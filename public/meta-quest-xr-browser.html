<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChocoDrop XR ブラウザPoC</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: 'Helvetica Neue', 'Hiragino Sans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.5;
      background: #030712;
      color: #f1f5f9;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: radial-gradient(120% 120% at 30% 10%, rgba(14,165,233,0.35), transparent), #020617;
    }
    header {
      padding: 1.5rem clamp(1rem, 4vw, 3rem) 0.5rem;
    }
    h1 {
      font-size: clamp(1.8rem, 4vw, 2.6rem);
      margin: 0 0 0.25rem;
    }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1rem;
      padding: 1rem clamp(1rem, 4vw, 3rem) 2rem;
      box-sizing: border-box;
    }
    .panel, .preview, .stage-wrapper, .settings, .status-card {
      background: rgba(15,23,42,0.85);
      border-radius: 1rem;
      padding: 1.2rem;
      box-shadow: 0 20px 45px rgba(2,6,23,0.65);
      border: 1px solid rgba(248,250,252,0.08);
    }
    .panel h2, .preview h2, .stage-wrapper h2, .settings h2, .status-card h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }
    label {
      font-size: 0.85rem;
      letter-spacing: 0.02em;
    }
    input[type="url"] {
      width: 100%;
      margin: 0.4rem 0 0.75rem;
      padding: 0.6rem 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #f8fafc;
    }
    button {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 0.65rem 1.5rem;
      background: linear-gradient(120deg, #38bdf8, #6366f1);
      color: #0f172a;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .note {
      font-size: 0.85rem;
      color: #94a3b8;
      margin-top: 0.75rem;
    }
    iframe {
      width: 100%;
      min-height: 360px;
      border: none;
      border-radius: 0.75rem;
      background: #0f172a;
    }
    #xr-stage {
      aspect-ratio: 16 / 9;
      min-height: 360px;
      border-radius: 0.75rem;
      overflow: hidden;
      position: relative;
    }
    #support-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      font-size: 0.85rem;
      background: rgba(34,197,94,0.12);
      color: #4ade80;
      border: 1px solid rgba(74,222,128,0.4);
      margin-top: 0.5rem;
    }
    #support-indicator[data-supported="false"] {
      background: rgba(248,113,113,0.12);
      color: #fca5a5;
      border-color: rgba(248,113,113,0.4);
    }
    .feature-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin: 0.75rem 0 0.25rem;
    }
    .feature-grid label {
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .feature-grid input {
      accent-color: #38bdf8;
    }
    .status-card ul {
      list-style: none;
      margin: 0.5rem 0 0;
      padding: 0;
      display: grid;
      gap: 0.4rem;
    }
    .status-card li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }
    .badge {
      padding: 0.15rem 0.65rem;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid rgba(148,163,184,0.4);
    }
    .badge[data-state="ok"] {
      background: rgba(34,197,94,0.15);
      color: #4ade80;
      border-color: rgba(74,222,128,0.35);
    }
    .badge[data-state="ng"] {
      background: rgba(248,113,113,0.15);
      color: #fca5a5;
      border-color: rgba(248,113,113,0.35);
    }
    .badge[data-state="pending"] {
      background: rgba(147,197,253,0.15);
      color: #bae6fd;
      border-color: rgba(147,197,253,0.35);
    }
    footer {
      padding: 0 1.5rem 1.5rem;
      font-size: 0.85rem;
      color: #94a3b8;
      text-align: center;
    }
    code {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', monospace;
      font-size: 0.9rem;
      color: #f472b6;
    }
  </style>
</head>
<body>
  <header>
    <p>接続先サーバー: <code>https://192.168.1.15</code></p>
    <h1>Meta Quest 3 向け XR ブラウザ PoC</h1>
    <p>WebXRサポートを検出し、Three.jsベースのシーンと2Dプレビューを同一ページで確認できます。</p>
  </header>
  <main>
    <section class="panel">
      <h2>1. URL ランチャー</h2>
      <form id="launcher">
        <label for="target-url">Quest ブラウザで開きたいURL</label>
        <input id="target-url" type="url" placeholder="https://192.168.1.15/examples/basic/" value="https://192.168.1.15/examples/basic/" required />
        <button type="submit">プレビューを更新</button>
      </form>
      <p class="note">入力したURLは右側のプレビュー iframe に読み込まれます。Questブラウザでは実際のタブで開きたい場合、プレビュー下の「新しいタブで開く」を使ってください。</p>
      <div id="support-indicator" aria-live="polite">WebXRサポートを確認しています…</div>
    </section>

    <section class="settings">
      <h2>2. セッション構成</h2>
      <form id="feature-form">
        <p class="note">VR起動前に要求/任意機能を切り替えられます。Quest 3のパススルーを使う場合は hand-tracking と layers を有効にしてください。</p>
        <h3>必須</h3>
        <div class="feature-grid">
          <label><input type="checkbox" name="required" value="local-floor" checked disabled />local-floor</label>
        </div>
        <h3>オプション</h3>
        <div class="feature-grid">
          <label><input type="checkbox" name="optional" value="local-floor" checked />local-floor</label>
          <label><input type="checkbox" name="optional" value="bounded-floor" checked />bounded-floor</label>
          <label><input type="checkbox" name="optional" value="hand-tracking" checked />hand-tracking</label>
          <label><input type="checkbox" name="optional" value="layers" checked />layers</label>
          <label><input type="checkbox" name="optional" value="depth-sensing" />depth-sensing</label>
        </div>
      </form>
      <p id="session-preview" class="note">optionalFeatures: local-floor, bounded-floor, hand-tracking, layers</p>
    </section>

    <section class="preview">
      <h2>3. 2D プレビュー</h2>
      <iframe id="preview-frame" title="XRプレビュー枠" src="https://192.168.1.15/examples/basic/"></iframe>
      <p class="note"><a id="open-tab" href="https://192.168.1.15/examples/basic/" target="_blank" rel="noreferrer">新しいタブで開く</a></p>
    </section>

    <section class="stage-wrapper">
      <h2>4. WebXR シーン</h2>
      <div id="xr-stage" aria-label="WebXR シーン領域"></div>
      <p class="note">VRボタンを押すとQuest 3のパススルー空間に星空グリッドが表示されます。local-floor / hand-tracking / layers を optional features として要求しています。</p>
    </section>

    <section class="status-card">
      <h2>5. サポート診断</h2>
      <ul>
        <li>immersive-vr <span class="badge" data-state="pending" id="diag-vr">checking</span></li>
        <li>immersive-ar <span class="badge" data-state="pending" id="diag-ar">checking</span></li>
      </ul>
      <p class="note">Quest Browserでは immersive-ar=パススルー。Chromeデスクトップの場合は通常falseになります。</p>
    </section>
  </main>
  <footer>
    <p>ファイル: <code>public/meta-quest-xr-browser.html</code> – テスト後は <code>npm run dev</code> で http://192.168.1.15:5173 などにホストしてください。</p>
  </footer>

  <script type="module">
    const stage = document.getElementById('xr-stage');
    const supportIndicator = document.getElementById('support-indicator');
    const form = document.getElementById('launcher');
    const urlInput = document.getElementById('target-url');
    const iframe = document.getElementById('preview-frame');
    const openTab = document.getElementById('open-tab');
    const featureForm = document.getElementById('feature-form');
    const sessionPreview = document.getElementById('session-preview');
    const diagVr = document.getElementById('diag-vr');
    const diagAr = document.getElementById('diag-ar');

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const value = urlInput.value.trim();
      if (!value) return;
      iframe.src = value;
      openTab.href = value;
    });

    const sessionState = {
      requiredFeatures: ['local-floor'],
      optionalFeatures: ['local-floor', 'bounded-floor', 'hand-tracking', 'layers'],
      depthSensing: undefined
    };

    function updateSessionPreview() {
      const list = sessionState.optionalFeatures.filter((item, index, arr) => arr.indexOf(item) === index);
      sessionPreview.textContent = `optionalFeatures: ${list.join(', ') || 'なし'}` + (sessionState.depthSensing ? ' / depthSensing: cpu & luminance-alpha' : '');
    }

    featureForm.addEventListener('change', () => {
      const optional = Array.from(featureForm.querySelectorAll('input[name="optional"]'))
        .filter((input) => input.checked)
        .map((input) => input.value);
      sessionState.optionalFeatures = optional;
      sessionState.depthSensing = optional.includes('depth-sensing')
        ? {
            usagePreference: ['cpu-optimized'],
            dataFormatPreference: ['luminance-alpha']
          }
        : undefined;
      updateSessionPreview();
      if (window.__xrApplySessionInit) {
        window.__xrApplySessionInit();
      }
    });

    function setDiag(el, state, text) {
      el.dataset.state = state;
      el.textContent = text;
    }

    if (!('xr' in navigator)) {
      supportIndicator.dataset.supported = 'false';
      supportIndicator.textContent = 'WebXR未対応のブラウザです。Quest Browserか最新のChromeを利用してください。';
      setDiag(diagVr, 'ng', 'unsupported');
      setDiag(diagAr, 'ng', 'unsupported');
    } else {
      navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
        supportIndicator.dataset.supported = supported ? 'true' : 'false';
        supportIndicator.textContent = supported
          ? 'WebXR: immersive-vr サポートあり。QuestブラウザでVRボタンが使えます。'
          : 'WebXR: immersive-vr サポートなし。2Dプレビューのみ動作します。';
        setDiag(diagVr, supported ? 'ok' : 'ng', supported ? 'available' : 'missing');
      }).catch((error) => {
        console.error(error);
        supportIndicator.dataset.supported = 'false';
        supportIndicator.textContent = 'WebXRサポート確認中にエラーが発生しました。コンソールを確認してください。';
        setDiag(diagVr, 'ng', 'error');
      });

      navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
        setDiag(diagAr, supported ? 'ok' : 'ng', supported ? 'available' : 'missing');
      }).catch(() => {
        setDiag(diagAr, 'ng', 'error');
      });
    }

    async function initThree() {
      const [{ WebGLRenderer, Scene, PerspectiveCamera, Color, AmbientLight, DirectionalLight, GridHelper, PointsMaterial, BufferGeometry, Float32BufferAttribute, Points, Clock }, { VRButton }] = await Promise.all([
        import('https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js'),
        import('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js')
      ]);

      const renderer = new WebGLRenderer({ antialias: true, alpha: true });
      renderer.xr.enabled = true;
      renderer.xr.setReferenceSpaceType('local-floor');

      window.__xrApplySessionInit = () => {
        renderer.xr.setSessionInit({
          optionalFeatures: sessionState.optionalFeatures,
          requiredFeatures: sessionState.requiredFeatures,
          depthSensing: sessionState.depthSensing
        });
      };
      window.__xrApplySessionInit();
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(stage.clientWidth, stage.clientHeight);
      stage.appendChild(renderer.domElement);

      const vrButton = VRButton.createButton(renderer);
      vrButton.id = 'vr-button';
      vrButton.style.marginTop = '1rem';
      vrButton.style.width = '100%';
      vrButton.style.borderRadius = '0.75rem';
      vrButton.style.border = '1px solid rgba(248,250,252,0.2)';
      vrButton.style.background = 'linear-gradient(120deg, #38bdf8, #8b5cf6)';
      vrButton.style.color = '#0f172a';
      vrButton.style.fontSize = '1rem';
      vrButton.style.fontWeight = '600';
      vrButton.textContent = 'VRモードを開始';
      stage.after(vrButton);

      const scene = new Scene();
      scene.background = new Color(0x04050a);

      const camera = new PerspectiveCamera(70, stage.clientWidth / stage.clientHeight, 0.1, 100);
      camera.position.set(0, 1.6, 3);

      const ambient = new AmbientLight(0xffffff, 0.4);
      const dir = new DirectionalLight(0x9fb8ff, 0.8);
      dir.position.set(-3, 5, 1);
      scene.add(ambient, dir);

      const grid = new GridHelper(20, 40, 0x38bdf8, 0x1e3a8a);
      grid.position.y = 0;
      scene.add(grid);

      const starsGeometry = new BufferGeometry();
      const starVertices = [];
      for (let i = 0; i < 4000; i += 1) {
        starVertices.push((Math.random() - 0.5) * 50);
        starVertices.push(Math.random() * 15 + 2);
        starVertices.push((Math.random() - 0.5) * 50);
      }
      starsGeometry.setAttribute('position', new Float32BufferAttribute(starVertices, 3));
      const starsMaterial = new PointsMaterial({ color: 0xffffff, size: 0.05 });
      const stars = new Points(starsGeometry, starsMaterial);
      scene.add(stars);

      const clock = new Clock();
      renderer.setAnimationLoop(() => {
        const elapsed = clock.getElapsedTime();
        stars.rotation.y = elapsed * 0.02;
        renderer.render(scene, camera);
      });

      const resize = () => {
        const { clientWidth, clientHeight } = stage;
        renderer.setSize(clientWidth, clientHeight);
        camera.aspect = clientWidth / Math.max(clientHeight, 1);
        camera.updateProjectionMatrix();
      };
      window.addEventListener('resize', resize);
      const observer = new ResizeObserver(resize);
      observer.observe(stage);
    }

    updateSessionPreview();

    initThree().catch((error) => {
      console.error('[XR demo] 初期化失敗', error);
      const fallback = document.createElement('p');
      fallback.textContent = 'WebGL/Three.js の読み込みに失敗しました。ネットワークとContent-Security-Policyを確認してください。';
      fallback.style.color = '#f87171';
      stage.replaceChildren(fallback);
    });
  </script>
</body>
</html>
