name: AI Parallel Implementation
# AI ã«è¤‡æ•°ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ä¸¦åˆ—å®Ÿè£…ã•ã›ã€è‡ªå‹•è©•ä¾¡ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

on:
  workflow_dispatch:
    inputs:
      task_description:
        description: 'å®Ÿè£…ã‚¿ã‚¹ã‚¯ã®èª¬æ˜Žï¼ˆä¾‹: VR/ARæ©Ÿèƒ½ã‚’è¿½åŠ ï¼‰'
        required: true
        type: string
      num_approaches:
        description: 'å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®æ•°ï¼ˆ1-5ï¼‰'
        required: false
        type: number
        default: 3
  workflow_call:
    inputs:
      task_description:
        required: true
        type: string
      num_approaches:
        required: false
        type: number
        default: 3

permissions:
  contents: write
  id-token: write

jobs:
  # ä¸¦åˆ—å®Ÿè£…ã®æº–å‚™
  prepare:
    name: Prepare implementation matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      timestamp: ${{ steps.set-matrix.outputs.timestamp }}

    steps:
      - name: Generate matrix
        id: set-matrix
        run: |
          NUM=${{ inputs.num_approaches }}

          # 1ã‹ã‚‰NUMã¾ã§ã®é…åˆ—ã‚’ç”Ÿæˆ
          MATRIX=$(seq 1 $NUM | jq -R . | jq -s -c .)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç”Ÿæˆï¼ˆãƒ–ãƒ©ãƒ³ãƒåã«ä½¿ç”¨ï¼‰
          TIMESTAMP=$(date +%s)
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

          echo "ðŸŒ³ Will create $NUM implementation approaches"

  # å„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä¸¦åˆ—å®Ÿè£…
  implement:
    name: Implement approach ${{ matrix.approach }}
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        approach: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false  # ä¸€ã¤ãŒå¤±æ•—ã—ã¦ã‚‚ä»–ã¯ç¶šè¡Œ

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global user.name "Claude Code AI"
          git config --global user.email "ai@chocodrop.dev"

      - name: ðŸ¤– AI Implementation - Approach ${{ matrix.approach }}
        uses: anthropics/claude-code-action@beta
        with:
          mode: agent
          direct_prompt: |
            # ä¸¦åˆ—å®Ÿè£…ã‚¿ã‚¹ã‚¯ - ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ ${{ matrix.approach }} / ${{ inputs.num_approaches }}

            ## ã‚¿ã‚¹ã‚¯å†…å®¹
            ${{ inputs.task_description }}

            ## å®Ÿè£…è¦ä»¶

            1. **ãƒ–ãƒ©ãƒ³ãƒä½œæˆ**
               - ãƒ–ãƒ©ãƒ³ãƒå: `ai/approach-${{ matrix.approach }}-${{ needs.prepare.outputs.timestamp }}`
               - ã“ã®ãƒ–ãƒ©ãƒ³ãƒã‚’æ–°è¦ä½œæˆã—ã¦ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ

            2. **å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**
               - ã‚ãªãŸã¯ **ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ ${{ matrix.approach }}** ã‚’æ‹…å½“ã—ã¦ã„ã¾ã™
               - **ä»–ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨ã¯ç•°ãªã‚‹å®Ÿè£…æ–¹æ³•**ã‚’æŽ¡ç”¨ã—ã¦ãã ã•ã„
               - ä»¥ä¸‹ã®ã‚ˆã†ãªè¦³ç‚¹ã§å·®åˆ¥åŒ–ã—ã¦ãã ã•ã„ï¼š
                 * ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆMVCã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆãªã©ï¼‰
                 * ä½¿ç”¨ã™ã‚‹æŠ€è¡“ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
                 * ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–ã®æ–¹æ³•
                 * ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ã‚„æŠ½è±¡åŒ–ãƒ¬ãƒ™ãƒ«

            3. **å®Ÿè£…å“è³ª**
               - å‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã
               - é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
               - ã‚³ãƒ¡ãƒ³ãƒˆã§å®Ÿè£…æ–¹é‡ã‚’èª¬æ˜Ž

            4. **å®Œäº†å‡¦ç†**
               - å®Ÿè£…å®Œäº†å¾Œã€å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
               - ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒªãƒ¢ãƒ¼ãƒˆã«push: `git push origin ai/approach-${{ matrix.approach }}-${{ needs.prepare.outputs.timestamp }}`

            ## é‡è¦
            - ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ **${{ matrix.approach }} / ${{ inputs.num_approaches }}** ã§ã™
            - ä»–ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨æ˜Žç¢ºã«ç•°ãªã‚‹å®Ÿè£…ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„
            - å®Œæˆã—ãŸã‚‰å¿…ãšpushã—ã¦ãã ã•ã„
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Verify branch was pushed
        run: |
          BRANCH="ai/approach-${{ matrix.approach }}-${{ needs.prepare.outputs.timestamp }}"
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "âœ… Branch $BRANCH was successfully pushed"
          else
            echo "âŒ Branch $BRANCH was not found on remote"
            exit 1
          fi

  # å…¨å®Ÿè£…å®Œäº†å¾Œã€æ¯”è¼ƒè©•ä¾¡ã‚’å®Ÿè¡Œ
  evaluate:
    name: Evaluate all approaches
    runs-on: ubuntu-latest
    needs: [prepare, implement]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build branch list
        id: branches
        run: |
          TIMESTAMP="${{ needs.prepare.outputs.timestamp }}"
          NUM=${{ inputs.num_approaches }}

          # ãƒ–ãƒ©ãƒ³ãƒåã‚’ã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šã§ç”Ÿæˆ
          BRANCHES=""
          for i in $(seq 1 $NUM); do
            if [ $i -eq 1 ]; then
              BRANCHES="ai/approach-${i}-${TIMESTAMP}"
            else
              BRANCHES="${BRANCHES},ai/approach-${i}-${TIMESTAMP}"
            fi
          done

          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Will compare branches: $BRANCHES"

      - name: Trigger comparison workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run worktree-parallel.yml \
            -f branches="${{ steps.branches.outputs.branches }}" \
            -f run_build=true \
            -f run_tests=true \
            -f compare_results=true

          echo "âœ… Comparison workflow triggered"
          echo "ðŸ“Š Check results at: https://github.com/${{ github.repository }}/actions/workflows/worktree-parallel.yml"

      - name: Summary
        run: |
          echo "## ðŸŽ‰ AI Parallel Implementation Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Task:** ${{ inputs.task_description }}" >> $GITHUB_STEP_SUMMARY
          echo "**Approaches:** ${{ inputs.num_approaches }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branches created:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.branches.outputs.branches }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Check the comparison workflow for AI analysis" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/actions/workflows/worktree-parallel.yml" >> $GITHUB_STEP_SUMMARY
