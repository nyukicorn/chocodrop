# ChocoDrop PWA / XR アーキテクチャ議論ログ（2025-10-31）

## 1. サマリー
- **自立型（PWA 基盤）**: manifest / Service Worker / OPFS を備えた PWA と没入ランチャーで、ホームアイコンからワンタップで WebXR セッションを起動できる基盤が整備済み。
- **取り込み型（シーンインポート）**: ユーザーが保有する Three.js シーンを ChocoDrop 側で読み込み、XR 空間に展開しながら生成機能を利用できるようにする方向性。シーン初期化を ChocoDrop が制御できる点が強み。
- **ブックマークレット誘導戦略（ピボット）**: コード改変不要で試せる子アプリ体験をブックマークレットで提供し、気に入ったユーザーを PWA ランチャー（親アプリ）へ誘導して本格運用してもらう二段構えで障壁を下げる。

## 2. 会話の文脈
- 目的は、ChocoDrop をホームアイコンから常用できるアプリ体験に進化させること。
- ユーザーが持つ任意の Three.js シーンに ChocoDrop の UI を埋め込み、画像・動画生成を行える「取り込み型」が元々の構想。
- 今回は PWA 基盤を実装し、没入ビューを即起動できるようにしたことで、取り込み型へ発展する可能性が見えてきた。

## 3. 現行実装の詳細
### 3.1 ダッシュボード（`/index.html`）
- Service Worker (`public/service-worker.js`) と OPFS (`public/pwa-bootstrap.js`) を用いてアセットのオフラインキャッシュ、セッション情報、ログの保持を実現。
- モデル一覧が取得できない場合は OPFS のバックアップから復元。フォームの最終入力・エラー内容もログ化。
- PWA manifest を通じてホームアイコン・フルスクリーン起動が可能。

### 3.2 没入ランチャー（`/immersive.html` + `immersive-launcher.js`）
- WebXR ターゲットを起動するための Three.js レンダラー、ライト、グリッドを準備。
- `ensureChocoDrop` → `createChocoDrop` を呼び出し、ChocoDrop のシーン管理ロジックを XR レンダリングループに注入。
- WebXR セッションをワンタップで開始可能。Service Worker により PWA としてオフライン起動にも対応。
- Import map を導入し、CDN 上の `three.module.js` を裸インポートで解決。

## 4. 元々の構想と今回の実装思想
### 4.1 ユーザーの構想（取り込み型）
- 任意の Three.js シーン（ユーザーが制作・保有）に ChocoDrop の UI コンポーネントを差し込み、その場で画像や動画を生成・配置したい。
- デモページはフォーム＋シーンが一体化した例であり、本番はユーザー側のシーンへ「ポンと UI を置く」スタイルが理想。
- WebXR/AR 空間内で UI を可視化し、ヘッドセットだけで操作を完結させることが目標。

### 4.2 今回の開発思想（自立型基盤）
- ChocoDrop 全体をインストール型 Web アプリ（PWA）として整備することに注力。
- ホームアイコン→没入ビュー→XR セッションの導線を整えることで「ワンタップ没入」を実現。
- Service Worker / OPFS で再訪性・オフライン体験を担保し、XR 内 UI の拡張や任意シーン取込への橋頭堡とする。

### 4.3 双方向に拡張するビジョン
- **自立型 (PWA モード)**: `/immersive.html` をベースに XR 内 UI を作り込み、ChocoDrop 専用空間を完成させる。
- **取り込み型 (シーンインポートモード)**: 新たなエントリー（例: `/importer.html`）を設け、ユーザーのシーンを読み込んで XR 表示し、`createChocoDrop` を注入。
- 共通の PWA インフラを活かしつつ、設定 UI・シームレスなシーン切り替え・XR 内フォーム表示を実現していく。

## 5. 自立型と取り込み型の比較
| 観点 | 自立型（PWA モード） | 取り込み型（シーンインポート） | 共通/共用できる要素 |
| --- | --- | --- | --- |
| 起動導線 | ホームアイコン → `/immersive.html` → WebXR | ホームアイコン → （新規）`/importer.html` → ユーザーシーン読み込み | PWA manifest / Service Worker / OPFS / adb reverse 等の検証手順 |
| シーン構成 | ChocoDrop が用意した標準グリッド＋ライト＋SceneManager | ユーザー提供の Three.js シーンをロードして差し替え | `createChocoDrop`、`SceneManager`、`LiveCommandClient` などコアロジック |
| UI 表示位置 | 現状はブラウザ UI（ダッシュボード）。将来的に XR パネルへ移設 | 初期ロード時から XR 空間に 3D パネルとして配置する想定 | UI コンポーネント、OPFS を用いた設定保存、エラーログ蓄積 |
| ユーザー価値 | ChocoDrop が単体で動く体験を保証。導入障壁が低い | 既存シーンが即座に XR 化でき、柔軟性と没入感が高い | 共通の生成 API、モデル選択、ログ収集、PWA のキャッシュ機構 |
| 主な追加開発 | XR 内 UI の実装、生成結果の HUD 配置、ワークフローの最適化 | シーン読込設定、シーン権限管理、XR 内 UI のダイナミック配置 | 設定 UI、OPFS スキーマ、テスト手順、CI/CD パイプライン |

## 6. 今後の検討タスク
1. **XR UI の実装** – WebXR Layers や 3D パネルを利用し、ヘッドセット内で ChocoDrop のコマンド入力・履歴確認を完結できるようにする。コントローラ操作や音声入力など XR 特有のインタラクションを検討。  
2. **シーン取込フローの設計** – GLTF/JSON/独自 API などを `immersive-launcher.js` 経由で読み込む導線を実装し、読み込んだシーンに `createChocoDrop` を適用する仕組みを整備。  
3. **設定と永続化** – OPFS を活用し、使用するシーン URL、デフォルトサービス、UI 配置などを保存。管理ダッシュボードから編集し、没入ビューに反映。  
4. **ユーザーテストと優先順位付け** – 自立型・取り込み型双方のプロトタイプを用意し、価値の高い導線を検証して優先度を決定。

## 7. プロジェクト構成に関する考察
- 現行リポジトリ内で双方のモードを扱う設計が可能。エントリーポイントや設定で切り替える方針が有効。
- 大規模に異なるアーキテクチャが必要になった場合を除き、プロジェクトを分ける必要はない。
- 新メンバーを迎える際は、本ドキュメントと既存の設計ドキュメント（UI/UX 設計、技術検証レポートなど）をセットで共有する想定。

## 8. 取り込み型＋ブックマークレット誘導戦略
- **ピボット背景**  
  - ユーザーが自分のコードに 1 行追加する方式は、心理的ハードルが高く、環境ごとのカメラ設定差異で ChocoDrop が意図どおり動かないケースが多い。  
  - 取り込み型であれば、ChocoDrop 側がシーン初期化を制御でき、挙動のばらつきを抑えられる。
- **戦略案**  
  1. 既存ブックマークレットを改良し、ユーザーのページ上で簡易 UI をオーバーレイ（子アプリ的「お試し」体験）。  
  2. 体験が成立したら「ChocoDrop PWA でこのシーンを開く」ボタンで没入ランチャーに誘導。  
  3. PWA（親アプリ）側でシーン URL や設定を受け取り、XR 空間で安定した生成体験を提供する。
- **メリット**  
  - コード改変不要で導入障壁が低い。  
  - 子アプリ体験と親アプリ体験をシームレスにつなげ、ユーザーの信頼醸成と機能拡張を段階的に進められる。  
  - 将来の外部シーン生成サービスとも連携しやすく、ChocoDrop をハブ化しやすい。
- **追加で意識すべき懸念点**  
  - ブックマークレット使用時の CSP 制約、クロスドメイン制約。  
  - 取り込むシーンの著作権やライセンス、安全なロード方式。  
  - PWA 内でのシーン設定やアセットの保存先（OPFS/クラウド）の整理、バージョン管理。  
  - 外部プラットフォームと連携する際の API 安定性、依存関係リスク、SLA。

## 9. 共有資料リンク
- `output/architecture-diagram.svg`
- `output/pwa-test-flow.svg`
- `output/scene-import-tutorial.md`
- `output/settings-schema.md`
- `output/xr-ui-prototype-notes.md`

## 10. 理解促進のためにあると良いもの
- アーキテクチャ図の拡張版とネットワーク構成説明
- シーン取り込み手順のスクリーンショット付きチュートリアル
- XR UI プロトタイプの動画モック（将来的に収録）
- 設定スキーマを基にした OPFS/クラウド同期のフローチャート
- テストフローの時系列図（adb reverse → npm run dev → ngrok → インストール → オフライン検証）

---
本ドキュメントは 2025-10-31 の議論内容を詳細に整理したものです。開発チーム拡大時のコンテキスト共有に活用してください。
