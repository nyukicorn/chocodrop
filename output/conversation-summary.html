<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ChocoDrop PWA / XR アーキテクチャ議論ログ（詳細版）</title>
  <style>
    body {
      font-family: "Inter", "Hiragino Sans", "Noto Sans JP", system-ui, sans-serif;
      line-height: 1.7;
      margin: 0;
      padding: 32px 40px;
      background: #f7f8fb;
      color: #0f172a;
    }
    header h1 {
      margin-bottom: 4px;
    }
    header p {
      margin-top: 0;
      color: #475569;
    }
    section {
      margin-bottom: 40px;
      background: white;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
    }
    h2 {
      margin-top: 0;
      color: #4c1d95;
    }
    h3 {
      margin-bottom: 0.5em;
      color: #1e293b;
    }
    ul {
      margin-top: 0.4em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th, td {
      border: 1px solid #e2e8f0;
      padding: 12px 14px;
      vertical-align: top;
    }
    th {
      background: #ede9fe;
      color: #312e81;
    }
    td ul {
      margin-top: 0.2em;
      margin-bottom: 0;
    }
    .diagram-wrapper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 24px;
      margin-top: 20px;
    }
    .diagram-card {
      background: linear-gradient(145deg, #eef2ff, #fff);
      border-radius: 16px;
      padding: 16px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.5);
    }
    svg {
      width: 100%;
      height: auto;
    }
    footer {
      margin-top: 24px;
      color: #64748b;
      font-size: 0.85rem;
    }
    .callout {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ChocoDrop PWA / XR アーキテクチャ議論ログ</h1>
    <p>更新日: 2025-10-31 / 参加者: プロダクトオーナー（ユーザー）、開発担当（Codex）</p>
  </header>

  <section id="context">
    <h2>1. 会話の文脈</h2>
    <ul>
      <li>ChocoDrop をホームアイコンから即立ち上げ、WebXR セッションへ一操作で遷移できる常用アプリ体験を目指している。</li>
      <li>理想像は「ユーザーが用意した任意の Three.js シーンに ChocoDrop の UI コンポーネントを差し込み、生成コンテンツをその場に配置する」こと。</li>
      <li>今回の実装では PWA 化と没入ランチャーを整備し、上記理想像へ進むための土台が成立した。</li>
    </ul>
  </section>

  <section id="current-implementation">
    <h2>2. 現行実装の詳細</h2>
    <h3>2.1 管理ダッシュボード (`/index.html`)</h3>
    <ul>
      <li>Service Worker と OPFS によるオフラインキャッシュ、セッション記録（直近プロンプト、モデル一覧、エラーログ）の保存を実装。</li>
      <li>マニフェスト・Apple Touch アイコン・テーマカラーを設定し、ホーム画面からスタンドアロン起動が可能。</li>
      <li>没入ビューへの導線（「🚀 ワンタップで没入ビューを開く」カード）とオフラインバナーを追加。</li>
    </ul>

    <h3>2.2 没入ランチャー (`/immersive.html` + `immersive-launcher.js`)</h3>
    <ul>
      <li>Three.js レンダラーを WebXR 用に初期化し、ライトとグリッドのあるベース空間を生成。</li>
      <li>`ensureChocoDrop` / `createChocoDrop` を呼び出し、ChocoDrop の SceneManager を XR レンダリングループに接続。</li>
      <li>Import map で CDN 上の `three.module.js` を解決し、OrbitControls / GLTFLoader を利用可能にした。</li>
      <li>ワンタップで `navigator.xr.requestSession('immersive-vr', ...)` を呼び出す導線を実装。Quest 3 で実際にセッション突入を確認済み。</li>
    </ul>

    <div class="diagram-wrapper">
      <div class="diagram-card">
        <h3>自立型（現在の没入ランチャー）</h3>
        <svg viewBox="0 0 340 200" role="img" aria-label="自立型モードのフロー">
          <rect x="10" y="20" width="140" height="40" rx="8" ry="8" fill="#7c3aed" opacity="0.18"></rect>
          <text x="80" y="45" fill="#312e81" text-anchor="middle" font-size="14">ホームアイコン</text>

          <line x1="80" y1="60" x2="80" y2="90" stroke="#7c3aed" stroke-width="2" marker-end="url(#arrow)"></line>

          <rect x="30" y="90" width="100" height="40" rx="8" ry="8" fill="#c4b5fd"></rect>
          <text x="80" y="115" fill="#312e81" text-anchor="middle" font-size="13">immersive.html</text>

          <line x1="80" y1="130" x2="80" y2="160" stroke="#7c3aed" stroke-width="2" marker-end="url(#arrow)"></line>

          <rect x="10" y="160" width="140" height="40" rx="8" ry="8" fill="#a78bfa"></rect>
          <text x="80" y="185" fill="#312e81" text-anchor="middle" font-size="13">WebXR セッション開始</text>

          <defs>
            <marker id="arrow" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
              <path d="M0,0 L8,4 L0,8 z" fill="#7c3aed"></path>
            </marker>
          </defs>
        </svg>
      </div>

      <div class="diagram-card">
        <h3>取り込み型（拡張後の構想）</h3>
        <svg viewBox="0 0 340 200" role="img" aria-label="取り込み型モードのフロー">
          <rect x="20" y="15" width="120" height="40" rx="8" ry="8" fill="#e0f2fe"></rect>
          <text x="80" y="40" fill="#0f172a" text-anchor="middle" font-size="13">ユーザー Three.js</text>

          <rect x="200" y="15" width="120" height="40" rx="8" ry="8" fill="#fde68a"></rect>
          <text x="260" y="40" fill="#92400e" text-anchor="middle" font-size="13">ChocoDrop XR基盤</text>

          <line x1="140" y1="35" x2="200" y2="35" stroke="#0ea5e9" stroke-width="2" marker-end="url(#arrow2)"></line>
          <text x="170" y="28" fill="#0f172a" font-size="12">シーン読込</text>

          <line x1="260" y1="55" x2="260" y2="100" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrow2)"></line>

          <rect x="170" y="100" width="180" height="40" rx="8" ry="8" fill="#fef3c7"></rect>
          <text x="260" y="125" fill="#92400e" text-anchor="middle" font-size="13">ChocoDrop UI / SceneManager</text>

          <line x1="260" y1="140" x2="260" y2="185" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrow2)"></line>

          <rect x="200" y="160" width="120" height="40" rx="8" ry="8" fill="#bbf7d0"></rect>
          <text x="260" y="185" fill="#065f46" text-anchor="middle" font-size="13">XR セッション</text>

          <defs>
            <marker id="arrow2" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
              <path d="M0,0 L8,4 L0,8 z" fill="#0284c7"></path>
            </marker>
          </defs>
        </svg>
      </div>
    </div>
  </section>

  <section id="ideology">
    <h2>3. 二つの思想とその相互補完</h2>
    <h3>3.1 ユーザー（PO）が描く「取り込み型」の思想</h3>
    <ul>
      <li>ユーザーが自分の Three.js / WebXR シーンに ChocoDrop UI を差し込み、その場で生成体験を完結させたい。</li>
      <li>フォームや操作 UI は VR/AR 空間内に浮かび、ヘッドセットだけで画像・動画を生成・配置できる。</li>
      <li>デモページは合体版だが、本番では「好きなシーンにポンと UI を置く」が本筋。</li>
    </ul>

    <h3>3.2 今回整えた「自立型 PWA 基盤」の思想</h3>
    <ul>
      <li>ChocoDrop をインストール可能な Web アプリとして育て、どのデバイスでも安定して立ち上がる基盤を優先。</li>
      <li>ホームアイコン→没入ビュー→WebXR までをワンタップで結び、Service Worker / OPFS で再訪やログ収集を担保。</li>
      <li>この土台の上に取り込み型のシーン読込機能や XR UI を積み上げる想定。</li>
    </ul>

    <div class="callout">
      <strong>補足:</strong> 双方の思想は対立ではなく補完関係にある。PWA 基盤は安定した起点を提供し、取り込み型はユーザー固有シーンへの適用範囲を広げる。
    </div>
  </section>

  <section id="comparison">
    <h2>4. 自立型と取り込み型の比較</h2>
    <table>
      <thead>
        <tr>
          <th>観点</th>
          <th>自立型（PWA モード）</th>
          <th>取り込み型（シーンインポート）</th>
          <th>共通/共用できる要素</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>起動導線</td>
          <td>ホームアイコン → `/immersive.html` → WebXR</td>
          <td>ホームアイコン → （新規）`/importer.html` → ユーザーシーン読み込み</td>
          <td>PWA manifest / Service Worker / OPFS / adb reverse 等の検証手順</td>
        </tr>
        <tr>
          <td>シーン構成</td>
          <td>ChocoDrop が用意した標準グリッド＋ライト＋SceneManager</td>
          <td>ユーザー提供の Three.js シーンをロードして差し替え</td>
          <td>`createChocoDrop`、`SceneManager`、`LiveCommandClient` などコアロジック</td>
        </tr>
        <tr>
          <td>UI 表示位置</td>
          <td>現状はブラウザ UI（ダッシュボード）。将来的に XR パネルへ移設</td>
          <td>初期ロード時から XR 空間に 3D パネルとして配置する想定</td>
          <td>UI コンポーネント、OPFS を用いた設定保存、エラーログ蓄積</td>
        </tr>
        <tr>
          <td>ユーザー価値</td>
          <td>ChocoDrop が単体で動く体験を保証。導入障壁が低い</td>
          <td>既存シーンが即座に XR 化でき、柔軟性と没入感が高い</td>
          <td>共通の生成 API、モデル選択、ログ収集、PWA のキャッシュ機構</td>
        </tr>
        <tr>
          <td>主な追加開発</td>
          <td>XR 内 UI の実装、生成結果の HUD 配置、ワークフローの最適化</td>
          <td>シーン読込設定、シーン権限管理、XR 内 UI のダイナミック配置</td>
          <td>設定 UI、OPFS スキーマ、テスト手順、CI/CD パイプライン</td>
        </tr>
      </tbody>
    </table>
  </section>

  <section id="next-steps">
    <h2>5. 今後の検討タスク</h2>
    <ol>
      <li><strong>XR UI の具体化:</strong> WebXR Layers / CSS3DRenderer 等で入力フォームを 3D パネル化し、Quest コントローラ操作や音声入力と連携。</li>
      <li><strong>シーン取込フロー:</strong> GLTFLoader や独自 API を通じてユーザーシーンを読み込み、`createChocoDrop` を適用するユーティリティを整備。</li>
      <li><strong>設定永続化:</strong> OPFS とダッシュボード UI を連携し、シーン URL・サービス設定・UI 配置を保存／復元。</li>
      <li><strong>ユーザーテスト:</strong> 自立型・取り込み型双方のプロトタイプを用意し、どちらが価値を生むか検証しながら優先度を決定。</li>
    </ol>
  </section>

  <section id="materials">
    <h2>6. 理解促進のためにあると良いもの</h2>
    <ul>
      <li><strong>アーキテクチャ図の拡張版:</strong> 現在の簡易図をベースに、ネットワーク（ngrok, adb reverse）、Service Worker、OPFS の関係を詳細に示した資料。</li>
      <li><strong>シーン取込チュートリアル:</strong> 「任意の GLTF を読み込んで XR 表示に変換する」ステップをスクリーンショット付きで解説。</li>
      <li><strong>XR UI プロトタイプレコーディング:</strong> Quest 上でフォームが浮かぶ様子を動画に収め、新メンバーの理解を助ける。</li>
      <li><strong>設定スキーマ表:</strong> OPFS に保存する JSON スキーマ（シーン URL、既定サービス、UI 配置など）を一覧化。</li>
      <li><strong>テストフロー図:</strong> adb reverse、ngrok、PWA インストール、オフライン検証までの手順を時系列で示した図。</li>
    </ul>
    <p>上記資料を整えることで、新規メンバーやステークホルダーが両モードの違いと共通部分、実装ロードマップを直感的に把握できます。</p>
  </section>

  <footer>
    &copy; 2025 ChocoDrop Project. このドキュメントは会話ログをもとに作成された内部共有資料です。
  </footer>
</body>
</html>
