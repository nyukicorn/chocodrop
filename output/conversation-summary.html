<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ChocoDrop PWA / XR アーキテクチャ議論ログ（詳細版）</title>
  <style>
    body {
      font-family: 'Inter', 'Hiragino Sans', 'Noto Sans JP', system-ui, sans-serif;
      background: #f7f8fb;
      color: #0f172a;
      margin: 0;
      padding: 32px 40px 80px;
      line-height: 1.7;
    }
    header h1 {
      margin: 0 0 6px 0;
    }
    header p {
      margin: 0;
      color: #475569;
    }
    section {
      margin-top: 32px;
      background: #fff;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
    }
    h2 {
      margin-top: 0;
      color: #4c1d95;
    }
    h3 {
      color: #1e293b;
      margin-bottom: 0.5em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th, td {
      border: 1px solid #e2e8f0;
      padding: 12px 14px;
      vertical-align: top;
    }
    th {
      background: #ede9fe;
      color: #312e81;
    }
    figure {
      margin: 24px 0;
      background: linear-gradient(145deg, #eef2ff, #fff);
      border-radius: 16px;
      padding: 18px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }
    figure img {
      width: 100%;
      height: auto;
      border-radius: 12px;
    }
    figure figcaption {
      margin-top: 12px;
      font-size: 0.95rem;
      color: #475569;
    }
    ul { margin-top: 0.4em; }
    li { margin-bottom: 0.3em; }
    footer {
      margin-top: 32px;
      color: #64748b;
      font-size: 0.85rem;
    }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <h1>ChocoDrop PWA / XR アーキテクチャ議論ログ</h1>
    <p>更新日: 2025-10-31 / 参加者: プロダクトオーナー（ユーザー）、開発担当（Codex）</p>
  </header>

  <section id="summary">
    <h2>1. サマリー</h2>
    <ul>
      <li><strong>自立型（PWA 基盤）:</strong> manifest / Service Worker / OPFS を備えた PWA と没入ランチャーを整備し、ホームアイコンからワンタップで WebXR セッションを起動できる状態。</li>
      <li><strong>取り込み型（シーンインポート）:</strong> ユーザー保有の Three.js シーンを ChocoDrop 側で読み込み、XR 空間で生成機能を利用できるようにする方向性。シーン初期化を ChocoDrop が握れる。</li>
      <li><strong>ブックマークレット誘導戦略（ピボット）:</strong> コード改変不要のお試し体験をブックマークレットで提供し、気に入ったユーザーを PWA ランチャーへ誘導して本格運用してもらう二段構え。</li>
    </ul>
  </section>

  <section id="context">
    <h2>2. 会話の文脈</h2>
    <ul>
      <li>ChocoDrop をホームアイコンから常用できるアプリ体験に進化させることが目標。</li>
      <li>元々はユーザーの Three.js シーンへ UI を差し込む「取り込み型」の構想があった。</li>
      <li>PWA 基盤と没入ランチャーを整備したことで、取り込み型への発展が現実的になった。</li>
    </ul>
  </section>

  <section id="current">
    <h2>3. 現行実装の詳細</h2>
    <h3>3.1 ダッシュボード（/index.html）</h3>
    <ul>
      <li>Service Worker と OPFS でオフラインキャッシュ・セッション・ログを保持。</li>
      <li>モデル一覧が取得できない場合のバックアップ復元とフォーム入力の保存。</li>
      <li>PWA manifest によりホーム画面からスタンドアロン起動可能。</li>
    </ul>
    <h3>3.2 没入ランチャー（/immersive.html + immersive-launcher.js）</h3>
    <ul>
      <li>Three.js レンダラーを XR 設定で初期化し、ライト・グリッドを配置。</li>
      <li>`ensureChocoDrop` → `createChocoDrop` で SceneManager を XR ループへ接続。</li>
      <li>Import map で CDN 上の `three.module.js` を解決し、OrbitControls / GLTFLoader を利用。</li>
    </ul>
  </section>

  <section id="ideology">
    <h2>4. 元々の構想と今回の実装思想</h2>
    <h3>4.1 ユーザーの構想（取り込み型）</h3>
    <ul>
      <li>ユーザーの任意シーンに UI を差し込み、その場で生成結果を配置したい。</li>
      <li>デモページは合体版。プロダクト本番では「好きなシーンにポンと UI」を目指す。</li>
      <li>ヘッドセット内に UI を浮かせ、ブラウザに戻らず操作完結する。</li>
    </ul>
    <h3>4.2 今回の開発思想（自立型基盤）</h3>
    <ul>
      <li>PWA と没入ランチャーを整え、安定した起動・再訪体験を優先。</li>
      <li>ワンタップで XR セッションへ入れる導線とログ／キャッシュを確保。</li>
      <li>この基盤上で XR 内 UI やシーン取込機能を積み上げる。</li>
    </ul>
    <h3>4.3 双方向に拡張するビジョン</h3>
    <ul>
      <li><strong>自立型:</strong> `/immersive.html` を起点に XR UI を作り込み、ChocoDrop 専用空間を完成。</li>
      <li><strong>取り込み型:</strong> `/importer.html`（仮）などでシーンを読み込み、`createChocoDrop` を適用。</li>
      <li>共通インフラ（PWA・Service Worker・OPFS）を共有しながらモードごとに体験を磨く。</li>
    </ul>
  </section>

  <section id="comparison">
    <h2>5. 自立型と取り込み型の比較</h2>
    <p>現在は取り込み型とブックマークレット誘導を強化しつつ、自立型基盤もアップデートを継続する。主要項目の比較は以下の通り。</p>
    <table>
      <thead>
        <tr>
          <th>観点</th>
          <th>自立型（PWA モード）</th>
          <th>取り込み型（シーンインポート）</th>
          <th>共通/共用できる要素</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>起動導線</td>
          <td>ホームアイコン → `/immersive.html` → WebXR</td>
          <td>ホームアイコン → （新規）`/importer.html` → ユーザーシーン読み込み</td>
          <td>PWA manifest / Service Worker / OPFS / adb reverse 等</td>
        </tr>
        <tr>
          <td>シーン構成</td>
          <td>標準グリッド＋ライト＋SceneManager</td>
          <td>ユーザー提供シーンを読み込み差し替え</td>
          <td>`createChocoDrop`、`SceneManager`、`LiveCommandClient` など</td>
        </tr>
        <tr>
          <td>UI 表示位置</td>
          <td>現状はブラウザ UI（ダッシュボード）。将来的に XR パネルへ移設</td>
          <td>初期ロード時から XR 空間に 3D パネルを配置</td>
          <td>UI コンポーネント、OPFS 保存、エラーログ蓄積</td>
        </tr>
        <tr>
          <td>ユーザー価値</td>
          <td>ChocoDrop が単体で動作し導入障壁が低い</td>
          <td>既存シーンを即座に XR 化でき柔軟性が高い</td>
          <td>共通の生成 API、モデル選択、ログ収集</td>
        </tr>
        <tr>
          <td>主な追加開発</td>
          <td>XR 内 UI、生成結果 HUD、ワークフロー最適化</td>
          <td>シーン読込設定、権限管理、XR UI の動的配置</td>
          <td>設定 UI、OPFS スキーマ、テスト手順、CI/CD</td>
        </tr>
      </tbody>
    </table>
  </section>

  <section id="tasks">
    <h2>6. 今後の検討タスク</h2>
    <ol>
      <li><strong>XR UI の実装:</strong> WebXR Layers / 3D パネルでフォームとログを XR 内に配置し、コントローラ／音声入力を検討。</li>
      <li><strong>シーン取込フロー:</strong> GLTF/JSON/独自 API を読み込み、`createChocoDrop` を適用するユーティリティを整備。</li>
      <li><strong>設定と永続化:</strong> OPFS にシーン URL・サービス設定・UI 配置を保存し、ダッシュボードから編集。</li>
      <li><strong>ユーザーテスト:</strong> 自立型・取り込み型双方のプロトタイプを用意し、価値を検証して優先度を決定。</li>
    </ol>
  </section>

  <section id="structure">
    <h2>7. プロジェクト構成に関する考察</h2>
    <ul>
      <li>現行リポジトリ内でモード切り替え可能。エントリーポイントや設定で制御する方針が有効。</li>
      <li>大規模なアーキテクチャ差が発生しない限り、プロジェクトを分割する必要はない。</li>
      <li>オンボーディング時は本ドキュメントと UI/UX 設計・技術検証レポートをセットで共有する。</li>
    </ul>
  </section>

  <section id="pivot-strategy">
    <h2>8. 取り込み型＋ブックマークレット誘導戦略</h2>
    <h3>8.1 ピボット背景</h3>
    <ul>
      <li>コード追記への心理的抵抗と環境差による不安定さがあった。</li>
      <li>取り込み型なら ChocoDrop が初期化を制御し、シーンごとのばらつきを抑制できる。</li>
    </ul>
    <h3>8.2 二段階誘導</h3>
    <ol>
      <li><strong>ブックマークレット改良:</strong> 現在のページに軽量 UI をオーバーレイし、子アプリ体験を提供。</li>
      <li><strong>PWA ランチャー誘導:</strong> 気に入ったらワンクリックで PWA ランチャーを開き、シーン設定を引き継いで XR 体験を開始。</li>
    </ol>
    <h3>8.3 メリットと懸念</h3>
    <ul>
      <li>コード改変不要で導入障壁が低く、子アプリ → 親アプリへの移行がスムーズ。</li>
      <li>外部シーン生成サービスとも連携しやすく、ChocoDrop をハブ化しやすい。</li>
      <li>CSP 制約・著作権・設定保存先・外部 API 依存性などの課題を事前に整理する必要がある。</li>
    </ul>
  </section>

  <section id="resources">
    <h2>9. 共有資料リンク</h2>
    <figure>
      <img src="architecture-diagram.svg" alt="ChocoDropアーキテクチャ図">
      <figcaption>アーキテクチャ図（`output/architecture-diagram.svg`）</figcaption>
    </figure>
    <figure>
      <img src="pwa-test-flow.svg" alt="PWA/XR テストフロー図">
      <figcaption>PWA / XR テストフロー図（`output/pwa-test-flow.svg`）</figcaption>
    </figure>
    <ul>
      <li><a href="scene-import-tutorial.md">シーン取り込みチュートリアル</a></li>
      <li><a href="settings-schema.md">設定スキーマ概要</a></li>
      <li><a href="xr-ui-prototype-notes.md">XR UI プロトタイプ仕様メモ</a></li>
    </ul>
  </section>

  <section id="materials">
    <h2>10. 理解促進のためにあると良いもの</h2>
    <ul>
      <li>アーキテクチャ図とネットワーク構成の詳細解説資料</li>
      <li>シーン取り込み手順のスクリーンショット付きチュートリアル</li>
      <li>XR UI プロトタイプの動画モック（将来的に収録）</li>
      <li>設定スキーマを基にした OPFS / クラウド同期フロー図</li>
      <li>テストフロー（adb reverse → npm run dev → ngrok → インストール → オフライン検証）の時系列図</li>
    </ul>
    <p>これらの資料を整備することで、新規メンバーやステークホルダーが両モードの違いとロードマップを素早く把握できます。</p>
  </section>

  <footer>
    &copy; 2025 ChocoDrop Project. このドキュメントは会話ログをもとに作成された内部共有資料です。
  </footer>
</body>
</html>
