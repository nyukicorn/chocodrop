# VR/AR機能実装タスクリスト

## 📋 実装優先順位

このリストは`VR_AR_IMPLEMENTATION_PLAN.md`に基づいた具体的な実装タスクです。

---

## 🔴 Phase 1: WebXR基盤構築（最優先）

### タスク1.1: WebXRManagerの作成
- [ ] `src/client/WebXRManager.js`を新規作成
- [ ] `navigator.xr`のサポート検出機能
- [ ] VRセッション開始/終了メソッド
- [ ] ARセッション開始/終了メソッド
- [ ] エラーハンドリング・フォールバック処理
- [ ] イベントリスナー（session start/end）
- **工数**: 3日
- **ファイル**: `src/client/WebXRManager.js`

### タスク1.2: Three.js VRButton統合
- [ ] `SceneManager.js`にVRButton追加
- [ ] `renderer.xr.enabled = true`の設定
- [ ] VRアニメーションループへの切り替え
- [ ] `renderer.setAnimationLoop()`の実装
- [ ] VR/非VRモードの切り替え処理
- **工数**: 2日
- **ファイル**: `src/client/SceneManager.js:12-100`

### タスク1.3: ARButton統合
- [ ] `SceneManager.js`にARButton追加
- [ ] `immersive-ar`セッションリクエスト
- [ ] AR用ヒットテスト機能
- [ ] AR/非ARモードの切り替え処理
- **工数**: 1日
- **ファイル**: `src/client/SceneManager.js:12-100`

### タスク1.4: 空間参照システム
- [ ] `viewer`参照空間の実装
- [ ] `local`参照空間の実装
- [ ] `local-floor`参照空間の実装
- [ ] `bounded-floor`参照空間の実装
- [ ] 参照空間の切り替え機能
- [ ] `getOffsetReferenceSpace()`による精度向上
- **工数**: 2日
- **ファイル**: `src/client/WebXRManager.js`

### タスク1.5: XRフレームループ統合
- [ ] `XRFrame`からのポーズ取得
- [ ] カメラ位置の更新
- [ ] ビュー行列の適用
- [ ] ステレオレンダリング（左右の目）
- **工数**: 2日
- **ファイル**: `src/client/SceneManager.js:4304-4350`

**Phase 1合計工数**: 10日（2週間）

---

## 🟠 Phase 2: ハンドトラッキング（差別化の核）

### タスク2.1: HandTrackingManagerの作成
- [ ] `src/client/HandTrackingManager.js`を新規作成
- [ ] `XRHand`インターフェースの取得
- [ ] 左手・右手の25ジョイント位置取得
- [ ] ジョイントの3D座標変換
- [ ] 手のビジュアライゼーション（ワイヤーフレーム）
- [ ] 手のメッシュモデル表示（オプション）
- **工数**: 4日
- **ファイル**: `src/client/HandTrackingManager.js`

### タスク2.2: GestureRecognizerの作成
- [ ] `src/client/GestureRecognizer.js`を新規作成
- [ ] **ピンチジェスチャー**:
  - [ ] 親指と人差し指の距離計算
  - [ ] 閾値判定（2cm以内でピンチ）
  - [ ] ピンチ開始/終了イベント
- [ ] **グラブジェスチャー**:
  - [ ] 全指の曲がり具合を計算
  - [ ] グラブ判定（すべての指が閉じている）
  - [ ] グラブ開始/終了イベント
- [ ] **ポイントジェスチャー**:
  - [ ] 人差し指の伸び具合
  - [ ] 他の指の曲がり具合
  - [ ] ポイント方向の計算
- [ ] **カスタムジェスチャー**:
  - [ ] ポーズ定義フォーマット
  - [ ] ポーズマッチングアルゴリズム
  - [ ] ジェスチャー登録API
- **工数**: 5日
- **ファイル**: `src/client/GestureRecognizer.js`

### タスク2.3: ピンチでオブジェクトを掴む
- [ ] `SceneManager.js`にハンドインタラクション追加
- [ ] ピンチ位置からのレイキャスト
- [ ] オブジェクト選択（ピンチ時）
- [ ] オブジェクトのハイライト表示
- [ ] 選択解除（ピンチ解放時）
- **工数**: 2日
- **ファイル**: `src/client/SceneManager.js:448-600`

### タスク2.4: ピンチドラッグでオブジェクト移動
- [ ] ピンチ継続中の手の移動検出
- [ ] オブジェクトを手の位置に追従
- [ ] 慣性計算（手を離した後の動き）
- [ ] 移動範囲の制限（必要に応じて）
- **工数**: 2日
- **ファイル**: `src/client/SceneManager.js:448-600`

### タスク2.5: 両手ピンチでスケール変更
- [ ] 両手ピンチの同時検出
- [ ] 両手間の距離計算
- [ ] 距離に応じたスケール変更
- [ ] スケール変更のスムージング
- [ ] 最小/最大スケールの制限
- **工数**: 3日
- **ファイル**: `src/client/SceneManager.js:662-689`

### タスク2.6: グラブでオブジェクト削除
- [ ] グラブジェスチャー検出
- [ ] オブジェクトとの交差判定
- [ ] 削除確認UI（空間UI）
- [ ] グラブ継続で削除実行（1秒間）
- [ ] 削除アニメーション（フェードアウト）
- **工数**: 2日
- **ファイル**: `src/client/SceneManager.js:3784-3852`

### タスク2.7: ポイントでオブジェクト回転
- [ ] ポイントジェスチャー検出
- [ ] 手の回転角度計算
- [ ] オブジェクトの回転適用
- [ ] 回転アニメーション
- **工数**: 2日
- **ファイル**: `src/client/SceneManager.js:605-690`

**Phase 2合計工数**: 20日（4週間）

---

## 🟡 Phase 3: コントローラー対応（汎用性）

### タスク3.1: ControllerManagerの作成
- [ ] `src/client/ControllerManager.js`を新規作成
- [ ] `XRInputSource`の取得
- [ ] コントローラーの検出（左右）
- [ ] コントローラーモデルの読み込み
- [ ] `XRControllerModelFactory`の統合
- **工数**: 3日
- **ファイル**: `src/client/ControllerManager.js`

### タスク3.2: コントローラーボタンマッピング
- [ ] トリガーボタンの検出
- [ ] グリップボタンの検出
- [ ] サムスティックの入力
- [ ] A/B/X/Yボタンの検出
- [ ] ボタンイベントの発火
- **工数**: 2日
- **ファイル**: `src/client/ControllerManager.js`

### タスク3.3: レイキャスティング実装
- [ ] コントローラーからのレイ照射
- [ ] レイとオブジェクトの交差判定
- [ ] レイの視覚化（ライン表示）
- [ ] ヒットポイントの表示（円形カーソル）
- **工数**: 2日
- **ファイル**: `src/client/ControllerManager.js`

### タスク3.4: トリガーでオブジェクト選択
- [ ] トリガー押下検出
- [ ] レイヒット時にオブジェクト選択
- [ ] 選択オブジェクトのハイライト
- [ ] 選択解除（トリガー解放）
- **工数**: 1日
- **ファイル**: `src/client/SceneManager.js:74-100`

### タスク3.5: グリップでオブジェクト移動
- [ ] グリップボタン押下検出
- [ ] オブジェクトをコントローラーに固定
- [ ] コントローラー移動に追従
- [ ] グリップ解放で固定解除
- **工数**: 2日
- **ファイル**: `src/client/SceneManager.js:448-600`

### タスク3.6: サムスティックで回転/スケール
- [ ] 左右スティック → Y軸回転
- [ ] 上下スティック → スケール変更
- [ ] スティック入力のスムージング
- **工数**: 2日
- **ファイル**: `src/client/SceneManager.js:605-690, 662-689`

### タスク3.7: 振動フィードバック
- [ ] `XRInputSource.gamepad.hapticActuators`の取得
- [ ] オブジェクト選択時の振動
- [ ] オブジェクト移動時の振動
- [ ] 削除時の振動パターン
- **工数**: 1日
- **ファイル**: `src/client/ControllerManager.js`

**Phase 3合計工数**: 13日（約3週間）

---

## 🟡 Phase 4: 空間UI（使いやすさ）

### タスク4.1: SpatialUIの基盤作成
- [ ] `src/client/SpatialUI.js`を新規作成
- [ ] WorldSpace UIコンテナ
- [ ] ビルボード機能（常にカメラを向く）
- [ ] UIパネルの3D配置
- **工数**: 2日
- **ファイル**: `src/client/SpatialUI.js`

### タスク4.2: 放射状メニュー
- [ ] 手のひら位置にメニュー表示
- [ ] 円形にボタン配置（6-8個）
- [ ] ボタンのホバーエフェクト
- [ ] ボタン選択（ピンチ/トリガー）
- [ ] メニュー項目:
  - [ ] 生成（画像/動画）
  - [ ] 編集
  - [ ] 削除
  - [ ] エフェクト
  - [ ] 設定
- **工数**: 3日
- **ファイル**: `src/client/SpatialUI.js`

### タスク4.3: フローティングパネル
- [ ] 半透明のUIパネル
- [ ] パネルの3D配置（ユーザー前方）
- [ ] パネルのサイズ変更
- [ ] パネルの移動（ドラッグ）
- [ ] パネルの最小化/最大化
- **工数**: 2日
- **ファイル**: `src/client/SpatialUI.js`

### タスク4.4: コンテキストメニュー
- [ ] オブジェクト長押しでメニュー表示
- [ ] メニュー項目:
  - [ ] 編集
  - [ ] 複製
  - [ ] 削除
  - [ ] エフェクト適用
  - [ ] 情報表示
- [ ] メニュー選択後の処理
- **工数**: 2日
- **ファイル**: `src/client/SpatialUI.js`

### タスク4.5: 空間キーボード
- [ ] `src/client/SpatialKeyboard.js`を新規作成
- [ ] QWERTY配列の仮想キーボード
- [ ] キーのホバーエフェクト
- [ ] キー選択（レイポインター/ピンチ）
- [ ] テキスト入力フィールド
- [ ] バックスペース/Enter機能
- **工数**: 3日
- **ファイル**: `src/client/SpatialKeyboard.js`

### タスク4.6: 音声入力統合
- [ ] Web Speech APIの統合
- [ ] 音声認識開始/停止ボタン
- [ ] 認識結果のテキスト表示
- [ ] 既存CommandUIとの統合
- **工数**: 2日
- **ファイル**: `src/client/CommandUI.js:500-600`

### タスク4.7: オブジェクト情報パネル
- [ ] ビルボードUI（常にカメラを向く）
- [ ] 表示内容:
  - [ ] プロンプト
  - [ ] 生成時刻
  - [ ] キーワード
  - [ ] スケール/回転値
- [ ] ホバーで自動表示/非表示
- [ ] パネルのフォント・色設定
- **工数**: 2日
- **ファイル**: `src/client/SceneManager.js:4254-4303`

**Phase 4合計工数**: 16日（約3週間）

---

## 🟢 Phase 5: 高度な機能（突き抜け要素）

### タスク5.1: MultimodalControllerの作成
- [ ] `src/client/MultimodalController.js`を新規作成
- [ ] ジェスチャー + 音声入力の統合
- [ ] ジェスチャー + テキストコマンドの統合
- [ ] コントローラー + ハンドの同時操作
- [ ] マルチモーダルコマンド解析
- **工数**: 4日
- **ファイル**: `src/client/MultimodalController.js`

### タスク5.2: 空間アンカーの実装
- [ ] `src/client/SpatialAnchorManager.js`を新規作成
- [ ] AR空間へのオブジェクト固定
- [ ] 物理座標への配置
- [ ] アンカーの永続化（IndexedDB）
- [ ] セッション間の復元
- **工数**: 4日
- **ファイル**: `src/client/SpatialAnchorManager.js`

### タスク5.3: QRコードマーカー連携
- [ ] QRコードスキャン機能
- [ ] マーカー位置の検出
- [ ] マーカーを基準にしたオブジェクト配置
- [ ] マーカー情報の保存
- **工数**: 3日
- **ファイル**: `src/client/SpatialAnchorManager.js`

### タスク5.4: コロケーション機能
- [ ] `src/client/ColocationManager.js`を新規作成
- [ ] WebSocket通信の実装
- [ ] 複数ユーザーの位置同期
- [ ] 共有オブジェクトの同期
- [ ] リアルタイム編集の共有
- [ ] 競合解決（同時編集）
- **工数**: 6日
- **ファイル**: `src/client/ColocationManager.js`

### タスク5.5: ボディトラッキング
- [ ] `src/client/BodyTrackingManager.js`を新規作成
- [ ] Quest 3ボディトラッキングAPIの統合
- [ ] ジャンプ動作の検出
- [ ] 座る動作の検出
- [ ] 全身ジェスチャー認識
- [ ] アバター連動（オプション）
- **工数**: 5日
- **ファイル**: `src/client/BodyTrackingManager.js`

**Phase 5合計工数**: 22日（約4.5週間）

---

## 📊 総工数まとめ

| フェーズ | 工数（日） | 工数（週） | 優先度 |
|---------|-----------|-----------|--------|
| Phase 1: WebXR基盤 | 10 | 2 | 🔴 最高 |
| Phase 2: ハンドトラッキング | 20 | 4 | 🟠 高 |
| Phase 3: コントローラー | 13 | 2.6 | 🟡 中 |
| Phase 4: 空間UI | 16 | 3.2 | 🟡 中 |
| Phase 5: 高度な機能 | 22 | 4.4 | 🟢 低 |
| **合計** | **81** | **16.2** | - |

---

## 🎯 推奨実装順序

### MVP（Minimum Viable Product）: Phase 1-2のみ
**期間**: 6週間
**達成できること**:
- ✅ VR/ARモードで起動
- ✅ 手でオブジェクトを掴む
- ✅ ジェスチャーで移動・スケール変更
- ✅ ピンチでAI生成コンテンツ配置

### Full Version 1.0: Phase 1-4
**期間**: 約12週間（3ヶ月）
**達成できること**:
- MVP機能
- ✅ コントローラー対応
- ✅ 空間UIでコマンド入力
- ✅ 音声入力

### Full Version 2.0: Phase 1-5
**期間**: 約16週間（4ヶ月）
**達成できること**:
- Full Version 1.0機能
- ✅ マルチモーダル操作
- ✅ 空間アンカー
- ✅ コロケーション
- ✅ ボディトラッキング

---

## 📝 次のステップ

### 即座に着手すべきタスク（最優先）

1. **WebXRManagerの作成** (3日)
   - `src/client/WebXRManager.js`
   - WebXR対応の基盤を構築

2. **VRButton統合** (2日)
   - `SceneManager.js`の編集
   - VRモードの起動を実装

3. **空間参照システム** (2日)
   - `WebXRManager.js`
   - 正確な空間トラッキング

**最初の1週間で達成**: VRモードでChocoDrop起動可能

---

## 🔧 開発環境セットアップ

### 必要なデバイス
- [ ] Meta Quest 3 または Quest 3S
- [ ] （オプション）Apple Vision Pro
- [ ] 開発用PC（WebXRシミュレーター用）

### ブラウザ設定
- [ ] Meta Quest Browser（最新版）
- [ ] Chrome（WebXR Emulator拡張機能）
- [ ] Firefox Reality

### 開発ツール
- [ ] [WebXR Emulator Extension](https://github.com/MozillaReality/WebXR-emulator-extension)
- [ ] Chrome DevTools（Remote Debugging）
- [ ] Quest Developer Hub

---

## ✅ 成功の定義

### Phase 1完了の条件
- [ ] WebXR対応デバイスでVRモード起動
- [ ] VRモードで既存のオブジェクト配置が動作
- [ ] デスクトップモードに影響なし
- [ ] エラーハンドリングが適切

### Phase 2完了の条件
- [ ] 手でオブジェクトを掴める
- [ ] ピンチドラッグで移動できる
- [ ] 両手でスケール変更できる
- [ ] グラブで削除できる
- [ ] ジェスチャー認識精度95%以上

### 最終ゴール
**「AI生成コンテンツを、手で空間に配置し、直感的に編集できる唯一のWebXRプラットフォーム」として、業界で突き抜けた存在になる**
