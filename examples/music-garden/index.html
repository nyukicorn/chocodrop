<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∏ Èü≥Ê•Ω„ÅÆËä±Âúí - ChocoDrop Demo</title>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
        }
    }
    </script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Yu Gothic', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
        }

        #info {
            position: fixed;
            top: 16px;
            left: 16px;
            color: rgba(255, 255, 255, 0.95);
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 400;
            z-index: 2000;
            max-width: 280px;
            line-height: 1.5;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.15),
                        inset 0 1px 2px rgba(255, 255, 255, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        #info.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }

        .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        #hint-toggle {
            position: fixed;
            top: 16px;
            left: 16px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: rgba(255, 255, 255, 0.95);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            z-index: 99;
            display: none;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.15),
                        inset 0 1px 1px rgba(255, 255, 255, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            animation: hint-sparkle 2.5s ease-in-out infinite;
        }

        #hint-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-1px) scale(1.05);
            animation: hint-sparkle-fast 1s ease-in-out infinite;
        }

        @keyframes hint-sparkle {
            0%, 100% {
                filter: brightness(1) drop-shadow(0 0 3px rgba(139, 92, 246, 0.3));
                transform: scale(1) rotate(0deg);
            }
            25% {
                filter: brightness(1.1) drop-shadow(0 0 6px rgba(139, 92, 246, 0.5));
                transform: scale(1.02) rotate(2deg);
            }
            50% {
                filter: brightness(1.2) drop-shadow(0 0 8px rgba(139, 92, 246, 0.7));
                transform: scale(1.05) rotate(0deg);
            }
            75% {
                filter: brightness(1.1) drop-shadow(0 0 6px rgba(139, 92, 246, 0.5));
                transform: scale(1.02) rotate(-2deg);
            }
        }

        @keyframes hint-sparkle-fast {
            0%, 100% {
                filter: brightness(1.1) drop-shadow(0 0 5px rgba(139, 92, 246, 0.6));
                transform: scale(1.05) rotate(0deg);
            }
            50% {
                filter: brightness(1.3) drop-shadow(0 0 10px rgba(139, 92, 246, 0.8));
                transform: scale(1.1) rotate(5deg);
            }
        }

        .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 16px;
            color: #cbd5e0;
            cursor: pointer;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #hint-toggle {
            position: fixed;
            top: 16px;
            left: 16px;
            background: rgba(30, 40, 60, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f7fafc;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            z-index: 99;
            display: none;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        #hint-toggle:hover {
            background: rgba(30, 40, 60, 1);
            transform: translateY(-1px);
        }

        .navigation {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 100;
            display: flex;
            gap: 8px;
        }

        .nav-link {
            background: rgba(30, 40, 60, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f7fafc;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .nav-link:hover {
            background: rgba(30, 40, 60, 1);
            transform: translateY(-1px);
        }

        .title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b9d, #c44569, #6c7b95);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .description {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .controls {
            text-align: center;
        }

        .control-item {
            margin: 8px 0;
            font-size: 13px;
            opacity: 0.8;
        }

        .emoji {
            display: inline-block;
            margin-right: 8px;
        }

        .highlight {
            color: #ff6b9d;
            font-weight: bold;
        }

        .navigation {
            position: fixed;
            top: 16px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 8px;
        }

        .nav-link {
            background: rgba(30, 40, 60, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #f7fafc;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .nav-link:hover {
            background: rgba(139, 92, 246, 0.2);
            transform: translateY(-1px);
        }

        .demo-links {
            position: fixed;
            bottom: 20px;
            right: 100px;
            z-index: 100;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .demo-link {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.95);
            text-decoration: none;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.15),
                        inset 0 1px 1px rgba(255, 255, 255, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .demo-link:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25),
                        inset 0 1px 2px rgba(255, 255, 255, 0.4);
        }

        #audio-status {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .audio-active {
            color: #4CAF50 !important;
        }

        .audio-inactive {
            color: #ff6b9d !important;
        }

        .music-icon {
            display: inline-block;
            animation: music-pulse 2.5s ease-in-out infinite;
            cursor: pointer;
            color: #ff6b9d;
            text-shadow: 0 0 10px currentColor;
        }

        .music-icon:hover {
            transform: scale(1.3);
            animation: music-dance 0.8s ease-in-out infinite;
        }

        @keyframes music-pulse {
            0%, 100% {
                transform: scale(1);
                filter: brightness(1);
            }
            50% {
                transform: scale(1.1);
                filter: brightness(1.3);
            }
        }

        @keyframes music-dance {
            0%, 100% {
                transform: scale(1.3) rotate(0deg);
            }
            25% {
                transform: scale(1.4) rotate(-5deg);
            }
            75% {
                transform: scale(1.4) rotate(5deg);
            }
        }

        #info strong {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.98);
            display: block;
            margin-bottom: 10px;
            text-align: center;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
        }

        #info code {
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.95);
            padding: 3px 6px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 11px;
            font-weight: 500;
        }

        .controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 11px;
        }

        .control-item {
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .key {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 3px 8px;
            border-radius: 5px;
            font-weight: 500;
            min-width: fit-content;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1),
                        inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* Áµ±Âêà„É°„Éã„É•„Éº */
        .unified-menu {
            position: fixed;
            top: 16px;
            right: 20px;
            z-index: 1000;
        }

        .menu-toggle {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #2d3748;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
        }

        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.3), 0 3px 8px rgba(0, 0, 0, 0.1);
            opacity: 1;
        }

        .menu-dropdown {
            position: absolute;
            top: 56px;
            right: 0;
            min-width: 220px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.15), 0 4px 12px rgba(0, 0, 0, 0.08);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .menu-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .menu-item {
            display: block;
            padding: 12px 16px;
            color: #2d3748;
            text-decoration: none;
            font-size: 13px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            cursor: pointer;
            background: none;
            border-left: none;
            border-right: none;
            border-top: none;
            width: 100%;
            text-align: left;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: rgba(139, 92, 246, 0.08);
            padding-left: 20px;
            border-left: 2px solid rgba(139, 92, 246, 0.4);
        }

        .menu-item.has-submenu {
            position: relative;
            padding: 0;
            border: none;
        }

        .submenu-toggle {
            display: block;
            padding: 12px 16px;
            color: #2d3748;
            font-size: 13px;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .submenu-toggle:hover {
            background: rgba(139, 92, 246, 0.08);
            padding-left: 20px;
            border-left: 2px solid rgba(139, 92, 246, 0.4);
        }

        .submenu {
            display: none;
            background: rgba(139, 92, 246, 0.03);
            border-top: 1px solid rgba(139, 92, 246, 0.1);
        }

        .submenu.active {
            display: block;
        }

        .submenu .menu-item {
            padding-left: 32px;
            font-size: 12px;
        }

        .submenu .menu-item:hover {
            padding-left: 36px;
            background: rgba(139, 92, 246, 0.12);
        }

        /* „É°„Éã„É•„Éº„Ç¢„Ç§„Ç≥„É≥„ÅÆ„Éê„Ç¶„É≥„Çπ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .menu-icon {
            display: inline-block;
            animation: menu-bounce 2s ease-in-out infinite;
            cursor: pointer;
            transition: transform 0.2s ease;
            text-shadow: 0 0 10px currentColor;
        }

        .menu-icon:hover {
            transform: scale(1.4);
            animation: menu-bounce-fast 0.8s ease-in-out infinite;
        }

        @keyframes menu-bounce {
            0%, 100% {
                filter: brightness(1) drop-shadow(0 0 8px currentColor);
                transform: scale(1) translateY(0px);
            }
            25% {
                filter: brightness(1.3) drop-shadow(0 0 15px currentColor);
                transform: scale(1.1) translateY(-4px);
            }
            50% {
                filter: brightness(1.5) drop-shadow(0 0 20px currentColor);
                transform: scale(1.15) translateY(-8px);
            }
            75% {
                filter: brightness(1.3) drop-shadow(0 0 15px currentColor);
                transform: scale(1.1) translateY(-4px);
            }
        }

        @keyframes menu-bounce-fast {
            0%, 100% {
                filter: brightness(1.4) drop-shadow(0 0 15px currentColor);
                transform: translateY(0px);
            }
            50% {
                filter: brightness(1.8) drop-shadow(0 0 25px currentColor);
                transform: translateY(-12px);
            }
        }

        /* ChocoDrop ÂãïÁîªË¶ÅÁ¥†„ÅåËä±„Å´Âüã„ÇÇ„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã */
        video {
            z-index: 20 !important;
            position: relative !important;
        }

        /* ChocoDrop UIË¶ÅÁ¥†„ÅÆz-index */
        .chocodrop-ui, .chocodrop-overlay {
            z-index: 100 !important;
        }
    </style>
</head>
<body>
    <!-- Áµ±Âêà„É°„Éã„É•„Éº -->
    <div class="unified-menu">
        <button class="menu-toggle" id="unifiedMenuToggle" aria-label="Menu">‚ò∞</button>
        <div class="menu-dropdown" id="unifiedMenuDropdown">
            <button class="menu-item" id="showInfoBtn"><span class="menu-icon">üìñ</span> „Åì„ÅÆ„ÉØ„Éº„É´„Éâ„Å´„Å§„ÅÑ„Å¶</button>

            <div class="menu-item has-submenu">
                <button class="submenu-toggle" id="worldsMenuToggle"><span class="menu-icon">üåç</span> ‰∏ñÁïåÈÅ∏Êäû <span style="font-size: 10px;">‚ñº</span></button>
                <div class="submenu" id="worldsSubmenu">
                    <a href="../basic/index.html" class="menu-item"><span class="menu-icon">üç´</span> „ÅØ„Åò„Åæ„Çä„ÅÆÂõΩ</a>
                    <a href="../pixel-ocean/index.html" class="menu-item"><span class="menu-icon">üåä</span> Êµ∑Â∫ï‰∏ñÁïå</a>
                    <a href="../wabi-sabi/index.html" class="menu-item"><span class="menu-icon">üñ§</span> ‰æò„Å≥ÂØÇ„Å≥„ÅÆ‰∏ñÁïå</a>
                    <a href="../space/index.html" class="menu-item"><span class="menu-icon">üåå</span> ÂÆáÂÆôÁ©∫Èñì</a>
                    <a href="../toy-city/index.html" class="menu-item"><span class="menu-icon">üé°</span> AIÈÅäÂúíÂú∞</a>
                    <a href="index.html" class="menu-item"><span class="menu-icon">üå∏</span> Á°ùÂ≠ê„ÅÆËä±ÔºàÁèæÂú®Âú∞Ôºâ</a>
                </div>
            </div>

            <a href="../../index.html" class="menu-item"><span class="menu-icon">üè†</span> Home</a>
            <a href="https://github.com/nyukicorn/chocodrop" class="menu-item" target="_blank"><span class="menu-icon">üîó</span> GitHub</a>

            <button class="menu-item" id="vrMenuButton"><span class="menu-icon">ü•Ω</span> VR</button>
            <button class="menu-item" id="arMenuButton"><span class="menu-icon">ü•Ω</span> AR</button>
        </div>
    </div>

    <!-- Navigation Links (hidden - replaced by unified menu) -->
    <div class="navigation" style="display: none;">
        <a href="../../index.html" class="nav-link">üè† Home</a>
        <a href="https://github.com/nyukicorn/chocodrop" class="nav-link" target="_blank">üì¶ GitHub</a>
    </div>

    <!-- Hint Toggle Button (initially hidden) -->
    <button id="hint-toggle">üí°</button>

    <!-- Main Info Panel -->
    <div id="info">
        <button class="close-btn" onclick="hideInfoPanel()">√ó</button>
        <strong>üå∏ Á°ùÂ≠ê„ÅÆ„Åã„Åë„Çâ„ÅÆËä±„Å∏„Çà„ÅÜ„Åì„Åù</strong>

        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 12px; line-height: 1.6; text-align: center; font-style: italic;">
            Êï£„Çâ„Å∞„Å£„ÅüÁ°ùÂ≠ê„ÅÆ„Åã„Åë„Çâ„Åü„Å°„ÅåÈõÜ„Åæ„ÇäÂØÑ„ÇäÊ∑ª„ÅÑ„ÄÅÊñ∞„Åü„Å™Ëä±„Çí„Åù„Å£„Å®Âí≤„Åã„Åõ„Çã‰∏ñÁïå
        </div>

        üí° Âü∫Êú¨Êìç‰Ωú:<br>
        1. ÂãïÁîª„ÇÑÁîªÂÉè„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Å¶„Åø„Å¶ÔºÅ<br>
        2. ‚ú® Èü≥Ê•Ω„ÇíÈ≥¥„Çâ„Åô„Å®Á°ùÂ≠ê„ÅÆËä±„Åü„Å°„Åå„Ç≠„É©„Ç≠„É©„Å®ÂëºÂê∏„ÇíÂßã„ÇÅ„Åæ„Åô<br>
        3. Ë¶ñÁÇπÊìç‰Ωú: ChocoDrop „ÇíÊúÄÂ∞èÂåñ„Åó„Å¶„Éâ„É©„ÉÉ„Ç∞<br>
        4. „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí„ÇØ„É™„ÉÉ„ÇØ ‚Üí WASD„Ç≠„Éº„ÅßÁßªÂãï<br>

        <div class="controls">
            <div class="control-item">
                <span class="key">@</span>
                <span>ChocoDropËµ∑Âãï</span>
            </div>
            <div class="control-item">
                <span class="key">üç´</span>
                <span>Âè≥‰∏ã„Éú„Çø„É≥„Åã„Çâ„ÇÇËµ∑ÂãïÂèØ</span>
            </div>
        </div>
    </div>

    <div id="audio-status" class="audio-inactive">üé§ Èü≥Â£∞ÂæÖÊ©ü‰∏≠...</div>

    <!-- Demo Links (hidden - replaced by unified menu) -->
    <div class="demo-links" style="display: none;">
        <a href="../basic/index.html" class="demo-link">üç´ „ÅØ„Åò„Åæ„Çä„ÅÆÂõΩ</a>
        <a href="../pixel-ocean/index.html" class="demo-link">üåä Êµ∑Â∫ï‰∏ñÁïå</a>
        <a href="../wabi-sabi/index.html" class="demo-link">üñ§ ‰æò„Å≥ÂØÇ„Å≥</a>
        <a href="../space/index.html" class="demo-link">üåå ÂÆáÂÆôÁ©∫Èñì</a>
        <a href="../toy-city/index.html" class="demo-link">üé° AIÈÅäÂúíÂú∞</a>
    </div>

    <!-- Three.js + ChocoDrop (module preload) -->
    <script type="module">
    import ensureChocoDrop from '../../public/load-chocodrop.js';

    (async () => {
    await ensureChocoDrop();

    const THREE = window.THREE;
    const ChocoDrop = window.ChocoDrop;

    // Áµ±Âêà„É°„Éã„É•„Éº„ÅÆÂà∂Âæ°
    
        (function() {
            const menuToggle = document.getElementById('unifiedMenuToggle');
            const menuDropdown = document.getElementById('unifiedMenuDropdown');
            const worldsMenuToggle = document.getElementById('worldsMenuToggle');
            const worldsSubmenu = document.getElementById('worldsSubmenu');
            const showInfoBtn = document.getElementById('showInfoBtn');
            const infoPanel = document.getElementById('info');

            // ÂàùÂõûË®™Âïè„ÉÅ„Çß„ÉÉ„ÇØ - localStorage‰ΩøÁî®
            const FIRST_VISIT_KEY = 'music_garden_visited';
            const hasVisited = localStorage.getItem(FIRST_VISIT_KEY);

            if (!hasVisited) {
                // ÂàùÂõûË®™ÂïèÊôÇ„ÅØÊÉÖÂ†±„Éë„Éç„É´„ÇíË°®Á§∫
                if (infoPanel) {
                    infoPanel.style.display = 'block';
                }
                localStorage.setItem(FIRST_VISIT_KEY, 'true');
            } else {
                // 2ÂõûÁõÆ‰ª•Èôç„ÅØÈùûË°®Á§∫
                if (infoPanel) {
                    infoPanel.style.display = 'none';
                }
            }

            // Áµ±Âêà„É°„Éã„É•„Éº„ÅÆ„Éà„Ç∞„É´
            if (menuToggle && menuDropdown) {
                menuToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    menuDropdown.classList.toggle('active');
                });

                // Â§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
                document.addEventListener('click', (e) => {
                    if (!menuToggle.contains(e.target) && !menuDropdown.contains(e.target)) {
                        menuDropdown.classList.remove('active');
                        // „Çµ„Éñ„É°„Éã„É•„Éº„ÇÇÈñâ„Åò„Çã
                        if (worldsSubmenu) {
                            worldsSubmenu.classList.remove('active');
                        }
                    }
                });

                // Esc„Ç≠„Éº„ÅßÈñâ„Åò„Çã
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        menuDropdown.classList.remove('active');
                        if (worldsSubmenu) {
                            worldsSubmenu.classList.remove('active');
                        }
                    }
                });
            }

            // ‰∏ñÁïåÈÅ∏Êäû„Çµ„Éñ„É°„Éã„É•„Éº„ÅÆ„Éà„Ç∞„É´
            if (worldsMenuToggle && worldsSubmenu) {
                worldsMenuToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    worldsSubmenu.classList.toggle('active');
                });
            }

            // ÊÉÖÂ†±„Éë„Éç„É´Ë°®Á§∫„Éú„Çø„É≥
            if (showInfoBtn) {
                showInfoBtn.addEventListener('click', () => {
                    // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÆöÁæ©„Åï„Çå„Åü showInfoPanel() „ÇíÂëº„Å≥Âá∫„Åô
                    if (typeof showInfoPanel === 'function') {
                        showInfoPanel();
                    } else {
                        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Áõ¥Êé•Ë°®Á§∫
                        const panel = document.getElementById('info');
                        if (panel) {
                            panel.style.display = 'block';
                            panel.classList.remove('hidden');
                        }
                    }
                    menuDropdown.classList.remove('active');
                });
            }

            // VR/AR„Éú„Çø„É≥„ÅØÂæå„ÅßThree.js„ÅÆrenderer„Å®ÈÄ£Êê∫
            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶‰øùÂ≠ò
            window.unifiedMenuVRButton = document.getElementById('vrMenuButton');
            window.unifiedMenuARButton = document.getElementById('arMenuButton');
        })();

        // VR/AR Button inline implementation
        // VRButton implementation
        const VRButton = {
            createButton: function(renderer) {
                const button = document.createElement('button');

                function showEnterVR() {
                    button.style.display = '';
                    button.style.cursor = 'pointer';
                    button.style.left = 'calc(50% - 50px)';
                    button.style.width = '100px';
                    button.textContent = 'ENTER VR';
                    button.onmouseenter = function() { button.style.opacity = '1.0'; };
                    button.onmouseleave = function() { button.style.opacity = '0.5'; };
                    button.onclick = function() {
                        const session = renderer.xr.getSession();
                        if (session) {
                            session.end();
                        } else {
                            navigator.xr.requestSession('immersive-vr', {
                                optionalFeatures: ['local-floor', 'bounded-floor', 'hand-tracking']
                            }).then(session => {
                                renderer.xr.setSession(session);
                                button.textContent = 'EXIT VR';

                                session.addEventListener('end', () => {
                                    button.textContent = 'ENTER VR';
                                });
                            }).catch(err => {
                                console.error('VR session failed:', err);
                            });
                        }
                    };
                }

                function showWebXRNotFound() {
                    button.style.display = '';
                    button.style.cursor = 'auto';
                    button.style.left = 'calc(50% - 75px)';
                    button.style.width = '150px';
                    button.textContent = 'VR NOT SUPPORTED';
                    button.onmouseenter = null;
                    button.onmouseleave = null;
                    button.onclick = null;
                }

                button.style.position = 'absolute';
                button.style.bottom = '20px';
                button.style.padding = '12px 6px';
                button.style.border = '1px solid #fff';
                button.style.borderRadius = '4px';
                button.style.background = 'rgba(0,0,0,0.1)';
                button.style.color = '#fff';
                button.style.font = 'normal 13px sans-serif';
                button.style.textAlign = 'center';
                button.style.opacity = '0.5';
                button.style.outline = 'none';
                button.style.zIndex = '999';

                if ('xr' in navigator) {
                    navigator.xr.isSessionSupported('immersive-vr').then(supported => {
                        supported ? showEnterVR() : showWebXRNotFound();
                    });
                } else {
                    showWebXRNotFound();
                }

                return button;
            }
        };

        // ARButton implementation
        const ARButton = {
            createButton: function(renderer, options) {
                const button = document.createElement('button');

                function showEnterAR() {
                    button.style.display = '';
                    button.style.cursor = 'pointer';
                    button.style.left = 'calc(50% - 50px)';
                    button.style.width = '100px';
                    button.textContent = 'ENTER AR';
                    button.onmouseenter = function() { button.style.opacity = '1.0'; };
                    button.onmouseleave = function() { button.style.opacity = '0.5'; };
                    button.onclick = function() {
                        const session = renderer.xr.getSession();
                        if (session) {
                            session.end();
                        } else {
                            navigator.xr.requestSession('immersive-ar', {
                                optionalFeatures: ['hit-test', 'dom-overlay', 'local-floor'],
                                domOverlay: options?.domOverlay || { root: document.body }
                            }).then(session => {
                                renderer.xr.setSession(session);
                                button.textContent = 'EXIT AR';

                                session.addEventListener('end', () => {
                                    button.textContent = 'ENTER AR';
                                });
                            }).catch(err => {
                                console.error('AR session failed:', err);
                                alert('AR not supported: ' + err.message);
                            });
                        }
                    };
                }

                function showWebXRNotFound() {
                    button.style.display = '';
                    button.style.cursor = 'auto';
                    button.style.left = 'calc(50% - 75px)';
                    button.style.width = '150px';
                    button.textContent = 'AR NOT SUPPORTED';
                    button.onmouseenter = null;
                    button.onmouseleave = null;
                    button.onclick = null;
                }

                button.style.position = 'absolute';
                button.style.bottom = '70px';
                button.style.padding = '12px 6px';
                button.style.border = '1px solid #fff';
                button.style.borderRadius = '4px';
                button.style.background = 'rgba(0,0,0,0.1)';
                button.style.color = '#fff';
                button.style.font = 'normal 13px sans-serif';
                button.style.textAlign = 'center';
                button.style.opacity = '0.5';
                button.style.outline = 'none';
                button.style.zIndex = '999';

                if ('xr' in navigator) {
                    navigator.xr.isSessionSupported('immersive-ar').then(supported => {
                        supported ? showEnterAR() : showWebXRNotFound();
                    });
                } else {
                    showWebXRNotFound();
                }

                return button;
            }
        };

        console.log('‚úÖ VRButton/ARButton inline implementation loaded');

        console.log('üå∏ Music Garden Loading...');
        console.log('THREE loaded:', typeof THREE !== 'undefined');

        // Basic Three.js setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });

        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setClearColor(0x0a0f1e, 1);  // Ê∑±„ÅÑÈùíÁ¥´„ÅÆËÉåÊôØ
        renderer.xr.enabled = true; // VR/ARÊúâÂäπÂåñ

        // Three.js „Ç≠„É£„É≥„Éê„Çπ„ÅÆz-index„ÇíË®≠ÂÆöÔºàÂãïÁîª„Çà„ÇäËÉåÊôØ„Å´ÈÖçÁΩÆÔºâ
        renderer.domElement.style.position = 'fixed';
        renderer.domElement.style.top = '0';
        renderer.domElement.style.left = '0';
        renderer.domElement.style.zIndex = '1';

        document.body.appendChild(renderer.domElement);

        // VR/AR„Éú„Çø„É≥„ÇíÁµ±Âêà„É°„Éã„É•„Éº„Å®ÈÄ£Êê∫Ôºàbody„Å´„ÅØËøΩÂä†„Åó„Å™„ÅÑÔºâ
        if (typeof VRButton !== 'undefined' && window.unifiedMenuVRButton) {
            console.log('‚úÖ VRButton script loaded - connecting to unified menu');

            // VR„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÈñ¢Êï∞„Çí‰ΩúÊàê
            function startVRSession() {
                if ('xr' in navigator) {
                    navigator.xr.isSessionSupported('immersive-vr').then(supported => {
                        if (supported) {
                            const sessionInit = { optionalFeatures: ['local-floor', 'bounded-floor', 'hand-tracking', 'layers'] };
                            navigator.xr.requestSession('immersive-vr', sessionInit).then(session => {
                                session.addEventListener('end', () => {
                                    renderer.xr.setSession(null);
                                });
                                renderer.xr.setSession(session);
                            });
                        } else {
                            console.log('VR not supported on this device');
                        }
                    });
                }
            }

            window.unifiedMenuVRButton.onclick = startVRSession;

            // „Çµ„Éù„Éº„Éà„ÉÅ„Çß„ÉÉ„ÇØ - Êú™„Çµ„Éù„Éº„Éà„ÅÆÂ†¥Âêà„ÅØ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´
            if ('xr' in navigator) {
                navigator.xr.isSessionSupported('immersive-vr').then(supported => {
                    if (!supported) {
                        window.unifiedMenuVRButton.style.display = 'none';
                    }
                });
            } else {
                window.unifiedMenuVRButton.style.display = 'none';
            }
        } else {
            console.log('‚ùå VRButton script not loaded or menu button not found');
            if (window.unifiedMenuVRButton) {
                window.unifiedMenuVRButton.style.display = 'none';
            }
        }

        if (typeof ARButton !== 'undefined' && window.unifiedMenuARButton) {
            console.log('‚úÖ ARButton script loaded - connecting to unified menu');

            // AR„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÈñ¢Êï∞„Çí‰ΩúÊàê
            function startARSession() {
                if ('xr' in navigator) {
                    navigator.xr.isSessionSupported('immersive-ar').then(supported => {
                        if (supported) {
                            const sessionInit = {
                                requiredFeatures: ['hit-test'],
                                optionalFeatures: ['dom-overlay'],
                                domOverlay: { root: document.body }
                            };
                            navigator.xr.requestSession('immersive-ar', sessionInit).then(session => {
                                session.addEventListener('end', () => {
                                    renderer.xr.setSession(null);
                                });
                                renderer.xr.setSession(session);
                            });
                        } else {
                            console.log('AR not supported on this device');
                        }
                    });
                }
            }

            window.unifiedMenuARButton.onclick = startARSession;

            // „Çµ„Éù„Éº„Éà„ÉÅ„Çß„ÉÉ„ÇØ - Êú™„Çµ„Éù„Éº„Éà„ÅÆÂ†¥Âêà„ÅØ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´
            if ('xr' in navigator) {
                navigator.xr.isSessionSupported('immersive-ar').then(supported => {
                    if (!supported) {
                        window.unifiedMenuARButton.style.display = 'none';
                    }
                });
            } else {
                window.unifiedMenuARButton.style.display = 'none';
            }
        } else {
            console.log('‚ùå ARButton script not loaded or menu button not found');
            if (window.unifiedMenuARButton) {
                window.unifiedMenuARButton.style.display = 'none';
            }
        }

        // üå∏ Èü≥Ê•Ω„Å´ÂèçÂøú„Åô„ÇãËä±„Çí‰ΩúÊàêÔºà„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅßÊßãÊàê„Åï„Çå„ÅüËä±Ôºâ
        function createMusicFlower(x, y, z, scale = 1) {
            const flowerGroup = new THREE.Group();

            // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅÆÁ∑èÊï∞
            const particleCount = 12000;
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const sizes = new Float32Array(particleCount);

            // „Ç¨„É©„Çπ„ÅÆ„Çà„ÅÜ„Å™ÈÄèÊòé„Å™Ëä±„Å≥„Çâ„ÅÆÂΩ¢Áä∂„Çí‰ΩúÊàê
            const petalCount = 7; // 7Êûö„ÅÆËä±„Å≥„Çâ

            for (let i = 0; i < particleCount; i++) {
                // ‰∏≠ÂøÉ„Åã„Çâ„ÅÆË∑ùÈõ¢Ôºà0=‰∏≠ÂøÉ„ÄÅ1=Â§ñÂÅ¥Ôºâ
                const radiusProgress = Math.pow(Math.random(), 0.4);
                const maxRadius = 3.5 * scale; // „Çà„ÇäÂ§ß„Åç„ÅèÂ∫É„Åí„Çã
                const baseRadius = radiusProgress * maxRadius;

                // ËßíÂ∫¶
                const angle = Math.random() * Math.PI * 2;

                // „Å©„ÅÆËä±„Å≥„Çâ„Å´Â±û„Åô„Çã„Åã
                const petalAngle = (angle / (Math.PI * 2)) * petalCount;
                const petalIndex = Math.floor(petalAngle);

                // Ëä±„Å≥„Çâ„ÅÆ‰∏≠ÂøÉËßíÂ∫¶
                const petalCenterAngle = (petalIndex / petalCount) * Math.PI * 2;
                const angleFromPetalCenter = angle - petalCenterAngle;

                // Ëä±„Å≥„Çâ„ÅÆÂΩ¢Áä∂Ôºö„Çà„ÇäÂ∫É„Åè„ÄÅÊ≥¢Êâì„Å§ÂΩ¢
                const normalizedAngle = angleFromPetalCenter / (Math.PI * 2 / petalCount);

                // Ëä±„Å≥„Çâ„ÅÆÂü∫Êú¨ÂπÖÔºà„Çà„ÇäÂ∫É„ÅèÔºâ
                const petalWidthBase = Math.exp(-Math.pow(normalizedAngle * 3.5, 2)) * 0.8;

                // Ëä±„Å≥„Çâ„ÅÆÂÖàÁ´Ø„Å´Âêë„Åã„Å£„Å¶Â∫É„Åå„Çã
                const petalExpansion = Math.pow(radiusProgress, 0.7) * 1.2;
                const petalWidth = petalWidthBase * petalExpansion;

                // ÊúÄÁµÇÁöÑ„Å™ÂçäÂæÑÔºàËä±„Å≥„Çâ„ÅÆÂΩ¢Áä∂„ÇíÈÅ©Áî®Ôºâ
                const radius = baseRadius * (1 + petalWidth);

                // XYÂ∫ßÊ®ô
                let px = Math.cos(angle) * radius;
                let py = Math.sin(angle) * radius;

                // ZÂ∫ßÊ®ôÔºöÂ§ß„Åç„ÅèÁ´ã‰ΩìÁöÑ„Å´ÊπæÊõ≤Ôºà„Ç¨„É©„Çπ„ÅÆ„Çà„ÅÜ„Å™Ê≥¢Êâì„Å§ÂΩ¢Ôºâ
                let pz = 0;

                if (radiusProgress < 0.08) {
                    // ‰∏≠ÂøÉÈÉ®ÔºöÂ∞ë„ÅóÁõõ„Çä‰∏ä„Åå„Çã
                    pz = (0.08 - radiusProgress) * 2 * scale;
                } else {
                    // Ëä±„Å≥„ÇâÈÉ®ÂàÜÔºöÂ§ß„Åç„ÅèÊ≥¢Êâì„Å§
                    const wave = Math.sin(radiusProgress * Math.PI);
                    const petalCurvature = Math.exp(-Math.pow(normalizedAngle * 2.5, 2));

                    // Ëä±„Å≥„Çâ„ÅåÂ§ß„Åç„Åè‰∏ä‰∏ã„Å´Â∫É„Åå„Çã
                    const verticalSpread = wave * petalCurvature * 2.5 * scale;

                    // Ëä±„Å≥„Çâ„ÅÆÊ≥¢Êâì„Å°Ôºà„Ç¨„É©„Çπ„ÅÆ„Çà„ÅÜ„Å™‰∏çË¶èÂâá„Å™Ê≥¢Ôºâ
                    const ripple = Math.sin(radiusProgress * Math.PI * 3 + angle * 2) * 0.3;

                    // Ëä±„Å≥„Çâ„ÅÆÂÖàÁ´Ø„ÅåÂÑ™ÈõÖ„Å´Âèç„Çã
                    const tipCurl = Math.pow(radiusProgress, 2) * 1.2;

                    pz = verticalSpread + ripple * scale + tipCurl * scale;
                }

                // „Çà„ÇäÂ§ß„Åç„Å™„Éé„Ç§„Ç∫„ÅßÊúâÊ©üÁöÑ„Å™Ë≥™ÊÑü
                px += (Math.random() - 0.5) * 0.06 * scale;
                py += (Math.random() - 0.5) * 0.06 * scale;
                pz += (Math.random() - 0.5) * 0.08 * scale;

                positions[i * 3] = px;
                positions[i * 3 + 1] = py;
                positions[i * 3 + 2] = pz;

                // „Ç¨„É©„Çπ„ÅÆ„Çà„ÅÜ„Å™ÈÄèÊòéÊÑü„ÅÆ„ÅÇ„Çã„Éë„Çπ„ÉÜ„É´„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥
                let hue, saturation, lightness;

                if (radiusProgress < 0.08) {
                    // ‰∏≠ÂøÉÔºöÊüî„Çâ„Åã„ÅÑÈªÑËâ≤
                    const t = radiusProgress / 0.08;
                    hue = 0.12;
                    saturation = 0.6 - t * 0.2;
                    lightness = 0.85 - t * 0.1;
                } else {
                    // Ëä±„Å≥„ÇâÈÉ®ÂàÜÔºö„Éë„Çπ„ÉÜ„É´„Éî„É≥„ÇØ‚Üí„É©„Éô„É≥„ÉÄ„Éº‚Üí„Éñ„É´„Éº
                    const t = (radiusProgress - 0.08) / (1.0 - 0.08);

                    // Ëâ≤Áõ∏„ÇíÊªë„Çâ„Åã„Å´Â§âÂåñÔºà„Éë„Çπ„ÉÜ„É´„Éà„Éº„É≥Ôºâ
                    if (t < 0.3) {
                        // „Éë„Çπ„ÉÜ„É´„Éî„É≥„ÇØ
                        const localT = t / 0.3;
                        hue = 0.92 + localT * 0.05;
                        saturation = 0.3 + localT * 0.15;
                        lightness = 0.85 - localT * 0.1;
                    } else if (t < 0.6) {
                        // „Éî„É≥„ÇØ‚Üí„É©„Éô„É≥„ÉÄ„Éº
                        const localT = (t - 0.3) / 0.3;
                        hue = 0.97 - localT * 0.15;
                        saturation = 0.45 + localT * 0.1;
                        lightness = 0.75 - localT * 0.05;
                    } else {
                        // „É©„Éô„É≥„ÉÄ„Éº‚Üí„Ç¢„Ç§„Çπ„Éñ„É´„Éº
                        const localT = (t - 0.6) / 0.4;
                        hue = 0.82 - localT * 0.3;
                        saturation = 0.55 - localT * 0.15;
                        lightness = 0.70 + localT * 0.05;
                    }
                }

                // ÂæÆÁ¥∞„Å™„Éê„É™„Ç®„Éº„Ç∑„Éß„É≥„ÅßËá™ÁÑ∂„Å™ÈÄèÊòéÊÑü
                hue += (Math.random() - 0.5) * 0.03;
                saturation += (Math.random() - 0.5) * 0.08;
                lightness += (Math.random() - 0.5) * 0.06;

                const color = new THREE.Color().setHSL(
                    (hue + 1) % 1,
                    Math.max(0, Math.min(1, saturation)),
                    Math.max(0.4, Math.min(0.95, lightness)) // „Çà„ÇäÊòé„Çã„Åè
                );

                colors[i * 3] = color.r;
                colors[i * 3 + 1] = color.g;
                colors[i * 3 + 2] = color.b;

                // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅÆ„Çµ„Ç§„Ç∫Ôºà‰∏≠ÂøÉÈÉ®ÂàÜ„ÅØÂ∞è„Åï„Åè„ÄÅÂ§ñÂÅ¥„Å´Âêë„Åã„Å£„Å¶Â§ß„Åç„ÅèÔºâ
                const particleSize = 0.08 + radiusProgress * 0.12;
                sizes[i] = particleSize * scale * (0.9 + Math.random() * 0.2);
            }

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            // ÂÖÉ„ÅÆËâ≤„Çí‰øùÂ≠òÔºàÈü≥Ê•ΩÂèçÂøú„ÅßËâ≤„ÇíÂ§â„Åà„ÅüÂæå„Å´Êàª„Åô„Åü„ÇÅÔºâ
            const originalColors = new Float32Array(colors.length);
            for (let i = 0; i < colors.length; i++) {
                originalColors[i] = colors[i];
            }

            // ÂÖÉ„ÅÆ‰ΩçÁΩÆ„Çí‰øùÂ≠òÔºàÈü≥Ê•ΩÂèçÂøú„ÅßÂ∫É„Åå„Å£„ÅüÂæå„Å´Êàª„Åô„Åü„ÇÅÔºâ
            const originalPositions = new Float32Array(positions.length);
            for (let i = 0; i < positions.length; i++) {
                originalPositions[i] = positions[i];
            }

            const material = new THREE.PointsMaterial({
                size: 0.18 * scale,
                vertexColors: true,
                transparent: true,
                opacity: 0.6, // „Çà„ÇäÈÄèÊòé„Å´
                blending: THREE.NormalBlending, // „Ç¨„É©„Çπ„ÅÆ„Çà„ÅÜ„Å™Ëá™ÁÑ∂„Å™„Éñ„É¨„É≥„Éâ
                sizeAttenuation: true,
                depthWrite: false,
                map: createCircleTexture() // ÂÜÜÂΩ¢„ÉÜ„ÇØ„Çπ„ÉÅ„É£„ÅßÊªë„Çâ„Åã„Å´
            });

            // ÂÜÜÂΩ¢„ÉÜ„ÇØ„Çπ„ÉÅ„É£„Çí‰ΩúÊàêÔºà„Ç∞„É≠„ÉºÂäπÊûúÔºâ
            function createCircleTexture() {
                const canvas = document.createElement('canvas');
                canvas.width = 64;
                canvas.height = 64;
                const ctx = canvas.getContext('2d');

                const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
                gradient.addColorStop(0, 'rgba(255,255,255,1)');
                gradient.addColorStop(0.3, 'rgba(255,255,255,0.8)');
                gradient.addColorStop(0.6, 'rgba(255,255,255,0.3)');
                gradient.addColorStop(1, 'rgba(255,255,255,0)');

                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 64, 64);

                const texture = new THREE.Texture(canvas);
                texture.needsUpdate = true;
                return texture;
            }

            const particles = new THREE.Points(geometry, material);
            flowerGroup.add(particles);

            const allPetals = [particles];
            const allBaseColors = [];
            const centerPetals = [];

            // ËøΩÂä†„ÅÆ„Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„ÉàÁî®„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
            const sparkleCount = 500; // Â§ßÂπÖ„Å´Â¢ó„ÇÑ„Åô
            const sparklePositions = new Float32Array(sparkleCount * 3);
            const sparkleColors = new Float32Array(sparkleCount * 3);
            const sparkleSizes = new Float32Array(sparkleCount);
            const sparklePhases = new Float32Array(sparkleCount); // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„ÅÆ‰ΩçÁõ∏

            for (let i = 0; i < sparkleCount; i++) {
                const r = Math.random() * 4.5 * scale; // „Çà„ÇäÂ∫ÉÁØÑÂõ≤„Å´
                const theta = Math.random() * Math.PI * 2;
                const zOffset = (Math.random() - 0.5) * 4 * scale; // „Çà„ÇäÈ´ò‰ΩéÂ∑Æ„Çí„Å§„Åë„Çã

                sparklePositions[i * 3] = Math.cos(theta) * r;
                sparklePositions[i * 3 + 1] = Math.sin(theta) * r;
                sparklePositions[i * 3 + 2] = zOffset;

                // „Éë„Çπ„ÉÜ„É´„Ç´„É©„Éº„Åß„Ç≠„É©„Ç≠„É©Ôºà„Çà„ÇäÊòé„Çã„ÅèÔºâ
                const hue = Math.random() * 0.3 + 0.5; // Èùí„Äú„Éî„É≥„ÇØÁ≥ª
                const color = new THREE.Color().setHSL(hue, 0.6, 0.85); // ÊòéÂ∫¶„Çí‰∏ä„Åí„Çã
                sparkleColors[i * 3] = color.r;
                sparkleColors[i * 3 + 1] = color.g;
                sparkleColors[i * 3 + 2] = color.b;

                sparkleSizes[i] = (0.04 + Math.random() * 0.08) * scale;
                sparklePhases[i] = Math.random() * Math.PI * 2; // „É©„É≥„ÉÄ„É†„Å™‰ΩçÁõ∏
            }

            const sparkleGeometry = new THREE.BufferGeometry();
            sparkleGeometry.setAttribute('position', new THREE.BufferAttribute(sparklePositions, 3));
            sparkleGeometry.setAttribute('color', new THREE.BufferAttribute(sparkleColors, 3));

            // „Ç≠„É©„Ç≠„É©Áî®„ÅÆÂÜÜÂΩ¢„ÉÜ„ÇØ„Çπ„ÉÅ„É£„Çí‰ΩúÊàê
            function createSparkleTexture() {
                const canvas = document.createElement('canvas');
                canvas.width = 64;
                canvas.height = 64;
                const ctx = canvas.getContext('2d');

                // „Çà„ÇäÊòé„Çã„ÅèÂÖâ„Çã„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥
                const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
                gradient.addColorStop(0, 'rgba(255,255,255,1)');
                gradient.addColorStop(0.1, 'rgba(255,255,255,1)');
                gradient.addColorStop(0.3, 'rgba(255,255,255,0.9)');
                gradient.addColorStop(0.6, 'rgba(255,255,255,0.5)');
                gradient.addColorStop(1, 'rgba(255,255,255,0)');

                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 64, 64);

                const texture = new THREE.Texture(canvas);
                texture.needsUpdate = true;
                return texture;
            }

            const sparkleMaterial = new THREE.PointsMaterial({
                size: 0.12 * scale, // „Çà„ÇäÂ§ß„Åç„Åè
                vertexColors: true,
                transparent: true,
                opacity: 0.85, // „Çà„ÇäÊòé„Çã„Åè
                blending: THREE.AdditiveBlending,
                sizeAttenuation: true,
                depthWrite: false,
                map: createSparkleTexture() // ÂÜÜÂΩ¢„ÉÜ„ÇØ„Çπ„ÉÅ„É£„Åß„Çà„ÇäÁæé„Åó„Åè
            });

            const sparkles = new THREE.Points(sparkleGeometry, sparkleMaterial);
            flowerGroup.add(sparkles);

            // sparkle„ÅÆ‰ΩçÁõ∏„Éá„Éº„Çø„Å®ÂÖÉ„ÅÆ‰ΩçÁΩÆ„ÇÇ‰øùÂ≠ò
            const originalSparklePositions = new Float32Array(sparklePositions.length);
            for (let i = 0; i < sparklePositions.length; i++) {
                originalSparklePositions[i] = sparklePositions[i];
            }

            sparkles.userData = {
                phases: sparklePhases,
                originalPositions: originalSparklePositions
            };

            flowerGroup.position.set(x, y, z);

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„Éá„Éº„Çø
            flowerGroup.userData = {
                originalScale: scale,
                mainParticles: particles,
                sparkles: sparkles,
                pulsePhase: Math.random() * Math.PI * 2,
                originalColors: originalColors, // ÂÖÉ„ÅÆËâ≤„Çí‰øùÂ≠ò
                originalPositions: originalPositions // ÂÖÉ„ÅÆ‰ΩçÁΩÆ„Çí‰øùÂ≠ò
            };

            return flowerGroup;
        }

        // üéµ Web Audio API „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        let audioContext;
        let analyser;
        let dataArray;
        let isAudioActive = false;

        function initAudioContext() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                console.log('üéµ Audio context initialized');
            } catch (error) {
                console.warn('üö´ Audio context not supported:', error);
            }
        }

        function connectVideoToAudio(videoElement) {
            console.log('üîó Attempting to connect video to audio...');
            console.log('üì∫ Video element:', videoElement);

            if (!audioContext || !analyser) {
                console.warn('üö´ Audio context not initialized, initializing now...');
                initAudioContext();
                if (!audioContext || !analyser) {
                    console.error('‚ùå Failed to initialize audio context');
                    return;
                }
            }

            try {
                console.log('üîä AudioContext state before connection:', audioContext.state);

                // AudioContext„Ååsuspended„ÅÆÂ†¥Âêà„ÄÅÂÜçÈñã„Åô„Çã
                if (audioContext.state === 'suspended') {
                    console.log('‚è∏Ô∏è AudioContext is suspended, resuming...');
                    audioContext.resume().then(() => {
                        console.log('‚ñ∂Ô∏è AudioContext resumed successfully');
                    }).catch(err => {
                        console.error('‚ùå Failed to resume AudioContext:', err);
                    });
                }

                // Êó¢„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                if (videoElement.audioSource) {
                    console.log('‚úÖ Video already connected to audio');
                    return;
                }

                console.log('üé¨ Creating MediaElementSource...');
                const source = audioContext.createMediaElementSource(videoElement);
                console.log('üéµ Connecting source to analyser...');
                source.connect(analyser);
                console.log('üîä Connecting analyser to destination...');
                analyser.connect(audioContext.destination);

                // Êé•Á∂öÊ∏à„Åø„Éû„Éº„ÇØ
                videoElement.audioSource = source;

                isAudioActive = true;
                updateAudioStatus('üé§ Èü≥Â£∞Ëß£Êûê‰∏≠...', 'audio-active');
                console.log('‚úÖ Video successfully connected to audio analyser');

                // Èü≥Â£∞„Éá„Éº„Çø„ÅÆ„ÉÜ„Çπ„Éà
                setTimeout(() => {
                    if (analyser && dataArray) {
                        analyser.getByteFrequencyData(dataArray);
                        const testVolume = dataArray.reduce((sum, freq) => sum + freq, 0) / dataArray.length / 255;
                        console.log('üß™ Audio test - Volume level:', testVolume);
                        if (testVolume > 0.01) {
                            console.log('üéµ Audio is being detected!');
                        } else {
                            console.log('üîá No audio detected. Video might be muted or have no audio track.');
                        }
                    }
                }, 1000);

            } catch (error) {
                console.error('‚ùå Failed to connect video to audio:', error);
                console.log('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });

                if (error.name === 'InvalidStateError') {
                    console.log('‚ö†Ô∏è InvalidStateError - Video already connected to another AudioContext!');
                    console.log('üí° This means ChocoDrop is using its own AudioContext.');
                    console.log('üîß Trying alternative approach...');

                    // ‰ª£ÊõøÊ°àÔºöÊó¢Â≠ò„ÅÆ audio „Åã„ÇâÈü≥Â£∞„Éá„Éº„Çø„Çí„Ç≥„Éî„Éº
                    tryAlternativeAudioConnection(videoElement);
                } else if (error.name === 'NotSupportedError') {
                    console.log('‚ùå NotSupportedError - Audio context creation failed');
                } else {
                    console.log('‚ùì Unknown error:', error.name);
                }
            }
        }

        function tryAlternativeAudioConnection(videoElement) {
            console.log('üîÑ Trying alternative audio connection method...');

            // ÊñπÊ≥ï1: Web Audio API „Çí‰Ωø„Çè„Åö„Å´„ÄÅÁõ¥Êé• video „ÅÆÈü≥Èáè„ÇíÁõ£Ë¶ñ
            const alternativeMonitor = () => {
                if (videoElement.paused) return;

                // Á∞°ÊòìÁöÑ„Å™Èü≥ÈáèÊ§úÂá∫ÔºàÂÆåÁíß„Åß„ÅØ„Å™„ÅÑ„ÅåÂãï‰Ωú„Åô„ÇãÔºâ
                const currentTime = videoElement.currentTime;
                const duration = videoElement.duration;
                const volume = videoElement.volume;

                // ÂÜçÁîüÊôÇÈñì„Éô„Éº„Çπ„ÅÆÁ∞°Êòì„Éë„É´„ÇπÁîüÊàê
                const timeBasedVolume = Math.sin(currentTime * 10) * 0.3 + 0.7;

                // Èü≥Ê•Ω„ÅåÂÜçÁîü‰∏≠„Å™„ÇâËä±„ÇíÂèçÂøú„Åï„Åõ„Çã
                if (currentTime > 0 && !videoElement.paused && volume > 0) {
                    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíË®≠ÂÆö„Åó„Å¶Ëä±„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈßÜÂãï
                    window.alternativeAudioData = {
                        volume: timeBasedVolume * volume,
                        isActive: true,
                        timestamp: Date.now()
                    };

                    if (!isAudioActive) {
                        isAudioActive = true;
                        updateAudioStatus('üéµ ‰ª£ÊõøÈü≥Â£∞Áõ£Ë¶ñ‰∏≠...', 'audio-active');
                        console.log('‚úÖ Alternative audio monitoring started');
                    }
                }
            };

            // 100msÊØé„Å´Áõ£Ë¶ñ
            videoElement.alternativeMonitorInterval = setInterval(alternativeMonitor, 100);
            console.log('üîÑ Alternative audio monitoring interval started');
        }

        function updateAudioStatus(text, className) {
            const status = document.getElementById('audio-status');
            status.textContent = text;
            status.className = className;
        }

        // üå∏ Ëä±Áïë„Çí‰ΩúÊàê
        const flowers = [];
        const flowerPositions = [
            [0, 0, 0],      // ‰∏≠Â§Æ
            [-8, 2, -5],    // Â∑¶
            [8, -1, -3],    // Âè≥
            [-3, -3, -8],   // Â∑¶Â••
            [5, 3, -6],     // Âè≥Â••
            [0, 5, -10],    // ‰∏äÂ••
            [-6, -2, 3],    // Â∑¶ÊâãÂâç
            [7, 1, 4]       // Âè≥ÊâãÂâç
        ];

        flowerPositions.forEach(pos => {
            const flower = createMusicFlower(pos[0], pos[1], pos[2], 0.8 + Math.random() * 0.4);
            flowers.push(flower);
            scene.add(flower);
        });

        // üéµ Èü≥Ê•ΩÂèçÂøú„ÅßÊï£„Çã„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç∑„Çπ„ÉÜ„É†
        const flyingParticles = [];
        const maxFlyingParticles = 2000;

        // È£õÊï£„Éë„Éº„ÉÜ„Ç£„ÇØ„É´Áî®„ÅÆgeometry
        const flyingGeometry = new THREE.BufferGeometry();
        const flyingPositions = new Float32Array(maxFlyingParticles * 3);
        const flyingColors = new Float32Array(maxFlyingParticles * 3);
        const flyingSizes = new Float32Array(maxFlyingParticles);

        flyingGeometry.setAttribute('position', new THREE.BufferAttribute(flyingPositions, 3));
        flyingGeometry.setAttribute('color', new THREE.BufferAttribute(flyingColors, 3));
        flyingGeometry.setAttribute('size', new THREE.BufferAttribute(flyingSizes, 1));

        // ÂÜÜÂΩ¢„ÉÜ„ÇØ„Çπ„ÉÅ„É£„Çí‰ΩúÊàêÔºà„Ç∞„É≠„ÉºÂäπÊûúÔºâ
        function createParticleTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');

            const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            gradient.addColorStop(0, 'rgba(255,255,255,1)');
            gradient.addColorStop(0.2, 'rgba(255,255,255,0.9)');
            gradient.addColorStop(0.5, 'rgba(255,255,255,0.5)');
            gradient.addColorStop(0.8, 'rgba(255,255,255,0.1)');
            gradient.addColorStop(1, 'rgba(255,255,255,0)');

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 64, 64);

            const texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;
            return texture;
        }

        const flyingMaterial = new THREE.PointsMaterial({
            size: 0.15,
            vertexColors: true,
            transparent: true,
            opacity: 0.9,
            blending: THREE.AdditiveBlending,
            sizeAttenuation: true,
            depthWrite: false,
            map: createParticleTexture()
        });

        const flyingPoints = new THREE.Points(flyingGeometry, flyingMaterial);
        scene.add(flyingPoints);

        // ‚ú® Áí∞Â¢ÉÂÖâÔºàÂÖ®‰Ωì„ÇíÊüî„Çâ„Åã„ÅèÁÖß„Çâ„ÅôÔºâ
        const ambientLight = new THREE.AmbientLight(0x8090c0, 0.6);
        scene.add(ambientLight);

        // üåü „É°„Ç§„É≥„ÅÆ„Éù„Ç§„É≥„Éà„É©„Ç§„ÉàÔºàËä±„ÇíÁæé„Åó„ÅèÁÖß„Çâ„ÅôÔºâ
        const pointLight = new THREE.PointLight(0xffffff, 1.5, 50);
        pointLight.position.set(0, 10, 5);
        scene.add(pointLight);

        // ËøΩÂä†„ÅÆ„É©„Ç§„Éà1Ôºà„Éë„Çπ„ÉÜ„É´„Éî„É≥„ÇØÔºâ
        const spotLight1 = new THREE.SpotLight(0xffc0e0, 0.6);
        spotLight1.position.set(-10, 10, 10);
        spotLight1.target.position.set(0, 0, 0);
        scene.add(spotLight1);
        scene.add(spotLight1.target);

        // ËøΩÂä†„ÅÆ„É©„Ç§„Éà2Ôºà„Éë„Çπ„ÉÜ„É´„Éñ„É´„ÉºÔºâ
        const spotLight2 = new THREE.SpotLight(0xb0c5ff, 0.5);
        spotLight2.position.set(10, 8, -5);
        spotLight2.target.position.set(0, 0, 0);
        scene.add(spotLight2);
        scene.add(spotLight2.target);

        // üì∑ „Ç´„É°„É©Ë®≠ÂÆöÔºàËä±„ÅÆÁæé„Åó„Åï„ÅåÈöõÁ´ã„Å§‰ΩçÁΩÆÔºâ
        camera.position.set(-1, 6, 11);  // Â∞ë„ÅóÂ∑¶ÂÅ¥„Åã„ÇâË¶ã„Çã
        camera.lookAt(0, 0.5, 0);  // Â∞ë„Åó‰∏ä„ÇíË¶ã„Çã

        // üéÆ „Ç≥„É≥„Éà„É≠„Éº„É´
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 4;  // „ÇÇ„ÅÜÂ∞ë„ÅóËøë„Å•„Åë„Çã„Çà„ÅÜ„Å´
        controls.maxDistance = 28;
        controls.target.set(0, 0.5, 0);  // Ëä±Áïë„ÅÆÂ∞ë„Åó‰∏ä„ÇíË¶ã„Çã

        // üç´ ChocoDropÂàùÊúüÂåñ
        console.log('üîç Pre-ChocoDrop system check:');
        console.log('  - AudioContext support:', typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined');
        console.log('  - Video elements before ChocoDrop:', document.querySelectorAll('video').length);
        
        const chocoDrop = ChocoDrop.createChocoDrop(scene, {
            camera: camera,
            renderer: renderer,
            // GitHub Pages„Å™„ÅÆ„ÅßÁîüÊàêÊ©üËÉΩ„Å™„Åó„ÄÅ„Ç§„É≥„Éù„Éº„Éà„ÅÆ„Åø
            serverUrl: null,
            enableServerHealthCheck: false,  // „Çµ„Éº„Éê„Éº„É¨„ÇπÁí∞Â¢É„Å™„ÅÆ„Åß„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÁÑ°Âäπ
            skipServiceDialog: true, // GitHub PagesÁî®Ôºö„Çµ„Éº„Éì„ÇπË®≠ÂÆö„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÁÑ°ÂäπÂåñ
            sceneOptions: {
                enableMouseInteraction: true
            },
            onControlsToggle: (disabled) => {
                controls.enabled = !disabled;
            },
            onVideoAdded: (videoObject) => {
                console.log('üé¨ Video object added to scene:', videoObject);
                console.log('üîç Video object type:', typeof videoObject);
                console.log('üîç Video object constructor:', videoObject.constructor.name);
                
                // üö® ÈáçË¶Å: onVideoAdded„ÅåÂëº„Å∞„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
                console.log('üö® onVideoAdded callback was triggered!');
                console.log('üîç DOM video elements at callback time:', document.querySelectorAll('video').length);
                
                // üîç ChocoDrop Three.js „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàË©≥Á¥∞Ë™øÊüª
                console.log('üîç Video object properties:', Object.keys(videoObject));
                console.log('üîç Video object material:', videoObject.material);
                console.log('üîç Video object material map:', videoObject.material?.map);
                console.log('üîç Video object userData:', videoObject.userData);
                console.log('üîç Video object children:', videoObject.children);
                
                // üîç SceneÂÜÖ„ÅÆÂÖ®„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíË™øÊüª
                console.log('üîç Scene children count:', scene.children.length);
                scene.traverse((child) => {
                    if (child.material && child.material.map && child.material.map.image) {
                        console.log('üîç Found textured object:', child);
                        console.log('üîç Texture image:', child.material.map.image);
                        console.log('üîç Image tagName:', child.material.map.image.tagName);
                    }
                });

                // ChocoDrop „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„Çâ video Ë¶ÅÁ¥†„ÇíÁõ¥Êé•ÂèñÂæó„Åô„ÇãË©¶„Åø
                if (videoObject && videoObject.userData && videoObject.userData.videoElement) {
                    console.log('‚úÖ Found video element in userData:', videoObject.userData.videoElement);
                    connectVideoToAudio(videoObject.userData.videoElement);
                    return;
                }

                // Material„ÅÆmap„Åã„ÇâvideoElement„ÇíÊé¢„Åô
                if (videoObject.material && videoObject.material.map && videoObject.material.map.image) {
                    const videoEl = videoObject.material.map.image;
                    if (videoEl.tagName === 'VIDEO') {
                        console.log('‚úÖ Found video element in material.map.image:', videoEl);
                        connectVideoToAudio(videoEl);
                        return;
                    }
                }

                // ChocoDrop „ÅØ Three.js „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíËøî„Åô„ÅÆ„Åß„ÄÅÂÆüÈöõ„ÅÆvideoË¶ÅÁ¥†„ÇíÊé¢„Åô
                console.log('üîç Searching for video elements in 500ms...');
                setTimeout(() => {
                    const videoElements = document.querySelectorAll('video');
                    console.log(`üìπ Found ${videoElements.length} video elements`);
                    console.log('üîä AudioContext state:', audioContext ? audioContext.state : 'not initialized');
                    console.log('üéµ Analyser exists:', !!analyser);
                    console.log('üìä Data array exists:', !!dataArray);

                    if (videoElements.length === 0) {
                        console.warn('‚ùå No video elements found! ChocoDrop might not have added the video to DOM yet.');
                        // ÂÜçË©¶Ë°å
                        setTimeout(() => {
                            console.log('üîÑ Retrying video search...');
                            const retryVideos = document.querySelectorAll('video');
                            console.log(`üìπ Retry found ${retryVideos.length} video elements`);
                            if (retryVideos.length > 0) {
                                retryVideos.forEach(v => connectVideoToAudio(v));
                            }
                        }, 2000);
                    }

                    videoElements.forEach((videoElement, index) => {
                        console.log(`üé• Video ${index}:`);
                        console.log(`  - src: ${videoElement.src}`);
                        console.log(`  - readyState: ${videoElement.readyState}`);
                        console.log(`  - paused: ${videoElement.paused}`);
                        console.log(`  - volume: ${videoElement.volume}`);
                        console.log(`  - muted: ${videoElement.muted}`);
                        console.log(`  - audioTracks: ${videoElement.audioTracks ? videoElement.audioTracks.length : 'not supported'}`);
                        console.log(`  - duration: ${videoElement.duration}`);
                        console.log(`  - currentTime: ${videoElement.currentTime}`);

                        // „Åæ„Å†Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂãïÁîªË¶ÅÁ¥†„ÇíÂá¶ÁêÜ
                        if (!videoElement.audioSource) {
                            // ÂãïÁîª„ÇíÂâçÈù¢„Å´ÈÖçÁΩÆ
                            videoElement.style.zIndex = '10';
                            videoElement.style.position = 'relative';

                            // „Åô„Åê„Å´Êé•Á∂ö„ÇíË©¶„Åø„Çã
                            connectVideoToAudio(videoElement);

                            // ÂãïÁîª„ÅÆÊ∫ñÂÇô„Åå„Åß„Åç„Å¶„Åã„ÇâÂÜçÊé•Á∂ö
                            videoElement.addEventListener('loadedmetadata', () => {
                                console.log('üìπ Video metadata loaded, ensuring audio connection...');
                                if (!videoElement.audioSource) {
                                    connectVideoToAudio(videoElement);
                                }
                            });

                            // ÂÜçÁîüÈñãÂßãÊôÇ„Å´„ÇÇÁ¢∫ÂÆü„Å´Êé•Á∂ö
                            videoElement.addEventListener('play', () => {
                                console.log('‚ñ∂Ô∏è Video playing, checking audio connection...');
                                if (!videoElement.audioSource) {
                                    connectVideoToAudio(videoElement);
                                }
                            });

                            // „ÇØ„É™„ÉÉ„ÇØ„ÅßÂÜçÁîü/‰∏ÄÊôÇÂÅúÊ≠¢Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
                            videoElement.addEventListener('click', () => {
                                if (videoElement.paused) {
                                    videoElement.play();
                                    // ÂÜçÁîüÈñãÂßãÊôÇ„Å´Âº∑Âà∂ÁöÑ„Å´Èü≥Â£∞„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ
                                    setTimeout(() => {
                                        if (!isAudioActive) {
                                            console.log('üîß Force activating audio monitoring...');
                                            isAudioActive = true;
                                            updateAudioStatus('üéµ Âº∑Âà∂Èü≥Â£∞Áõ£Ë¶ñ‰∏≠...', 'audio-active');

                                            // ‰ª£ÊõøÁõ£Ë¶ñ„ÇíÈñãÂßã
                                            tryAlternativeAudioConnection(videoElement);
                                        }
                                    }, 100);
                                } else {
                                    videoElement.pause();
                                }
                            });
                        }
                    });
                }, 500);  // ChocoDrop „Åå DOM „Å´ video Ë¶ÅÁ¥†„ÇíËøΩÂä†„Åô„Çã„ÅÆ„ÇíÂæÖ„Å§
            }
        });

        // Èü≥Â£∞„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂàùÊúüÂåñ
        initAudioContext();
        
        // üéµ Three.js SceneÂÜÖ„ÅÆVideoTexture„ÇíÁõ£Ë¶ñ„Åó„Å¶Èü≥Â£∞Êé•Á∂ö
        function monitorVideoTextures() {
            let foundVideo = false;
            
            scene.traverse((child) => {
                if (child.material && child.material.map && child.material.map.image) {
                    const image = child.material.map.image;
                    
                    // HTMLVideoElement„ÇíÁô∫Ë¶ã
                    if (image instanceof HTMLVideoElement && !image.audioConnected) {
                        console.log('üéµ Found VideoTexture with HTMLVideoElement:', image);
                        console.log('  - src:', image.src);
                        console.log('  - readyState:', image.readyState);
                        console.log('  - paused:', image.paused);
                        
                        if (image.readyState >= 2) {
                            connectVideoToAudio(image);
                            image.audioConnected = true;
                            foundVideo = true;
                        }
                    }
                }
            });
            
            // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Êõ¥Êñ∞
            if (foundVideo && !window.videoTextureFound) {
                console.log('‚úÖ VideoTexture audio connection established!');
                window.videoTextureFound = true;
            }
        }
        
        // 1Áßí„Åî„Å®„Å´Áõ£Ë¶ñ
        setInterval(monitorVideoTextures, 1000);
        
        // ÂàùÂõûÂÆüË°å
        setTimeout(monitorVideoTextures, 2000);

        console.log('üç´ ChocoDrop Music Garden initialized');
        console.log('Press @ key to activate command interface');
        console.log('‰ΩøÁî®‰æã: üç´„Ç¢„Ç§„Ç≥„É≥„ÇØ„É™„ÉÉ„ÇØ„ÅßUIËµ∑Âãï„ÄÅÂãïÁîª„ÇíÈÖçÁΩÆ„Åó„Å¶Èü≥Ê•ΩÂèçÂøú!');

        // üéµ „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÇíËä±„Åã„ÇâÊîæÂá∫„Åô„ÇãÈñ¢Êï∞
        function emitParticlesFromFlower(flower, volume, time) {
            const particlesToEmit = Math.floor(volume * 15); // Èü≥Èáè„Å´Âøú„Åò„Å¶ÊîæÂá∫Êï∞„ÇíË™øÊï¥

            for (let i = 0; i < particlesToEmit; i++) {
                if (flyingParticles.length >= maxFlyingParticles) {
                    // Âè§„ÅÑ„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÇíÂÜçÂà©Áî®
                    flyingParticles.shift();
                }

                // Ëä±„ÅÆ‰ΩçÁΩÆ
                const flowerPos = flower.position;

                // Ëä±„ÅÆ‰∏≠ÂøÉ„Åã„Çâ„É©„É≥„ÉÄ„É†„Å™‰ΩçÁΩÆ„ÅßÊîæÂá∫
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * 2.5 * flower.userData.originalScale;
                const offsetX = Math.cos(angle) * radius;
                const offsetY = Math.sin(angle) * radius;
                const offsetZ = Math.random() * 1.5 * flower.userData.originalScale;

                // ÊîæÂá∫ÈÄüÂ∫¶ÔºàÈü≥Èáè„Å´Âøú„Åò„Å¶Â§âÂåñÔºâ
                const speed = (0.5 + volume * 2) * (0.8 + Math.random() * 0.4);
                const velocityAngle = angle + (Math.random() - 0.5) * 0.5;

                const particle = {
                    position: new THREE.Vector3(
                        flowerPos.x + offsetX,
                        flowerPos.y + offsetY,
                        flowerPos.z + offsetZ
                    ),
                    velocity: new THREE.Vector3(
                        Math.cos(velocityAngle) * speed,
                        Math.sin(velocityAngle) * speed,
                        (Math.random() - 0.3) * speed * 1.5
                    ),
                    color: new THREE.Color().setHSL(
                        (Math.random() * 0.3 + 0.5 + time * 0.1) % 1,
                        0.8 + Math.random() * 0.2,
                        0.6 + Math.random() * 0.2
                    ),
                    size: 0.08 + Math.random() * 0.12,
                    life: 1.0, // ÂØøÂëΩÔºà1.0„Åã„Çâ0.0„Å´Ê∏õÂ∞ëÔºâ
                    decay: 0.008 + Math.random() * 0.012
                };

                flyingParticles.push(particle);
            }
        }

        // üé¨ „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É´„Éº„Éó
        function animate() {
            requestAnimationFrame(animate);

            const time = Date.now() * 0.001;

            // Èü≥Â£∞Ëß£ÊûêÔºà„Éá„Éê„ÉÉ„Ç∞Âº∑ÂåñÁâàÔºâ
            let volume = 0;
            let frequencies = new Array(8).fill(0);

            // „Éá„Éê„ÉÉ„Ç∞: 5Áßí„Åî„Å®„Å´Áä∂ÊÖã„Çí„É≠„Ç∞Âá∫Âäõ
            if (!window.lastDebugLog || Date.now() - window.lastDebugLog > 5000) {
                console.log('üîç Audio Debug Status:');
                console.log('  - isAudioActive:', isAudioActive);
                console.log('  - analyser exists:', !!analyser);
                console.log('  - audioContext state:', audioContext ? audioContext.state : 'none');
                console.log('  - dataArray exists:', !!dataArray);
                console.log('  - video elements count:', document.querySelectorAll('video').length);
                console.log('  - alternative audio:', window.alternativeAudioData ? window.alternativeAudioData.isActive : 'none');
                window.lastDebugLog = Date.now();
            }

            if (isAudioActive && analyser) {
                analyser.getByteFrequencyData(dataArray);

                // ÂÖ®‰ΩìÈü≥Èáè„ÇíË®àÁÆó
                volume = dataArray.reduce((sum, freq) => sum + freq, 0) / dataArray.length / 255;

                // Èü≥Ê•ΩÊ§úÂá∫ÊôÇ„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞Ôºà„É≠„Ç∞„Å™„ÅóÔºâ
                if (volume > 0.005) {
                    if (!window.audioDetected) {
                        updateAudioStatus('üéµ Èü≥Ê•ΩÂèçÂøú‰∏≠!', 'audio-active');
                        window.audioDetected = true;
                    }
                } else if (window.audioDetected) {
                    updateAudioStatus('üîá Èü≥Â£∞ÂæÖÊ©ü‰∏≠...', 'audio-waiting');
                    window.audioDetected = false;
                }

                // Âë®Ê≥¢Êï∞Â∏ØÂüü„ÇíÂàÜÊûêÔºà‰ΩéÈü≥„ÄúÈ´òÈü≥Ôºâ
                const bands = 8;
                const bandSize = Math.floor(dataArray.length / bands);
                for (let i = 0; i < bands; i++) {
                    let sum = 0;
                    for (let j = 0; j < bandSize; j++) {
                        sum += dataArray[i * bandSize + j];
                    }
                    frequencies[i] = sum / bandSize / 255;
                }
            } else if (window.alternativeAudioData && window.alternativeAudioData.isActive) {
                // ‰ª£ÊõøÈü≥Â£∞Áõ£Ë¶ñ„Éá„Éº„Çø„Çí‰ΩøÁî®
                const altData = window.alternativeAudioData;
                const timeSinceUpdate = Date.now() - altData.timestamp;

                // ÊúÄÊñ∞„Éá„Éº„ÇøÔºà1Áßí‰ª•ÂÜÖÔºâ„ÅÆÂ†¥Âêà„ÅÆ„Åø‰ΩøÁî®
                if (timeSinceUpdate < 1000) {
                    volume = altData.volume;
                    // Á∞°ÊòìÁöÑ„Å™Âë®Ê≥¢Êï∞„Éá„Éº„ÇøÁîüÊàê
                    for (let i = 0; i < 8; i++) {
                        frequencies[i] = Math.sin(time * (i + 1) * 2) * volume * 0.5 + 0.5;
                    }

                    if (!window.alternativeAudioDetected) {
                        console.log('üîÑ Using alternative audio data! Volume:', volume);
                        window.alternativeAudioDetected = true;
                    }
                }
            }

            // üéµ Èü≥Ê•Ω„Å´ÂèçÂøú„Åó„Å¶Ëä±„Åã„Çâ„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÇíÊîæÂá∫
            if (volume > 0.03) {
                flowers.forEach((flower, index) => {
                    // Èü≥Èáè„ÅåÂ§ß„Åç„ÅÑÊôÇ„Å†„ÅëÊîæÂá∫ÔºàÂÖ®„Å¶„ÅÆËä±„Åã„ÇâÂ∞ë„Åó„Åö„Å§Ôºâ
                    if (Math.random() < volume * 0.3) {
                        emitParticlesFromFlower(flower, volume, time);
                    }
                });
            }

            // üåü È£õÊï£„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÇíÊõ¥Êñ∞
            const activeParticles = [];
            flyingParticles.forEach((particle, index) => {
                // ÈáçÂäõ„Å®Á©∫Ê∞óÊäµÊäó„ÇíÈÅ©Áî®
                particle.velocity.z -= 0.015; // ÈáçÂäõ
                particle.velocity.x *= 0.98; // Á©∫Ê∞óÊäµÊäó
                particle.velocity.y *= 0.98;
                particle.velocity.z *= 0.98;

                // ‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
                particle.position.add(particle.velocity);

                // ÂØøÂëΩ„ÇíÊ∏õ„Çâ„Åô
                particle.life -= particle.decay;

                // Áîü„Åç„Å¶„ÅÑ„Çã„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅÆ„Åø‰øùÊåÅ
                if (particle.life > 0 && particle.position.z > -20) {
                    activeParticles.push(particle);

                    // geometry„ÇíÊõ¥Êñ∞
                    const idx = activeParticles.length - 1;
                    flyingPositions[idx * 3] = particle.position.x;
                    flyingPositions[idx * 3 + 1] = particle.position.y;
                    flyingPositions[idx * 3 + 2] = particle.position.z;

                    flyingColors[idx * 3] = particle.color.r;
                    flyingColors[idx * 3 + 1] = particle.color.g;
                    flyingColors[idx * 3 + 2] = particle.color.b;

                    flyingSizes[idx] = particle.size * particle.life; // ÂØøÂëΩ„Å´Âøú„Åò„Å¶Â∞è„Åï„Åè„Å™„Çã
                }
            });

            // ÈÖçÂàó„ÇíÊõ¥Êñ∞
            flyingParticles.length = 0;
            flyingParticles.push(...activeParticles);

            // geometry„ÇíÊõ¥Êñ∞
            flyingGeometry.setDrawRange(0, activeParticles.length);
            flyingGeometry.attributes.position.needsUpdate = true;
            flyingGeometry.attributes.color.needsUpdate = true;
            flyingGeometry.attributes.size.needsUpdate = true;
            flyingMaterial.opacity = 0.6 + volume * 0.4;

            // üå∏ „Éë„Éº„ÉÜ„Ç£„ÇØ„É´Ëä±„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            flowers.forEach((flower, index) => {
                const userData = flower.userData;
                const mainParticles = userData.mainParticles;
                const sparkles = userData.sparkles;

                // Èü≥Ê•Ω„Å´ÂèçÂøú„Åô„Çã„Çπ„Ç±„Éº„É´
                if (volume > 0.005) {
                    const basePulse = Math.sin(time + userData.pulsePhase) * 0.1 + 1;
                    const musicScale = 1 + volume * 0.3;
                    flower.scale.setScalar(userData.originalScale * basePulse * musicScale);
                } else {
                    flower.scale.setScalar(userData.originalScale);
                }

                // „É°„Ç§„É≥„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                if (mainParticles) {
                    // ÂõûËª¢
                    mainParticles.rotation.z += 0.002 + volume * 0.01;

                    // Èü≥Ê•Ω„Å´Âêà„Çè„Åõ„Å¶Ëâ≤„ÇíÂ§âÂåñÔºàÂÖÉ„ÅÆËâ≤„Çí‰øùÊåÅÔºâ
                    const colors = mainParticles.geometry.attributes.color.array;
                    const originalColors = userData.originalColors;
                    const positions = mainParticles.geometry.attributes.position.array;
                    const originalPositions = userData.originalPositions;

                    for (let i = 0; i < colors.length; i += 3) {
                        // ÂÖÉ„ÅÆËâ≤„ÇíÂèñÂæó
                        const baseColor = new THREE.Color(
                            originalColors[i],
                            originalColors[i + 1],
                            originalColors[i + 2]
                        );

                        const hsl = {};
                        baseColor.getHSL(hsl);

                        if (volume > 0.005) {
                            // Èü≥Ê•Ω„Å´Âêà„Çè„Åõ„Å¶Ëâ≤Áõ∏„Çí„Ç∑„Éï„Éà
                            const shift = volume * 0.15 * Math.sin(time * 2 + i * 0.01);
                            const newColor = new THREE.Color().setHSL(
                                (hsl.h + shift + 1) % 1,
                                Math.min(1, hsl.s + volume * 0.1),
                                Math.min(1, hsl.l + volume * 0.1)
                            );
                            colors[i] = newColor.r;
                            colors[i + 1] = newColor.g;
                            colors[i + 2] = newColor.b;

                            // üå∏ „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Çí‰∏≠ÂøÉ„Åã„ÇâÂ§ñÂÅ¥„Å´Â∫É„Åí„Çã
                            const particleIndex = i / 3;
                            const px = originalPositions[i];
                            const py = originalPositions[i + 1];
                            const pz = originalPositions[i + 2];

                            // ‰∏≠ÂøÉ„Åã„Çâ„ÅÆË∑ùÈõ¢„ÇíË®àÁÆó
                            const dist = Math.sqrt(px * px + py * py);

                            if (dist > 0.1) {
                                // Â§ñÂÅ¥„Å´Â∫É„Åí„ÇãÈáèÔºàÈü≥Èáè„Å´Âøú„Åò„Å¶Â§âÂåñÔºâ
                                const expandAmount = 1 + volume * 0.2;
                                const wave = Math.sin(time * 3 + particleIndex * 0.05) * 0.05;
                                const finalExpand = expandAmount + wave;

                                positions[i] = px * finalExpand;
                                positions[i + 1] = py * finalExpand;
                                positions[i + 2] = pz + volume * 0.3 * Math.sin(time * 2 + particleIndex * 0.1);
                            }
                        } else {
                            // Èü≥Ê•Ω„Åå„Å™„ÅÑÊôÇ„ÅØÂÖÉ„ÅÆËâ≤„Å®‰ΩçÁΩÆ„Å´Êàª„Åô
                            colors[i] = originalColors[i];
                            colors[i + 1] = originalColors[i + 1];
                            colors[i + 2] = originalColors[i + 2];

                            positions[i] = originalPositions[i];
                            positions[i + 1] = originalPositions[i + 1];
                            positions[i + 2] = originalPositions[i + 2];
                        }
                    }
                    mainParticles.geometry.attributes.color.needsUpdate = true;
                    mainParticles.geometry.attributes.position.needsUpdate = true;

                    // ÈÄèÊòéÂ∫¶„Å®„Çµ„Ç§„Ç∫Ôºà„Ç¨„É©„Çπ„ÅÆ„Çà„ÅÜ„Å™ÈÄèÊòéÊÑü„ÇíÁ∂≠ÊåÅÔºâ
                    mainParticles.material.opacity = 0.5 + volume * 0.3;
                    mainParticles.material.size = (0.15 + volume * 0.05) * userData.originalScale;
                }

                // „Ç≠„É©„Ç≠„É©„Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                if (sparkles) {
                    // „ÇÜ„Å£„Åè„ÇäÂõûËª¢ÔºàÈü≥Ê•Ω„Åå„ÅÇ„Çå„Å∞ÈÄü„ÅèÔºâ
                    sparkles.rotation.z -= 0.002 + volume * 0.02;
                    sparkles.rotation.y += 0.001 + volume * 0.01;

                    const sparklePositions = sparkles.geometry.attributes.position.array;
                    const originalSparklePositions = sparkles.userData.originalPositions;
                    const phases = sparkles.userData.phases;

                    for (let i = 0; i < sparklePositions.length; i += 3) {
                        const particleIndex = i / 3;
                        const phase = phases[particleIndex];

                        // ÂÖÉ„ÅÆ‰ΩçÁΩÆ„ÇíÂèñÂæó
                        const origX = originalSparklePositions[i];
                        const origY = originalSparklePositions[i + 1];
                        const origZ = originalSparklePositions[i + 2];

                        // Â∏∏„Å´‰∏ä‰∏ã„Å´ÊºÇ„ÅÜÂãï„Åç
                        const floatSpeed = 0.5 + Math.sin(phase) * 0.3;
                        const floatWave = Math.sin(time * floatSpeed + phase) * 0.3;

                        // Èü≥Ê•Ω„Å´ÂèçÂøú„Åó„Å¶ÊøÄ„Åó„ÅèÂãï„Åè
                        const musicWave = Math.sin(time * 4 + phase) * volume * 0.8;

                        // Ëû∫ÊóãÁä∂„Å´Ëàû„ÅÜ
                        const spiralX = Math.cos(time * 0.3 + phase) * 0.15;
                        const spiralY = Math.sin(time * 0.3 + phase) * 0.15;

                        // ÂÖÉ„ÅÆ‰ΩçÁΩÆ„Åã„Çâ„ÅÆÁõ∏ÂØæÁöÑ„Å™Âãï„Åç
                        sparklePositions[i] = origX + spiralX;
                        sparklePositions[i + 1] = origY + spiralY;
                        sparklePositions[i + 2] = origZ + floatWave + musicWave;
                    }
                    sparkles.geometry.attributes.position.needsUpdate = true;

                    // Èü≥Ê•Ω„Åå„ÅÇ„ÇãÊôÇ„ÅØ„Çà„ÇäÊòé„Çã„Åè„ÄÅÂ§ß„Åç„ÅèÔºàÂ∏∏„Å´„Ç≠„É©„Ç≠„É©Ëºù„ÅèÔºâ
                    const twinkle = Math.sin(time * 3) * 0.3; // „Çà„ÇäÊøÄ„Åó„ÅèÊòéÊªÖ
                    sparkles.material.opacity = 0.6 + twinkle + volume * 0.4;
                    sparkles.material.size = (0.12 + Math.sin(time * 4) * 0.04 + volume * 0.15) * userData.originalScale;
                }

                // Ëä±ÂÖ®‰Ωì„ÅÆÂõûËª¢
                if (volume > 0.005) {
                    flower.rotation.x = Math.sin(time * 0.3 + index) * 0.08;
                    flower.rotation.y = Math.cos(time * 0.2 + index) * 0.04;
                }
            });

            // „É©„Ç§„Éà„ÇÇÈü≥Ê•Ω„Å´ÂèçÂøú
            pointLight.intensity = 0.8 + volume * 0.5;
            pointLight.color.setHSL((time * 0.1) % 1, 0.5, 1);

            controls.update();
            renderer.render(scene, camera);
        }

        animate();

        // üì± „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // üéØ „Éí„É≥„Éà„Éë„Éç„É´ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
        let autoHideTimer = null;

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©
        window.hideInfoPanel = function() {
            const infoPanel = document.getElementById('info');
            const hintToggle = document.getElementById('hint-toggle');

            infoPanel.classList.add('hidden');
            setTimeout(() => {
                infoPanel.style.display = 'none';
                hintToggle.style.display = 'block';
            }, 300);

            if (autoHideTimer) {
                clearTimeout(autoHideTimer);
            }
        };

        window.showInfoPanel = function() {
            const infoPanel = document.getElementById('info');
            const hintToggle = document.getElementById('hint-toggle');

            hintToggle.style.display = 'none';
            infoPanel.style.display = 'block';
            setTimeout(() => {
                infoPanel.classList.remove('hidden');
            }, 10);

            // 30ÁßíÂæå„Å´Ëá™ÂãïÈùûË°®Á§∫
            autoHideTimer = setTimeout(window.hideInfoPanel, 30000);
        };

        // „Éí„É≥„Éà„Éà„Ç∞„É´„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        document.getElementById('hint-toggle').onclick = window.showInfoPanel;

        // 30ÁßíÂæå„ÅÆËá™ÂãïÈùûË°®Á§∫„Çø„Ç§„Éû„ÉºÈñãÂßã
        autoHideTimer = setTimeout(window.hideInfoPanel, 30000);

        console.log('‚úÖ Èü≥Ê•Ω„ÅÆËä±Âúí„ÅåÊ∫ñÂÇôÂÆå‰∫ÜÔºÅüéµ Ê≠å„Å£„Å¶„ÅäËä±„ÇíÂí≤„Åã„Åõ„Åæ„Åó„Çá„ÅÜ');
    })();
    </script>
</body>
</html>
