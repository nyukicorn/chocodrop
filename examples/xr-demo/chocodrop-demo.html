<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChocoDrop XR Demo - VR/AR Integration</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #000;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 5px;
      max-width: 300px;
      font-size: 14px;
      line-height: 1.6;
      z-index: 100;
    }
    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 5px;
      color: white;
      z-index: 100;
    }
    button {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="info">
    <h3>ğŸ« ChocoDrop XR Demo</h3>
    <p><strong>ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—:</strong></p>
    <ul>
      <li>ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°: ã‚«ãƒ¡ãƒ©å›è»¢</li>
      <li>å³ãƒœã‚¿ãƒ³: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ </li>
    </ul>
    <p><strong>VR:</strong></p>
    <ul>
      <li>ãƒˆãƒªã‚¬ãƒ¼: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ/ç§»å‹•</li>
      <li>ã‚°ãƒªãƒƒãƒ—: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤</li>
    </ul>
    <p><strong>AR:</strong></p>
    <ul>
      <li>ç”»é¢ã‚¿ãƒƒãƒ—: ãƒ¬ãƒ†ã‚£ã‚¯ãƒ«ä½ç½®ã«é…ç½®</li>
      <li>å¹³é¢æ¤œå‡º: ç·‘è‰²ã®å¹³é¢è¡¨ç¤º</li>
    </ul>
  </div>

  <div id="controls">
    <h4>ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h4>
    <button id="addSphere">çƒä½“ã‚’è¿½åŠ </button>
    <button id="addBox">ç«‹æ–¹ä½“ã‚’è¿½åŠ </button>
    <button id="addCone">å††éŒã‚’è¿½åŠ </button>
    <button id="clearAll">å…¨ã¦ã‚¯ãƒªã‚¢</button>
    <div class="status" id="status">æº–å‚™å®Œäº†</div>
  </div>

  <!-- Three.js r170 CDN -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/controls/OrbitControls.js';

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«THREEå‚ç…§ã‚’è¨­å®šï¼ˆUMDãƒ“ãƒ«ãƒ‰å¯¾å¿œï¼‰
    window.THREE = THREE;

    // ChocoDrop XRãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    const { SceneManager } = await import('../../src/client/SceneManager.js');
    const { VRButton } = await import('../../src/client/xr/VRButton.js');
    const { ARButton } = await import('../../src/client/xr/ARButton.js');

    // ã‚·ãƒ¼ãƒ³ã€ã‚«ãƒ¡ãƒ©ã€ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x202020);

    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 1.6, 3);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    // OrbitControlsï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ï¼‰
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(0, 1, 0);
    controls.update();

    // ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(1, 1, 1);
    scene.add(directionalLight);

    // ã‚°ãƒªãƒƒãƒ‰ï¼ˆå‚è€ƒç”¨ï¼‰
    const gridHelper = new THREE.GridHelper(10, 10);
    scene.add(gridHelper);

    // SceneManagerã®åˆæœŸåŒ–
    const sceneManager = new SceneManager(scene, {
      camera: camera,
      renderer: renderer,
      enableXR: true,
      enableMouseInteraction: true
    });

    // VRãƒœã‚¿ãƒ³ã®è¿½åŠ 
    const vrButton = VRButton.createButton(renderer, {
      right: '20px',
      bottom: '80px',
      onSessionEnd: () => {
        updateStatus('VRã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†');
      }
    });
    document.body.appendChild(vrButton);

    // ARãƒœã‚¿ãƒ³ã®è¿½åŠ 
    const arButton = ARButton.createButton(renderer, {
      right: '20px',
      bottom: '130px',
      requiredFeatures: ['hit-test'],
      optionalFeatures: ['plane-detection', 'depth-sensing', 'anchors'],
      onSessionEnd: () => {
        updateStatus('ARã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†');
      }
    });
    document.body.appendChild(arButton);

    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ é–¢æ•°
    function addObject(type) {
      let geometry, material, mesh;

      material = new THREE.MeshPhongMaterial({
        color: Math.random() * 0xffffff,
        shininess: 30
      });

      switch (type) {
        case 'sphere':
          geometry = new THREE.SphereGeometry(0.3, 32, 32);
          break;
        case 'box':
          geometry = new THREE.BoxGeometry(0.4, 0.4, 0.4);
          break;
        case 'cone':
          geometry = new THREE.ConeGeometry(0.3, 0.6, 32);
          break;
      }

      mesh = new THREE.Mesh(geometry, material);

      // ARãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ¬ãƒ†ã‚£ã‚¯ãƒ«ä½ç½®ã«é…ç½®
      if (sceneManager.xrManager && sceneManager.xrManager.isARMode()) {
        const reticlePos = sceneManager.arController.getReticlePosition();
        if (reticlePos) {
          mesh.position.copy(reticlePos);
        } else {
          mesh.position.set(0, 0.5, -2);
        }
      } else {
        // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—/VRãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚«ãƒ¡ãƒ©å‰æ–¹ã«é…ç½®
        const offset = new THREE.Vector3(0, 0, -2);
        offset.applyQuaternion(camera.quaternion);
        mesh.position.copy(camera.position).add(offset);
      }

      // SceneManagerã«è¿½åŠ 
      const id = `object_${Date.now()}`;
      mesh.userData.id = id;
      mesh.userData.type = type;
      sceneManager.spawnedObjects.set(id, mesh);
      scene.add(mesh);

      // VRã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®é¸æŠå¯èƒ½ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
      if (sceneManager.vrController) {
        sceneManager.vrController.addSelectableObject(mesh);
      }

      updateStatus(`${type}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
    }

    // UIã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('addSphere').onclick = () => addObject('sphere');
    document.getElementById('addBox').onclick = () => addObject('box');
    document.getElementById('addCone').onclick = () => addObject('cone');
    document.getElementById('clearAll').onclick = () => {
      sceneManager.spawnedObjects.forEach((obj, id) => {
        scene.remove(obj);
        obj.geometry.dispose();
        obj.material.dispose();
      });
      sceneManager.spawnedObjects.clear();
      if (sceneManager.vrController) {
        sceneManager.vrController.setSelectableObjects([]);
      }
      updateStatus('å…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    };

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateStatus(message) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      setTimeout(() => {
        statusEl.textContent = 'æº–å‚™å®Œäº†';
      }, 3000);
    }

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
    function animate() {
      renderer.setAnimationLoop(() => {
        // XRãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°
        const frame = renderer.xr.getFrame();
        if (frame) {
          sceneManager.updateXR(frame);
        }

        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        renderer.render(scene, camera);
      });
    }

    // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // é–‹å§‹
    animate();
    updateStatus('ChocoDrop XR Demo èµ·å‹•å®Œäº†');

    console.log('ğŸ« ChocoDrop XR Demo Ready!');
    console.log('ğŸ® VR/AR buttons available below');
    console.log('ğŸ“¦ SceneManager:', sceneManager);
  </script>
</body>
</html>
