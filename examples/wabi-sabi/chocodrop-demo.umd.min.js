!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ChocoDrop={},e.THREE)}(this,function(e,t){"use strict";function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,Object.freeze(t)}var i=n(t);class o{constructor(e=null,t=null){this.serverUrl=null,this.sceneManager=t,this.initialized=!1,this.initPromise=null,e?(this.serverUrl=e,this.initialized=!0,console.log("🍫 ChocoDropClient initialized:",e)):this.initPromise=this.initializeWithConfig()}async initializeWithConfig(){try{const e=`${window.location.protocol}//${window.location.hostname}:${window.location.port}`,t=await fetch(`${e}/api/config`);if(t.ok){const e=await t.json();this.serverUrl=e.serverUrl,console.log("🍫 ChocoDropClient initialized from config:",this.serverUrl)}else this.serverUrl=this.detectServerUrl(),console.log("🍫 ChocoDropClient fallback to detected URL:",this.serverUrl)}catch(e){console.warn("⚠️ ChocoDrop config fetch failed, using fallback:",e),this.serverUrl=this.detectServerUrl()}this.initialized=!0}detectServerUrl(){const e=window.location.port,t=window.location.protocol,n=window.location.hostname;return e?`${t}//${n}:${e}`:`${t}//${n}:3011`}async ensureInitialized(){if(!this.initialized){if(!this.initPromise)throw new Error("ChocoDropClient not initialized");await this.initPromise}}createConnectionError(e){const t=this.serverUrl?`（接続先: ${this.serverUrl}）`:"";return new Error(`${e}\nサーバーへ接続できません。ChocoDrop ローカルサーバー（Express）が起動しているか確認してください（例: \`npm run dev\`）。${t}`)}isNetworkError(e){if(!e)return!1;const t="string"==typeof e.message?e.message:"";return"TypeError"===e.name||t.includes("Failed to fetch")||t.includes("NetworkError")||t.includes("connect ECONNREFUSED")||t.includes("ERR_CONNECTION")}handleRequestError(e,t){if(this.isNetworkError(e)){const n=this.createConnectionError(t);return n.code="LOCAL_SERVER_UNREACHABLE",n.cause=e,n}return e instanceof Error?e:new Error(t)}async generateImage(e,t={}){await this.ensureInitialized(),console.log(`🎨 Requesting image generation: "${e}"`);try{const n={prompt:e,width:t.width||512,height:t.height||512};t.service&&(n.service=t.service);const i=await fetch(`${this.serverUrl}/api/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!i.ok){let e=null;try{e=await i.json()}catch(e){}const t=new Error(e?.error||`Server error: ${i.status}`);throw e?.errorCategory&&(t.code=e.errorCategory),t}const o=await i.json();return console.log("✅ Image generation result:",o),o}catch(e){throw console.error("❌ Image generation request failed:",e),this.handleRequestError(e,"画像生成リクエストに失敗しました。")}}async generateVideo(e,t={}){await this.ensureInitialized(),console.log(`🎬 Requesting video generation: "${e}"`);try{const n={resolution:"720p",enable_safety_checker:!0,enable_prompt_expansion:!0},i={prompt:e,duration:"number"==typeof t.duration&&t.duration>0?t.duration:3,resolution:t.resolution||n.resolution,enable_safety_checker:t.enable_safety_checker??n.enable_safety_checker,enable_prompt_expansion:t.enable_prompt_expansion??n.enable_prompt_expansion};t.aspect_ratio&&(i.aspect_ratio=t.aspect_ratio),t.model&&(i.model=t.model),"number"==typeof t.width&&t.width>0&&(i.width=t.width),"number"==typeof t.height&&t.height>0&&(i.height=t.height),"number"==typeof t.seed&&(i.seed=t.seed),t.negative_prompt&&(i.negative_prompt=t.negative_prompt),"number"==typeof t.frames_per_second&&t.frames_per_second>0&&(i.frames_per_second=t.frames_per_second),"number"==typeof t.guidance_scale&&(i.guidance_scale=t.guidance_scale);const o=await fetch(`${this.serverUrl}/api/generate-video`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!o.ok){let e=null;try{e=await o.json()}catch(e){}const t=new Error(e?.error||`Server error: ${o.status}`);throw e?.errorCategory&&(t.code=e.errorCategory),t}const r=await o.json();return console.log("✅ Video generation result:",r),r}catch(e){throw console.error("❌ Video generation request failed:",e),this.handleRequestError(e,"動画生成リクエストに失敗しました。")}}async executeCommand(e){await this.ensureInitialized(),console.log(`🎯 Executing command: "${e}"`);try{const t=await fetch(`${this.serverUrl}/api/command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:e})});if(!t.ok){let e=null;try{e=await t.json()}catch(e){}const n=new Error(e?.error||`Server error: ${t.status}`);throw e?.errorCategory&&(n.code=e.errorCategory),n}const n=await t.json();return console.log("✅ Command execution result:",n),n}catch(e){throw console.error("❌ Command execution failed:",e),this.handleRequestError(e,"コマンド実行に失敗しました。")}}async modifySelectedObject(e,t){await this.ensureInitialized(),console.log(`🔧 Modifying selected object: "${t}"`);try{if(this.sceneManager){console.log("🎨 Using SceneManager integrated command processing");const n="string"==typeof t?t.trim():"",i=n.startsWith("[変更]")?n:`[変更] ${n}`,o=this.sceneManager.parseCommand(i);if(console.log("🔍 Parsed command result:",o),o&&(null!==o.color||o.effects&&o.effects.length>0||null!==o.movement)){let t=!1;if(null!==o.color&&e.material&&(e.material.map?(e.material.color.setHex(o.color),e.material.needsUpdate=!0,console.log(`🎨 Texture color tint changed to: #${o.color.toString(16)}`)):(e.material.color.setHex(o.color),e.material.needsUpdate=!0,console.log(`🎨 Material color changed to: #${o.color.toString(16)}`)),t=!0),o.effects&&o.effects.length>0){this.sceneManager.applyEffects(e,o.effects)&&(t=!0)}if(null!==o.movement){const n=e.position,i={x:n.x+o.movement.x,y:n.y+o.movement.y,z:n.z+o.movement.z};e.position.set(i.x,i.y,i.z),console.log(`📍 Object moved to: (${i.x.toFixed(2)}, ${i.y.toFixed(2)}, ${i.z.toFixed(2)})`),t=!0}if(t)return console.log("✅ Object modification applied successfully"),{success:!0,message:"オブジェクトを変更しました",isClientSideEffect:!0}}}console.log("🔄 Falling back to server-side processing");const n=`${t} (対象オブジェクト: ${e?.userData?.objectId||e?.id||"unknown"})`,i=await fetch(`${this.serverUrl}/api/command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:n})});if(!i.ok){let e=null;try{e=await i.json()}catch(e){}const t=new Error(e?.error||`Server error: ${i.status}`);throw e?.errorCategory&&(t.code=e.errorCategory),t}const o=await i.json();return console.log("✅ Object modification result:",o),o}catch(e){throw console.error("❌ Object modification failed:",e),this.handleRequestError(e,"オブジェクト変更リクエストに失敗しました。")}}async getAvailableServices(){await this.ensureInitialized();try{const e=await fetch(`${this.serverUrl}/api/services`);if(!e.ok)throw new Error(`Server error: ${e.status}`);return await e.json()}catch(e){return console.error("❌ Failed to get services:",e),[]}}}const r=o,a=o,s={"ユニコーン":"unicorn","ドラゴン":"dragon","龍":"dragon","怪獣":"monster","モンスター":"monster","魔法使い":"wizard","魔術師":"sorcerer","魔女":"witch","妖精":"fairy","🧚":"fairy","🧙":"wizard","魔法杖":"magic wand","杖":"wand","スタッフ":"staff","魔法":"magic","呪文":"spell","魔法陣":"magic circle","水晶玉":"crystal ball","薬瓶":"potion bottle","魔導書":"grimoire","フェニックス":"phoenix","グリフィン":"griffin","ペガサス":"pegasus","ケルベロス":"cerberus","画像":"image","写真":"photo","イメージ":"image","絵":"picture","ファイル":"file","メディア":"media","素材":"asset","動画":"video","ビデオ":"video","ムービー":"movie","映像":"video","クリップ":"clip","猫":"cat","ネコ":"cat","ねこ":"cat","犬":"dog","イヌ":"dog","いぬ":"dog","狼":"wolf","熊":"bear","ライオン":"lion","トラ":"tiger","象":"elephant","キリン":"giraffe","シマウマ":"zebra","パンダ":"panda","ウサギ":"rabbit","リス":"squirrel","ハムスター":"hamster","フクロウ":"owl","ワシ":"eagle","カラス":"crow","ハト":"dove","ペンギン":"penguin","イルカ":"dolphin","クジラ":"whale","サメ":"shark","タコ":"octopus","カニ":"crab","エビ":"shrimp","花":"flower","はな":"flower","ハナ":"flower","桜":"cherry blossom","バラ":"rose","ひまわり":"sunflower","チューリップ":"tulip","雲":"cloud","空":"sky","海":"ocean","湖":"lake","川":"river","山":"mountain","やま":"mountain","ヤマ":"mountain","森":"forest","木":"tree","き":"tree","キ":"tree","草原":"meadow","砂漠":"desert","滝":"waterfall","洞窟":"cave","島":"island","星座":"constellation","銀河":"galaxy","惑星":"planet","城":"castle","しろ":"castle","シロ":"castle","宮殿":"palace","家":"house","塔":"tower","教会":"church","神殿":"temple","図書館":"library","学校":"school","病院":"hospital","駅":"station","空港":"airport","港":"port","橋":"bridge","灯台":"lighthouse","風車":"windmill","庭":"garden","公園":"park","遊園地":"amusement park","車":"car","電車":"train","バス":"bus","飛行機":"airplane","ヘリコプター":"helicopter","船":"ship","ヨット":"yacht","自転車":"bicycle","バイク":"motorcycle","ロケット":"rocket","月":"moon","太陽":"sun","星":"star","彗星":"comet","流れ星":"shooting star","虹":"rainbow","雷":"lightning","雪":"snow","雨":"rain","嵐":"storm","霧":"fog","氷":"ice","火":"fire","水":"water","風":"wind","光":"light","影":"shadow","夜":"night","朝":"morning","夕方":"evening","赤":"red","青":"blue","緑":"green","黄色":"yellow","白":"white","黒":"black","紫":"purple","ピンク":"pink","オレンジ":"orange","茶色":"brown","グレー":"gray","金":"gold","銀":"silver","プラチナ":"platinum","銅":"copper","鉄":"iron","石":"stone","木材":"wood","ガラス":"glass","水晶":"crystal","ダイヤモンド":"diamond","鳥":"bird","とり":"bird","トリ":"bird"};function l(){const e={};for(const[t,n]of Object.entries(s))e[t]||(e[t]=[]),e[t].includes(n)||e[t].push(n);return e}function c(e){return s[e]||e}function d(e,t,n){const i=t.toLowerCase();if(i.includes(e.toLowerCase()))return!0;for(const[t,o]of Object.entries(n))if(e.includes(t))for(const e of o)if(i.includes(e.toLowerCase()))return!0;const o=c(e);return!(o===e||!i.includes(o.toLowerCase()))}"undefined"!=typeof module&&module.exports&&(module.exports={TRANSLATION_DICTIONARY:s,createObjectKeywords:l,translateKeyword:c,matchKeywordWithFilename:d});const h=globalThis.THREE||i;class p{constructor(e,t={}){if(!e)throw new Error("THREE.Scene is required");this.scene=e,this.camera=t.camera||null,this.renderer=t.renderer||null,this.labelRenderer=null,this.client=t.client||new o(t.serverUrl,this),this.experimentGroup=new h.Group,this.experimentGroup.name="LiveExperiments",this.scene.add(this.experimentGroup),this.commandHistory=[],this.spawnedObjects=new Map,this.objectCounter=0,this.selectedObject=null,this.selectedImageService=t.selectedImageService||null,this.selectedVideoService=t.selectedVideoService||null,this.audioControls=new Map,this.audioControlUpdateInterval=null,this.audioControlUpdateListener=null,this.clock=new h.Clock,this.raycaster=new h.Raycaster,this.mouse=new h.Vector2,this.lastHoveredObject=null,this.config={showLocationIndicator:!1!==t.showLocationIndicator,indicatorDuration:t.indicatorDuration||3e3,defaultObjectScale:t.defaultObjectScale||1,enableObjectSelection:!1!==t.enableObjectSelection,enableMouseInteraction:t.enableMouseInteraction,enableDebugLogging:!0===t.enableDebugLogging,...t.config},this.setupClickEvents(),console.log("🧪 SceneManager initialized with click selection"),"undefined"!=typeof globalThis&&(globalThis.sceneManager=this)}setupClickEvents(){!0===this.config.enableMouseInteraction&&this.renderer?(this.setupObjectDragging(),console.log("🖱️ Mouse interaction enabled - Click to select, Shift+drag to move objects")):!0!==this.config.enableMouseInteraction||this.renderer?console.log("🖱️ Mouse interaction disabled (safe mode). Set enableMouseInteraction: true to enable."):console.warn("⚠️ Mouse interaction requested but renderer not provided. Mouse interaction disabled.")}debugSceneInfo(){console.log("🔍 === SCENE DEBUG INFO ==="),this.camera&&console.log(`📷 Camera:\n        - Position: (${this.camera.position.x.toFixed(2)}, ${this.camera.position.y.toFixed(2)}, ${this.camera.position.z.toFixed(2)})\n        - Rotation: (${(180*this.camera.rotation.x/Math.PI).toFixed(1)}°, ${(180*this.camera.rotation.y/Math.PI).toFixed(1)}°, ${(180*this.camera.rotation.z/Math.PI).toFixed(1)}°)\n        - FOV: ${this.camera.fov||"N/A"}\n        - Near/Far: ${this.camera.near||"N/A"}/${this.camera.far||"N/A"}`),console.log(`🌳 Scene hierarchy:\n      - Total objects in scene: ${this.scene.children.length}\n      - experimentGroup exists: ${this.scene.getObjectByName("LiveExperiments")?"Yes":"No"}\n      - experimentGroup children: ${this.experimentGroup.children.length}`),console.log(`📦 Spawned objects: ${this.spawnedObjects.size}`),this.spawnedObjects.forEach((e,t)=>{const n=new h.Vector3;if(e.getWorldPosition(n),console.log(`  - ${t} (${e.userData.type}): \n        Local: (${e.position.x.toFixed(2)}, ${e.position.y.toFixed(2)}, ${e.position.z.toFixed(2)})\n        World: (${n.x.toFixed(2)}, ${n.y.toFixed(2)}, ${n.z.toFixed(2)})\n        Visible: ${e.visible}, Scale: ${e.scale.x.toFixed(2)}`),"generated_3d_model"===e.userData.type){const t=(new h.Box3).setFromObject(e),n=t.getSize(new h.Vector3),i=t.getCenter(new h.Vector3);console.log(`    📐 Bounding box - Center: (${i.x.toFixed(2)}, ${i.y.toFixed(2)}, ${i.z.toFixed(2)}), Size: (${n.x.toFixed(2)}, ${n.y.toFixed(2)}, ${n.z.toFixed(2)})`);let o=0;e.traverse(e=>{e.isMesh&&o++}),console.log(`    🎭 Meshes: ${o}`)}}),this.camera&&this.spawnedObjects.size>0&&(console.log("📏 Distances from camera:"),this.spawnedObjects.forEach((e,t)=>{const n=this.camera.position.distanceTo(e.position);console.log(`  - ${t}: ${n.toFixed(2)} units`)})),console.log("=========================")}selectObject(e){if(this.selectedObject!==e&&(this.deselectObject(),this.selectedObject=e,this.createModernSelectionIndicator(e),console.log(`✅ Selected object: ${e.name}`),this.commandUI)){const t=e.userData||{};if(this.commandUI.addOutput(`📍 選択: ${e.name}`,"info"),t.prompt&&this.commandUI.addOutput(`   プロンプト: ${t.prompt}`,"hint"),t.modelName&&this.commandUI.addOutput(`   モデル: ${t.modelName}`,"hint"),"delete"===this.commandUI.currentMode){const n=t.originalPrompt||e.name||"選択したオブジェクト";this.commandUI.input.value=`${n}を削除`,this.commandUI.input.focus(),this.commandUI.input.setSelectionRange(this.commandUI.input.value.length,this.commandUI.input.value.length),this.commandUI.addOutput(`🎯 削除対象設定: ${n}`,"system")}}}createModernSelectionIndicator(e){const t=e.getObjectByName("selectionIndicator");t&&e.remove(t);const n=new h.Group;n.name="selectionIndicator";const i=(new h.Box3).setFromObject(e),o=i.getSize(new h.Vector3),r=i.getCenter(new h.Vector3),a=new h.Vector3(o.x+.1,o.y+.1,o.z+.1);if(e.geometry&&"PlaneGeometry"===e.geometry.type){const t=e.geometry.parameters.width,i=e.geometry.parameters.height,o=new h.Shape;o.moveTo(-t/2,-i/2),o.lineTo(t/2,-i/2),o.lineTo(t/2,i/2),o.lineTo(-t/2,i/2),o.lineTo(-t/2,-i/2);const r=o.getPoints(),a=(new h.BufferGeometry).setFromPoints(r),s=this.getAdaptiveSelectionColor(),l=new h.LineBasicMaterial({color:s,linewidth:2,transparent:!0,opacity:.9}),c=new h.Line(a,l);c.position.set(0,0,.01),n.add(c)}else{const e=new h.EdgesGeometry(new h.BoxGeometry(a.x,a.y,a.z)),t=this.getAdaptiveSelectionColor(),i=new h.LineBasicMaterial({color:t,linewidth:2,transparent:!0,opacity:.9}),o=new h.LineSegments(e,i);o.position.copy(r),n.add(o)}e.add(n),n.position.set(0,0,0),this.addResizeHandles(n,a,r,e)}addResizeHandles(e,t,n,i){if(console.log("🔧 addResizeHandles called"),!i)return void console.log("❌ No parent object provided");if(!i.geometry)return void console.log("❌ Parent has no geometry");if("PlaneGeometry"!==i.geometry.type)return void console.log(`❌ Geometry type is ${i.geometry.type}, not PlaneGeometry`);console.log("✅ PlaneGeometry detected, creating handles");const o=.15,r=new h.BoxGeometry(o,o,o),a=this.getAdaptiveSelectionColor(),s=new h.MeshBasicMaterial({color:a,transparent:!0,opacity:.8,depthTest:!1,depthWrite:!1}),l=new h.MeshBasicMaterial({color:this.getAdaptiveHoverColor(),transparent:!0,opacity:1,depthTest:!1,depthWrite:!1}),c=i.geometry.parameters.width,d=i.geometry.parameters.height;[{x:c/2,y:d/2,z:.1,corner:"top-right"},{x:-c/2,y:d/2,z:.1,corner:"top-left"},{x:c/2,y:-d/2,z:.1,corner:"bottom-right"},{x:-c/2,y:-d/2,z:.1,corner:"bottom-left"}].forEach((t,n)=>{const i=new h.Mesh(r,s.clone());i.position.set(t.x,t.y,t.z),i.userData={isResizeHandle:!0,handleIndex:n,corner:t.corner,defaultMaterial:i.material,hoverMaterial:l.clone()},i.renderOrder=1001,i.onHover=()=>{i.material=i.userData.hoverMaterial,i.scale.setScalar(1.5),document.body.style.cursor="nw-resize"},i.onHoverExit=()=>{i.material=i.userData.defaultMaterial,i.scale.setScalar(1),document.body.style.cursor="default"},e.add(i),console.log(`🔴 Added resize handle at ${t.corner}`)})}updateSelectionIndicatorScale(e){}deselectObject(){if(this.selectedObject){const e=this.selectedObject.getObjectByName("selectionIndicator");e&&(this.selectedObject.remove(e),e.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())})),console.log(`✅ Deselected: ${this.selectedObject.name}`),this.selectedObject=null}}setupObjectDragging(){if(!this.renderer)return;const e=this.renderer.domElement;let t=!1,n=null,i=new h.Vector3,o=new h.Vector2,r="move",a=new h.Vector3;e.addEventListener("mousedown",s=>{if(0!==s.button)return;const l=e.getBoundingClientRect();this.mouse.x=(s.clientX-l.left)/l.width*2-1,this.mouse.y=-(s.clientY-l.top)/l.height*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const c=this.raycaster.intersectObjects(this.experimentGroup.children,!0);if(c.length>0){const l=c[0].object;if(l.userData&&l.userData.isResizeHandle)return t=!0,n=this.selectedObject,r="resize",this.resizeHandleInfo={corner:l.userData.corner,handleIndex:l.userData.handleIndex},a.copy(n.scale),o.set(s.clientX,s.clientY),e.style.cursor="nw-resize",void console.log(`🔄 Started resizing: ${n.name} from ${l.userData.corner}`);if(l.userData&&l.userData.isRotateHandle)return void console.log(`🔄 Rotation handle clicked for: ${this.selectedObject.name}`);if(!l.userData||"generated_image"!==l.userData.type&&"generated_video"!==l.userData.type&&"generated_3d_model"!==l.userData.type&&"imported_file"!==l.userData.source)this.selectObject(l);else{if(this.commandUI&&"delete"===this.commandUI.currentMode){const e=l.name;return console.log(`🗑️ Delete mode: clicked on ${e}`),void this.commandUI.showDeleteConfirmation(`オブジェクト「${e}」を削除`).then(t=>{t?(this.removeObject(e),this.commandUI.addOutput(`🗑️ 削除完了: ${e}`,"success")):this.commandUI.addOutput(`❌ 削除キャンセル: ${e}`,"info")}).catch(t=>{console.error("Delete confirmation error:",t),this.commandUI.addOutput(`❌ 削除エラー: ${e}`,"error")})}t=!0,n=l,r="move",i.copy(c[0].point).sub(l.position),o.set(s.clientX,s.clientY),l.material,e.style.cursor="move",console.log(`🔄 Started moving: ${l.name} (Shift-free interaction)`),this.selectObject(l)}}else this.deselectObject()}),e.addEventListener("mousemove",i=>{if(!t)return void this.handleHoverEffects(i,e);if(!n)return;const s=i.clientX-o.x,l=i.clientY-o.y;if("resize"===r){if(!this.resizeHandleInfo)return void console.error("❌ Resize handle info missing");let e=1;switch(this.resizeHandleInfo.corner){case"top-right":e=s>0&&l<0?1+.001*(Math.abs(s)+Math.abs(l)):1-.001*(Math.abs(s)+Math.abs(l));break;case"top-left":e=s<0&&l<0?1+.001*(Math.abs(s)+Math.abs(l)):1-.001*(Math.abs(s)+Math.abs(l));break;case"bottom-right":e=s>0&&l>0?1+.001*(Math.abs(s)+Math.abs(l)):1-.001*(Math.abs(s)+Math.abs(l));break;case"bottom-left":e=s<0&&l>0?1+.001*(Math.abs(s)+Math.abs(l)):1-.001*(Math.abs(s)+Math.abs(l));break;default:e=1+.001*(s+l)}const t=Math.max(.1,Math.min(5,a.x*e));n.scale.setScalar(t),this.updateSelectionIndicatorScale(n)}else if("move"===r){const e=.01;n.position.x+=s*e,n.position.y-=l*e,o.set(i.clientX,i.clientY)}}),e.addEventListener("mouseup",()=>{t&&n&&(n.material&&n.userData&&!n.userData.hasOpacityEffect&&(n.material.opacity=1,n.material.transparent=!1),console.log(`✅ Finished dragging: ${n.name} to (${n.position.x.toFixed(1)}, ${n.position.y.toFixed(1)}, ${n.position.z.toFixed(1)})`),t=!1,n=null,r="move",this.resizeHandleInfo=null,e.style.cursor="default")}),e.addEventListener("wheel",t=>{t.preventDefault();const n=e.getBoundingClientRect(),i=new h.Vector2;i.x=(t.clientX-n.left)/n.width*2-1,i.y=-(t.clientY-n.top)/n.height*2+1,this.raycaster.setFromCamera(i,this.camera);const o=this.raycaster.intersectObjects(this.experimentGroup.children,!0);if(o.length>0){const e=o[0].object;if(e.userData&&("generated_image"===e.userData.type||"generated_video"===e.userData.type||"generated_3d_model"===e.userData.type)){const n=t.deltaY>0?.9:1.1,i=e.scale.x*n;i>=.2&&i<=5&&(e.scale.setScalar(i),e.material&&(e.material.emissive.setHex(3355443),setTimeout(()=>{e.material&&e.material.emissive.setHex(0)},150)),console.log(`🔄 Resized ${e.userData.type}: ${e.name} to scale ${i.toFixed(2)} (Shift-free interaction)`))}}}),document.addEventListener("keydown",e=>{const t=document.activeElement;if(t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable))return;if(!this.selectedObject)return;const n=this.selectedObject;if(!n.userData||"generated_image"!==n.userData.type&&"generated_video"!==n.userData.type)return;const i=Math.PI/36;let o=!1;switch(e.key){case"ArrowLeft":n.rotation.y-=i,o=!0;break;case"ArrowRight":n.rotation.y+=i,o=!0;break;case"ArrowUp":const t=n.rotation.x-i;t>=-Math.PI/6&&t<=Math.PI/6&&(n.rotation.x=t,o=!0);break;case"ArrowDown":const r=n.rotation.x+i;r>=-Math.PI/6&&r<=Math.PI/6&&(n.rotation.x=r,o=!0);break;case"r":case"R":n.rotation.x=0;const a=new h.Vector3;this.camera.getWorldDirection(a);const s=n.position.clone().add(a.multiplyScalar(-1));n.lookAt(s),n.rotation.x=0,o=!0,console.log(`🔄 Reset rotation for: ${n.name}`);break;case"i":case"I":this.debugSceneInfo(),e.preventDefault()}if(o){e.preventDefault();const t={x:(180*n.rotation.x/Math.PI).toFixed(1),y:(180*n.rotation.y/Math.PI).toFixed(1),z:(180*n.rotation.z/Math.PI).toFixed(1)};console.log(`🔄 Rotated ${n.userData.type}: ${n.name} to (${t.x}°, ${t.y}°, ${t.z}°)`)}}),console.log("🖱️ Object dragging system enabled (Drag to move objects - Shift-free interaction)"),console.log("🔄 Object resizing system enabled (Scroll to resize images/videos - Shift-free interaction)"),console.log("🎯 Angle adjustment enabled (Select object + Arrow keys to rotate, R to reset)")}handleHoverEffects(e,t){const n=t.getBoundingClientRect();this.mouse.x=(e.clientX-n.left)/n.width*2-1,this.mouse.y=-(e.clientY-n.top)/n.height*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const i=this.raycaster.intersectObjects(this.experimentGroup.children,!0);if(this.lastHoveredObject&&this.lastHoveredObject.onHoverExit&&(this.lastHoveredObject.onHoverExit(),this.lastHoveredObject=null),i.length>0){const e=i[0].object;if(e.userData&&e.userData.isResizeHandle&&e.onHover)return e.onHover(),void(this.lastHoveredObject=e);if(e.userData&&("generated_image"===e.userData.type||"generated_video"===e.userData.type))return t.style.cursor="move",void(this.lastHoveredObject={onHoverExit:()=>{t.style.cursor="default"}})}t.style.cursor="default"}async executeCommand(e){const t=Date.now();console.log(`🎯 Executing: "${e}"`);try{const n=this.parseCommand(e);console.log("📝 Parsed:",n);const i=await this.dispatchCommand(n);return this.commandHistory.push({timestamp:t,command:e,parsed:n,result:i,status:"success"}),i}catch(n){throw console.error("❌ Command execution failed:",n),this.commandHistory.push({timestamp:t,command:e,error:n.message,status:"error"}),n}}parseCommand(e){if((e=e.replace(/\s*⏎\s*/g,"").trim()).startsWith("[変更] ")){const t=e.replace("[変更] ","");return this.parseObjectModificationCommand(t.toLowerCase().trim())}if(e.startsWith("[削除] ")){const t=e.replace("[削除] ","");return this.parseDeleteCommand(t.toLowerCase().trim())}const t=e.toLowerCase().trim(),n=this.parseNaturalLanguageCommand(t);if(n)return n;const i=t.includes("アニメーション")&&(t.includes("作って")||t.includes("生成")||t.includes("を")||t.includes("create")||t.includes("make")||t.includes("generate"));if(["動画","ビデオ","ムービー","映像","動く","video","movie","motion","moving","clip"].some(e=>t.includes(e))||t.includes("animate")&&!t.includes("を")||i)return{type:"video_generation",prompt:e,position:this.parsePosition(t),size:this.parseSize(t)};if(["選択","select","オブジェクト選択","既存","existing"].some(e=>t.includes(e)))return{type:"object_selection",position:this.parsePosition(t)};if(["インポート","import","読み込","読込","ファイル","file","画像を選択","動画を選択","選択して配置"].some(e=>t.includes(e))){return{type:"file_import",fileType:t.includes("動画")||t.includes("video")||t.includes("mp4")?"video":"image",position:this.parsePosition(t),size:this.parseSize(t)}}return["画像","写真","イメージ","絵","ピクチャー","image","picture","photo","generate","create","make","draw"].some(e=>t.includes(e)),{type:"image_generation",prompt:e,position:this.parsePosition(t),size:this.parseSize(t)}}getObjectKeywords(){return l()}normalizeTargetPhrase(e){if(!e)return"";let t=`${e}`.trim();t=t.replace(/[。、，,.!?！？]/g," ").trim();const n=/^(さっき|先ほど|直前|最近|この前|その|あの|この|前回|前の|最新|最後|last|latest)\s*(の)?/i;for(;n.test(t);)t=t.replace(n,"").trim();t=t.replace(/(してください|して下さい|してね|してよ|してくれ|してくれませんか|してくださいね|してくださいよ|お願いします?|お願い|頼む)$/i,"").trim();const i=[/(を)?(左右反転|反転|削除|消して|消す|変更|変えて|塗り替えて|塗って|回転|回して|移動|動かして|拡大|縮小|大きく|小さく|並べ|寄せて|整列|選択|選んで|指定|生成|作って|描いて|アップロード|アップして|読み込んで|読み込んだ|開いて|閉じて|置いて|配置して|貼り付けて|flip|delete|remove|change|make|turn|rotate|move|scale|resize|generate|create).*$/i,/(を|に|へ|で|から|まで|と|や|って)$/i];for(const e of i)t=t.replace(e,"").trim();if(t=t.replace(/(を|に|へ|で|から|まで|と|や|って)$/i,"").trim(),!t){const n=/^(flip|delete|remove|change|make|turn|rotate|move|scale|resize|generate|create)\s+/i;n.test(e.trim())&&(t=e.trim().replace(n,"").trim())}return t=t.replace(/(を|に|へ|で|から|まで|と|や|って)$/i,"").trim(),t}isReferentialCommand(e){return!!e&&/(さっき|先ほど|直前|最近|前回|前の|最後|最新|last|previous|before)/i.test(e)}getObjectSourceType(e){return e&&e.userData&&(e.userData.source||e.userData.type)||null}getRecentObjects(e){const t=Array.from(this.spawnedObjects.values());if(0===t.length)return[];const n=/(インポート|取り込|アップロード|読み込)/.test(e),i=/(生成|作っ|描い|create|generate)/.test(e);let o=t;return n?o=o.filter(e=>"imported_file"===this.getObjectSourceType(e)):i&&(o=o.filter(e=>{const t=this.getObjectSourceType(e);return"generated_image"===t||"generated_video"===t})),0===o.length&&(o=t),o.sort((e,t)=>{const n=e.userData?.lastModified||e.userData?.createdAt||0;return(t.userData?.lastModified||t.userData?.createdAt||0)-n})}findRecentObjectByContext(e,t,n){const i=this.getRecentObjects(e);if(0===i.length)return null;if(t)for(const e of i)if(this.matchesObjectName(e,t,n))return e;return i[0]}extractTextTokens(e){return e?e.replace(/[。、，,.!?！？]/g," ").split(/[\s_/\-]+/).map(e=>e.trim()).filter(e=>e.length>1):[]}buildObjectKeywordHints({prompt:e="",fileName:t="",baseType:n=null}={}){const i=new Set;if(e){i.add(e.toLowerCase());for(const t of this.extractTextTokens(e))i.add(t.toLowerCase())}if(t){const e=t.replace(/\.[^/.]+$/,"");i.add(e.toLowerCase());for(const t of this.extractTextTokens(e))i.add(t.toLowerCase())}return"image"===n?["image","photo","picture","画像","写真","イメージ"].forEach(e=>i.add(e)):"video"===n&&["video","movie","clip","動画","ビデオ","ムービー","映像"].forEach(e=>i.add(e)),Array.from(i).filter(Boolean)}findObjectByKeyword(e){const t=this.getObjectKeywords(),n=this.normalizeTargetPhrase(e),i=e.match(/((\d+)番目|最初|初回|1番目)に(インポート|取り込)した(.+)/);if(i){let e=1;i[2]?e=parseInt(i[2]):("最初"===i[1]||"初回"===i[1]||"1番目"===i[1])&&(e=1);const n=this.normalizeTargetPhrase(i[4])||i[4].trim();return this.findImportedObjectByOrder(n,e,t)}const o=e.match(/(インポート|取り込|アップロード|読み込|生成|作った)した?(.+)/);if(o){const e=o[1],n=this.normalizeTargetPhrase(o[2])||o[2].trim(),i="インポート"===e||"取り込"===e;return this.findObjectBySourceAndName(n,i,t)}if(this.isReferentialCommand(e)){const i=this.findRecentObjectByContext(e,n,t);if(i)return i}return this.findObjectByName(n||e,t)}findImportedObjectByOrder(e,t,n){const i=[];for(const e of this.spawnedObjects.values())e.userData&&"imported_file"===this.getObjectSourceType(e)&&i.push(e);i.sort((e,t)=>(e.userData.importOrder||0)-(t.userData.importOrder||0));const o=e?i.filter(t=>this.matchesObjectName(t,e,n)):i;if(o.length>=t){const n=o[t-1];return console.log(`🎯 Found ${t}番目 imported object "${e}": ${n.name}`),n}return console.warn(`⚠️ ${t}番目にインポートした"${e}"が見つかりません`),null}findObjectBySourceAndName(e,t,n){for(const i of this.spawnedObjects.values()){if(!i.userData)continue;const o=this.getObjectSourceType(i);if((!t||"imported_file"===o)&&((t||("generated_image"===o||"generated_video"===o))&&this.matchesObjectName(i,e,n))){const n=t?"インポートした":"生成した";return console.log(`🎯 Found ${n} object "${e}": ${i.name}`),i}}const i=t?"インポートした":"生成した";return console.warn(`⚠️ ${i}"${e}"が見つかりません`),null}findObjectByName(e,t){const n=e&&e.trim();if(!n)return null;for(const e of this.spawnedObjects.values())if(e&&this.matchesObjectName(e,n,t))return e;return null}matchesObjectName(e,t,n){if(!e||!t)return!1;const i=t.toLowerCase();if(e.userData&&Array.isArray(e.userData.keywords))for(const t of e.userData.keywords){if(!t)continue;const e=t.toLowerCase();if(i.includes(e)||e.includes(i))return!0}for(const[e,t]of Object.entries(n)){const n=e.toLowerCase();if(i.includes(n))return!0;for(const e of t){const t=e.toLowerCase();if(i.includes(t))return!0}}if(e.userData&&e.userData.prompt){const t=e.userData.prompt.toLowerCase();if(t.includes(i)||i.includes(t))return!0}return!!(e.userData&&e.userData.fileName&&d(t,e.userData.fileName,n))}parseImageGenerationCommand(e){let t=e;const n=["を","に","で","の"];for(const i of n)if(e.includes(i)){const n=e.split(i);if(n[0]){t=n[0].trim();break}}return t=t.replace(/(画像|作って|生成|して|ください)/g,"").trim(),{type:"image_generation",prompt:t,position:this.parsePosition(e),size:this.parseSize(e)}}parseObjectModificationCommand(e){const t=e.toLowerCase().trim();let n=null;const i={"赤":16711680,"赤色":16711680,"青":255,"青色":255,"緑":65280,"緑色":65280,"黄":16776960,"黄色":16776960,"黄色い":16776960,"紫":16711935,"紫色":16711935,"橙":16746496,"橙色":16746496,"オレンジ":16746496,"オレンジ色":16746496,"白":16777215,"白色":16777215,"黒":0,"黒色":0,"灰":8421504,"灰色":8421504,"グレー":8421504,"グレー色":8421504,"ピンク":16761035,"ピンク色":16761035,"茶":9127187,"茶色":9127187,"銀":12632256,"銀色":12632256,"金":16766720,"金色":16766720};for(const[e,o]of Object.entries(i))if(t.includes(e)){n=o;break}const o=this.parseEffects(t);console.log("🔍 parseObjectModificationCommand - Effects found:",o);let r=null;if(t.includes("大きく")||t.includes("拡大"))r=1.5;else if(t.includes("小さく")||t.includes("縮小"))r=.7;else if(t.includes("倍")){const e=t.match(/(\d+(?:\.\d+)?)\s*倍/);e&&(r=parseFloat(e[1]))}let a=null;(t.includes("移動")||t.includes("動か")||t.includes("へ"))&&(a=this.parsePositionFromPrompt(t));let s=null;if(t.includes("回転")||t.includes("回す")||t.includes("回して")||t.includes("rotate")){const e=t.match(/(\d+)\s*度/);s=e?parseFloat(e[1])*Math.PI/180:Math.PI/4}let l=null;t.includes("透明")||t.includes("transparent")?l=t.includes("半透明")?.5:.3:(t.includes("不透明")||t.includes("opaque"))&&(l=1);let c=null;return(t.includes("左右反転")||t.includes("反転")||t.includes("ひっくり返")||t.includes("flip"))&&(c=!0),{type:"object_modification",command:e,color:n,scale:r,movement:a,rotation:s,opacity:l,flip:c,effects:o,requiresSelection:!0}}parseEffects(e){const t=[],n={"透明":{type:"opacity",value:0,name:"transparent"},"半透明":{type:"opacity",value:.5,name:"semi_transparent"},"不透明":{type:"opacity",value:1,name:"opaque"},"濃く":{type:"opacity",value:1,name:"solid"},"光らせ":{type:"glow",color:16777215,intensity:.5,name:"glow_white"},"光る":{type:"glow",color:16777215,intensity:.5,name:"glow_white"},"ネオン":{type:"glow",color:65535,intensity:.8,name:"neon_cyan"},"ホログラム":{type:"glow",color:65535,intensity:.6,name:"hologram"},"メタリック":{type:"material",metalness:.8,roughness:.2,name:"metallic"},"金属質":{type:"material",metalness:.9,roughness:.1,name:"metallic_shiny"},"ガラス":{type:"material",metalness:0,roughness:0,name:"glass"},"マット":{type:"material",metalness:0,roughness:1,name:"matte"},"ふわふわ":{type:"animation",animation:"float",speed:.002,amplitude:.5,name:"float_gentle"},"浮く":{type:"animation",animation:"float",speed:.003,amplitude:.8,name:"float_strong"},"漂う":{type:"animation",animation:"float",speed:.001,amplitude:.3,name:"float_slow"},"ドクドク":{type:"animation",animation:"pulse",speed:.003,amplitude:.15,name:"pulse_heartbeat"},"鼓動":{type:"animation",animation:"pulse",speed:.0025,amplitude:.1,name:"pulse_heart"},"脈動":{type:"animation",animation:"pulse",speed:.004,amplitude:.2,name:"pulse_throb"},"くるくる":{type:"animation",animation:"spin",speed:.02,axis:"y",name:"spin_y"},"スピン":{type:"animation",animation:"spin",speed:.03,axis:"y",name:"spin_fast"},"回る":{type:"animation",animation:"spin",speed:.015,axis:"y",name:"spin_slow"},"きらめ":{type:"animation",animation:"sparkle",intensity:.8,name:"sparkle"},"輝":{type:"animation",animation:"sparkle",intensity:1,name:"shine"},"キラキラ":{type:"animation",animation:"sparkle",intensity:.9,name:"twinkle"},"宇宙":{type:"cosmic",colors:[4474111,16729224,4521898],intensity:.9,name:"cosmic"},"オーロラ":{type:"aurora",colors:[65450,4491519,16746666],intensity:.8,name:"aurora"},"星雲":{type:"nebula",colors:[8930559,16746564,4500223],intensity:1,name:"nebula"},"エネルギー":{type:"energy",colors:[16755200,43775,11141375],intensity:.7,name:"energy"},"神秘的":{type:"mystic",colors:[11158783,16729258,4521983],intensity:.6,name:"mystic"},"水彩":{type:"watercolor_art",colors:[16739229,5164484,16770669,9822675],opacity:.6,name:"watercolor"},"水彩画":{type:"watercolor_art",colors:[16739229,5164484,16770669,9822675],opacity:.6,name:"watercolor"},"パステル":{type:"pastel_art",colors:[16757690,16768954,16777146,12255177,12247551],opacity:.7,name:"pastel"},"虹色":{type:"rainbow_glow",colors:[16711680,16746496,16776960,65280,35071,255,8913151],intensity:.5,name:"rainbow_glow"},"モノクロ":{type:"monochrome",name:"monochrome"},"グレースケール":{type:"monochrome",name:"grayscale"},"モノクロに":{type:"monochrome",name:"monochrome"},"白黒":{type:"monochrome",name:"black_white"}},i={"魔法っぽく":[{type:"glow",color:13387007,intensity:.7,name:"magic_glow"},{type:"animation",animation:"pulse",speed:.003,amplitude:.1,name:"magic_pulse"},{type:"animation",animation:"sparkle",intensity:.6,name:"magic_sparkle"}],"幽霊":[{type:"opacity",value:.6,name:"ghost_transparent"},{type:"animation",animation:"float",speed:.002,amplitude:.4,name:"ghost_float"},{type:"glow",color:16777215,intensity:.3,name:"ghost_aura"}],"サイバー":[{type:"glow",color:65450,intensity:.8,name:"cyber_glow"},{type:"material",metalness:.8,roughness:.1,name:"cyber_metal"},{type:"animation",animation:"glitch",intensity:.1,name:"cyber_glitch"}],"夢みたい":[{type:"opacity",value:.7,name:"dream_soft"},{type:"animation",animation:"float",speed:.0015,amplitude:.3,name:"dream_float"},{type:"animation",animation:"rainbow",speed:.001,name:"dream_rainbow"}]};for(const[n,o]of Object.entries(i))e.includes(n)&&(t.push(...o),console.log(`✨ Preset effect applied: ${n}`));const o=this.requiresChromaKey(e),r=o?this.detectChromaKeyConfig(e):null,a=null!==r;console.log(`🔍 Checking effects for cmd: "${e}"`);for(const[i,o]of Object.entries(n))a&&"透明"===i||(console.log(`🔍 Checking keyword: "${i}" in cmd: "${e}"`),e.includes(i)&&(t.push(o),console.log(`🎭 Effect detected: ${i} -> ${o.name}`),"キラキラ"===i&&console.log(`✨ SPARKLE EFFECT FOUND! cmd="${e}"`)));return o&&(a?(t.push({type:"chroma_key",color:r.color,threshold:r.threshold,smoothing:r.smoothing,name:"chroma_key"}),console.log(`🪄 Chroma key requested (color: #${r.color.toString(16)}, threshold: ${r.threshold})`)):this.commandUI&&this.commandUI.showInputFeedback("背景を透過するには背景色を指定してください（例：「背景の白を透過して」）","info")),t}requiresChromaKey(e){if(!e)return!1;if(["クロマキー","グリーンバック","remove background","transparent background"].some(t=>e.includes(t)))return!0;return!(!["背景を","背景の","背景"].some(t=>e.includes(t))||!["透過","透明","消","抜","なくして"].some(t=>e.includes(t)))}detectChromaKeyConfig(e){const t=this.detectChromaKeyColor(e);if(null===t)return null;let n;switch(t){case 16777215:n=.12;break;case 0:n=.14;break;case 65280:n=.32;break;case 255:n=.3;break;default:n=.2}return{color:t,threshold:n,smoothing:.1}}detectChromaKeyColor(e){const t=e.match(/#([0-9a-fA-F]{6})/);if(t)return parseInt(t[1],16);const n=[{tokens:["白","ホワイト","しろ"],value:16777215},{tokens:["黒","ブラック","くろ"],value:0},{tokens:["緑","グリーン","みどり"],value:65280},{tokens:["青","ブルー","あお"],value:255},{tokens:["赤","レッド","あか"],value:16711680},{tokens:["黄","イエロー","きいろ"],value:16776960},{tokens:["ピンク"],value:16761035},{tokens:["オレンジ"],value:16746496}];for(const t of n)if(t.tokens.some(t=>e.includes(t)))return t.value;return e.includes("グリーンバック")?65280:null}applyEffects(e,t){let n=!1;for(const i of t)switch(console.log(`✨ Applying effect: ${i.name} (${i.type})`),i.type){case"opacity":n=this.applyOpacityEffect(e,i)||n;break;case"glow":n=this.applyGlowEffect(e,i)||n;break;case"material":n=this.applyMaterialEffect(e,i)||n;break;case"animation":n=this.applyAnimationEffect(e,i)||n;break;case"cosmic":case"aurora":case"nebula":case"energy":case"mystic":case"rainbow_glow":n=this.applyCosmicEffect(e,i)||n;break;case"watercolor_art":case"pastel_art":n=this.applyWatercolorEffect(e,i)||n;break;case"chroma_key":n=this.applyChromaKeyEffect(e,i)||n;break;case"monochrome":n=this.applyMonochromeEffect(e,i)||n;break;default:console.warn(`🚫 Unknown effect type: ${i.type}`)}return n}applyOpacityEffect(e,t){return!!e.material&&(e.material.transparent=!0,e.material.opacity=t.value,e.material.needsUpdate=!0,e.userData||(e.userData={}),e.userData.hasOpacityEffect=!0,e.userData.originalOpacity=t.value,console.log(`👻 Opacity set to: ${t.value} (${t.name})`),!0)}applyGlowEffect(e,t){if(!e.material)return!1;if(this.ensureEmissiveSupport(e))return e.material.emissive=new h.Color(t.color),e.material.emissiveIntensity=t.intensity,e.material.needsUpdate=!0,console.log(`💡 Glow applied: color=0x${t.color.toString(16)}, intensity=${t.intensity}`),!0;const n=new h.Color(t.color);return e.userData.originalColor||(e.userData.originalColor=e.material.color?e.material.color.clone():null),e.material.color?(e.material.color.lerp(n,.4),e.material.needsUpdate=!0,console.log("💡 Glow fallback applied via color tint"),!0):(console.warn("🚫 Glow effect could not be applied"),!1)}ensureEmissiveSupport(e){const t=e.material;return!!t&&("emissive"in t&&void 0!==t.emissive)}applyMaterialEffect(e,t){return!!e.material&&("MeshStandardMaterial"===e.material.type?(void 0!==t.metalness&&(e.material.metalness=t.metalness),void 0!==t.roughness&&(e.material.roughness=t.roughness),e.material.needsUpdate=!0,console.log(`🔩 Material updated: metalness=${t.metalness}, roughness=${t.roughness}`),!0):(console.warn(`🚫 Material effect requires StandardMaterial, got: ${e.material.type}`),!1))}applyAnimationEffect(e,t){this.animations||(this.animations=new Map,this.startAnimationLoop());const n=`${e.uuid}_${t.animation}`;this.animations.has(n)&&this.animations.delete(n);const i={object:e,type:t.animation,speed:t.speed,amplitude:t.amplitude||1,axis:t.axis||"y",intensity:t.intensity||1,startTime:Date.now(),originalPosition:{...e.position},originalScale:{...e.scale},originalRotation:{...e.rotation}};return this.animations.set(n,i),console.log(`🎬 Animation started: ${t.animation} for ${e.name}`),!0}applyCosmicEffect(e,t){if(!e.material)return!1;const n=!this.ensureEmissiveSupport(e);this.animations||(this.animations=new Map,this.startAnimationLoop());const i=`${e.uuid}_${t.type}`;this.animations.has(i)&&this.animations.delete(i),n?e.material.color?(e.userData.originalColor||(e.userData.originalColor=e.material.color.clone()),e.material.color.set(t.colors[0]),e.material.needsUpdate=!0):console.warn("🚫 Cosmic fallback could not adjust color"):(e.material.emissive=new h.Color(t.colors[0]),e.material.emissiveIntensity=t.intensity,e.material.needsUpdate=!0);const o={object:e,type:"cosmic",cosmicType:t.type,colors:t.colors,intensity:t.intensity,speed:this.getCosmicSpeed(t.type),startTime:Date.now(),colorIndex:0,originalEmissive:!n&&e.material.emissive?e.material.emissive.clone():null,originalEmissiveIntensity:n?0:e.material.emissiveIntensity||0,useColorFallback:n};return this.animations.set(i,o),console.log(`🌌 Cosmic effect started: ${t.type} with ${t.colors.length} colors`),!0}applyChromaKeyEffect(e,t){if(!e.material)return!1;const n=e.material,i=n.map;if(!i)return console.warn("🚫 Chroma key requires texture map"),!1;if(n.userData&&n.userData.isChromaKeyMaterial&&n.uniforms)return n.uniforms.keyColor.value.setHex(t.color),n.uniforms.threshold.value=t.threshold,n.uniforms.smoothing.value=t.smoothing,n.needsUpdate=!0,console.log("🎯 Updated existing chroma key material"),!0;const o=new h.ShaderMaterial({uniforms:{map:{value:i},keyColor:{value:new h.Color(t.color)},threshold:{value:t.threshold},smoothing:{value:t.smoothing}},vertexShader:"varying vec2 vUv;\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragmentShader:"uniform sampler2D map;\nuniform vec3 keyColor;\nuniform float threshold;\nuniform float smoothing;\nvarying vec2 vUv;\nvoid main() {\n  vec4 color = texture2D(map, vUv);\n  float dist = distance(color.rgb, keyColor);\n  float alpha = smoothstep(threshold, threshold + smoothing, dist) * color.a;\n  if (alpha <= 0.0) discard;\n  gl_FragColor = vec4(color.rgb, alpha);\n}",transparent:!0,side:h.DoubleSide,depthTest:n.depthTest,depthWrite:n.depthWrite,toneMapped:!0===n.toneMapped});return o.userData.isChromaKeyMaterial=!0,e.material=o,"function"==typeof n.dispose&&n.dispose(),console.log("🪄 Applied chroma key shader material"),!0}applyMonochromeEffect(e,t){if(!e.material)return!1;const n=e.material,i=n.map;if(!i)return console.warn("🚫 Monochrome effect requires texture map"),!1;if(n.userData&&n.userData.isMonochromeMaterial&&n.uniforms)return console.log("🎯 Monochrome material already applied"),!0;const o=new h.ShaderMaterial({uniforms:{map:{value:i}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        uniform sampler2D map;\n        varying vec2 vUv;\n        void main() {\n          vec4 color = texture2D(map, vUv);\n          // ルミナンス（輝度）計算でグレースケール化\n          float gray = dot(color.rgb, vec3(0.299, 0.587, 0.114));\n          gl_FragColor = vec4(vec3(gray), color.a);\n        }\n      ",transparent:n.transparent,side:h.DoubleSide,depthTest:n.depthTest,depthWrite:n.depthWrite,toneMapped:!0===n.toneMapped});return o.userData.isMonochromeMaterial=!0,e.material=o,"function"==typeof n.dispose&&n.dispose(),console.log("⚫ Applied monochrome effect"),!0}getCosmicSpeed(e){switch(e){case"cosmic":return 5e-4;case"aurora":default:return 8e-4;case"nebula":return 3e-4;case"energy":return.0015;case"mystic":return 6e-4;case"rainbow_glow":return.001}}applyWatercolorEffect(e,t){if(!e.material)return!1;e.material.transparent=!0,e.material.opacity=t.opacity,this.animations||(this.animations=new Map,this.startAnimationLoop());const n=`${e.uuid}_${t.type}`;this.animations.has(n)&&this.animations.delete(n),e.material.color=new h.Color(t.colors[0]),e.material.needsUpdate=!0;const i={object:e,type:"watercolor",artType:t.type,colors:t.colors,opacity:t.opacity,speed:this.getWatercolorSpeed(t.type),startTime:Date.now(),colorIndex:0,originalColor:new h.Color(e.material.color),originalOpacity:e.material.opacity};return this.animations.set(n,i),console.log(`🎨 Watercolor effect started: ${t.type} with ${t.colors.length} colors`),!0}getWatercolorSpeed(e){switch(e){case"watercolor_art":default:return 3e-4;case"pastel_art":return 2e-4}}startAnimationLoop(){if(this.animationLoopRunning)return;this.animationLoopRunning=!0;const e=()=>{this.animations&&this.animations.size>0&&this.updateAnimations(),this.animationLoopRunning&&requestAnimationFrame(e)};e(),console.log("🎭 Animation loop started")}updateAnimations(){const e=Date.now();for(const[t,n]of this.animations.entries()){const t=.001*(e-n.startTime);switch(n.type){case"float":this.updateFloatAnimation(n,t);break;case"pulse":this.updatePulseAnimation(n,t);break;case"spin":this.updateSpinAnimation(n,t);break;case"sparkle":this.updateSparkleAnimation(n,t);break;case"rainbow":this.updateRainbowAnimation(n,t);break;case"glitch":this.updateGlitchAnimation(n,t);break;case"cosmic":this.updateCosmicAnimation(n,t);break;case"watercolor":this.updateWatercolorAnimation(n,t)}}}updateFloatAnimation(e,t){const n=Math.sin(t*e.speed*2*Math.PI)*e.amplitude;e.object.position.y=e.originalPosition.y+n}updatePulseAnimation(e,t){const n=1+Math.sin(t*e.speed*2*Math.PI)*e.amplitude;e.object.scale.setScalar(e.originalScale.x*n)}updateSpinAnimation(e,t){const n=t*e.speed*2*Math.PI;"x"===e.axis?e.object.rotation.x=e.originalRotation.x+n:"y"===e.axis?e.object.rotation.y=e.originalRotation.y+n:"z"===e.axis&&(e.object.rotation.z=e.originalRotation.z+n)}updateSparkleAnimation(e,t){if(e.object.material){const n=(.5*Math.sin(3*t*2*Math.PI)+.5)*e.intensity;e.object.material.emissiveIntensity=n,e.object.material.needsUpdate=!0}}updateRainbowAnimation(e,t){if(e.object.material){const n=t*e.speed%1,i=(new h.Color).setHSL(n,1,.5);e.object.material.color=i,e.object.material.needsUpdate=!0}}updateGlitchAnimation(e,t){if(Math.random()<.1){const t=(Math.random()-.5)*e.intensity;e.object.position.x=e.originalPosition.x+t,e.object.position.z=e.originalPosition.z+t}else e.object.position.x=e.originalPosition.x,e.object.position.z=e.originalPosition.z}updateCosmicAnimation(e,t){if(!e.object.material)return;const n=t*e.speed,i=e.colors.length,o=n%i,r=Math.floor(o),a=(r+1)%i,s=o-r,l=new h.Color(e.colors[r]),c=new h.Color(e.colors[a]),d=l.lerp(c,s);let p=1;switch(e.cosmicType){case"aurora":p=.7+.3*Math.sin(2.5*t);break;case"nebula":p=.8+.2*Math.sin(1.2*t);break;case"energy":p=.6+Math.sin(4*t)*Math.cos(3*t)*.4;break;case"cosmic":p=.8+.2*Math.sin(1.8*t);break;case"mystic":p=.7+.3*Math.sin(1.5*t)*Math.cos(.8*t);break;case"rainbow_glow":p=.6+.3*Math.sin(2*t)}e.useColorFallback?e.object.material.color&&(e.object.material.color.copy(d),e.object.material.needsUpdate=!0):(e.object.material.emissive=d,e.object.material.emissiveIntensity=e.intensity*p,e.object.material.needsUpdate=!0)}updateWatercolorAnimation(e,t){if(!e.object.material)return;const n=t*e.speed,i=e.colors.length,o=n%i,r=Math.floor(o),a=(r+1)%i,s=o-r,l=new h.Color(e.colors[r]),c=new h.Color(e.colors[a]),d=l.lerp(c,s);let p=1;switch(e.artType){case"watercolor_art":p=.9+.1*Math.sin(.5*t);break;case"pastel_art":p=.95+.05*Math.sin(.3*t)}e.object.material.color=d,e.object.material.opacity=e.opacity*p,e.object.material.needsUpdate=!0}getAutoEffectsFromPrompt(e){if(!e)return null;const t=e.toLowerCase();return t.includes("ユニコーン")||t.includes("unicorn")||t.includes("魔法")||t.includes("magic")||t.includes("魔女")||t.includes("wizard")||t.includes("fairy")||t.includes("妖精")?["魔法っぽく"]:t.includes("ドラゴン")||t.includes("dragon")||t.includes("宇宙")||t.includes("space")||t.includes("星")||t.includes("star")?["宇宙"]:t.includes("幽霊")||t.includes("ghost")||t.includes("精霊")||t.includes("spirit")?["幽霊"]:t.includes("ロボット")||t.includes("robot")||t.includes("サイバー")||t.includes("cyber")||t.includes("未来")||t.includes("future")?["サイバー"]:t.includes("猫")||t.includes("cat")||t.includes("犬")||t.includes("dog")||t.includes("鳥")||t.includes("bird")?["きらめ"]:t.includes("花")||t.includes("flower")||t.includes("桜")||t.includes("cherry")||t.includes("自然")||t.includes("nature")?["パステル"]:null}applyRecognitionFeedback(e){console.log(`🎯 Object recognition successful: ${e.name}`);this.applyEffects(e,[{type:"animation",animation:"sparkle",intensity:.8,name:"recognition_feedback"}]),setTimeout(()=>{this.stopRecognitionFeedback(e)},3e3)}stopRecognitionFeedback(e){if(!this.animations)return;const t=`${e.uuid}_sparkle`;this.animations.has(t)&&(this.animations.delete(t),e.material&&(e.material.emissiveIntensity=0,e.material.needsUpdate=!0),console.log(`✨ Recognition feedback stopped for: ${e.name}`))}parseDeleteCommand(e){const t=e.toLowerCase().trim();return t.includes("選択")||t.includes("これ")||t.includes("この")?{type:"delete",target:"selected",requiresSelection:!0,command:e}:t.includes("全部")||t.includes("すべて")||t.includes("全て")?{type:"delete",target:"all",command:e}:{type:"delete",target:"selected",requiresSelection:!0,command:e}}parseNaturalLanguageCommand(e){const t=["(S+?)を(.+?)に移動","(S+?)を(.+?)へ移動","(S+?)を(.+?)に動か","(S+?)を(.+?)へ動か"];for(const n of t){const t=new RegExp(n),i=e.match(t);if(i){const e=i[1],t=i[2];return console.log(`🎯 Natural language move detected: "${e}" to "${t}"`),{type:"natural_object_modification",targetObjectName:e,movement:this.parsePositionFromPrompt(t),requiresObjectSearch:!0}}}const n=["(S+?)を(S+?)色に","(S+?)を(S+?)に"],i=["赤","赤色","青","青色","緑","緑色","黄","黄色","黄色い","紫","紫色","橙","橙色","オレンジ","オレンジ色","白","白色","黒","黒色","灰","灰色","グレー","グレー色","ピンク","ピンク色","茶","茶色","銀","銀色","金","金色"];for(const t of n){const n=new RegExp(t),o=e.match(n);if(o&&i.some(e=>o[2].includes(e))){const e=o[1],t=o[2];console.log(`🎨 Natural language color change detected: "${e}" to "${t}"`);const n={"赤":16711680,"赤色":16711680,"青":255,"青色":255,"緑":65280,"緑色":65280,"黄":16776960,"黄色":16776960,"黄色い":16776960,"紫":16711935,"紫色":16711935,"橙":16746496,"橙色":16746496,"オレンジ":16746496,"オレンジ色":16746496,"白":16777215,"白色":16777215,"黒":0,"黒色":0,"灰":8421504,"灰色":8421504,"グレー":8421504,"グレー色":8421504,"ピンク":16761035,"ピンク色":16761035,"茶":9127187,"茶色":9127187,"銀":12632256,"銀色":12632256,"金":16766720,"金色":16766720};let i=null;for(const[e,o]of Object.entries(n))if(t.includes(e)){i=o;break}return{type:"natural_object_modification",targetObjectName:e,color:i,requiresObjectSearch:!0}}}const o=["(S+?)を回転","(S+?)を回す","(S+?)を回して","(S+?)回転","回転.*?(S+)"];for(const t of o){const n=new RegExp(t),i=e.match(n);if(i){const t=i[1];console.log(`🔄 Natural language rotation detected: "${t}"`);const n=e.match(/(\d+)\s*度/);return{type:"natural_object_modification",targetObjectName:t,rotation:n?parseFloat(n[1])*Math.PI/180:Math.PI/4,requiresObjectSearch:!0}}}const r=["(S+?)を左右反転","(S+?)を反転","(S+?)反転","(S+?)をひっくり返","(S+?)をflip"];for(const t of r){const n=new RegExp(t),i=e.match(n);if(i){const e=i[1];return console.log(`🔄 Natural language flip detected: "${e}"`),{type:"natural_object_modification",targetObjectName:e,flip:!0,requiresObjectSearch:!0}}}const a=["(S+?)を(S+?)っぽく","(S+?)を(S+?)に","(S+?)を(S+?)風に","(S+?)を(S+?)みたい"],s=["水彩","水彩画","宇宙","オーロラ","星雲","エネルギー","神秘的","パステル","魔法","幽霊","サイバー","夢","光","ネオン","メタリック","金属","ガラス","マット"];for(const t of a){const n=new RegExp(t),i=e.match(n);if(i&&s.some(e=>i[2].includes(e))){const e=i[1],t=i[2];return console.log(`✨ Natural language effect detected: "${e}" with "${t}"`),{type:"natural_object_modification",targetObjectName:e,command:t,requiresObjectSearch:!0}}}return null}parsePositionFromPrompt(e){let t=0,n=0,i=0;e.includes("右へ")||e.includes("右に")||e.includes("右側へ")||e.includes("右側に")?t=5:(e.includes("左へ")||e.includes("左に")||e.includes("左側へ")||e.includes("左側に"))&&(t=-5),e.includes("上へ")||e.includes("上に")||e.includes("上側へ")?n=3:(e.includes("下へ")||e.includes("下に")||e.includes("下側へ"))&&(n=-3),e.includes("前へ")||e.includes("手前へ")||e.includes("近くへ")?i=3:(e.includes("後ろへ")||e.includes("奥へ")||e.includes("遠くへ"))&&(i=-3);const o=e.match(/(\d+(?:\.\d+)?)\s*(?:メートル|m)/);if(o){const e=parseFloat(o[1]);Math.abs(t)>0&&(t=t>0?e:-e),Math.abs(n)>0&&(n=n>0?e:-e),Math.abs(i)>0&&(i=i>0?e:-e)}return e.includes("少し")||e.includes("ちょっと")?(t*=.5,n*=.5,i*=.5):(e.includes("大きく")||e.includes("たくさん"))&&(t*=2,n*=2,i*=2),console.log(`📍 Position movement parsed from "${e}": (${t}, ${n}, ${i})`),{x:t,y:n,z:i}}parsePosition(e){let t=0,n=5,i=-10;return e.includes("左下")?(t=-8,n=0,i=10,console.log(`📍 Position parsed from "${e}": 左下 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("右上")?(t=5,n=4,i=12,console.log(`📍 Position parsed from "${e}": 右上 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("左上")?(t=-8,n=4,i=15,console.log(`📍 Position parsed from "${e}": 左上 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("右下")?(t=8,n=0,i=10,console.log(`📍 Position parsed from "${e}": 右下 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("中央")||e.includes("真ん中")||e.includes("正面")?(t=0,n=3,i=12,console.log(`📍 Position parsed from "${e}": 中央 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("空")||e.includes("天空")?(t=0,n=20,i=10,console.log(`📍 Position parsed from "${e}": 空中 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("地面")||e.includes("足元")?(t=0,n=1,i=8,console.log(`📍 Position parsed from "${e}": 地面 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):(e.includes("前に")||e.includes("手前に")?i=Math.min(i,-6):(e.includes("後ろに")||e.includes("奥に")||e.includes("遠くに"))&&(i=-25),e.includes("右に")||e.includes("右側")||e.includes("画面の右")?t=8:(e.includes("左に")||e.includes("左側")||e.includes("画面の左"))&&(t=-8),e.includes("上に")||e.includes("上側")||e.includes("画面の上")||e.includes("高い位置に")||e.includes("空中に")?n=8:(e.includes("下に")||e.includes("下側")||e.includes("画面の下")||e.includes("低い位置に")||e.includes("地面に"))&&(n=-2),e.includes("近くに")||e.includes("すぐ前に")?i=Math.max(.5*i,-4):(e.includes("遠くに")||e.includes("向こうに"))&&(i=Math.min(1.5*i,-30)),console.log(`📍 Position parsed from "${e}": (${t}, ${n}, ${i})`),{x:t,y:n,z:i})}parseSize(e){return e.includes("大きな")||e.includes("大きい")?{scale:2}:e.includes("小さな")||e.includes("小さい")?{scale:.5}:{scale:this.config.defaultObjectScale}}async dispatchCommand(e){switch(e.type){case"image_generation":if(!this.client||!this.client.serverUrl)throw new Error("画像生成機能を使用するにはサーバー設定が必要です。インポート機能のみ利用可能です。");return await this.executeImageGeneration(e);case"video_generation":if(!this.client||!this.client.serverUrl)throw new Error("動画生成機能を使用するにはサーバー設定が必要です。インポート機能のみ利用可能です。");return await this.executeVideoGeneration(e);case"object_modification":return await this.executeObjectModification(e);case"natural_object_modification":return await this.executeNaturalObjectModification(e);case"delete":return await this.executeDelete(e);case"file_import":return await this.executeFileImport(e);case"object_selection":return await this.executeObjectSelection(e);default:throw new Error(`Unknown command type: ${e.type}`)}}async executeImageGeneration(e){try{console.log(`🎨 Generating image: "${e.prompt}"`);const t=[{width:512,height:512},{width:768,height:432},{width:1024,height:1024},{width:640,height:480}];let n,i;for(let o=0;o<t.length;o++){const r=t[o];try{if(console.log(`🔄 Trying ${r.width}x${r.height}...`),n=await this.client.generateImage(e.prompt,{width:r.width,height:r.height,service:this.selectedImageService||void 0}),n.success){console.log(`✅ Success with ${r.width}x${r.height}`);break}}catch(e){if(i=e,console.log(`⚠️ Failed with ${r.width}x${r.height}: ${e.message}`),o<t.length-1){console.log("🔄 Retrying with next size...");continue}}}n&&n.modelName&&console.log(`📡 Used model: ${n.modelName}`);const o=new h.TextureLoader;let r;if(n&&n.success&&(n.imageUrl||n.localPath)){let e=n.imageUrl;if(!e&&n.localPath){const t=n.localPath.split("/").pop();e=`${this.client.serverUrl}/generated/${t}`}console.log(`✅ Image generated successfully: ${e}`),r=await o.loadAsync(e),r.colorSpace=h.SRGBColorSpace}else console.log(`⚠️ Using fallback image (last error: ${i?.message||"unknown"})`),r=this.createFallbackTexture(e.prompt);const a=6*(e.size?.scale??this.config.defaultObjectScale??1),s=r.image?.naturalWidth||r.image?.width||r.source?.data?.width||1,l=s/(r.image?.naturalHeight||r.image?.height||r.source?.data?.height||1)||1;let c=a,d=a;l>=1?(c=a,d=a/l):(c=a*l,d=a);const p=new h.PlaneGeometry(c,d),u=new h.MeshBasicMaterial({map:r,transparent:!0,side:h.DoubleSide,toneMapped:!1}),g=new h.Mesh(p,u);if(g.renderOrder=1e3,u.depthTest=!0,u.depthWrite=!0,u.alphaTest=.01,u.needsUpdate=!0,this.camera){const t=this.calculateCameraRelativePosition(e.position);g.position.copy(t),this.alignPlaneToCamera(g)}else g.position.set(e.position.x,e.position.y,e.position.z);g.scale.setScalar(1);const m="generated_"+ ++this.objectCounter;return g.name=m,g.userData={id:m,prompt:e.prompt,createdAt:Date.now(),type:"generated_image",source:"generated_image",modelName:n?.modelName||this.selectedImageService||null,keywords:this.buildObjectKeywordHints({prompt:e.prompt,baseType:"image"})},this.experimentGroup.add(g),this.spawnedObjects.set(m,g),console.log(`✅ Created object: ${m} at (${e.position.x}, ${e.position.y}, ${e.position.z})`),this.config.showLocationIndicator&&this.createLocationIndicator(e.position),{objectId:m,position:e.position,prompt:e.prompt,modelName:n?.modelName,success:!0,fallbackUsed:!n?.success,error:n?.success?null:i?.message||n?.error||"画像生成に失敗しました"}}catch(e){throw console.error("🎨 Image generation failed:",e),e.fallbackUsed=!0,e}}async executeVideoGeneration(e){try{console.log(`🎬 Generating video: "${e.prompt}"`),console.log("🔍 Video generation - selectedVideoService:",this.selectedVideoService);const t=await this.client.generateVideo(e.prompt,{duration:3,model:this.selectedVideoService||void 0});let n;t.modelName&&console.log(`📡 Used model: ${t.modelName}`);let i=null;const o=t.success&&t.videoUrl;o?(console.log(`✅ Video generated successfully: ${t.videoUrl}`),i=document.createElement("video"),i.src=t.videoUrl,i.crossOrigin="anonymous",i.loop=!0,i.muted=!0,i.playsInline=!0,n=new h.VideoTexture(i),n.colorSpace=h.SRGBColorSpace,i.addEventListener("loadeddata",()=>{i.play().catch(console.error)})):(console.log("⚠️ Using fallback video texture"),n=this.createFallbackVideoTexture(e.prompt));const r=6*(e.size?.scale??this.config.defaultObjectScale??1),a=t.metadata?.width||512,s=t.metadata?.height||512,l=a&&s?a/s:1;let c=r,d=r;l>=1?d=r/l:c=r*l;const p=new h.PlaneGeometry(c,d),u=new h.MeshBasicMaterial({map:n,transparent:!1,side:h.DoubleSide,toneMapped:!1}),g=new h.Mesh(p,u);if(g.renderOrder=1e3,u.depthTest=!0,u.depthWrite=!0,this.camera){const t=this.calculateCameraRelativePosition(e.position);g.position.copy(t),this.alignPlaneToCamera(g)}else g.position.set(e.position.x,e.position.y,e.position.z);g.scale.setScalar(1);const m="generated_video_"+ ++this.objectCounter;return g.name=m,g.userData={id:m,prompt:e.prompt,createdAt:Date.now(),type:"generated_video",source:"generated_video",videoUrl:t.videoUrl,modelName:t.modelName||this.selectedVideoService||null,width:a,height:s,videoElement:i,keywords:this.buildObjectKeywordHints({prompt:e.prompt,baseType:"video"})},this.createAudioControl(g),this.experimentGroup.add(g),this.spawnedObjects.set(m,g),console.log(`✅ Created video object: ${m} at (${e.position.x}, ${e.position.y}, ${e.position.z})`),this.config.showLocationIndicator&&this.createLocationIndicator(e.position),{objectId:m,position:e.position,prompt:e.prompt,modelName:t.modelName,videoUrl:t.videoUrl,success:!0,fallbackUsed:!o,error:o?null:t?.error||"動画生成に失敗しました"}}catch(t){console.error("🎬 Video generation failed:",t),console.log("🔄 Creating fallback video plane due to generation error");const n=this.createFallbackVideoTexture(e.prompt),i=6*(e.size?.scale??this.config.defaultObjectScale??1),o=new h.PlaneGeometry(i,i),r=new h.MeshBasicMaterial({map:n,transparent:!1,side:h.DoubleSide,toneMapped:!1}),a=new h.Mesh(o,r);if(this.camera){const t=this.calculateCameraRelativePosition(e.position);a.position.copy(t),this.alignPlaneToCamera(a)}else a.position.set(e.position.x,e.position.y,e.position.z);a.scale.setScalar(1);const s="generated_video_"+ ++this.objectCounter;return a.name=s,a.userData={id:s,prompt:e.prompt,createdAt:Date.now(),type:"generated_video",source:"generated_video",videoUrl:null,modelName:"Error Fallback",width:512,height:512,videoElement:null,error:t.message,keywords:this.buildObjectKeywordHints({prompt:e.prompt,baseType:"video"})},this.scene.add(a),console.log("📍 Fallback video plane added to scene"),{success:!1,error:t.message,object:a,prompt:e.prompt}}}async loadImageFile(e,t={}){try{const{position:n={x:0,y:5,z:-10},fileName:i=null}=t;console.log(`📁 Loading image file: ${e}`);const o=new h.TextureLoader,r=await o.loadAsync(e);r.colorSpace=h.SRGBColorSpace;const a=r.image?.naturalWidth||r.image?.width||r.source?.data?.width||1,s=a/(r.image?.naturalHeight||r.image?.height||r.source?.data?.height||1)||1,l=6;let c=l,d=l;s>=1?(c=l,d=l/s):(c=l*s,d=l);const p=new h.PlaneGeometry(c,d),u=new h.MeshBasicMaterial({map:r,transparent:!0,side:h.DoubleSide,toneMapped:!1});u.alphaTest=.01,u.needsUpdate=!0;const g=new h.Mesh(p,u);if(g.renderOrder=1e3,u.depthTest=!0,u.depthWrite=!0,this.camera){const e=this.calculateCameraRelativePosition(n);g.position.copy(e),this.alignPlaneToCamera(g)}else g.position.set(n.x,n.y,n.z);g.scale.setScalar(1);const m=i?i.replace(/\.[^/.]+$/,""):"imported_image",b="imported_image_"+ ++this.objectCounter;return g.name=b,g.userData={id:b,source:"imported_file",createdAt:Date.now(),type:"generated_image",prompt:m,fileName:i,importOrder:this.objectCounter,keywords:this.buildObjectKeywordHints({prompt:m,fileName:i,baseType:"image"})},this.experimentGroup.add(g),this.spawnedObjects.set(b,g),console.log(`✅ Created imported image: ${b} at (${n.x}, ${n.y}, ${n.z})`),this.config.showLocationIndicator&&this.createLocationIndicator(n),{objectId:b,position:n,success:!0}}catch(e){throw console.error("📁 Image file loading failed:",e),e}}async loadVideoFile(e,t={}){try{const{position:n={x:0,y:5,z:-10},fileName:i=null}=t;console.log(`🎬 Loading video file: ${e}`);const o=document.createElement("video");o.src=e,o.loop=!0,o.muted=!0,o.playsInline=!0,o.autoplay=!0,o.preload="auto";const r=new h.VideoTexture(o);r.colorSpace=h.SRGBColorSpace,r.flipY=!0,r.minFilter=h.LinearFilter,r.magFilter=h.LinearFilter,r.generateMipmaps=!1,r.needsUpdate=!0,await new Promise((e,t)=>{o.addEventListener("loadedmetadata",()=>{console.log(`🎬 Video loaded: ${o.videoWidth}x${o.videoHeight}`),e()},{once:!0}),o.addEventListener("error",e=>{t(e?.error||new Error("Video failed to load"))},{once:!0}),o.load()});try{await o.play()}catch(e){console.warn("🎬 Video autoplay could not start automatically. Playback will require user interaction.",e)}const a=o.videoWidth/o.videoHeight,s=6;let l=s,c=s;a>1?c=s/a:l=s*a;const d=new h.PlaneGeometry(l,c),p=new h.MeshBasicMaterial({map:r,transparent:!0,side:h.DoubleSide,toneMapped:!1});p.alphaTest=.01,p.depthTest=!0,p.depthWrite=!1,p.needsUpdate=!0;const u=new h.Mesh(d,p);if(u.renderOrder=1001,this.camera){const e=this.calculateCameraRelativePosition(n);u.position.copy(e),this.alignPlaneToCamera(u)}else u.position.set(n.x,n.y,n.z);u.scale.setScalar(1),u.userData.videoTexture=r;const g=i?i.replace(/\.[^/.]+$/,""):"imported_video",m="imported_video_"+ ++this.objectCounter;return u.name=m,u.userData={id:m,source:"imported_file",createdAt:Date.now(),type:"generated_video",videoElement:o,objectUrl:e,prompt:g,fileName:i,importOrder:this.objectCounter,keywords:this.buildObjectKeywordHints({prompt:g,fileName:i,baseType:"video"})},this.createAudioControl(u),this.experimentGroup.add(u),this.spawnedObjects.set(m,u),console.log(`✅ Created imported video: ${m} at (${n.x}, ${n.y}, ${n.z})`),this.config.showLocationIndicator&&this.createLocationIndicator(n),{objectId:m,position:n,success:!0}}catch(e){throw console.error("🎬 Video file loading failed:",e),e}}async executeNaturalObjectModification(e){const t=this.findObjectsByName(e.targetObjectName);if(0===t.length)return{success:!1,message:`オブジェクト「${e.targetObjectName}」が見つかりませんでした`};console.log(`🔍 Found ${t.length} object(s) matching "${e.targetObjectName}"`);const n=this.selectObjectFromMultiple(t,e.targetObjectName);console.log(`🎯 Operating on object: ${n.name}`);let i=!1;if(null!==e.color&&n.material&&(n.material.map?(n.material.color.setHex(e.color),n.material.needsUpdate=!0,console.log(`🎨 Texture color tint changed to: #${e.color.toString(16)}`)):(n.material.color.setHex(e.color),n.material.needsUpdate=!0,console.log(`🎨 Material color changed to: #${e.color.toString(16)}`)),i=!0),e.effects&&e.effects.length>0){this.applyEffects(n,e.effects)&&(i=!0)}if(null!==e.movement){const t=n.position,o={x:t.x+e.movement.x,y:t.y+e.movement.y,z:t.z+e.movement.z};n.position.set(o.x,o.y,o.z),console.log(`📍 Position moved from (${t.x.toFixed(1)}, ${t.y.toFixed(1)}, ${t.z.toFixed(1)}) to (${o.x.toFixed(1)}, ${o.y.toFixed(1)}, ${o.z.toFixed(1)})`),i=!0}return i?(n.userData.lastModified=Date.now(),n.userData.modifications=n.userData.modifications||[],n.userData.modifications.push({timestamp:Date.now(),color:e.color,movement:e.movement,command:`Natural language: ${e.targetObjectName}`}),{success:!0,message:`オブジェクト「${n.name}」を変更しました`,objectId:n.name,modifications:{color:e.color,movement:e.movement}}):{success:!1,message:"変更可能な属性が見つかりませんでした"}}findObjectsByName(e){const t=[],n=e.toLowerCase();for(const[e,i]of this.spawnedObjects){if(i.userData.prompt){i.userData.prompt.toLowerCase().includes(n)&&(t.push(i),console.log(`✅ Object match found: ${e} (prompt: "${i.userData.prompt}")`))}i.name&&i.name.toLowerCase().includes(n)&&(t.push(i),console.log(`✅ Object match found: ${e} (name: "${i.name}")`))}return t}selectObjectFromMultiple(e,t){const n=[/(\d+)つ目の/,/(\d+)番目の/,/(\d+)個目の/,/最初の|1つ目の|1番目の|1個目の/,/最後の|最終の/,/2つ目の|2番目の|2個目の/,/3つ目の|3番目の|3個目の/];for(const i of n){const n=t.match(i);if(n){let t;if(n[1])t=parseInt(n[1])-1;else{const i=n[0];i.includes("最初")||i.includes("1つ目")||i.includes("1番目")||i.includes("1個目")?t=0:i.includes("最後")||i.includes("最終")?t=e.length-1:i.includes("2つ目")||i.includes("2番目")||i.includes("2個目")?t=1:(i.includes("3つ目")||i.includes("3番目")||i.includes("3個目"))&&(t=2)}if(t>=0&&t<e.length)return console.log(`🔢 Selected object by ordinal: index ${t+1} of ${e.length}`),e[t];console.warn(`⚠️ Invalid ordinal index: ${t+1} (available: 1-${e.length})`)}}return console.log("🔢 No ordinal specified, using first object"),e[0]}async executeObjectModification(e){let t=this.findObjectByKeyword(e.command);if(t)this.selectObject(t),this.applyRecognitionFeedback(t);else{if(!this.selectedObject)return{success:!1,message:"オブジェクトを選択するか、対象を指定してください（例：「猫を赤くして」）"};t=this.selectedObject}console.log(`🔧 Modifying object: ${t.name}`),console.log("🔍 Debug - parsed.movement:",e.movement);let n=!1;if(null!==e.color&&t.material&&(t.material.map?(t.material.color.setHex(e.color),t.material.needsUpdate=!0,console.log(`🎨 Texture color tint changed to: #${e.color.toString(16)}`)):(t.material.color.setHex(e.color),t.material.needsUpdate=!0,console.log(`🎨 Material color changed to: #${e.color.toString(16)}`)),n=!0),e.effects&&e.effects.length>0){this.applyEffects(t,e.effects)&&(n=!0)}if(null!==e.scale){const i=t.scale.x,o=i*e.scale;t.scale.setScalar(o),console.log(`📏 Scale changed from ${i} to ${o}`),n=!0}if(null!==e.movement){const i=t.position,o={x:i.x+e.movement.x,y:i.y+e.movement.y,z:i.z+e.movement.z};t.position.set(o.x,o.y,o.z),console.log(`📍 Position moved from (${i.x.toFixed(1)}, ${i.y.toFixed(1)}, ${i.z.toFixed(1)}) to (${o.x.toFixed(1)}, ${o.y.toFixed(1)}, ${o.z.toFixed(1)})`),n=!0}if(null!==e.rotation){const i=t.rotation.y+e.rotation;t.rotation.y=i;const o=(180*e.rotation/Math.PI).toFixed(1);console.log(`🔄 Rotation changed by ${o}° (new Y rotation: ${(180*i/Math.PI).toFixed(1)}°)`),n=!0}if(null!==e.opacity&&t.material){const i=t.material.opacity||1;t.material.opacity=e.opacity,t.material.transparent=e.opacity<1,console.log(`🔍 Opacity changed from ${i.toFixed(2)} to ${e.opacity.toFixed(2)}`),n=!0}if(e.flip){const e=t.scale.x;t.scale.x=-e,console.log(`↔️ Object flipped horizontally (scale.x: ${e} → ${t.scale.x})`),n=!0}return n?(t.userData.lastModified=Date.now(),t.userData.modifications=t.userData.modifications||[],t.userData.modifications.push({timestamp:Date.now(),color:e.color,scale:e.scale,movement:e.movement,rotation:e.rotation,opacity:e.opacity,command:e.command}),this.updateAllAudioControlPositions(),{success:!0,message:`オブジェクト「${t.name}」を変更しました`,objectId:t.name,modifications:{color:e.color,scale:e.scale,movement:e.movement,rotation:e.rotation,opacity:e.opacity}}):{success:!1,message:"変更可能な属性が見つかりませんでした"}}async executeDelete(e){const t=e.command||"";if("all"===e.target||t.includes("すべて")||t.includes("全部"))return this.clearAll(),{success:!0,message:"すべてのオブジェクトを削除しました"};const n=this.findObjectByKeyword(t);let i=null,o="";if(t.match(/^(削除|消して|消す|delete|remove)$/i)&&this.selectedObject?(i=this.selectedObject,o="選択されたオブジェクト"):n?(i=n,o="コマンドで指定されたオブジェクト"):this.selectedObject&&(i=this.selectedObject,o="選択されたオブジェクト"),i){const e=i.name;console.log(`🗑️ Deleting ${o}: ${e}`),i===this.selectedObject&&this.deselectObject();return this.removeObject(e)?{success:!0,message:`${o}「${e}」を削除しました`,deletedObjectId:e}:{success:!1,message:"オブジェクトの削除に失敗しました"}}return{success:!1,message:"削除対象が見つかりませんでした。オブジェクトを選択するか、対象を指定してください"}}async executeFileImport(e){try{console.log("🍫 Starting file import process...");const t=document.createElement("input");return t.type="file",t.style.display="none","video"===e.fileType?t.accept="video/*":t.accept="image/*",document.body.appendChild(t),new Promise((n,i)=>{t.onchange=async o=>{try{const t=o.target.files[0];if(!t)return void i(new Error("ファイルが選択されませんでした"));console.log(`📁 Selected file: ${t.name}`);const r=URL.createObjectURL(t);let a;a="video"===e.fileType||t.type.startsWith("video/")?await this.loadVideoFile(r,{position:e.position}):await this.loadImageFile(r,{position:e.position}),console.log("✅ File import completed:",a),n(a)}catch(e){console.error("❌ File import failed:",e),i(e)}finally{document.body.removeChild(t)}},t.oncancel=()=>{document.body.removeChild(t),i(new Error("ファイル選択がキャンセルされました"))},t.click()})}catch(e){throw console.error("❌ File import execution failed:",e),e}}async executeObjectSelection(e){try{console.log("🎯 Starting object selection...");const e=this.getSpawnedObjects();if(0===e.length)throw new Error("選択可能なオブジェクトがありません。まずファイルをインポートしてください。");console.log(`📋 Available objects: ${e.length}`);const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.8);\n        z-index: 10000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      ";const n=document.createElement("div");n.style.cssText="\n        background: #1a1a2e;\n        border-radius: 12px;\n        padding: 24px;\n        max-width: 500px;\n        max-height: 70vh;\n        overflow-y: auto;\n        color: white;\n        font-family: Arial, sans-serif;\n      ";const i=document.createElement("h3");i.textContent="🎯 オブジェクトを選択してください",i.style.cssText="margin: 0 0 16px 0; color: #ec4899;",n.appendChild(i);const o=document.createElement("div");o.style.cssText="margin-bottom: 16px;",e.forEach((e,n)=>{const i=document.createElement("div");i.style.cssText="\n          padding: 12px;\n          margin: 8px 0;\n          background: #2a2a3e;\n          border-radius: 8px;\n          cursor: pointer;\n          border: 2px solid transparent;\n          transition: all 0.3s ease;\n        ";const r="generated_image"===e.userData?.type?"🖼️ 画像":"generated_video"===e.userData?.type?"🎬 動画":"📄 ファイル",a=new Date(e.userData?.createdAt).toLocaleTimeString();i.innerHTML=`\n          <div style="font-weight: bold;">${r} #${n+1}</div>\n          <div style="font-size: 12px; color: #94a3b8;">作成: ${a}</div>\n          <div style="font-size: 12px; color: #94a3b8;">位置: (${Math.round(e.position.x)}, ${Math.round(e.position.y)}, ${Math.round(e.position.z)})</div>\n        `,i.onmouseover=()=>{i.style.borderColor="#ec4899",i.style.background="#3a3a4e"},i.onmouseout=()=>{i.style.borderColor="transparent",i.style.background="#2a2a3e"},i.onclick=()=>{resolve({selectedObjectId:e.id,selectedObject:e}),document.body.removeChild(t)},o.appendChild(i)}),n.appendChild(o);const r=document.createElement("button");return r.textContent="キャンセル",r.style.cssText="\n        background: #666;\n        color: white;\n        border: none;\n        padding: 8px 16px;\n        border-radius: 6px;\n        cursor: pointer;\n        font-size: 14px;\n      ",r.onclick=()=>{document.body.removeChild(t),reject(new Error("オブジェクト選択がキャンセルされました"))},n.appendChild(r),t.appendChild(n),document.body.appendChild(t),new Promise((e,t)=>{})}catch(e){throw console.error("❌ Object selection failed:",e),e}}createFallbackTexture(e){const t=document.createElement("canvas");t.width=512,t.height=512;const n=t.getContext("2d"),i=this.hashString(e)%360,o=n.createLinearGradient(0,0,512,512);return o.addColorStop(0,`hsl(${i}, 70%, 60%)`),o.addColorStop(1,`hsl(${(i+60)%360}, 70%, 40%)`),n.fillStyle=o,n.fillRect(0,0,512,512),n.fillStyle="white",n.font="24px Arial",n.textAlign="center",n.fillText("🎨",256,230),n.font="16px Arial",n.fillText(e.slice(0,20),256,270),n.font="14px Arial",n.fillStyle="rgba(255,255,255,0.7)",n.fillText("Placeholder Image",256,300),new h.CanvasTexture(t)}createFallbackVideoTexture(e){const t=document.createElement("canvas");t.width=512,t.height=512;const n=t.getContext("2d"),i=this.hashString(e)%360;let o=0;const r=()=>{const t=n.createLinearGradient(0,0,512,512),a=2*o%360;t.addColorStop(0,`hsl(${(i+a)%360}, 70%, 60%)`),t.addColorStop(1,`hsl(${(i+a+60)%360}, 70%, 40%)`),n.fillStyle=t,n.fillRect(0,0,512,512),n.fillStyle="white",n.font="24px Arial",n.textAlign="center";const s=["🎬","🎥","📹","🎞️"],l=Math.floor(o/10)%s.length;n.fillText(s[l],256,230),n.font="16px Arial",n.fillText(e.slice(0,20),256,270),n.font="14px Arial",n.fillStyle="rgba(255,255,255,0.7)",n.fillText("Placeholder Video",256,300),o++,setTimeout(()=>requestAnimationFrame(r),1e3/60)};return r(),new h.CanvasTexture(t)}hashString(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t)}getSpawnedObjects(){return Array.from(this.spawnedObjects.entries()).map(([e,t])=>({id:e,name:t.name,userData:t.userData,position:t.position.clone()}))}removeObject(e){const t=this.spawnedObjects.get(e);if(t){if(t.userData?.videoElement){const e=t.userData.videoElement;try{e.pause(),"function"==typeof e.removeAttribute?e.removeAttribute("src"):e.src="","function"==typeof e.load&&e.load()}catch(e){console.warn("🎬 Failed to release video element resources:",e)}}if(t.userData?.objectUrl)try{URL.revokeObjectURL(t.userData.objectUrl)}catch(e){console.warn("🎬 Failed to revoke object URL:",e)}if(t.userData?.cleanupCallbacks)try{t.userData.cleanupCallbacks.forEach(e=>{"function"==typeof e&&e()})}catch(e){console.warn("🧹 Cleanup callbacks failed:",e)}if(this.experimentGroup.remove(t),this.spawnedObjects.delete(e),t.geometry&&t.geometry.dispose(),t.material){(Array.isArray(t.material)?t.material:[t.material]).forEach(e=>{e.map&&"function"==typeof e.map.dispose&&e.map.dispose(),e.dispose()})}return console.log(`🗑️ Removed object: ${e}`),!0}return!1}clearAll(){Array.from(this.spawnedObjects.keys()).forEach(e=>this.removeObject(e)),console.log("🧹 Cleared all experimental objects")}getCommandHistory(){return[...this.commandHistory]}createLocationIndicator(e){const t=new h.SphereGeometry(1,16,16),n=new h.MeshBasicMaterial({color:65280,transparent:!0,opacity:.9}),i=new h.Mesh(t,n);if(this.camera){const t=this.calculateCameraRelativePosition({x:e.x,y:e.y+2,z:e.z});i.position.copy(t)}else i.position.set(e.x,e.y+2,e.z);console.log(`🟢 インジケーター表示: (${i.position.x.toFixed(1)}, ${i.position.y.toFixed(1)}, ${i.position.z.toFixed(1)})`),this.scene.add(i),setTimeout(()=>{this.scene.remove(i),t.dispose(),n.dispose()},this.config.indicatorDuration);let o=.8,r=-1;const a=()=>{o+=.05*r,o<=.3&&(r=1),o>=.8&&(r=-1),n.opacity=o,i.parent&&requestAnimationFrame(a)};a()}clearLoadingStates(){const e=[];if(this.scene.traverse(t=>{t.userData&&t.userData.isLoadingIndicator&&e.push(t)}),e.forEach(e=>{this.scene.remove(e),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())}),this.animations)for(const[e,t]of this.animations.entries())("loading"===t.type||t.isLoadingAnimation)&&this.animations.delete(e);console.log("🧹 Loading states cleared from scene")}calculateCameraRelativePosition(e){if(!this.camera)return this.config.enableDebugLogging&&console.warn("📷 Camera not available, using fallback positioning"),new h.Vector3(e.x,e.y,e.z);try{const t=new h.Vector3;this.camera.getWorldPosition(t);const n=new h.Vector3;this.camera.getWorldDirection(n).normalize();let i=new h.Vector3;i.copy(this.camera.up).applyQuaternion(this.camera.getWorldQuaternion(new h.Quaternion)).normalize(),0===i.lengthSq()&&i.set(0,1,0);const o=(new h.Vector3).crossVectors(n,i).normalize();0===o.lengthSq()&&o.set(1,0,0),i=(new h.Vector3).crossVectors(o,n).normalize();const r=t.clone();r.add(n.clone().multiplyScalar(e.z)),r.add(o.clone().multiplyScalar(e.x)),r.add(i.clone().multiplyScalar(e.y));const a=r.clone().sub(t);if(n.dot(a.normalize())<.05){const i=Math.max(4,Math.abs(e.z))||6;r.copy(t).add(n.clone().multiplyScalar(i)),this.logDebug("⚠️ Adjusted object position to keep it in front of the camera")}return this.logDebug(`📍 Camera relative position calculated: (${r.x.toFixed(1)}, ${r.y.toFixed(1)}, ${r.z.toFixed(1)})`),r}catch(t){return console.error("❌ Camera relative position calculation failed:",t),new h.Vector3(e.x,e.y,e.z)}}alignPlaneToCamera(e){if(!this.camera)return;const t=new h.Vector3;this.camera.getWorldDirection(t),t.normalize().negate();let n=new h.Vector3;n.copy(this.camera.up).applyQuaternion(this.camera.getWorldQuaternion(new h.Quaternion)).normalize(),Math.abs(t.dot(n))>.999&&(n=new h.Vector3(0,1,0),Math.abs(t.dot(n))>.999&&(n=new h.Vector3(0,0,1)));const i=(new h.Vector3).crossVectors(t,n).normalize();n=(new h.Vector3).crossVectors(i,t).normalize();const o=new h.Matrix4;o.makeBasis(i,n,t),e.quaternion.setFromRotationMatrix(o)}setCamera(e){this.camera=e}updateConfig(e){this.config={...this.config,...e}}setImageService(e){this.selectedImageService=e||null,this.logDebug("🎯 Updated image service:",this.selectedImageService)}getImageService(){return this.selectedImageService}setVideoService(e){this.selectedVideoService=e||null,this.logDebug("🎬 Updated video service:",this.selectedVideoService)}getVideoService(){return this.selectedVideoService}createAudioControl(e){const t=e.userData.videoElement;if(!t)return;const n=document.createElement("div");n.className="chocodrop-audio-control",n.innerHTML="♪";const i=(()=>{const e=document.createElement("div");return e.className="chocodrop-audio-tooltip",e.textContent="音声のオン/オフ切り替え",e.style.cssText="\n        position: absolute !important;\n        background: rgba(0, 0, 0, 0.85) !important;\n        backdrop-filter: blur(12px) !important;\n        -webkit-backdrop-filter: blur(12px) !important;\n        border: 1px solid rgba(255, 255, 255, 0.15) !important;\n        border-radius: 8px !important;\n        padding: 8px 12px !important;\n        color: white !important;\n        font-size: 11px !important;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;\n        font-weight: 500 !important;\n        white-space: nowrap !important;\n        pointer-events: none !important;\n        z-index: 1000000 !important;\n        opacity: 0 !important;\n        transform: translateY(-100%) translateX(-50%) !important;\n        transition: opacity 0.2s ease !important;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;\n        margin-bottom: 8px !important;\n      ",e})();document.body.appendChild(i);const o=(()=>{const e=document.createElement("div");e.className="chocodrop-volume-slider",e.style.cssText="\n        position: absolute !important;\n        width: 30px !important;\n        height: 100px !important;\n        background: rgba(0, 0, 0, 0.85) !important;\n        backdrop-filter: blur(12px) !important;\n        -webkit-backdrop-filter: blur(12px) !important;\n        border: 1px solid rgba(255, 255, 255, 0.15) !important;\n        border-radius: 15px !important;\n        padding: 10px 8px !important;\n        z-index: 1000001 !important;\n        opacity: 0 !important;\n        pointer-events: none !important;\n        transition: opacity 0.2s ease !important;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;\n        display: flex !important;\n        flex-direction: column !important;\n        align-items: center !important;\n        justify-content: center !important;\n      ";const i=document.createElement("input");i.type="range",i.min="0",i.max="100",i.value="100",i.style.cssText="\n        width: 80px !important;\n        height: 12px !important;\n        background: rgba(255, 255, 255, 0.2) !important;\n        border-radius: 6px !important;\n        outline: none !important;\n        cursor: pointer !important;\n        -webkit-appearance: none !important;\n        appearance: none !important;\n        transform: rotate(-90deg) !important;\n        transform-origin: center !important;\n      ";const o=document.createElement("style");return o.textContent='\n        .chocodrop-volume-slider input[type="range"]::-webkit-slider-track {\n          width: 6px;\n          height: 80px;\n          background: rgba(255, 255, 255, 0.2);\n          border-radius: 3px;\n        }\n        .chocodrop-volume-slider input[type="range"]::-webkit-slider-thumb {\n          -webkit-appearance: none;\n          width: 14px;\n          height: 14px;\n          background: white;\n          border-radius: 50%;\n          cursor: pointer;\n          box-shadow: 0 2px 6px rgba(0,0,0,0.3);\n        }\n        .chocodrop-volume-slider input[type="range"]::-moz-range-track {\n          width: 6px;\n          height: 80px;\n          background: rgba(255, 255, 255, 0.2);\n          border-radius: 3px;\n          border: none;\n        }\n        .chocodrop-volume-slider input[type="range"]::-moz-range-thumb {\n          width: 14px;\n          height: 14px;\n          background: white;\n          border-radius: 50%;\n          cursor: pointer;\n          border: none;\n          box-shadow: 0 2px 6px rgba(0,0,0,0.3);\n        }\n      ',document.head.appendChild(o),i.addEventListener("input",e=>{const i=e.target.value;t.volume=i/100,0==i?(n.innerHTML='<span style="position: relative;">♪<span style="position: absolute; top: 0; left: 0; color: #8b5cf6; font-size: 14px;">⃠</span></span>',n.style.background="rgba(99, 102, 241, 0.6) !important",n.title="ミュート中"):(n.innerHTML="♪",n.style.background="rgba(0, 0, 0, 0.4) !important",n.style.color="white !important",n.title="音声ON")}),e.appendChild(i),e})();document.body.appendChild(o),n.style.cssText="\n      position: absolute !important;\n      width: 18px !important;\n      height: 18px !important;\n      background: rgba(0, 0, 0, 0.4) !important;\n      border: 1px solid rgba(255, 255, 255, 0.3) !important;\n      border-radius: 50% !important;\n      color: white !important;\n      font-size: 9px !important;\n      cursor: pointer !important;\n      display: flex !important;\n      align-items: center !important;\n      justify-content: center !important;\n      z-index: 999999 !important;\n      transition: all 0.2s ease !important;\n      user-select: none !important;\n      box-shadow: 0 1px 4px rgba(0,0,0,0.2) !important;\n      backdrop-filter: blur(8px) !important;\n      pointer-events: auto !important;\n      opacity: 1 !important;\n    ";let r=!1;n.addEventListener("mouseenter",()=>{if(n.style.background="rgba(0, 0, 0, 0.7)",n.style.transform="scale(1.05)",n.style.borderColor="rgba(255, 255, 255, 0.5)",!r){const e=n.getBoundingClientRect();i.style.left=`${e.left+e.width/2}px`,i.style.top=e.top-8+"px",i.style.opacity="1"}}),n.addEventListener("mouseleave",()=>{n.style.background="rgba(0, 0, 0, 0.5)",n.style.transform="scale(1.0)",n.style.borderColor="rgba(255, 255, 255, 0.4)",i.style.opacity="0"}),n.addEventListener("click",e=>{if(e.stopPropagation(),r)return r=!1,o.style.opacity="0",void(o.style.pointerEvents="none");t.muted||0===t.volume?(t.muted=!1,t.volume=o.querySelector("input").value/100,n.innerHTML="♪",n.style.background="rgba(0, 0, 0, 0.4) !important",n.style.color="white !important",n.title="音声ON"):(t.muted=!0,n.innerHTML='<span style="position: relative;">♪<span style="position: absolute; top: 0; left: 0; color: #8b5cf6; font-size: 14px;">⃠</span></span>',n.style.background="rgba(99, 102, 241, 0.6) !important",n.title="ミュート中")}),n.addEventListener("contextmenu",e=>{if(e.preventDefault(),e.stopPropagation(),r=!r,r){const e=n.getBoundingClientRect();o.style.left=e.left+e.width/2-15+"px",o.style.top=e.top-110+"px",o.style.opacity="1",o.style.pointerEvents="auto",i.style.opacity="0"}else o.style.opacity="0",o.style.pointerEvents="none"}),document.addEventListener("click",e=>{!r||n.contains(e.target)||o.contains(e.target)||(r=!1,o.style.opacity="0",o.style.pointerEvents="none")}),document.body.appendChild(n),e.userData.audioControlElement=n,e.userData.updateAudioControlPosition=()=>{this.updateAudioControlPosition(e,n)},this.updateAudioControlPosition(e,n),this.audioControls.set(e.userData.id||e.uuid,{object:e,audioButton:n,tooltip:i,volumeSlider:o,hideSlider:()=>{r=!1,o.style.opacity="0",o.style.pointerEvents="none"}}),this.audioControlUpdateListener||(this.audioControlUpdateListener=()=>{this.updateAllAudioControlPositions()},window.addEventListener("scroll",this.audioControlUpdateListener,{passive:!0}),window.addEventListener("resize",this.audioControlUpdateListener,{passive:!0})),this.audioControlUpdateInterval||(this.audioControlUpdateInterval=setInterval(()=>{this.updateAllAudioControlPositions()},100));const a=e=>{!r||n.contains(e.target)||o.contains(e.target)||(r=!1,o.style.opacity="0",o.style.pointerEvents="none")};document.addEventListener("click",a,!0),e.userData.cleanupCallbacks=e.userData.cleanupCallbacks||[],e.userData.cleanupCallbacks.push(()=>{document.removeEventListener("click",a,!0),n.parentNode&&n.parentNode.removeChild(n),i.parentNode&&i.parentNode.removeChild(i),o.parentNode&&o.parentNode.removeChild(o),this.audioControls.delete(e.userData.id||e.uuid),0===this.audioControls.size&&(this.audioControlUpdateInterval&&(clearInterval(this.audioControlUpdateInterval),this.audioControlUpdateInterval=null),this.audioControlUpdateListener&&(window.removeEventListener("scroll",this.audioControlUpdateListener),window.removeEventListener("resize",this.audioControlUpdateListener),this.audioControlUpdateListener=null))}),console.log("🔊 Audio control created for video:",e.userData.id)}updateAudioControlPosition(e,t){if(!this.camera||!this.renderer||!t.parentNode)return;const n=new h.Vector3;e.getWorldPosition(n),n.project(this.camera);const i=this.renderer.domElement.getBoundingClientRect(),o=(.5*n.x+.5)*i.width+i.left,r=-(.5*n.y-.5)*i.height+i.top,a=e.geometry;if(a&&a.parameters){a.parameters.width,e.scale.x;const n=150,i=-50;t.style.left=`${o+n}px`,t.style.top=`${r+i}px`}else t.style.left=`${o+50}px`,t.style.top=r-20+"px"}updateAllAudioControlPositions(){this.audioControls&&0!==this.audioControls.size&&this.audioControls.forEach(e=>{const t=e.object;t&&t.userData&&t.userData.updateAudioControlPosition&&t.userData.updateAudioControlPosition()})}toggleVideoAudio(e,t){const n=e.userData.videoElement;n&&(n.muted?(n.muted=!1,t.innerHTML="🔈",console.log("🔊 Audio enabled for video:",e.userData.id)):(n.muted=!0,t.innerHTML="🔊",console.log("🔇 Audio muted for video:",e.userData.id)))}initializeLabelRenderer(){this.labelRenderer||this.loadAndInitializeCSS2DRenderer()}async ensureCSS2DRenderer(){this.labelRenderer||(this.css2dInitPromise||(this.css2dInitPromise=this.loadAndInitializeCSS2DRenderer()),await this.css2dInitPromise)}async loadAndInitializeCSS2DRenderer(){try{if(window.THREE&&window.THREE.CSS2DRenderer)return void this.setupCSS2DRenderer();console.log("🏷️ Loading CSS2DRenderer dynamically...");const e=await import("https://cdn.skypack.dev/three@0.158.0/examples/jsm/renderers/CSS2DRenderer.js");window.THREE||(window.THREE={}),window.THREE.CSS2DRenderer=e.CSS2DRenderer,window.THREE.CSS2DObject=e.CSS2DObject,console.log("✅ CSS2DRenderer loaded successfully"),this.setupCSS2DRenderer()}catch(e){console.warn("⚠️ Failed to load CSS2DRenderer:",e),console.warn("🔧 Audio controls will not be visible. Please include CSS2DRenderer in your project.")}}setupCSS2DRenderer(){try{this.labelRenderer=new window.THREE.CSS2DRenderer,this.labelRenderer.setSize(window.innerWidth,window.innerHeight),this.labelRenderer.domElement.style.position="absolute",this.labelRenderer.domElement.style.top="0px",this.labelRenderer.domElement.style.pointerEvents="none",this.renderer&&this.renderer.domElement.parentNode?this.renderer.domElement.parentNode.appendChild(this.labelRenderer.domElement):document.body.appendChild(this.labelRenderer.domElement),console.log("🏷️ CSS2DRenderer initialized for UI overlays"),this.addLabelRendererResizeHandler()}catch(e){console.warn("⚠️ Failed to setup CSS2DRenderer:",e)}}addLabelRendererResizeHandler(){this.labelRendererResizeHandler||(this.labelRendererResizeHandler=()=>{this.labelRenderer&&this.labelRenderer.setSize(window.innerWidth,window.innerHeight)},window.addEventListener("resize",this.labelRendererResizeHandler))}updateRenderer(){this.labelRenderer&&this.scene&&this.camera&&this.labelRenderer.render(this.scene,this.camera)}logDebug(...e){this.config.enableDebugLogging&&console.log(...e)}getAdaptiveSelectionColor(){const e=this.scene.background;let t={r:.5,g:.5,b:.5};e&&e.isColor&&(t={r:e.r,g:e.g,b:e.b});return(e=>{const{r:t,g:n,b:i}=e;return.2126*(t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.7152*(n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4))+.0722*(i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4))})(t)<.5?65416:1710638}getAdaptiveHoverColor(){const e=this.scene.background;let t={r:.5,g:.5,b:.5};e&&e.isColor&&(t={r:e.r,g:e.g,b:e.b});return(e=>{const{r:t,g:n,b:i}=e;return.2126*(t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.7152*(n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4))+.0722*(i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4))})(t)<.5?65535:16724838}dispose(){this.clearAll(),this.experimentGroup.parent&&this.experimentGroup.parent.remove(this.experimentGroup)}}const u="chocodrop-service-image",g="chocodrop-service-video";class m{constructor(e={}){this.sceneManager=e.sceneManager||null,this.client=e.client||null,this.onControlsToggle=e.onControlsToggle||(()=>{}),this.isVisible=!1,this.container=null,this.input=null,this.output=null,this.currentMode="generate",this.activeConnections=new Map,this.currentTaskId=null,this.config={activationKey:e.activationKey||"@",position:e.position||"bottom-right",width:e.width||450,maxHeight:e.maxHeight||600,theme:e.theme||"dark",skipServiceDialog:!1!==e.skipServiceDialog,showExamples:!1!==e.showExamples,autoScroll:!1!==e.autoScroll,enableDebugLogging:!0===e.enableDebugLogging,enableServerHealthCheck:!1!==e.enableServerHealthCheck,...e.config},this.availableImageServices=[],this.availableVideoServices=[],this.selectedImageService=null,this.selectedVideoService=null,this.imageServiceSelect=null,this.videoServiceSelect=null,this.serviceSelectorContainer=null,this.serviceSelectorStatus=null,this.serviceSelectorContent=null,this.serviceSelectorRetryButton=null,this.serviceSelectorSaveButton=null,this.serviceSelectorCancelButton=null,this.serviceModalOverlay=null,this.serviceModal=null,this.servicesLoading=!1,this.isExpanded=!1,this.overlayTextarea=null,this.pendingImageService=null,this.pendingVideoService=null;try{const e=localStorage.getItem(u),t=localStorage.getItem(g);e&&(this.selectedImageService=e),t&&(this.selectedVideoService=t)}catch(e){console.warn("⚠️ Failed to load stored service selections:",e)}this.pendingImageService=this.selectedImageService,this.pendingVideoService=this.selectedVideoService,this.serverHealthState={available:!0,checking:!1,lastError:null},this.serverHealthBackdrop=null,this.serverHealthModal=null,this.serverHealthMessage=null,this.serverHealthDetail=null,this.serverHealthRetryButton=null,this.mcpNoticeShown=!1,this.applyServiceSelectionToSceneManager(),this.currentTheme=localStorage.getItem("live-command-theme")||"light",this.isDarkMode="dark"===this.currentTheme,this.isWabiSabiMode="wabisabi"===this.currentTheme,this.commandHistory=[],this.currentHistoryIndex=-1,this.maxHistorySize=50,this.initUI(),this.bindEvents(),!this.client&&this.sceneManager&&this.sceneManager.client&&(this.client=this.sceneManager.client),this.initializeServerHealthCheck(),this.createServiceModal(),this.createFloatingChocolateIcon(),document.addEventListener("DOMContentLoaded",()=>{this.refreshStyles()}),this.logDebug("🎮 CommandUI initialized"),this.config.skipServiceDialog||this.selectedImageService&&this.selectedVideoService||this.openServiceModal(!0)}logDebug(...e){this.config.enableDebugLogging&&console.log(...e)}showDemoMessage(){this.showCompactToast("デモページでは利用できません")}showCompactToast(e){const t=document.getElementById("demo-toast");t&&t.remove();const n=this.radioModeContainer;if(!n)return;const i=document.createElement("div");i.id="demo-toast",i.textContent=e,i.style.cssText=`\n      position: absolute;\n      top: -35px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: ${this.isDarkMode?"rgba(139, 92, 246, 0.9)":"rgba(139, 92, 246, 0.85)"};\n      color: white;\n      padding: 6px 12px;\n      border-radius: 6px;\n      font-size: 12px;\n      font-weight: 500;\n      white-space: nowrap;\n      z-index: 1000;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);\n    `,n.style.position="relative",n.appendChild(i),setTimeout(()=>{i.style.opacity="1"},10),setTimeout(()=>{i.parentNode&&(i.style.opacity="0",setTimeout(()=>{i.parentNode&&i.remove()},300))},3e3)}initUI(){this.container=document.createElement("div"),this.container.id="live-command-ui",this.container.style.cssText=this.getContainerStyles();const e=document.createElement("div");e.className="progressive-brand-indicator",e.style.cssText="\n      position: absolute;\n      top: -8px;\n      right: 8px;\n      width: 8px;\n      height: 8px;\n      background: linear-gradient(135deg, #6366f1, #8b5cf6);\n      border-radius: 50%;\n      opacity: 0.7;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      z-index: 10;\n      cursor: pointer;\n    ";const t=document.createElement("div");t.className="progressive-brand-text",t.style.cssText=`\n      position: absolute;\n      top: -35px;\n      right: -5px;\n      padding: 6px 12px;\n      background: rgba(255, 255, 255, 0.15);\n      border: 1px solid ${this.isDarkMode?"rgba(129, 140, 248, 0.3)":"rgba(99, 102, 241, 0.25)"};\n      border-radius: 12px;\n      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);\n      color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937"};\n      font-size: 11px;\n      font-weight: 700;\n      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      letter-spacing: 0.02em;\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      opacity: 0;\n      transform: translateY(5px) scale(0.9);\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      pointer-events: none;\n      z-index: 11;\n      white-space: nowrap;\n    `,t.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">🍫</span> <span style="color: #6366f1;">ChocoDrop</span>',e.addEventListener("mouseenter",()=>{t.style.opacity="1",t.style.transform="translateY(0) scale(1)",e.style.transform="scale(1.2)",e.style.opacity="1"}),e.addEventListener("mouseleave",()=>{t.style.opacity="0",t.style.transform="translateY(5px) scale(0.9)",e.style.transform="scale(1)",e.style.opacity="0.7"}),e.appendChild(t),this.container.appendChild(e),this.output=document.createElement("div"),this.outputDiv=this.output,this.output.id="command-output",this.output.className="command-output",this.output.style.cssText=this.getOutputStyles(),this.floatingContainer=document.createElement("div"),this.floatingContainer.id="floating-cards-container",this.floatingContainer.style.cssText="\n      position: fixed;\n      top: var(--floating-top, 20px);\n      left: 50%;\n      transform: translateX(-50%);\n      z-index: 99999;\n      pointer-events: none;\n      display: none;\n      flex-direction: column-reverse;\n      gap: 8px;\n      width: 400px;\n      max-width: 90vw;\n      align-items: center;\n      justify-content: flex-end;\n    ",this.taskCards=new Map,this.inputWrapper=document.createElement("div"),this.inputWrapper.style.cssText="\n      position: relative;\n      width: 100%;\n      margin-bottom: 0;\n    ",this.input=document.createElement("textarea"),this.input.rows=1,this.input.id="command-input",this.input.placeholder="「右上にドラゴンを」「美しい桜の森を中央に」など... ✨",this.input.style.cssText=this.getInputStyles(),this.expandButton=document.createElement("div"),this.expandButton.innerHTML="⤢",this.expandButton.title="テキスト全体を表示",this.expandButton.style.cssText=`\n      position: absolute;\n      bottom: 8px;\n      right: 8px;\n      width: 24px;\n      height: 24px;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"};\n      border: 1px solid ${this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)"};\n      border-radius: 6px;\n      color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937"};\n      font-size: 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      z-index: 1;\n    `,this.expandButton.addEventListener("mouseenter",()=>{this.expandButton.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)",this.expandButton.style.transform="scale(1.1)"}),this.expandButton.addEventListener("mouseleave",()=>{this.expandButton.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",this.expandButton.style.transform="scale(1)"}),this.expandButton.addEventListener("click",()=>{this.isExpanded?this.hideOverlayTextarea():this.showOverlayTextarea()}),this.inputWrapper.appendChild(this.input),this.inputWrapper.appendChild(this.expandButton);const n=this.createRadioModeSelector(),i=this.createMinimalActions(),o=document.createElement("div");o.innerHTML="×",o.style.cssText=`\n      position: absolute;\n      top: 12px;\n      right: 12px;\n      width: 22px;\n      height: 22px;\n      border-radius: 50%;\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"};\n      color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937"};\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: normal;\n      transition: all 0.2s ease;\n      backdrop-filter: blur(8px);\n      z-index: 10;\n    `,o.addEventListener("mouseover",()=>{o.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)",o.style.transform="scale(1.1)"}),o.addEventListener("mouseout",()=>{o.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",o.style.color=this.isDarkMode?"#ffffff":"#1f2937",o.style.transform="scale(1)"}),o.addEventListener("click",()=>{this.hide()}),this.container.appendChild(o),this.container.appendChild(n),this.container.appendChild(this.inputWrapper),this.container.appendChild(i),document.body.appendChild(this.floatingContainer),document.body.appendChild(this.container),this.applyTheme(),this.isComposing=!1,this.hasCompositionJustEnded=!1,this.input.addEventListener("input",()=>{this.isComposing||(this.autoResizeTextarea(),this.detectCommandType())}),this.input.addEventListener("compositionstart",()=>{this.isComposing=!0}),this.input.addEventListener("compositionend",()=>{this.isComposing=!1;/Safari/.test(navigator.userAgent)&&/Version/.test(navigator.userAgent)&&(this.hasCompositionJustEnded=!0),setTimeout(()=>{this.autoResizeTextarea(),this.detectCommandType()},10)});const r=/Safari/.test(navigator.userAgent)&&/Version/.test(navigator.userAgent);this.input.addEventListener("keydown",e=>{if("Enter"===e.key){if(r&&this.hasCompositionJustEnded)return void(this.hasCompositionJustEnded=!1);if(!r&&(e.isComposing||this.isComposing))return;if("generate"===this.currentMode)return e.preventDefault(),void this.showDemoMessage();e.preventDefault(),this.executeCommand()}}),this.config.showExamples}createMinimalActions(){const e=document.createElement("div");e.style.cssText="\n      display: flex;\n      margin-top: 8px;\n      margin-bottom: 0 !important;\n      gap: 8px;\n      justify-content: space-between;\n      align-items: center;\n    ";const t=document.createElement("div");t.style.cssText="display: flex; gap: 8px; align-items: center;";const n=document.createElement("button");n.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.7) brightness(0.9);">🧹</span> Clear All',n.style.cssText=this.getActionButtonStyles("secondary"),n.addEventListener("click",()=>this.clearAllWithConfirmation());const i=document.createElement("button");i.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.7) brightness(0.9);">📚</span> History',i.style.cssText=this.getActionButtonStyles("secondary"),i.style.opacity="0.5",i.disabled=!0,i.title="履歴機能（開発中）",t.appendChild(n),t.appendChild(i);const o=document.createElement("div");o.style.cssText="display: flex; gap: 6px; align-items: center;";const r=document.createElement("button"),a=()=>({light:"🌙",dark:"🍵",wabisabi:"☀️"}[this.currentTheme]||"🌙");r.innerHTML=(()=>{const e=a();return"☀️"===e?`<span style="filter: saturate(1.2) brightness(1.1);">${e}</span>`:"🍵"===e?`<span style="filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);">${e}</span>`:`<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">${e}</span>`})(),r.style.cssText=this.getActionButtonStyles("icon"),r.title=(()=>({light:"ダークモードに切り替え",dark:"侘び寂びモードに切り替え",wabisabi:"ライトモードに切り替え"}[this.currentTheme]||"ダークモードに切り替え"))(),r.addEventListener("click",()=>this.toggleTheme());const s=document.createElement("button");return s.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">⚙️</span>',s.style.cssText=this.getActionButtonStyles("icon"),s.title="サービス設定を開く",s.addEventListener("click",()=>this.openServiceModal()),o.appendChild(r),o.appendChild(s),e.appendChild(t),e.appendChild(o),this.clearBtn=n,this.historyBtn=i,this.themeToggle=r,this.settingsButton=s,e}createServiceSelectorSection(){return this.serviceSelectorContainer=document.createElement("div"),this.serviceSelectorContainer.id="service-selector",this.serviceSelectorContainer.style.cssText="\n      margin-bottom: 16px;\n      padding: 12px;\n      border-radius: 12px;\n      border: 1px solid transparent;\n      transition: background 0.3s ease, border 0.3s ease;\n    ",this.serviceSelectorStatus=document.createElement("div"),this.serviceSelectorStatus.textContent="サービス情報を読み込んでいます...",this.serviceSelectorStatus.style.fontSize="12px",this.serviceSelectorStatus.style.opacity="0.8",this.serviceSelectorStatus.style.marginBottom="8px",this.serviceSelectorContainer.appendChild(this.serviceSelectorStatus),this.serviceSelectorContent=document.createElement("div"),this.serviceSelectorContainer.appendChild(this.serviceSelectorContent),this.updateServiceSelectorTheme(),this.serviceSelectorContainer}createServiceModal(){this.serviceModalOverlay&&(this.serviceModalOverlay.remove(),this.serviceModalOverlay=null,this.serviceModal=null),this.serviceModalOverlay=document.createElement("div"),this.serviceModalOverlay.id="chocodrop-service-modal-overlay",this.serviceModalOverlay.style.cssText="\n      position: fixed;\n      inset: 0;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      backdrop-filter: blur(18px);\n      -webkit-backdrop-filter: blur(18px);\n      z-index: 2000;\n      padding: 16px !important;\n      opacity: 0;\n      transition: opacity 0.2s ease;\n    ",this.serviceModalOverlay.addEventListener("click",e=>{e.target===this.serviceModalOverlay&&this.closeServiceModal()}),this.serviceModal=document.createElement("div"),this.serviceModal.className="chocodrop-service-modal",this.serviceModal.style.cssText="\n      width: min(420px, 90vw);\n      border-radius: 24px;\n      padding: 26px 28px;\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);\n      display: flex;\n      flex-direction: column;\n      gap: 18px;\n      max-height: 90vh;\n      overflow-y: auto;\n      position: relative;\n    ";const e=document.createElement("h2");e.textContent="サービス設定",e.style.cssText="\n      margin: 0;\n      font-size: 18px;\n      font-weight: 700;\n      letter-spacing: 0.03em;\n    ";const t=document.createElement("p");t.textContent="利用するサービスを選択してください。",t.style.cssText="\n      margin: 0;\n      font-size: 12px;\n      opacity: 0.75;\n    ";const n=this.createServiceSelectorSection(),i=document.createElement("div");i.style.cssText="\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      gap: 16px;\n    ",this.serviceSelectorRetryButton=document.createElement("button"),this.serviceSelectorRetryButton.textContent="再読み込み",this.serviceSelectorRetryButton.style.cssText="\n      font-size: 11px;\n      padding: 6px 14px;\n      border-radius: 10px;\n      border: 1px solid transparent;\n      cursor: pointer;\n      display: none;\n      transition: all 0.2s ease;\n    ",this.serviceSelectorRetryButton.addEventListener("click",()=>this.initializeServiceSelector(!0));const o=document.createElement("div");o.style.cssText="display: flex; gap: 8px;",this.serviceSelectorCancelButton=document.createElement("button"),this.serviceSelectorCancelButton.textContent="Cancel",this.serviceSelectorCancelButton.style.cssText="\n      font-size: 12px;\n      padding: 8px 16px;\n      border-radius: 10px;\n      border: 1px solid rgba(255, 255, 255, 0.35);\n      background: transparent;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    ",this.serviceSelectorCancelButton.addEventListener("click",()=>this.closeServiceModal()),this.serviceSelectorSaveButton=document.createElement("button"),this.serviceSelectorSaveButton.textContent="Save",this.serviceSelectorSaveButton.style.cssText="\n      font-size: 12px;\n      padding: 8px 18px;\n      border-radius: 10px;\n      border: none;\n      cursor: pointer;\n      background: linear-gradient(135deg, #6366f1, #8b5cf6);\n      color: white;\n      font-weight: 600;\n      transition: all 0.2s ease;\n      box-shadow: 0 12px 24px rgba(99, 102, 241, 0.35);\n    ",this.serviceSelectorSaveButton.addEventListener("click",()=>this.handleServiceSave()),o.appendChild(this.serviceSelectorCancelButton),o.appendChild(this.serviceSelectorSaveButton),i.appendChild(this.serviceSelectorRetryButton),i.appendChild(o),this.serviceModal.appendChild(e),this.serviceModal.appendChild(t),this.serviceModal.appendChild(n),this.serviceModal.appendChild(i),this.serviceModalOverlay.appendChild(this.serviceModal),document.body.appendChild(this.serviceModalOverlay),this.updateServiceSelectorTheme(),this.toggleServiceRetryButton(!1)}openServiceModal(e=!1){this.serviceModalOverlay||this.createServiceModal(),this.serviceModalOverlay.style.display="flex",requestAnimationFrame(()=>{this.serviceModalOverlay&&(this.serviceModalOverlay.style.opacity="1")}),this.resetPendingSelections(),this.initializeServiceSelector(e)}closeServiceModal(){this.serviceModalOverlay&&(this.serviceModalOverlay.style.opacity="0",setTimeout(()=>{this.serviceModalOverlay&&(this.serviceModalOverlay.style.display="none"),this.resetPendingSelections()},150))}async initializeServiceSelector(e=!1){if(!this.servicesLoading||e){if(!this.client||"function"!=typeof this.client.getAvailableServices)return this.setServiceSelectorStatus("サービス情報を取得できませんでした（クライアント初期化待ちです）。右下の「再読み込み」で再取得できます。","error"),this.toggleServiceRetryButton(!0),void this.setServiceButtonsEnabled(!1);this.servicesLoading=!0,this.setServiceSelectorStatus("サービス情報を読み込んでいます...","info"),this.toggleServiceRetryButton(!1),this.setServiceButtonsEnabled(!1);try{"function"==typeof this.client.ensureInitialized&&await this.client.ensureInitialized();const e=await this.client.getAvailableServices();if(!e||!1===e.success||!e.metadata)throw new Error(e?.error||"サービス情報が取得できませんでした");this.availableImageServices=Array.isArray(e.metadata?.image)?e.metadata.image:[],this.availableVideoServices=Array.isArray(e.metadata?.video)?e.metadata.video:[],this.selectedImageService=this.resolveServiceSelection("image",this.availableImageServices,e.default?.image),this.selectedVideoService=this.resolveServiceSelection("video",this.availableVideoServices,e.default?.video),this.pendingImageService=this.selectedImageService,this.pendingVideoService=this.selectedVideoService,this.populateServiceSelector(),this.applyServiceSelectionToSceneManager(),this.setServiceButtonsEnabled(!0)}catch(e){console.error("❌ Failed to initialize service selector:",e),this.setServiceSelectorStatus("サービス情報を取得できませんでした。サーバーが起動しているか確認のうえ、再読み込みしてください。","error"),this.toggleServiceRetryButton(!0),this.setServiceButtonsEnabled(!1)}finally{this.servicesLoading=!1}}}setServiceSelectorStatus(e,t="info"){this.serviceSelectorStatus&&(this.serviceSelectorStatus.textContent=e,this.serviceSelectorStatus.dataset.statusType=t,this.serviceSelectorStatus.classList.toggle("service-selector-helper","error"!==t),this.updateServiceSelectorTheme())}toggleServiceRetryButton(e){this.serviceSelectorRetryButton&&(this.serviceSelectorRetryButton.style.display=e?"inline-flex":"none",this.updateServiceSelectorTheme())}resolveServiceSelection(e,t,n){if(!t||0===t.length)return null;const i="image"===e?u:g;let o=null;try{o=localStorage.getItem(i)}catch(e){console.warn("⚠️ Failed to access localStorage:",e)}let r=o&&t.some(e=>e.id===o)?o:null;!r&&n&&t.some(e=>e.id===n)&&(r=n),r||(r=t[0]?.id||null);try{r?localStorage.setItem(i,r):localStorage.removeItem(i)}catch(e){console.warn("⚠️ Failed to persist service selection:",e)}return r}populateServiceSelector(){if(!this.serviceSelectorContent)return;this.serviceSelectorContent.innerHTML="";const e=this.availableImageServices.length>0,t=this.availableVideoServices.length>0;if(e||t){if(this.setServiceSelectorStatus("利用するサービスを選択してください。","info"),e){const e=this.buildServiceRow("image","画像 (T2I)",this.availableImageServices,this.pendingImageService||this.selectedImageService);this.serviceSelectorContent.appendChild(e)}if(t){const e=this.buildServiceRow("video","動画 (T2V)",this.availableVideoServices,this.pendingVideoService||this.selectedVideoService);this.serviceSelectorContent.appendChild(e)}this.updateServiceSelectorTheme()}else this.setServiceSelectorStatus("利用可能なサービスが見つかりませんでした。","error")}buildServiceRow(e,t,n,i){const o=document.createElement("div");o.className=`service-row service-row-${e}`,o.style.cssText="\n      display: flex;\n      flex-direction: column;\n      gap: 6px;\n      margin-bottom: 12px;\n    ";const r=document.createElement("label");r.textContent=t,r.style.fontSize="13px",r.style.fontWeight="600",o.appendChild(r);const a=document.createElement("select");a.dataset.serviceType=e,a.style.fontFamily="inherit",a.style.width="100%",n.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name||e.id,e.description&&(t.title=e.description),a.appendChild(t)}),i&&n.some(e=>e.id===i)&&(a.value=i),a.addEventListener("change",t=>{this.onServiceSelectionChange(e,t.target.value)}),o.appendChild(a);const s=document.createElement("div");return s.className="service-description",s.textContent=this.findServiceInfo(e,a.value)?.description||"",s.style.fontSize="11px",s.style.opacity="0.75",s.style.lineHeight="1.4",s.style.minHeight="14px",o.appendChild(s),a.addEventListener("change",()=>{s.textContent=this.findServiceInfo(e,a.value)?.description||""}),"image"===e?this.imageServiceSelect=a:this.videoServiceSelect=a,o}onServiceSelectionChange(e,t){"image"===e?this.pendingImageService=t:this.pendingVideoService=t;const n=this.findServiceInfo(e,t),i="image"===e?this.imageServiceSelect?.parentElement?.querySelector(".service-description"):this.videoServiceSelect?.parentElement?.querySelector(".service-description");i&&(i.textContent=n?.description||"")}handleServiceSave(){const e=this.pendingImageService||this.selectedImageService,t=this.pendingVideoService||this.selectedVideoService;if(e){try{localStorage.setItem(u,e)}catch(e){console.warn("⚠️ Failed to persist image service selection:",e)}this.selectedImageService=e,this.sceneManager?.setImageService(e)}if(t){try{localStorage.setItem(g,t)}catch(e){console.warn("⚠️ Failed to persist video service selection:",e)}this.selectedVideoService=t,this.sceneManager?.setVideoService(t)}const n=this.findServiceInfo("image",e),i=this.findServiceInfo("video",t);n&&this.addOutput(`🖼️ 画像サービスを「${n.name}」に設定しました`,"system"),i&&this.addOutput(`🎬 動画サービスを「${i.name}」に設定しました`,"system"),this.closeServiceModal()}setServiceButtonsEnabled(e){this.serviceSelectorSaveButton&&(this.serviceSelectorSaveButton.disabled=!e,this.serviceSelectorSaveButton.style.opacity=e?"1":"0.6",this.serviceSelectorSaveButton.style.cursor=e?"pointer":"not-allowed")}resetPendingSelections(){this.pendingImageService=this.selectedImageService,this.pendingVideoService=this.selectedVideoService,this.imageServiceSelect&&this.selectedImageService&&(this.imageServiceSelect.value=this.selectedImageService),this.videoServiceSelect&&this.selectedVideoService&&(this.videoServiceSelect.value=this.selectedVideoService),this.serviceSelectorContent&&this.serviceSelectorContent.childElementCount>0&&this.populateServiceSelector()}findServiceInfo(e,t){return("image"===e?this.availableImageServices:this.availableVideoServices).find(e=>e.id===t)||null}applyServiceSelectionToSceneManager(){this.sceneManager&&(this.sceneManager.setImageService(this.selectedImageService),this.sceneManager.setVideoService(this.selectedVideoService))}updateServiceSelectorTheme(){if(this.serviceModalOverlay&&(this.serviceModalOverlay.style.background=this.isDarkMode?"rgba(8, 11, 26, 0.55)":"rgba(229, 231, 255, 0.45)"),this.serviceModal&&(this.serviceModal.style.background=this.isDarkMode?"rgba(17, 24, 39, 0.15)":"rgba(255, 255, 255, 0.15)",this.serviceModal.style.border=this.isDarkMode?"1px solid rgba(129, 140, 248, 0.4)":"1px solid rgba(99, 102, 241, 0.25)",this.serviceModal.style.color=this.isDarkMode?"#e5e7ff":"#1f2937"),this.serviceSelectorStatus){const e=this.serviceSelectorStatus.dataset?.statusType,t="error"===e?this.isDarkMode?"#fca5a5":"#b91c1c":this.isDarkMode?"rgba(209, 213, 219, 0.8)":"rgba(55, 65, 81, 0.75)";this.serviceSelectorStatus.style.color=t}if(this.serviceSelectorContainer){this.serviceSelectorContainer.querySelectorAll("label").forEach(e=>{e.style.color=this.isDarkMode?"rgba(255, 255, 255, 0.9)":"rgba(31, 41, 55, 0.9)"});this.serviceSelectorContainer.querySelectorAll("select").forEach(e=>{e.style.background=this.isDarkMode?"rgba(99, 102, 241, 0.18)":"rgba(99, 102, 241, 0.12)",e.style.border=this.isDarkMode?"1px solid rgba(129, 140, 248, 0.45)":"1px solid rgba(99, 102, 241, 0.45)",e.style.color=this.isDarkMode?"#ffffff":"#1f2937",e.style.padding="10px 12px",e.style.borderRadius="10px",e.style.fontSize="13px",e.style.outline="none",e.style.boxShadow=this.isDarkMode?"0 12px 28px rgba(15, 23, 42, 0.5)":"0 12px 24px rgba(99, 102, 241, 0.2)"});this.serviceSelectorContainer.querySelectorAll(".service-description").forEach(e=>{e.style.color=this.isDarkMode?"rgba(209, 213, 219, 0.8)":"rgba(55, 65, 81, 0.7)"})}this.serviceSelectorRetryButton&&(this.serviceSelectorRetryButton.style.background=this.isDarkMode?"rgba(129, 140, 248, 0.35)":"rgba(99, 102, 241, 0.15)",this.serviceSelectorRetryButton.style.border=this.isDarkMode?"1px solid rgba(129, 140, 248, 0.5)":"1px solid rgba(99, 102, 241, 0.45)",this.serviceSelectorRetryButton.style.color=this.isDarkMode?"#f9fafb":"#1e1b4b",this.serviceSelectorRetryButton.style.boxShadow=this.isDarkMode?"0 0 8px rgba(129, 140, 248, 0.45)":"0 0 8px rgba(99, 102, 241, 0.35)"),this.serviceSelectorCancelButton&&(this.serviceSelectorCancelButton.style.border=this.isDarkMode?"1px solid rgba(209, 213, 219, 0.3)":"1px solid rgba(148, 163, 184, 0.5)",this.serviceSelectorCancelButton.style.color=this.isDarkMode?"rgba(226, 232, 240, 0.85)":"rgba(30, 41, 59, 0.85)"),this.serviceSelectorSaveButton&&(this.serviceSelectorSaveButton.style.background=this.isDarkMode?"linear-gradient(135deg, #6366f1, #8b5cf6)":"linear-gradient(135deg, #818cf8, #a855f7)",this.serviceSelectorSaveButton.style.boxShadow=this.isDarkMode?"0 16px 28px rgba(99, 102, 241, 0.4)":"0 16px 28px rgba(129, 140, 248, 0.35)")}createRadioModeSelector(){const e=document.createElement("div");e.className="radio-mode-selector",e.style.cssText=`\n      display: grid;\n      grid-template-columns: repeat(4, 1fr);\n      gap: 8px;\n      margin-bottom: 12px;\n      padding: 12px;\n      background: ${this.isWabiSabiMode?"linear-gradient(135deg, rgba(158, 158, 158, 0.25), rgba(189, 189, 189, 0.2))":this.isDarkMode?"linear-gradient(135deg, rgba(30, 27, 75, 0.3), rgba(15, 23, 42, 0.4))":"linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1))"};\n      border: 1px solid ${this.isWabiSabiMode?"rgba(141, 110, 99, 0.4)":this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(255, 255, 255, 0.25)"};\n      border-radius: 16px;\n      backdrop-filter: blur(12px);\n      transition: all 0.3s ease;\n      position: relative;\n    `;return this.radioModeButtons={},[{value:"generate",label:"Generate",icon:"🚫",disabled:!0},{value:"import",label:"Import",icon:"📥"},{value:"modify",label:"Modify",icon:"🔧"},{value:"delete",label:"Delete",icon:"🗑️"}].forEach(t=>{const n=document.createElement("div");n.className=`mode-option ${t.value}`,n.style.cssText=`\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 4px;\n        padding: 10px 8px;\n        border-radius: 12px;\n        cursor: ${t.disabled?"not-allowed":"pointer"};\n        transition: all 0.2s ease;\n        font-size: 11px;\n        font-weight: 600;\n        text-align: center;\n        color: ${t.disabled?"rgba(139, 92, 246, 0.6)":this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(55, 65, 81, 0.8)"};\n        background: transparent;\n        border: 1px solid transparent;\n        position: relative;\n        opacity: ${t.disabled?"0.6":"1"};\n      `;const i=document.createElement("div");i.textContent=t.icon,i.style.cssText=`\n        font-size: 16px;\n        margin-bottom: 2px;\n        filter: ${t.disabled?"hue-rotate(240deg) saturate(0.8) brightness(1.1)":this.isDarkMode?"hue-rotate(220deg) saturate(0.8) brightness(1.2)":"hue-rotate(240deg) saturate(0.7) brightness(0.9)"};\n        transition: filter 0.2s ease;\n      `;const o=document.createElement("span");o.textContent=t.label;const r=document.createElement("div");r.className="auto-badge",r.textContent="AUTO",r.style.cssText="\n        position: absolute;\n        top: -4px;\n        right: -4px;\n        font-size: 7px;\n        font-weight: 700;\n        padding: 2px 4px;\n        background: linear-gradient(135deg, #10b981, #059669);\n        color: white;\n        border-radius: 6px;\n        opacity: 0;\n        transform: scale(0.8);\n        transition: all 0.2s ease;\n        display: none;\n      ",n.appendChild(i),n.appendChild(o),n.appendChild(r),t.disabled?n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showDemoMessage()}):n.addEventListener("click",()=>{"import"===t.value?this.triggerFileSelection():this.selectMode(t.value,!0)}),this.radioModeButtons[t.value]={button:n,autoBadge:r},e.appendChild(n)}),this.radioModeContainer=e,this.selectMode("import",!1),e}selectMode(e,t=!1,n=null){this.currentMode=e,Object.keys(this.radioModeButtons).forEach(e=>{const{button:t,autoBadge:n}=this.radioModeButtons[e];t.style.color=this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(55, 65, 81, 0.8)",t.style.background="transparent",t.style.border="1px solid transparent",t.style.transform="scale(1)",t.style.boxShadow="none",n.style.display="none",n.style.opacity="0"});const{button:i,autoBadge:o}=this.radioModeButtons[e],r=this.isWabiSabiMode?{background:"linear-gradient(135deg, rgba(109, 76, 65, 0.2), rgba(141, 110, 99, 0.15))",border:"1px solid rgba(109, 76, 65, 0.4)",boxShadow:"0 4px 16px rgba(109, 76, 65, 0.25), inset 0 1px 0 rgba(245, 245, 220, 0.15)",color:"#F5F5F5"}:this.isDarkMode?{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15))",border:"1px solid rgba(99, 102, 241, 0.4)",boxShadow:"0 4px 16px rgba(99, 102, 241, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1)",color:"#a5b4fc"}:{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.08))",border:"1px solid rgba(99, 102, 241, 0.3)",boxShadow:"0 4px 16px rgba(99, 102, 241, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2)",color:"#6366f1"};i.style.color=r.color,i.style.background=r.background,i.style.border=r.border,i.style.boxShadow=r.boxShadow,i.style.transform="scale(1.02)",!t&&n&&(o.style.display="inline-block",setTimeout(()=>{o.style.opacity="1",o.style.transform="scale(1)"},100),setTimeout(()=>{o.style.opacity="0",o.style.transform="scale(0.8)",setTimeout(()=>{o.style.display="none"},200)},3e3)),t||(this.addPulseEffect(i),this.addContainerGlow(e)),this.input.placeholder=this.getPlaceholderForMode(e),t&&this.clearInputOnModeSwitch(e),"import"===e||this.selectedFile?this.showImportInterface():this.hideImportInterface(),"delete"===e&&t&&this.handleDeleteModeSelection(),"modify"===e&&t&&this.handleModifyModeSelection()}addPulseEffect(e){e.style.animation="none",setTimeout(()=>{e.style.animation="smartModePulse 0.6s ease-out"},10),setTimeout(()=>{e.style.animation=""},610),this.ensurePulseAnimation()}ensurePulseAnimation(){if(document.getElementById("smart-mode-pulse-animation"))return;const e=document.createElement("style");e.id="smart-mode-pulse-animation",e.textContent="\n      @keyframes smartModePulse {\n        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }\n        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }\n        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }\n      }\n    ",document.head.appendChild(e)}addContainerGlow(e){const t=this.radioModeContainer;if(!t)return;const n=(this.isWabiSabiMode?{generate:"rgba(139, 195, 74, 0.4)",import:"rgba(139, 195, 74, 0.4)",modify:"rgba(139, 195, 74, 0.4)",delete:"rgba(139, 195, 74, 0.4)"}:{generate:"rgba(79, 70, 229, 0.4)",import:"rgba(34, 197, 94, 0.4)",modify:"rgba(236, 72, 153, 0.4)",delete:"rgba(107, 114, 128, 0.3)"})[e];n&&(t.style.boxShadow=`0 0 20px ${n}, 0 0 40px ${n}`,t.style.borderColor=n.replace("0.4","0.6").replace("0.3","0.5")),setTimeout(()=>{t.style.boxShadow="",t.style.borderColor=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.15)"},1e3)}getActionButtonStyles(e="secondary"){const t="\n      border: none;\n      border-radius: 10px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n      font-weight: 500;\n      backdrop-filter: blur(8px);\n      -webkit-backdrop-filter: blur(8px);\n    ";return"secondary"===e?t+`\n        width: 90px;\n        height: 36px;\n        padding: 8px 12px;\n        font-size: 12px;\n        font-weight: 600;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n        background: ${this.isWabiSabiMode?"linear-gradient(135deg, rgba(141, 110, 99, 0.3), rgba(109, 76, 65, 0.2))":this.isDarkMode?"linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2))":"linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))"};\n        border: 1px solid ${this.isWabiSabiMode?"rgba(93, 64, 55, 0.6)":this.isDarkMode?"rgba(156, 163, 175, 0.2)":"rgba(255, 255, 255, 0.3)"};\n        color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#d1d5db":"#374151"};\n        text-align: center;\n        white-space: nowrap;\n      `:"icon"===e?t+`\n        width: 32px;\n        height: 32px;\n        padding: 0;\n        font-size: 14px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: ${this.isDarkMode?"linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1))":"linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))"};\n        border: 1px solid ${this.isDarkMode?"rgba(99, 102, 241, 0.2)":"rgba(255, 255, 255, 0.4)"};\n        color: ${this.isDarkMode?"#a5b4fc":"#6366f1"};\n      `:void 0}getDestructiveButtonStyles(){return`\n      min-width: 50px;\n      height: 32px;\n      border: 1px solid ${this.isDarkMode?"rgba(220, 38, 127, 0.4)":"rgba(190, 24, 93, 0.35)"};\n      border-radius: 6px;\n      background: ${this.isDarkMode?"rgba(220, 38, 127, 0.3)":"rgba(190, 24, 93, 0.25)"};\n      color: ${this.isDarkMode?"#fca5a5":"#dc2626"};\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n      font-size: 11px;\n      font-weight: 500;\n      padding: 0 8px;\n      backdrop-filter: blur(10px);\n      -webkit-backdrop-filter: blur(10px);\n    `}getCommandTypeIndicatorStyles(){return`\n      padding: 4px 0;\n      margin-bottom: 0;\n      font-size: 11px;\n      font-weight: 400;\n      text-align: left;\n      color: ${this.isDarkMode?"rgba(255, 255, 255, 0.6)":"rgba(0, 0, 0, 0.6)"};\n      transition: all 0.3s ease;\n      border: none;\n      background: none;\n    `}autoResizeTextarea(){this.input.style.height="auto";const e=Math.min(this.input.scrollHeight,72);this.input.style.height=e+"px",this.input.scrollHeight>72?(this.input.style.overflowY="auto",this.expandButton&&(this.expandButton.style.display="flex")):(this.input.style.overflowY="hidden",this.expandButton&&(this.expandButton.style.display="none"))}detectCommandType(){const e=this.input.value.trim();if(!e)return void this.selectMode("generate",!1);const t=this.analyzeCommandType(e);"delete"!==this.currentMode&&"modify"!==this.currentMode&&this.selectMode(t.type,!1,t.detectedKeyword)}analyzeCommandType(e){this.logDebug(`🔍 Analyzing command: "${e}"`);const t=this.detectMediaType(e),n=[{pattern:/削除/,keyword:"削除"},{pattern:/消去/,keyword:"消去"},{pattern:/消して/,keyword:"消して"},{pattern:/消す/,keyword:"消す"},{pattern:/取り除/,keyword:"取り除"},{pattern:/除去/,keyword:"除去"},{pattern:/削除して/,keyword:"削除して"},{pattern:/delete/i,keyword:"delete"},{pattern:/remove/i,keyword:"remove"},{pattern:/clear/i,keyword:"clear"},{pattern:/erase/i,keyword:"erase"}],i=[{pattern:/移動/,keyword:"移動"},{pattern:/動かして/,keyword:"動かして"},{pattern:/変更/,keyword:"変更"},{pattern:/変えて/,keyword:"変えて"},{pattern:/修正/,keyword:"修正"},{pattern:/調整/,keyword:"調整"},{pattern:/回転/,keyword:"回転"},{pattern:/反転/,keyword:"反転"},{pattern:/ミラー/,keyword:"ミラー"},{pattern:/傾け/,keyword:"傾け"},{pattern:/向きを変え/,keyword:"向きを変え"},{pattern:/向きを変更/,keyword:"向きを変更"},{pattern:/左右(逆|反転)/,keyword:"左右反転"},{pattern:/上下(逆|反転)/,keyword:"上下反転"},{pattern:/逆さ/,keyword:"逆さ"},{pattern:/ひっくり返/,keyword:"ひっくり返す"},{pattern:/.*を.*色/,keyword:"色変更"},{pattern:/.*を.*サイズ/,keyword:"サイズ変更"},{pattern:/を.*に.*して/,keyword:"変更"},{pattern:/move/i,keyword:"move"},{pattern:/change/i,keyword:"change"},{pattern:/modify/i,keyword:"modify"},{pattern:/edit/i,keyword:"edit"}],o=[{pattern:/作って/,keyword:"作って"},{pattern:/生成/,keyword:"生成"},{pattern:/作成/,keyword:"作成"},{pattern:/描いて/,keyword:"描いて"},{pattern:/書いて/,keyword:"書いて"},{pattern:/create/i,keyword:"create"},{pattern:/generate/i,keyword:"generate"},{pattern:/make/i,keyword:"make"},{pattern:/draw/i,keyword:"draw"}];for(const{pattern:i,keyword:o}of n)if(i.test(e))return this.logDebug(`✅ Delete pattern matched: ${o}`),{type:"delete",confidence:.9,reason:"削除キーワードを検出",mediaType:t.type,requiresConfirmation:!0,detectedKeyword:o};for(const{pattern:n,keyword:o}of i)if(n.test(e))return this.logDebug(`✅ Modify pattern matched: ${o}`),{type:"modify",confidence:.8,reason:"変更キーワードを検出",mediaType:t.type,requiresConfirmation:!1,detectedKeyword:o};for(const{pattern:n,keyword:i}of o)if(n.test(e))return{type:"generate",confidence:t.confidence,reason:t.reason,mediaType:t.type,requiresConfirmation:!1,detectedKeyword:i};return this.logDebug("ℹ️ No specific pattern matched, defaulting to generate mode"),{type:"generate",confidence:t.confidence,reason:t.reason,mediaType:t.type,requiresConfirmation:!1,detectedKeyword:null}}detectMediaType(e){return[/動画|ビデオ|映像|ムービー/,/video|movie|clip/i].some(t=>t.test(e))?{type:"video",confidence:.8,reason:"動画生成コマンド"}:[/画像|写真|絵|イラスト|イメージ/,/image|picture|photo|illustration/i].some(t=>t.test(e))?{type:"image",confidence:.8,reason:"画像生成コマンド"}:{type:"image",confidence:.6,reason:"生成コマンド（画像デフォルト）"}}showCommandTypeIndicator(e){const{type:t,confidence:n,reason:i}=e;n<.7?this.showProactiveSuggestion(t,n):this.hideProactiveSuggestion(),this.enableGestureControl()}showProactiveSuggestion(e,t){this.proactiveSuggestion||(this.proactiveSuggestion=document.createElement("div"),this.proactiveSuggestion.id="proactive-suggestion",this.proactiveSuggestion.style.cssText="\n        margin-bottom: 0;\n        padding: 10px;\n        background: rgba(255, 193, 7, 0.15);\n        border: 1px solid rgba(255, 193, 7, 0.3);\n        border-radius: 8px;\n        font-size: 12px;\n        color: #ffc107;\n        text-align: center;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      ",this.container.insertBefore(this.proactiveSuggestion,this.input));const n=["generate","modify","delete"].filter(t=>t!==e)[0];this.proactiveSuggestion.innerHTML=`\n      💡 もしかして「${{generate:"🎨 生成",modify:"✏️ 変更",delete:"🗑️ 削除"}[n]}モード」ですか？\n      <div style="margin-top: 4px; font-size: 10px; opacity: 0.8;">\n        クリックで変更 | スワイプで選択\n      </div>\n    `,this.proactiveSuggestion.style.display="block",this.proactiveSuggestion.onclick=()=>{this.currentMode=n,this.hideProactiveSuggestion(),this.updateIndicatorForMode(n,.9)}}hideProactiveSuggestion(){this.proactiveSuggestion&&(this.proactiveSuggestion.style.display="none")}updateIndicatorForMode(e,t){}enableGestureControl(){this.gestureEnabled=!0}createActionButtons(){const e=document.createElement("div");e.style.cssText="\n      display: flex;\n      margin-top: 8px;\n      gap: 8px;\n    ";const t=document.createElement("button");return t.innerHTML="🧹 全削除",t.style.cssText=this.getModernButtonStyles("danger"),t.addEventListener("click",()=>this.clearAll()),e.appendChild(t),e}getContainerStyles(){const e={"bottom-right":"bottom: 20px; right: 20px;","bottom-left":"bottom: 20px; left: 20px;","top-right":"top: 20px; right: 20px;","top-left":"top: 20px; left: 20px;",center:"top: 50%; left: 50%; transform: translate(-50%, -50%);"},t=this.isWabiSabiMode?{background:"linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))",backdropFilter:"blur(20px) saturate(120%)",border:"1px solid rgba(93, 64, 55, 0.5)",boxShadow:"0 8px 32px rgba(33, 33, 33, 0.4), 0 0 0 1px rgba(93, 64, 55, 0.4), inset 0 1px 0 rgba(189, 189, 189, 0.15)"}:this.isDarkMode?{background:"linear-gradient(135deg, rgba(15, 23, 42, 0.7), rgba(30, 27, 75, 0.65))",backdropFilter:"blur(24px) saturate(180%)",border:"1px solid rgba(99, 102, 241, 0.2)",boxShadow:"0 8px 32px rgba(15, 23, 42, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1)"}:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))",backdropFilter:"blur(24px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.4)",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3)"};return`\n      position: fixed;\n      ${e[this.config.position]||e["bottom-right"]}\n      width: 320px;\n      max-height: ${this.config.maxHeight}px;\n      background: ${t.background};\n      border: ${t.border};\n      border-radius: 20px;\n      color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937"};\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;\n      font-size: 14px;\n      z-index: 1000;\n      padding: 16px !important;\n      box-shadow: ${t.boxShadow};\n      backdrop-filter: ${t.backdropFilter};\n      -webkit-backdrop-filter: ${t.backdropFilter};\n      display: none;\n      flex-direction: column;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    `}getHeaderStyles(){return"\n      margin-bottom: 20px;\n      text-align: center;\n      background: linear-gradient(135deg, #4f46e5, #7c3aed);\n      -webkit-background-clip: text;\n      -webkit-text-fill-color: transparent;\n      background-clip: text;\n      font-weight: 800;\n      font-size: 18px;\n      border-bottom: 1px solid rgba(79, 70, 229, 0.2);\n      padding-bottom: 12px;\n    "}getOutputStyles(){return this.addScrollbarStyles(),`\n      height: 200px;\n      overflow-y: auto;\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.05)":"rgba(255, 255, 255, 0.1)"};\n      border: 1px solid ${this.isDarkMode?"rgba(255, 255, 255, 0.15)":"rgba(255, 255, 255, 0.2)"};\n      border-radius: 12px;\n      padding: 12px;\n      margin-bottom: 16px;\n      font-size: 12px;\n      line-height: 1.4;\n      backdrop-filter: blur(8px);\n\n      /* カスタムスクロールバーのスタイル */\n      scrollbar-width: thin;\n      scrollbar-color: ${this.isDarkMode?"rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.3) rgba(0, 0, 0, 0.1)"};\n    `}addScrollbarStyles(){if(document.getElementById("custom-scrollbar-styles"))return;const e=document.createElement("style");e.id="custom-scrollbar-styles",e.textContent=`\n      .command-output::-webkit-scrollbar {\n        width: 8px;\n      }\n\n      .command-output::-webkit-scrollbar-track {\n        background: ${this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"};\n        border-radius: 4px;\n      }\n\n      .command-output::-webkit-scrollbar-thumb {\n        background: ${this.isDarkMode?"rgba(255, 255, 255, 0.3)":"rgba(0, 0, 0, 0.3)"};\n        border-radius: 4px;\n        transition: background 0.2s ease;\n      }\n\n      .command-output::-webkit-scrollbar-thumb:hover {\n        background: ${this.isDarkMode?"rgba(255, 255, 255, 0.5)":"rgba(0, 0, 0, 0.5)"};\n      }\n\n      /* ダークモード用 */\n      .dark-mode .command-output::-webkit-scrollbar-track {\n        background: rgba(255, 255, 255, 0.1);\n      }\n\n      .dark-mode .command-output::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      .dark-mode .command-output::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.5);\n      }\n\n      /* ライトモード用 */\n      .light-mode .command-output::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.1);\n      }\n\n      .light-mode .command-output::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      .light-mode .command-output::-webkit-scrollbar-thumb:hover {\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      @keyframes shimmer {\n        0% { background-position: -200% 0; }\n        100% { background-position: 200% 0; }\n      }\n\n      /* タスクステータスコンテナのホバー効果 */\n      .task-status-container:hover .progress-bar {\n        box-shadow: 0 0 20px rgba(255,123,71,0.6) !important;\n        transform: scaleY(1.1);\n      }\n\n      /* プログレスバーの微細なアニメーション */\n      .progress-bar {\n        position: relative;\n      }\n\n      .progress-bar::after {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: linear-gradient(90deg, \n          transparent, \n          rgba(255,255,255,0.4), \n          transparent);\n        animation: progress-shine 2s ease-in-out infinite;\n      }\n\n      @keyframes progress-shine {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(100%); }\n      }\n\n      /* wabi-sabiモード用の入力フィールドフォーカススタイル */\n      .wabisabi-mode textarea:focus,\n      .wabisabi-mode input:focus {\n        background: linear-gradient(135deg, rgba(97, 97, 97, 0.4), rgba(66, 66, 66, 0.3)) !important;\n        border: 1px solid rgba(141, 110, 99, 0.6) !important;\n        box-shadow: 0 4px 16px rgba(66, 66, 66, 0.3), inset 0 1px 0 rgba(189, 189, 189, 0.2), 0 0 0 2px rgba(141, 110, 99, 0.2) !important;\n        color: #F5F5F5 !important;\n        outline: none !important;\n      }\n    `,document.head.appendChild(e)}getInputStyles(){const e=this.isWabiSabiMode?{background:"linear-gradient(135deg, rgba(97, 97, 97, 0.4), rgba(66, 66, 66, 0.3))",border:"1px solid rgba(97, 97, 97, 0.5)",boxShadow:"0 4px 16px rgba(66, 66, 66, 0.3), inset 0 1px 0 rgba(189, 189, 189, 0.2)"}:this.isDarkMode?{background:"linear-gradient(135deg, rgba(30, 27, 75, 0.4), rgba(15, 23, 42, 0.5))",border:"1px solid rgba(99, 102, 241, 0.25)",boxShadow:"0 4px 16px rgba(15, 23, 42, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08)"}:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))",border:"1px solid rgba(255, 255, 255, 0.5)",boxShadow:"0 4px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.4)"};return`\n      width: 100%;\n      padding: 14px 16px;\n      background: ${e.background};\n      border: ${e.border};\n      border-radius: 14px;\n      color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937"};\n      font-size: 14px;\n      outline: none;\n      box-sizing: border-box;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      font-family: inherit;\n      backdrop-filter: blur(16px);\n      -webkit-backdrop-filter: blur(16px);\n      box-shadow: ${e.boxShadow};\n      placeholder-color: ${this.isDarkMode?"rgba(255, 255, 255, 0.5)":"rgba(55, 65, 81, 0.6)"};\n      resize: none;\n      overflow-y: hidden;\n      min-height: 22px;\n      max-height: 66px;\n      line-height: 22px;\n    `}getModernButtonStyles(e){return`\n      border: none;\n      border-radius: 12px;\n      color: white;\n      cursor: pointer;\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      font-family: inherit;\n      outline: none;\n      ${{primary:this.isWabiSabiMode?"\n        background: linear-gradient(135deg, #8D6E63, #6D4C41);\n        box-shadow: 0 4px 12px rgba(85, 139, 47, 0.4), inset 0 1px 0 rgba(184, 158, 135, 0.15);\n        width: 100%;\n        padding: 16px;\n        font-size: 14px;\n        font-weight: 600;\n      ":"\n        background: linear-gradient(135deg, #4f46e5, #4338ca);\n        width: 100%;\n        padding: 16px;\n        font-size: 14px;\n        font-weight: 600;\n      ",secondary:this.isWabiSabiMode?"\n        background: rgba(158, 158, 158, 0.2);\n        border: 1px solid rgba(141, 110, 99, 0.4);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #F5F5F5;\n      ":"\n        background: rgba(255, 255, 255, 0.08);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n      ",danger:this.isWabiSabiMode?"\n        background: rgba(141, 110, 99, 0.3);\n        border: 1px solid rgba(93, 64, 55, 0.5);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #F5F5F5;\n      ":"\n        background: rgba(255, 59, 48, 0.15);\n        border: 1px solid rgba(255, 59, 48, 0.3);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #ff453a;\n      "}[e]}\n    `}getModeButtonStyles(e,t){return`\n      flex: 1;\n      padding: 12px 16px;\n      border: none;\n      border-radius: 8px;\n      color: ${e?"white":this.isWabiSabiMode?"#F5F5F5":"rgba(255, 255, 255, 0.7)"};\n      background: ${e?{generate:"linear-gradient(135deg, #22c55e, #16a34a)",import:"linear-gradient(135deg, #22c55e, #16a34a)",modify:"linear-gradient(135deg, #22c55e, #16a34a)",delete:"linear-gradient(135deg, #22c55e, #16a34a)"}[t]:"transparent"};\n      font-size: 13px;\n      font-weight: 600;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n    `}bindEvents(){document.addEventListener("keydown",e=>{if(e.key===this.config.activationKey)return e.preventDefault(),void this.toggle();this.isVisible&&"Escape"===e.key&&this.hide(),this.isVisible&&e.ctrlKey&&("z"!==e.key||e.shiftKey?("y"===e.key||"z"===e.key&&e.shiftKey)&&(e.preventDefault(),this.redo()):(e.preventDefault(),this.undo()))}),this.input.addEventListener("focus",()=>{this.input.style.borderColor="#74b9ff",this.input.style.boxShadow="0 0 5px rgba(116, 185, 255, 0.5)"}),this.input.addEventListener("blur",()=>{this.input.style.borderColor="#4a90e2",this.input.style.boxShadow="none"})}toggle(){this.isVisible?this.hide():this.show()}show(){this.container.style.display="flex",this.container.style.flexDirection="column",this.floatingContainer.style.display="flex",setTimeout(()=>{const e=this.container.getBoundingClientRect();this.floatingContainer.style.left=e.left+"px",this.floatingContainer.style.top=e.top-80+"px",this.floatingContainer.style.width=e.width+"px",this.floatingContainer.style.transform="none"},50),this.isVisible=!0,this.input.focus(),this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.opacity="0",this.floatingChocolateIcon.style.pointerEvents="none"),this.onControlsToggle(!0)}hide(){this.container.style.display="none",this.floatingContainer.style.display="none",this.isVisible=!1,this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.opacity="0.8",this.floatingChocolateIcon.style.pointerEvents="auto"),this.onControlsToggle(!1),this.logDebug("🎮 コントロールを再開")}switchMode(e){if(this.currentMode===e)return;this.currentMode=e,this.container.querySelectorAll("[data-mode]").forEach(t=>{const n=t.dataset.mode===e;t.style.cssText=this.getModeButtonStyles(n,t.dataset.mode)}),this.input.placeholder=this.getPlaceholderForMode(e);const t=this.container.querySelector("#execute-btn");t.innerHTML=`<span>${{generate:"🎨 Generate Object",modify:"✏️ Apply Changes",delete:"🗑️ Delete Objects"}[e]}</span>`,t.style.background={generate:"linear-gradient(135deg, #5b21b6, #4c1d95)",modify:"linear-gradient(135deg, #ec4899, #be185d)",delete:"rgba(107, 114, 128, 0.15)"}[e]}getPlaceholderForMode(e){const t={generate:"「猫の画像を作って」と話しかけて ⏎ ✨",import:"ファイルを選択して ⏎ 📁",modify:"選択後「透明に変更」と伝えて ⏎ ✏️",delete:"選択後、コマンドをそのまま送って ⏎ 🗑️"};return t[e]||t.generate}handleDemoOrientationCommand(e){if(!this.sceneManager)return null;const t=e.toLowerCase(),n=/上下|逆さ|さかさ|ひっくり返/.test(t),i=/左右|向きを変え|向きを変更|横向き|ミラー|反転/.test(t),o=/右向き|右を向|右に向け/.test(t),r=/左向き|左を向|左に向け/.test(t),a=/後ろ向き|反対向き|背中|180度|半回転/.test(t);if(!(n||i||o||r||a))return null;let s=this.sceneManager.selectedObject;if(s||"function"!=typeof this.sceneManager.findObjectByKeyword||(s=this.sceneManager.findObjectByKeyword(t),s&&this.sceneManager.selectObject(s)),!s)return this.addOutput("⚠️ 変更したいオブジェクトを先に選択してください。","warning"),{handled:!0,result:{success:!1,message:"対象オブジェクトが見つかりませんでした"}};const l=[];if(i){const e=0===s.scale.x?1:s.scale.x;s.scale.x=-e,l.push("左右反転")}if(n){const e=0===s.scale.y?1:s.scale.y;s.scale.y=-e,l.push("上下反転")}if(o&&(s.rotation.y=Math.PI/2,l.push("右向き")),r&&(s.rotation.y=-Math.PI/2,l.push("左向き")),a&&(s.rotation.y=Math.PI,l.push("背面向き")),0===l.length)return{handled:!1};s.userData=s.userData||{},s.userData.modifications=s.userData.modifications||[],s.userData.modifications.push({timestamp:Date.now(),type:"orientation",operations:l,command:e}),"function"==typeof this.sceneManager.createModernSelectionIndicator&&this.sceneManager.createModernSelectionIndicator(s);const c=`✏️ ${l.join("・")} を適用しました`;return this.addOutput(c,"success"),{handled:!0,result:{success:!0,message:c,objectId:s.name,operations:l}}}async executeCommand(){const e=this.input.value.trim();if(!e)return;const t=this.analyzeCommandType(e);if(this.selectedFile?("import"!==this.currentMode&&this.selectMode("import",!1),this.currentMode="import"):this.currentMode=t.type,t.requiresConfirmation){if(!await this.showDeleteConfirmation(e))return void this.addOutput("❌ 削除をキャンセルしました","system")}this.input.value="",this.hideProactiveSuggestion(),t.mediaType;const n=this.addTaskCard(e,{status:"processing"});this.saveCommandToHistory({command:e,mode:this.currentMode,mediaType:t.mediaType,timestamp:Date.now()});try{let i;const o=`${this.getModePrefix(this.currentMode)}${e}`;if(this.logDebug("🔍 Current mode check:",this.currentMode),"import"===this.currentMode){if(this.logDebug("📁 Import mode detected - bypassing SceneManager"),!this.selectedFile)throw new Error("ファイルが選択されていません。まずファイルを選択してください。");i=await this.handleImportCommand(e)}else if(this.sceneManager)if("modify"===this.currentMode){const t=this.handleDemoOrientationCommand(e);i=t&&t.handled?t.result:await this.sceneManager.executeCommand(o)}else if("modify"===this.currentMode){const t=this.sceneManager?.selectedObject;if(!t)return void this.addOutput("⚠️ 変更するオブジェクトが選択されていません。まず3Dシーン内のオブジェクトをクリックで選択してから、再度コマンドを実行してください。","system");console.log("🔧 Demo: Calling modifySelectedObject with:",t,e),i=this.client&&this.client.modifySelectedObject?await this.client.modifySelectedObject(t,e):await this.sceneManager.executeCommand(o)}else i=await this.sceneManager.executeCommand(o);else{if(!this.client)throw new Error("SceneManager または Client が設定されていません");if("generate"===this.currentMode)i="video"===t.mediaType?await this.client.generateVideo(e,{model:this.selectedVideoService||void 0}):await this.client.generateImage(e,{service:this.selectedImageService||void 0});else if("modify"===this.currentMode){if(!this.selectedObject)throw new Error("変更するオブジェクトが選択されていません。まず対象オブジェクトを選択してください。");i=await this.client.modifySelectedObject(this.selectedObject,e)}else if("delete"===this.currentMode){if(!this.selectedObject&&!this.sceneManager?.getSelectedObjects()?.length)return void this.addOutput("⚠️ 削除するオブジェクトが選択されていません。まず3Dシーン内のオブジェクトをクリックで選択してから、再度Deleteボタンを押してください。","system");const t=`本当に「${e}」を実行しますか？\n\nこの操作は取り消せません。`;if(!confirm(t))return void this.addOutput("❌ 削除がキャンセルされました","system");i=await this.client.deleteObjects(e)}else i=await this.client.executeCommand(o)}if(i&&i.taskId&&(this.connectToProgress(i.taskId,n),this.currentTaskId=i.taskId),i&&!1===i.success){const e=new Error(i.error||"操作に失敗しました");throw i.errorCategory&&(e.code=i.errorCategory),e}if(n&&this.updateTaskCard(n,"completed"),i?.fallbackUsed){const e=i?.error?`⚠️ 生成に失敗したためプレースホルダーを表示しています: ${i.error}`:"⚠️ 生成に失敗したためプレースホルダーを表示しています。";this.showInputFeedback("生成に失敗したためプレースホルダーを表示しています。設定を確認してください。","error"),this.addOutput(e,"error")}t.mediaType}catch(e){const i={generate:`❌ ${"video"===t.mediaType?"動画":"画像"}生成エラー`,modify:"❌ 変更エラー",delete:"❌ 削除エラー"};"LOCAL_SERVER_UNREACHABLE"===e?.code?(this.serverHealthState.available=!1,this.serverHealthState.lastError=e,this.showServerHealthModal(e),this.showInputFeedback("サーバーに接続できません。`npm run dev` でローカルサーバーを起動してください。","error"),this.addOutput("📡 サーバーに接続できません。`npm run dev` でローカルサーバーを起動してください。","error")):"MCP_CONFIG_MISSING"===e?.code?this.showMcpConfigNotice(e):this.showInputFeedback(e.message,"error"),n&&this.updateTaskCard(n,"error"),this.addOutput(`${i[this.currentMode]}: ${e.message}`,"error"),console.error("Command execution error:",e)}this.sceneManager&&this.sceneManager.selectedObject&&("modify"!==this.currentMode&&"delete"!==this.currentMode||setTimeout(()=>{this.sceneManager.deselectObject()},500)),this.config.autoScroll&&this.scrollToBottom()}initializeServerHealthCheck(){!1!==this.config.enableServerHealthCheck?this.client?setTimeout(()=>{this.performServerHealthCheck({reason:"initial",showModalOnFail:!0}).catch(e=>{this.logDebug("⚠️ Initial health check failed:",e)})},100):this.logDebug("⚠️ Server health check skipped - client not available"):this.logDebug("🚫 Server health check disabled via config")}async performServerHealthCheck(e={}){if(!1===this.config.enableServerHealthCheck)return!0;if(!this.client)return!0;if(this.serverHealthState.checking)return this.serverHealthState.available;this.serverHealthState.checking=!0;const{showModalOnFail:t=!0}=e;this.serverHealthRetryButton&&(this.serverHealthRetryButton.disabled=!0,this.serverHealthRetryButton.textContent="再接続中…");try{"function"==typeof this.client.ensureInitialized&&await this.client.ensureInitialized();const e=this.getHealthEndpoint(),t="undefined"!=typeof AbortController?new AbortController:null,n=t?setTimeout(()=>t.abort(),5e3):null,i=await fetch(e,{method:"GET",cache:"no-store",signal:t?t.signal:void 0});if(n&&clearTimeout(n),!i.ok)throw new Error(`Health check failed: HTTP ${i.status}`);return await i.json(),this.serverHealthState.available=!0,this.serverHealthState.lastError=null,this.hideServerHealthModal(),!0}catch(e){return this.serverHealthState.available=!1,this.serverHealthState.lastError=e,t&&this.showServerHealthModal(e),!1}finally{this.serverHealthState.checking=!1,this.serverHealthRetryButton&&(this.serverHealthRetryButton.disabled=!1,this.serverHealthRetryButton.textContent="再接続を試す")}}getHealthEndpoint(){const e=this.client?.serverUrl||this.sceneManager?.client?.serverUrl;return e?`${e.replace(/\/$/,"")}/health`:"/health"}ensureServerHealthModal(){if(this.serverHealthModal)return;const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      inset: 0;\n      background: rgba(15, 23, 42, 0.65);\n      backdrop-filter: blur(6px);\n      display: none;\n      align-items: center;\n      justify-content: center;\n      z-index: 9999;\n    ";const t=document.createElement("div");t.style.cssText=`\n      max-width: 420px;\n      width: calc(100% - 64px);\n      background: ${this.isDarkMode?"rgba(15, 23, 42, 0.95)":"rgba(255, 255, 255, 0.98)"};\n      color: ${this.isDarkMode?"#f1f5f9":"#1f2937"};\n      border-radius: 16px;\n      padding: 28px;\n      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.35);\n      border: 1px solid ${this.isDarkMode?"rgba(148, 163, 184, 0.1)":"rgba(148, 163, 184, 0.2)"};\n      display: flex;\n      flex-direction: column;\n      gap: 18px;\n    `;const n=document.createElement("div");n.textContent="ChocoDrop サーバーに接続できません",n.style.cssText="\n      font-size: 18px;\n      font-weight: 700;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    ";const i=document.createElement("span");i.textContent="🔌",n.prepend(i);const o=document.createElement("p");o.style.cssText="\n      margin: 0;\n      line-height: 1.6;\n      font-size: 14px;\n    ",o.textContent="ローカルで起動している ChocoDrop サーバー（Express）に接続できません。ターミナルで `npm run dev` を実行し、サーバーが起動していることを確認してください。";const r=document.createElement("pre");r.style.cssText=`\n      margin: 0;\n      padding: 12px;\n      background: ${this.isDarkMode?"rgba(30, 41, 59, 0.6)":"rgba(15, 23, 42, 0.05)"};\n      border-radius: 10px;\n      font-size: 12px;\n      line-height: 1.5;\n      white-space: pre-wrap;\n      word-break: break-word;\n      color: ${this.isDarkMode?"#94a3b8":"#475569"};\n      border: 1px dashed ${this.isDarkMode?"rgba(148, 163, 184, 0.25)":"rgba(148, 163, 184, 0.35)"};\n    `,r.textContent="";const a=document.createElement("div");a.style.cssText="\n      display: flex;\n      gap: 12px;\n      justify-content: flex-end;\n    ";const s=document.createElement("button");s.textContent="閉じる",s.style.cssText=this.getSecondaryButtonStyles(),s.addEventListener("click",()=>{this.hideServerHealthModal()});const l=document.createElement("button");l.textContent="再接続を試す",l.style.cssText=this.getPrimaryButtonStyles(),l.addEventListener("click",()=>{this.performServerHealthCheck({reason:"manual",showModalOnFail:!0})}),a.appendChild(s),a.appendChild(l),t.appendChild(n),t.appendChild(o),t.appendChild(r),t.appendChild(a),e.appendChild(t),document.body.appendChild(e),this.serverHealthBackdrop=e,this.serverHealthModal=t,this.serverHealthMessage=o,this.serverHealthDetail=r,this.serverHealthRetryButton=l}getPrimaryButtonStyles(){return"\n      padding: 10px 16px;\n      border-radius: 10px;\n      border: none;\n      background: linear-gradient(135deg, #6366f1, #8b5cf6);\n      color: #ffffff;\n      font-weight: 600;\n      cursor: pointer;\n      transition: transform 0.2s ease, box-shadow 0.2s ease;\n      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.35);\n    "}getSecondaryButtonStyles(){return`\n      padding: 10px 16px;\n      border-radius: 10px;\n      border: 1px solid ${this.isDarkMode?"rgba(148, 163, 184, 0.3)":"rgba(71, 85, 105, 0.3)"};\n      background: transparent;\n      color: ${this.isDarkMode?"#cbd5f5":"#1f2937"};\n      font-weight: 600;\n      cursor: pointer;\n      transition: transform 0.2s ease, background 0.2s ease;\n    `}showServerHealthModal(e){if(!1!==this.config.enableServerHealthCheck&&(this.ensureServerHealthModal(),this.serverHealthBackdrop&&(this.serverHealthBackdrop.style.display="flex"),this.serverHealthDetail)){const t=e?.message||"サーバーに接続できません。";this.serverHealthDetail.textContent=t}}hideServerHealthModal(){this.serverHealthBackdrop&&(this.serverHealthBackdrop.style.display="none")}showMcpConfigNotice(e){if(this.mcpNoticeShown)return;this.mcpNoticeShown=!0;const t=e?.message||"MCP 設定が見つかりません。config.json の設定を確認してください。";this.showInputFeedback("AI生成サーバー (MCP) が未設定です。設定が完了するまで生成を実行できません。","error"),this.addOutput(`⚙️ MCP 設定が必要です: docs/SETUP.md を参照し、config.json の mcp セクションまたは MCP_CONFIG_PATH 環境変数を設定してください。\nサーバーからのメッセージ: ${t}`,"error")}async showConfirmationDialog(e){const{icon:t="🗑️",title:n="確認",message:i="この操作を実行しますか？",confirmText:o="実行",cancelText:r="キャンセル",confirmColor:a="#ef4444"}=e;return new Promise(e=>{const s=document.createElement("div");s.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(15, 23, 42, 0.6);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        z-index: 2000;\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n      ";const l=document.createElement("div");l.style.cssText=`\n        background: ${this.isDarkMode?"linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(30, 27, 75, 0.8))":"linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3))"};\n        border: 1px solid ${this.isDarkMode?"rgba(99, 102, 241, 0.3)":"rgba(255, 255, 255, 0.5)"};\n        border-radius: 20px;\n        padding: 32px;\n        max-width: 420px;\n        text-align: center;\n        color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937"};\n        font-family: inherit;\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n        box-shadow: ${this.isDarkMode?"0 8px 32px rgba(15, 23, 42, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1)":"0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2)"};\n        transform: scale(0.9);\n        opacity: 0;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      `,l.innerHTML=`\n        <div style="font-size: 56px; margin-bottom: 20px;">${t}</div>\n        <h3 style="margin: 0 0 16px 0; color: ${this.isDarkMode?"#a5b4fc":"#6366f1"}; font-size: 20px; font-weight: 700; letter-spacing: 0.02em;">\n          ${n}\n        </h3>\n        <p style="margin: 0 0 28px 0; color: ${this.isDarkMode?"#d1d5db":"#6b7280"}; line-height: 1.6; font-size: 16px;">\n          ${i}\n        </p>\n        <div style="display: flex; gap: 8px; justify-content: center;">\n          <button id="cancel-btn" style="\n            padding: 14px 24px;\n            background: ${this.isDarkMode?"linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2))":"linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))"};\n            border: 1px solid ${this.isDarkMode?"rgba(156, 163, 175, 0.2)":"rgba(255, 255, 255, 0.3)"};\n            border-radius: 12px;\n            color: ${this.isDarkMode?"#d1d5db":"#374151"};\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 600;\n            transition: all 0.2s ease;\n            backdrop-filter: blur(16px);\n            -webkit-backdrop-filter: blur(16px);\n          ">${r}</button>\n          <button id="confirm-btn" style="\n            padding: 14px 24px;\n            background: ${"#6366f1"===a?"linear-gradient(135deg, #6366f1, #8b5cf6)":"#ef4444"===a?"linear-gradient(135deg, #ef4444, #dc2626)":"linear-gradient(135deg, #ff7b47, #f97316)"};\n            border: none;\n            border-radius: 12px;\n            color: white;\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 700;\n            transition: all 0.2s ease;\n            box-shadow: 0 4px 16px ${"#6366f1"===a?"rgba(99, 102, 241, 0.3)":"#ef4444"===a?"rgba(239, 68, 68, 0.3)":"rgba(255, 123, 71, 0.3)"};\n            backdrop-filter: blur(8px);\n            -webkit-backdrop-filter: blur(8px);\n          ">${o}</button>\n        </div>\n      `,s.appendChild(l),document.body.appendChild(s),requestAnimationFrame(()=>{s.style.opacity="1",l.style.transform="scale(1)",l.style.opacity="1"}),l.querySelector("#cancel-btn").onclick=()=>{this.closeModalWithAnimation(s),e(!1)},l.querySelector("#confirm-btn").onclick=()=>{this.closeModalWithAnimation(s),e(!0)};const c=t=>{"Escape"===t.key&&(this.closeModalWithAnimation(s),document.removeEventListener("keydown",c),e(!1))};document.addEventListener("keydown",c),s.onclick=t=>{t.target===s&&(this.closeModalWithAnimation(s),e(!1))}})}async showDeleteConfirmation(e){return this.showConfirmationDialog({icon:"🗑️",title:"削除の確認",message:`「${e}」を実行しますか？<br>この操作は取り消すことができません。`,confirmText:"削除実行",cancelText:"キャンセル",confirmColor:"#ff7b47"})}addOutput(e,t="default",n={}){if("task"===t||"progress"===t)return this.addTaskCard(e,n);"error"!==t&&"system"!==t||this.addSystemMessage(e,t)}addTaskCard(e,t={}){this.taskCards||(this.taskCards=new Map);const n=t.taskId||`task_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,i=t.status||"pending",o=e.prompt||e.command||e,r=document.createElement("div");r.className="floating-task-card",r.setAttribute("data-task-id",n),r.style.cssText=this.getFloatingCardStyles(i),r.style.setProperty("opacity","0","important"),r.style.setProperty("transform","translateY(20px) scale(0.95)","important"),r.style.setProperty("filter","blur(4px)","important");const a=this.getFriendlyMessage(i,o);return r.innerHTML=`\n      <span style="font-size: 14px;">${{pending:"⏳",processing:"🎨",progress:"⚡",completed:"✅",error:"❌"}[i]}</span>\n      <span style="font-size: 13px; margin-left: 6px;">${a}</span>\n    `,this.floatingContainer.appendChild(r),this.updateCardDisplayLimit(),this.taskCards.set(n,{element:r,status:i,prompt:o,originalPrompt:o,startTime:Date.now(),endTime:null,error:null,contentType:"image",model:null,settings:null}),this.addCardDetailEvents(r,n),this.animateCardEntrance(r),n}updateTaskCard(e,t,n={}){if(!this.taskCards||!this.taskCards.has(e))return;const i=this.taskCards.get(e),o=i.element;i.status=t;const r=this.getFriendlyMessage(t,i.prompt);o.innerHTML=`\n      <span style="font-size: 14px;">${{pending:"⏳",processing:"🎨",progress:"⚡",completed:"✅",error:"❌"}[t]}</span>\n      <span style="font-size: 13px; margin-left: 6px;">${r}</span>\n    `,"completed"===t?this.animateCardSuccess(o,e):"error"===t&&this.animateCardError(o,e)}addSystemMessage(e,t){const n=document.createElement("div");n.className=`system-message ${t}`,n.style.cssText=`\n      padding: 8px 12px;\n      margin: 4px 0;\n      border-radius: 8px;\n      font-size: 12px;\n      line-height: 1.4;\n      animation: slideIn 0.3s ease-out;\n      background: ${"error"===t?"rgba(239, 68, 68, 0.1)":"rgba(107, 114, 128, 0.1)"};\n      border: 1px solid ${"error"===t?"rgba(239, 68, 68, 0.3)":"rgba(107, 114, 128, 0.3)"};\n      color: ${"error"===t?"#fca5a5":this.isDarkMode?"#d1d5db":"#6b7280"};\n    `,n.textContent=e,this.outputDiv.appendChild(n),this.scrollToBottom()}getTaskCardStyles(e){const t={pending:"rgba(167, 139, 250, 0.3)",processing:"rgba(192, 132, 252, 0.5)",progress:"rgba(236, 72, 153, 0.4)",completed:"rgba(167, 139, 250, 0.4)",error:"rgba(239, 68, 68, 0.4)"};return`\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(255, 255, 255, 0.15)"};\n      border: 1px solid ${this.isDarkMode?"rgba(255, 255, 255, 0.15)":"rgba(255, 255, 255, 0.25)"};\n      border-radius: 12px;\n      padding: 16px;\n      margin-bottom: 12px;\n      backdrop-filter: blur(12px);\n      transition: all 0.3s ease;\n      animation: slideInUp 0.3s ease-out;\n    `+`border-left: 3px solid ${t[e]||t.pending};`}getFloatingCardStyles(e){const t=this.isDarkMode?{background:"linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 27, 75, 0.7))",border:"1px solid rgba(99, 102, 241, 0.25)",boxShadow:"0 8px 32px rgba(15, 23, 42, 0.3), 0 0 0 1px rgba(99, 102, 241, 0.1)",color:"#ffffff"}:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25))",border:"1px solid rgba(255, 255, 255, 0.4)",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.2)",color:"#1f2937"};return`\n      height: 36px;\n      padding: 0 18px;\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n      background: ${t.background};\n      backdrop-filter: blur(24px) saturate(180%);\n      -webkit-backdrop-filter: blur(24px) saturate(180%);\n      border: ${t.border};\n      border-radius: 18px;\n      color: ${t.color};\n      pointer-events: auto;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;\n      font-weight: 600;\n      font-size: 13px;\n      letter-spacing: 0.01em;\n      box-shadow: ${t.boxShadow};\n      transform: translateY(10px);\n      opacity: 0;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    `}updateCardDisplayLimit(){const e=Array.from(this.floatingContainer.children).filter(e=>!e.classList.contains("overflow-counter")),t=this.floatingContainer.querySelector(".overflow-counter");if(t&&t.remove(),e.length<=3)e.forEach(e=>{e.style.display="flex"});else{e.slice(-3);const t=e.length-3;e.forEach((t,n)=>{n<e.length-3?t.style.display="none":t.style.display="flex"});const n=document.createElement("div");n.className="overflow-counter";const i=this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.12)",o=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.15)",r=this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(0, 0, 0, 0.6)";n.style.cssText=`\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 8px 12px;\n        margin: 4px 0;\n        background: ${i};\n        backdrop-filter: blur(20px);\n        border-radius: 12px;\n        border: 1px solid ${o};\n        font-size: 12px;\n        color: ${r};\n        font-weight: 500;\n        min-height: 32px;\n        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n        cursor: pointer;\n      `,n.innerHTML=`+ ${t}`,this.floatingContainer.insertBefore(n,this.floatingContainer.firstChild);const a=this.isDarkMode?"rgba(255, 255, 255, 0.12)":"rgba(0, 0, 0, 0.18)";n.addEventListener("mouseenter",()=>{n.style.background=a,n.style.transform="scale(1.05)"}),n.addEventListener("mouseleave",()=>{n.style.background=i,n.style.transform="scale(1)"})}}addCardDetailEvents(e,t){if("ontouchstart"in window||navigator.maxTouchPoints>0)e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showTaskDetailModal(t)});else{let n;e.addEventListener("mouseenter",()=>{n=setTimeout(()=>{this.showTaskDetailModal(t)},800)}),e.addEventListener("mouseleave",()=>{n&&clearTimeout(n)}),e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showTaskDetailModal(t)})}}showTaskDetailModal(e){const t=this.taskCards.get(e);if(!t)return;const n=document.querySelector(".task-detail-modal");n&&n.remove();const i=this.createTaskDetailModal(t);document.body.appendChild(i),requestAnimationFrame(()=>{i.style.opacity="1",i.querySelector(".modal-content").style.transform="translateY(0) scale(1)"})}createTaskDetailModal(e){const t=document.createElement("div");t.className="task-detail-modal";const n=this.isDarkMode?"rgba(0, 0, 0, 0.6)":"rgba(0, 0, 0, 0.4)",i=this.isDarkMode?"rgba(20, 20, 20, 0.95)":"rgba(255, 255, 255, 0.95)",o=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",r=this.isDarkMode?"rgba(255, 255, 255, 0.9)":"rgba(0, 0, 0, 0.9)",a=this.isDarkMode?"rgba(255, 255, 255, 0.6)":"rgba(0, 0, 0, 0.6)";t.style.cssText=`\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: ${n};\n      backdrop-filter: blur(10px);\n      z-index: 100000;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      transition: opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: pointer;\n    `;const s=e.endTime?((e.endTime-e.startTime)/1e3).toFixed(1):((Date.now()-e.startTime)/1e3).toFixed(1),l="pending"===e.status?"待機中":"in-progress"===e.status?"実行中":"completed"===e.status?"完了":"エラー",c=document.createElement("div");c.className="modal-content",c.style.cssText=`\n      background: ${i};\n      backdrop-filter: blur(30px);\n      border: 1px solid ${o};\n      border-radius: 16px;\n      padding: 16px !important;\n      max-width: 400px;\n      width: 90%;\n      max-height: 80vh;\n      overflow-y: auto;\n      transform: translateY(20px) scale(0.95);\n      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: default;\n      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n    `,c.innerHTML=`\n      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">\n        <h3 style="margin: 0; color: ${r}; font-size: 18px; font-weight: 600;">タスク詳細</h3>\n        <button class="close-btn" style="\n          background: none;\n          border: none;\n          font-size: 24px;\n          color: ${a};\n          cursor: pointer;\n          padding: 0;\n          line-height: 1;\n          transition: color 0.2s;\n        ">×</button>\n      </div>\n      \n      <div style="space-y: 16px;">\n        <div>\n          <div style="color: ${a}; font-size: 12px; font-weight: 500; margin-bottom: 0;">📝 元のプロンプト</div>\n          <div style="color: ${r}; font-size: 14px; line-height: 1.4;">${e.originalPrompt}</div>\n        </div>\n        \n        <div>\n          <div style="color: ${a}; font-size: 12px; font-weight: 500; margin-bottom: 0;">📊 ステータス</div>\n          <div style="color: ${r}; font-size: 14px;">${l}</div>\n        </div>\n        \n        <div>\n          <div style="color: ${a}; font-size: 12px; font-weight: 500; margin-bottom: 0;">⏱️ 実行時間</div>\n          <div style="color: ${r}; font-size: 14px;">${s}秒</div>\n        </div>\n        \n        ${e.error?`\n        <div>\n          <div style="color: ${a}; font-size: 12px; font-weight: 500; margin-bottom: 0;">❌ エラー詳細</div>\n          <div style="color: #ef4444; font-size: 14px; line-height: 1.4;">${e.error}</div>\n        </div>\n        `:""}\n        \n        <div>\n          <div style="color: ${a}; font-size: 12px; font-weight: 500; margin-bottom: 0;">🎨 コンテンツタイプ</div>\n          <div style="color: ${r}; font-size: 14px;">${e.contentType||"画像"}</div>\n        </div>\n      </div>\n    `,c.addEventListener("click",e=>{e.stopPropagation()});const d=c.querySelector(".close-btn");return d.addEventListener("click",()=>{this.closeTaskDetailModal(t)}),d.addEventListener("mouseenter",()=>{d.style.color=r}),d.addEventListener("mouseleave",()=>{d.style.color=a}),t.addEventListener("click",()=>{this.closeTaskDetailModal(t)}),t.appendChild(c),t}closeTaskDetailModal(e){e.style.opacity="0",e.querySelector(".modal-content").style.transform="translateY(20px) scale(0.95)",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}animateCardEntrance(e){e.style.transform="translateY(20px) scale(0.95)",e.style.opacity="0",e.style.filter="blur(4px)",requestAnimationFrame(()=>{e.style.transition="all 0.6s cubic-bezier(0.16, 1, 0.3, 1)",e.style.transform="translateY(0) scale(1)",e.style.opacity="1",e.style.filter="blur(0px)",e.style.boxShadow="0 4px 20px rgba(255, 255, 255, 0.1), 0 0 40px rgba(255, 255, 255, 0.05)"})}animateCardSuccess(e,t){e.style.transition="all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",e.style.borderColor="rgba(76, 175, 80, 0.6)",e.style.transform="scale(1.08)",e.style.boxShadow="0 8px 32px rgba(76, 175, 80, 0.4), 0 0 60px rgba(76, 175, 80, 0.2)",e.style.filter="brightness(1.1) saturate(1.2)",setTimeout(()=>{e.style.transform="scale(1.02)",e.style.filter="brightness(1.05) saturate(1.1)"},150),setTimeout(()=>{this.animateCardExit(e,t)},2e3)}animateCardError(e,t){e.style.transition="all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",e.style.borderColor="rgba(244, 67, 54, 0.7)",e.style.boxShadow="0 8px 32px rgba(244, 67, 54, 0.3), 0 0 60px rgba(244, 67, 54, 0.15)",e.style.filter="saturate(1.3) brightness(1.1)",e.style.animation="errorPulse 0.6s cubic-bezier(0.16, 1, 0.3, 1) 2",this.addErrorTooltip(e,t),e.style.cursor="pointer",e.onclick=()=>this.animateCardExit(e,t),setTimeout(()=>{this.taskCards.has(t)&&this.animateCardExit(e,t)},5e3)}addErrorTooltip(e,t){const n=this.taskCards.get(t);if(!n||!n.error)return;const i=document.createElement("div");i.style.cssText="\n      position: absolute;\n      bottom: 100%;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(244, 67, 54, 0.95);\n      color: white;\n      padding: 8px 12px;\n      border-radius: 8px;\n      font-size: 11px;\n      white-space: nowrap;\n      pointer-events: none;\n      z-index: 1001;\n      backdrop-filter: blur(10px);\n      margin-bottom: 0;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n    ",i.textContent=n.error,e.style.position="relative",e.appendChild(i),requestAnimationFrame(()=>{i.style.opacity="1"}),setTimeout(()=>{i.parentNode&&(i.style.opacity="0",setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300))},3e3)}animateCardExit(e,t){e.style.transition="all 0.28s cubic-bezier(0.4, 0, 0.2, 1)",e.style.transform="translateY(-12px) scale(0.92)",e.style.opacity="0",e.style.filter="blur(6px) brightness(1.2)",e.style.boxShadow="0 0 40px rgba(255, 255, 255, 0.3), 0 0 80px rgba(255, 255, 255, 0.1)",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e),this.taskCards.delete(t),this.updateCardDisplayLimit()},280)}getResponseType(e){return/ちょこっと|ちょこん|少し|軽く/.test(e)||e.length<15?"casual":/美しい|幻想|素敵|魔法|世界|綺麗/.test(e)?"magical":"balanced"}getFriendlyMessage(e,t,n=null){const i=t.length>15?t.substring(0,15)+"...":t,o=this.getResponseType(t);switch(e){case"pending":return"casual"===o?"ちょこっと準備中です...":"magical"===o?"魔法をかけようとしています...":"ちょこっと魔法の準備中...";case"processing":case"in-progress":case"progress":return"modify"===this.currentMode?"casual"===o?"ちょこっと調整中です...":"magical"===o?"イメージを変化させています...":"ちょこんと編集中です...":"casual"===o?"ちょこんと配置中です...":"magical"===o?"あなたの想いを形にしています...":"ちょこっと魔法をかけています...";case"completed":return"delete"===this.currentMode?"casual"===o?"ちょこっと削除しました！":"magical"===o?"すっきりと片付きました！":"ちょこんと削除完了！すっきりですね！":"modify"===this.currentMode?"casual"===o?"ちょこっと調整しました！":"magical"===o?"素敵に変身しました！":"ちょこんと編集完了！いい感じですね！":"casual"===o?"ちょこっとドロップしました！":"magical"===o?"素敵な世界が完成しました！":"ちょこんと配置完了！素敵ですね！";case"error":if(n){return`❌ ${n.length>30?n.substring(0,30)+"...":n}`}return"casual"===o?"おっと、エラーが発生しました":"magical"===o?"申し訳ございません、処理に失敗しました":"エラーが発生しました。もう一度お試しください";default:return i}}getStatusColor(e){const t={pending:this.isDarkMode?"#a78bfa":"#7c3aed",processing:this.isDarkMode?"#c084fc":"#9333ea",progress:this.isDarkMode?"#ec4899":"#be185d",completed:this.isDarkMode?"#a78bfa":"#7c3aed",error:this.isDarkMode?"#f87171":"#dc2626"};return t[e]||t.pending}createStatusIndicator(e){return"processing"===e||"progress"===e?`\n        <div class="status-indicator" style="\n          background: ${this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.08)"};\n          border-radius: 8px;\n          height: 4px;\n          overflow: hidden;\n          margin-top: 8px;\n          position: relative;\n        ">\n          <div class="status-pulse" style="\n            background: linear-gradient(90deg, transparent, #6366f1, #8b5cf6, transparent);\n            height: 100%;\n            width: 30%;\n            border-radius: 8px;\n            animation: statusPulse 1.8s ease-in-out infinite;\n          "></div>\n        </div>\n        <div style="display: flex; align-items: center; gap: 4px; margin-top: 8px;">\n          <div class="status-dots" style="font-size: 10px; color: ${this.isDarkMode?"#c084fc":"#9333ea"};">\n            処理中<span style="animation: dots 1.5s infinite;">...</span>\n          </div>\n        </div>\n      `:""}animateTaskCompletion(e){e.style.animation="taskComplete 0.8s ease-out",this.addSubtleParticleEffect(e),setTimeout(()=>{e.style.animation=""},800),this.ensureTaskAnimations()}addSubtleParticleEffect(e){const t=e.getBoundingClientRect();for(let e=0;e<3;e++){const n=document.createElement("div");n.style.cssText=`\n        position: fixed;\n        width: 4px;\n        height: 4px;\n        background: linear-gradient(45deg, #a78bfa, #c084fc);\n        border-radius: 50%;\n        pointer-events: none;\n        z-index: 9999;\n        left: ${t.right-20}px;\n        top: ${t.top+10}px;\n        opacity: 0.8;\n        transform: scale(0);\n        animation: subtleParticle 1.2s ease-out forwards;\n      `;const i=e/3*Math.PI*2,o=15;n.style.setProperty("--move-x",Math.cos(i)*o+"px"),n.style.setProperty("--move-y",Math.sin(i)*o+"px"),document.body.appendChild(n),setTimeout(()=>n.remove(),1200)}}ensureTaskAnimations(){if(document.getElementById("task-animations"))return;const e=document.createElement("style");e.id="task-animations",e.textContent="\n      @keyframes slideInUp {\n        from { opacity: 0; transform: translateY(20px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n\n      @keyframes taskComplete {\n        0% {\n          transform: scale(1);\n          border-left-color: rgba(192, 132, 252, 0.5);\n        }\n        30% {\n          transform: scale(1.01);\n          background: rgba(167, 139, 250, 0.08);\n          border-left-color: rgba(167, 139, 250, 0.6);\n        }\n        60% {\n          background: rgba(167, 139, 250, 0.05);\n        }\n        100% {\n          transform: scale(1);\n          background: rgba(167, 139, 250, 0.02);\n          border-left-color: rgba(167, 139, 250, 0.4);\n        }\n      }\n\n      @keyframes subtleParticle {\n        0% {\n          transform: scale(0) translate(0, 0);\n          opacity: 0.8;\n        }\n        20% {\n          transform: scale(1) translate(0, 0);\n          opacity: 1;\n        }\n        100% {\n          transform: scale(0.3) translate(var(--move-x, 0), var(--move-y, 0));\n          opacity: 0;\n        }\n      }\n\n      @keyframes shimmer {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(100%); }\n      }\n\n      @keyframes slideIn {\n        from { opacity: 0; transform: translateX(-20px); }\n        to { opacity: 1; transform: translateX(0); }\n      }\n\n      @keyframes statusPulse {\n        0% { transform: translateX(-100%); }\n        50% { transform: translateX(300%); }\n        100% { transform: translateX(-100%); }\n      }\n\n      @keyframes dots {\n        0%, 20% { opacity: 0; }\n        50% { opacity: 1; }\n        100% { opacity: 0; }\n      }\n\n      @keyframes errorPulse {\n        0% {\n          transform: scale(1);\n          filter: saturate(1.3) brightness(1.1);\n        }\n        50% {\n          transform: scale(1.03);\n          filter: saturate(1.5) brightness(1.2);\n          box-shadow: 0 12px 40px rgba(244, 67, 54, 0.4), 0 0 80px rgba(244, 67, 54, 0.2);\n        }\n        100% {\n          transform: scale(1);\n          filter: saturate(1.3) brightness(1.1);\n        }\n      }\n    ",document.head.appendChild(e)}addTaskStatus(e,t=0,n=null){const i=n||`task_${Date.now()}`;return this.addTaskCard(e,{percent:Math.min(Math.max(t,0),100),taskId:i,status:t>0?"progress":"pending"})}updateTaskProgress(e,t,n=null){this.output.querySelector(`[data-task-id="${e}"]`)&&n&&this.addOutput(n,"progress",{percent:Math.min(Math.max(t,0),100),taskId:e})}completeTask(e){const t=this.output.querySelector(`[data-task-id="${e}"]`);t&&(t.style.transition="opacity 0.5s ease, transform 0.5s ease",t.style.opacity="0",t.style.transform="translateX(20px)",setTimeout(()=>{t.parentNode&&t.remove()},500))}connectToProgress(e,t=null){if(this.activeConnections.has(e))return;const n=new EventSource(`/api/progress/${e}`);this.activeConnections.set(e,n),n.onmessage=e=>{try{const n=JSON.parse(e.data);n.uiTaskId=t,this.handleProgressUpdate(n)}catch(e){console.error("SSE data parse error:",e)}},n.onerror=t=>{console.error("SSE connection error:",t),this.disconnectProgress(e)}}handleProgressUpdate(e){switch(e.type){case"connected":this.logDebug(`🔗 Connected to progress stream: ${e.taskId}`);break;case"progress":void 0!==e.percent&&e.uiTaskId&&this.updateTaskCard(e.uiTaskId,"progress",{percent:e.percent});break;case"completed":e.uiTaskId&&this.updateTaskCard(e.uiTaskId,"completed"),this.disconnectProgress(e.taskId);break;case"error":e.uiTaskId&&this.updateTaskCard(e.uiTaskId,"error"),this.addOutput(`❌ ${e.message}`,"error"),this.disconnectProgress(e.taskId)}}disconnectProgress(e){const t=this.activeConnections.get(e);t&&(t.close(),this.activeConnections.delete(e))}scrollToBottom(){this.outputDiv&&(this.outputDiv.scrollTop=this.outputDiv.scrollHeight)}getModePrefix(e){return{generate:"",modify:"[変更] ",delete:"[削除] "}[e]||""}saveCommandToHistory(e){this.commandHistory=this.commandHistory.slice(0,this.currentHistoryIndex+1),this.commandHistory.push(e),this.currentHistoryIndex=this.commandHistory.length-1,this.commandHistory.length>this.maxHistorySize&&(this.commandHistory.shift(),this.currentHistoryIndex--),this.updateUndoRedoButtons()}undo(){if(!this.canUndo())return void this.addOutput("↶ Undoできる操作がありません","hint");const e=this.commandHistory[this.currentHistoryIndex];this.currentHistoryIndex--,"generate"===e.mode?(this.addOutput(`↶ Undo: "${e.command}" の生成を取り消しました`,"system"),this.sceneManager&&this.sceneManager.undoLastGenerate&&this.sceneManager.undoLastGenerate()):"modify"===e.mode?(this.addOutput(`↶ Undo: "${e.command}" の変更を取り消しました`,"system"),this.sceneManager&&this.sceneManager.undoLastModify&&this.sceneManager.undoLastModify()):"delete"===e.mode&&(this.addOutput(`↶ Undo: "${e.command}" の削除を取り消しました`,"system"),this.sceneManager&&this.sceneManager.undoLastDelete&&this.sceneManager.undoLastDelete()),this.updateUndoRedoButtons()}redo(){if(!this.canRedo())return void this.addOutput("↷ Redoできる操作がありません","hint");this.currentHistoryIndex++;const e=this.commandHistory[this.currentHistoryIndex];this.addOutput(`↷ Redo: "${e.command}" を再実行しました`,"system"),this.sceneManager&&this.sceneManager.redoCommand&&this.sceneManager.redoCommand(e),this.updateUndoRedoButtons()}canUndo(){return this.currentHistoryIndex>=0}canRedo(){return this.currentHistoryIndex<this.commandHistory.length-1}updateUndoRedoButtons(){this.undoBtn&&(this.undoBtn.disabled=!this.canUndo(),this.undoBtn.style.opacity=this.canUndo()?"1":"0.4",this.undoBtn.style.cursor=this.canUndo()?"pointer":"not-allowed"),this.redoBtn&&(this.redoBtn.disabled=!this.canRedo(),this.redoBtn.style.opacity=this.canRedo()?"1":"0.4",this.redoBtn.style.cursor=this.canRedo()?"pointer":"not-allowed")}async clearAllWithConfirmation(){await this.showClearAllConfirmation()&&this.clearAll()}async showClearAllConfirmation(){return this.showConfirmationDialog({icon:"🧹",title:"Clear All の確認",message:"すべてのオブジェクトが削除されます。<br>この操作は取り消すことができません。",confirmText:"Clear All 実行",cancelText:"キャンセル",confirmColor:"#6366f1"})}closeModalWithAnimation(e){const t=e.querySelector("div:last-child");t.style.transform="scale(0.9)",t.style.opacity="0",e.style.opacity="0",setTimeout(()=>{e.parentElement&&document.body.removeChild(e)},200)}clearAll(){this.sceneManager?(this.sceneManager.clearAll(),this.addOutput("🧹 全ての実験オブジェクトを削除しました","system")):this.client&&this.addOutput("⚠️ サーバー側削除は未実装","error")}showExamples(){this.addOutput("💡 コマンド例:","system"),["右上にドラゴンを作って","中央に大きなユニコーンを生成","左下に小さな桜を作って","空に鳳凰を作って","地面に神社を作って"].forEach(e=>{this.addOutput(`   "${e}"`,"hint")})}setSceneManager(e){this.sceneManager=e,this.applyServiceSelectionToSceneManager()}setClient(e){this.client=e}updateConfig(e){this.config={...this.config,...e},e.activationKey&&this.bindEvents()}refreshStyles(){document.body.className=this.isWabiSabiMode?"wabisabi-mode":this.isDarkMode?"dark-mode":"light-mode";const e=this.container?.querySelector('[data-mode="generate"]');e&&(e.style.cssText=this.getModeButtonStyles(!0,"generate"));const t=this.container?.querySelector("#execute-btn");t&&(t.style.cssText=this.getModernButtonStyles("primary"))}toggleTheme(){const e=["light","dark","wabisabi"],t=(e.indexOf(this.currentTheme)+1)%e.length;if(this.currentTheme=e[t],this.isDarkMode="dark"===this.currentTheme,this.isWabiSabiMode="wabisabi"===this.currentTheme,localStorage.setItem("live-command-theme",this.currentTheme),this.themeToggle){const e=()=>({light:"🌙",dark:"🍵",wabisabi:"☀️"}[this.currentTheme]||"🌙"),t=()=>({light:"ダークモードに切り替え",dark:"侘び寂びモードに切り替え",wabisabi:"ライトモードに切り替え"}[this.currentTheme]||"ダークモードに切り替え"),n=()=>{const t=e();return"☀️"===t?`<span style="filter: saturate(1.2) brightness(1.1);">${t}</span>`:"🍵"===t?`<span style="filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);">${t}</span>`:`<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">${t}</span>`};this.themeToggle.innerHTML=n(),this.themeToggle.title=t()}this.applyTheme()}applyTheme(){document.body.className=this.isDarkMode?"dark-mode":"light-mode";const e=this.container.style.display,t=this.container.style.flexDirection;this.container.style.cssText=this.getContainerStyles(),this.container.style.display=e||"flex",this.container.style.flexDirection=t||"column";const n=this.container.querySelector(".floating-brand-badge");if(n&&(n.style.background=this.isDarkMode?"linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.7))":"linear-gradient(135deg, rgba(99, 102, 241, 0.9), rgba(139, 92, 246, 0.8))",n.style.border="1px solid "+(this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(255, 255, 255, 0.4)")),this.input.style.cssText=this.getInputStyles(),this.output.style.cssText=this.getOutputStyles(),this.radioModeContainer&&(this.radioModeContainer.style.background=this.isWabiSabiMode?"linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))":this.isDarkMode?"linear-gradient(135deg, rgba(30, 27, 75, 0.3), rgba(15, 23, 42, 0.4))":"linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1))",this.radioModeContainer.style.borderColor=this.isWabiSabiMode?"rgba(93, 64, 55, 0.4)":this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(255, 255, 255, 0.25)",Object.keys(this.radioModeButtons).forEach(e=>{const{button:t}=this.radioModeButtons[e];this.currentMode!==e&&(t.style.color=this.isWabiSabiMode?"rgba(245, 245, 245, 0.8)":this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(55, 65, 81, 0.8)",t.style.background="transparent",t.style.border="1px solid transparent",t.style.boxShadow="none")}),this.selectMode(this.currentMode,!1)),this.clearBtn&&(this.clearBtn.style.cssText=this.getActionButtonStyles("secondary")),this.historyBtn&&(this.historyBtn.style.cssText=this.getActionButtonStyles("secondary"),this.historyBtn.style.opacity="0.5"),this.themeToggle){const e=()=>({light:"🌙",dark:"🍵",wabisabi:"☀️"}[this.currentTheme]||"🌙"),t=()=>({light:"ダークモードに切り替え",dark:"侘び寂びモードに切り替え",wabisabi:"ライトモードに切り替え"}[this.currentTheme]||"ダークモードに切り替え"),n=()=>{const t=e();return"☀️"===t?`<span style="filter: saturate(1.2) brightness(1.1);">${t}</span>`:"🍵"===t?`<span style="filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);">${t}</span>`:`<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">${t}</span>`};this.themeToggle.innerHTML=n(),this.themeToggle.title=t(),this.themeToggle.style.cssText=this.getActionButtonStyles("icon")}this.settingsButton&&(this.settingsButton.style.cssText=this.getActionButtonStyles("icon")),this.updateServiceSelectorTheme();const i=this.container.querySelector(".close-button");i&&(i.style.color=this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937",i.style.background=this.isWabiSabiMode?"rgba(245, 245, 245, 0.1)":this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"),this.updateFloatingContainerTheme(),this.updateExistingTextColors()}updateFloatingContainerTheme(){if(!this.floatingContainer)return;const e=this.floatingContainer.style.display;this.taskCards&&this.taskCards.size>0&&this.taskCards.forEach((e,t)=>{const n=e.element;if(n){const e={background:"linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 27, 75, 0.7))",border:"1px solid rgba(99, 102, 241, 0.25)",color:"#ffffff"},t={background:"linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25))",border:"1px solid rgba(255, 255, 255, 0.4)",color:"#1f2937"},i=this.isDarkMode?e:t;n.style.setProperty("background",i.background,"important"),n.style.setProperty("border",i.border,"important"),n.style.setProperty("color",i.color,"important")}}),this.floatingContainer.style.display=e}updateExistingTextColors(){const e=this.isDarkMode?{system:"#60a5fa",command:"#93c5fd",success:"#f472b6",error:"#f87171",processing:"#fbbf24",info:"#d1d5db",hint:"#d1d5db"}:{system:"#1e40af",command:"#1d4ed8",success:"#be185d",error:"#dc2626",processing:"#d97706",info:"#7c3aed",hint:"#374151"},t=this.isDarkMode?"#d1d5db":"#374151";this.output.querySelectorAll("div").forEach(n=>{const i=n.textContent;let o="default";i.includes("📋")||i.includes("🎨")||i.includes("🎮")||i.includes("UI起動")?o="system":i.startsWith("> ")?o="command":i.includes("✅")||i.includes("⭐")||i.includes("生成しました")?o="success":i.includes("❌")||i.includes("エラー")?o="error":i.includes("中...")?o="processing":i.includes("📍")||i.includes("使用モデル:")||i.includes("位置:")?o="info":i.includes("   ")&&(o="hint"),n.style.color=e[o]||t})}showImportInterface(){this.fileInput||(this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".glb,.gltf,.jpg,.jpeg,.png,.mp4,.mov",this.fileInput.style.display="none",this.fileInput.onchange=e=>this.handleFileSelection(e),document.body.appendChild(this.fileInput)),this.enableDragAndDrop()}hideImportInterface(){this.fileSelectButton&&this.fileSelectButton.parentNode&&this.fileSelectButton.parentNode.removeChild(this.fileSelectButton),this.disableDragAndDrop()}openFileSelector(){this.fileInput&&this.fileInput.click()}triggerFileSelection(){this.fileInput||this.showImportInterface(),this.openFileSelector(),this.selectMode("import",!0)}async handleFileSelection(e){const t=e.target.files[0];if(t)try{const n=this.detectFileType(t.name),i=URL.createObjectURL(t);this.selectedFile={file:t,url:i,type:n,name:t.name},e?.target&&(e.target.value=""),this.selectMode("import",!0);const o=`中央に設置 (${t.name})`;this.input.value=o,this.addOutput(`📁 ファイル選択: ${t.name} (${n})`,"system"),this.addOutput(`🚀 自動アップロード開始: ${o}`,"system"),setTimeout(()=>{this.executeCommand()},500)}catch(e){console.error("File selection error:",e),this.addOutput(`❌ ファイル選択エラー: ${e.message}`,"error")}}enableDragAndDrop(){this.input&&(this.input.addEventListener("dragover",this.handleDragOver.bind(this)),this.input.addEventListener("drop",this.handleDrop.bind(this)),this.input.addEventListener("dragenter",this.handleDragEnter.bind(this)),this.input.addEventListener("dragleave",this.handleDragLeave.bind(this)))}disableDragAndDrop(){this.input&&(this.input.removeEventListener("dragover",this.handleDragOver.bind(this)),this.input.removeEventListener("drop",this.handleDrop.bind(this)),this.input.removeEventListener("dragenter",this.handleDragEnter.bind(this)),this.input.removeEventListener("dragleave",this.handleDragLeave.bind(this)))}handleDragOver(e){e.preventDefault(),this.input.style.background=this.isDarkMode?"rgba(236, 72, 153, 0.1)":"rgba(236, 72, 153, 0.05)"}handleDragEnter(e){e.preventDefault(),this.input.style.background=this.isDarkMode?"rgba(236, 72, 153, 0.1)":"rgba(236, 72, 153, 0.05)"}handleDragLeave(e){e.preventDefault(),this.input.style.background=""}async handleDrop(e){e.preventDefault(),this.input.style.background="";const t=Array.from(e.dataTransfer.files);if(0===t.length)return;const n=t[0];this.detectFileType(n.name)?this.handleFileSelection({target:{files:[n]}}):this.addOutput("❌ サポートされていないファイル形式です","error")}detectFileType(e){const t=e.toLowerCase().split(".").pop();return["glb","gltf"].includes(t)?"3d":["jpg","jpeg","png","webp"].includes(t)?"image":["mp4","mov","webm"].includes(t)?"video":null}async handleImportCommand(e){if(!this.selectedFile)throw new Error("ファイルが選択されていません");try{const t=this.sceneManager?this.sceneManager.parsePosition(e):{x:0,y:5,z:-10};let n;switch(this.selectedFile.type){case"3d":if(!this.sceneManager)throw new Error("SceneManager が利用できません");n=await this.sceneManager.load3DModel(this.selectedFile.url,{position:t});break;case"image":if(!this.sceneManager)throw new Error("SceneManager が利用できません");n=await this.sceneManager.loadImageFile(this.selectedFile.url,{position:t,fileName:this.selectedFile.name});break;case"video":if(!this.sceneManager)throw new Error("SceneManager が利用できません");n=await this.sceneManager.loadVideoFile(this.selectedFile.url,{position:t,fileName:this.selectedFile.name});break;default:throw new Error(`サポートされていないファイルタイプ: ${this.selectedFile.type}`)}const i=this.selectedFile?.name,o=this.selectedFile?.type,r=this.selectedFile?.url;return"video"!==o&&r&&URL.revokeObjectURL(r),this.fileInput&&(this.fileInput.value=""),this.selectedFile=null,this.selectMode("generate",!1),{success:!0,message:`${i||"ファイル"} を ${t.x}, ${t.y}, ${t.z} に配置しました`,objectId:n.objectId}}catch(e){throw this.selectedFile?.url&&URL.revokeObjectURL(this.selectedFile.url),this.fileInput&&(this.fileInput.value=""),this.selectedFile=null,this.selectMode("generate",!1),e}}handleDeleteModeSelection(){const e=this.sceneManager?.selectedObject;if(e){const t=e.userData?.originalPrompt||e.name||"選択したオブジェクト";this.input.value=`${t}を削除 ⏎`,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length),this.addOutput(`🎯 削除対象: ${t}`,"system")}else this.input.value="",this.addOutput("❗ 削除するオブジェクトを選択後、削除ボタンを押してください","system"),this.triggerAttentionAnimation("delete")}handleModifyModeSelection(){const e=this.sceneManager?.selectedObject;if(e){const t=e.userData?.originalPrompt||e.name||"選択したオブジェクト";this.input.value=`${t}を`,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length),this.addOutput(`🎯 修正対象: ${t}`,"system")}else this.input.value="",this.addOutput("❗ 修正するオブジェクトを選択後、修正ボタンを押してください","system"),this.triggerAttentionAnimation("modify")}triggerAttentionAnimation(e){const t=this.chatOutput,n=this.input;this.addMicroShakeEffect(t),this.addContextGlow(n,e),this.addEmotionalPulse(t,e),this.add3DDepthEffect(t)}addMicroShakeEffect(e){e.style.animation="microShake2025 0.5s ease-in-out",this.ensureMicroShakeAnimation(),setTimeout(()=>{e.style.animation=""},500)}addContextGlow(e,t){const n="delete"===t?"rgba(239, 68, 68, 0.4)":"rgba(99, 102, 241, 0.4)";e.style.transition="all 0.3s ease",e.style.boxShadow=`0 0 20px ${n}, 0 0 40px ${n}`,setTimeout(()=>{e.style.boxShadow=""},3e3)}addEmotionalPulse(e,t){const n="delete"===t?"#ef4444":"#6366f1";e.style.borderLeft=`4px solid ${n}`,e.style.animation="emotionalPulse2025 2s ease-in-out infinite",this.ensureEmotionalPulseAnimation(),setTimeout(()=>{e.style.animation="",e.style.borderLeft=""},6e3)}add3DDepthEffect(e){e.style.transform="translateZ(8px) rotateX(1deg)",e.style.transition="transform 0.3s ease",setTimeout(()=>{e.style.transform=""},2e3)}ensureMicroShakeAnimation(){if(document.getElementById("micro-shake-2025"))return;const e=document.createElement("style");e.id="micro-shake-2025",e.textContent="\n      @keyframes microShake2025 {\n        0%, 100% { transform: translateX(0); }\n        10% { transform: translateX(-2px) rotateZ(-0.5deg); }\n        20% { transform: translateX(2px) rotateZ(0.5deg); }\n        30% { transform: translateX(-1px) rotateZ(-0.3deg); }\n        40% { transform: translateX(1px) rotateZ(0.3deg); }\n        50% { transform: translateX(-0.5px) rotateZ(-0.1deg); }\n        60% { transform: translateX(0.5px) rotateZ(0.1deg); }\n        70% { transform: translateX(0); }\n      }\n    ",document.head.appendChild(e)}ensureEmotionalPulseAnimation(){if(document.getElementById("emotional-pulse-2025"))return;const e=document.createElement("style");e.id="emotional-pulse-2025",e.textContent="\n      @keyframes emotionalPulse2025 {\n        0% { \n          border-left-width: 4px;\n          filter: brightness(1);\n        }\n        50% { \n          border-left-width: 8px;\n          filter: brightness(1.2) saturate(1.1);\n        }\n        100% { \n          border-left-width: 4px;\n          filter: brightness(1);\n        }\n      }\n    ",document.head.appendChild(e)}clearInputOnModeSwitch(e){if(this.input.value.trim()){this.isPreviousModeMessage(this.input.value,e)&&(this.input.value="",this.addOutput(`💫 ${this.getModeDisplayName(e)}モードに切り替えました`,"system"))}}isPreviousModeMessage(e,t){const n=[/.*を削除$/,/削除$/],i=[/.*を$/,/.*を変更/,/.*をピンク/,/.*を大きく/,/.*を小さく/,/.*を移動/,/回転/,/反転/,/ミラー/,/傾け/,/向きを変え/,/.*を.*色/,/.*を.*サイズ/],o=[/ファイル/,/画像/,/インポート/];switch(t){case"delete":return i.some(t=>t.test(e))||o.some(t=>t.test(e));case"modify":case"generate":return n.some(t=>t.test(e))||i.some(t=>t.test(e))||o.some(t=>t.test(e));case"import":return n.some(t=>t.test(e))||i.some(t=>t.test(e));default:return!1}}getModeDisplayName(e){return{generate:"生成",import:"インポート",modify:"修正",delete:"削除"}[e]||e}createFloatingChocolateIcon(){this.floatingChocolateIcon&&this.floatingChocolateIcon.remove(),this.floatingChocolateIcon=document.createElement("div"),this.floatingChocolateIcon.innerHTML="🍫",this.floatingChocolateIcon.title="ChocoDrop を開く (@キーでも開けます)",this.floatingChocolateIcon.style.cssText="\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      width: 48px;\n      height: 48px;\n      border-radius: 50%;\n      background: rgba(99, 102, 241, 0.15);\n      backdrop-filter: blur(16px);\n      -webkit-backdrop-filter: blur(16px);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05);\n      opacity: 0.8;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 20px;\n      cursor: pointer;\n      z-index: 999;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      transform: scale(1);\n      filter: none;\n    ",this.floatingChocolateIcon.addEventListener("mouseover",()=>{this.floatingChocolateIcon.style.transform="scale(1.1) translateY(-2px)",this.floatingChocolateIcon.style.boxShadow="0 6px 16px rgba(99, 102, 241, 0.3), 0 3px 8px rgba(0, 0, 0, 0.1)",this.floatingChocolateIcon.style.opacity="1",this.floatingChocolateIcon.style.filter="none"}),this.floatingChocolateIcon.addEventListener("mouseout",()=>{this.floatingChocolateIcon.style.transform="scale(1) translateY(0)",this.floatingChocolateIcon.style.boxShadow="0 4px 12px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05)",this.floatingChocolateIcon.style.opacity="0.8",this.floatingChocolateIcon.style.filter="none"}),this.floatingChocolateIcon.addEventListener("click",()=>{this.isVisible?this.hide():this.show()}),this.floatingChocolateIcon.addEventListener("contextmenu",e=>{e.preventDefault(),this.showFloatingIconContextMenu(e)}),document.body.appendChild(this.floatingChocolateIcon)}showFloatingIconContextMenu(e){const t=document.querySelector(".floating-icon-context-menu");t&&t.remove();const n=document.createElement("div");n.className="floating-icon-context-menu",n.style.cssText=`\n      position: fixed;\n      top: ${e.clientY}px;\n      left: ${e.clientX}px;\n      background: ${this.isDarkMode?"rgba(17, 24, 39, 0.85)":"rgba(255, 255, 255, 0.85)"};\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid ${this.isDarkMode?"rgba(129, 140, 248, 0.3)":"rgba(99, 102, 241, 0.2)"};\n      border-radius: 12px;\n      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);\n      padding: 8px 0;\n      min-width: 160px;\n      z-index: 2000;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937"};\n    `;const i=document.createElement("div");i.innerHTML="📄 フォームを開く",i.style.cssText="\n      padding: 8px 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      color: #6366f1;\n      text-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);\n    ",i.addEventListener("mouseover",()=>{i.style.background=this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(99, 102, 241, 0.1)",i.style.textShadow="0 2px 6px rgba(99, 102, 241, 0.5)"}),i.addEventListener("mouseout",()=>{i.style.background="transparent",i.style.textShadow="0 2px 4px rgba(99, 102, 241, 0.3)"}),i.addEventListener("click",()=>{n.remove(),this.isVisible?this.hide():this.show()});const o=document.createElement("div");o.innerHTML="✕ アイコンを非表示",o.style.cssText="\n      padding: 8px 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      color: #6366f1;\n      text-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);\n    ",o.addEventListener("mouseover",()=>{o.style.background=this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(99, 102, 241, 0.1)",o.style.textShadow="0 2px 6px rgba(99, 102, 241, 0.5)"}),o.addEventListener("mouseout",()=>{o.style.background="transparent",o.style.textShadow="0 2px 4px rgba(99, 102, 241, 0.3)"}),o.addEventListener("click",()=>{n.remove(),this.hideFloatingIcon()}),n.appendChild(i),n.appendChild(o),document.body.appendChild(n);const r=n.getBoundingClientRect();r.right>window.innerWidth&&(n.style.left=e.clientX-r.width+"px"),r.bottom>window.innerHeight&&(n.style.top=e.clientY-r.height+"px");const a=e=>{n.contains(e.target)||(n.remove(),document.removeEventListener("click",a))};setTimeout(()=>{document.addEventListener("click",a)},10)}hideFloatingIcon(){this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.display="none")}showFloatingIcon(){this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.display="flex")}dispose(){this.fileInput&&this.fileInput.parentNode&&this.fileInput.parentNode.removeChild(this.fileInput),this.selectedFile&&this.selectedFile.url&&URL.revokeObjectURL(this.selectedFile.url),this.floatingChocolateIcon&&this.floatingChocolateIcon.parentNode&&this.floatingChocolateIcon.parentNode.removeChild(this.floatingChocolateIcon),this.container&&this.container.parentElement&&this.container.parentElement.removeChild(this.container)}showOverlayTextarea(){if(this.overlayTextarea)return;this.isExpanded=!0,this.overlayTextarea=document.createElement("textarea"),this.overlayTextarea.value=this.input.value,this.overlayTextarea.placeholder=this.input.placeholder;const e=this.container.getBoundingClientRect(),t=20;let n=e.top+60,i=e.left,o=e.width;i+o>window.innerWidth-t&&(i=window.innerWidth-o-t),i<t&&(i=t,o=Math.min(o,window.innerWidth-40)),n+300>window.innerHeight-t&&(n=Math.max(t,window.innerHeight-300-t));const r=this.isWabiSabiMode?"linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))":this.isDarkMode?"linear-gradient(135deg, rgba(30, 27, 75, 0.4), rgba(15, 23, 42, 0.5))":"linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))",a=this.isWabiSabiMode?"1px solid rgba(93, 64, 55, 0.5)":this.isDarkMode?"1px solid rgba(99, 102, 241, 0.25)":"1px solid rgba(255, 255, 255, 0.5)",s=this.isWabiSabiMode?"0 4px 16px rgba(66, 66, 66, 0.3), inset 0 1px 0 rgba(189, 189, 189, 0.2)":this.isDarkMode?"0 4px 16px rgba(15, 23, 42, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08)":"0 4px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.4)",l=this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937";this.overlayTextarea.style.cssText=`\n      position: fixed;\n      top: ${n}px;\n      left: ${i}px;\n      width: ${o}px;\n      height: 300px;\n      box-sizing: border-box;\n      background: ${r};\n      backdrop-filter: blur(24px) saturate(180%);\n      border: ${a};\n      box-shadow: ${s};\n      border-radius: 16px;\n      color: ${l};\n      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      line-height: 1.5;\n      padding: 20px;\n      resize: none;\n      outline: none;\n      z-index: 10000;\n      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);\n      opacity: 0;\n      transition: opacity 0.2s ease-out;\n    `,document.body.appendChild(this.overlayTextarea),requestAnimationFrame(()=>{this.overlayTextarea.style.opacity="1"}),this.overlayTextarea.focus(),this.overlayTextarea.addEventListener("input",e=>{this.input.value=e.target.value}),this.overlayTextarea.addEventListener("keydown",e=>{"Escape"===e.key&&this.hideOverlayTextarea()}),this.overlayTextarea.addEventListener("blur",()=>{setTimeout(()=>this.hideOverlayTextarea(),100)})}hideOverlayTextarea(){this.overlayTextarea&&(this.isExpanded=!1,this.overlayTextarea.style.opacity="0",setTimeout(()=>{this.overlayTextarea&&(document.body.removeChild(this.overlayTextarea),this.overlayTextarea=null)},200))}hideOverlayTextarea(){this.overlayTextarea&&(this.isExpanded=!1,this.overlayTextarea.style.opacity="0",setTimeout(()=>{this.overlayTextarea&&(document.body.removeChild(this.overlayTextarea),this.overlayTextarea=null)},200))}}const b="chocodrop-service-image",y="chocodrop-service-video";class f{constructor(e={}){this.sceneManager=e.sceneManager||null,this.client=e.client||null,this.onControlsToggle=e.onControlsToggle||(()=>{}),this.isVisible=!1,this.container=null,this.input=null,this.output=null,this.currentMode="generate",this.activeConnections=new Map,this.currentTaskId=null,this.config={activationKey:e.activationKey||"@",position:e.position||"bottom-right",width:e.width||450,maxHeight:e.maxHeight||600,theme:e.theme||"dark",showExamples:!1!==e.showExamples,autoScroll:!1!==e.autoScroll,enableDebugLogging:!0===e.enableDebugLogging,skipServiceDialog:!1!==e.skipServiceDialog,enableServerHealthCheck:!1!==e.enableServerHealthCheck,...e.config},this.availableImageServices=[],this.availableVideoServices=[],this.selectedImageService=null,this.selectedVideoService=null,this.highlightOverlay=null,this.inputDefaultStyles=null,this.imageServiceSelect=null,this.videoServiceSelect=null,this.serviceSelectorContainer=null,this.serviceSelectorStatus=null,this.serviceSelectorContent=null,this.serviceSelectorRetryButton=null,this.serviceSelectorSaveButton=null,this.serviceSelectorCancelButton=null,this.serviceModalOverlay=null,this.serviceModal=null,this.servicesLoading=!1,this.isExpanded=!1,this.overlayTextarea=null,this.pendingImageService=null,this.pendingVideoService=null,this.feedbackAutoClearTimer=null,this.currentFeedback=null,this.serverHealthState={available:!0,checking:!1,lastError:null},this.serverHealthBackdrop=null,this.serverHealthModal=null,this.serverHealthMessage=null,this.serverHealthDetail=null,this.serverHealthRetryButton=null,this.mcpNoticeShown=!1;try{const e=localStorage.getItem(b),t=localStorage.getItem(y);console.log("🔍 Debug localStorage read:",{storedImage:e,storedVideo:t,IMAGE_SERVICE_STORAGE_KEY:b,VIDEO_SERVICE_STORAGE_KEY:y}),e&&(this.selectedImageService=e,console.log("✅ Set selectedImageService:",this.selectedImageService)),t&&(this.selectedVideoService=t,console.log("✅ Set selectedVideoService:",this.selectedVideoService)),console.log("🔍 Final values:",{selectedImageService:this.selectedImageService,selectedVideoService:this.selectedVideoService})}catch(e){console.warn("⚠️ Failed to load stored service selections:",e)}this.pendingImageService=this.selectedImageService,this.pendingVideoService=this.selectedVideoService,this.applyServiceSelectionToSceneManager(),console.log("🔍 After applyServiceSelectionToSceneManager - UI:",{selectedImageService:this.selectedImageService,selectedVideoService:this.selectedVideoService}),console.log("🔍 After applyServiceSelectionToSceneManager - SceneManager:",{selectedImageService:this.sceneManager?.selectedImageService,selectedVideoService:this.sceneManager?.selectedVideoService}),this.currentTheme=localStorage.getItem("live-command-theme")||"light",this.isDarkMode="dark"===this.currentTheme,this.isWabiSabiMode="wabisabi"===this.currentTheme,this.commandHistory=[],this.currentHistoryIndex=-1,this.maxHistorySize=50,this.initUI(),this.bindEvents(),!this.client&&this.sceneManager&&this.sceneManager.client&&(this.client=this.sceneManager.client),this.initializeServerHealthCheck(),this.createServiceModal(),this.createFloatingChocolateIcon(),document.addEventListener("DOMContentLoaded",()=>{this.refreshStyles()}),this.logDebug("🎮 CommandUI initialized"),this.config.skipServiceDialog||this.selectedImageService&&this.selectedVideoService||this.openServiceModal(!0)}logDebug(...e){this.config.enableDebugLogging&&console.log(...e)}initUI(){this.container=document.createElement("div"),this.container.id="live-command-ui",this.container.style.cssText=this.getContainerStyles();const e=document.createElement("div");e.className="progressive-brand-indicator",e.style.cssText=`\n      position: absolute;\n      top: -8px;\n      right: 8px;\n      width: 8px;\n      height: 8px;\n      background: linear-gradient(135deg, ${this.isWabiSabiMode?"#8BC34A, #689F38":"#6366f1, #8b5cf6"});\n      border-radius: 50%;\n      opacity: 0.7;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      z-index: 10;\n      cursor: pointer;\n    `;const t=document.createElement("div");t.className="progressive-brand-text",t.style.cssText=`\n      position: absolute;\n      top: -35px;\n      right: -5px;\n      padding: 6px 12px;\n      background: rgba(255, 255, 255, 0.15);\n      border: 1px solid ${this.isDarkMode?"rgba(129, 140, 248, 0.3)":"rgba(99, 102, 241, 0.25)"};\n      border-radius: 12px;\n      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      font-size: 11px;\n      font-weight: 700;\n      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      letter-spacing: 0.02em;\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      opacity: 0;\n      transform: translateY(5px) scale(0.9);\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      pointer-events: none;\n      z-index: 11;\n      white-space: nowrap;\n    `,t.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">🍫</span> <span style="color: #6366f1;">ChocoDrop</span>',e.addEventListener("mouseenter",()=>{t.style.opacity="1",t.style.transform="translateY(0) scale(1)",e.style.transform="scale(1.2)",e.style.opacity="1"}),e.addEventListener("mouseleave",()=>{t.style.opacity="0",t.style.transform="translateY(5px) scale(0.9)",e.style.transform="scale(1)",e.style.opacity="0.7"}),e.appendChild(t),this.container.appendChild(e),this.output=document.createElement("div"),this.outputDiv=this.output,this.output.id="command-output",this.output.className="command-output",this.output.style.cssText=this.getOutputStyles(),this.floatingContainer=document.createElement("div"),this.floatingContainer.id="floating-cards-container",this.floatingContainer.style.cssText="\n      position: fixed;\n      bottom: var(--floating-bottom, 120px);\n      left: 50%;\n      transform: translateX(-50%);\n      z-index: 99999;\n      pointer-events: none;\n      display: none;\n      flex-direction: column;\n      gap: 8px;\n      width: 400px;\n      max-width: 90vw;\n      align-items: center;\n      justify-content: flex-start;\n    ",this.taskCards=new Map,this.inputWrapper=document.createElement("div"),this.inputWrapper.style.cssText="\n      position: relative;\n      width: 100%;\n      margin-bottom: 0;\n    ",this.input=document.createElement("textarea"),this.input.rows=1,this.input.id="command-input",this.input.placeholder="「右上にドラゴンを」「美しい桜の森を中央に」など... ✨",this.input.style.cssText=this.getInputStyles(),this.expandButton=document.createElement("div"),this.expandButton.innerHTML="⤢",this.expandButton.title="テキスト全体を表示",this.expandButton.style.cssText=`\n      position: absolute;\n      bottom: 8px;\n      right: 8px;\n      width: 24px;\n      height: 24px;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"};\n      border: 1px solid ${this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)"};\n      border-radius: 6px;\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      font-size: 12px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      z-index: 1;\n    `,this.expandButton.addEventListener("mouseenter",()=>{this.expandButton.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)",this.expandButton.style.transform="scale(1.1)"}),this.expandButton.addEventListener("mouseleave",()=>{this.expandButton.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",this.expandButton.style.transform="scale(1)"}),this.expandButton.addEventListener("click",()=>{this.isExpanded?this.hideOverlayTextarea():this.showOverlayTextarea()}),this.inputWrapper.appendChild(this.input),this.inputWrapper.appendChild(this.expandButton);const n=this.createRadioModeSelector(),i=this.createMinimalActions(),o=document.createElement("div");o.innerHTML="×",o.style.cssText=`\n      position: absolute;\n      top: 12px;\n      right: 12px;\n      width: 22px;\n      height: 22px;\n      border-radius: 50%;\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"};\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: normal;\n      transition: all 0.2s ease;\n      backdrop-filter: blur(8px);\n      z-index: 10;\n    `,o.addEventListener("mouseover",()=>{o.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)",o.style.transform="scale(1.1)"}),o.addEventListener("mouseout",()=>{o.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",o.style.color=this.isDarkMode?"#ffffff":"#1f2937",o.style.transform="scale(1)"}),o.addEventListener("click",()=>{this.hide()}),this.container.appendChild(o),this.container.appendChild(n),this.container.appendChild(this.inputWrapper),this.container.appendChild(i),document.body.appendChild(this.floatingContainer),document.body.appendChild(this.container),this.applyTheme(),this.isComposing=!1,this.hasCompositionJustEnded=!1,this.input.addEventListener("input",()=>{this.isComposing||(this.currentFeedback&&this.clearInputFeedback(),this.autoResizeTextarea(),this.applyKeywordHighlighting(),this.detectCommandType())}),this.input.addEventListener("compositionstart",()=>{this.isComposing=!0}),this.input.addEventListener("compositionend",()=>{this.isComposing=!1;/Safari/.test(navigator.userAgent)&&/Version/.test(navigator.userAgent)&&(this.hasCompositionJustEnded=!0),setTimeout(()=>{this.autoResizeTextarea(),this.detectCommandType()},10)});const r=/Safari/.test(navigator.userAgent)&&/Version/.test(navigator.userAgent);this.input.addEventListener("keydown",e=>{if("Enter"===e.key){if(r&&this.hasCompositionJustEnded)return void(this.hasCompositionJustEnded=!1);if(!r&&(e.isComposing||this.isComposing))return;if(e.preventDefault(),"delete"===this.currentMode&&this.input.value.trim()){const e=this.input.value.trim();this.showDeleteConfirmation(e).then(t=>{if(t){const t=`[削除] ${e}`;this.executeCommand(t)}else this.addOutput("❌ 削除をキャンセルしました","info")})}else this.executeCommand()}}),this.config.showExamples}createMinimalActions(){const e=document.createElement("div");e.style.cssText="\n      display: flex;\n      margin-top: 8px;\n      margin-bottom: 0 !important;\n      gap: 8px;\n      justify-content: space-between;\n      align-items: center;\n    ";const t=document.createElement("div");t.style.cssText="display: flex; gap: 8px; align-items: center;";const n=document.createElement("button");n.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.7) brightness(0.9);">🧹</span> Clear All',n.style.cssText=this.getActionButtonStyles("secondary"),n.addEventListener("click",()=>this.clearAllWithConfirmation());const i=document.createElement("button");i.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.7) brightness(0.9);">📚</span> History',i.style.cssText=this.getActionButtonStyles("secondary"),i.style.opacity="0.5",i.disabled=!0,i.title="履歴機能（開発中）",t.appendChild(n),t.appendChild(i);const o=document.createElement("div");o.style.cssText="display: flex; gap: 6px; align-items: center;";const r=document.createElement("button"),a=()=>({light:"🌙",dark:"🍵",wabisabi:"☀️"}[this.currentTheme]||"🌙");r.innerHTML=(()=>{const e=a();return"☀️"===e?`<span style="filter: saturate(1.2) brightness(1.1);">${e}</span>`:"🍵"===e?`<span style="filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);">${e}</span>`:`<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">${e}</span>`})(),r.style.cssText=this.getActionButtonStyles("icon"),r.title=(()=>({light:"ダークモードに切り替え",dark:"侘び寂びモードに切り替え",wabisabi:"ライトモードに切り替え"}[this.currentTheme]||"ダークモードに切り替え"))(),r.addEventListener("click",()=>this.toggleTheme());const s=document.createElement("button");return s.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">⚙️</span>',s.style.cssText=this.getActionButtonStyles("icon"),s.title="サービス設定を開く",s.addEventListener("click",()=>this.openServiceModal()),o.appendChild(r),o.appendChild(s),e.appendChild(t),e.appendChild(o),this.clearBtn=n,this.historyBtn=i,this.themeToggle=r,this.settingsButton=s,e}createServiceSelectorSection(){return this.serviceSelectorContainer=document.createElement("div"),this.serviceSelectorContainer.id="service-selector",this.serviceSelectorContainer.style.cssText="\n      margin-bottom: 16px;\n      padding: 12px;\n      border-radius: 12px;\n      border: 1px solid transparent;\n      transition: background 0.3s ease, border 0.3s ease;\n    ",this.serviceSelectorStatus=document.createElement("div"),this.serviceSelectorStatus.textContent="サービス情報を読み込んでいます...",this.serviceSelectorStatus.style.fontSize="12px",this.serviceSelectorStatus.style.opacity="0.8",this.serviceSelectorStatus.style.marginBottom="8px",this.serviceSelectorContainer.appendChild(this.serviceSelectorStatus),this.serviceSelectorContent=document.createElement("div"),this.serviceSelectorContainer.appendChild(this.serviceSelectorContent),this.updateServiceSelectorTheme(),this.serviceSelectorContainer}createServiceModal(){this.serviceModalOverlay&&(this.serviceModalOverlay.remove(),this.serviceModalOverlay=null,this.serviceModal=null),this.serviceModalOverlay=document.createElement("div"),this.serviceModalOverlay.id="chocodrop-service-modal-overlay",this.serviceModalOverlay.style.cssText="\n      position: fixed;\n      inset: 0;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      backdrop-filter: blur(18px);\n      -webkit-backdrop-filter: blur(18px);\n      z-index: 2000;\n      padding: 16px !important;\n      opacity: 0;\n      transition: opacity 0.2s ease;\n    ",this.serviceModalOverlay.addEventListener("click",e=>{e.target===this.serviceModalOverlay&&this.closeServiceModal()}),this.serviceModal=document.createElement("div"),this.serviceModal.className="chocodrop-service-modal",this.serviceModal.style.cssText="\n      width: min(420px, 90vw);\n      border-radius: 24px;\n      padding: 26px 28px;\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);\n      display: flex;\n      flex-direction: column;\n      gap: 18px;\n      max-height: 90vh;\n      overflow-y: auto;\n      position: relative;\n    ";const e=document.createElement("h2");e.textContent="サービス設定",e.style.cssText="\n      margin: 0;\n      font-size: 14px;\n      font-weight: 700;\n      letter-spacing: 0.03em;\n    ";const t=document.createElement("p");t.textContent="利用するサービスを選択してください。",t.style.cssText="\n      margin: 0;\n      font-size: 12px;\n      opacity: 0.75;\n    ";const n=this.createServiceSelectorSection(),i=document.createElement("div");i.style.cssText="\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      gap: 16px;\n    ",this.serviceSelectorRetryButton=document.createElement("button"),this.serviceSelectorRetryButton.textContent="再読み込み",this.serviceSelectorRetryButton.style.cssText="\n      font-size: 11px;\n      padding: 6px 14px;\n      border-radius: 10px;\n      border: 1px solid transparent;\n      cursor: pointer;\n      display: none;\n      transition: all 0.2s ease;\n    ",this.serviceSelectorRetryButton.addEventListener("click",()=>this.initializeServiceSelector(!0));const o=document.createElement("div");o.style.cssText="display: flex; gap: 8px;",this.serviceSelectorCancelButton=document.createElement("button"),this.serviceSelectorCancelButton.textContent="Cancel",this.serviceSelectorCancelButton.style.cssText="\n      font-size: 12px;\n      padding: 8px 16px;\n      border-radius: 10px;\n      border: 1px solid rgba(255, 255, 255, 0.35);\n      background: transparent;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    ",this.serviceSelectorCancelButton.addEventListener("click",()=>this.closeServiceModal()),this.serviceSelectorSaveButton=document.createElement("button"),this.serviceSelectorSaveButton.textContent="Save",this.serviceSelectorSaveButton.style.cssText=`\n      font-size: 12px;\n      padding: 8px 18px;\n      border-radius: 10px;\n      border: none;\n      cursor: pointer;\n      background: linear-gradient(135deg, ${this.isWabiSabiMode?"#8BC34A, #689F38":"#6366f1, #8b5cf6"});\n      color: white;\n      font-weight: 600;\n      transition: all 0.2s ease;\n      box-shadow: 0 12px 24px rgba(99, 102, 241, 0.35);\n    `,this.serviceSelectorSaveButton.addEventListener("click",()=>this.handleServiceSave()),o.appendChild(this.serviceSelectorCancelButton),o.appendChild(this.serviceSelectorSaveButton),i.appendChild(this.serviceSelectorRetryButton),i.appendChild(o),this.serviceModal.appendChild(e),this.serviceModal.appendChild(t),this.serviceModal.appendChild(n),this.serviceModal.appendChild(i),this.serviceModalOverlay.appendChild(this.serviceModal),document.body.appendChild(this.serviceModalOverlay),this.updateServiceSelectorTheme(),this.toggleServiceRetryButton(!1)}openServiceModal(e=!1){this.serviceModalOverlay||this.createServiceModal(),this.serviceModalOverlay.style.display="flex",requestAnimationFrame(()=>{this.serviceModalOverlay&&(this.serviceModalOverlay.style.opacity="1")}),this.resetPendingSelections(),this.initializeServiceSelector(e)}closeServiceModal(){this.serviceModalOverlay&&(this.serviceModalOverlay.style.opacity="0",setTimeout(()=>{this.serviceModalOverlay&&(this.serviceModalOverlay.style.display="none"),this.resetPendingSelections()},150))}async initializeServiceSelector(e=!1){if(!this.servicesLoading||e){if(!this.client||"function"!=typeof this.client.getAvailableServices)return this.setServiceSelectorStatus("サービス情報を取得できませんでした（クライアント初期化待ちです）。右下の「再読み込み」で再取得できます。","error"),this.toggleServiceRetryButton(!0),void this.setServiceButtonsEnabled(!1);this.servicesLoading=!0,this.setServiceSelectorStatus("サービス情報を読み込んでいます...","info"),this.toggleServiceRetryButton(!1),this.setServiceButtonsEnabled(!1);try{"function"==typeof this.client.ensureInitialized&&await this.client.ensureInitialized();const e=await this.client.getAvailableServices();if(!e||!1===e.success||!e.metadata)throw new Error(e?.error||"サービス情報が取得できませんでした");this.availableImageServices=Array.isArray(e.metadata?.image)?e.metadata.image:[],this.availableVideoServices=Array.isArray(e.metadata?.video)?e.metadata.video:[],this.selectedImageService=this.resolveServiceSelection("image",this.availableImageServices,e.default?.image),this.selectedVideoService=this.resolveServiceSelection("video",this.availableVideoServices,e.default?.video),this.pendingImageService=this.selectedImageService,this.pendingVideoService=this.selectedVideoService,this.populateServiceSelector(),this.applyServiceSelectionToSceneManager(),this.setServiceButtonsEnabled(!0)}catch(e){console.error("❌ Failed to initialize service selector:",e),this.setServiceSelectorStatus("MCP設定が必要です。config.jsonでMCPサービスを設定してください。3000番以外のポートを使用している場合は、サーバーのCORS設定も確認してください。詳細はREADMEをご確認ください。","error"),this.toggleServiceRetryButton(!0),this.setServiceButtonsEnabled(!1)}finally{this.servicesLoading=!1}}}setServiceSelectorStatus(e,t="info"){this.serviceSelectorStatus&&(this.serviceSelectorStatus.textContent=e,this.serviceSelectorStatus.dataset.statusType=t,this.serviceSelectorStatus.classList.toggle("service-selector-helper","error"!==t),this.updateServiceSelectorTheme())}toggleServiceRetryButton(e){this.serviceSelectorRetryButton&&(this.serviceSelectorRetryButton.style.display=e?"inline-flex":"none",this.updateServiceSelectorTheme())}resolveServiceSelection(e,t,n){if(!t||0===t.length)return null;const i="image"===e?b:y;let o=null;try{o=localStorage.getItem(i)}catch(e){console.warn("⚠️ Failed to access localStorage:",e)}let r=o&&t.some(e=>e.id===o)?o:null;!r&&n&&t.some(e=>e.id===n)&&(r=n),r||(r=t[0]?.id||null);try{r?localStorage.setItem(i,r):localStorage.removeItem(i)}catch(e){console.warn("⚠️ Failed to persist service selection:",e)}return r}populateServiceSelector(){if(!this.serviceSelectorContent)return;this.serviceSelectorContent.innerHTML="";const e=this.availableImageServices.length>0,t=this.availableVideoServices.length>0;if(e||t){if(this.setServiceSelectorStatus("利用するサービスを選択してください。","info"),e){const e=this.buildServiceRow("image","画像 (T2I)",this.availableImageServices,this.pendingImageService||this.selectedImageService);this.serviceSelectorContent.appendChild(e)}if(t){const e=this.buildServiceRow("video","動画 (T2V)",this.availableVideoServices,this.pendingVideoService||this.selectedVideoService);this.serviceSelectorContent.appendChild(e)}this.updateServiceSelectorTheme()}else this.setServiceSelectorStatus("利用可能なサービスが見つかりませんでした。","error")}buildServiceRow(e,t,n,i){const o=document.createElement("div");o.className=`service-row service-row-${e}`,o.style.cssText="\n      display: flex;\n      flex-direction: column;\n      gap: 6px;\n      margin-bottom: 12px;\n    ";const r=document.createElement("label");r.textContent=t,r.style.fontSize="13px",r.style.fontWeight="600",o.appendChild(r);const a=document.createElement("select");a.dataset.serviceType=e,a.style.fontFamily="inherit",a.style.width="100%",n.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name||e.id,e.description&&(t.title=e.description),a.appendChild(t)}),i&&n.some(e=>e.id===i)&&(a.value=i),a.addEventListener("change",t=>{this.onServiceSelectionChange(e,t.target.value)}),o.appendChild(a);const s=document.createElement("div");return s.className="service-description",s.textContent=this.findServiceInfo(e,a.value)?.description||"",s.style.fontSize="11px",s.style.opacity="0.75",s.style.lineHeight="1.4",s.style.minHeight="14px",o.appendChild(s),a.addEventListener("change",()=>{s.textContent=this.findServiceInfo(e,a.value)?.description||""}),"image"===e?this.imageServiceSelect=a:this.videoServiceSelect=a,o}onServiceSelectionChange(e,t){"image"===e?this.pendingImageService=t:this.pendingVideoService=t;const n=this.findServiceInfo(e,t),i="image"===e?this.imageServiceSelect?.parentElement?.querySelector(".service-description"):this.videoServiceSelect?.parentElement?.querySelector(".service-description");i&&(i.textContent=n?.description||"")}handleServiceSave(){const e=this.pendingImageService||this.selectedImageService,t=this.pendingVideoService||this.selectedVideoService;if(e){try{localStorage.setItem(b,e)}catch(e){console.warn("⚠️ Failed to persist image service selection:",e)}this.selectedImageService=e,this.sceneManager?.setImageService(e)}if(t){try{localStorage.setItem(y,t)}catch(e){console.warn("⚠️ Failed to persist video service selection:",e)}this.selectedVideoService=t,this.sceneManager?.setVideoService(t)}const n=this.findServiceInfo("image",e),i=this.findServiceInfo("video",t);n&&this.addOutput(`🖼️ 画像サービスを「${n.name}」に設定しました`,"system"),i&&this.addOutput(`🎬 動画サービスを「${i.name}」に設定しました`,"system"),this.closeServiceModal()}setServiceButtonsEnabled(e){this.serviceSelectorSaveButton&&(this.serviceSelectorSaveButton.disabled=!e,this.serviceSelectorSaveButton.style.opacity=e?"1":"0.6",this.serviceSelectorSaveButton.style.cursor=e?"pointer":"not-allowed")}resetPendingSelections(){this.pendingImageService=this.selectedImageService,this.pendingVideoService=this.selectedVideoService,this.imageServiceSelect&&this.selectedImageService&&(this.imageServiceSelect.value=this.selectedImageService),this.videoServiceSelect&&this.selectedVideoService&&(this.videoServiceSelect.value=this.selectedVideoService),this.serviceSelectorContent&&this.serviceSelectorContent.childElementCount>0&&this.populateServiceSelector()}findServiceInfo(e,t){return("image"===e?this.availableImageServices:this.availableVideoServices).find(e=>e.id===t)||null}applyServiceSelectionToSceneManager(){this.sceneManager&&(this.sceneManager.setImageService(this.selectedImageService),this.sceneManager.setVideoService(this.selectedVideoService))}updateServiceSelectorTheme(){if(this.serviceModalOverlay&&(this.serviceModalOverlay.style.background=this.isDarkMode?"rgba(8, 11, 26, 0.55)":"rgba(229, 231, 255, 0.45)"),this.serviceModal&&(this.serviceModal.style.background=this.isDarkMode?"rgba(17, 24, 39, 0.15)":"rgba(255, 255, 255, 0.15)",this.serviceModal.style.border=this.isDarkMode?"1px solid rgba(129, 140, 248, 0.4)":"1px solid rgba(99, 102, 241, 0.25)",this.serviceModal.style.color=this.isDarkMode?"#e5e7ff":"#1f2937"),this.serviceSelectorStatus){const e=this.serviceSelectorStatus.dataset?.statusType,t="error"===e?this.isDarkMode?"#fca5a5":"#b91c1c":this.isDarkMode?"rgba(209, 213, 219, 0.8)":"rgba(55, 65, 81, 0.75)";this.serviceSelectorStatus.style.color=t}if(this.serviceSelectorContainer){this.serviceSelectorContainer.querySelectorAll("label").forEach(e=>{e.style.color=this.isWabiSabiMode?"#5D4037":this.isDarkMode?"rgba(255, 255, 255, 0.9)":"rgba(31, 41, 55, 0.9)"});this.serviceSelectorContainer.querySelectorAll("select").forEach(e=>{e.style.background=this.isWabiSabiMode?"rgba(161, 136, 127, 0.15)":this.isDarkMode?"rgba(99, 102, 241, 0.18)":"rgba(99, 102, 241, 0.12)",e.style.border=this.isWabiSabiMode?"1px solid rgba(161, 136, 127, 0.4)":this.isDarkMode?"1px solid rgba(129, 140, 248, 0.45)":"1px solid rgba(99, 102, 241, 0.45)",e.style.color=this.isWabiSabiMode?"#5D4037":this.isDarkMode?"#ffffff":"#1f2937",e.style.padding="10px 12px",e.style.borderRadius="10px",e.style.fontSize="13px",e.style.outline="none",e.style.boxShadow=this.isWabiSabiMode?"0 12px 24px rgba(93, 64, 55, 0.25)":this.isDarkMode?"0 12px 28px rgba(15, 23, 42, 0.5)":"0 12px 24px rgba(99, 102, 241, 0.2)"});this.serviceSelectorContainer.querySelectorAll(".service-description").forEach(e=>{e.style.color=this.isWabiSabiMode?"rgba(93, 64, 55, 0.7)":this.isDarkMode?"rgba(209, 213, 219, 0.8)":"rgba(55, 65, 81, 0.7)"})}this.serviceSelectorRetryButton&&(this.serviceSelectorRetryButton.style.background=this.isWabiSabiMode?"rgba(161, 136, 127, 0.25)":this.isDarkMode?"rgba(129, 140, 248, 0.35)":"rgba(99, 102, 241, 0.15)",this.serviceSelectorRetryButton.style.border=this.isWabiSabiMode?"1px solid rgba(161, 136, 127, 0.5)":this.isDarkMode?"1px solid rgba(129, 140, 248, 0.5)":"1px solid rgba(99, 102, 241, 0.45)",this.serviceSelectorRetryButton.style.color=this.isWabiSabiMode?"#5D4037":this.isDarkMode?"#f9fafb":"#1e1b4b",this.serviceSelectorRetryButton.style.boxShadow=this.isWabiSabiMode?"0 0 8px rgba(161, 136, 127, 0.4)":this.isDarkMode?"0 0 8px rgba(129, 140, 248, 0.45)":"0 0 8px rgba(99, 102, 241, 0.35)"),this.serviceSelectorCancelButton&&(this.serviceSelectorCancelButton.style.border=this.isWabiSabiMode?"1px solid rgba(161, 136, 127, 0.4)":this.isDarkMode?"1px solid rgba(209, 213, 219, 0.3)":"1px solid rgba(148, 163, 184, 0.5)",this.serviceSelectorCancelButton.style.color=this.isWabiSabiMode?"rgba(93, 64, 55, 0.85)":this.isDarkMode?"rgba(226, 232, 240, 0.85)":"rgba(30, 41, 59, 0.85)"),this.serviceSelectorSaveButton&&(this.serviceSelectorSaveButton.style.background=this.isWabiSabiMode?"linear-gradient(135deg, #6D4C41, #5D4037)":this.isDarkMode?"linear-gradient(135deg, "+(this.isWabiSabiMode?"#8BC34A, #689F38":"#6366f1, #8b5cf6")+")":"linear-gradient(135deg, #818cf8, #a855f7)",this.serviceSelectorSaveButton.style.boxShadow=this.isWabiSabiMode?"0 16px 28px rgba(93, 64, 55, 0.35)":this.isDarkMode?"0 16px 28px rgba(99, 102, 241, 0.4)":"0 16px 28px rgba(129, 140, 248, 0.35)")}createRadioModeSelector(){const e=document.createElement("div");e.className="radio-mode-selector",e.style.cssText=`\n      display: grid;\n      grid-template-columns: repeat(4, 1fr);\n      gap: 8px;\n      margin-bottom: 12px;\n      padding: 12px;\n      background: ${this.isWabiSabiMode?"linear-gradient(135deg, rgba(158, 158, 158, 0.25), rgba(189, 189, 189, 0.2))":this.isDarkMode?"linear-gradient(135deg, rgba(30, 27, 75, 0.3), rgba(15, 23, 42, 0.4))":"linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1))"};\n      border: 1px solid ${this.isWabiSabiMode?"rgba(141, 110, 99, 0.4)":this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(255, 255, 255, 0.25)"};\n      border-radius: 16px;\n      backdrop-filter: blur(12px);\n      transition: all 0.3s ease;\n      position: relative;\n    `;return this.radioModeButtons={},[{value:"generate",label:"Generate",icon:"✨"},{value:"import",label:"Import",icon:"📥"},{value:"modify",label:"Modify",icon:"🔧"},{value:"delete",label:"Delete",icon:"🗑️"}].forEach(t=>{const n=document.createElement("div");n.className=`mode-option ${t.value}`,n.style.cssText=`\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 4px;\n        padding: 10px 8px;\n        border-radius: 12px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        font-size: 11px;\n        font-weight: 600;\n        text-align: center;\n        color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(55, 65, 81, 0.8)"};\n        background: transparent;\n        border: 1px solid transparent;\n        position: relative;\n      `;const i=document.createElement("div");i.textContent=t.icon,i.style.cssText=`\n        font-size: 12px;\n        margin-bottom: 2px;\n        filter: ${this.isDarkMode?"hue-rotate(220deg) saturate(0.8) brightness(1.2)":"hue-rotate(240deg) saturate(0.7) brightness(0.9)"};\n        transition: filter 0.2s ease;\n      `;const o=document.createElement("span");o.textContent=t.label;const r=document.createElement("div");r.className="auto-badge",r.textContent="AUTO",r.style.cssText="\n        position: absolute;\n        top: -4px;\n        right: -4px;\n        font-size: 7px;\n        font-weight: 700;\n        padding: 2px 4px;\n        background: linear-gradient(135deg, #10b981, #059669);\n        color: white;\n        border-radius: 6px;\n        opacity: 0;\n        transform: scale(0.8);\n        transition: all 0.2s ease;\n        display: none;\n      ",n.appendChild(i),n.appendChild(o),n.appendChild(r),n.addEventListener("click",()=>{"import"===t.value?this.triggerFileSelection():this.selectMode(t.value,!0)}),this.radioModeButtons[t.value]={button:n,autoBadge:r},e.appendChild(n)}),this.radioModeContainer=e,this.selectMode("generate",!1),e}selectMode(e,t=!1,n=null){this.currentMode=e,Object.keys(this.radioModeButtons).forEach(e=>{const{button:t,autoBadge:n}=this.radioModeButtons[e];t.style.color=this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(55, 65, 81, 0.8)",t.style.background="transparent",t.style.border="1px solid transparent",t.style.transform="scale(1)",t.style.boxShadow="none",n.style.display="none",n.style.opacity="0"});const{button:i,autoBadge:o}=this.radioModeButtons[e],r=this.isWabiSabiMode?{background:"linear-gradient(135deg, rgba(109, 76, 65, 0.2), rgba(141, 110, 99, 0.15))",border:"1px solid rgba(109, 76, 65, 0.4)",boxShadow:"0 4px 16px rgba(109, 76, 65, 0.25), inset 0 1px 0 rgba(245, 245, 220, 0.15)",color:"#F5F5F5"}:this.isDarkMode?{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15))",border:"1px solid rgba(99, 102, 241, 0.4)",boxShadow:"0 4px 16px rgba(99, 102, 241, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1)",color:"#a5b4fc"}:{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.08))",border:"1px solid rgba(99, 102, 241, 0.3)",boxShadow:"0 4px 16px rgba(99, 102, 241, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2)",color:this.isWabiSabiMode?"#8BC34A":"#6366f1"};i.style.color=r.color,i.style.background=r.background,i.style.border=r.border,i.style.boxShadow=r.boxShadow,i.style.transform="scale(1.02)",!t&&n&&(o.style.display="inline-block",setTimeout(()=>{o.style.opacity="1",o.style.transform="scale(1)"},100),setTimeout(()=>{o.style.opacity="0",o.style.transform="scale(0.8)",setTimeout(()=>{o.style.display="none"},200)},3e3)),t||"import"===e?"import"===e&&this.addContainerGlow(e):(this.addPulseEffect(i),this.addContainerGlow(e)),this.input.placeholder=this.getPlaceholderForMode(e),t&&this.clearInputOnModeSwitch(e),"import"===e||this.selectedFile?this.showImportInterface():this.hideImportInterface(),"delete"===e&&t&&this.handleDeleteModeSelection(),"modify"===e&&t&&this.handleModifyModeSelection()}addPulseEffect(e){e.style.animation="none",setTimeout(()=>{e.style.animation="smartModePulse 0.6s ease-out"},10),setTimeout(()=>{e.style.animation=""},610),this.ensurePulseAnimation()}ensurePulseAnimation(){if(document.getElementById("smart-mode-pulse-animation"))return;const e=document.createElement("style");e.id="smart-mode-pulse-animation",e.textContent="\n      @keyframes smartModePulse {\n        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }\n        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }\n        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }\n      }\n    ",document.head.appendChild(e)}addContainerGlow(e){const t=this.radioModeContainer;if(!t)return;const n=this.isWabiSabiMode?{generate:"rgba(139, 195, 74, 0.4)",modify:"rgba(139, 195, 74, 0.4)",delete:"rgba(139, 195, 74, 0.4)",import:"rgba(139, 195, 74, 0.4)"}:{generate:"rgba(79, 70, 229, 0.4)",modify:"rgba(236, 72, 153, 0.4)",delete:"rgba(107, 114, 128, 0.3)",import:"rgba(59, 130, 246, 0.35)"},i=n[e]||n.generate;t.style.boxShadow=`0 0 20px ${i}, 0 0 40px ${i}`;const o=i.replace("0.4","0.6").replace("0.3","0.5");t.style.borderColor=o!==i?o:i,setTimeout(()=>{t.style.boxShadow="",t.style.borderColor=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.15)"},1e3)}getActionButtonStyles(e="secondary"){const t="\n      border: none;\n      border-radius: 10px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n      font-weight: 500;\n      backdrop-filter: blur(8px);\n      -webkit-backdrop-filter: blur(8px);\n    ";return"secondary"===e?t+`\n        width: 90px;\n        height: 36px;\n        padding: 8px 12px;\n        font-size: 12px;\n        font-weight: 600;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n        background: ${this.isWabiSabiMode?"linear-gradient(135deg, rgba(141, 110, 99, 0.3), rgba(109, 76, 65, 0.2))":this.isDarkMode?"linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2))":"linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))"};\n        border: 1px solid ${this.isWabiSabiMode?"rgba(93, 64, 55, 0.6)":this.isDarkMode?"rgba(156, 163, 175, 0.2)":"rgba(255, 255, 255, 0.3)"};\n        color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#d1d5db":"#374151"};\n        text-align: center;\n        white-space: nowrap;\n      `:"icon"===e?t+`\n        width: 32px;\n        height: 32px;\n        padding: 0;\n        font-size: 14px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: ${this.isDarkMode?"linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1))":"linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))"};\n        border: 1px solid ${this.isDarkMode?"rgba(99, 102, 241, 0.2)":"rgba(255, 255, 255, 0.4)"};\n        color: ${this.isDarkMode?"#a5b4fc":"#6366f1"};\n      `:void 0}getDestructiveButtonStyles(){return`\n      min-width: 50px;\n      height: 32px;\n      border: 1px solid ${this.isDarkMode?"rgba(220, 38, 127, 0.4)":"rgba(190, 24, 93, 0.35)"};\n      border-radius: 6px;\n      background: ${this.isDarkMode?"rgba(220, 38, 127, 0.3)":"rgba(190, 24, 93, 0.25)"};\n      color: ${this.isDarkMode?"#fca5a5":"#dc2626"};\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n      font-size: 11px;\n      font-weight: 500;\n      padding: 0 8px;\n      backdrop-filter: blur(10px);\n      -webkit-backdrop-filter: blur(10px);\n    `}getCommandTypeIndicatorStyles(){return`\n      padding: 4px 0;\n      margin-bottom: 0;\n      font-size: 11px;\n      font-weight: 400;\n      text-align: left;\n      color: ${this.isDarkMode?"rgba(255, 255, 255, 0.6)":"rgba(0, 0, 0, 0.6)"};\n      transition: all 0.3s ease;\n      border: none;\n      background: none;\n    `}autoResizeTextarea(){this.input.style.height="auto";const e=Math.min(this.input.scrollHeight,72);this.input.style.height=e+"px",this.input.scrollHeight>72?(this.input.style.overflowY="auto",this.expandButton&&(this.expandButton.style.display="flex")):(this.input.style.overflowY="hidden",this.expandButton&&(this.expandButton.style.display="none"))}detectCommandType(){const e=this.input.value.trim();if(!e)return void this.selectMode("generate",!1);const t=this.analyzeCommandType(e);"delete"!==this.currentMode&&"modify"!==this.currentMode&&this.selectMode(t.type,!1,t.detectedKeyword)}analyzeCommandType(e,t){const n=e.trim();if(this.logDebug(`🔍 Analyzing command: "${e}"`),this.logDebug("📋 Selected object: "+(t?"Yes":"No")),!n)return{type:"empty",reason:"空のコマンド"};const i=this.detectMediaType(e),o=[{pattern:/削除/,keyword:"削除"},{pattern:/消去/,keyword:"消去"},{pattern:/消して/,keyword:"消して"},{pattern:/消す/,keyword:"消す"},{pattern:/取り除/,keyword:"取り除"},{pattern:/除去/,keyword:"除去"},{pattern:/削除して/,keyword:"削除して"},{pattern:/delete/i,keyword:"delete"},{pattern:/remove/i,keyword:"remove"},{pattern:/clear/i,keyword:"clear"},{pattern:/erase/i,keyword:"erase"}];for(const{pattern:t,keyword:n}of o)if(t.test(e))return this.logDebug(`✅ Delete pattern matched: ${n}`),{type:"delete",confidence:.9,reason:"削除キーワードを検出",mediaType:i.type,requiresConfirmation:!0,detectedKeyword:n,needsTarget:!0};const r=[{pattern:/作って/,keyword:"作って"},{pattern:/つくって/,keyword:"つくって"},{pattern:/生成/,keyword:"生成"},{pattern:/作成/,keyword:"作成"},{pattern:/描いて/,keyword:"描いて"},{pattern:/書いて/,keyword:"書いて"},{pattern:/create/i,keyword:"create"},{pattern:/generate/i,keyword:"generate"},{pattern:/make/i,keyword:"make"},{pattern:/draw/i,keyword:"draw"}];for(const{pattern:t,keyword:n}of r)if(t.test(e))return this.logDebug(`✅ Generate pattern matched: ${n}`),{type:"generate",confidence:i.confidence,reason:"生成キーワードを検出",mediaType:i.type,requiresConfirmation:!1,detectedKeyword:n,needsTarget:!1};const a=[/インポートした.*を/,/選択した.*を/,/この.*を/,/その.*を/,/あの.*を/,/[0-9]+番目.*を/,/最初.*を/,/初回.*を/,/生成した.*を/,/作った.*を/,/.+の(画像|写真|イメージ|絵|イラスト|ピクチャー)(を|に)/,/.+の(動画|ビデオ|ムービー|映像|クリップ)(を|に)/,/(.+?)(画像|写真|イメージ|絵|イラスト|ピクチャー)を.*(変えて|変更|にして|加工|編集|調整|塗り|並べ|移動|回転|反転|整列)/,/(.+?)(動画|ビデオ|ムービー|映像|クリップ)を.*(変えて|変更|にして|加工|編集|調整|塗り|並べ|移動|回転|反転|整列)/].some(t=>t.test(e));if(a)return this.logDebug("✅ Target reference pattern matched"),{type:"modify",confidence:.9,reason:"対象を明示的に指定",mediaType:i.type,requiresConfirmation:!1,needsTarget:!0,hasExplicitTarget:!0};if(t&&n&&!/の画像|の動画|画像を|動画を|画像$|動画$/.test(e))return this.logDebug("✅ Selected object + command = modify"),{type:"modify",confidence:.8,reason:"選択オブジェクトに対する変更",mediaType:i.type,requiresConfirmation:!1,needsTarget:!1};const s=/(画像|写真|イメージ|絵|イラスト|ピクチャー|メディア|素材|動画|ビデオ|ムービー|映像|クリップ|オブジェクト|モデル)/i;return/(にして|に変えて|へ変えて|へ変更|変えて|変更|調整|加工|編集|塗(って|り)|染め|彩色|彩度|明るく|暗く|薄く|濃く|ぼかし|シャープ|左右反転|上下反転|反転|回転|移動|並べ|整列|揃え|寄せて|拡大|縮小|大きく|小さく|伸ばして|縮めて|高く|低く|近づけ|遠ざけ|透明|半透明|不透明|透過|背景を透過|背景透過|背景を消|背景消|背景抜|輝かせて|光らせて|暗くして|焼き込み|焼き付け|flip|rotate|move|align|scale|resize|tint|color|brighten|darken|adjust|edit|modify)/i.test(e)?(this.logDebug("✅ Modification indicators detected"),{type:"modify",confidence:.7,reason:"変更キーワードを検出",mediaType:i.type,requiresConfirmation:!1,needsTarget:!t,hasExplicitTarget:a||s.test(e)}):(this.logDebug("ℹ️ Defaulting to generate mode"),{type:"generate",confidence:i.confidence,reason:"デフォルト動作（新規生成）",mediaType:i.type,requiresConfirmation:!1,needsTarget:!1})}getAllCommandKeywords(){return[{pattern:/削除/,keyword:"削除",type:"delete"},{pattern:/消去/,keyword:"消去",type:"delete"},{pattern:/消して/,keyword:"消して",type:"delete"},{pattern:/消す/,keyword:"消す",type:"delete"},{pattern:/取り除/,keyword:"取り除",type:"delete"},{pattern:/除去/,keyword:"除去",type:"delete"},{pattern:/削除して/,keyword:"削除して",type:"delete"},{pattern:/delete/i,keyword:"delete",type:"delete"},{pattern:/remove/i,keyword:"remove",type:"delete"},{pattern:/clear/i,keyword:"clear",type:"delete"},{pattern:/erase/i,keyword:"erase",type:"delete"},{pattern:/移動/,keyword:"移動",type:"modify"},{pattern:/動かして/,keyword:"動かして",type:"modify"},{pattern:/変更/,keyword:"変更",type:"modify"},{pattern:/変えて/,keyword:"変えて",type:"modify"},{pattern:/修正/,keyword:"修正",type:"modify"},{pattern:/調整/,keyword:"調整",type:"modify"},{pattern:/move/i,keyword:"move",type:"modify"},{pattern:/change/i,keyword:"change",type:"modify"},{pattern:/modify/i,keyword:"modify",type:"modify"},{pattern:/edit/i,keyword:"edit",type:"modify"},{pattern:/作って/,keyword:"作って",type:"generate"},{pattern:/生成/,keyword:"生成",type:"generate"},{pattern:/作成/,keyword:"作成",type:"generate"},{pattern:/描いて/,keyword:"描いて",type:"generate"},{pattern:/書いて/,keyword:"書いて",type:"generate"},{pattern:/create/i,keyword:"create",type:"generate"},{pattern:/generate/i,keyword:"generate",type:"generate"},{pattern:/make/i,keyword:"make",type:"generate"},{pattern:/draw/i,keyword:"draw",type:"generate"}]}applyKeywordHighlighting(){}createHighlightOverlay(e,t){this.clearKeywordHighlighting(),this.highlightOverlay=document.createElement("div"),this.highlightOverlay.className="keyword-highlight-overlay";const n=window.getComputedStyle(this.input);this.inputDefaultStyles||this.captureInputDefaultStyles(),this.highlightOverlay.style.cssText=`\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      white-space: pre-wrap;\n      word-wrap: break-word;\n      overflow: hidden;\n      font-family: ${n.fontFamily};\n      font-size: ${n.fontSize};\n      font-weight: ${n.fontWeight};\n      line-height: ${n.lineHeight};\n      letter-spacing: ${n.letterSpacing};\n      padding: ${n.padding};\n      border: ${n.borderWidth} solid transparent;\n      margin: 0;\n      z-index: 1;\n      color: transparent;\n      background: transparent;\n    `;let i="",o=0;for(const n of t){i+=this.escapeHtml(e.substring(o,n.start));const t=this.getKeywordColor(n.type);i+=`<span style="color: ${t}; font-weight: 600; background: linear-gradient(135deg, ${t}22 0%, ${t}11 100%); border-radius: 3px; padding: 1px 2px;">${this.escapeHtml(n.keyword)}</span>`,o=n.end}i+=this.escapeHtml(e.substring(o)),this.highlightOverlay.innerHTML=i,this.input.style.background="transparent",this.input.style.backgroundColor="transparent",this.input.style.backgroundImage="none",this.input.style.color=this.getInputTextColor(),this.inputWrapper.insertBefore(this.highlightOverlay,this.input)}getKeywordColor(e){return"#ff6ad5"}getInputTextColor(){return this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937"}captureInputDefaultStyles(){if(!this.input)return;const e=window.getComputedStyle(this.input);this.inputDefaultStyles={background:e.background,backgroundImage:e.backgroundImage,backgroundColor:e.backgroundColor,color:e.color}}clearKeywordHighlighting(){this.highlightOverlay&&(this.highlightOverlay.remove(),this.highlightOverlay=null),this.input&&(this.inputDefaultStyles?(this.input.style.background=this.inputDefaultStyles.background,this.input.style.backgroundImage=this.inputDefaultStyles.backgroundImage,this.input.style.backgroundColor=this.inputDefaultStyles.backgroundColor,this.input.style.color=this.inputDefaultStyles.color):(this.input.style.background="",this.input.style.backgroundImage="",this.input.style.backgroundColor="",this.input.style.color=""))}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}detectMediaType(e){return[/動画|ビデオ|映像|ムービー/,/video|movie|clip/i].some(t=>t.test(e))?{type:"video",confidence:.8,reason:"動画生成コマンド"}:[/画像|写真|絵|イラスト|イメージ/,/image|picture|photo|illustration/i].some(t=>t.test(e))?{type:"image",confidence:.8,reason:"画像生成コマンド"}:{type:"image",confidence:.6,reason:"生成コマンド（画像デフォルト）"}}showCommandTypeIndicator(e){const{type:t,confidence:n,reason:i}=e;n<.7?this.showProactiveSuggestion(t,n):this.hideProactiveSuggestion(),this.enableGestureControl()}showProactiveSuggestion(e,t){this.proactiveSuggestion||(this.proactiveSuggestion=document.createElement("div"),this.proactiveSuggestion.id="proactive-suggestion",this.proactiveSuggestion.style.cssText="\n        margin-bottom: 0;\n        padding: 10px;\n        background: rgba(255, 193, 7, 0.15);\n        border: 1px solid rgba(255, 193, 7, 0.3);\n        border-radius: 8px;\n        font-size: 12px;\n        color: #ffc107;\n        text-align: center;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      ",this.container.insertBefore(this.proactiveSuggestion,this.input));const n=["generate","modify","delete"].filter(t=>t!==e)[0];this.proactiveSuggestion.innerHTML=`\n      💡 もしかして「${{generate:"🎨 生成",modify:"✏️ 変更",delete:"🗑️ 削除"}[n]}モード」ですか？\n      <div style="margin-top: 4px; font-size: 10px; opacity: 0.8;">\n        クリックで変更 | スワイプで選択\n      </div>\n    `,this.proactiveSuggestion.style.display="block",this.proactiveSuggestion.onclick=()=>{this.currentMode=n,this.hideProactiveSuggestion(),this.updateIndicatorForMode(n,.9)}}hideProactiveSuggestion(){this.proactiveSuggestion&&(this.proactiveSuggestion.style.display="none")}updateIndicatorForMode(e,t){}enableGestureControl(){this.gestureEnabled=!0}createActionButtons(){const e=document.createElement("div");e.style.cssText="\n      display: flex;\n      margin-top: 8px;\n      gap: 8px;\n    ";const t=document.createElement("button");return t.innerHTML="🧹 全削除",t.style.cssText=this.getModernButtonStyles("danger"),t.addEventListener("click",()=>this.clearAll()),e.appendChild(t),e}getContainerStyles(){const e={"bottom-right":"bottom: 20px; right: 20px;","bottom-left":"bottom: 20px; left: 20px;","top-right":"top: 20px; right: 20px;","top-left":"top: 20px; left: 20px;",center:"top: 50%; left: 50%; transform: translate(-50%, -50%);"},t=this.isWabiSabiMode?{background:"linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))",backdropFilter:"blur(20px) saturate(120%)",border:"1px solid rgba(93, 64, 55, 0.5)",boxShadow:"0 8px 32px rgba(33, 33, 33, 0.4), 0 0 0 1px rgba(93, 64, 55, 0.4), inset 0 1px 0 rgba(189, 189, 189, 0.15)"}:this.isDarkMode?{background:"linear-gradient(135deg, rgba(15, 23, 42, 0.7), rgba(30, 27, 75, 0.65))",backdropFilter:"blur(24px) saturate(180%)",border:"1px solid rgba(99, 102, 241, 0.2)",boxShadow:"0 8px 32px rgba(15, 23, 42, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1)"}:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))",backdropFilter:"blur(24px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.4)",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3)"};return`\n      position: fixed;\n      ${e[this.config.position]||e["bottom-right"]}\n      width: 320px;\n      max-height: ${this.config.maxHeight}px;\n      background: ${t.background};\n      border: ${t.border};\n      border-radius: 20px;\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;\n      font-size: 14px;\n      z-index: 1000;\n      padding: 16px !important;\n      box-shadow: ${t.boxShadow};\n      backdrop-filter: ${t.backdropFilter};\n      -webkit-backdrop-filter: ${t.backdropFilter};\n      display: none;\n      flex-direction: column;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    `}getHeaderStyles(){return"\n      margin-bottom: 20px;\n      text-align: center;\n      background: linear-gradient(135deg, #4f46e5, #7c3aed);\n      -webkit-background-clip: text;\n      -webkit-text-fill-color: transparent;\n      background-clip: text;\n      font-weight: 800;\n      font-size: 14px;\n      border-bottom: 1px solid rgba(79, 70, 229, 0.2);\n      padding-bottom: 12px;\n    "}getOutputStyles(){return this.addScrollbarStyles(),`\n      height: 200px;\n      overflow-y: auto;\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.05)":"rgba(255, 255, 255, 0.1)"};\n      border: 1px solid ${this.isDarkMode?"rgba(255, 255, 255, 0.15)":"rgba(255, 255, 255, 0.2)"};\n      border-radius: 12px;\n      padding: 12px;\n      margin-bottom: 16px;\n      font-size: 12px;\n      line-height: 1.4;\n      backdrop-filter: blur(8px);\n\n      /* カスタムスクロールバーのスタイル */\n      scrollbar-width: thin;\n      scrollbar-color: ${this.isDarkMode?"rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.3) rgba(0, 0, 0, 0.1)"};\n    `}addScrollbarStyles(){if(document.getElementById("custom-scrollbar-styles"))return;const e=document.createElement("style");e.id="custom-scrollbar-styles",e.textContent=`\n      .command-output::-webkit-scrollbar {\n        width: 8px;\n      }\n\n      .command-output::-webkit-scrollbar-track {\n        background: ${this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"};\n        border-radius: 4px;\n      }\n\n      .command-output::-webkit-scrollbar-thumb {\n        background: ${this.isDarkMode?"rgba(255, 255, 255, 0.3)":"rgba(0, 0, 0, 0.3)"};\n        border-radius: 4px;\n        transition: background 0.2s ease;\n      }\n\n      .command-output::-webkit-scrollbar-thumb:hover {\n        background: ${this.isDarkMode?"rgba(255, 255, 255, 0.5)":"rgba(0, 0, 0, 0.5)"};\n      }\n\n      /* ダークモード用 */\n      .dark-mode .command-output::-webkit-scrollbar-track {\n        background: rgba(255, 255, 255, 0.1);\n      }\n\n      .dark-mode .command-output::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      .dark-mode .command-output::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.5);\n      }\n\n      /* ライトモード用 */\n      .light-mode .command-output::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.1);\n      }\n\n      .light-mode .command-output::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      .light-mode .command-output::-webkit-scrollbar-thumb:hover {\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      @keyframes shimmer {\n        0% { background-position: -200% 0; }\n        100% { background-position: 200% 0; }\n      }\n\n      /* 2025年トレンド: 微細な浮遊感アニメーション */\n      @keyframes gentleFloat {\n        0%, 100% { \n          transform: translateY(0px) scale(1);\n        }\n        25% { \n          transform: translateY(-2px) scale(1.005);\n        }\n        50% { \n          transform: translateY(-1px) scale(1.002);\n        }\n        75% { \n          transform: translateY(-3px) scale(1.008);\n        }\n      }\n\n      /* タスクステータスコンテナのホバー効果 */\n      .task-status-container:hover .progress-bar {\n        box-shadow: 0 0 20px rgba(255,123,71,0.6) !important;\n        transform: scaleY(1.1);\n      }\n\n      /* プログレスバーの微細なアニメーション */\n      .progress-bar {\n        position: relative;\n      }\n\n      .progress-bar::after {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: linear-gradient(90deg, \n          transparent, \n          rgba(255,255,255,0.4), \n          transparent);\n        animation: progress-shine 2s ease-in-out infinite;\n      }\n\n      @keyframes progress-shine {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(100%); }\n      }\n    `,document.head.appendChild(e)}getInputStyles(){const e=this.isWabiSabiMode?{background:"linear-gradient(135deg, rgba(97, 97, 97, 0.4), rgba(66, 66, 66, 0.3))",border:"1px solid rgba(97, 97, 97, 0.5)",boxShadow:"0 4px 16px rgba(66, 66, 66, 0.3), inset 0 1px 0 rgba(189, 189, 189, 0.2)"}:this.isDarkMode?{background:"linear-gradient(135deg, rgba(30, 27, 75, 0.4), rgba(15, 23, 42, 0.5))",border:"1px solid rgba(99, 102, 241, 0.25)",boxShadow:"0 4px 16px rgba(15, 23, 42, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08)"}:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))",border:"1px solid rgba(255, 255, 255, 0.5)",boxShadow:"0 4px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.4)"};return`\n      width: 100%;\n      padding: 14px 16px;\n      background: ${e.background};\n      border: ${e.border};\n      border-radius: 14px;\n      color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937"};\n      font-size: 14px;\n      outline: none;\n      box-sizing: border-box;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      font-family: inherit;\n      backdrop-filter: blur(16px);\n      -webkit-backdrop-filter: blur(16px);\n      box-shadow: ${e.boxShadow};\n      placeholder-color: ${this.isDarkMode?"rgba(255, 255, 255, 0.5)":"rgba(55, 65, 81, 0.6)"};\n      resize: none;\n      overflow-y: hidden;\n      min-height: 22px;\n      max-height: 66px;\n      line-height: 22px;\n    `}getModernButtonStyles(e){return`\n      border: none;\n      border-radius: 12px;\n      color: white;\n      cursor: pointer;\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      font-family: inherit;\n      outline: none;\n      ${{primary:this.isWabiSabiMode?"\n        background: linear-gradient(135deg, #8D6E63, #6D4C41);\n        box-shadow: 0 4px 12px rgba(85, 139, 47, 0.4), inset 0 1px 0 rgba(184, 158, 135, 0.15);\n        width: 100%;\n        padding: 16px;\n        font-size: 14px;\n        font-weight: 600;\n      ":"\n        background: linear-gradient(135deg, #4f46e5, #4338ca);\n        width: 100%;\n        padding: 16px;\n        font-size: 14px;\n        font-weight: 600;\n      ",secondary:this.isWabiSabiMode?"\n        background: rgba(158, 158, 158, 0.2);\n        border: 1px solid rgba(141, 110, 99, 0.4);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #F5F5F5;\n      ":"\n        background: rgba(255, 255, 255, 0.08);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n      ",danger:this.isWabiSabiMode?"\n        background: rgba(141, 110, 99, 0.3);\n        border: 1px solid rgba(93, 64, 55, 0.5);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #F5F5F5;\n      ":"\n        background: rgba(255, 59, 48, 0.15);\n        border: 1px solid rgba(255, 59, 48, 0.3);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #ff453a;\n      "}[e]}\n    `}getModeButtonStyles(e,t){return`\n      flex: 1;\n      padding: 12px 16px;\n      border: none;\n      border-radius: 8px;\n      color: ${e?"white":"rgba(255, 255, 255, 0.7)"};\n      background: ${e?{generate:"linear-gradient(135deg, #22c55e, #16a34a)",modify:"linear-gradient(135deg, #22c55e, #16a34a)",delete:"linear-gradient(135deg, #22c55e, #16a34a)"}[t]:"transparent"};\n      font-size: 13px;\n      font-weight: 600;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n    `}bindEvents(){document.addEventListener("keydown",e=>{if(e.key===this.config.activationKey)return e.preventDefault(),void this.toggle();this.isVisible&&"Escape"===e.key&&this.hide(),this.isVisible&&e.ctrlKey&&("z"!==e.key||e.shiftKey?("y"===e.key||"z"===e.key&&e.shiftKey)&&(e.preventDefault(),this.redo()):(e.preventDefault(),this.undo()))}),this.input.addEventListener("focus",()=>{this.isWabiSabiMode?(this.input.style.borderColor="#8BC34A",this.input.style.boxShadow="0 0 5px rgba(139, 195, 74, 0.5)"):(this.input.style.borderColor="#74b9ff",this.input.style.boxShadow="0 0 5px rgba(116, 185, 255, 0.5)")}),this.input.addEventListener("blur",()=>{this.isWabiSabiMode?(this.input.style.borderColor="#8D6E63",this.input.style.boxShadow="none"):(this.input.style.borderColor="#4a90e2",this.input.style.boxShadow="none")})}toggle(){this.isVisible?this.hide():this.show()}show(){this.container.style.display="flex",this.container.style.flexDirection="column",this.floatingContainer.style.display="flex",setTimeout(()=>{const e=this.container.getBoundingClientRect();this.floatingContainer.style.left=e.left+"px",this.floatingContainer.style.top=e.top-80+"px",this.floatingContainer.style.width=e.width+"px",this.floatingContainer.style.transform="none"},50),this.isVisible=!0,this.input.focus(),this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.opacity="0",this.floatingChocolateIcon.style.pointerEvents="none"),this.onControlsToggle(!0)}hide(){this.container.style.display="none",this.floatingContainer.style.display="none",this.isVisible=!1,this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.opacity="0.8",this.floatingChocolateIcon.style.pointerEvents="auto"),this.onControlsToggle(!1),this.logDebug("🎮 コントロールを再開")}switchMode(e){if(this.currentMode===e)return;this.currentMode=e,this.container.querySelectorAll("[data-mode]").forEach(t=>{const n=t.dataset.mode===e;t.style.cssText=this.getModeButtonStyles(n,t.dataset.mode)}),this.input.placeholder=this.getPlaceholderForMode(e);const t=this.container.querySelector("#execute-btn");t.innerHTML=`<span>${{generate:"🎨 Generate Object",modify:"✏️ Apply Changes",delete:"🗑️ Delete Objects"}[e]}</span>`,t.style.background={generate:"linear-gradient(135deg, #5b21b6, #4c1d95)",modify:"linear-gradient(135deg, #ec4899, #be185d)",delete:"rgba(107, 114, 128, 0.15)"}[e]}getPlaceholderForMode(e){const t={generate:"「猫の画像を作って」と話しかけて ⏎ ✨",import:"ファイルを選択して ⏎ 📁",modify:"選択後「透明に変更」と伝えて ⏎ ✏️",delete:"選択後、コマンドをそのまま送って ⏎ 🗑️"};return t[e]||t.generate}async executeCommand(e=null){const t=e||this.input.value.replace(/\s*⏎\s*/g,"").trim();if(!t)return;const n=await this.preValidateCommand(t);n.canExecute&&await this.proceedWithExecution(t,n.commandType)}async showConfirmationDialog(e){const{icon:t="🗑️",title:n="確認",message:i="この操作を実行しますか？",confirmText:o="実行",cancelText:r="キャンセル",confirmColor:a="#ef4444"}=e;return new Promise(e=>{const s=document.createElement("div");s.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(15, 23, 42, 0.6);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        z-index: 2000;\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n      ";const l=document.createElement("div");l.style.cssText=`\n        background: ${this.isWabiSabiMode?"linear-gradient(135deg, rgba(239, 235, 233, 0.4), rgba(215, 204, 200, 0.3))":this.isDarkMode?"linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(30, 27, 75, 0.8))":"linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3))"};\n        border: 1px solid ${this.isWabiSabiMode?"rgba(161, 136, 127, 0.4)":this.isDarkMode?"rgba(99, 102, 241, 0.3)":"rgba(255, 255, 255, 0.5)"};\n        border-radius: 20px;\n        padding: 32px;\n        max-width: 420px;\n        text-align: center;\n        color: ${this.isWabiSabiMode?"#5D4037":this.isDarkMode?"#ffffff":"#1f2937"};\n        font-family: inherit;\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n        box-shadow: ${this.isWabiSabiMode?"0 8px 32px rgba(93, 64, 55, 0.2), 0 0 0 1px rgba(161, 136, 127, 0.2)":this.isDarkMode?"0 8px 32px rgba(15, 23, 42, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1)":"0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2)"};\n        transform: scale(0.9);\n        opacity: 0;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      `,l.innerHTML=`\n        <div style="font-size: 56px; margin-bottom: 20px;">${t}</div>\n        <h3 style="margin: 0 0 16px 0; color: ${this.isDarkMode?"#a5b4fc":"#6366f1"}; font-size: 20px; font-weight: 700; letter-spacing: 0.02em;">\n          ${n}\n        </h3>\n        <p style="margin: 0 0 28px 0; color: ${this.isDarkMode?"#d1d5db":"#6b7280"}; line-height: 1.6; font-size: 12px;">\n          ${i}\n        </p>\n        <div style="display: flex; gap: 8px; justify-content: center;">\n          <button id="cancel-btn" style="\n            padding: 14px 24px;\n            background: ${this.isDarkMode?"linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2))":"linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))"};\n            border: 1px solid ${this.isDarkMode?"rgba(156, 163, 175, 0.2)":"rgba(255, 255, 255, 0.3)"};\n            border-radius: 12px;\n            color: ${this.isDarkMode?"#d1d5db":"#374151"};\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 600;\n            transition: all 0.2s ease;\n            backdrop-filter: blur(16px);\n            -webkit-backdrop-filter: blur(16px);\n          ">${r}</button>\n          <button id="confirm-btn" style="\n            padding: 14px 24px;\n            background: ${a===(this.isWabiSabiMode?"#8BC34A":"#6366f1")?"linear-gradient(135deg, "+(this.isWabiSabiMode?"#8BC34A, #689F38":"#6366f1, #8b5cf6")+")":"#ef4444"===a?"linear-gradient(135deg, #ef4444, #dc2626)":"linear-gradient(135deg, #ff7b47, #f97316)"};\n            border: none;\n            border-radius: 12px;\n            color: white;\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 700;\n            transition: all 0.2s ease;\n            box-shadow: 0 4px 16px ${a===(this.isWabiSabiMode?"#8BC34A":"#6366f1")?"rgba(99, 102, 241, 0.3)":"#ef4444"===a?"rgba(239, 68, 68, 0.3)":"rgba(255, 123, 71, 0.3)"};\n            backdrop-filter: blur(8px);\n            -webkit-backdrop-filter: blur(8px);\n          ">${o}</button>\n        </div>\n      `,s.appendChild(l),document.body.appendChild(s),requestAnimationFrame(()=>{s.style.opacity="1",l.style.transform="scale(1)",l.style.opacity="1"}),l.querySelector("#cancel-btn").onclick=t=>{t.stopPropagation(),t.preventDefault(),this.closeModalWithAnimation(s),e(!1)},l.querySelector("#confirm-btn").onclick=t=>{t.stopPropagation(),t.preventDefault(),this.closeModalWithAnimation(s),e(!0)};const c=t=>{"Escape"===t.key&&(this.closeModalWithAnimation(s),document.removeEventListener("keydown",c),e(!1))};document.addEventListener("keydown",c),s.onclick=t=>{t.stopPropagation(),t.target===s&&(this.closeModalWithAnimation(s),e(!1))},l.onclick=e=>{e.stopPropagation()}})}async showDeleteConfirmation(e){return this.showConfirmationDialog({icon:"🗑️",title:"削除の確認",message:`「${e}」を実行しますか？<br>この操作は取り消すことができません。`,confirmText:"削除実行",cancelText:"キャンセル",confirmColor:"#ff7b47"})}addOutput(e,t="default",n={}){if("task"===t||"progress"===t)return this.addTaskCard(e,n);"error"!==t&&"system"!==t||this.addSystemMessage(e,t)}addTaskCard(e,t={}){this.taskCards||(this.taskCards=new Map);const n=t.taskId||`task_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,i=t.status||"pending",o=e.prompt||e.command||e,r=document.createElement("div");r.className="floating-task-card",r.setAttribute("data-task-id",n),"pending"!==i&&"processing"!==i&&"progress"!==i||r.classList.add("chocodrop-shimmer","chocodrop-float"),r.style.cssText=this.getFloatingCardStyles(i),r.style.setProperty("opacity","0","important"),r.style.setProperty("transform","translateY(20px) scale(0.95)","important"),r.style.setProperty("filter","blur(4px)","important");const a=this.getFriendlyMessage(i,o,t.errorMessage);return r.innerHTML=`\n      <span style="font-size: 14px;">${{pending:"⏳",processing:"🎨",progress:"⚡",completed:"✅",error:"❌"}[i]}</span>\n      <span style="font-size: 13px; margin-left: 6px;">${a}</span>\n    `,this.floatingContainer.insertBefore(r,this.floatingContainer.firstChild),this.updateCardDisplayLimit(),this.taskCards.set(n,{element:r,status:i,prompt:o,originalPrompt:o,startTime:Date.now(),endTime:null,error:null,contentType:"image",model:null,settings:null}),this.addCardDetailEvents(r,n),this.animateCardEntrance(r),this.ensureShimmerStyles(),n}ensureShimmerStyles(){if(document.querySelector("#chocodrop-shimmer-styles"))return;const e=document.createElement("style");e.id="chocodrop-shimmer-styles",e.textContent=`\n      /* 2025年トレンド: シマーエフェクト（強化版） */\n      .chocodrop-shimmer {\n        position: relative;\n        overflow: hidden;\n      }\n      \n      .chocodrop-shimmer::before {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: -100%;\n        width: 100%;\n        height: 100%;\n        background: linear-gradient(\n          90deg,\n          transparent,\n          ${this.isDarkMode?"rgba(255, 255, 255, 0.5)":"rgba(255, 255, 255, 0.7)"},\n          transparent\n        );\n        animation: shimmer 1.5s infinite;\n        pointer-events: none;\n        z-index: 1;\n      }\n      \n      .chocodrop-shimmer > * {\n        position: relative;\n        z-index: 2;\n      }\n      \n      /* 2025年トレンド: 微細な浮遊感 */\n      .chocodrop-float {\n        animation: gentleFloat 4s ease-in-out infinite;\n      }\n      \n      /* 待機中の特別なパルス効果（強化版） */\n      .chocodrop-shimmer.floating-task-card {\n        animation: gentleFloat 4s ease-in-out infinite, subtlePulse 3s ease-in-out infinite;\n      }\n      \n      @keyframes subtlePulse {\n        0%, 100% { \n          box-shadow: 0 8px 32px rgba(15, 23, 42, 0.3), 0 0 0 1px rgba(99, 102, 241, 0.1);\n        }\n        50% { \n          box-shadow: 0 12px 40px rgba(15, 23, 42, 0.5), 0 0 0 1px rgba(99, 102, 241, 0.3);\n        }\n      }\n    `,document.head.appendChild(e)}updateTaskCard(e,t,n={}){if(!this.taskCards||!this.taskCards.has(e))return;const i=this.taskCards.get(e),o=i.element;i.status=t,"error"===t&&n.errorMessage&&(i.error=n.errorMessage),"pending"===t||"processing"===t||"progress"===t?o.classList.add("chocodrop-shimmer","chocodrop-float"):o.classList.remove("chocodrop-shimmer","chocodrop-float");const r=this.getFriendlyMessage(t,i.prompt,i.error);o.innerHTML=`\n      <span style="font-size: 14px;">${{pending:"⏳",processing:"🎨",progress:"⚡",completed:"✅",error:"❌"}[t]}</span>\n      <span style="font-size: 13px; margin-left: 6px;">${r}</span>\n    `,o.style.cssText=this.getFloatingCardStyles(t),"completed"===t?this.animateCardSuccess(o,e):"error"===t&&this.animateCardError(o,e)}performErrorCleanup(e,t){if(e&&(this.updateTaskCard(e,"error",{errorMessage:t.message}),setTimeout(()=>{this.removeTaskCard(e)},1e4)),this.currentTaskId&&(this.currentTaskId=null),this.sceneManager&&this.sceneManager.clearLoadingStates?.(),this.progressConnections)for(const[t,n]of this.progressConnections.entries())n.taskId===e&&this.progressConnections.delete(t);console.log("🧹 Error cleanup completed")}removeTaskCard(e){const t=document.querySelector(`[data-task-id="${e}"]`);t&&(t.style.opacity="0",t.style.transform="translateX(-20px)",setTimeout(()=>{t.remove()},300),console.log(`🗑️ Task card removed: ${e}`))}addSystemMessage(e,t){const n=document.createElement("div");n.className=`system-message ${t}`,n.style.cssText=`\n      padding: 8px 12px;\n      margin: 4px 0;\n      border-radius: 8px;\n      font-size: 12px;\n      line-height: 1.4;\n      animation: slideIn 0.3s ease-out;\n      background: ${"error"===t?"rgba(239, 68, 68, 0.1)":"rgba(107, 114, 128, 0.1)"};\n      border: 1px solid ${"error"===t?"rgba(239, 68, 68, 0.3)":"rgba(107, 114, 128, 0.3)"};\n      color: ${"error"===t?"#fca5a5":this.isDarkMode?"#d1d5db":"#6b7280"};\n    `,n.textContent=e,this.outputDiv.appendChild(n),this.scrollToBottom()}showInputFeedback(e,t="error",n={}){if("success"===t)return;if("error"===t?this.addOutput(`⚠️ ${e}`,"error"):this.addOutput(`💡 ${e}`,"system"),!this.feedbackOverlay){const e=document.createElement("div");e.className="input-feedback-overlay",e.style.cssText="\n        position: absolute;\n        left: 16px;\n        right: 16px;\n        bottom: 12px;\n        z-index: 1200;\n        pointer-events: auto;\n        display: flex;\n        gap: 8px;\n        align-items: center;\n        padding: 12px 16px;\n        border-radius: 12px;\n        backdrop-filter: blur(10px);\n        -webkit-backdrop-filter: blur(10px);\n        transition: opacity 180ms ease, transform 180ms ease;\n        opacity: 0;\n        transform: translateY(8px);\n      ",this.container.appendChild(e),this.feedbackOverlay=e}const i=this.feedbackOverlay;i.innerHTML="";const o="error"===t,r=o?this.isDarkMode?"rgba(239, 68, 68, 0.28)":"rgba(239, 68, 68, 0.18)":this.isDarkMode?"rgba(59, 130, 246, 0.25)":"rgba(59, 130, 246, 0.18)",a=o?"1px solid rgba(239, 68, 68, 0.45)":"1px solid rgba(59, 130, 246, 0.35)",s=o?this.isDarkMode?"#fca5a5":"#b91c1c":this.isDarkMode?"#bfdbfe":"#1d4ed8";i.style.background=r,i.style.border=a,i.style.color=s;const l=document.createElement("span");if(l.textContent=e,l.style.flex="1",i.appendChild(l),n.actions&&Array.isArray(n.actions)&&n.actions.length>0){const e=document.createElement("div");e.style.cssText="\n        display: flex;\n        gap: 8px;\n      ",n.actions.forEach(t=>{const n=document.createElement("button");n.type="button",n.textContent=t.label,n.style.cssText=`\n          padding: 6px 12px;\n          border-radius: 999px;\n          border: none;\n          cursor: pointer;\n          background: ${o?"rgba(239, 68, 68, 0.28)":"rgba(59, 130, 246, 0.25)"};\n          color: inherit;\n          font-size: 11px;\n          transition: background 0.2s ease;\n        `,n.addEventListener("mouseenter",()=>{n.style.background=o?"rgba(239, 68, 68, 0.38)":"rgba(59, 130, 246, 0.35)"}),n.addEventListener("mouseleave",()=>{n.style.background=o?"rgba(239, 68, 68, 0.28)":"rgba(59, 130, 246, 0.25)"}),n.addEventListener("click",()=>{"function"==typeof t.onClick&&t.onClick()}),e.appendChild(n)}),i.appendChild(e)}this.feedbackAutoClearTimer&&(clearTimeout(this.feedbackAutoClearTimer),this.feedbackAutoClearTimer=null),i.style.pointerEvents="auto",i.style.opacity="1",i.style.transform="translateY(0)",this.currentFeedback=i,"info"===t&&(this.feedbackAutoClearTimer=setTimeout(()=>this.clearInputFeedback(),n.duration||3e3))}clearInputFeedback(){if(this.feedbackAutoClearTimer&&(clearTimeout(this.feedbackAutoClearTimer),this.feedbackAutoClearTimer=null),this.currentFeedback){const e=this.currentFeedback;e.style.pointerEvents="none",e.style.opacity="0",e.style.transform="translateY(8px)",this.currentFeedback=null,setTimeout(()=>{e.innerHTML=""},180)}}ensureFeedbackStyles(){if(document.getElementById("feedback-styles"))return;const e=document.createElement("style");e.id="feedback-styles",e.textContent="\n      @keyframes feedbackSlideIn {\n        from {\n          opacity: 0;\n          transform: translateY(-10px);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n      \n      @keyframes feedbackSlideOut {\n        from {\n          opacity: 1;\n          transform: translateY(0);\n        }\n        to {\n          opacity: 0;\n          transform: translateY(-10px);\n        }\n      }\n    ",document.head.appendChild(e)}async preValidateCommand(e){const t=this.sceneManager?.selectedObject||this.selectedFile,n=this.analyzeCommandType(e,t);if(this.selectedFile&&(n.type="import",n.mediaType="video"===this.selectedFile.type?"video":"image",n.needsTarget=!1,n.requiresConfirmation=!1,n.hasExplicitTarget=!0,n.detectedKeyword=n.detectedKeyword||"import"),n.type&&this.selectMode&&n.type!==this.currentMode&&this.selectMode(n.type,!1,n.detectedKeyword||null),"empty"===n.type)return this.showInputFeedback("💡 何をしましょうか？コマンドを入力してください","info"),{canExecute:!1,reason:"empty_command"};if(n.needsTarget&&!t){if(!(!!this.sceneManager&&(n.hasExplicitTarget||"modify"===n.type)))return this.showInputFeedback("🎯 操作対象が選択されていません","error",{actions:[{label:"選択する",onClick:()=>{this.clearInputFeedback(),this.showInputFeedback("👆 3Dシーン内のオブジェクトをクリックで選択してください","info")}},{label:"ヒント",onClick:()=>{this.clearInputFeedback(),this.showInputFeedback("💡 「インポートした猫を」「選択した画像を」のように対象を明示してみてください","info")}}]}),{canExecute:!1,reason:"no_target_selected"};this.logDebug("🔍 Searching for explicitly mentioned target...");try{const t=await(this.sceneManager?.findObjectByKeyword(e));return t?(this.sceneManager.selectObject(t),this.showInputFeedback(`✨ 「${t.name||t.userData?.originalPrompt||"オブジェクト"}」を見つけました！`,"success"),setTimeout(()=>this.executeCommandAfterValidation(e,n),1e3),{canExecute:!1,reason:"target_found_waiting"}):(this.showInputFeedback("🔍 指定されたオブジェクトが見つかりません","error",{actions:[{label:"選択する",onClick:()=>{this.clearInputFeedback(),this.showInputFeedback("👆 3Dシーン内のオブジェクトをクリックで選択してください","info")}},{label:"新規作成に変更",onClick:()=>{const t=this.convertToGenerateCommand(e);this.input.value=t,this.clearInputFeedback(),this.showInputFeedback("✏️ コマンドを新規作成用に変更しました","success")}}]}),{canExecute:!1,reason:"target_not_found"})}catch(e){return this.logDebug("❌ Error searching for target:",e),this.showInputFeedback("⚠️ 対象の検索中にエラーが発生しました","error"),{canExecute:!1,reason:"search_error"}}}return{canExecute:!0,commandType:n}}async executeCommandAfterValidation(e,t){this.clearInputFeedback(),await this.proceedWithExecution(e,t)}async proceedWithExecution(e,t){const n=this.sceneManager?.selectedObject||this.selectedFile;if(t||(t=this.analyzeCommandType(e,n)),this.selectedFile?("import"!==this.currentMode&&this.selectMode("import",!1),this.currentMode="import"):this.currentMode=t.type,t.requiresConfirmation){if(!await this.showDeleteConfirmation(e))return void this.addOutput("❌ 削除をキャンセルしました","system")}this.input.value="",this.clearInputFeedback(),this.hideProactiveSuggestion();const i=this.addTaskCard(e,{status:"processing"});let o;this.saveCommandToHistory({command:e,mode:this.currentMode,mediaType:t.mediaType,timestamp:Date.now()});try{const n=`${this.getModePrefix(this.currentMode)}${e}`;if(this.logDebug("🔍 Current mode check:",this.currentMode),"import"===this.currentMode){if(this.logDebug("📁 Import mode detected - bypassing SceneManager"),!this.selectedFile)throw new Error("ファイルが選択されていません。まずファイルを選択してください。");o=await this.handleImportCommand(e)}else if(this.sceneManager)if("modify"===this.currentMode){const t=this.sceneManager?.selectedObject;if(!t)return void this.addOutput("⚠️ 変更するオブジェクトが選択されていません。まず3Dシーン内のオブジェクトをクリックで選択してから、再度コマンドを実行してください。","system");o=this.client&&this.client.modifySelectedObject?await this.client.modifySelectedObject(t,e):await this.sceneManager.executeCommand(n)}else o=await this.sceneManager.executeCommand(n);else{if(!this.client)throw new Error("SceneManager または Client が設定されていません");if("generate"===this.currentMode)o="video"===t.mediaType?await this.client.generateVideo(e,{model:this.selectedVideoService||void 0}):await this.client.generateImage(e,{service:this.selectedImageService||void 0});else if("delete"===this.currentMode){const t=this.sceneManager?.selectedObject;if(!t&&!this.sceneManager?.getSelectedObjects()?.length)return void this.addOutput("⚠️ 削除するオブジェクトが選択されていません。まず3Dシーン内のオブジェクトをクリックで選択してから、再度Deleteボタンを押してください。","system");const n=`本当に「${e}」を実行しますか？\n\nこの操作は取り消せません。`;if(!confirm(n))return void this.addOutput("❌ 削除がキャンセルされました","system");o=await this.client.deleteObjects(e)}else o=await this.client.executeCommand(n)}if(o&&!1===o.success){const e=new Error(o.error||"操作に失敗しました");throw o.errorCategory&&(e.code=o.errorCategory),e}if(o&&o.taskId&&(this.connectToProgress(o.taskId,i),this.currentTaskId=o.taskId),i&&this.updateTaskCard(i,"completed"),o?.fallbackUsed){const e=o?.error?`⚠️ 生成に失敗したためプレースホルダーを表示しています: ${o.error}`:"⚠️ 生成に失敗したためプレースホルダーを表示しています。";this.showInputFeedback("生成に失敗したためプレースホルダーを表示しています。設定を確認してください。","error"),this.addOutput(e,"error")}t.mediaType}catch(e){const n={generate:`❌ ${"video"===t.mediaType?"動画":"画像"}生成エラー`,modify:"❌ 変更エラー",delete:"❌ 削除エラー"};"LOCAL_SERVER_UNREACHABLE"===e?.code?(this.serverHealthState.available=!1,this.serverHealthState.lastError=e,this.showServerHealthModal(e),this.showInputFeedback("サーバーに接続できません。`npm run dev` でローカルサーバーを起動してください。","error"),this.addOutput("📡 サーバーに接続できません。`npm run dev` でローカルサーバーを起動してください。","error")):"MCP_CONFIG_MISSING"===e?.code?this.showMcpConfigNotice(e):this.showInputFeedback(e.message,"error"),this.performErrorCleanup(i,e),this.addOutput(`${n[this.currentMode]}: ${e.message}`,"error"),console.error("Command execution error:",e)}this.sceneManager&&this.sceneManager.selectedObject&&("modify"!==this.currentMode&&"delete"!==this.currentMode||setTimeout(()=>{this.sceneManager.deselectObject()},500)),this.config.autoScroll&&this.scrollToBottom()}convertToGenerateCommand(e){const t=[{from:/(.+)を大きく/,to:"大きな$1の画像を作って"},{from:/(.+)を小さく/,to:"小さな$1の画像を作って"},{from:/(.+)を(.+)に/,to:"$2の$1の画像を作って"},{from:/(.+)を(.+)く/,to:"$2い$1の画像を作って"}];for(const{from:n,to:i}of t)if(n.test(e))return e.replace(n,i);return`${e}の画像を作って`}initializeServerHealthCheck(){!1!==this.config.enableServerHealthCheck?this.client?setTimeout(()=>{this.performServerHealthCheck({reason:"initial",showModalOnFail:!0}).catch(e=>{this.logDebug("⚠️ Initial health check failed:",e)})},100):this.logDebug("⚠️ Server health check skipped - client not available"):this.logDebug("🚫 Server health check disabled via config")}async performServerHealthCheck(e={}){if(!1===this.config.enableServerHealthCheck)return!0;if(!this.client)return!0;if(this.serverHealthState.checking)return this.serverHealthState.available;this.serverHealthState.checking=!0;const{showModalOnFail:t=!0}=e;this.serverHealthRetryButton&&(this.serverHealthRetryButton.disabled=!0,this.serverHealthRetryButton.textContent="再接続中…");try{"function"==typeof this.client.ensureInitialized&&await this.client.ensureInitialized();const e=this.getHealthEndpoint(),t="undefined"!=typeof AbortController?new AbortController:null,n=t?setTimeout(()=>t.abort(),5e3):null,i=await fetch(e,{method:"GET",cache:"no-store",signal:t?t.signal:void 0});if(n&&clearTimeout(n),!i.ok)throw new Error(`Health check failed: HTTP ${i.status}`);return await i.json(),this.serverHealthState.available=!0,this.serverHealthState.lastError=null,this.hideServerHealthModal(),!0}catch(e){return this.serverHealthState.available=!1,this.serverHealthState.lastError=e,t&&this.showServerHealthModal(e),!1}finally{this.serverHealthState.checking=!1,this.serverHealthRetryButton&&(this.serverHealthRetryButton.disabled=!1,this.serverHealthRetryButton.textContent="再接続を試す")}}getHealthEndpoint(){const e=this.client?.serverUrl||this.sceneManager?.client?.serverUrl;return e?`${e.replace(/\/$/,"")}/health`:"/health"}ensureServerHealthModal(){if(this.serverHealthModal)return;const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      inset: 0;\n      background: rgba(15, 23, 42, 0.65);\n      backdrop-filter: blur(6px);\n      display: none;\n      align-items: center;\n      justify-content: center;\n      z-index: 9999;\n    ";const t=document.createElement("div");t.style.cssText=`\n      max-width: 420px;\n      width: calc(100% - 64px);\n      background: ${this.isDarkMode?"rgba(15, 23, 42, 0.95)":"rgba(255, 255, 255, 0.98)"};\n      color: ${this.isDarkMode?"#f1f5f9":"#1f2937"};\n      border-radius: 16px;\n      padding: 28px;\n      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.35);\n      border: 1px solid ${this.isDarkMode?"rgba(148, 163, 184, 0.1)":"rgba(148, 163, 184, 0.2)"};\n      display: flex;\n      flex-direction: column;\n      gap: 18px;\n    `;const n=document.createElement("div");n.textContent="ChocoDrop サーバーに接続できません",n.style.cssText="\n      font-size: 18px;\n      font-weight: 700;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    ";const i=document.createElement("span");i.textContent="🔌",n.prepend(i);const o=document.createElement("p");o.style.cssText="\n      margin: 0;\n      line-height: 1.6;\n      font-size: 14px;\n    ",o.textContent="ローカルで起動している ChocoDrop サーバー（Express）に接続できません。ターミナルで `npm run dev` を実行し、サーバーが起動していることを確認してください。";const r=document.createElement("pre");r.style.cssText=`\n      margin: 0;\n      padding: 12px;\n      background: ${this.isDarkMode?"rgba(30, 41, 59, 0.6)":"rgba(15, 23, 42, 0.05)"};\n      border-radius: 10px;\n      font-size: 12px;\n      line-height: 1.5;\n      white-space: pre-wrap;\n      word-break: break-word;\n      color: ${this.isDarkMode?"#94a3b8":"#475569"};\n      border: 1px dashed ${this.isDarkMode?"rgba(148, 163, 184, 0.25)":"rgba(148, 163, 184, 0.35)"};\n    `,r.textContent="";const a=document.createElement("div");a.style.cssText="\n      display: flex;\n      gap: 12px;\n      justify-content: flex-end;\n    ";const s=document.createElement("button");s.textContent="閉じる",s.style.cssText=this.getSecondaryButtonStyles(),s.addEventListener("click",()=>{this.hideServerHealthModal()});const l=document.createElement("button");l.textContent="再接続を試す",l.style.cssText=this.getPrimaryButtonStyles(),l.addEventListener("click",()=>{this.performServerHealthCheck({reason:"manual",showModalOnFail:!0})}),a.appendChild(s),a.appendChild(l),t.appendChild(n),t.appendChild(o),t.appendChild(r),t.appendChild(a),e.appendChild(t),document.body.appendChild(e),this.serverHealthBackdrop=e,this.serverHealthModal=t,this.serverHealthMessage=o,this.serverHealthDetail=r,this.serverHealthRetryButton=l}getPrimaryButtonStyles(){return"\n      padding: 10px 16px;\n      border-radius: 10px;\n      border: none;\n      background: linear-gradient(135deg, #6366f1, #8b5cf6);\n      color: #ffffff;\n      font-weight: 600;\n      cursor: pointer;\n      transition: transform 0.2s ease, box-shadow 0.2s ease;\n      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.35);\n    "}getSecondaryButtonStyles(){return`\n      padding: 10px 16px;\n      border-radius: 10px;\n      border: 1px solid ${this.isDarkMode?"rgba(148, 163, 184, 0.3)":"rgba(71, 85, 105, 0.3)"};\n      background: transparent;\n      color: ${this.isDarkMode?"#cbd5f5":"#1f2937"};\n      font-weight: 600;\n      cursor: pointer;\n      transition: transform 0.2s ease, background 0.2s ease;\n    `}showServerHealthModal(e){if(!1!==this.config.enableServerHealthCheck&&(this.ensureServerHealthModal(),this.serverHealthBackdrop&&(this.serverHealthBackdrop.style.display="flex"),this.serverHealthDetail)){const t=e?.message||"サーバーに接続できません。";this.serverHealthDetail.textContent=t}}hideServerHealthModal(){this.serverHealthBackdrop&&(this.serverHealthBackdrop.style.display="none")}showMcpConfigNotice(e){if(this.mcpNoticeShown)return;this.mcpNoticeShown=!0;const t=e?.message||"MCP 設定が見つかりません。config.json の設定を確認してください。";this.showInputFeedback("AI生成サーバー (MCP) が未設定です。設定が完了するまで生成を実行できません。","error"),this.addOutput(`⚙️ MCP 設定が必要です: docs/SETUP.md を参照し、config.json の mcp セクションまたは MCP_CONFIG_PATH 環境変数を設定してください。\nサーバーからのメッセージ: ${t}`,"error")}getTaskCardStyles(e){const t={pending:"rgba(167, 139, 250, 0.3)",processing:"rgba(192, 132, 252, 0.5)",progress:"rgba(236, 72, 153, 0.4)",completed:"rgba(167, 139, 250, 0.4)",error:"rgba(239, 68, 68, 0.4)"};return`\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(255, 255, 255, 0.15)"};\n      border: 1px solid ${this.isDarkMode?"rgba(255, 255, 255, 0.15)":"rgba(255, 255, 255, 0.25)"};\n      border-radius: 12px;\n      padding: 16px;\n      margin-bottom: 12px;\n      backdrop-filter: blur(12px);\n      transition: all 0.3s ease;\n      animation: slideInUp 0.3s ease-out;\n    `+`border-left: 3px solid ${t[e]||t.pending};`}getFloatingCardStyles(e){const t=this.isDarkMode?{background:"linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 27, 75, 0.7))",border:"1px solid rgba(99, 102, 241, 0.25)",boxShadow:"0 8px 32px rgba(15, 23, 42, 0.3), 0 0 0 1px rgba(99, 102, 241, 0.1)",color:"#ffffff"}:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25))",border:"1px solid rgba(255, 255, 255, 0.4)",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.2)",color:"#1f2937"},n="pending"===e||"processing"===e||"progress"===e?`\n      position: relative;\n      overflow: hidden;\n      &::before {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: -100%;\n        width: 100%;\n        height: 100%;\n        background: linear-gradient(\n          90deg,\n          transparent,\n          ${this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(255, 255, 255, 0.4)"},\n          transparent\n        );\n        animation: shimmer 2s infinite;\n      }\n    `:"";return`\n      height: 36px;\n      padding: 0 18px;\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n      background: ${t.background};\n      backdrop-filter: blur(24px) saturate(180%);\n      -webkit-backdrop-filter: blur(24px) saturate(180%);\n      border: ${t.border};\n      border-radius: 18px;\n      color: ${t.color};\n      pointer-events: auto;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;\n      font-weight: 600;\n      font-size: 13px;\n      letter-spacing: 0.01em;\n      box-shadow: ${t.boxShadow};\n      transform: translateY(10px);\n      opacity: 0;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      ${n}\n      ${"pending"===e||"processing"===e||"progress"===e?"\n      animation: gentleFloat 4s ease-in-out infinite, shimmer 2s infinite;\n    ":""}\n      position: relative;\n      overflow: hidden;\n    `}updateCardDisplayLimit(){const e=Array.from(this.floatingContainer.children).filter(e=>!e.classList.contains("overflow-counter")),t=this.floatingContainer.querySelector(".overflow-counter");if(t&&t.remove(),e.length<=3)e.forEach(e=>{e.style.display="flex"});else{e.slice(0,3);const t=e.length-3;e.forEach((e,t)=>{e.style.display=t<3?"flex":"none"});const n=document.createElement("div");n.className="overflow-counter";const i=this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.12)",o=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.15)",r=this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(0, 0, 0, 0.6)";n.style.cssText=`\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 8px 12px;\n        margin: 4px 0;\n        background: ${i};\n        backdrop-filter: blur(20px);\n        border-radius: 12px;\n        border: 1px solid ${o};\n        font-size: 12px;\n        color: ${r};\n        font-weight: 500;\n        min-height: 32px;\n        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n        cursor: pointer;\n      `,n.innerHTML=`+ ${t}`,this.floatingContainer.appendChild(n);const a=this.isDarkMode?"rgba(255, 255, 255, 0.12)":"rgba(0, 0, 0, 0.18)";n.addEventListener("mouseenter",()=>{n.style.background=a,n.style.transform="scale(1.05)"}),n.addEventListener("mouseleave",()=>{n.style.background=i,n.style.transform="scale(1)"})}}addCardDetailEvents(e,t){if("ontouchstart"in window||navigator.maxTouchPoints>0)e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showTaskDetailModal(t)});else{let n;e.addEventListener("mouseenter",()=>{n=setTimeout(()=>{this.showTaskDetailModal(t)},800)}),e.addEventListener("mouseleave",()=>{n&&clearTimeout(n)}),e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showTaskDetailModal(t)})}}showTaskDetailModal(e){const t=this.taskCards.get(e);if(!t)return;const n=document.querySelector(".task-detail-modal");n&&n.remove();const i=this.createTaskDetailModal(t);document.body.appendChild(i),requestAnimationFrame(()=>{i.style.opacity="1",i.querySelector(".modal-content").style.transform="translateY(0) scale(1)"})}createTaskDetailModal(e){const t=document.createElement("div");t.className="task-detail-modal";const n=this.isDarkMode?"rgba(0, 0, 0, 0.6)":"rgba(0, 0, 0, 0.4)",i=this.isDarkMode?"rgba(20, 20, 20, 0.95)":"rgba(255, 255, 255, 0.95)",o=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",r=this.isDarkMode?"rgba(255, 255, 255, 0.9)":"rgba(0, 0, 0, 0.9)",a=this.isDarkMode?"rgba(255, 255, 255, 0.6)":"rgba(0, 0, 0, 0.6)";t.style.cssText=`\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: ${n};\n      backdrop-filter: blur(10px);\n      z-index: 100000;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      transition: opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: pointer;\n    `;const s=e.endTime?((e.endTime-e.startTime)/1e3).toFixed(1):((Date.now()-e.startTime)/1e3).toFixed(1),l="pending"===e.status?"待機中":"in-progress"===e.status?"実行中":"completed"===e.status?"完了":"エラー",c=document.createElement("div");c.className="modal-content",c.style.cssText=`\n      background: ${i};\n      backdrop-filter: blur(30px);\n      border: 1px solid ${o};\n      border-radius: 16px;\n      padding: 16px !important;\n      max-width: 400px;\n      width: 90%;\n      max-height: 80vh;\n      overflow-y: auto;\n      transform: translateY(20px) scale(0.95);\n      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: default;\n      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n    `,c.innerHTML=`\n      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">\n        <h3 style="margin: 0; color: ${r}; font-size: 14px; font-weight: 600;">タスク詳細</h3>\n        <button class="close-btn" style="\n          background: none;\n          border: none;\n          font-size: 24px;\n          color: ${a};\n          cursor: pointer;\n          padding: 0;\n          line-height: 1;\n          transition: color 0.2s;\n        ">×</button>\n      </div>\n      \n      <div style="space-y: 16px;">\n        <div>\n          <div style="color: ${a}; font-size: 12px; font-weight: 500; margin-bottom: 0;">📝 元のプロンプト</div>\n          <div style="color: ${r}; font-size: 14px; line-height: 1.4;">${e.originalPrompt}</div>\n        </div>\n        \n        <div>\n          <div style="color: ${a}; font-size: 12px; font-weight: 500; margin-bottom: 0;">📊 ステータス</div>\n          <div style="color: ${r}; font-size: 14px;">${l}</div>\n        </div>\n        \n        <div>\n          <div style="color: ${a}; font-size: 12px; font-weight: 500; margin-bottom: 0;">⏱️ 実行時間</div>\n          <div style="color: ${r}; font-size: 14px;">${s}秒</div>\n        </div>\n        \n        ${e.error?`\n        <div>\n          <div style="color: ${a}; font-size: 12px; font-weight: 500; margin-bottom: 0;">❌ エラー詳細</div>\n          <div style="color: #ef4444; font-size: 14px; line-height: 1.4;">${e.error}</div>\n        </div>\n        `:""}\n        \n        <div>\n          <div style="color: ${a}; font-size: 12px; font-weight: 500; margin-bottom: 0;">🎨 コンテンツタイプ</div>\n          <div style="color: ${r}; font-size: 14px;">${e.contentType||"画像"}</div>\n        </div>\n      </div>\n    `,c.addEventListener("click",e=>{e.stopPropagation()});const d=c.querySelector(".close-btn");return d.addEventListener("click",()=>{this.closeTaskDetailModal(t)}),d.addEventListener("mouseenter",()=>{d.style.color=r}),d.addEventListener("mouseleave",()=>{d.style.color=a}),t.addEventListener("click",()=>{this.closeTaskDetailModal(t)}),t.appendChild(c),t}closeTaskDetailModal(e){e.style.opacity="0",e.querySelector(".modal-content").style.transform="translateY(20px) scale(0.95)",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}animateCardEntrance(e){e.style.transform="translateY(20px) scale(0.95)",e.style.opacity="0",e.style.filter="blur(4px)",requestAnimationFrame(()=>{e.style.transition="all 0.6s cubic-bezier(0.16, 1, 0.3, 1)",e.style.transform="translateY(0) scale(1)",e.style.opacity="1",e.style.filter="blur(0px)",e.style.boxShadow="0 4px 20px rgba(255, 255, 255, 0.1), 0 0 40px rgba(255, 255, 255, 0.05)"})}animateCardSuccess(e,t){e.style.transition="all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",e.style.borderColor="rgba(76, 175, 80, 0.6)",e.style.transform="scale(1.08)",e.style.boxShadow="0 8px 32px rgba(76, 175, 80, 0.4), 0 0 60px rgba(76, 175, 80, 0.2)",e.style.filter="brightness(1.1) saturate(1.2)",setTimeout(()=>{e.style.transform="scale(1.02)",e.style.filter="brightness(1.05) saturate(1.1)"},150),setTimeout(()=>{this.animateCardExit(e,t)},2e3)}animateCardError(e,t){e.style.transition="all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",e.style.borderColor="rgba(244, 67, 54, 0.7)",e.style.boxShadow="0 8px 32px rgba(244, 67, 54, 0.3), 0 0 60px rgba(244, 67, 54, 0.15)",e.style.filter="saturate(1.3) brightness(1.1)",e.style.animation="errorPulse 0.6s cubic-bezier(0.16, 1, 0.3, 1) 2",this.addErrorTooltip(e,t),e.style.cursor="pointer",e.onclick=()=>this.animateCardExit(e,t),setTimeout(()=>{this.taskCards.has(t)&&this.animateCardExit(e,t)},5e3)}addErrorTooltip(e,t){const n=this.taskCards.get(t);if(!n||!n.error)return;const i=document.createElement("div");i.style.cssText="\n      position: absolute;\n      bottom: 100%;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(244, 67, 54, 0.95);\n      color: white;\n      padding: 8px 12px;\n      border-radius: 8px;\n      font-size: 11px;\n      white-space: nowrap;\n      pointer-events: none;\n      z-index: 1001;\n      backdrop-filter: blur(10px);\n      margin-bottom: 0;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n    ",i.textContent=n.error,e.style.position="relative",e.appendChild(i),requestAnimationFrame(()=>{i.style.opacity="1"}),setTimeout(()=>{i.parentNode&&(i.style.opacity="0",setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300))},3e3)}animateCardExit(e,t){e.style.transition="all 0.28s cubic-bezier(0.4, 0, 0.2, 1)",e.style.transform="translateY(-12px) scale(0.92)",e.style.opacity="0",e.style.filter="blur(6px) brightness(1.2)",e.style.boxShadow="0 0 40px rgba(255, 255, 255, 0.3), 0 0 80px rgba(255, 255, 255, 0.1)",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e),this.taskCards.delete(t),this.updateCardDisplayLimit()},280)}getResponseType(e){return/ちょこっと|ちょこん|少し|軽く/.test(e)||e.length<15?"casual":/美しい|幻想|素敵|魔法|世界|綺麗/.test(e)?"magical":"balanced"}getFriendlyMessage(e,t,n=null){const i=t.length>15?t.substring(0,15)+"...":t,o=this.getResponseType(t);switch(e){case"pending":return"casual"===o?"ちょこっと準備中です...":"magical"===o?"魔法をかけようとしています...":"ちょこっと魔法の準備中...";case"processing":case"in-progress":case"progress":return"modify"===this.currentMode?"casual"===o?"ちょこっと調整中です...":"magical"===o?"イメージを変化させています...":"ちょこんと編集中です...":"casual"===o?"ちょこんと配置中です...":"magical"===o?"あなたの想いを形にしています...":"ちょこっと魔法をかけています...";case"completed":return"delete"===this.currentMode?"casual"===o?"ちょこっと削除しました！":"magical"===o?"すっきりと片付きました！":"ちょこんと削除完了！すっきりですね！":"modify"===this.currentMode?"casual"===o?"ちょこっと調整しました！":"magical"===o?"素敵に変身しました！":"ちょこんと編集完了！いい感じですね！":"casual"===o?"ちょこっとドロップしました！":"magical"===o?"素敵な世界が完成しました！":"ちょこんと配置完了！素敵ですね！";case"error":if(n){return`❌ ${n.length>30?n.substring(0,30)+"...":n}`}return"casual"===o?"おっと、エラーが発生しました":"magical"===o?"申し訳ございません、処理に失敗しました":"エラーが発生しました。もう一度お試しください";default:return i}}getStatusColor(e){const t={pending:this.isDarkMode?"#a78bfa":"#7c3aed",processing:this.isDarkMode?"#c084fc":"#9333ea",progress:this.isDarkMode?"#ec4899":"#be185d",completed:this.isDarkMode?"#a78bfa":"#7c3aed",error:this.isDarkMode?"#f87171":"#dc2626"};return t[e]||t.pending}createStatusIndicator(e){return"processing"===e||"progress"===e?`\n        <div class="status-indicator" style="\n          background: ${this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.08)"};\n          border-radius: 8px;\n          height: 4px;\n          overflow: hidden;\n          margin-top: 8px;\n          position: relative;\n        ">\n          <div class="status-pulse" style="\n            background: linear-gradient(90deg, transparent, ${this.isWabiSabiMode?"#8BC34A, #689F38":"#6366f1, #8b5cf6"}, transparent);\n            height: 100%;\n            width: 30%;\n            border-radius: 8px;\n            animation: statusPulse 1.8s ease-in-out infinite;\n          "></div>\n        </div>\n        <div style="display: flex; align-items: center; gap: 4px; margin-top: 8px;">\n          <div class="status-dots" style="font-size: 10px; color: ${this.isDarkMode?"#c084fc":"#9333ea"};">\n            処理中<span style="animation: dots 1.5s infinite;">...</span>\n          </div>\n        </div>\n      `:""}animateTaskCompletion(e){e.style.animation="taskComplete 0.8s ease-out",this.addSubtleParticleEffect(e),setTimeout(()=>{e.style.animation=""},800),this.ensureTaskAnimations()}addSubtleParticleEffect(e){const t=e.getBoundingClientRect();for(let e=0;e<3;e++){const n=document.createElement("div");n.style.cssText=`\n        position: fixed;\n        width: 4px;\n        height: 4px;\n        background: linear-gradient(45deg, #a78bfa, #c084fc);\n        border-radius: 50%;\n        pointer-events: none;\n        z-index: 9999;\n        left: ${t.right-20}px;\n        top: ${t.top+10}px;\n        opacity: 0.8;\n        transform: scale(0);\n        animation: subtleParticle 1.2s ease-out forwards;\n      `;const i=e/3*Math.PI*2,o=15;n.style.setProperty("--move-x",Math.cos(i)*o+"px"),n.style.setProperty("--move-y",Math.sin(i)*o+"px"),document.body.appendChild(n),setTimeout(()=>n.remove(),1200)}}ensureTaskAnimations(){if(document.getElementById("task-animations"))return;const e=document.createElement("style");e.id="task-animations",e.textContent="\n      @keyframes slideInUp {\n        from { opacity: 0; transform: translateY(20px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n\n      @keyframes taskComplete {\n        0% {\n          transform: scale(1);\n          border-left-color: rgba(192, 132, 252, 0.5);\n        }\n        30% {\n          transform: scale(1.01);\n          background: rgba(167, 139, 250, 0.08);\n          border-left-color: rgba(167, 139, 250, 0.6);\n        }\n        60% {\n          background: rgba(167, 139, 250, 0.05);\n        }\n        100% {\n          transform: scale(1);\n          background: rgba(167, 139, 250, 0.02);\n          border-left-color: rgba(167, 139, 250, 0.4);\n        }\n      }\n\n      @keyframes subtleParticle {\n        0% {\n          transform: scale(0) translate(0, 0);\n          opacity: 0.8;\n        }\n        20% {\n          transform: scale(1) translate(0, 0);\n          opacity: 1;\n        }\n        100% {\n          transform: scale(0.3) translate(var(--move-x, 0), var(--move-y, 0));\n          opacity: 0;\n        }\n      }\n\n      @keyframes shimmer {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(100%); }\n      }\n\n      @keyframes slideIn {\n        from { opacity: 0; transform: translateX(-20px); }\n        to { opacity: 1; transform: translateX(0); }\n      }\n\n      @keyframes statusPulse {\n        0% { transform: translateX(-100%); }\n        50% { transform: translateX(300%); }\n        100% { transform: translateX(-100%); }\n      }\n\n      @keyframes dots {\n        0%, 20% { opacity: 0; }\n        50% { opacity: 1; }\n        100% { opacity: 0; }\n      }\n\n      @keyframes errorPulse {\n        0% {\n          transform: scale(1);\n          filter: saturate(1.3) brightness(1.1);\n        }\n        50% {\n          transform: scale(1.03);\n          filter: saturate(1.5) brightness(1.2);\n          box-shadow: 0 12px 40px rgba(244, 67, 54, 0.4), 0 0 80px rgba(244, 67, 54, 0.2);\n        }\n        100% {\n          transform: scale(1);\n          filter: saturate(1.3) brightness(1.1);\n        }\n      }\n    ",document.head.appendChild(e)}addTaskStatus(e,t=0,n=null){const i=n||`task_${Date.now()}`;return this.addTaskCard(e,{percent:Math.min(Math.max(t,0),100),taskId:i,status:t>0?"progress":"pending"})}updateTaskProgress(e,t,n=null){this.output.querySelector(`[data-task-id="${e}"]`)&&n&&this.addOutput(n,"progress",{percent:Math.min(Math.max(t,0),100),taskId:e})}completeTask(e){const t=this.output.querySelector(`[data-task-id="${e}"]`);t&&(t.style.transition="opacity 0.5s ease, transform 0.5s ease",t.style.opacity="0",t.style.transform="translateX(20px)",setTimeout(()=>{t.parentNode&&t.remove()},500))}connectToProgress(e,t=null){if(this.activeConnections.has(e))return;const n=new EventSource(`/api/progress/${e}`);this.activeConnections.set(e,n),n.onmessage=e=>{try{const n=JSON.parse(e.data);n.uiTaskId=t,this.handleProgressUpdate(n)}catch(e){console.error("SSE data parse error:",e)}},n.onerror=t=>{console.error("SSE connection error:",t),this.disconnectProgress(e)}}handleProgressUpdate(e){switch(e.type){case"connected":this.logDebug(`🔗 Connected to progress stream: ${e.taskId}`);break;case"progress":void 0!==e.percent&&e.uiTaskId&&this.updateTaskCard(e.uiTaskId,"progress",{percent:e.percent});break;case"completed":e.uiTaskId&&this.updateTaskCard(e.uiTaskId,"completed"),this.disconnectProgress(e.taskId);break;case"error":e.uiTaskId&&this.updateTaskCard(e.uiTaskId,"error",{errorMessage:e.message}),this.addOutput(`❌ ${e.message}`,"error"),this.disconnectProgress(e.taskId)}}disconnectProgress(e){const t=this.activeConnections.get(e);t&&(t.close(),this.activeConnections.delete(e))}scrollToBottom(){this.outputDiv&&(this.outputDiv.scrollTop=this.outputDiv.scrollHeight)}getModePrefix(e){return{generate:"",modify:"[変更] ",delete:"[削除] "}[e]||""}saveCommandToHistory(e){this.commandHistory=this.commandHistory.slice(0,this.currentHistoryIndex+1),this.commandHistory.push(e),this.currentHistoryIndex=this.commandHistory.length-1,this.commandHistory.length>this.maxHistorySize&&(this.commandHistory.shift(),this.currentHistoryIndex--),this.updateUndoRedoButtons()}undo(){if(!this.canUndo())return void this.addOutput("↶ Undoできる操作がありません","hint");const e=this.commandHistory[this.currentHistoryIndex];this.currentHistoryIndex--,"generate"===e.mode?(this.addOutput(`↶ Undo: "${e.command}" の生成を取り消しました`,"system"),this.sceneManager&&this.sceneManager.undoLastGenerate&&this.sceneManager.undoLastGenerate()):"modify"===e.mode?(this.addOutput(`↶ Undo: "${e.command}" の変更を取り消しました`,"system"),this.sceneManager&&this.sceneManager.undoLastModify&&this.sceneManager.undoLastModify()):"delete"===e.mode&&(this.addOutput(`↶ Undo: "${e.command}" の削除を取り消しました`,"system"),this.sceneManager&&this.sceneManager.undoLastDelete&&this.sceneManager.undoLastDelete()),this.updateUndoRedoButtons()}redo(){if(!this.canRedo())return void this.addOutput("↷ Redoできる操作がありません","hint");this.currentHistoryIndex++;const e=this.commandHistory[this.currentHistoryIndex];this.addOutput(`↷ Redo: "${e.command}" を再実行しました`,"system"),this.sceneManager&&this.sceneManager.redoCommand&&this.sceneManager.redoCommand(e),this.updateUndoRedoButtons()}canUndo(){return this.currentHistoryIndex>=0}canRedo(){return this.currentHistoryIndex<this.commandHistory.length-1}updateUndoRedoButtons(){this.undoBtn&&(this.undoBtn.disabled=!this.canUndo(),this.undoBtn.style.opacity=this.canUndo()?"1":"0.4",this.undoBtn.style.cursor=this.canUndo()?"pointer":"not-allowed"),this.redoBtn&&(this.redoBtn.disabled=!this.canRedo(),this.redoBtn.style.opacity=this.canRedo()?"1":"0.4",this.redoBtn.style.cursor=this.canRedo()?"pointer":"not-allowed")}async clearAllWithConfirmation(){await this.showClearAllConfirmation()&&this.clearAll()}async showClearAllConfirmation(){return this.showConfirmationDialog({icon:"🧹",title:"Clear All の確認",message:"すべてのオブジェクトが削除されます。<br>この操作は取り消すことができません。",confirmText:"Clear All 実行",cancelText:"キャンセル",confirmColor:this.isWabiSabiMode?"#8BC34A":"#6366f1"})}closeModalWithAnimation(e){const t=e.querySelector("div:last-child");t.style.transform="scale(0.9)",t.style.opacity="0",e.style.opacity="0",setTimeout(()=>{e.parentElement&&document.body.removeChild(e)},200)}clearAll(){this.sceneManager?(this.sceneManager.clearAll(),this.addOutput("🧹 全ての実験オブジェクトを削除しました","system")):this.client&&this.addOutput("⚠️ サーバー側削除は未実装","error")}showExamples(){this.addOutput("💡 コマンド例:","system"),["右上にドラゴンを作って","中央に大きなユニコーンを生成","左下に小さな桜を作って","空に鳳凰を作って","地面に神社を作って"].forEach(e=>{this.addOutput(`   "${e}"`,"hint")})}setSceneManager(e){this.sceneManager=e,this.applyServiceSelectionToSceneManager()}setClient(e){this.client=e}updateConfig(e){this.config={...this.config,...e},e.activationKey&&this.bindEvents()}refreshStyles(){const e=this.container?.querySelector('[data-mode="generate"]');e&&(e.style.cssText=this.getModeButtonStyles(!0,"generate"));const t=this.container?.querySelector("#execute-btn");t&&(t.style.cssText=this.getModernButtonStyles("primary")),this.serviceModal&&this.updateServiceModalStyles(),this.updateServiceSelectorTheme()}updateServiceModalStyles(){this.serviceModal&&(this.serviceModal.style.background=this.isWabiSabiMode?"linear-gradient(135deg, rgba(158, 158, 158, 0.4), rgba(189, 189, 189, 0.35))":this.isDarkMode?"linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(30, 27, 75, 0.8))":"linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3))",this.serviceModal.style.border=this.isWabiSabiMode?"1px solid rgba(141, 110, 99, 0.4)":this.isDarkMode?"1px solid rgba(99, 102, 241, 0.3)":"1px solid rgba(255, 255, 255, 0.5)",this.serviceModal.style.color=this.isWabiSabiMode?"#424242":this.isDarkMode?"#ffffff":"#1f2937",this.serviceModal.style.boxShadow=this.isWabiSabiMode?"0 20px 40px rgba(93, 64, 55, 0.35)":"0 20px 40px rgba(15, 23, 42, 0.35)")}toggleTheme(){switch(this.currentTheme){case"light":this.currentTheme="dark";break;case"dark":this.currentTheme="wabisabi";break;default:this.currentTheme="light"}if(this.isDarkMode="dark"===this.currentTheme,this.isWabiSabiMode="wabisabi"===this.currentTheme,localStorage.setItem("live-command-theme",this.currentTheme),this.themeToggle){const e={light:{icon:"🌙",title:"ダークモードに切り替え"},dark:{icon:"🍵",title:"侘び寂びモードに切り替え"},wabisabi:{icon:"☀️",title:"ライトモードに切り替え"}}[this.currentTheme];"☀️"===e.icon?this.themeToggle.innerHTML=`<span style="filter: saturate(1.2) brightness(1.1);">${e.icon}</span>`:"🍵"===e.icon?this.themeToggle.innerHTML=`<span style="filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);">${e.icon}</span>`:this.themeToggle.innerHTML=`<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">${e.icon}</span>`,this.themeToggle.title=e.title}this.applyTheme()}applyTheme(){document.body.className=this.isWabiSabiMode?"wabisabi-mode":this.isDarkMode?"dark-mode":"light-mode";const e=this.container.style.display,t=this.container.style.flexDirection;this.container.style.cssText=this.getContainerStyles(),this.container.style.display=e||"flex",this.container.style.flexDirection=t||"column";const n=this.container.querySelector(".floating-brand-badge");n&&(n.style.background=this.isDarkMode?"linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.7))":"linear-gradient(135deg, rgba(99, 102, 241, 0.9), rgba(139, 92, 246, 0.8))",n.style.border="1px solid "+(this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(255, 255, 255, 0.4)"));const i=!!this.highlightOverlay;if(this.inputDefaultStyles=null,this.clearKeywordHighlighting(),this.input.style.cssText=this.getInputStyles(),this.captureInputDefaultStyles(),(i||this.input&&this.input.value.trim())&&this.applyKeywordHighlighting(),this.output.style.cssText=this.getOutputStyles(),this.radioModeContainer&&(this.radioModeContainer.style.background=this.isWabiSabiMode?"linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))":this.isDarkMode?"linear-gradient(135deg, rgba(30, 27, 75, 0.3), rgba(15, 23, 42, 0.4))":"linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1))",this.radioModeContainer.style.borderColor=this.isWabiSabiMode?"rgba(93, 64, 55, 0.4)":this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(255, 255, 255, 0.25)",Object.keys(this.radioModeButtons).forEach(e=>{const{button:t}=this.radioModeButtons[e];this.currentMode!==e&&(t.style.color=this.isWabiSabiMode?"rgba(245, 245, 245, 0.8)":this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(55, 65, 81, 0.8)",t.style.background="transparent",t.style.border="1px solid transparent",t.style.boxShadow="none")}),this.selectMode(this.currentMode,!1)),this.clearBtn&&(this.clearBtn.style.cssText=this.getActionButtonStyles("secondary")),this.historyBtn&&(this.historyBtn.style.cssText=this.getActionButtonStyles("secondary"),this.historyBtn.style.opacity="0.5"),this.themeToggle){const e={light:{icon:"🌙",title:"ダークモードに切り替え"},dark:{icon:"🍵",title:"侘び寂びモードに切り替え"},wabisabi:{icon:"☀️",title:"ライトモードに切り替え"}},t=e[this.currentTheme]||e.light;"☀️"===t.icon?this.themeToggle.innerHTML=`<span style="filter: saturate(1.2) brightness(1.1);">${t.icon}</span>`:"🍵"===t.icon?this.themeToggle.innerHTML=`<span style="filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);">${t.icon}</span>`:this.themeToggle.innerHTML=`<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">${t.icon}</span>`,this.themeToggle.title=t.title,this.themeToggle.style.cssText=this.getActionButtonStyles("icon")}this.settingsButton&&(this.settingsButton.style.cssText=this.getActionButtonStyles("icon")),this.updateServiceSelectorTheme();const o=this.container.querySelector(".close-button");o&&(o.style.color=this.isDarkMode?"#ffffff":"#1f2937",o.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"),this.updateFloatingContainerTheme(),this.updateExistingTextColors()}updateFloatingContainerTheme(){if(!this.floatingContainer)return;const e=this.floatingContainer.style.display;this.taskCards&&this.taskCards.size>0&&this.taskCards.forEach((e,t)=>{const n=e.element;if(n){const e={background:"linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 27, 75, 0.7))",border:"1px solid rgba(99, 102, 241, 0.25)",color:"#ffffff"},t={background:"linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25))",border:"1px solid rgba(255, 255, 255, 0.4)",color:"#1f2937"},i=this.isDarkMode?e:t;n.style.setProperty("background",i.background,"important"),n.style.setProperty("border",i.border,"important"),n.style.setProperty("color",i.color,"important")}}),this.floatingContainer.style.display=e}updateExistingTextColors(){const e=this.isDarkMode?{system:"#60a5fa",command:"#93c5fd",success:"#f472b6",error:"#f87171",processing:"#fbbf24",info:"#d1d5db",hint:"#d1d5db"}:{system:"#1e40af",command:"#1d4ed8",success:"#be185d",error:"#dc2626",processing:"#d97706",info:"#7c3aed",hint:"#374151"},t=this.isDarkMode?"#d1d5db":"#374151";this.output.querySelectorAll("div").forEach(n=>{const i=n.textContent;let o="default";i.includes("📋")||i.includes("🎨")||i.includes("🎮")||i.includes("UI起動")?o="system":i.startsWith("> ")?o="command":i.includes("✅")||i.includes("⭐")||i.includes("生成しました")?o="success":i.includes("❌")||i.includes("エラー")?o="error":i.includes("中...")?o="processing":i.includes("📍")||i.includes("使用モデル:")||i.includes("位置:")?o="info":i.includes("   ")&&(o="hint"),n.style.color=e[o]||t})}showImportInterface(){this.fileInput||(this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".glb,.gltf,.jpg,.jpeg,.png,.mp4,.mov",this.fileInput.style.display="none",this.fileInput.onchange=e=>this.handleFileSelection(e),document.body.appendChild(this.fileInput)),this.enableDragAndDrop()}hideImportInterface(){this.fileSelectButton&&this.fileSelectButton.parentNode&&this.fileSelectButton.parentNode.removeChild(this.fileSelectButton),this.disableDragAndDrop()}openFileSelector(){this.fileInput&&this.fileInput.click()}triggerFileSelection(){this.fileInput||this.showImportInterface(),this.openFileSelector(),this.selectMode("import",!0)}async handleFileSelection(e){const t=e.target.files[0];if(t)try{this.selectedFile&&this.selectedFile.url&&URL.revokeObjectURL(this.selectedFile.url);const e=this.detectFileType(t.name),n=URL.createObjectURL(t);this.selectedFile={file:t,url:n,type:e,name:t.name},this.selectMode("import",!0);const i=`中央に設置 (${t.name})`;this.input.value=i,this.addOutput(`📁 ファイル選択: ${t.name} (${e})`,"system"),this.addOutput(`🚀 自動アップロード開始: ${i}`,"system"),setTimeout(()=>{this.executeCommand()},500)}catch(e){console.error("File selection error:",e),this.addOutput(`❌ ファイル選択エラー: ${e.message}`,"error")}finally{e.target&&(e.target.value="")}}enableDragAndDrop(){this.input&&(this.input.addEventListener("dragover",this.handleDragOver.bind(this)),this.input.addEventListener("drop",this.handleDrop.bind(this)),this.input.addEventListener("dragenter",this.handleDragEnter.bind(this)),this.input.addEventListener("dragleave",this.handleDragLeave.bind(this)))}disableDragAndDrop(){this.input&&(this.input.removeEventListener("dragover",this.handleDragOver.bind(this)),this.input.removeEventListener("drop",this.handleDrop.bind(this)),this.input.removeEventListener("dragenter",this.handleDragEnter.bind(this)),this.input.removeEventListener("dragleave",this.handleDragLeave.bind(this)))}handleDragOver(e){e.preventDefault(),this.input.style.background=this.isDarkMode?"rgba(236, 72, 153, 0.1)":"rgba(236, 72, 153, 0.05)"}handleDragEnter(e){e.preventDefault(),this.input.style.background=this.isDarkMode?"rgba(236, 72, 153, 0.1)":"rgba(236, 72, 153, 0.05)"}handleDragLeave(e){e.preventDefault(),this.input.style.background=""}async handleDrop(e){e.preventDefault(),this.input.style.background="";const t=Array.from(e.dataTransfer.files);if(0===t.length)return;const n=t[0];this.detectFileType(n.name)?this.handleFileSelection({target:{files:[n]}}):this.addOutput("❌ サポートされていないファイル形式です","error")}detectFileType(e){const t=e.toLowerCase().split(".").pop();return["glb","gltf"].includes(t)?"3d":["jpg","jpeg","png","webp"].includes(t)?"image":["mp4","mov","webm"].includes(t)?"video":null}async handleImportCommand(e){if(!this.selectedFile)throw new Error("ファイルが選択されていません");try{const t=this.sceneManager?this.sceneManager.parsePosition(e):{x:0,y:5,z:-10};let n;switch(this.selectedFile.type){case"3d":if(!this.sceneManager)throw new Error("SceneManager が利用できません");n=await this.sceneManager.load3DModel(this.selectedFile.url,{position:t});break;case"image":if(!this.sceneManager)throw new Error("SceneManager が利用できません");n=await this.sceneManager.loadImageFile(this.selectedFile.url,{position:t,fileName:this.selectedFile.name});break;case"video":if(!this.sceneManager)throw new Error("SceneManager が利用できません");n=await this.sceneManager.loadVideoFile(this.selectedFile.url,{position:t,fileName:this.selectedFile.name});break;default:throw new Error(`サポートされていないファイルタイプ: ${this.selectedFile.type}`)}const i=this.selectedFile?.name,o=this.selectedFile?.type,r=this.selectedFile?.url;return"video"!==o&&r&&URL.revokeObjectURL(r),this.selectedFile=null,this.selectMode("generate",!1),{success:!0,message:`${i||"ファイル"} を ${t.x}, ${t.y}, ${t.z} に配置しました`,objectId:n.objectId}}catch(e){throw this.selectedFile?.url&&URL.revokeObjectURL(this.selectedFile.url),this.selectedFile=null,this.selectMode("generate",!1),e}}handleDeleteModeSelection(){this.selectedFile?.url&&URL.revokeObjectURL(this.selectedFile.url),this.selectedFile=null;const e=this.sceneManager?.selectedObject;if(e){const t=e.userData?.originalPrompt||e.name||"選択したオブジェクト";this.input.value=`${t}を削除 ⏎`,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length),this.addOutput(`🎯 削除対象: ${t}`,"system")}else this.input.value="",this.addOutput("❗ 削除するオブジェクトを選択後、削除ボタンを押してください","system"),this.triggerAttentionAnimation("delete")}handleModifyModeSelection(){this.selectedFile?.url&&URL.revokeObjectURL(this.selectedFile.url),this.selectedFile=null;const e=this.sceneManager?.selectedObject;if(e){const t=e.userData?.originalPrompt||e.name||"選択したオブジェクト";this.input.value=`${t}を`,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length),this.addOutput(`🎯 修正対象: ${t}`,"system")}else this.input.value="",this.addOutput("❗ 修正するオブジェクトを選択後、修正ボタンを押してください","system"),this.triggerAttentionAnimation("modify")}triggerAttentionAnimation(e){const t=this.chatOutput,n=this.input;this.addMicroShakeEffect(t),this.addContextGlow(n,e),this.addEmotionalPulse(t,e),this.add3DDepthEffect(t)}addMicroShakeEffect(e){e.style.animation="microShake2025 0.5s ease-in-out",this.ensureMicroShakeAnimation(),setTimeout(()=>{e.style.animation=""},500)}addContextGlow(e,t){const n="delete"===t?"rgba(239, 68, 68, 0.4)":"rgba(99, 102, 241, 0.4)";e.style.transition="all 0.3s ease",e.style.boxShadow=`0 0 20px ${n}, 0 0 40px ${n}`,setTimeout(()=>{e.style.boxShadow=""},3e3)}addEmotionalPulse(e,t){const n="delete"===t?"#ef4444":this.isWabiSabiMode?"#8BC34A":"#6366f1";e.style.borderLeft=`4px solid ${n}`,e.style.animation="emotionalPulse2025 2s ease-in-out infinite",this.ensureEmotionalPulseAnimation(),setTimeout(()=>{e.style.animation="",e.style.borderLeft=""},6e3)}add3DDepthEffect(e){e.style.transform="translateZ(8px) rotateX(1deg)",e.style.transition="transform 0.3s ease",setTimeout(()=>{e.style.transform=""},2e3)}ensureMicroShakeAnimation(){if(document.getElementById("micro-shake-2025"))return;const e=document.createElement("style");e.id="micro-shake-2025",e.textContent="\n      @keyframes microShake2025 {\n        0%, 100% { transform: translateX(0); }\n        10% { transform: translateX(-2px) rotateZ(-0.5deg); }\n        20% { transform: translateX(2px) rotateZ(0.5deg); }\n        30% { transform: translateX(-1px) rotateZ(-0.3deg); }\n        40% { transform: translateX(1px) rotateZ(0.3deg); }\n        50% { transform: translateX(-0.5px) rotateZ(-0.1deg); }\n        60% { transform: translateX(0.5px) rotateZ(0.1deg); }\n        70% { transform: translateX(0); }\n      }\n    ",document.head.appendChild(e)}ensureEmotionalPulseAnimation(){if(document.getElementById("emotional-pulse-2025"))return;const e=document.createElement("style");e.id="emotional-pulse-2025",e.textContent="\n      @keyframes emotionalPulse2025 {\n        0% { \n          border-left-width: 4px;\n          filter: brightness(1);\n        }\n        50% { \n          border-left-width: 8px;\n          filter: brightness(1.2) saturate(1.1);\n        }\n        100% { \n          border-left-width: 4px;\n          filter: brightness(1);\n        }\n      }\n    ",document.head.appendChild(e)}clearInputOnModeSwitch(e){if(this.input.value.trim()){this.isPreviousModeMessage(this.input.value,e)&&(this.input.value="",this.addOutput(`💫 ${this.getModeDisplayName(e)}モードに切り替えました`,"system"))}}isPreviousModeMessage(e,t){const n=[/.*を削除$/,/削除$/],i=[/.*を$/,/.*を変更/,/.*をピンク/,/.*を大きく/,/.*を小さく/,/.*を移動/,/回転/,/反転/,/ミラー/,/傾け/,/向きを変え/,/.*を.*色/,/.*を.*サイズ/],o=[/ファイル/,/画像/,/インポート/];switch(t){case"delete":return i.some(t=>t.test(e))||o.some(t=>t.test(e));case"modify":case"generate":return n.some(t=>t.test(e))||i.some(t=>t.test(e))||o.some(t=>t.test(e));case"import":return n.some(t=>t.test(e))||i.some(t=>t.test(e));default:return!1}}getModeDisplayName(e){return{generate:"生成",import:"インポート",modify:"修正",delete:"削除"}[e]||e}createFloatingChocolateIcon(){this.floatingChocolateIcon&&this.floatingChocolateIcon.remove(),this.floatingChocolateIcon=document.createElement("div"),this.floatingChocolateIcon.innerHTML="🍫",this.floatingChocolateIcon.title="ChocoDrop を開く (@キーでも開けます)",this.floatingChocolateIcon.style.cssText="\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      width: 48px;\n      height: 48px;\n      border-radius: 50%;\n      background: rgba(99, 102, 241, 0.15);\n      backdrop-filter: blur(16px);\n      -webkit-backdrop-filter: blur(16px);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05);\n      opacity: 0.8;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 20px;\n      cursor: pointer;\n      z-index: 999;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      transform: scale(1);\n      filter: none;\n    ",this.floatingChocolateIcon.addEventListener("mouseover",()=>{this.floatingChocolateIcon.style.transform="scale(1.1) translateY(-2px)",this.floatingChocolateIcon.style.boxShadow="0 6px 16px rgba(99, 102, 241, 0.3), 0 3px 8px rgba(0, 0, 0, 0.1)",this.floatingChocolateIcon.style.opacity="1",this.floatingChocolateIcon.style.filter="none"}),this.floatingChocolateIcon.addEventListener("mouseout",()=>{this.floatingChocolateIcon.style.transform="scale(1) translateY(0)",this.floatingChocolateIcon.style.boxShadow="0 4px 12px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05)",this.floatingChocolateIcon.style.opacity="0.8",this.floatingChocolateIcon.style.filter="none"}),this.floatingChocolateIcon.addEventListener("click",()=>{this.isVisible?this.hide():this.show()}),this.floatingChocolateIcon.addEventListener("contextmenu",e=>{e.preventDefault(),this.showFloatingIconContextMenu(e)}),document.body.appendChild(this.floatingChocolateIcon)}showFloatingIconContextMenu(e){const t=document.querySelector(".floating-icon-context-menu");t&&t.remove();const n=document.createElement("div");n.className="floating-icon-context-menu",n.style.cssText=`\n      position: fixed;\n      top: ${e.clientY}px;\n      left: ${e.clientX}px;\n      background: ${this.isWabiSabiMode?"rgba(239, 235, 233, 0.9)":this.isDarkMode?"rgba(17, 24, 39, 0.85)":"rgba(255, 255, 255, 0.85)"};\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid ${this.isWabiSabiMode?"rgba(161, 136, 127, 0.4)":this.isDarkMode?"rgba(129, 140, 248, 0.3)":"rgba(99, 102, 241, 0.2)"};\n      border-radius: 12px;\n      box-shadow: ${this.isWabiSabiMode?"0 8px 24px rgba(93, 64, 55, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1)":"0 8px 24px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1)"};\n      padding: 8px 0;\n      min-width: 160px;\n      z-index: 2000;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      color: ${this.isWabiSabiMode?"#5D4037":this.isDarkMode?"#ffffff":"#1f2937"};\n    `;const i=document.createElement("div");i.innerHTML="📄 フォームを開く",i.style.cssText=`\n      padding: 8px 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      color: ${this.isWabiSabiMode?"#8D6E63":"#6366f1"};\n      text-shadow: ${this.isWabiSabiMode?"0 2px 4px rgba(141, 110, 99, 0.3)":"0 2px 4px rgba(99, 102, 241, 0.3)"};\n    `,i.addEventListener("mouseover",()=>{i.style.background=this.isWabiSabiMode?"rgba(161, 136, 127, 0.15)":this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(99, 102, 241, 0.1)",i.style.textShadow=this.isWabiSabiMode?"0 2px 6px rgba(141, 110, 99, 0.5)":"0 2px 6px rgba(99, 102, 241, 0.5)"}),i.addEventListener("mouseout",()=>{i.style.background="transparent",i.style.textShadow=this.isWabiSabiMode?"0 2px 4px rgba(141, 110, 99, 0.3)":"0 2px 4px rgba(99, 102, 241, 0.3)"}),i.addEventListener("click",()=>{n.remove(),this.isVisible?this.hide():this.show()});const o=document.createElement("div");o.innerHTML="✕ アイコンを非表示",o.style.cssText=`\n      padding: 8px 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      color: ${this.isWabiSabiMode?"#8D6E63":"#6366f1"};\n      text-shadow: ${this.isWabiSabiMode?"0 2px 4px rgba(141, 110, 99, 0.3)":"0 2px 4px rgba(99, 102, 241, 0.3)"};\n    `,o.addEventListener("mouseover",()=>{o.style.background=this.isWabiSabiMode?"rgba(161, 136, 127, 0.15)":this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(99, 102, 241, 0.1)",o.style.textShadow=this.isWabiSabiMode?"0 2px 6px rgba(141, 110, 99, 0.5)":"0 2px 6px rgba(99, 102, 241, 0.5)"}),o.addEventListener("mouseout",()=>{o.style.background="transparent",o.style.textShadow=this.isWabiSabiMode?"0 2px 4px rgba(141, 110, 99, 0.3)":"0 2px 4px rgba(99, 102, 241, 0.3)"}),o.addEventListener("click",()=>{n.remove(),this.hideFloatingIcon()}),n.appendChild(i),n.appendChild(o),document.body.appendChild(n);const r=n.getBoundingClientRect();r.right>window.innerWidth&&(n.style.left=e.clientX-r.width+"px"),r.bottom>window.innerHeight&&(n.style.top=e.clientY-r.height+"px");const a=e=>{n.contains(e.target)||(n.remove(),document.removeEventListener("click",a))};setTimeout(()=>{document.addEventListener("click",a)},10)}hideFloatingIcon(){this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.display="none")}showFloatingIcon(){this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.display="flex")}dispose(){this.clearKeywordHighlighting(),this.fileInput&&this.fileInput.parentNode&&this.fileInput.parentNode.removeChild(this.fileInput),this.selectedFile&&this.selectedFile.url&&URL.revokeObjectURL(this.selectedFile.url),this.floatingChocolateIcon&&this.floatingChocolateIcon.parentNode&&this.floatingChocolateIcon.parentNode.removeChild(this.floatingChocolateIcon),this.container&&this.container.parentElement&&this.container.parentElement.removeChild(this.container)}showOverlayTextarea(){if(this.overlayTextarea)return;this.isExpanded=!0,this.overlayTextarea=document.createElement("textarea"),this.overlayTextarea.value=this.input.value,this.overlayTextarea.placeholder=this.input.placeholder;const e=this.container.getBoundingClientRect(),t=20;let n=e.top+60,i=e.left,o=e.width;i+o>window.innerWidth-t&&(i=window.innerWidth-o-t),i<t&&(i=t,o=Math.min(o,window.innerWidth-40)),n+300>window.innerHeight-t&&(n=Math.max(t,window.innerHeight-300-t));const r=this.isWabiSabiMode?"linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))":this.isDarkMode?"linear-gradient(135deg, rgba(30, 27, 75, 0.4), rgba(15, 23, 42, 0.5))":"linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))",a=this.isWabiSabiMode?"1px solid rgba(93, 64, 55, 0.5)":this.isDarkMode?"1px solid rgba(99, 102, 241, 0.25)":"1px solid rgba(255, 255, 255, 0.5)",s=this.isWabiSabiMode?"0 4px 16px rgba(66, 66, 66, 0.3), inset 0 1px 0 rgba(189, 189, 189, 0.2)":this.isDarkMode?"0 4px 16px rgba(15, 23, 42, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08)":"0 4px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.4)",l=this.getInputTextColor();this.overlayTextarea.style.cssText=`\n      position: fixed;\n      top: ${n}px;\n      left: ${i}px;\n      width: ${o}px;\n      height: 300px;\n      box-sizing: border-box;\n      background: ${r};\n      backdrop-filter: blur(24px) saturate(180%);\n      border: ${a};\n      box-shadow: ${s};\n      border-radius: 16px;\n      color: ${l};\n      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      line-height: 1.5;\n      padding: 20px;\n      resize: none;\n      outline: none;\n      z-index: 10000;\n      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);\n      opacity: 0;\n      transition: opacity 0.2s ease-out;\n    `,document.body.appendChild(this.overlayTextarea),requestAnimationFrame(()=>{this.overlayTextarea.style.opacity="1"}),this.overlayTextarea.focus(),this.overlayTextarea.addEventListener("input",e=>{this.input.value=e.target.value}),this.overlayTextarea.addEventListener("keydown",e=>{"Escape"===e.key&&this.hideOverlayTextarea()}),this.overlayTextarea.addEventListener("blur",()=>{setTimeout(()=>this.hideOverlayTextarea(),100)})}hideOverlayTextarea(){this.overlayTextarea&&(this.isExpanded=!1,this.overlayTextarea.style.opacity="0",setTimeout(()=>{this.overlayTextarea&&(document.body.removeChild(this.overlayTextarea),this.overlayTextarea=null)},200))}hideOverlayTextarea(){this.overlayTextarea&&(this.isExpanded=!1,this.overlayTextarea.style.opacity="0",setTimeout(()=>{this.overlayTextarea&&(document.body.removeChild(this.overlayTextarea),this.overlayTextarea=null)},200))}}function x(e,t={}){if(!e)throw new Error("THREE.Scene インスタンスが必要です");const{camera:n=null,renderer:i=null,serverUrl:r=null,client:a=null,onControlsToggle:s=()=>{},sceneOptions:l={},uiOptions:c={},...d}=t,h=r||l.serverUrl||null,u=a||new o(h),g=new p(e,{camera:n,renderer:i,serverUrl:h,client:u,...l,...d}),m=new f({sceneManager:g,client:u,onControlsToggle:s,...c,skipServiceDialog:t.skipServiceDialog});return{client:u,sceneManager:g,ui:m,dispose(){m.dispose?.(),g.dispose?.()}}}const v=x,S=x;function k(e,t={}){if(!e)throw new Error("THREE.Scene インスタンスが必要です");const n=["enableServerHealthCheck","skipServiceDialog","theme","showExamples","autoScroll","enableDebugLogging"],{camera:i=null,renderer:r=null,serverUrl:a=null,client:s=null,onControlsToggle:l=()=>{},sceneOptions:c={},uiOptions:d={},...h}=t,u=a||c.serverUrl||null,g=s||new o(u),b={},y={};Object.keys(h).forEach(e=>{n.includes(e)?b[e]=h[e]:y[e]=h[e]});const f={...b,...d},x={...c,...y},v=new p(e,{camera:i,renderer:r,serverUrl:u,client:g,...x}),S=new m({sceneManager:v,client:g,onControlsToggle:l,...f});return v.ui=S,S.setSceneManager(v),{sceneManager:v,ui:S,client:g,dispose:()=>{S&&S.dispose(),v&&v.dispose()}}}var w={ChocoDropClient:o,ChocoDroClient:a,LiveCommandClient:r,SceneManager:p,CommandUI:m,CommandUIDemo:m,createChocoDrop:k,createChocoDro:v,createLiveCommand:S};e.ChocoDroClient=a,e.ChocoDropClient=o,e.CommandUIDemo=m,e.LiveCommandClient=r,e.SceneManager=p,e.createChocoDro=v,e.createChocoDrop=k,e.createChocoDropDemo=k,e.createLiveCommand=S,e.default=w,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=chocodrop-demo.umd.min.js.map
