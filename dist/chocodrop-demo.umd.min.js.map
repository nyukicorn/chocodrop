{"version":3,"names":["ChocoDropClient","constructor","serverUrl","this","initialized","initPromise","console","log","initializeWithConfig","baseUrl","window","location","protocol","hostname","port","response","fetch","ok","config","json","detectServerUrl","error","warn","currentPort","ensureInitialized","Error","generateImage","prompt","options","payload","width","height","service","method","headers","body","JSON","stringify","status","result","generateVideo","safeDefaults","resolution","enable_safety_checker","enable_prompt_expansion","duration","aspect_ratio","model","seed","negative_prompt","frames_per_second","guidance_scale","executeCommand","command","getAvailableServices","LiveCommandClient","ChocoDroClient","SceneManager","scene","camera","renderer","labelRenderer","client","experimentGroup","THREE","Group","name","add","commandHistory","spawnedObjects","Map","objectCounter","selectedObject","selectedImageService","selectedVideoService","clock","Clock","raycaster","Raycaster","mouse","Vector2","lastHoveredObject","showLocationIndicator","indicatorDuration","defaultObjectScale","enableObjectSelection","enableMouseInteraction","enableDebugLogging","setupClickEvents","globalThis","sceneManager","setupObjectDragging","debugSceneInfo","position","x","toFixed","y","z","rotation","Math","PI","fov","near","far","children","length","getObjectByName","size","forEach","obj","id","worldPos","Vector3","getWorldPosition","userData","type","visible","scale","box","Box3","setFromObject","getSize","center","getCenter","meshCount","traverse","child","isMesh","distance","distanceTo","selectObject","object","deselectObject","createModernSelectionIndicator","commandUI","objectInfo","addOutput","modelName","currentMode","objectName","originalPrompt","input","value","focus","setSelectionRange","existingIndicator","remove","indicatorGroup","margin","adjustedSize","geometry","parameters","shape","Shape","moveTo","lineTo","points","getPoints","geometryLine","BufferGeometry","setFromPoints","adaptiveColor","getAdaptiveSelectionColor","materialLine","LineBasicMaterial","color","linewidth","transparent","opacity","line","Line","set","edgesGeometry","EdgesGeometry","BoxGeometry","edgesMaterial","edges","LineSegments","copy","addResizeHandles","parentObject","handleSize","handleGeometry","handleMaterial","MeshBasicMaterial","depthTest","depthWrite","handleHoverMaterial","getAdaptiveHoverColor","positions","corner","pos","index","handle","Mesh","clone","isResizeHandle","handleIndex","defaultMaterial","material","hoverMaterial","renderOrder","onHover","setScalar","document","style","cursor","onHoverExit","updateSelectionIndicatorScale","indicator","dispose","Array","isArray","canvas","domElement","isDragging","dragObject","dragOffset","mouseStart","dragMode","originalScale","addEventListener","event","button","rect","getBoundingClientRect","clientX","left","clientY","top","setFromCamera","intersects","intersectObjects","resizeHandleInfo","isRotateHandle","source","showDeleteConfirmation","then","confirmed","removeObject","catch","point","sub","handleHoverEffects","deltaX","deltaY","scaleMultiplier","abs","newScale","max","min","cameraRight","cameraUp","getWorldDirection","setFromMatrixColumn","matrixWorld","normalize","moveScale","worldMove","multiplyScalar","preventDefault","scaleFactor","emissive","setHex","setTimeout","rotationStep","rotated","key","newRotationX","newRotationXDown","cameraDirection","targetPoint","lookAt","angles","timestamp","Date","now","parsed","parseCommand","dispatchCommand","push","message","startsWith","actualCommand","replace","parseObjectModificationCommand","toLowerCase","trim","parseDeleteCommand","cmd","naturalLanguagePattern","parseNaturalLanguageCommand","videoKeywords","isVideoRequest","some","keyword","includes","parsePosition","parseSize","selectKeywords","isSelectRequest","importKeywords","isImportRequest","isVideoImport","fileType","imageKeywords","findObjectByKeyword","objectKeywords","split","aliases","Object","entries","alias","generatedObjects","filter","lastObject","parseImageGenerationCommand","particles","particle","parts","colorMap","colorName","colorValue","match","parseFloat","movement","parsePositionFromPrompt","degreeMatch","requiresSelection","target","movePatterns","pattern","regex","RegExp","direction","targetObjectName","requiresObjectSearch","colorPatterns","colorKeywords","colorKey","distanceMatch","executeImageGeneration","executeVideoGeneration","executeObjectModification","executeNaturalObjectModification","executeDelete","executeFileImport","executeObjectSelection","fallbackSizes","imageResult","lastError","i","dimensions","undefined","success","loader","TextureLoader","texture","imageUrl","localPath","filename","pop","loadAsync","colorSpace","SRGBColorSpace","createFallbackTexture","sizeScale","baseSize","imageWidth","image","naturalWidth","data","imageHeight","naturalHeight","aspectRatio","planeWidth","planeHeight","PlaneGeometry","map","side","DoubleSide","toneMapped","plane","finalPosition","calculateCameraRelativePosition","alignPlaneToCamera","objectId","createdAt","createLocationIndicator","videoResult","videoTexture","video","videoUrl","createElement","src","crossOrigin","loop","muted","playsInline","VideoTexture","play","createFallbackVideoTexture","requestedWidth","metadata","requestedHeight","planeAspect","videoElement","createAudioControl","fallbackVideoTexture","loadImageFile","fileUrl","fileName","importOrder","loadVideoFile","autoplay","preload","Promise","resolve","reject","handleLoaded","videoWidth","videoHeight","handleError","once","load","playError","objectUrl","targetObjects","findObjectsByName","targetObject","selectObjectFromMultiple","modified","toString","currentPos","newPos","lastModified","modifications","searchName","results","searchLower","promptLower","objects","originalCommand","ordinalPatterns","parseInt","matchedText","currentScale","currentRotation","newRotation","degrees","currentOpacity","clearAll","targetByKeyword","deleteReason","isSimpleDeleteCommand","deletedObjectId","display","accept","appendChild","onchange","async","file","files","URL","createObjectURL","removeChild","oncancel","click","getSpawnedObjects","modal","cssText","container","title","textContent","objectList","item","time","toLocaleTimeString","innerHTML","round","onmouseover","borderColor","background","onmouseout","onclick","selectedObjectId","cancelBtn","ctx","getContext","hash","hashString","hue","gradient","createLinearGradient","addColorStop","fillStyle","fillRect","font","textAlign","fillText","slice","CanvasTexture","animationFrame","animate","offset","icons","iconIndex","floor","requestAnimationFrame","str","char","charCodeAt","from","get","pause","removeAttribute","revokeObjectURL","delete","materials","mat","objectIds","keys","getCommandHistory","relativePosition","SphereGeometry","indicatorPos","parent","cameraPos","crossVectors","cameraUpActual","logDebug","forward","negate","up","applyQuaternion","quaternion","dot","right","orientation","Matrix4","makeBasis","setFromRotationMatrix","setCamera","updateConfig","newConfig","setImageService","serviceId","getImageService","setVideoService","getVideoService","videoObject","audioButton","className","createTooltip","tooltip","createVolumeSlider","sliderContainer","slider","head","e","volume","volumeSlider","isSliderVisible","transform","buttonRect","stopPropagation","pointerEvents","querySelector","contains","audioControlElement","updateAudioControlPosition","audioControlUpdateInterval","setInterval","cleanupCallbacks","parentNode","vector","project","offsetX","offsetY","toggleVideoAudio","initializeLabelRenderer","loadAndInitializeCSS2DRenderer","ensureCSS2DRenderer","css2dInitPromise","CSS2DRenderer","setupCSS2DRenderer","module","import","CSS2DObject","setSize","innerWidth","innerHeight","addLabelRendererResizeHandler","labelRendererResizeHandler","updateRenderer","render","args","backgroundColor","bgColor","r","g","b","isColor","getLuminance","rs","pow","gs","bs","bgLuminance","IMAGE_SERVICE_STORAGE_KEY","VIDEO_SERVICE_STORAGE_KEY","CommandUIDemo","onControlsToggle","isVisible","output","activeConnections","currentTaskId","activationKey","maxHeight","theme","showExamples","autoScroll","availableImageServices","availableVideoServices","imageServiceSelect","videoServiceSelect","serviceSelectorContainer","serviceSelectorStatus","serviceSelectorContent","serviceSelectorRetryButton","serviceSelectorSaveButton","serviceSelectorCancelButton","serviceModalOverlay","serviceModal","servicesLoading","isExpanded","overlayTextarea","pendingImageService","pendingVideoService","storedImage","localStorage","getItem","storedVideo","applyServiceSelectionToSceneManager","currentTheme","isDarkMode","isWabiSabiMode","currentHistoryIndex","maxHistorySize","initUI","bindEvents","createServiceModal","createFloatingChocolateIcon","refreshStyles","openServiceModal","showDemoMessage","showCompactToast","existingToast","getElementById","buttonContainer","radioModeContainer","toast","getContainerStyles","brandIndicator","brandText","outputDiv","getOutputStyles","floatingContainer","taskCards","inputWrapper","rows","placeholder","getInputStyles","expandButton","hideOverlayTextarea","showOverlayTextarea","modeSelector","createRadioModeSelector","actionContainer","createMinimalActions","closeButton","hide","applyTheme","isComposing","hasCompositionJustEnded","autoResizeTextarea","detectCommandType","isSafari","test","navigator","userAgent","leftSection","clearBtn","getActionButtonStyles","clearAllWithConfirmation","historyBtn","disabled","rightSection","themeToggle","getThemeIcon","themeConfig","light","dark","wabisabi","getThemeTitle","titleConfig","getThemeIconWithFilter","icon","toggleTheme","settingsButton","createServiceSelectorSection","fontSize","marginBottom","updateServiceSelectorTheme","closeServiceModal","subtitle","selector","actionRow","initializeServiceSelector","actionButtons","handleServiceSave","toggleServiceRetryButton","forceFetch","resetPendingSelections","force","setServiceSelectorStatus","setServiceButtonsEnabled","resolveServiceSelection","default","populateServiceSelector","dataset","statusType","classList","toggle","services","defaultId","storageKey","storedId","isStoredValid","resolvedId","setItem","removeItem","hasImage","hasVideo","imageRow","buildServiceRow","videoRow","labelText","selectedId","row","label","fontWeight","select","serviceType","fontFamily","option","description","onServiceSelectionChange","findServiceInfo","lineHeight","minHeight","info","parentElement","newImageId","newVideoId","imageInfo","videoInfo","enabled","childElementCount","list","find","border","statusColor","labels","querySelectorAll","selects","padding","borderRadius","outline","boxShadow","descriptions","desc","modes","radioModeButtons","mode","autoBadge","triggerFileSelection","selectMode","isManual","detectedKeyword","selectedGlass","addPulseEffect","addContainerGlow","getPlaceholderForMode","clearInputOnModeSwitch","selectedFile","showImportInterface","hideImportInterface","handleDeleteModeSelection","handleModifyModeSelection","element","animation","ensurePulseAnimation","glowColors","generate","modify","glowColor","variant","baseStyles","getDestructiveButtonStyles","getCommandTypeIndicatorStyles","maxLines","newHeight","scrollHeight","overflowY","commandType","analyzeCommandType","text","mediaInfo","detectMediaType","deletePatterns","modifyPatterns","generatePatterns","confidence","reason","mediaType","requiresConfirmation","videoPatterns","imagePatterns","showCommandTypeIndicator","commandInfo","showProactiveSuggestion","hideProactiveSuggestion","enableGestureControl","detectedType","proactiveSuggestion","insertBefore","alternativeTypes","t","suggestion","suggestionLabels","updateIndicatorForMode","gestureEnabled","createActionButtons","getModernButtonStyles","glassmorphismDark","backdropFilter","glassmorphismLight","glassmorphismWabiSabi","getHeaderStyles","gradientColors","addScrollbarStyles","styles","primary","secondary","danger","getModeButtonStyles","isActive","modeColors","ctrlKey","shiftKey","undo","redo","show","flexDirection","containerRect","floatingChocolateIcon","switchMode","btn","executeBtn","buttonColors","placeholders","handleDemoOrientationCommand","normalized","wantsVerticalFlip","wantsHorizontalFlip","wantsRotateRight","wantsRotateLeft","wantsRotateBack","hasOrientationKeyword","handled","operations","currentX","currentY","join","taskId","addTaskCard","saveCommandToHistory","modePrefix","getModePrefix","fullCommand","handleImportCommand","orientationResult","modifySelectedObject","getSelectedObjects","confirmMessage","confirm","deleteObjects","connectToProgress","successMessages","updateTaskCard","errorMessages","scrollToBottom","showConfirmationDialog","confirmText","cancelText","confirmColor","dialog","closeModalWithAnimation","escHandler","removeEventListener","addSystemMessage","taskInfo","random","substr","card","setAttribute","getFloatingCardStyles","setProperty","iconMap","pending","processing","progress","completed","friendlyMessage","getFriendlyMessage","updateCardDisplayLimit","startTime","endTime","contentType","settings","addCardDetailEvents","animateCardEntrance","has","taskData","animateCardSuccess","animateCardError","entry","getTaskCardStyles","statusBorders","maxVisibleCards","allCards","existingCounter","hiddenCount","counter","counterBaseColor","counterBorderColor","counterTextColor","firstChild","counterHoverColor","isTouchDevice","maxTouchPoints","showTaskDetailModal","hoverTimeout","clearTimeout","existingModal","createTaskDetailModal","overlayColor","modalBg","modalBorder","textColor","labelColor","statusText","modalContent","closeBtn","closeTaskDetailModal","transition","animateCardExit","addErrorTooltip","getResponseType","errorMessage","shortPrompt","substring","responseType","shortError","getStatusColor","colors","createStatusIndicator","animateTaskCompletion","addSubtleParticleEffect","ensureTaskAnimations","angle","cos","sin","addTaskStatus","percent","updateTaskProgress","newMessage","existingTask","completeTask","serverTaskId","uiTaskId","eventSource","EventSource","onmessage","parse","handleProgressUpdate","onerror","disconnectProgress","connection","close","scrollTop","prefixes","commandData","shift","updateUndoRedoButtons","canUndo","undoLastGenerate","undoLastModify","undoLastDelete","canRedo","redoCommand","undoBtn","redoBtn","showClearAllConfirmation","examples","example","setSceneManager","setClient","generateBtn","themeOrder","currentIndex","indexOf","nextIndex","currentDisplay","currentFlexDirection","brandBadge","updateFloatingContainerTheme","updateExistingTextColors","system","hint","defaultTextColor","fileInput","handleFileSelection","enableDragAndDrop","fileSelectButton","disableDragAndDrop","openFileSelector","detectFileType","url","defaultPrompt","handleDragOver","bind","handleDrop","handleDragEnter","handleDragLeave","dataTransfer","ext","load3DModel","processedFileName","importedType","importedUrl","triggerAttentionAnimation","chatOutput","inputField","addMicroShakeEffect","addContextGlow","addEmotionalPulse","add3DDepthEffect","ensureMicroShakeAnimation","pulseColor","borderLeft","ensureEmotionalPulseAnimation","newMode","isPreviousModeMessage","getModeDisplayName","inputValue","importPatterns","modeNames","showFloatingIconContextMenu","existingMenu","menu","openFormItem","textShadow","hideIconItem","hideFloatingIcon","bottom","closeMenu","showFloatingIcon","overlayHeight","overlayBackground","overlayBorder","overlayInnerShadow","overlayTextColor","KEYWORD_HIGHLIGHT_COLOR","CommandUI","highlightOverlay","inputDefaultStyles","applyKeywordHighlighting","getAllCommandKeywords","createHighlightOverlay","matches","clearKeywordHighlighting","computedStyle","getComputedStyle","captureInputDefaultStyles","letterSpacing","borderWidth","highlightedHTML","lastIndex","escapeHtml","start","getKeywordColor","end","backgroundImage","getInputTextColor","div","ensureShimmerStyles","styleSheet","shimmerEffect","floatingAnimation","updateServiceModalStyles","hadHighlight","createChocoDrop","sceneOptions","uiOptions","resolvedServerUrl","chocoDropClient","ui","createChocoDro","createLiveCommand","createChocoDropDemo","otherSceneOptions","mergedSceneOptions"],"sources":["../src/client/LiveCommandClient.js","../src/client/SceneManager.js","../src/client/demo/CommandUIDemo.js","../src/client/CommandUI.js","../src/client/bootstrap.js","../src/client/demo/index.js"],"sourcesContent":["/**\n * ChocoDrop Client - ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ\n */\nexport class ChocoDropClient {\n  constructor(serverUrl = null) {\n    this.serverUrl = null;\n    this.initialized = false;\n    this.initPromise = null;\n\n    if (serverUrl) {\n      this.serverUrl = serverUrl;\n      this.initialized = true;\n      console.log('ğŸ« ChocoDropClient initialized:', serverUrl);\n    } else {\n      // è¨­å®šå–å¾—ã‚’é…å»¶å®Ÿè¡Œï¼ˆPromiseã‚’ä¿å­˜ï¼‰\n      this.initPromise = this.initializeWithConfig();\n    }\n  }\n\n  /**\n   * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¨­å®šã‚’å–å¾—ã—ã¦åˆæœŸåŒ–\n   */\n  async initializeWithConfig() {\n    try {\n      // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ›ã‚¹ãƒˆã¨ãƒãƒ¼ãƒˆã‚’åŸºæº–ã«è¨­å®šAPIå‘¼ã³å‡ºã—\n      const baseUrl = `${window.location.protocol}//${window.location.hostname}:${window.location.port}`;\n\n      const response = await fetch(`${baseUrl}/api/config`);\n      if (response.ok) {\n        const config = await response.json();\n        this.serverUrl = config.serverUrl;\n        console.log('ğŸ« ChocoDropClient initialized from config:', this.serverUrl);\n      } else {\n        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒãƒ¼ãƒˆæ¨æ¸¬\n        this.serverUrl = this.detectServerUrl();\n        console.log('ğŸ« ChocoDropClient fallback to detected URL:', this.serverUrl);\n      }\n    } catch (error) {\n      console.warn('âš ï¸ ChocoDrop config fetch failed, using fallback:', error);\n      this.serverUrl = this.detectServerUrl();\n    }\n\n    this.initialized = true;\n  }\n\n  /**\n   * ã‚µãƒ¼ãƒãƒ¼URLè‡ªå‹•æ¤œå‡ºï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰\n   */\n  detectServerUrl() {\n    const currentPort = window.location.port;\n    const protocol = window.location.protocol;\n    const hostname = window.location.hostname;\n\n    // ãƒãƒ¼ãƒˆãŒæœªæŒ‡å®šã®å ´åˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ­ãƒˆã‚³ãƒ«ç­‰ï¼‰ã¯æ—¢å®šã® 3011 ã‚’ä½¿ç”¨\n    if (!currentPort) {\n      return `${protocol}//${hostname}:3011`;\n    }\n\n    return `${protocol}//${hostname}:${currentPort}`;\n  }\n\n  /**\n   * åˆæœŸåŒ–å®Œäº†ã‚’å¾…æ©Ÿ\n   */\n  async ensureInitialized() {\n    if (this.initialized) return;\n\n    // initPromiseãŒã‚ã‚Œã°å¾…æ©Ÿ\n    if (this.initPromise) {\n      await this.initPromise;\n      return;\n    }\n\n    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼\n    throw new Error('ChocoDropClient not initialized');\n  }\n\n  /**\n   * ç”»åƒç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n   */\n  async generateImage(prompt, options = {}) {\n    await this.ensureInitialized();\n    console.log(`ğŸ¨ Requesting image generation: \"${prompt}\"`);\n\n    try {\n      const payload = {\n        prompt,\n        width: options.width || 512,\n        height: options.height || 512\n      };\n\n      if (options.service) {\n        payload.service = options.service;\n      }\n\n      const response = await fetch(`${this.serverUrl}/api/generate`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(payload)\n      });\n\n      if (!response.ok) {\n        throw new Error(`Server error: ${response.status}`);\n      }\n\n      const result = await response.json();\n      console.log('âœ… Image generation result:', result);\n      \n      return result;\n\n    } catch (error) {\n      console.error('âŒ Image generation request failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * å‹•ç”»ç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n   */\n  async generateVideo(prompt, options = {}) {\n    await this.ensureInitialized();\n    console.log(`ğŸ¬ Requesting video generation: \"${prompt}\"`);\n\n    try {\n      const safeDefaults = {\n        // aspect_ratio: ã‚µãƒ¼ãƒãƒ¼å´ã§å„ãƒ¢ãƒ‡ãƒ«æœ€é©ãªæ¯”ç‡ã‚’è‡ªå‹•é¸æŠ\n        resolution: '720p',\n        enable_safety_checker: true,\n        enable_prompt_expansion: true\n      };\n\n      const payload = {\n        prompt,\n        duration: typeof options.duration === 'number' && options.duration > 0 ? options.duration : 3,\n        resolution: options.resolution || safeDefaults.resolution,\n        enable_safety_checker: options.enable_safety_checker ?? safeDefaults.enable_safety_checker,\n        enable_prompt_expansion: options.enable_prompt_expansion ?? safeDefaults.enable_prompt_expansion\n      };\n\n      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’æŒ‡å®šã—ãŸå ´åˆã®ã¿è¿½åŠ \n      if (options.aspect_ratio) {\n        payload.aspect_ratio = options.aspect_ratio;\n      }\n      // ãã‚Œä»¥å¤–ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§å„ãƒ¢ãƒ‡ãƒ«ã«æœ€é©ãªæ¯”ç‡ã‚’è‡ªå‹•é¸æŠ\n\n      if (options.model) {\n        payload.model = options.model;\n      }\n\n      if (typeof options.width === 'number' && options.width > 0) {\n        payload.width = options.width;\n      }\n\n      if (typeof options.height === 'number' && options.height > 0) {\n        payload.height = options.height;\n      }\n\n      if (typeof options.seed === 'number') {\n        payload.seed = options.seed;\n      }\n\n      if (options.negative_prompt) {\n        payload.negative_prompt = options.negative_prompt;\n      }\n\n      if (typeof options.frames_per_second === 'number' && options.frames_per_second > 0) {\n        payload.frames_per_second = options.frames_per_second;\n      }\n\n      if (typeof options.guidance_scale === 'number') {\n        payload.guidance_scale = options.guidance_scale;\n      }\n\n      const response = await fetch(`${this.serverUrl}/api/generate-video`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(payload)\n      });\n\n      if (!response.ok) {\n        throw new Error(`Server error: ${response.status}`);\n      }\n\n      const result = await response.json();\n      console.log('âœ… Video generation result:', result);\n      \n      return result;\n\n    } catch (error) {\n      console.error('âŒ Video generation request failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * è‡ªç„¶è¨€èªã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ\n   */\n  async executeCommand(command) {\n    await this.ensureInitialized();\n    console.log(`ğŸ¯ Executing command: \"${command}\"`);\n\n    try {\n      const response = await fetch(`${this.serverUrl}/api/command`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ command })\n      });\n\n      if (!response.ok) {\n        throw new Error(`Server error: ${response.status}`);\n      }\n\n      const result = await response.json();\n      console.log('âœ… Command execution result:', result);\n      \n      return result;\n\n    } catch (error) {\n      console.error('âŒ Command execution failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * åˆ©ç”¨å¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§å–å¾—\n   */\n  async getAvailableServices() {\n    await this.ensureInitialized();\n    try {\n      const response = await fetch(`${this.serverUrl}/api/services`);\n      \n      if (!response.ok) {\n        throw new Error(`Server error: ${response.status}`);\n      }\n\n      return await response.json();\n\n    } catch (error) {\n      console.error('âŒ Failed to get services:', error);\n      return [];\n    }\n  }\n}\n\n// å¾Œæ–¹äº’æ›ã®ãŸã‚æ—§åç§°ã‚‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ\nexport const LiveCommandClient = ChocoDropClient;\nexport const ChocoDroClient = ChocoDropClient;\n","import * as THREE from 'three';\nimport { ChocoDropClient, ChocoDroClient, LiveCommandClient } from './LiveCommandClient.js';\n\n/**\n * Scene Manager - 3D scene integration for ChocoDrop System\n * Handles natural language parsing and 3D object management\n */\nexport class SceneManager {\n  constructor(scene, options = {}) {\n    if (!scene) {\n      throw new Error('THREE.Scene is required');\n    }\n    \n    this.scene = scene;\n    this.camera = options.camera || null;\n    this.renderer = options.renderer || null;\n    this.labelRenderer = null; // CSS2DRenderer for UI overlays like audio controls\n    // ChocoDrop Clientï¼ˆå…±é€šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ³¨å…¥ã‚’å„ªå…ˆï¼‰\n    // å¤–éƒ¨ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰å…±æœ‰ã™ã‚‹å ´åˆã¯ options.client ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å†åˆ©ç”¨\n    this.client = options.client || new ChocoDropClient(options.serverUrl);\n    \n    // å®Ÿé¨“ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ç”¨ã‚°ãƒ«ãƒ¼ãƒ—\n    this.experimentGroup = new THREE.Group();\n    this.experimentGroup.name = 'LiveExperiments';\n    // ä¸€æ—¦ã‚·ãƒ¼ãƒ³ã«è¿½åŠ ï¼ˆå¾Œã§ã‚«ãƒ¡ãƒ©ã«ç§»å‹•ã™ã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰\n    this.scene.add(this.experimentGroup);\n    \n    // ã‚³ãƒãƒ³ãƒ‰å±¥æ­´\n    this.commandHistory = [];\n    \n    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†\n    this.spawnedObjects = new Map();\n    this.objectCounter = 0;\n    this.selectedObject = null;\n    this.selectedImageService = options.selectedImageService || null;\n    this.selectedVideoService = options.selectedVideoService || null;\n\n    // Animationç®¡ç†ï¼ˆUIè¦ç´ ç”¨ï¼‰\n    this.clock = new THREE.Clock();\n    \n    // ãƒ¬ã‚¤ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ç”¨\n    this.raycaster = new THREE.Raycaster();\n    this.mouse = new THREE.Vector2();\n    this.lastHoveredObject = null;\n    \n    // è¨­å®š\n    this.config = {\n      showLocationIndicator: options.showLocationIndicator !== false,\n      indicatorDuration: options.indicatorDuration || 3000,\n      defaultObjectScale: options.defaultObjectScale || 1.0,\n      enableObjectSelection: options.enableObjectSelection !== false,\n      enableMouseInteraction: options.enableMouseInteraction,\n      enableDebugLogging: options.enableDebugLogging === true,\n      ...options.config\n    };\n    \n    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š\n    this.setupClickEvents();\n    \n    console.log('ğŸ§ª SceneManager initialized with click selection');\n\n    // ãƒ‡ãƒãƒƒã‚°ã‚„ã‚³ãƒ³ã‚½ãƒ¼ãƒ«æ“ä½œã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã‚’ä¿æŒ\n    if (typeof globalThis !== 'undefined') {\n      globalThis.sceneManager = this;\n    }\n  }\n  /**\n   * ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š\n   */\n  setupClickEvents() {\n    // enableMouseInteractionãŒæ˜ç¤ºçš„ã«trueã®å ´åˆã®ã¿ãƒã‚¦ã‚¹æ“ä½œã‚’æœ‰åŠ¹åŒ–\n    if (this.config.enableMouseInteraction === true && this.renderer) {\n      this.setupObjectDragging();\n      console.log('ğŸ–±ï¸ Mouse interaction enabled - Click to select, Shift+drag to move objects');\n    } else if (this.config.enableMouseInteraction === true && !this.renderer) {\n      console.warn('âš ï¸ Mouse interaction requested but renderer not provided. Mouse interaction disabled.');\n    } else {\n      console.log('ğŸ–±ï¸ Mouse interaction disabled (safe mode). Set enableMouseInteraction: true to enable.');\n    }\n  }\n\n  // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºãƒ¡ã‚½ãƒƒãƒ‰\n  debugSceneInfo() {\n    console.log('ğŸ” === SCENE DEBUG INFO ===');\n    \n    // ã‚«ãƒ¡ãƒ©æƒ…å ±\n    if (this.camera) {\n      console.log(`ğŸ“· Camera:\n        - Position: (${this.camera.position.x.toFixed(2)}, ${this.camera.position.y.toFixed(2)}, ${this.camera.position.z.toFixed(2)})\n        - Rotation: (${(this.camera.rotation.x * 180 / Math.PI).toFixed(1)}Â°, ${(this.camera.rotation.y * 180 / Math.PI).toFixed(1)}Â°, ${(this.camera.rotation.z * 180 / Math.PI).toFixed(1)}Â°)\n        - FOV: ${this.camera.fov || 'N/A'}\n        - Near/Far: ${this.camera.near || 'N/A'}/${this.camera.far || 'N/A'}`);\n    }\n    \n    // ã‚·ãƒ¼ãƒ³éšå±¤\n    console.log(`ğŸŒ³ Scene hierarchy:\n      - Total objects in scene: ${this.scene.children.length}\n      - experimentGroup exists: ${this.scene.getObjectByName('LiveExperiments') ? 'Yes' : 'No'}\n      - experimentGroup children: ${this.experimentGroup.children.length}`);\n    \n    // ç”Ÿæˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n    console.log(`ğŸ“¦ Spawned objects: ${this.spawnedObjects.size}`);\n    this.spawnedObjects.forEach((obj, id) => {\n      const worldPos = new THREE.Vector3();\n      obj.getWorldPosition(worldPos);\n      console.log(`  - ${id} (${obj.userData.type}): \n        Local: (${obj.position.x.toFixed(2)}, ${obj.position.y.toFixed(2)}, ${obj.position.z.toFixed(2)})\n        World: (${worldPos.x.toFixed(2)}, ${worldPos.y.toFixed(2)}, ${worldPos.z.toFixed(2)})\n        Visible: ${obj.visible}, Scale: ${obj.scale.x.toFixed(2)}`);\n      \n      // 3Dãƒ¢ãƒ‡ãƒ«ã®è©³ç´°æƒ…å ±\n      if (obj.userData.type === 'generated_3d_model') {\n        const box = new THREE.Box3().setFromObject(obj);\n        const size = box.getSize(new THREE.Vector3());\n        const center = box.getCenter(new THREE.Vector3());\n        console.log(`    ğŸ“ Bounding box - Center: (${center.x.toFixed(2)}, ${center.y.toFixed(2)}, ${center.z.toFixed(2)}), Size: (${size.x.toFixed(2)}, ${size.y.toFixed(2)}, ${size.z.toFixed(2)})`);\n        \n        // ãƒ¡ãƒƒã‚·ãƒ¥æ•°\n        let meshCount = 0;\n        obj.traverse((child) => {\n          if (child.isMesh) meshCount++;\n        });\n        console.log(`    ğŸ­ Meshes: ${meshCount}`);\n      }\n    });\n    \n    // ã‚«ãƒ¡ãƒ©ã‹ã‚‰ã®è·é›¢è¨ˆç®—\n    if (this.camera && this.spawnedObjects.size > 0) {\n      console.log(`ğŸ“ Distances from camera:`);\n      this.spawnedObjects.forEach((obj, id) => {\n        const distance = this.camera.position.distanceTo(obj.position);\n        console.log(`  - ${id}: ${distance.toFixed(2)} units`);\n      });\n    }\n    \n    console.log('=========================');\n  }\n  \n\n  \n  /**\n   * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ\n   */\n  selectObject(object) {\n    // æ—¢ã«åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„\n    if (this.selectedObject === object) {\n      return;\n    }\n\n    // å‰ã®é¸æŠã‚’è§£é™¤\n    this.deselectObject();\n\n    this.selectedObject = object;\n\n    this.createModernSelectionIndicator(object);\n\n    console.log(`âœ… Selected object: ${object.name}`);\n    \n    // CommandUIã«é¸æŠæƒ…å ±ã‚’è¡¨ç¤º\n    if (this.commandUI) {\n      const objectInfo = object.userData || {};\n      this.commandUI.addOutput(`ğŸ“ é¸æŠ: ${object.name}`, 'info');\n      if (objectInfo.prompt) {\n        this.commandUI.addOutput(`   ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${objectInfo.prompt}`, 'hint');\n      }\n      if (objectInfo.modelName) {\n        this.commandUI.addOutput(`   ãƒ¢ãƒ‡ãƒ«: ${objectInfo.modelName}`, 'hint');\n      }\n\n      // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ãŒå¾…æ©Ÿä¸­ã®å ´åˆã€å‰Šé™¤ã‚³ãƒãƒ³ãƒ‰ã‚’è‡ªå‹•å…¥åŠ›\n      if (this.commandUI.currentMode === 'delete') {\n        const objectName = objectInfo.originalPrompt || object.name || 'é¸æŠã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ';\n        this.commandUI.input.value = `${objectName}ã‚’å‰Šé™¤`;\n        this.commandUI.input.focus();\n        // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ–‡æœ«ã«ç§»å‹•ï¼ˆé¸æŠçŠ¶æ…‹ã‚’è§£é™¤ï¼‰\n        this.commandUI.input.setSelectionRange(this.commandUI.input.value.length, this.commandUI.input.value.length);\n        this.commandUI.addOutput(`ğŸ¯ å‰Šé™¤å¯¾è±¡è¨­å®š: ${objectName}`, 'system');\n      }\n    }\n  }\n\n  createModernSelectionIndicator(object) {\n    // ã‚·ãƒ³ãƒ—ãƒ«ã§ç¢ºå®Ÿãªé¸æŠã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼\n    // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰\n    const existingIndicator = object.getObjectByName('selectionIndicator');\n    if (existingIndicator) {\n      object.remove(existingIndicator);\n    }\n\n    const indicatorGroup = new THREE.Group();\n    indicatorGroup.name = 'selectionIndicator';\n\n    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’æ­£ç¢ºã«å–å¾—\n    const box = new THREE.Box3().setFromObject(object);\n    const size = box.getSize(new THREE.Vector3());\n    const center = box.getCenter(new THREE.Vector3());\n\n    // å°ã•ãªãƒãƒ¼ã‚¸ãƒ³ã‚’è¿½åŠ ã—ã¦æ ãŒè¦‹ãˆã‚„ã™ãã™ã‚‹\n    const margin = 0.1;\n    const adjustedSize = new THREE.Vector3(\n      size.x + margin,\n      size.y + margin, \n      size.z + margin\n    );\n\n    // ã‚·ãƒ³ãƒ—ãƒ«ãªé»„è‰²ã„æ ç·š\n    // PlaneGeometryã®å ´åˆã¯å¹³é¢çš„ãªæ ã‚’ä½œæˆ\n    if (object.geometry && object.geometry.type === 'PlaneGeometry') {\n      // ã‚¹ã‚±ãƒ¼ãƒ«ã¯æ—¢ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é©ç”¨ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã‚¸ã‚ªãƒ¡ãƒˆãƒªã®ã‚µã‚¤ã‚ºã®ã¿ä½¿ç”¨\n      const width = object.geometry.parameters.width;\n      const height = object.geometry.parameters.height;\n      \n      // å¹³é¢ã®å‘¨ã‚Šã«æ ç·šã‚’ä½œæˆ\n      const shape = new THREE.Shape();\n      shape.moveTo(-width/2, -height/2);\n      shape.lineTo(width/2, -height/2);\n      shape.lineTo(width/2, height/2);\n      shape.lineTo(-width/2, height/2);\n      shape.lineTo(-width/2, -height/2);\n      \n      const points = shape.getPoints();\n      const geometryLine = new THREE.BufferGeometry().setFromPoints(points);\n      // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–é¸æŠã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼\n      const adaptiveColor = this.getAdaptiveSelectionColor();\n      const materialLine = new THREE.LineBasicMaterial({\n        color: adaptiveColor,\n        linewidth: 2,\n        transparent: true,\n        opacity: 0.9\n      });\n      \n      const line = new THREE.Line(geometryLine, materialLine);\n      line.position.set(0, 0, 0.01); // å°‘ã—å‰ã«å‡ºã—ã¦è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹\n      indicatorGroup.add(line);\n    } else {\n      // ãã®ä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯é€šå¸¸ã®3Dãƒœãƒƒã‚¯ã‚¹æ \n      const edgesGeometry = new THREE.EdgesGeometry(\n        new THREE.BoxGeometry(adjustedSize.x, adjustedSize.y, adjustedSize.z)\n      );\n      // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–é¸æŠã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼\n      const adaptiveColor = this.getAdaptiveSelectionColor();\n      const edgesMaterial = new THREE.LineBasicMaterial({\n        color: adaptiveColor,\n        linewidth: 2,\n        transparent: true,\n        opacity: 0.9\n      });\n      \n      const edges = new THREE.LineSegments(edgesGeometry, edgesMaterial);\n      edges.position.copy(center);\n      indicatorGroup.add(edges);\n    }\n\n    // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å­ã¨ã—ã¦è¿½åŠ ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ä¸€ç·’ã«å‹•ãï¼‰\n    object.add(indicatorGroup);\n    indicatorGroup.position.set(0, 0, 0); // è¦ªã‹ã‚‰ã®ç›¸å¯¾ä½ç½®ã¯0\n\n    // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã‚’è¿½åŠ ï¼ˆè¦ªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥æ¸¡ã™ï¼‰\n    this.addResizeHandles(indicatorGroup, adjustedSize, center, object);\n  }\n\n  /**\n   * ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã‚’è¿½åŠ \n   */\n  addResizeHandles(indicatorGroup, size, center, parentObject) {\n    // PlaneGeometryã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”¨ã®ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«\n    console.log('ğŸ”§ addResizeHandles called');\n\n    if (!parentObject) {\n      console.log('âŒ No parent object provided');\n      return;\n    }\n\n    if (!parentObject.geometry) {\n      console.log('âŒ Parent has no geometry');\n      return;\n    }\n\n    if (parentObject.geometry.type !== 'PlaneGeometry') {\n      console.log(`âŒ Geometry type is ${parentObject.geometry.type}, not PlaneGeometry`);\n      return;\n    }\n\n    console.log('âœ… PlaneGeometry detected, creating handles');\n\n    const handleSize = 0.15; // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: ã‚ˆã‚Šå°ã•ãæ´—ç·´ã•ã‚ŒãŸ\n    const handleGeometry = new THREE.BoxGeometry(handleSize, handleSize, handleSize);\n    // è§’ã‚’ä¸¸ãã™ã‚‹ãŸã‚ã€å¾Œã§roundedBoxã‚’ä½¿ç”¨\n\n    // å¸¸ã«å‰é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒãƒ†ãƒªã‚¢ãƒ«\n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«\n    const adaptiveColor = this.getAdaptiveSelectionColor();\n    const handleMaterial = new THREE.MeshBasicMaterial({\n      color: adaptiveColor,\n      transparent: true,\n      opacity: 0.8,\n      depthTest: false,\n      depthWrite: false\n    });\n\n    const handleHoverMaterial = new THREE.MeshBasicMaterial({\n      color: this.getAdaptiveHoverColor(),\n      transparent: true,\n      opacity: 1.0,\n      depthTest: false,\n      depthWrite: false\n    });\n\n    // å››éš…ã®ä½ç½®ã‚’è¨ˆç®—ï¼ˆè¦ªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªã‚µã‚¤ã‚ºã«åŸºã¥ãï¼‰\n    const width = parentObject.geometry.parameters.width;\n    const height = parentObject.geometry.parameters.height;\n\n    const positions = [\n      { x: width/2, y: height/2, z: 0.1, corner: 'top-right' },\n      { x: -width/2, y: height/2, z: 0.1, corner: 'top-left' },\n      { x: width/2, y: -height/2, z: 0.1, corner: 'bottom-right' },\n      { x: -width/2, y: -height/2, z: 0.1, corner: 'bottom-left' }\n    ];\n\n    positions.forEach((pos, index) => {\n      const handle = new THREE.Mesh(handleGeometry, handleMaterial.clone());\n      handle.position.set(pos.x, pos.y, pos.z); // è¦ªã‹ã‚‰ã®ç›¸å¯¾ä½ç½®\n      handle.userData = { \n        isResizeHandle: true, \n        handleIndex: index,\n        corner: pos.corner,\n        defaultMaterial: handle.material,\n        hoverMaterial: handleHoverMaterial.clone()\n      };\n      \n      // ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ \n      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é †åºã‚’é«˜ãè¨­å®šï¼ˆå¸¸ã«å‰é¢ï¼‰\n      handle.renderOrder = 1001;\n\n      handle.onHover = () => {\n        handle.material = handle.userData.hoverMaterial;\n        handle.scale.setScalar(1.5);\n        document.body.style.cursor = 'nw-resize';\n      };\n\n      handle.onHoverExit = () => {\n        handle.material = handle.userData.defaultMaterial;\n        handle.scale.setScalar(1.0);\n        document.body.style.cursor = 'default';\n      };\n\n      indicatorGroup.add(handle);\n\n      // ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒãƒ³ãƒ‰ãƒ«ãŒè¦‹ãˆã‚‹ã“ã¨ã‚’ç¢ºèª\n      console.log(`ğŸ”´ Added resize handle at ${pos.corner}`);\n    });\n  }\n\n  /**\n   * é¸æŠã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ç‰ˆï¼‰\n   */\n  updateSelectionIndicatorScale(object) {\n    // ãƒªã‚µã‚¤ã‚ºä¸­ã¯ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰\n    // æ ç·šã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ä¸€ç·’ã«ã‚¹ã‚±ãƒ¼ãƒ«ã•ã‚Œã‚‹ã®ã§ã€ç‰¹åˆ¥ãªæ›´æ–°ã¯ä¸è¦\n\n    // ãƒãƒ³ãƒ‰ãƒ«ä½ç½®ã®ã¿æ›´æ–°ãŒå¿…è¦ãªå ´åˆã¯ã€ã“ã“ã§å‡¦ç†\n    // ç¾åœ¨ã¯è‡ªå‹•çš„ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ä¸€ç·’ã«ã‚¹ã‚±ãƒ¼ãƒ«ã•ã‚Œã‚‹ã®ã§å‡¦ç†ä¸è¦\n  }\n\n  /**\n   * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠè§£é™¤\n   */\n  deselectObject() {\n    // ã‚·ãƒ³ãƒ—ãƒ«ã§ç¢ºå®Ÿãªé¸æŠè§£é™¤\n    if (this.selectedObject) {\n      // é¸æŠã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å­ã‹ã‚‰æ¢ã™ï¼‰\n      const indicator = this.selectedObject.getObjectByName('selectionIndicator');\n      if (indicator) {\n        this.selectedObject.remove(indicator);\n        \n        // ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’é˜²ããŸã‚ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ç ´æ£„\n        indicator.traverse((child) => {\n          if (child.geometry) child.geometry.dispose();\n          if (child.material) {\n            if (Array.isArray(child.material)) {\n              child.material.forEach(material => material.dispose());\n            } else {\n              child.material.dispose();\n            }\n          }\n        });\n      }\n\n      console.log(`âœ… Deselected: ${this.selectedObject.name}`);\n      this.selectedObject = null;\n    }\n  }\n\n  /**\n   * ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°ã«ã‚ˆã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç§»å‹•æ©Ÿèƒ½\n   */\n  setupObjectDragging() {\n    if (!this.renderer) return;\n    \n    const canvas = this.renderer.domElement;\n    let isDragging = false;\n    let dragObject = null;\n    let dragOffset = new THREE.Vector3();\n    let mouseStart = new THREE.Vector2();\n    let dragMode = 'move'; // 'move', 'resize', 'rotate'\n    let originalScale = new THREE.Vector3();\n    \n    canvas.addEventListener('mousedown', (event) => {\n      if (event.button !== 0) return; // å·¦ã‚¯ãƒªãƒƒã‚¯ã®ã¿\n      \n      // ãƒ¬ã‚¤ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡º\n      const rect = canvas.getBoundingClientRect();\n      this.mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;\n      this.mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\n      \n      this.raycaster.setFromCamera(this.mouse, this.camera);\n      // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ãã®å­ï¼ˆé¸æŠã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼å«ã‚€ï¼‰ã‚’æ¤œå‡ºå¯¾è±¡ã«\n      const intersects = this.raycaster.intersectObjects(this.experimentGroup.children, true);\n      \n      if (intersects.length > 0) {\n        const object = intersects[0].object;\n\n        // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ - Shiftã‚­ãƒ¼ä¸è¦\n        if (object.userData && object.userData.isResizeHandle) {\n          // ãƒªã‚µã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰é–‹å§‹\n          isDragging = true;\n          dragObject = this.selectedObject; // ãƒªã‚µã‚¤ã‚ºã™ã‚‹å®Ÿéš›ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n          dragMode = 'resize';\n          \n          // ãƒãƒ³ãƒ‰ãƒ«æƒ…å ±ã‚’ä¿å­˜\n          this.resizeHandleInfo = {\n            corner: object.userData.corner,\n            handleIndex: object.userData.handleIndex\n          };\n          \n          originalScale.copy(dragObject.scale);\n          mouseStart.set(event.clientX, event.clientY);\n          canvas.style.cursor = 'nw-resize';\n          console.log(`ğŸ”„ Started resizing: ${dragObject.name} from ${object.userData.corner}`);\n          return;\n        }\n\n        // å›è»¢ãƒãƒ³ãƒ‰ãƒ«ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ\n        if (object.userData && object.userData.isRotateHandle) {\n          // å›è»¢ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼ˆä»Šå¾Œå®Ÿè£…ï¼‰\n          console.log(`ğŸ”„ Rotation handle clicked for: ${this.selectedObject.name}`);\n          return;\n        }\n\n        // ç”Ÿæˆã•ã‚ŒãŸç”»åƒãƒ»å‹•ç”»ãƒ»3Dãƒ¢ãƒ‡ãƒ«å¯¾è±¡ï¼ˆShiftä¸è¦ã®ç›´æ„Ÿçš„æ“ä½œï¼‰\n        if (object.userData && (object.userData.type === 'generated_image' || object.userData.type === 'generated_video' || object.userData.type === 'generated_3d_model' || object.userData.source === 'imported_file')) {\n          \n          // ğŸ—‘ï¸ Deleteãƒ¢ãƒ¼ãƒ‰ã§ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†\n          if (this.commandUI && this.commandUI.currentMode === 'delete') {\n            // å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¦ç›´æ¥å‰Šé™¤\n            const objectName = object.name;\n            console.log(`ğŸ—‘ï¸ Delete mode: clicked on ${objectName}`);\n            \n            this.commandUI.showDeleteConfirmation(`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€Œ${objectName}ã€ã‚’å‰Šé™¤`)\n              .then(confirmed => {\n                if (confirmed) {\n                  this.removeObject(objectName);\n                  this.commandUI.addOutput(`ğŸ—‘ï¸ å‰Šé™¤å®Œäº†: ${objectName}`, 'success');\n                } else {\n                  this.commandUI.addOutput(`âŒ å‰Šé™¤ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ${objectName}`, 'info');\n                }\n              })\n              .catch(error => {\n                console.error('Delete confirmation error:', error);\n                this.commandUI.addOutput(`âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${objectName}`, 'error');\n              });\n            return; // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ç§»å‹•å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—\n          }\n          \n          // ç§»å‹•ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼ˆShiftã‚­ãƒ¼ä¸è¦ï¼‰\n          isDragging = true;\n          dragObject = object;\n          dragMode = 'move';\n          dragOffset.copy(intersects[0].point).sub(object.position);\n          mouseStart.set(event.clientX, event.clientY);\n\n          // é«˜å“è³ªãªè¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯\n          if (object.material) {\n            // ç§»å‹•ä¸­ã®é€æ˜åº¦å¤‰æ›´ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰\n            // object.material.opacity = 0.8;\n            // object.material.transparent = true;\n          }\n          // ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´ã‚’å‰Šé™¤ï¼ˆå¤§ãããªã‚‹åŸå› ï¼‰\n\n          canvas.style.cursor = 'move';\n          console.log(`ğŸ”„ Started moving: ${object.name} (Shift-free interaction)`);\n\n          // é¸æŠçŠ¶æ…‹ã‚‚æ›´æ–°\n          this.selectObject(object);\n        } else {\n          // é€šå¸¸ã‚¯ãƒªãƒƒã‚¯: é¸æŠã®ã¿\n          this.selectObject(object);\n        }\n      } else {\n        this.deselectObject();\n      }\n    });\n    \n    canvas.addEventListener('mousemove', (event) => {\n      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã§ãªã„å ´åˆã¯ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å‡¦ç†\n      if (!isDragging) {\n        this.handleHoverEffects(event, canvas);\n        return;\n      }\n      \n      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®å‡¦ç†\n      if (!dragObject) return;\n      \n      // ãƒã‚¦ã‚¹ã®ç§»å‹•é‡ã‚’è¨ˆç®—\n      const deltaX = event.clientX - mouseStart.x;\n      const deltaY = event.clientY - mouseStart.y;\n\n      if (dragMode === 'resize') {\n        // ãƒªã‚µã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰: ã‚ˆã‚Šç›´æ„Ÿçš„ãªæ–¹å‘è¨ˆç®—\n        if (!this.resizeHandleInfo) {\n          console.error('âŒ Resize handle info missing');\n          return;\n        }\n        \n        const corner = this.resizeHandleInfo.corner;\n        let scaleMultiplier = 1;\n        \n        // å„ãƒãƒ³ãƒ‰ãƒ«ã®ä½ç½®ã«å¿œã˜ãŸç›´æ„Ÿçš„ãªæ–¹å‘è¨ˆç®—\n        switch(corner) {\n          case 'top-right': \n            // å³ä¸Šãƒãƒ³ãƒ‰ãƒ«: å³ä¸Šæ–¹å‘ã«å¼•ã£å¼µã‚‹ã¨æ‹¡å¤§\n            scaleMultiplier = (deltaX > 0 && deltaY < 0) ? 1 + (Math.abs(deltaX) + Math.abs(deltaY)) * 0.001 : 1 - (Math.abs(deltaX) + Math.abs(deltaY)) * 0.001;\n            break;\n          case 'top-left':\n            // å·¦ä¸Šãƒãƒ³ãƒ‰ãƒ«: å·¦ä¸Šæ–¹å‘ã«å¼•ã£å¼µã‚‹ã¨æ‹¡å¤§\n            scaleMultiplier = (deltaX < 0 && deltaY < 0) ? 1 + (Math.abs(deltaX) + Math.abs(deltaY)) * 0.001 : 1 - (Math.abs(deltaX) + Math.abs(deltaY)) * 0.001;\n            break;\n          case 'bottom-right':\n            // å³ä¸‹ãƒãƒ³ãƒ‰ãƒ«: å³ä¸‹æ–¹å‘ã«å¼•ã£å¼µã‚‹ã¨æ‹¡å¤§\n            scaleMultiplier = (deltaX > 0 && deltaY > 0) ? 1 + (Math.abs(deltaX) + Math.abs(deltaY)) * 0.001 : 1 - (Math.abs(deltaX) + Math.abs(deltaY)) * 0.001;\n            break;\n          case 'bottom-left':\n            // å·¦ä¸‹ãƒãƒ³ãƒ‰ãƒ«: å·¦ä¸‹æ–¹å‘ã«å¼•ã£å¼µã‚‹ã¨æ‹¡å¤§\n            scaleMultiplier = (deltaX < 0 && deltaY > 0) ? 1 + (Math.abs(deltaX) + Math.abs(deltaY)) * 0.001 : 1 - (Math.abs(deltaX) + Math.abs(deltaY)) * 0.001;\n            break;\n          default:\n            scaleMultiplier = 1 + (deltaX + deltaY) * 0.001; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯\n        }\n        \n        const newScale = Math.max(0.1, Math.min(5.0, originalScale.x * scaleMultiplier));\n        dragObject.scale.setScalar(newScale);\n\n        // é¸æŠã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚‚æ›´æ–°ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰\n        this.updateSelectionIndicatorScale(dragObject);\n\n      } else if (dragMode === 'move') {\n        // ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ï¼ˆå¾“æ¥ã®å‡¦ç†ï¼‰\n        const cameraRight = new THREE.Vector3();\n        const cameraUp = new THREE.Vector3();\n        this.camera.getWorldDirection(new THREE.Vector3()); // dummy call to update matrix\n        cameraRight.setFromMatrixColumn(this.camera.matrixWorld, 0).normalize();\n        cameraUp.setFromMatrixColumn(this.camera.matrixWorld, 1).normalize();\n\n        // ãƒã‚¦ã‚¹ç§»å‹•ã‚’ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã«å¤‰æ›\n        const moveScale = 0.01;\n        const worldMove = new THREE.Vector3()\n          .add(cameraRight.clone().multiplyScalar(deltaX * moveScale))\n          .add(cameraUp.clone().multiplyScalar(-deltaY * moveScale));\n\n        dragObject.position.add(worldMove);\n        mouseStart.set(event.clientX, event.clientY);\n      }\n    });\n    \n    canvas.addEventListener('mouseup', () => {\n      if (isDragging && dragObject) {\n        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ã®å‡¦ç†\n        if (dragObject.material) {\n          dragObject.material.opacity = 1.0;\n          dragObject.material.transparent = false;\n        }\n\n        // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å…ƒã«æˆ»ã™ï¼ˆç§»å‹•é–‹å§‹æ™‚ã«å¤‰æ›´ã—ãŸå ´åˆï¼‰\n        // ç¾åœ¨ã¯ç§»å‹•é–‹å§‹æ™‚ã®ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›´ã‚’å‰Šé™¤ã—ãŸã®ã§ã€ã“ã®å‡¦ç†ã¯ä¸è¦\n\n        console.log(`âœ… Finished dragging: ${dragObject.name} to (${dragObject.position.x.toFixed(1)}, ${dragObject.position.y.toFixed(1)}, ${dragObject.position.z.toFixed(1)})`);\n\n        isDragging = false;\n        dragObject = null;\n        dragMode = 'move'; // ãƒªã‚»ãƒƒãƒˆ\n        this.resizeHandleInfo = null; // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«æƒ…å ±ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n        canvas.style.cursor = 'default';\n      }\n    });\n    \n    // Shift+ãƒ›ã‚¤ãƒ¼ãƒ«ã§ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ã‚’è¿½åŠ \n    canvas.addEventListener('wheel', (event) => {\n      event.preventDefault();\n      \n      const rect = canvas.getBoundingClientRect();\n      const mouse = new THREE.Vector2();\n      mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;\n      mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\n      \n      this.raycaster.setFromCamera(mouse, this.camera);\n      const intersects = this.raycaster.intersectObjects(this.experimentGroup.children, true);\n      \n      if (intersects.length > 0) {\n        const obj = intersects[0].object;\n        // ç”Ÿæˆã•ã‚ŒãŸç”»åƒãƒ»å‹•ç”»ãƒ»3Dãƒ¢ãƒ‡ãƒ«å¯¾è±¡ï¼ˆShiftä¸è¦ã®ç›´æ„Ÿçš„æ“ä½œï¼‰\n        if (obj.userData && (obj.userData.type === 'generated_image' || obj.userData.type === 'generated_video' || obj.userData.type === 'generated_3d_model')) {\n          const scaleFactor = event.deltaY > 0 ? 0.9 : 1.1;\n          const newScale = obj.scale.x * scaleFactor;\n          \n          // æœ€å°ãƒ»æœ€å¤§ã‚µã‚¤ã‚ºåˆ¶é™\n          if (newScale >= 0.2 && newScale <= 5.0) {\n            obj.scale.setScalar(newScale);\n            \n            // é«˜å“è³ªãªè¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯\n            if (obj.material) {\n              obj.material.emissive.setHex(0x333333);\n              setTimeout(() => {\n                if (obj.material) {\n                  obj.material.emissive.setHex(0x000000);\n                }\n              }, 150);\n            }\n            \n            console.log(`ğŸ”„ Resized ${obj.userData.type}: ${obj.name} to scale ${newScale.toFixed(2)} (Shift-free interaction)`);\n          }\n        }\n      }\n    });\n\n    // é¸æŠã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è§’åº¦èª¿æ•´ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«\n    document.addEventListener('keydown', (event) => {\n      if (!this.selectedObject) return;\n      \n      const object = this.selectedObject;\n      // ç”Ÿæˆã•ã‚ŒãŸç”»åƒãƒ»å‹•ç”»ã®ã¿è§’åº¦èª¿æ•´å¯èƒ½\n      if (!object.userData || (object.userData.type !== 'generated_image' && object.userData.type !== 'generated_video')) {\n        return;\n      }\n      \n      const rotationStep = Math.PI / 36; // 5åº¦ãšã¤å›è»¢\n      let rotated = false;\n      \n      switch (event.key) {\n        case 'ArrowLeft':\n          object.rotation.y -= rotationStep;\n          rotated = true;\n          break;\n        case 'ArrowRight':\n          object.rotation.y += rotationStep;\n          rotated = true;\n          break;\n        case 'ArrowUp':\n          // Xè»¸å›è»¢ã¯åˆ¶é™ï¼ˆ-30åº¦ã‹ã‚‰+30åº¦ã¾ã§ï¼‰\n          const newRotationX = object.rotation.x - rotationStep;\n          if (newRotationX >= -Math.PI/6 && newRotationX <= Math.PI/6) {\n            object.rotation.x = newRotationX;\n            rotated = true;\n          }\n          break;\n        case 'ArrowDown':\n          // Xè»¸å›è»¢ã¯åˆ¶é™ï¼ˆ-30åº¦ã‹ã‚‰+30åº¦ã¾ã§ï¼‰\n          const newRotationXDown = object.rotation.x + rotationStep;\n          if (newRotationXDown >= -Math.PI/6 && newRotationXDown <= Math.PI/6) {\n            object.rotation.x = newRotationXDown;\n            rotated = true;\n          }\n          break;\n        case 'r':\n        case 'R':\n          // ãƒªã‚»ãƒƒãƒˆï¼šæ­£é¢å‘ãã«æˆ»ã™\n          object.rotation.x = 0;\n          // ã‚«ãƒ¡ãƒ©ã®è¦–ç·šæ–¹å‘ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¢ãƒ‹ã‚¿ãƒ¼ã§è¦‹ã¦ã„ã‚‹æ–¹å‘ï¼‰ã«å‘ã‘ã‚‹\n          const cameraDirection = new THREE.Vector3();\n          this.camera.getWorldDirection(cameraDirection);\n          const targetPoint = object.position.clone().add(cameraDirection.multiplyScalar(-1));\n          object.lookAt(targetPoint);\n          object.rotation.x = 0; // ãŠè¾å„€é˜²æ­¢\n          rotated = true;\n          console.log(`ğŸ”„ Reset rotation for: ${object.name}`);\n          break;\n\n        case 'i':\n        case 'I':\n          // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º\n          this.debugSceneInfo();\n          event.preventDefault();\n          break;\n      }\n      \n      if (rotated) {\n        event.preventDefault();\n        const angles = {\n          x: (object.rotation.x * 180 / Math.PI).toFixed(1),\n          y: (object.rotation.y * 180 / Math.PI).toFixed(1),\n          z: (object.rotation.z * 180 / Math.PI).toFixed(1)\n        };\n        console.log(`ğŸ”„ Rotated ${object.userData.type}: ${object.name} to (${angles.x}Â°, ${angles.y}Â°, ${angles.z}Â°)`);\n      }\n    });\n\n    console.log('ğŸ–±ï¸ Object dragging system enabled (Drag to move objects - Shift-free interaction)');\n    console.log('ğŸ”„ Object resizing system enabled (Scroll to resize images/videos - Shift-free interaction)');\n    console.log('ğŸ¯ Angle adjustment enabled (Select object + Arrow keys to rotate, R to reset)');\n  }\n\n  handleHoverEffects(event, canvas) {\n    // ãƒ¬ã‚¤ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡º\n    const rect = canvas.getBoundingClientRect();\n    this.mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;\n    this.mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\n    \n    this.raycaster.setFromCamera(this.mouse, this.camera);\n\n    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ãã®å­ï¼ˆé¸æŠã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼å«ã‚€ï¼‰ã‚’æ¤œå‡ºå¯¾è±¡ã«\n    const intersects = this.raycaster.intersectObjects(this.experimentGroup.children, true);\n    \n    // å‰å›ãƒ›ãƒãƒ¼ã—ã¦ã„ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ\n    if (this.lastHoveredObject && this.lastHoveredObject.onHoverExit) {\n      this.lastHoveredObject.onHoverExit();\n      this.lastHoveredObject = null;\n    }\n    \n    // æ–°ã—ã„ãƒ›ãƒãƒ¼å¯¾è±¡ã‚’æ¤œå‡º\n    if (intersects.length > 0) {\n      const object = intersects[0].object;\n      \n      // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã«ãƒ›ãƒãƒ¼ã—ãŸå ´åˆ\n      if (object.userData && object.userData.isResizeHandle && object.onHover) {\n        object.onHover();\n        this.lastHoveredObject = object;\n        return;\n      }\n      \n      // é€šå¸¸ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ›ãƒãƒ¼ã—ãŸå ´åˆ\n      if (object.userData && (object.userData.type === 'generated_image' || object.userData.type === 'generated_video')) {\n        // ç§»å‹•å¯èƒ½ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ã‚«ãƒ¼ã‚½ãƒ«ã‚’å¤‰æ›´\n        canvas.style.cursor = 'move';\n\n        this.lastHoveredObject = { onHoverExit: () => { canvas.style.cursor = 'default'; } };\n        return;\n      }\n    }\n    \n    // ãƒ›ãƒãƒ¼å¯¾è±¡ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¼ã‚½ãƒ«\n    canvas.style.cursor = 'default';\n  }\n\n  /**\n   * ãƒ¡ã‚¤ãƒ³ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ\n   * @param {string} command - è‡ªç„¶è¨€èªã‚³ãƒãƒ³ãƒ‰\n   */\n  async executeCommand(command) {\n    const timestamp = Date.now();\n    console.log(`ğŸ¯ Executing: \"${command}\"`);\n    \n    try {\n      // ã‚³ãƒãƒ³ãƒ‰è§£æ\n      const parsed = this.parseCommand(command);\n      console.log('ğŸ“ Parsed:', parsed);\n      \n      // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ\n      const result = await this.dispatchCommand(parsed);\n      \n      // å±¥æ­´ã«è¨˜éŒ²\n      this.commandHistory.push({\n        timestamp,\n        command,\n        parsed,\n        result,\n        status: 'success'\n      });\n      \n      return result;\n      \n    } catch (error) {\n      console.error('âŒ Command execution failed:', error);\n      \n      this.commandHistory.push({\n        timestamp,\n        command,\n        error: error.message,\n        status: 'error'\n      });\n      \n      throw error;\n    }\n  }\n\n  /**\n   * è‡ªç„¶è¨€èªã‚³ãƒãƒ³ãƒ‰è§£æ\n   * @param {string} command \n   * @returns {object} è§£æçµæœ\n   */\n  parseCommand(command) {\n    // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ¤å®š\n    if (command.startsWith('[å¤‰æ›´] ')) {\n      const actualCommand = command.replace('[å¤‰æ›´] ', '');\n      return this.parseObjectModificationCommand(actualCommand.toLowerCase().trim());\n    }\n    \n    if (command.startsWith('[å‰Šé™¤] ')) {\n      const actualCommand = command.replace('[å‰Šé™¤] ', '');\n      return this.parseDeleteCommand(actualCommand.toLowerCase().trim());\n    }\n    \n    // å‹•ç”»ç”Ÿæˆã®åˆ¤å®šï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã— = ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ï¼‰\n    const cmd = command.toLowerCase().trim();\n    \n    // è‡ªç„¶è¨€èªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ“ä½œã®åˆ¤å®šï¼ˆã€Œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå + å‹•ä½œã€ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰\n    const naturalLanguagePattern = this.parseNaturalLanguageCommand(cmd);\n    if (naturalLanguagePattern) {\n      return naturalLanguagePattern;\n    }\n    \n    // å‹•ç”»é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯\n    const videoKeywords = ['å‹•ç”»', 'ãƒ“ãƒ‡ã‚ª', 'ãƒ ãƒ¼ãƒ“ãƒ¼', 'æ˜ åƒ', 'ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³', 'å‹•ã', \n                          'video', 'movie', 'animation', 'animate', 'motion', 'moving', 'clip'];\n    const isVideoRequest = videoKeywords.some(keyword => cmd.includes(keyword));\n    \n    if (isVideoRequest) {\n      return {\n        type: 'video_generation',\n        prompt: command,\n        position: this.parsePosition(cmd),\n        size: this.parseSize(cmd)\n      };\n    }\n    \n    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠé–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯\n    const selectKeywords = ['é¸æŠ', 'select', 'ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ', 'æ—¢å­˜', 'existing'];\n    const isSelectRequest = selectKeywords.some(keyword => cmd.includes(keyword));\n    \n    if (isSelectRequest) {\n      return {\n        type: 'object_selection',\n        position: this.parsePosition(cmd)\n      };\n    }\n    \n    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯\n    const importKeywords = ['ã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 'import', 'èª­ã¿è¾¼', 'èª­è¾¼', 'ãƒ•ã‚¡ã‚¤ãƒ«', 'file', 'ç”»åƒã‚’é¸æŠ', 'å‹•ç”»ã‚’é¸æŠ', 'é¸æŠã—ã¦é…ç½®'];\n    const isImportRequest = importKeywords.some(keyword => cmd.includes(keyword));\n    \n    if (isImportRequest) {\n      const isVideoImport = cmd.includes('å‹•ç”»') || cmd.includes('video') || cmd.includes('mp4');\n      return {\n        type: 'file_import',\n        fileType: isVideoImport ? 'video' : 'image',\n        position: this.parsePosition(cmd),\n        size: this.parseSize(cmd)\n      };\n    }\n    \n    // ç”»åƒç”Ÿæˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯\n    const imageKeywords = ['ç”»åƒ', 'å†™çœŸ', 'ã‚¤ãƒ¡ãƒ¼ã‚¸', 'çµµ', 'ãƒ”ã‚¯ãƒãƒ£ãƒ¼', \n                          'image', 'picture', 'photo', 'generate', 'create', 'make', 'draw'];\n    const isImageRequest = imageKeywords.some(keyword => cmd.includes(keyword));\n    \n    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ç”»åƒç”Ÿæˆã¨ã—ã¦å‡¦ç†\n    return {\n      type: 'image_generation',\n      prompt: command,\n      position: this.parsePosition(cmd),\n      size: this.parseSize(cmd)\n    };\n  }\n\n  /**\n   * ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰å¯¾è±¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç‰¹å®š\n   */\n  findObjectByKeyword(command) {\n    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è­˜åˆ¥ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰\n    const objectKeywords = {\n      'çŒ«': ['cat', 'ãƒã‚³', 'ã­ã“'],\n      'çŠ¬': ['dog', 'ã‚¤ãƒŒ', 'ã„ã¬'],\n      'ãƒ‰ãƒ©ã‚´ãƒ³': ['dragon', 'é¾', 'ã‚Šã‚…ã†'],\n      'ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³': ['unicorn'],\n      'ãƒšã‚¬ã‚µã‚¹': ['pegasus'],\n      'é³¥': ['bird', 'ã¨ã‚Š', 'ãƒˆãƒª'],\n      'èŠ±': ['flower', 'ã¯ãª', 'ãƒãƒŠ'],\n      'åŸ': ['castle', 'ã—ã‚', 'ã‚·ãƒ­'],\n      'å±±': ['mountain', 'ã‚„ã¾', 'ãƒ¤ãƒ'],\n      'æœ¨': ['tree', 'ã', 'ã‚­']\n    };\n\n    // ã‚·ãƒ¼ãƒ³å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œç´¢\n    for (const child of this.scene.children) {\n      if (!child.name || !child.name.startsWith('generated_')) continue;\n      \n      // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåã‹ã‚‰ã‚¿ã‚¤ãƒ—ã‚’æ¨æ¸¬ï¼ˆä¾‹: generated_image_1 â†’ imageï¼‰\n      const nameParts = child.name.split('_');\n      \n      // ã‚³ãƒãƒ³ãƒ‰å†…ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ç…§åˆ\n      for (const [keyword, aliases] of Object.entries(objectKeywords)) {\n        // ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯\n        if (command.includes(keyword)) {\n          console.log(`ğŸ¯ Found object by keyword \"${keyword}\": ${child.name}`);\n          return child;\n        }\n        \n        // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚‚ãƒã‚§ãƒƒã‚¯\n        for (const alias of aliases) {\n          if (command.toLowerCase().includes(alias.toLowerCase())) {\n            console.log(`ğŸ¯ Found object by alias \"${alias}\": ${child.name}`);\n            return child;\n          }\n        }\n      }\n      \n      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚‚ç¢ºèª\n      if (child.userData && child.userData.prompt) {\n        const prompt = child.userData.prompt.toLowerCase();\n        for (const [keyword, aliases] of Object.entries(objectKeywords)) {\n          if (prompt.includes(keyword.toLowerCase())) {\n            console.log(`ğŸ¯ Found object by prompt \"${keyword}\": ${child.name}`);\n            return child;\n          }\n        }\n      }\n    }\n    \n    // æœ€å¾Œã«ä½œæˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ã‚ªãƒ—ã‚·ãƒ§ãƒ³\n    if (command.includes('æœ€å¾Œ') || command.includes('æœ€æ–°') || command.includes('last')) {\n      const generatedObjects = this.scene.children.filter(\n        child => child.name && child.name.startsWith('generated_')\n      );\n      if (generatedObjects.length > 0) {\n        const lastObject = generatedObjects[generatedObjects.length - 1];\n        console.log(`ğŸ¯ Found last created object: ${lastObject.name}`);\n        return lastObject;\n      }\n    }\n    \n    return null;\n  }\n\n  /**\n   * ç”»åƒç”Ÿæˆã‚³ãƒãƒ³ãƒ‰è§£æ\n   */\n  parseImageGenerationCommand(command) {\n    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæŠ½å‡º (ã€Œã‚’ã€ã€Œã«ã€ã€Œã§ã€ãªã©ã§åŒºåˆ‡ã‚‹)\n    let prompt = command;\n    const particles = ['ã‚’', 'ã«', 'ã§', 'ã®'];\n    \n    for (const particle of particles) {\n      if (command.includes(particle)) {\n        const parts = command.split(particle);\n        if (parts[0]) {\n          prompt = parts[0].trim();\n          break;\n        }\n      }\n    }\n    \n    // ä¸è¦ãªèªå¥ã‚’é™¤å»\n    prompt = prompt\n      .replace(/(ç”»åƒ|ä½œã£ã¦|ç”Ÿæˆ|ã—ã¦|ãã ã•ã„)/g, '')\n      .trim();\n    \n    return {\n      type: 'image_generation',\n      prompt,\n      position: this.parsePosition(command),\n      size: this.parseSize(command)\n    };\n  }\n\n  /**\n   * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ›´ã‚³ãƒãƒ³ãƒ‰è§£æ\n   */\n  parseObjectModificationCommand(command) {\n    const cmd = command.toLowerCase().trim();\n    \n    // è‰²å¤‰æ›´ã®è§£æ\n    let color = null;\n    const colorMap = {\n      'èµ¤': 0xff0000, 'é’': 0x0000ff, 'ç·‘': 0x00ff00, 'é»„': 0xffff00,\n      'ç´«': 0xff00ff, 'æ©™': 0xff8800, 'ã‚ªãƒ¬ãƒ³ã‚¸': 0xff8800,\n      'ç™½': 0xffffff, 'é»’': 0x000000, 'ç°': 0x808080, 'ã‚°ãƒ¬ãƒ¼': 0x808080,\n      'ãƒ”ãƒ³ã‚¯': 0xffc0cb, 'èŒ¶': 0x8b4513, 'éŠ€': 0xc0c0c0, 'é‡‘': 0xffd700\n    };\n    \n    for (const [colorName, colorValue] of Object.entries(colorMap)) {\n      if (cmd.includes(colorName)) {\n        color = colorValue;\n        break;\n      }\n    }\n    \n    // ã‚µã‚¤ã‚ºå¤‰æ›´ã®è§£æ\n    let scale = null;\n    if (cmd.includes('å¤§ãã') || cmd.includes('æ‹¡å¤§')) {\n      scale = 1.5;\n    } else if (cmd.includes('å°ã•ã') || cmd.includes('ç¸®å°')) {\n      scale = 0.7;\n    } else if (cmd.includes('å€')) {\n      const match = cmd.match(/(\\d+(?:\\.\\d+)?)\\s*å€/);\n      if (match) {\n        scale = parseFloat(match[1]);\n      }\n    }\n    \n    // ç§»å‹•ã‚³ãƒãƒ³ãƒ‰ã®è§£æ\n    let movement = null;\n    if (cmd.includes('ç§»å‹•') || cmd.includes('å‹•ã‹') || cmd.includes('ã¸')) {\n      movement = this.parsePositionFromPrompt(cmd);\n    }\n\n    // å›è»¢ã‚³ãƒãƒ³ãƒ‰ã®è§£æ\n    let rotation = null;\n    if (cmd.includes('å›è»¢') || cmd.includes('å›ã™') || cmd.includes('å›ã—ã¦') || cmd.includes('rotate')) {\n      // è§’åº¦æŒ‡å®šãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯\n      const degreeMatch = cmd.match(/(\\d+)\\s*åº¦/);\n      if (degreeMatch) {\n        rotation = parseFloat(degreeMatch[1]) * Math.PI / 180; // åº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›\n      } else {\n        rotation = Math.PI / 4; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯45åº¦\n      }\n    }\n\n    // é€æ˜åº¦ã‚³ãƒãƒ³ãƒ‰ã®è§£æ\n    let opacity = null;\n    if (cmd.includes('é€æ˜') || cmd.includes('transparent')) {\n      if (cmd.includes('åŠé€æ˜')) {\n        opacity = 0.5;\n      } else {\n        opacity = 0.3; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€æ˜åº¦\n      }\n    } else if (cmd.includes('ä¸é€æ˜') || cmd.includes('opaque')) {\n      opacity = 1.0;\n    }\n\n    return {\n      type: 'object_modification',\n      command: command,\n      color: color,\n      scale: scale,\n      movement: movement,\n      rotation: rotation,\n      opacity: opacity,\n      requiresSelection: true\n    };\n  }\n\n  /**\n   * å‰Šé™¤ã‚³ãƒãƒ³ãƒ‰è§£æ\n   */\n  parseDeleteCommand(command) {\n    const cmd = command.toLowerCase().trim();\n    \n    // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’å‰Šé™¤ã™ã‚‹ã‹ã€å…¨å‰Šé™¤ã‹ã‚’åˆ¤å®š\n    if (cmd.includes('é¸æŠ') || cmd.includes('ã“ã‚Œ') || cmd.includes('ã“ã®')) {\n      return {\n        type: 'delete',\n        target: 'selected',\n        requiresSelection: true\n      };\n    }\n    \n    if (cmd.includes('å…¨éƒ¨') || cmd.includes('ã™ã¹ã¦') || cmd.includes('å…¨ã¦')) {\n      return {\n        type: 'delete',\n        target: 'all'\n      };\n    }\n    \n    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤\n    return {\n      type: 'delete',\n      target: 'selected',\n      requiresSelection: true\n    };\n  }\n\n  /**\n   * è‡ªç„¶è¨€èªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ“ä½œã‚³ãƒãƒ³ãƒ‰è§£æ\n   * ä¾‹: \"ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³ã‚’å³ã«ç§»å‹•\", \"çŒ«ã®ç”»åƒã‚’ãƒ”ãƒ³ã‚¯ã«\", \"1ã¤ç›®ã®çŒ«ã‚’å·¦ã«\"\n   */\n  parseNaturalLanguageCommand(command) {\n    // ç§»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯\n    const movePatterns = [\n      '(\\S+?)ã‚’(.+?)ã«ç§»å‹•', \n      '(\\S+?)ã‚’(.+?)ã¸ç§»å‹•',\n      '(\\S+?)ã‚’(.+?)ã«å‹•ã‹',\n      '(\\S+?)ã‚’(.+?)ã¸å‹•ã‹'\n    ];\n    \n    for (const pattern of movePatterns) {\n      const regex = new RegExp(pattern);\n      const match = command.match(regex);\n      if (match) {\n        const objectName = match[1];\n        const direction = match[2];\n        \n        console.log(`ğŸ¯ Natural language move detected: \"${objectName}\" to \"${direction}\"`);\n        \n        return {\n          type: 'natural_object_modification',\n          targetObjectName: objectName,\n          movement: this.parsePositionFromPrompt(direction),\n          requiresObjectSearch: true\n        };\n      }\n    }\n    \n    // è‰²å¤‰æ›´ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯\n    const colorPatterns = [\n      '(\\S+?)ã‚’(\\S+?)è‰²ã«',\n      '(\\S+?)ã‚’(\\S+?)ã«'\n    ];\n    \n    // è‰²å¤‰æ›´ã¯åŸºæœ¬çš„ãªè‰²ã®ã¿å¯¾å¿œ\n    const colorKeywords = ['èµ¤', 'é’', 'ç·‘', 'é»„', 'ç´«', 'æ©™', 'ã‚ªãƒ¬ãƒ³ã‚¸', 'ç™½', 'é»’', 'ç°', 'ã‚°ãƒ¬ãƒ¼', 'ãƒ”ãƒ³ã‚¯', 'èŒ¶', 'éŠ€', 'é‡‘'];\n    \n    for (const pattern of colorPatterns) {\n      const regex = new RegExp(pattern);\n      const match = command.match(regex);\n      if (match && colorKeywords.some(color => match[2].includes(color))) {\n        const objectName = match[1];\n        const colorName = match[2];\n        \n        console.log(`ğŸ¨ Natural language color change detected: \"${objectName}\" to \"${colorName}\"`);\n        \n        // è‰²å¤‰æ›´ã®è§£æï¼ˆæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æµç”¨ï¼‰\n        const colorMap = {\n          'èµ¤': 0xff0000, 'é’': 0x0000ff, 'ç·‘': 0x00ff00, 'é»„': 0xffff00,\n          'ç´«': 0xff00ff, 'æ©™': 0xff8800, 'ã‚ªãƒ¬ãƒ³ã‚¸': 0xff8800,\n          'ç™½': 0xffffff, 'é»’': 0x000000, 'ç°': 0x808080, 'ã‚°ãƒ¬ãƒ¼': 0x808080,\n          'ãƒ”ãƒ³ã‚¯': 0xffc0cb, 'èŒ¶': 0x8b4513, 'éŠ€': 0xc0c0c0, 'é‡‘': 0xffd700\n        };\n        \n        let colorValue = null;\n        for (const [colorKey, value] of Object.entries(colorMap)) {\n          if (colorName.includes(colorKey)) {\n            colorValue = value;\n            break;\n          }\n        }\n        \n        return {\n          type: 'natural_object_modification',\n          targetObjectName: objectName,\n          color: colorValue,\n          requiresObjectSearch: true\n        };\n      }\n    }\n    \n    return null; // è‡ªç„¶è¨€èªãƒ‘ã‚¿ãƒ¼ãƒ³ã«ä¸€è‡´ã—ãªã„å ´åˆ\n  }\n\n  /**\n   * ç§»å‹•ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ç›¸å¯¾ä½ç½®ã‚’è§£æï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç§»å‹•ç”¨ï¼‰\n   */\n  parsePositionFromPrompt(command) {\n    let x = 0, y = 0, z = 0;\n    \n    // å·¦å³ç§»å‹•ï¼ˆä¿®æ­£ï¼šå·¦å³ã‚’æ­£ã—ã„æ–¹å‘ã«ï¼‰\n    if (command.includes('å³ã¸') || command.includes('å³ã«') || command.includes('å³å´ã¸') || command.includes('å³å´ã«')) {\n      x = 5; // 5ãƒ¡ãƒ¼ãƒˆãƒ«å³ã¸ï¼ˆæ­£ã®å€¤ã§å³ã«ç§»å‹•ï¼‰\n    } else if (command.includes('å·¦ã¸') || command.includes('å·¦ã«') || command.includes('å·¦å´ã¸') || command.includes('å·¦å´ã«')) {\n      x = -5; // 5ãƒ¡ãƒ¼ãƒˆãƒ«å·¦ã¸ï¼ˆè² ã®å€¤ã§å·¦ã«ç§»å‹•ï¼‰\n    }\n    \n    // ä¸Šä¸‹ç§»å‹•\n    if (command.includes('ä¸Šã¸') || command.includes('ä¸Šã«') || command.includes('ä¸Šå´ã¸')) {\n      y = 3; // 3ãƒ¡ãƒ¼ãƒˆãƒ«ä¸Šã¸\n    } else if (command.includes('ä¸‹ã¸') || command.includes('ä¸‹ã«') || command.includes('ä¸‹å´ã¸')) {\n      y = -3; // 3ãƒ¡ãƒ¼ãƒˆãƒ«ä¸‹ã¸\n    }\n    \n    // å‰å¾Œç§»å‹•\n    if (command.includes('å‰ã¸') || command.includes('æ‰‹å‰ã¸') || command.includes('è¿‘ãã¸')) {\n      z = 3; // ã‚«ãƒ¡ãƒ©ã«è¿‘ã¥ã‘ã‚‹\n    } else if (command.includes('å¾Œã‚ã¸') || command.includes('å¥¥ã¸') || command.includes('é ãã¸')) {\n      z = -3; // ã‚«ãƒ¡ãƒ©ã‹ã‚‰é ã–ã‘ã‚‹\n    }\n    \n    // è·é›¢æŒ‡å®šã®è§£æ\n    const distanceMatch = command.match(/(\\d+(?:\\.\\d+)?)\\s*(?:ãƒ¡ãƒ¼ãƒˆãƒ«|m)/);\n    if (distanceMatch) {\n      const distance = parseFloat(distanceMatch[1]);\n      // æ–¹å‘ã«å¿œã˜ã¦è·é›¢ã‚’é©ç”¨\n      if (Math.abs(x) > 0) x = x > 0 ? distance : -distance;\n      if (Math.abs(y) > 0) y = y > 0 ? distance : -distance;\n      if (Math.abs(z) > 0) z = z > 0 ? distance : -distance;\n    }\n    \n    // ã€Œå°‘ã—ã€ã€Œå¤§ããã€ãªã©ã®ä¿®é£¾èª\n    if (command.includes('å°‘ã—') || command.includes('ã¡ã‚‡ã£ã¨')) {\n      x *= 0.5; y *= 0.5; z *= 0.5;\n    } else if (command.includes('å¤§ãã') || command.includes('ãŸãã•ã‚“')) {\n      x *= 2; y *= 2; z *= 2;\n    }\n    \n    console.log(`ğŸ“ Position movement parsed from \"${command}\": (${x}, ${y}, ${z})`);\n    \n    return { x, y, z };\n  }\n\n  /**\n   * ä½ç½®æƒ…å ±è§£æï¼ˆã‚«ãƒ¡ãƒ©ç›¸å¯¾ä½ç½®ï¼‰\n   */\n  parsePosition(command) {\n    const defaultPos = { x: 0, y: 5, z: 10 }; // ã‚«ãƒ¡ãƒ©å‰æ–¹10mã€å°‘ã—ä¸Š\n    \n    // åŸºæœ¬æ–¹å‘ã®è§£æï¼ˆã‚«ãƒ¡ãƒ©ç›¸å¯¾åº§æ¨™ç³»ï¼‰\n    let x = 0, y = 5, z = 10; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆã‚«ãƒ¡ãƒ©ç›¸å¯¾ã€æ­£ã®zãŒå‰æ–¹ï¼‰\n    \n    // çµ„ã¿åˆã‚ã›ä½ç½®ã‚’æœ€åˆã«ãƒã‚§ãƒƒã‚¯ï¼ˆå„ªå…ˆåº¦æœ€é«˜ï¼‰\n    if (command.includes('å·¦ä¸‹')) {\n      x = -8; y = 0; z = 10;  // å·¦ä¸‹: å·¦å´ã§ä½ã„ä½ç½®\n      console.log(`ğŸ“ Position parsed from \"${command}\": å·¦ä¸‹ (${x}, ${y}, ${z})`);\n      return { x, y, z };\n    } else if (command.includes('å³ä¸Š')) {\n      x = 5; y = 4; z = 12;  // yåº§æ¨™ã‚’ä¸‹ã’ã¦ç”»é¢å†…ã«åã‚ã‚‹\n      console.log(`ğŸ“ Position parsed from \"${command}\": å³ä¸Š (${x}, ${y}, ${z})`);\n      return { x, y, z };\n    } else if (command.includes('å·¦ä¸Š')) {\n      x = -8; y = 4; z = 15; // yåº§æ¨™ã‚’ä¸‹ã’ã¦ç”»é¢å†…ã«åã‚ã‚‹\n      console.log(`ğŸ“ Position parsed from \"${command}\": å·¦ä¸Š (${x}, ${y}, ${z})`);\n      return { x, y, z };\n    } else if (command.includes('å³ä¸‹')) {\n      x = 8; y = 0; z = 10; // å³ä¸‹: å³å´ã§ä½ã„ä½ç½®\n      console.log(`ğŸ“ Position parsed from \"${command}\": å³ä¸‹ (${x}, ${y}, ${z})`);\n      return { x, y, z };\n    }\n    \n    // ç‰¹æ®Šä½ç½®\n    if (command.includes('ä¸­å¤®') || command.includes('çœŸã‚“ä¸­') || command.includes('æ­£é¢')) {\n      x = 0; y = 3; z = 12;  // y=3 ã§ç›®ç·šãƒ¬ãƒ™ãƒ«ã«\n      console.log(`ğŸ“ Position parsed from \"${command}\": ä¸­å¤® (${x}, ${y}, ${z})`);\n      return { x, y, z };\n    } else if (command.includes('ç©º') || command.includes('å¤©ç©º')) {\n      x = 0; y = 20; z = 10;\n      console.log(`ğŸ“ Position parsed from \"${command}\": ç©ºä¸­ (${x}, ${y}, ${z})`);\n      return { x, y, z };\n    } else if (command.includes('åœ°é¢') || command.includes('è¶³å…ƒ')) {\n      x = 0; y = 1; z = 8;\n      console.log(`ğŸ“ Position parsed from \"${command}\": åœ°é¢ (${x}, ${y}, ${z})`);\n      return { x, y, z };\n    }\n    \n    // å€‹åˆ¥æ–¹å‘ã®è§£æ\n    // å‰å¾Œæ–¹å‘\n    if (command.includes('å‰ã«') || command.includes('æ‰‹å‰ã«')) {\n      z = 5; // ã‚«ãƒ¡ãƒ©ã«è¿‘ã¥ã‘ã‚‹\n    } else if (command.includes('å¾Œã‚ã«') || command.includes('å¥¥ã«') || command.includes('é ãã«')) {\n      z = 20; // ã‚«ãƒ¡ãƒ©ã‹ã‚‰é ã–ã‘ã‚‹\n    }\n    \n    // å·¦å³æ–¹å‘\n    if (command.includes('å³ã«') || command.includes('å³å´') || command.includes('ç”»é¢ã®å³')) {\n      x = 8;\n    } else if (command.includes('å·¦ã«') || command.includes('å·¦å´') || command.includes('ç”»é¢ã®å·¦')) {\n      x = -8;\n    }\n    \n    // ä¸Šä¸‹æ–¹å‘ï¼ˆã‚«ãƒ¡ãƒ©ç›¸å¯¾ï¼‰\n    if (command.includes('ä¸Šã«') || command.includes('ä¸Šå´') || command.includes('ç”»é¢ã®ä¸Š') || command.includes('é«˜ã„ä½ç½®ã«') || command.includes('ç©ºä¸­ã«')) {\n      y = 8; // ã‚«ãƒ¡ãƒ©ã‹ã‚‰8ãƒ¡ãƒ¼ãƒˆãƒ«ä¸Š\n    } else if (command.includes('ä¸‹ã«') || command.includes('ä¸‹å´') || command.includes('ç”»é¢ã®ä¸‹') || command.includes('ä½ã„ä½ç½®ã«') || command.includes('åœ°é¢ã«')) {\n      y = -2; // ã‚«ãƒ¡ãƒ©ã‹ã‚‰2ãƒ¡ãƒ¼ãƒˆãƒ«ä¸‹\n    }\n    \n    // è·é›¢æŒ‡å®š\n    if (command.includes('è¿‘ãã«') || command.includes('ã™ãå‰ã«')) {\n      z = Math.min(z * 0.5, 3); // åŠåˆ†ã®è·é›¢ã€ãŸã ã—æœ€ä½3mï¼ˆæ­£ã®å€¤ãªã®ã§ min ã‚’ä½¿ç”¨ï¼‰\n    } else if (command.includes('é ãã«') || command.includes('å‘ã“ã†ã«')) {\n      z = z * 1.5; // 1.5å€ã®è·é›¢\n    }\n    \n    console.log(`ğŸ“ Position parsed from \"${command}\": (${x}, ${y}, ${z})`);\n    \n    return { x, y, z };\n  }\n\n  /**\n   * ã‚µã‚¤ã‚ºè§£æ\n   */\n  parseSize(command) {\n    if (command.includes('å¤§ããª') || command.includes('å¤§ãã„')) return { scale: 2.0 };\n    if (command.includes('å°ã•ãª') || command.includes('å°ã•ã„')) return { scale: 0.5 };\n    return { scale: this.config.defaultObjectScale };\n  }\n\n  /**\n   * ã‚³ãƒãƒ³ãƒ‰ç¨®åˆ¥åˆ¥å®Ÿè¡Œ\n   */\n  async dispatchCommand(parsed) {\n    switch (parsed.type) {\n      case 'image_generation':\n        // ã‚µãƒ¼ãƒãƒ¼ãªã—ã®å ´åˆã¯ç”Ÿæˆæ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–\n        if (!this.client || !this.client.serverUrl) {\n          throw new Error('ç”»åƒç”Ÿæˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã‚µãƒ¼ãƒãƒ¼è¨­å®šãŒå¿…è¦ã§ã™ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚');\n        }\n        return await this.executeImageGeneration(parsed);\n        \n      case 'video_generation':\n        // ã‚µãƒ¼ãƒãƒ¼ãªã—ã®å ´åˆã¯ç”Ÿæˆæ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–\n        if (!this.client || !this.client.serverUrl) {\n          throw new Error('å‹•ç”»ç”Ÿæˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã‚µãƒ¼ãƒãƒ¼è¨­å®šãŒå¿…è¦ã§ã™ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚');\n        }\n        return await this.executeVideoGeneration(parsed);\n        \n      case 'object_modification':\n        return await this.executeObjectModification(parsed);\n        \n      case 'natural_object_modification':\n        return await this.executeNaturalObjectModification(parsed);\n        \n      case 'delete':\n        return await this.executeDelete(parsed);\n        \n      case 'file_import':\n        return await this.executeFileImport(parsed);\n        \n      case 'object_selection':\n        return await this.executeObjectSelection(parsed);\n        \n      default:\n        throw new Error(`Unknown command type: ${parsed.type}`);\n    }\n  }\n\n  /**\n   * ç”»åƒç”Ÿæˆå®Ÿè¡Œ\n   */\n  async executeImageGeneration(parsed) {\n    try {\n      console.log(`ğŸ¨ Generating image: \"${parsed.prompt}\"`);\n      \n      // æ®µéšçš„ã«ã‚µã‚¤ã‚ºã‚’è©¦è¡Œï¼ˆã‚·ãƒ¼ãƒ³ã«é…ç½®ã—ã‚„ã™ã„ã‚µã‚¤ã‚ºã‚’å„ªå…ˆï¼‰\n      const fallbackSizes = [\n        { width: 512, height: 512 },    // 1:1 åŸºæœ¬ã‚µã‚¤ã‚ºï¼ˆäº’æ›æ€§æœ€é«˜ï¼‰\n        { width: 768, height: 432 },    // 16:9 ç¾ä»£çš„ã‚µã‚¤ã‚º\n        { width: 1024, height: 1024 },  // å¤§ãã‚1:1\n        { width: 640, height: 480 },    // 4:3 ã‚¯ãƒ©ã‚·ãƒƒã‚¯\n      ];\n      \n      let imageResult;\n      let lastError;\n      \n      for (let i = 0; i < fallbackSizes.length; i++) {\n        const dimensions = fallbackSizes[i];\n        try {\n          console.log(`ğŸ”„ Trying ${dimensions.width}x${dimensions.height}...`);\n          \n          imageResult = await this.client.generateImage(parsed.prompt, {\n            width: dimensions.width,\n            height: dimensions.height,\n            service: this.selectedImageService || undefined\n          });\n          \n          if (imageResult.success) {\n            console.log(`âœ… Success with ${dimensions.width}x${dimensions.height}`);\n            break;\n          }\n        } catch (error) {\n          lastError = error;\n          console.log(`âš ï¸ Failed with ${dimensions.width}x${dimensions.height}: ${error.message}`);\n          \n          // æœ€å¾Œã®è©¦è¡Œã§ãªã„å ´åˆã¯ç¶šè¡Œ\n          if (i < fallbackSizes.length - 1) {\n            console.log(`ğŸ”„ Retrying with next size...`);\n            continue;\n          }\n        }\n      }\n      \n      // çµæœã«ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚’å«ã‚ã‚‹\n      if (imageResult && imageResult.modelName) {\n        console.log(`ğŸ“¡ Used model: ${imageResult.modelName}`);\n      }\n      \n      const loader = new THREE.TextureLoader();\n      let texture;\n      if (imageResult && imageResult.success && (imageResult.imageUrl || imageResult.localPath)) {\n        // æˆåŠŸ: ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨ã—ã¦ä½¿ç”¨\n        let imageUrl = imageResult.imageUrl;\n        \n        // localPathã®å ´åˆã¯Webã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªURLã«å¤‰æ›\n        if (!imageUrl && imageResult.localPath) {\n          const filename = imageResult.localPath.split('/').pop();\n          imageUrl = `${this.client.serverUrl}/generated/${filename}`;\n        }\n        \n        console.log(`âœ… Image generated successfully: ${imageUrl}`);\n        texture = await loader.loadAsync(imageUrl);\n\n        // ãƒ†ã‚¯ã‚¹ãƒãƒ£ã®è‰²å½©ã‚’æ­£ç¢ºã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®è¨­å®š\n        texture.colorSpace = THREE.SRGBColorSpace; // æ­£ã—ã„ã‚«ãƒ©ãƒ¼ã‚¹ãƒšãƒ¼ã‚¹\n      } else {\n        // å¤±æ•—: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒã‚’ä½¿ç”¨\n        console.log(`âš ï¸ Using fallback image (last error: ${lastError?.message || 'unknown'})`);\n        texture = this.createFallbackTexture(parsed.prompt);\n      }\n\n      const sizeScale = parsed.size?.scale ?? this.config.defaultObjectScale ?? 1;\n      const baseSize = 6 * sizeScale;\n\n      const imageWidth = texture.image?.naturalWidth || texture.image?.width || texture.source?.data?.width || 1;\n      const imageHeight = texture.image?.naturalHeight || texture.image?.height || texture.source?.data?.height || 1;\n      const aspectRatio = imageWidth / imageHeight || 1;\n\n      let planeWidth = baseSize;\n      let planeHeight = baseSize;\n      if (aspectRatio >= 1) {\n        planeWidth = baseSize;\n        planeHeight = baseSize / aspectRatio;\n      } else {\n        planeWidth = baseSize * aspectRatio;\n        planeHeight = baseSize;\n      }\n\n      // ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹å¹³é¢ã‚¸ã‚ªãƒ¡ãƒˆãƒªã‚’ä½œæˆ\n      const geometry = new THREE.PlaneGeometry(planeWidth, planeHeight);\n      const material = new THREE.MeshBasicMaterial({\n        map: texture,\n        transparent: false,  // ä¸é€æ˜ã§é®®æ˜è¡¨ç¤º\n        side: THREE.DoubleSide, // ä¸¡é¢è¡¨ç¤º\n        toneMapped: false    // ãƒˆãƒ¼ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ç„¡åŠ¹åŒ–ï¼ˆã‚ˆã‚Šé®®ã‚„ã‹ãªè‰²å½©ï¼‰\n      });\n      \n      const plane = new THREE.Mesh(geometry, material);\n      \n      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é †åºã‚’è¨­å®šï¼ˆç”»åƒã‚‚å‰é¢ã«è¡¨ç¤ºï¼‰\n      plane.renderOrder = 1000;  // é«˜ã„å€¤ã§å‰é¢ã«è¡¨ç¤º\n      material.depthTest = true;  // æ·±åº¦ãƒ†ã‚¹ãƒˆã¯æœ‰åŠ¹ã«\n      material.depthWrite = true; // æ·±åº¦æ›¸ãè¾¼ã¿ã‚‚æœ‰åŠ¹ã«\n      \n      // ã‚«ãƒ¡ãƒ©ç›¸å¯¾ä½ç½®ã§é…ç½®ï¼ˆã‚«ãƒ¡ãƒ©ã®å‘ãã‚‚è€ƒæ…®ï¼‰\n      if (this.camera) {\n        const finalPosition = this.calculateCameraRelativePosition(parsed.position);\n        plane.position.copy(finalPosition);\n        this.alignPlaneToCamera(plane);\n      } else {\n        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: çµ¶å¯¾åº§æ¨™\n        plane.position.set(parsed.position.x, parsed.position.y, parsed.position.z);\n      }\n      \n      // ã‚¹ã‚±ãƒ¼ãƒ«ã¯å¹…è¨ˆç®—ã«å«ã‚ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯1.0ã«å›ºå®š\n      plane.scale.setScalar(1.0);\n      \n      // è­˜åˆ¥ç”¨ã®åå‰ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿\n      const objectId = `generated_${++this.objectCounter}`;\n      plane.name = objectId;\n      plane.userData = {\n        id: objectId,\n        prompt: parsed.prompt,\n        createdAt: Date.now(),\n        type: 'generated_image',\n        modelName: imageResult?.modelName || this.selectedImageService || null\n      };\n      \n      this.experimentGroup.add(plane);\n      this.spawnedObjects.set(objectId, plane);\n      \n      console.log(`âœ… Created object: ${objectId} at (${parsed.position.x}, ${parsed.position.y}, ${parsed.position.z})`);\n      \n      // ç”Ÿæˆä½ç½®ã«ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ï¼ˆè¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰\n      if (this.config.showLocationIndicator) {\n        this.createLocationIndicator(parsed.position);\n      }\n      \n      return {\n        objectId,\n        position: parsed.position,\n        prompt: parsed.prompt,\n        modelName: imageResult?.modelName,\n        success: true\n      };\n      \n    } catch (error) {\n      console.error('ğŸ¨ Image generation failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * å‹•ç”»ç”Ÿæˆå®Ÿè¡Œ\n   */\n  async executeVideoGeneration(parsed) {\n    try {\n      console.log(`ğŸ¬ Generating video: \"${parsed.prompt}\"`);\n      console.log('ğŸ” Video generation - selectedVideoService:', this.selectedVideoService);\n      \n      // ChocoDro ClientçµŒç”±ã§å‹•ç”»ç”Ÿæˆ\n      // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã¯å„ãƒ¢ãƒ‡ãƒ«ã®ã‚µãƒãƒ¼ãƒˆçŠ¶æ³ã«å¿œã˜ã¦ã‚µãƒ¼ãƒãƒ¼å´ã§æœ€é©åŒ–\n      const videoResult = await this.client.generateVideo(parsed.prompt, {\n        duration: 3,\n        model: this.selectedVideoService || undefined\n        // width, heightæŒ‡å®šã‚’å‰Šé™¤ã—ã¦ã‚µãƒ¼ãƒãƒ¼å´ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ(16:9)ã‚’ä½¿ç”¨\n      });\n      \n      // çµæœã«ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚’å«ã‚ã‚‹\n      if (videoResult.modelName) {\n        console.log(`ğŸ“¡ Used model: ${videoResult.modelName}`);\n      }\n      \n      let videoTexture;\n      let video = null; // videoå¤‰æ•°ã‚’ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã§å®šç¾©\n      \n      if (videoResult.success && videoResult.videoUrl) {\n        // æˆåŠŸ: ç”Ÿæˆã•ã‚ŒãŸå‹•ç”»ã‚’ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨ã—ã¦ä½¿ç”¨\n        console.log(`âœ… Video generated successfully: ${videoResult.videoUrl}`);\n        \n        // HTML5 videoè¦ç´ ã‚’ä½œæˆ\n        video = document.createElement('video');\n        video.src = videoResult.videoUrl;\n        video.crossOrigin = 'anonymous';\n        video.loop = true;\n        video.muted = true; // åˆæœŸã¯ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§éŸ³å£°åˆ¶å¾¡ï¼‰\n        video.playsInline = true;\n        \n        // å‹•ç”»ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ä½œæˆ\n        videoTexture = new THREE.VideoTexture(video);\n        videoTexture.colorSpace = THREE.SRGBColorSpace;\n        \n        // å‹•ç”»ã®è‡ªå‹•å†ç”Ÿã‚’é–‹å§‹\n        video.addEventListener('loadeddata', () => {\n          video.play().catch(console.error);\n        });\n        \n      } else {\n        // å¤±æ•—: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å‹•ç”»ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ä½¿ç”¨\n        console.log(`âš ï¸ Using fallback video texture`);\n        videoTexture = this.createFallbackVideoTexture(parsed.prompt);\n      }\n      \n      // å‹•ç”»ã‚’è¡¨ç¤ºã™ã‚‹å¹³é¢ã‚¸ã‚ªãƒ¡ãƒˆãƒªã‚’ä½œæˆï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’è€ƒæ…®ï¼‰\n      const sizeScale = parsed.size?.scale ?? this.config.defaultObjectScale ?? 1;\n      const baseSize = 6 * sizeScale;\n\n      const requestedWidth = videoResult.metadata?.width || 512;\n      const requestedHeight = videoResult.metadata?.height || 512;\n      const planeAspect = requestedWidth && requestedHeight ? requestedWidth / requestedHeight : 1;\n\n      let planeWidth = baseSize;\n      let planeHeight = baseSize;\n\n      if (planeAspect >= 1) {\n        planeHeight = baseSize / planeAspect;\n      } else {\n        planeWidth = baseSize * planeAspect;\n      }\n\n      const geometry = new THREE.PlaneGeometry(planeWidth, planeHeight);\n      const material = new THREE.MeshBasicMaterial({\n        map: videoTexture,\n        transparent: false,\n        side: THREE.DoubleSide,\n        toneMapped: false\n      });\n      \n      const plane = new THREE.Mesh(geometry, material);\n      \n      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é †åºã‚’è¨­å®šï¼ˆå‹•ç”»ã‚’å‰é¢ã«è¡¨ç¤ºï¼‰\n      plane.renderOrder = 1000;  // é«˜ã„å€¤ã§å‰é¢ã«è¡¨ç¤º\n      material.depthTest = true;  // æ·±åº¦ãƒ†ã‚¹ãƒˆã¯æœ‰åŠ¹ã«\n      material.depthWrite = true; // æ·±åº¦æ›¸ãè¾¼ã¿ã‚‚æœ‰åŠ¹ã«\n      \n      // ã‚«ãƒ¡ãƒ©ç›¸å¯¾ä½ç½®ã§é…ç½®\n      if (this.camera) {\n        const finalPosition = this.calculateCameraRelativePosition(parsed.position);\n        plane.position.copy(finalPosition);\n        this.alignPlaneToCamera(plane);\n      } else {\n        plane.position.set(parsed.position.x, parsed.position.y, parsed.position.z);\n      }\n\n      // ã‚¹ã‚±ãƒ¼ãƒ«ã¯å¹…è¨ˆç®—ã«å«ã‚ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯1.0ã«å›ºå®š\n      plane.scale.setScalar(1.0);\n\n      // è­˜åˆ¥ç”¨ã®åå‰ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿\n      const objectId = `generated_video_${++this.objectCounter}`;\n      plane.name = objectId;\n      plane.userData = {\n        id: objectId,\n        prompt: parsed.prompt,\n        createdAt: Date.now(),\n        type: 'generated_video',\n        videoUrl: videoResult.videoUrl,\n        modelName: videoResult.modelName || this.selectedVideoService || null,\n        width: requestedWidth,\n        height: requestedHeight,\n        videoElement: video // videoè¦ç´ ã®å‚ç…§ã‚’ä¿å­˜\n      };\n\n      // éŸ³å£°åˆ¶å¾¡UIã‚’ä½œæˆ\n      this.createAudioControl(plane);\n      \n      this.experimentGroup.add(plane);\n      this.spawnedObjects.set(objectId, plane);\n      \n      console.log(`âœ… Created video object: ${objectId} at (${parsed.position.x}, ${parsed.position.y}, ${parsed.position.z})`);\n      \n      // ç”Ÿæˆä½ç½®ã«ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ \n      if (this.config.showLocationIndicator) {\n        this.createLocationIndicator(parsed.position);\n      }\n      \n      return {\n        objectId,\n        position: parsed.position,\n        prompt: parsed.prompt,\n        modelName: videoResult.modelName,\n        videoUrl: videoResult.videoUrl,\n        success: true\n      };\n      \n    } catch (error) {\n      console.error('ğŸ¬ Video generation failed:', error);\n      \n      // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å‹•ç”»ã‚’è¡¨ç¤º\n      console.log('ğŸ”„ Creating fallback video plane due to generation error');\n      const fallbackVideoTexture = this.createFallbackVideoTexture(parsed.prompt);\n      \n      // å‹•ç”»ã‚’è¡¨ç¤ºã™ã‚‹å¹³é¢ã‚¸ã‚ªãƒ¡ãƒˆãƒªã‚’ä½œæˆ\n      const sizeScale = parsed.size?.scale ?? this.config.defaultObjectScale ?? 1;\n      const baseSize = 6 * sizeScale;\n      const geometry = new THREE.PlaneGeometry(baseSize, baseSize);\n      const material = new THREE.MeshBasicMaterial({\n        map: fallbackVideoTexture,\n        transparent: false,\n        side: THREE.DoubleSide,\n        toneMapped: false\n      });\n      \n      const plane = new THREE.Mesh(geometry, material);\n      \n      // ã‚«ãƒ¡ãƒ©ç›¸å¯¾ä½ç½®ã§é…ç½®\n      if (this.camera) {\n        const finalPosition = this.calculateCameraRelativePosition(parsed.position);\n        plane.position.copy(finalPosition);\n        this.alignPlaneToCamera(plane);\n      } else {\n        plane.position.set(parsed.position.x, parsed.position.y, parsed.position.z);\n      }\n\n      plane.scale.setScalar(1.0);\n\n      // è­˜åˆ¥ç”¨ã®åå‰ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿\n      const objectId = `generated_video_${++this.objectCounter}`;\n      plane.name = objectId;\n      plane.userData = {\n        id: objectId,\n        prompt: parsed.prompt,\n        createdAt: Date.now(),\n        type: 'generated_video',\n        videoUrl: null, // ã‚¨ãƒ©ãƒ¼æ™‚ã¯null\n        modelName: 'Error Fallback',\n        width: 512,\n        height: 512,\n        videoElement: null,\n        error: error.message\n      };\n\n      // ã‚·ãƒ¼ãƒ³ã«è¿½åŠ \n      this.scene.add(plane);\n      console.log('ğŸ“ Fallback video plane added to scene');\n\n      return {\n        success: false,\n        error: error.message,\n        object: plane,\n        prompt: parsed.prompt\n      };\n    }\n  }\n\n  async loadImageFile(fileUrl, options = {}) {\n    try {\n      const { position = { x: 0, y: 5, z: -10 }, fileName = null } = options;\n      \n      console.log(`ğŸ“ Loading image file: ${fileUrl}`);\n      \n      // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’èª­ã¿è¾¼ã¿\n      const loader = new THREE.TextureLoader();\n      const texture = await loader.loadAsync(fileUrl);\n\n      // ãƒ†ã‚¯ã‚¹ãƒãƒ£ã®è‰²å½©ã‚’æ­£ç¢ºã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®è¨­å®š\n      texture.colorSpace = THREE.SRGBColorSpace;\n\n      // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç®—å‡ºï¼ˆfallback: 1ï¼‰\n      const imageWidth = texture.image?.naturalWidth || texture.image?.width || texture.source?.data?.width || 1;\n      const imageHeight = texture.image?.naturalHeight || texture.image?.height || texture.source?.data?.height || 1;\n      const aspectRatio = imageWidth / imageHeight || 1;\n      \n      const baseSize = 6;\n      let width = baseSize;\n      let height = baseSize;\n      if (aspectRatio >= 1) {\n        width = baseSize;\n        height = baseSize / aspectRatio;\n      } else {\n        width = baseSize * aspectRatio;\n        height = baseSize;\n      }\n\n      // ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹å¹³é¢ã‚¸ã‚ªãƒ¡ãƒˆãƒªã‚’ä½œæˆï¼ˆç¸¦æ¨ªæ¯”ã‚’ç¶­æŒï¼‰\n      const geometry = new THREE.PlaneGeometry(width, height);\n      const material = new THREE.MeshBasicMaterial({\n        map: texture,\n        transparent: false,\n        side: THREE.DoubleSide,\n        toneMapped: false\n      });\n      \n      const plane = new THREE.Mesh(geometry, material);\n\n      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é †åºã‚’è¨­å®š\n      plane.renderOrder = 1000;\n      material.depthTest = true;\n      material.depthWrite = true;\n      \n      // ã‚«ãƒ¡ãƒ©ç›¸å¯¾ä½ç½®ã§é…ç½®\n      if (this.camera) {\n        const finalPosition = this.calculateCameraRelativePosition(position);\n        plane.position.copy(finalPosition);\n        this.alignPlaneToCamera(plane);\n      } else {\n        plane.position.set(position.x, position.y, position.z);\n      }\n      \n      plane.scale.setScalar(1.0);\n      \n      // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰promptã‚’ä½œæˆï¼ˆæ‹¡å¼µå­ã‚’é™¤å»ï¼‰\n      const prompt = fileName ? fileName.replace(/\\.[^/.]+$/, '') : 'imported_image';\n\n      // è­˜åˆ¥ç”¨ã®åå‰ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿\n      const objectId = `imported_image_${++this.objectCounter}`;\n      plane.name = objectId;\n      plane.userData = {\n        id: objectId,\n        source: 'imported_file',\n        createdAt: Date.now(),\n        type: 'generated_image',\n        prompt: prompt, // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’promptã¨ã—ã¦è¨­å®š\n        fileName: fileName, // å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚‚ä¿å­˜\n        importOrder: this.objectCounter // ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºã‚’è¨˜éŒ²\n      };\n      \n      this.experimentGroup.add(plane);\n      this.spawnedObjects.set(objectId, plane);\n      \n      console.log(`âœ… Created imported image: ${objectId} at (${position.x}, ${position.y}, ${position.z})`);\n      \n      // ç”Ÿæˆä½ç½®ã«ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ \n      if (this.config.showLocationIndicator) {\n        this.createLocationIndicator(position);\n      }\n      \n      return {\n        objectId,\n        position: position,\n        success: true\n      };\n      \n    } catch (error) {\n      console.error('ğŸ“ Image file loading failed:', error);\n      throw error;\n    }\n  }\n\n  async loadVideoFile(fileUrl, options = {}) {\n    try {\n      const { position = { x: 0, y: 5, z: -10 }, fileName = null } = options;\n      \n      console.log(`ğŸ¬ Loading video file: ${fileUrl}`);\n      \n      // HTMLVideoElementã‚’ä½œæˆ\n      const video = document.createElement('video');\n      video.src = fileUrl;\n      video.loop = true;\n      video.muted = true;\n      video.playsInline = true;\n      video.autoplay = true;\n      video.preload = 'auto';\n\n      // VideoTextureã‚’ä½œæˆ\n      const videoTexture = new THREE.VideoTexture(video);\n      videoTexture.colorSpace = THREE.SRGBColorSpace;\n\n      // ãƒ“ãƒ‡ã‚ªã®èª­ã¿è¾¼ã¿ã¨ã‚µã‚¤ã‚ºå–å¾—\n      await new Promise((resolve, reject) => {\n        const handleLoaded = () => {\n          console.log(`ğŸ¬ Video loaded: ${video.videoWidth}x${video.videoHeight}`);\n          resolve();\n        };\n        const handleError = (event) => {\n          reject(event?.error || new Error('Video failed to load'));\n        };\n\n        video.addEventListener('loadedmetadata', handleLoaded, { once: true });\n        video.addEventListener('error', handleError, { once: true });\n        video.load();\n      });\n\n      try {\n        await video.play();\n      } catch (playError) {\n        console.warn('ğŸ¬ Video autoplay could not start automatically. Playback will require user interaction.', playError);\n      }\n      \n      // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’è¨ˆç®—ã—ã¦ã‚µã‚¤ã‚ºèª¿æ•´\n      const aspectRatio = video.videoWidth / video.videoHeight;\n      const baseSize = 6;\n      let width = baseSize;\n      let height = baseSize;\n      \n      if (aspectRatio > 1) {\n        height = baseSize / aspectRatio;\n      } else {\n        width = baseSize * aspectRatio;\n      }\n      \n      // å‹•ç”»ã‚’è¡¨ç¤ºã™ã‚‹å¹³é¢ã‚¸ã‚ªãƒ¡ãƒˆãƒªã‚’ä½œæˆ\n      const geometry = new THREE.PlaneGeometry(width, height);\n      const material = new THREE.MeshBasicMaterial({\n        map: videoTexture,\n        transparent: false,\n        side: THREE.DoubleSide,\n        toneMapped: false\n      });\n      \n      const plane = new THREE.Mesh(geometry, material);\n      \n      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é †åºã‚’è¨­å®š\n      plane.renderOrder = 1000;\n      material.depthTest = true;\n      material.depthWrite = true;\n      \n      // ã‚«ãƒ¡ãƒ©ç›¸å¯¾ä½ç½®ã§é…ç½®\n      if (this.camera) {\n        const finalPosition = this.calculateCameraRelativePosition(position);\n        plane.position.copy(finalPosition);\n        this.alignPlaneToCamera(plane);\n      } else {\n        plane.position.set(position.x, position.y, position.z);\n      }\n      \n      plane.scale.setScalar(1.0);\n      \n      // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰promptã‚’ä½œæˆï¼ˆæ‹¡å¼µå­ã‚’é™¤å»ï¼‰\n      const prompt = fileName ? fileName.replace(/\\.[^/.]+$/, '') : 'imported_video';\n\n      // è­˜åˆ¥ç”¨ã®åå‰ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿\n      const objectId = `imported_video_${++this.objectCounter}`;\n      plane.name = objectId;\n      plane.userData = {\n        id: objectId,\n        source: 'imported_file',\n        createdAt: Date.now(),\n        type: 'generated_video',\n        videoElement: video,\n        objectUrl: fileUrl,\n        prompt: prompt, // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’promptã¨ã—ã¦è¨­å®š\n        fileName: fileName, // å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚‚ä¿å­˜\n        importOrder: this.objectCounter // ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºã‚’è¨˜éŒ²\n      };\n\n      // éŸ³å£°åˆ¶å¾¡UIã‚’ä½œæˆ\n      this.createAudioControl(plane);\n\n      this.experimentGroup.add(plane);\n      this.spawnedObjects.set(objectId, plane);\n      \n      console.log(`âœ… Created imported video: ${objectId} at (${position.x}, ${position.y}, ${position.z})`);\n      \n      // ç”Ÿæˆä½ç½®ã«ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ \n      if (this.config.showLocationIndicator) {\n        this.createLocationIndicator(position);\n      }\n      \n      return {\n        objectId,\n        position: position,\n        success: true\n      };\n      \n    } catch (error) {\n      console.error('ğŸ¬ Video file loading failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * è‡ªç„¶è¨€èªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ“ä½œå®Ÿè¡Œ\n   */\n  async executeNaturalObjectModification(parsed) {\n    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åå‰ã§æ¤œç´¢\n    const targetObjects = this.findObjectsByName(parsed.targetObjectName);\n    \n    if (targetObjects.length === 0) {\n      return {\n        success: false,\n        message: `ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€Œ${parsed.targetObjectName}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`\n      };\n    }\n    \n    console.log(`ğŸ” Found ${targetObjects.length} object(s) matching \"${parsed.targetObjectName}\"`);\n    \n    // è¤‡æ•°ã®å ´åˆã¯åºæ•°è©ã§é¸æŠã€ãªã‘ã‚Œã°æœ€åˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n    const targetObject = this.selectObjectFromMultiple(targetObjects, parsed.targetObjectName);\n    console.log(`ğŸ¯ Operating on object: ${targetObject.name}`);\n    \n    let modified = false;\n    \n    // è‰²å¤‰æ›´\n    if (parsed.color !== null && targetObject.material) {\n      if (targetObject.material.map) {\n        targetObject.material.color.setHex(parsed.color);\n        console.log(`ğŸ¨ Color changed to: ${parsed.color.toString(16)}`);\n      } else {\n        targetObject.material.color.setHex(parsed.color);\n        console.log(`ğŸ¨ Color changed to: ${parsed.color.toString(16)}`);\n      }\n      modified = true;\n    }\n    \n    // ä½ç½®ç§»å‹•\n    if (parsed.movement !== null) {\n      const currentPos = targetObject.position;\n      const newPos = {\n        x: currentPos.x + parsed.movement.x,\n        y: currentPos.y + parsed.movement.y,\n        z: currentPos.z + parsed.movement.z\n      };\n      \n      targetObject.position.set(newPos.x, newPos.y, newPos.z);\n      console.log(`ğŸ“ Position moved from (${currentPos.x.toFixed(1)}, ${currentPos.y.toFixed(1)}, ${currentPos.z.toFixed(1)}) to (${newPos.x.toFixed(1)}, ${newPos.y.toFixed(1)}, ${newPos.z.toFixed(1)})`);\n      modified = true;\n    }\n    \n    if (modified) {\n      // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°\n      targetObject.userData.lastModified = Date.now();\n      targetObject.userData.modifications = targetObject.userData.modifications || [];\n      targetObject.userData.modifications.push({\n        timestamp: Date.now(),\n        color: parsed.color,\n        movement: parsed.movement,\n        command: `Natural language: ${parsed.targetObjectName}`\n      });\n      \n      return {\n        success: true,\n        message: `ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€Œ${targetObject.name}ã€ã‚’å¤‰æ›´ã—ã¾ã—ãŸ`,\n        objectId: targetObject.name,\n        modifications: {\n          color: parsed.color,\n          movement: parsed.movement\n        }\n      };\n    } else {\n      return {\n        success: false,\n        message: 'å¤‰æ›´å¯èƒ½ãªå±æ€§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'\n      };\n    }\n  }\n  \n  /**\n   * åå‰ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œç´¢\n   */\n  findObjectsByName(searchName) {\n    const results = [];\n    const searchLower = searchName.toLowerCase();\n    \n    // ç”Ÿæˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰æ¤œç´¢\n    for (const [objectId, object] of this.spawnedObjects) {\n      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæƒ…å ±ã‹ã‚‰æ¤œç´¢\n      if (object.userData.prompt) {\n        const promptLower = object.userData.prompt.toLowerCase();\n        \n        // éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢ï¼ˆã€Œãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³ã€ãŒã€Œãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³ã®ç”»åƒã€ã«ãƒãƒƒãƒï¼‰\n        if (promptLower.includes(searchLower)) {\n          results.push(object);\n          console.log(`âœ… Object match found: ${objectId} (prompt: \"${object.userData.prompt}\")`);\n        }\n      }\n      \n      // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåã‹ã‚‰ã‚‚æ¤œç´¢\n      if (object.name && object.name.toLowerCase().includes(searchLower)) {\n        results.push(object);\n        console.log(`âœ… Object match found: ${objectId} (name: \"${object.name}\")`);\n      }\n    }\n    \n    return results;\n  }\n  \n  /**\n   * è¤‡æ•°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰åºæ•°è©ã§é¸æŠ\n   */\n  selectObjectFromMultiple(objects, originalCommand) {\n    // åºæ•°è©ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯\n    const ordinalPatterns = [\n      /(\\d+)ã¤ç›®ã®/, /(\\d+)ç•ªç›®ã®/, /(\\d+)å€‹ç›®ã®/,\n      /æœ€åˆã®|1ã¤ç›®ã®|1ç•ªç›®ã®|1å€‹ç›®ã®/,\n      /æœ€å¾Œã®|æœ€çµ‚ã®/,\n      /2ã¤ç›®ã®|2ç•ªç›®ã®|2å€‹ç›®ã®/,\n      /3ã¤ç›®ã®|3ç•ªç›®ã®|3å€‹ç›®ã®/\n    ];\n    \n    for (const pattern of ordinalPatterns) {\n      const match = originalCommand.match(pattern);\n      if (match) {\n        let index;\n        \n        if (match[1]) {\n          // æ•°å­—ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ\n          index = parseInt(match[1]) - 1; // 1ãƒ™ãƒ¼ã‚¹ã‹ã‚‰0ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›\n        } else {\n          // ç‰¹åˆ¥ãªè¡¨ç¾ã®å ´åˆ\n          const matchedText = match[0];\n          if (matchedText.includes('æœ€åˆ') || matchedText.includes('1ã¤ç›®') || \n              matchedText.includes('1ç•ªç›®') || matchedText.includes('1å€‹ç›®')) {\n            index = 0;\n          } else if (matchedText.includes('æœ€å¾Œ') || matchedText.includes('æœ€çµ‚')) {\n            index = objects.length - 1;\n          } else if (matchedText.includes('2ã¤ç›®') || matchedText.includes('2ç•ªç›®') || matchedText.includes('2å€‹ç›®')) {\n            index = 1;\n          } else if (matchedText.includes('3ã¤ç›®') || matchedText.includes('3ç•ªç›®') || matchedText.includes('3å€‹ç›®')) {\n            index = 2;\n          }\n        }\n        \n        if (index >= 0 && index < objects.length) {\n          console.log(`ğŸ”¢ Selected object by ordinal: index ${index + 1} of ${objects.length}`);\n          return objects[index];\n        } else {\n          console.warn(`âš ï¸ Invalid ordinal index: ${index + 1} (available: 1-${objects.length})`);\n        }\n      }\n    }\n    \n    // åºæ•°è©ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€åˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n    console.log(`ğŸ”¢ No ordinal specified, using first object`);\n    return objects[0];\n  }\n\n  /**\n   * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ›´å®Ÿè¡Œ\n   */\n  async executeObjectModification(parsed) {\n    // ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰å¯¾è±¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç‰¹å®š\n    let targetObject = this.findObjectByKeyword(parsed.command);\n    \n    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨\n    if (!targetObject) {\n      if (!this.selectedObject) {\n        return { \n          success: false, \n          message: 'ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã™ã‚‹ã‹ã€å¯¾è±¡ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€ŒçŒ«ã‚’èµ¤ãã—ã¦ã€ï¼‰' \n        };\n      }\n      targetObject = this.selectedObject;\n    } else {\n      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§è¦‹ã¤ã‘ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹\n      this.selectObject(targetObject);\n    }\n    console.log(`ğŸ”§ Modifying object: ${targetObject.name}`);\n    console.log(`ğŸ” Debug - parsed.movement:`, parsed.movement);\n    \n    let modified = false;\n    \n    // è‰²å¤‰æ›´\n    if (parsed.color !== null && targetObject.material) {\n      if (targetObject.material.map) {\n        // ãƒ†ã‚¯ã‚¹ãƒãƒ£ãŒã‚ã‚‹å ´åˆã¯è‰²èª¿å¤‰æ›´\n        targetObject.material.color.setHex(parsed.color);\n        console.log(`ğŸ¨ Color changed to: ${parsed.color.toString(16)}`);\n      } else {\n        // ãƒ†ã‚¯ã‚¹ãƒãƒ£ãŒãªã„å ´åˆã¯ç›´æ¥è‰²å¤‰æ›´\n        targetObject.material.color.setHex(parsed.color);\n        console.log(`ğŸ¨ Color changed to: ${parsed.color.toString(16)}`);\n      }\n      modified = true;\n    }\n    \n    // ã‚µã‚¤ã‚ºå¤‰æ›´\n    if (parsed.scale !== null) {\n      const currentScale = targetObject.scale.x; // ç¾åœ¨ã®ã‚¹ã‚±ãƒ¼ãƒ«å–å¾—\n      const newScale = currentScale * parsed.scale;\n      targetObject.scale.setScalar(newScale);\n      console.log(`ğŸ“ Scale changed from ${currentScale} to ${newScale}`);\n      modified = true;\n    }\n    \n    // ä½ç½®ç§»å‹•\n    if (parsed.movement !== null) {\n      // ç¾åœ¨ä½ç½®ã‹ã‚‰ç›¸å¯¾ç§»å‹•\n      const currentPos = targetObject.position;\n      const newPos = {\n        x: currentPos.x + parsed.movement.x,\n        y: currentPos.y + parsed.movement.y,\n        z: currentPos.z + parsed.movement.z\n      };\n\n      targetObject.position.set(newPos.x, newPos.y, newPos.z);\n      console.log(`ğŸ“ Position moved from (${currentPos.x.toFixed(1)}, ${currentPos.y.toFixed(1)}, ${currentPos.z.toFixed(1)}) to (${newPos.x.toFixed(1)}, ${newPos.y.toFixed(1)}, ${newPos.z.toFixed(1)})`);\n      modified = true;\n    }\n\n    // å›è»¢\n    if (parsed.rotation !== null) {\n      const currentRotation = targetObject.rotation.y;\n      const newRotation = currentRotation + parsed.rotation;\n      targetObject.rotation.y = newRotation;\n      const degrees = (parsed.rotation * 180 / Math.PI).toFixed(1);\n      console.log(`ğŸ”„ Rotation changed by ${degrees}Â° (new Y rotation: ${(newRotation * 180 / Math.PI).toFixed(1)}Â°)`);\n      modified = true;\n    }\n\n    // é€æ˜åº¦\n    if (parsed.opacity !== null && targetObject.material) {\n      const currentOpacity = targetObject.material.opacity || 1.0;\n      targetObject.material.opacity = parsed.opacity;\n      targetObject.material.transparent = parsed.opacity < 1.0;\n      console.log(`ğŸ” Opacity changed from ${currentOpacity.toFixed(2)} to ${parsed.opacity.toFixed(2)}`);\n      modified = true;\n    }\n    \n    if (modified) {\n      // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°\n      targetObject.userData.lastModified = Date.now();\n      targetObject.userData.modifications = targetObject.userData.modifications || [];\n      targetObject.userData.modifications.push({\n        timestamp: Date.now(),\n        color: parsed.color,\n        scale: parsed.scale,\n        movement: parsed.movement,\n        rotation: parsed.rotation,\n        opacity: parsed.opacity,\n        command: parsed.command\n      });\n      \n      return { \n        success: true, \n        message: `ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€Œ${targetObject.name}ã€ã‚’å¤‰æ›´ã—ã¾ã—ãŸ`,\n        objectId: targetObject.name,\n        modifications: {\n          color: parsed.color,\n          scale: parsed.scale,\n          movement: parsed.movement,\n          rotation: parsed.rotation,\n          opacity: parsed.opacity\n        }\n      };\n    } else {\n      return { \n        success: false, \n        message: 'å¤‰æ›´å¯èƒ½ãªå±æ€§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ' \n      };\n    }\n  }\n\n  /**\n   * å‰Šé™¤å®Ÿè¡Œ\n   */\n  async executeDelete(parsed) {\n    // ã‚³ãƒãƒ³ãƒ‰ã®å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯\n    const command = parsed.command || '';\n    \n    // ã€Œã™ã¹ã¦ã€å‰Šé™¤ã®å ´åˆ\n    if (parsed.target === 'all' || command.includes('ã™ã¹ã¦') || command.includes('å…¨éƒ¨')) {\n      this.clearAll();\n      return { success: true, message: 'ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ' };\n    }\n    \n    // ã¾ãšã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰å¯¾è±¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç‰¹å®š\n    const targetByKeyword = this.findObjectByKeyword(command);\n    \n    // å‰Šé™¤å¯¾è±¡ã®å„ªå…ˆé †ä½ï¼š\n    // 1. ã‚³ãƒãƒ³ãƒ‰ã§æŒ‡å®šã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n    // 2. é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\n    // 3. ã‚³ãƒãƒ³ãƒ‰ãŒå˜ã«ã€Œå‰Šé™¤ã€ã ã‘ã®å ´åˆã¯é¸æŠã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å„ªå…ˆ\n    \n    let targetObject = null;\n    let deleteReason = '';\n    \n    // ã‚³ãƒãƒ³ãƒ‰ãŒå˜ç´”ãªå‰Šé™¤ã‚³ãƒãƒ³ãƒ‰ã‹åˆ¤å®š\n    const isSimpleDeleteCommand = command.match(/^(å‰Šé™¤|æ¶ˆã—ã¦|æ¶ˆã™|delete|remove)$/i);\n    \n    if (isSimpleDeleteCommand && this.selectedObject) {\n      // å˜ç´”ãªã€Œå‰Šé™¤ã€ã‚³ãƒãƒ³ãƒ‰ã§é¸æŠã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹å ´åˆ\n      targetObject = this.selectedObject;\n      deleteReason = 'é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ';\n    } else if (targetByKeyword) {\n      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ç‰¹å®šã§ããŸå ´åˆ\n      targetObject = targetByKeyword;\n      deleteReason = 'ã‚³ãƒãƒ³ãƒ‰ã§æŒ‡å®šã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ';\n    } else if (this.selectedObject) {\n      // ãã®ä»–ã®å ´åˆã§é¸æŠã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹å ´åˆ\n      targetObject = this.selectedObject;\n      deleteReason = 'é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ';\n    }\n    \n    if (targetObject) {\n      const objectId = targetObject.name;\n      console.log(`ğŸ—‘ï¸ Deleting ${deleteReason}: ${objectId}`);\n      \n      // é¸æŠçŠ¶æ…‹ã‚’è§£é™¤\n      if (targetObject === this.selectedObject) {\n        this.deselectObject();\n      }\n      \n      // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤\n      const success = this.removeObject(objectId);\n      \n      if (success) {\n        return { \n          success: true, \n          message: `${deleteReason}ã€Œ${objectId}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`,\n          deletedObjectId: objectId\n        };\n      } else {\n        return { \n          success: false, \n          message: 'ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ' \n        };\n      }\n    }\n    \n    return { \n      success: false, \n      message: 'å‰Šé™¤å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã™ã‚‹ã‹ã€å¯¾è±¡ã‚’æŒ‡å®šã—ã¦ãã ã•ã„' \n    };\n  }\n\n  async executeFileImport(parsed) {\n    try {\n      console.log('ğŸ« Starting file import process...');\n      \n      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º\n      const input = document.createElement('input');\n      input.type = 'file';\n      input.style.display = 'none';\n      \n      if (parsed.fileType === 'video') {\n        input.accept = 'video/*';\n      } else {\n        input.accept = 'image/*';\n      }\n      \n      document.body.appendChild(input);\n      \n      return new Promise((resolve, reject) => {\n        input.onchange = async (event) => {\n          try {\n            const file = event.target.files[0];\n            if (!file) {\n              reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ'));\n              return;\n            }\n            \n            console.log(`ğŸ“ Selected file: ${file.name}`);\n            \n            // ãƒ•ã‚¡ã‚¤ãƒ«ã®ObjectURLã‚’ä½œæˆ\n            const fileUrl = URL.createObjectURL(file);\n            \n            let result;\n            if (parsed.fileType === 'video' || file.type.startsWith('video/')) {\n              result = await this.loadVideoFile(fileUrl, { position: parsed.position });\n            } else {\n              result = await this.loadImageFile(fileUrl, { position: parsed.position });\n            }\n            \n            console.log('âœ… File import completed:', result);\n            resolve(result);\n            \n          } catch (error) {\n            console.error('âŒ File import failed:', error);\n            reject(error);\n          } finally {\n            document.body.removeChild(input);\n          }\n        };\n        \n        input.oncancel = () => {\n          document.body.removeChild(input);\n          reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ'));\n        };\n        \n        input.click();\n      });\n      \n    } catch (error) {\n      console.error('âŒ File import execution failed:', error);\n      throw error;\n    }\n  }\n\n  async executeObjectSelection(parsed) {\n    try {\n      console.log('ğŸ¯ Starting object selection...');\n      \n      const objects = this.getSpawnedObjects();\n      if (objects.length === 0) {\n        throw new Error('é¸æŠå¯èƒ½ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');\n      }\n      \n      console.log(`ğŸ“‹ Available objects: ${objects.length}`);\n      \n      // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠUIã‚’ä½œæˆ\n      const modal = document.createElement('div');\n      modal.style.cssText = `\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.8);\n        z-index: 10000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      `;\n      \n      const container = document.createElement('div');\n      container.style.cssText = `\n        background: #1a1a2e;\n        border-radius: 12px;\n        padding: 24px;\n        max-width: 500px;\n        max-height: 70vh;\n        overflow-y: auto;\n        color: white;\n        font-family: Arial, sans-serif;\n      `;\n      \n      const title = document.createElement('h3');\n      title.textContent = 'ğŸ¯ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„';\n      title.style.cssText = 'margin: 0 0 16px 0; color: #ec4899;';\n      container.appendChild(title);\n      \n      const objectList = document.createElement('div');\n      objectList.style.cssText = 'margin-bottom: 16px;';\n      \n      objects.forEach((obj, index) => {\n        const item = document.createElement('div');\n        item.style.cssText = `\n          padding: 12px;\n          margin: 8px 0;\n          background: #2a2a3e;\n          border-radius: 8px;\n          cursor: pointer;\n          border: 2px solid transparent;\n          transition: all 0.3s ease;\n        `;\n        \n        const name = obj.userData?.type === 'generated_image' ? 'ğŸ–¼ï¸ ç”»åƒ' : \n                     obj.userData?.type === 'generated_video' ? 'ğŸ¬ å‹•ç”»' : 'ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«';\n        const time = new Date(obj.userData?.createdAt).toLocaleTimeString();\n        \n        item.innerHTML = `\n          <div style=\"font-weight: bold;\">${name} #${index + 1}</div>\n          <div style=\"font-size: 12px; color: #94a3b8;\">ä½œæˆ: ${time}</div>\n          <div style=\"font-size: 12px; color: #94a3b8;\">ä½ç½®: (${Math.round(obj.position.x)}, ${Math.round(obj.position.y)}, ${Math.round(obj.position.z)})</div>\n        `;\n        \n        item.onmouseover = () => {\n          item.style.borderColor = '#ec4899';\n          item.style.background = '#3a3a4e';\n        };\n        \n        item.onmouseout = () => {\n          item.style.borderColor = 'transparent';\n          item.style.background = '#2a2a3e';\n        };\n        \n        item.onclick = () => {\n          resolve({ selectedObjectId: obj.id, selectedObject: obj });\n          document.body.removeChild(modal);\n        };\n        \n        objectList.appendChild(item);\n      });\n      \n      container.appendChild(objectList);\n      \n      const cancelBtn = document.createElement('button');\n      cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';\n      cancelBtn.style.cssText = `\n        background: #666;\n        color: white;\n        border: none;\n        padding: 8px 16px;\n        border-radius: 6px;\n        cursor: pointer;\n        font-size: 14px;\n      `;\n      \n      cancelBtn.onclick = () => {\n        document.body.removeChild(modal);\n        reject(new Error('ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ'));\n      };\n      \n      container.appendChild(cancelBtn);\n      modal.appendChild(container);\n      document.body.appendChild(modal);\n      \n      return new Promise((resolve, reject) => {\n        // Promise handlers are set up in the click events above\n      });\n      \n    } catch (error) {\n      console.error('âŒ Object selection failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ä½œæˆ\n   */\n  createFallbackTexture(prompt) {\n    const canvas = document.createElement('canvas');\n    canvas.width = 512;\n    canvas.height = 512;\n    const ctx = canvas.getContext('2d');\n    \n    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ™ãƒ¼ã‚¹ã®è‰²ã‚’ç”Ÿæˆ\n    const hash = this.hashString(prompt);\n    const hue = hash % 360;\n    \n    // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯\n    const gradient = ctx.createLinearGradient(0, 0, 512, 512);\n    gradient.addColorStop(0, `hsl(${hue}, 70%, 60%)`);\n    gradient.addColorStop(1, `hsl(${(hue + 60) % 360}, 70%, 40%)`);\n    \n    ctx.fillStyle = gradient;\n    ctx.fillRect(0, 0, 512, 512);\n    \n    // ãƒ†ã‚­ã‚¹ãƒˆæç”»\n    ctx.fillStyle = 'white';\n    ctx.font = '24px Arial';\n    ctx.textAlign = 'center';\n    ctx.fillText('ğŸ¨', 256, 230);\n    \n    ctx.font = '16px Arial';\n    ctx.fillText(prompt.slice(0, 20), 256, 270);\n    \n    ctx.font = '14px Arial';\n    ctx.fillStyle = 'rgba(255,255,255,0.7)';\n    ctx.fillText('Placeholder Image', 256, 300);\n    \n    return new THREE.CanvasTexture(canvas);\n  }\n\n  /**\n   * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®å‹•ç”»ãƒ†ã‚¯ã‚¹ãƒãƒ£ä½œæˆ\n   */\n  createFallbackVideoTexture(prompt) {\n    const canvas = document.createElement('canvas');\n    canvas.width = 512;\n    canvas.height = 512;\n    const ctx = canvas.getContext('2d');\n    \n    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ™ãƒ¼ã‚¹ã®è‰²ã‚’ç”Ÿæˆ\n    const hash = this.hashString(prompt);\n    const hue = hash % 360;\n    \n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®å¤‰æ•°\n    let animationFrame = 0;\n    \n    const animate = () => {\n      // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ï¼ˆæ™‚é–“ã§å¤‰åŒ–ï¼‰\n      const gradient = ctx.createLinearGradient(0, 0, 512, 512);\n      const offset = (animationFrame * 2) % 360;\n      gradient.addColorStop(0, `hsl(${(hue + offset) % 360}, 70%, 60%)`);\n      gradient.addColorStop(1, `hsl(${(hue + offset + 60) % 360}, 70%, 40%)`);\n      \n      ctx.fillStyle = gradient;\n      ctx.fillRect(0, 0, 512, 512);\n      \n      // å‹•çš„ãƒ†ã‚­ã‚¹ãƒˆæç”»\n      ctx.fillStyle = 'white';\n      ctx.font = '24px Arial';\n      ctx.textAlign = 'center';\n      \n      // å‹•ç”»ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n      const icons = ['ğŸ¬', 'ğŸ¥', 'ğŸ“¹', 'ğŸï¸'];\n      const iconIndex = Math.floor(animationFrame / 10) % icons.length;\n      ctx.fillText(icons[iconIndex], 256, 230);\n      \n      ctx.font = '16px Arial';\n      ctx.fillText(prompt.slice(0, 20), 256, 270);\n      \n      ctx.font = '14px Arial';\n      ctx.fillStyle = 'rgba(255,255,255,0.7)';\n      ctx.fillText('Placeholder Video', 256, 300);\n      \n      animationFrame++;\n      \n      // 60FPSã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n      setTimeout(() => requestAnimationFrame(animate), 1000/60);\n    };\n    \n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹\n    animate();\n    \n    return new THREE.CanvasTexture(canvas);\n  }\n\n  /**\n   * æ–‡å­—åˆ—ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—\n   */\n  hashString(str) {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n      const char = str.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash; // 32bitæ•´æ•°ã«å¤‰æ›\n    }\n    return Math.abs(hash);\n  }\n\n  /**\n   * ç”Ÿæˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—\n   */\n  getSpawnedObjects() {\n    return Array.from(this.spawnedObjects.entries()).map(([id, object]) => ({\n      id,\n      name: object.name,\n      userData: object.userData,\n      position: object.position.clone()\n    }));\n  }\n\n  /**\n   * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤\n   */\n  removeObject(objectId) {\n    const object = this.spawnedObjects.get(objectId);\n    if (object) {\n      if (object.userData?.videoElement) {\n        const videoElement = object.userData.videoElement;\n        try {\n          videoElement.pause();\n          if (typeof videoElement.removeAttribute === 'function') {\n            videoElement.removeAttribute('src');\n          } else {\n            videoElement.src = '';\n          }\n          if (typeof videoElement.load === 'function') {\n            videoElement.load();\n          }\n        } catch (error) {\n          console.warn('ğŸ¬ Failed to release video element resources:', error);\n        }\n      }\n\n      if (object.userData?.objectUrl) {\n        try {\n          URL.revokeObjectURL(object.userData.objectUrl);\n        } catch (error) {\n          console.warn('ğŸ¬ Failed to revoke object URL:', error);\n        }\n      }\n\n      this.experimentGroup.remove(object);\n      this.spawnedObjects.delete(objectId);\n      \n      // ã‚¸ã‚ªãƒ¡ãƒˆãƒªã¨ãƒãƒ†ãƒªã‚¢ãƒ«ã®ãƒ¡ãƒ¢ãƒªè§£æ”¾\n      if (object.geometry) object.geometry.dispose();\n      if (object.material) {\n        const materials = Array.isArray(object.material) ? object.material : [object.material];\n        materials.forEach(mat => {\n          if (mat.map && typeof mat.map.dispose === 'function') {\n            mat.map.dispose();\n          }\n          mat.dispose();\n        });\n      }\n      \n      console.log(`ğŸ—‘ï¸ Removed object: ${objectId}`);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * å…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤\n   */\n  clearAll() {\n    const objectIds = Array.from(this.spawnedObjects.keys());\n    objectIds.forEach(id => this.removeObject(id));\n    console.log('ğŸ§¹ Cleared all experimental objects');\n  }\n\n  /**\n   * ã‚³ãƒãƒ³ãƒ‰å±¥æ­´å–å¾—\n   */\n  getCommandHistory() {\n    return [...this.commandHistory];\n  }\n\n  /**\n   * ç”Ÿæˆä½ç½®ã«ä¸€æ™‚çš„ãªè¦–è¦šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º\n   */\n  createLocationIndicator(relativePosition) {\n    // ç›®ç«‹ã¤å…‰ã‚‹çƒä½“ã‚’ä½œæˆ\n    const geometry = new THREE.SphereGeometry(1, 16, 16);\n    const material = new THREE.MeshBasicMaterial({\n      color: 0x00ff00,\n      transparent: true,\n      opacity: 0.9\n    });\n    \n    const indicator = new THREE.Mesh(geometry, material);\n    \n    // ã‚«ãƒ¡ãƒ©ç›¸å¯¾ä½ç½®ã§ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚‚é…ç½®\n    if (this.camera) {\n      const indicatorPos = this.calculateCameraRelativePosition({\n        x: relativePosition.x,\n        y: relativePosition.y + 2, // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å°‘ã—ä¸Šã«è¡¨ç¤º\n        z: relativePosition.z\n      });\n      indicator.position.copy(indicatorPos);\n    } else {\n      indicator.position.set(relativePosition.x, relativePosition.y + 2, relativePosition.z);\n    }\n    \n    console.log(`ğŸŸ¢ ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º: (${indicator.position.x.toFixed(1)}, ${indicator.position.y.toFixed(1)}, ${indicator.position.z.toFixed(1)})`);\n    \n    this.scene.add(indicator);\n    \n    // è¨­å®šã•ã‚ŒãŸæ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤\n    setTimeout(() => {\n      this.scene.remove(indicator);\n      geometry.dispose();\n      material.dispose();\n    }, this.config.indicatorDuration);\n    \n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç‚¹æ»…åŠ¹æœï¼‰\n    let opacity = 0.8;\n    let direction = -1;\n    const animate = () => {\n      opacity += direction * 0.05;\n      if (opacity <= 0.3) direction = 1;\n      if (opacity >= 0.8) direction = -1;\n      \n      material.opacity = opacity;\n      \n      if (indicator.parent) {\n        requestAnimationFrame(animate);\n      }\n    };\n    animate();\n  }\n\n  /**\n   * ã‚«ãƒ¡ãƒ©ç›¸å¯¾ä½ç½®è¨ˆç®—ï¼ˆç”»é¢åº§æ¨™å¯¾å¿œï¼‰\n   */\n  calculateCameraRelativePosition(relativePosition) {\n    if (!this.camera) {\n      if (this.config.enableDebugLogging) {\n        console.warn('ğŸ“· Camera not available, using fallback positioning');\n      }\n      return new THREE.Vector3(relativePosition.x, relativePosition.y, relativePosition.z);\n    }\n\n    try {\n      // ã‚«ãƒ¡ãƒ©ã®ä½ç½®ã¨æ–¹å‘ã‚’å–å¾—\n      const cameraPos = this.camera.position.clone();\n      const cameraDirection = new THREE.Vector3();\n      this.camera.getWorldDirection(cameraDirection);\n      \n      // ã‚«ãƒ¡ãƒ©ã®å³æ–¹å‘ã¨ä¸Šæ–¹å‘ã‚’è¨ˆç®—\n      const cameraRight = new THREE.Vector3();\n      const cameraUp = new THREE.Vector3(0, 1, 0); // ãƒ¯ãƒ¼ãƒ«ãƒ‰ã®ä¸Šæ–¹å‘\n      cameraRight.crossVectors(cameraDirection, cameraUp).normalize();\n      const cameraUpActual = new THREE.Vector3();\n      cameraUpActual.crossVectors(cameraRight, cameraDirection).normalize();\n\n      // ç›¸å¯¾ä½ç½®ã‚’ã‚«ãƒ¡ãƒ©åº§æ¨™ç³»ã§è¨ˆç®—\n      const finalPosition = cameraPos.clone();\n      \n      // å‰å¾Œæ–¹å‘ï¼ˆZè»¸ï¼‰: ã‚«ãƒ¡ãƒ©ã®å‘ãã«æ²¿ã£ã¦ï¼ˆæ­£ã®å€¤ã§å‰æ–¹ã€è² ã®å€¤ã§å¾Œæ–¹ï¼‰\n      finalPosition.add(cameraDirection.clone().multiplyScalar(relativePosition.z));\n      \n      // å·¦å³æ–¹å‘ï¼ˆXè»¸ï¼‰: ã‚«ãƒ¡ãƒ©ã®å³æ–¹å‘ã«æ²¿ã£ã¦\n      finalPosition.add(cameraRight.clone().multiplyScalar(relativePosition.x));\n      \n      // ä¸Šä¸‹æ–¹å‘ï¼ˆYè»¸ï¼‰: ã‚«ãƒ¡ãƒ©ã®ä¸Šæ–¹å‘ã«æ²¿ã£ã¦\n      finalPosition.add(cameraUpActual.clone().multiplyScalar(relativePosition.y));\n\n      this.logDebug(\n        `ğŸ“ Camera relative position calculated: (${finalPosition.x.toFixed(1)}, ${finalPosition.y.toFixed(1)}, ${finalPosition.z.toFixed(1)})`\n      );\n      return finalPosition;\n      \n    } catch (error) {\n      console.error('âŒ Camera relative position calculation failed:', error);\n      return new THREE.Vector3(relativePosition.x, relativePosition.y, relativePosition.z);\n    }\n  }\n\n  /**\n   * ã‚«ãƒ¡ãƒ©ã‚’è¨­å®š\n   */\n  alignPlaneToCamera(plane) {\n    if (!this.camera) {\n      return;\n    }\n\n    const forward = new THREE.Vector3();\n    this.camera.getWorldDirection(forward); // ã‚«ãƒ¡ãƒ©ã®å‰æ–¹å‘ï¼ˆå‰æ–¹ãŒè² Zï¼‰\n    forward.negate(); // å¹³é¢ã®æ³•ç·šã‚’ã‚«ãƒ¡ãƒ©å´ã¸å‘ã‘ã‚‹\n\n    let up = new THREE.Vector3().copy(this.camera.up).applyQuaternion(this.camera.quaternion).normalize();\n    if (Math.abs(forward.dot(up)) > 0.999) {\n      up = new THREE.Vector3(0, 1, 0);\n      if (Math.abs(forward.dot(up)) > 0.999) {\n        up = new THREE.Vector3(0, 0, 1);\n      }\n    }\n\n    const right = new THREE.Vector3().crossVectors(up, forward).normalize();\n    up = new THREE.Vector3().crossVectors(forward, right).normalize();\n\n    const orientation = new THREE.Matrix4();\n    orientation.makeBasis(right, up, forward);\n    plane.quaternion.setFromRotationMatrix(orientation);\n  }\n\n  /**\n   * ã‚«ãƒ¡ãƒ©ã‚’è¨­å®š\n   */\n  setCamera(camera) {\n    this.camera = camera;\n  }\n\n  /**\n   * è¨­å®šã‚’æ›´æ–°\n   */\n  updateConfig(newConfig) {\n    this.config = { ...this.config, ...newConfig };\n  }\n\n  setImageService(serviceId) {\n    this.selectedImageService = serviceId || null;\n    this.logDebug('ğŸ¯ Updated image service:', this.selectedImageService);\n  }\n\n  getImageService() {\n    return this.selectedImageService;\n  }\n\n  setVideoService(serviceId) {\n    this.selectedVideoService = serviceId || null;\n    this.logDebug('ğŸ¬ Updated video service:', this.selectedVideoService);\n  }\n\n  getVideoService() {\n    return this.selectedVideoService;\n  }\n\n\n\n\n\n  /**\n   * éŸ³å£°åˆ¶å¾¡UIã‚’ä½œæˆ\n   */\n  createAudioControl(videoObject) {\n    const videoElement = videoObject.userData.videoElement;\n    if (!videoElement) return;\n\n    // éŸ³å£°åˆ¶å¾¡ãƒœã‚¿ãƒ³ã‚’ä½œæˆ\n    const audioButton = document.createElement('div');\n    audioButton.className = 'chocodrop-audio-control';\n    audioButton.innerHTML = 'â™ª'; // åˆæœŸçŠ¶æ…‹ï¼šéŸ³æ¥½è¨˜å·\n    // ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’ä½œæˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã«åˆã‚ã›ã¦ï¼‰\n    const createTooltip = () => {\n      const tooltip = document.createElement('div');\n      tooltip.className = 'chocodrop-audio-tooltip';\n      tooltip.textContent = 'éŸ³å£°ã®ã‚ªãƒ³/ã‚ªãƒ•åˆ‡ã‚Šæ›¿ãˆ';\n      tooltip.style.cssText = `\n        position: absolute !important;\n        background: rgba(0, 0, 0, 0.85) !important;\n        backdrop-filter: blur(12px) !important;\n        -webkit-backdrop-filter: blur(12px) !important;\n        border: 1px solid rgba(255, 255, 255, 0.15) !important;\n        border-radius: 8px !important;\n        padding: 8px 12px !important;\n        color: white !important;\n        font-size: 11px !important;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;\n        font-weight: 500 !important;\n        white-space: nowrap !important;\n        pointer-events: none !important;\n        z-index: 1000000 !important;\n        opacity: 0 !important;\n        transform: translateY(-100%) translateX(-50%) !important;\n        transition: opacity 0.2s ease !important;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;\n        margin-bottom: 8px !important;\n      `;\n      return tooltip;\n    };\n\n    const tooltip = createTooltip();\n    document.body.appendChild(tooltip);\n\n    // ç¸¦å‹éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ä½œæˆ\n    const createVolumeSlider = () => {\n      const sliderContainer = document.createElement('div');\n      sliderContainer.className = 'chocodrop-volume-slider';\n      sliderContainer.style.cssText = `\n        position: absolute !important;\n        width: 30px !important;\n        height: 100px !important;\n        background: rgba(0, 0, 0, 0.85) !important;\n        backdrop-filter: blur(12px) !important;\n        -webkit-backdrop-filter: blur(12px) !important;\n        border: 1px solid rgba(255, 255, 255, 0.15) !important;\n        border-radius: 15px !important;\n        padding: 10px 8px !important;\n        z-index: 1000001 !important;\n        opacity: 0 !important;\n        pointer-events: none !important;\n        transition: opacity 0.2s ease !important;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;\n        display: flex !important;\n        flex-direction: column !important;\n        align-items: center !important;\n        justify-content: center !important;\n      `;\n\n      const slider = document.createElement('input');\n      slider.type = 'range';\n      slider.min = '0';\n      slider.max = '100';\n      slider.value = '100';\n      slider.style.cssText = `\n        width: 80px !important;\n        height: 12px !important;\n        background: rgba(255, 255, 255, 0.2) !important;\n        border-radius: 6px !important;\n        outline: none !important;\n        cursor: pointer !important;\n        -webkit-appearance: none !important;\n        appearance: none !important;\n        transform: rotate(-90deg) !important;\n        transform-origin: center !important;\n      `;\n\n      // WebKitç”¨ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«\n      const style = document.createElement('style');\n      style.textContent = `\n        .chocodrop-volume-slider input[type=\"range\"]::-webkit-slider-track {\n          width: 6px;\n          height: 80px;\n          background: rgba(255, 255, 255, 0.2);\n          border-radius: 3px;\n        }\n        .chocodrop-volume-slider input[type=\"range\"]::-webkit-slider-thumb {\n          -webkit-appearance: none;\n          width: 14px;\n          height: 14px;\n          background: white;\n          border-radius: 50%;\n          cursor: pointer;\n          box-shadow: 0 2px 6px rgba(0,0,0,0.3);\n        }\n        .chocodrop-volume-slider input[type=\"range\"]::-moz-range-track {\n          width: 6px;\n          height: 80px;\n          background: rgba(255, 255, 255, 0.2);\n          border-radius: 3px;\n          border: none;\n        }\n        .chocodrop-volume-slider input[type=\"range\"]::-moz-range-thumb {\n          width: 14px;\n          height: 14px;\n          background: white;\n          border-radius: 50%;\n          cursor: pointer;\n          border: none;\n          box-shadow: 0 2px 6px rgba(0,0,0,0.3);\n        }\n      `;\n      document.head.appendChild(style);\n\n      // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º\n      slider.addEventListener('input', (e) => {\n        const value = e.target.value;\n        videoElement.volume = value / 100;\n\n        // ã‚¢ã‚¤ã‚³ãƒ³ã‚’éŸ³é‡ã«å¿œã˜ã¦å¤‰æ›´\n        if (value == 0) {\n          audioButton.innerHTML = '<span style=\"position: relative;\">â™ª<span style=\"position: absolute; top: 0; left: 0; color: #8b5cf6; font-size: 14px;\">âƒ </span></span>';\n          audioButton.style.background = 'rgba(99, 102, 241, 0.6) !important';\n          audioButton.title = 'ãƒŸãƒ¥ãƒ¼ãƒˆä¸­';\n        } else {\n          audioButton.innerHTML = 'â™ª';\n          audioButton.style.background = 'rgba(0, 0, 0, 0.4) !important';\n          audioButton.style.color = 'white !important';\n          audioButton.title = 'éŸ³å£°ON';\n        }\n      });\n\n      sliderContainer.appendChild(slider);\n      return sliderContainer;\n    };\n\n    const volumeSlider = createVolumeSlider();\n    document.body.appendChild(volumeSlider);\n\n    audioButton.style.cssText = `\n      position: absolute !important;\n      width: 18px !important;\n      height: 18px !important;\n      background: rgba(0, 0, 0, 0.4) !important;\n      border: 1px solid rgba(255, 255, 255, 0.3) !important;\n      border-radius: 50% !important;\n      color: white !important;\n      font-size: 9px !important;\n      cursor: pointer !important;\n      display: flex !important;\n      align-items: center !important;\n      justify-content: center !important;\n      z-index: 999999 !important;\n      transition: all 0.2s ease !important;\n      user-select: none !important;\n      box-shadow: 0 1px 4px rgba(0,0,0,0.2) !important;\n      backdrop-filter: blur(8px) !important;\n      pointer-events: auto !important;\n      opacity: 1 !important;\n    `;\n\n    let isSliderVisible = false;\n\n    // ãƒ›ãƒãƒ¼åŠ¹æœã¨ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤º\n    audioButton.addEventListener('mouseenter', () => {\n      audioButton.style.background = 'rgba(0, 0, 0, 0.7)';\n      audioButton.style.transform = 'scale(1.05)';\n      audioButton.style.borderColor = 'rgba(255, 255, 255, 0.5)';\n\n      if (!isSliderVisible) {\n        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¡¨ç¤º\n        const buttonRect = audioButton.getBoundingClientRect();\n        tooltip.style.left = `${buttonRect.left + buttonRect.width / 2}px`;\n        tooltip.style.top = `${buttonRect.top - 8}px`;\n        tooltip.style.opacity = '1';\n      }\n    });\n\n    audioButton.addEventListener('mouseleave', () => {\n      audioButton.style.background = 'rgba(0, 0, 0, 0.5)';\n      audioButton.style.transform = 'scale(1.0)';\n      audioButton.style.borderColor = 'rgba(255, 255, 255, 0.4)';\n\n      // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’éè¡¨ç¤º\n      tooltip.style.opacity = '0';\n    });\n\n    // å·¦ã‚¯ãƒªãƒƒã‚¯ï¼šãƒŸãƒ¥ãƒ¼ãƒˆã®ã‚ªãƒ³/ã‚ªãƒ•åˆ‡ã‚Šæ›¿ãˆ\n    audioButton.addEventListener('click', (e) => {\n      e.stopPropagation();\n\n      // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹\n      if (isSliderVisible) {\n        isSliderVisible = false;\n        volumeSlider.style.opacity = '0';\n        volumeSlider.style.pointerEvents = 'none';\n        return;\n      }\n\n      // ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ\n      if (videoElement.muted || videoElement.volume === 0) {\n        videoElement.muted = false;\n        videoElement.volume = volumeSlider.querySelector('input').value / 100;\n        audioButton.innerHTML = 'â™ª';\n        audioButton.style.background = 'rgba(0, 0, 0, 0.4) !important';\n        audioButton.style.color = 'white !important';\n        audioButton.title = 'éŸ³å£°ON';\n      } else {\n        videoElement.muted = true;\n        audioButton.innerHTML = '<span style=\"position: relative;\">â™ª<span style=\"position: absolute; top: 0; left: 0; color: #8b5cf6; font-size: 14px;\">âƒ </span></span>';\n        audioButton.style.background = 'rgba(99, 102, 241, 0.6) !important';\n        audioButton.title = 'ãƒŸãƒ¥ãƒ¼ãƒˆä¸­';\n      }\n    });\n\n    // å³ã‚¯ãƒªãƒƒã‚¯ï¼šéŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ\n    audioButton.addEventListener('contextmenu', (e) => {\n      e.preventDefault();\n      e.stopPropagation();\n\n      isSliderVisible = !isSliderVisible;\n\n      if (isSliderVisible) {\n        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’è¡¨ç¤º\n        const buttonRect = audioButton.getBoundingClientRect();\n        volumeSlider.style.left = `${buttonRect.left + buttonRect.width / 2 - 15}px`;\n        volumeSlider.style.top = `${buttonRect.top - 110}px`;\n        volumeSlider.style.opacity = '1';\n        volumeSlider.style.pointerEvents = 'auto';\n\n        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’éè¡¨ç¤º\n        tooltip.style.opacity = '0';\n      } else {\n        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’éè¡¨ç¤º\n        volumeSlider.style.opacity = '0';\n        volumeSlider.style.pointerEvents = 'none';\n      }\n    });\n\n    // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’é–‰ã˜ã‚‹\n    document.addEventListener('click', (e) => {\n      if (isSliderVisible && !audioButton.contains(e.target) && !volumeSlider.contains(e.target)) {\n        isSliderVisible = false;\n        volumeSlider.style.opacity = '0';\n        volumeSlider.style.pointerEvents = 'none';\n      }\n    });\n\n    // ãƒšãƒ¼ã‚¸ã«è¿½åŠ \n    document.body.appendChild(audioButton);\n\n    // éŸ³é‡ãƒœã‚¿ãƒ³ã¯å¸¸æ™‚è¡¨ç¤ºï¼ˆéè¡¨ç¤ºæ©Ÿèƒ½ã‚’å‰Šé™¤ï¼‰\n\n    // å‹•ç”»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«éŸ³å£°åˆ¶å¾¡ãƒœã‚¿ãƒ³ã‚’é–¢é€£ä»˜ã‘\n    videoObject.userData.audioControlElement = audioButton;\n\n    // ä½ç½®æ›´æ–°é–¢æ•°ã‚’ä¿å­˜\n    videoObject.userData.updateAudioControlPosition = () => {\n      this.updateAudioControlPosition(videoObject, audioButton);\n    };\n\n    // åˆæœŸä½ç½®è¨­å®š\n    this.updateAudioControlPosition(videoObject, audioButton);\n\n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ã§ä½ç½®ã‚’æ›´æ–°\n    if (!this.audioControlUpdateInterval) {\n      this.audioControlUpdateInterval = setInterval(() => {\n        this.spawnedObjects.forEach(obj => {\n          if (obj.userData.updateAudioControlPosition) {\n            obj.userData.updateAudioControlPosition();\n          }\n        });\n      }, 100); // 100msã”ã¨ã«æ›´æ–°\n    }\n\n    // å‹•ç”»ãŒå‰Šé™¤ã•ã‚ŒãŸã¨ãã«ãƒœã‚¿ãƒ³ã‚‚å‰Šé™¤\n    videoObject.userData.cleanupCallbacks = videoObject.userData.cleanupCallbacks || [];\n    videoObject.userData.cleanupCallbacks.push(() => {\n      if (audioButton.parentNode) {\n        audioButton.parentNode.removeChild(audioButton);\n      }\n    });\n\n    console.log('ğŸ”Š Audio control created for video:', videoObject.userData.id);\n  }\n\n  /**\n   * éŸ³å£°åˆ¶å¾¡ãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’å‹•ç”»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦æ›´æ–°\n   */\n  updateAudioControlPosition(videoObject, audioButton) {\n    if (!this.camera || !this.renderer || !audioButton.parentNode) return;\n\n    // å‹•ç”»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®3Dåº§æ¨™ã‚’ç”»é¢åº§æ¨™ã«å¤‰æ›\n    const vector = new THREE.Vector3();\n    videoObject.getWorldPosition(vector);\n    vector.project(this.camera);\n\n    // ç”»é¢åº§æ¨™ã«å¤‰æ›\n    const canvas = this.renderer.domElement;\n    const rect = canvas.getBoundingClientRect();\n\n    const x = (vector.x * 0.5 + 0.5) * rect.width + rect.left;\n    const y = -(vector.y * 0.5 - 0.5) * rect.height + rect.top;\n\n    // å‹•ç”»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å³ä¸Šã«ãƒœã‚¿ãƒ³ã‚’é…ç½®\n    const geometry = videoObject.geometry;\n    if (geometry && geometry.parameters) {\n      const width = geometry.parameters.width * videoObject.scale.x;\n      const offsetX = 150; // å‹•ç”»ã®å³å´ã«å›ºå®šè·é›¢\n      const offsetY = -50; // å‹•ç”»ã®ä¸Šå´ã«å›ºå®šè·é›¢\n\n      audioButton.style.left = `${x + offsetX}px`;\n      audioButton.style.top = `${y + offsetY}px`;\n    } else {\n      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å‹•ç”»ä¸­å¿ƒã®å³ä¸Š\n      audioButton.style.left = `${x + 50}px`;\n      audioButton.style.top = `${y - 20}px`;\n    }\n  }\n\n  /**\n   * å‹•ç”»éŸ³å£°ã®å†ç”Ÿ/åœæ­¢ã‚’åˆ‡ã‚Šæ›¿ãˆ\n   */\n  toggleVideoAudio(videoObject, audioButton) {\n    const videoElement = videoObject.userData.videoElement;\n    if (!videoElement) return;\n\n    if (videoElement.muted) {\n      // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤ï¼šéŸ³å£°å†ç”Ÿ\n      videoElement.muted = false;\n      audioButton.innerHTML = 'ğŸ”ˆ'; // éŸ³å£°å†ç”Ÿä¸­ãƒãƒ¼ã‚¯\n      console.log('ğŸ”Š Audio enabled for video:', videoObject.userData.id);\n    } else {\n      // ãƒŸãƒ¥ãƒ¼ãƒˆï¼šéŸ³å£°åœæ­¢\n      videoElement.muted = true;\n      audioButton.innerHTML = 'ğŸ”Š'; // éŸ³å£°ã‚ã‚Šãƒãƒ¼ã‚¯\n      console.log('ğŸ”‡ Audio muted for video:', videoObject.userData.id);\n    }\n  }\n\n  /**\n   * CSS2DRendereråˆæœŸåŒ–ï¼ˆéŸ³å£°åˆ¶å¾¡UIãªã©ã®è¡¨ç¤ºã«å¿…è¦ï¼‰\n   */\n  initializeLabelRenderer() {\n    if (this.labelRenderer) {\n      return; // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿\n    }\n\n    // CSS2DRendererã‚’å‹•çš„ã«èª­ã¿è¾¼ã‚“ã§åˆæœŸåŒ–\n    this.loadAndInitializeCSS2DRenderer();\n  }\n\n  /**\n   * CSS2DRendererã®æº–å‚™å®Œäº†ã‚’ä¿è¨¼\n   */\n  async ensureCSS2DRenderer() {\n    if (this.labelRenderer) {\n      return; // æ—¢ã«æº–å‚™å®Œäº†\n    }\n\n    // åˆæœŸåŒ–å‡¦ç†ãŒã¾ã ã®å ´åˆã¯é–‹å§‹\n    if (!this.css2dInitPromise) {\n      this.css2dInitPromise = this.loadAndInitializeCSS2DRenderer();\n    }\n\n    // åˆæœŸåŒ–å®Œäº†ã¾ã§å¾…æ©Ÿ\n    await this.css2dInitPromise;\n  }\n\n  /**\n   * CSS2DRendererã®å‹•çš„èª­ã¿è¾¼ã¿ã¨åˆæœŸåŒ–\n   */\n  async loadAndInitializeCSS2DRenderer() {\n    try {\n      // CSS2DRendererãŒæ—¢ã«åˆ©ç”¨å¯èƒ½ãªå ´åˆ\n      if (window.THREE && window.THREE.CSS2DRenderer) {\n        this.setupCSS2DRenderer();\n        return;\n      }\n\n      // Three.jsã®CSS2DRendererã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿\n      console.log('ğŸ·ï¸ Loading CSS2DRenderer dynamically...');\n\n      // CDNã‹ã‚‰CSS2DRendererã‚’èª­ã¿è¾¼ã¿\n      const module = await import('https://cdn.skypack.dev/three@0.158.0/examples/jsm/renderers/CSS2DRenderer.js');\n\n      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®š\n      if (!window.THREE) window.THREE = {};\n      window.THREE.CSS2DRenderer = module.CSS2DRenderer;\n      window.THREE.CSS2DObject = module.CSS2DObject;\n\n      console.log('âœ… CSS2DRenderer loaded successfully');\n      this.setupCSS2DRenderer();\n\n    } catch (error) {\n      console.warn('âš ï¸ Failed to load CSS2DRenderer:', error);\n      console.warn('ğŸ”§ Audio controls will not be visible. Please include CSS2DRenderer in your project.');\n    }\n  }\n\n  /**\n   * CSS2DRendererã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—\n   */\n  setupCSS2DRenderer() {\n    try {\n      this.labelRenderer = new window.THREE.CSS2DRenderer();\n      this.labelRenderer.setSize(window.innerWidth, window.innerHeight);\n      this.labelRenderer.domElement.style.position = 'absolute';\n      this.labelRenderer.domElement.style.top = '0px';\n      this.labelRenderer.domElement.style.pointerEvents = 'none';\n\n      // ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ \n      if (this.renderer && this.renderer.domElement.parentNode) {\n        this.renderer.domElement.parentNode.appendChild(this.labelRenderer.domElement);\n      } else {\n        document.body.appendChild(this.labelRenderer.domElement);\n      }\n\n      console.log('ğŸ·ï¸ CSS2DRenderer initialized for UI overlays');\n\n      // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ \n      this.addLabelRendererResizeHandler();\n\n    } catch (error) {\n      console.warn('âš ï¸ Failed to setup CSS2DRenderer:', error);\n    }\n  }\n\n  /**\n   * CSS2DRendererã®ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¿½åŠ \n   */\n  addLabelRendererResizeHandler() {\n    if (!this.labelRendererResizeHandler) {\n      this.labelRendererResizeHandler = () => {\n        if (this.labelRenderer) {\n          this.labelRenderer.setSize(window.innerWidth, window.innerHeight);\n        }\n      };\n      window.addEventListener('resize', this.labelRendererResizeHandler);\n    }\n  }\n\n  /**\n   * ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ›´æ–°ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ã§å‘¼ã³å‡ºã—ï¼‰\n   */\n  updateRenderer() {\n    if (this.labelRenderer && this.scene && this.camera) {\n      this.labelRenderer.render(this.scene, this.camera);\n    }\n  }\n\n  logDebug(...args) {\n    if (!this.config.enableDebugLogging) {\n      return;\n    }\n    console.log(...args);\n  }\n\n  /**\n   * 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–é¸æŠã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è‰²è¨ˆç®—\n   * èƒŒæ™¯è‰²ã‚’è‡ªå‹•æ¤œå‡ºã—ã¦WCAG 2025åŸºæº–ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆæ¯”ã‚’ä¿è¨¼\n   */\n  getAdaptiveSelectionColor() {\n    // ã‚·ãƒ¼ãƒ³ã®èƒŒæ™¯è‰²ã‚’å–å¾—\n    const backgroundColor = this.scene.background;\n    let bgColor = { r: 0.5, g: 0.5, b: 0.5 }; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¸­é–“è‰²\n    \n    if (backgroundColor) {\n      if (backgroundColor.isColor) {\n        bgColor = {\n          r: backgroundColor.r,\n          g: backgroundColor.g,\n          b: backgroundColor.b\n        };\n      }\n    }\n    \n    // æ˜åº¦è¨ˆç®—ï¼ˆç›¸å¯¾è¼åº¦ï¼‰\n    const getLuminance = (color) => {\n      const { r, g, b } = color;\n      const rs = r <= 0.03928 ? r / 12.92 : Math.pow((r + 0.055) / 1.055, 2.4);\n      const gs = g <= 0.03928 ? g / 12.92 : Math.pow((g + 0.055) / 1.055, 2.4);\n      const bs = b <= 0.03928 ? b / 12.92 : Math.pow((b + 0.055) / 1.055, 2.4);\n      return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;\n    };\n    \n    const bgLuminance = getLuminance(bgColor);\n    \n    // WCAG 2025æº–æ‹ : 4.5:1ä»¥ä¸Šã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆæ¯”ã‚’ç¢ºä¿\n    // èƒŒæ™¯ãŒæš—ã„å ´åˆã¯æ˜ã‚‹ã„è‰²ã€æ˜ã‚‹ã„å ´åˆã¯æš—ã„è‰²ã‚’é¸æŠ\n    if (bgLuminance < 0.5) {\n      // æš—ã„èƒŒæ™¯: æ˜ã‚‹ã„ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè‰²\n      return 0x00ff88; // æ˜ã‚‹ã„ãƒ†ã‚£ãƒ¼ãƒ«\n    } else {\n      // æ˜ã‚‹ã„èƒŒæ™¯: æš—ã„ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè‰²  \n      return 0x1a1a2e; // ãƒ€ãƒ¼ã‚¯ãƒã‚¤ãƒ“ãƒ¼\n    }\n  }\n  \n  /**\n   * ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–ãƒ›ãƒãƒ¼è‰²è¨ˆç®—\n   */\n  getAdaptiveHoverColor() {\n    const backgroundColor = this.scene.background;\n    let bgColor = { r: 0.5, g: 0.5, b: 0.5 };\n    \n    if (backgroundColor && backgroundColor.isColor) {\n      bgColor = {\n        r: backgroundColor.r,\n        g: backgroundColor.g,\n        b: backgroundColor.b\n      };\n    }\n    \n    const getLuminance = (color) => {\n      const { r, g, b } = color;\n      const rs = r <= 0.03928 ? r / 12.92 : Math.pow((r + 0.055) / 1.055, 2.4);\n      const gs = g <= 0.03928 ? g / 12.92 : Math.pow((g + 0.055) / 1.055, 2.4);\n      const bs = b <= 0.03928 ? b / 12.92 : Math.pow((b + 0.055) / 1.055, 2.4);\n      return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;\n    };\n    \n    const bgLuminance = getLuminance(bgColor);\n    \n    if (bgLuminance < 0.5) {\n      // æš—ã„èƒŒæ™¯: ã‚ˆã‚Šæ˜ã‚‹ã„ãƒ›ãƒãƒ¼è‰²\n      return 0x00ffff; // ã‚·ã‚¢ãƒ³\n    } else {\n      // æ˜ã‚‹ã„èƒŒæ™¯: ã‚ˆã‚Šæš—ã„ãƒ›ãƒãƒ¼è‰²\n      return 0xff3366; // ãƒ€ãƒ¼ã‚¯ãƒ”ãƒ³ã‚¯\n    }\n  }\n\n  /**\n   * ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n   */\n  dispose() {\n    this.clearAll();\n    if (this.experimentGroup.parent) {\n      this.experimentGroup.parent.remove(this.experimentGroup);\n    }\n  }\n}\n","const IMAGE_SERVICE_STORAGE_KEY = 'chocodrop-service-image';\nconst VIDEO_SERVICE_STORAGE_KEY = 'chocodrop-service-video';\n\n/**\n * Command UI Demo - Demo version with restricted functionality\n * For GitHub Pages demo - import functionality only\n */\nexport class CommandUIDemo {\n  constructor(options = {}) {\n    this.sceneManager = options.sceneManager || null;\n    this.client = options.client || null;\n    this.onControlsToggle = options.onControlsToggle || (() => {});\n    \n    this.isVisible = false;\n    this.container = null;\n    this.input = null;\n    this.output = null;\n    this.currentMode = 'generate';\n\n    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—ç®¡ç†\n    this.activeConnections = new Map();\n    this.currentTaskId = null;\n    \n    // è¨­å®š\n    this.config = {\n      activationKey: options.activationKey || '@',\n      position: options.position || 'bottom-right',\n      width: options.width || 450,\n      maxHeight: options.maxHeight || 600,\n      theme: options.theme || 'dark',\n      showExamples: options.showExamples !== false,\n      autoScroll: options.autoScroll !== false,\n      enableDebugLogging: options.enableDebugLogging === true,\n      ...options.config\n    };\n\n    this.availableImageServices = [];\n    this.availableVideoServices = [];\n    this.selectedImageService = null;\n    this.selectedVideoService = null;\n    this.imageServiceSelect = null;\n    this.videoServiceSelect = null;\n    this.serviceSelectorContainer = null;\n    this.serviceSelectorStatus = null;\n    this.serviceSelectorContent = null;\n    this.serviceSelectorRetryButton = null;\n    this.serviceSelectorSaveButton = null;\n    this.serviceSelectorCancelButton = null;\n    this.serviceModalOverlay = null;\n    this.serviceModal = null;\n    this.servicesLoading = false;\n    this.isExpanded = false;\n    this.overlayTextarea = null;\n    this.pendingImageService = null;\n    this.pendingVideoService = null;\n\n    try {\n      const storedImage = localStorage.getItem(IMAGE_SERVICE_STORAGE_KEY);\n      const storedVideo = localStorage.getItem(VIDEO_SERVICE_STORAGE_KEY);\n      if (storedImage) {\n        this.selectedImageService = storedImage;\n      }\n      if (storedVideo) {\n        this.selectedVideoService = storedVideo;\n      }\n    } catch (error) {\n      console.warn('âš ï¸ Failed to load stored service selections:', error);\n    }\n\n    this.pendingImageService = this.selectedImageService;\n    this.pendingVideoService = this.selectedVideoService;\n\n    this.applyServiceSelectionToSceneManager();\n\n    // ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ç®¡ç† (light, dark, wabisabi)\n    this.currentTheme = localStorage.getItem('live-command-theme') || 'light';\n    this.isDarkMode = this.currentTheme === 'dark';\n    this.isWabiSabiMode = this.currentTheme === 'wabisabi';\n    \n    // Undo/Redo ã‚·ã‚¹ãƒ†ãƒ \n    this.commandHistory = [];\n    this.currentHistoryIndex = -1;\n    this.maxHistorySize = 50; // æœ€å¤§ã‚³ãƒãƒ³ãƒ‰ä¿å­˜æ•°\n    \n    this.initUI();\n    this.bindEvents();\n\n    if (!this.client && this.sceneManager && this.sceneManager.client) {\n      this.client = this.sceneManager.client;\n    }\n\n    this.createServiceModal();\n    this.createFloatingChocolateIcon();\n\n    // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¢ºå®Ÿã«é©ç”¨\n    document.addEventListener('DOMContentLoaded', () => {\n      this.refreshStyles();\n    });\n\n    this.logDebug('ğŸ® CommandUI initialized');\n\n    if (!this.selectedImageService || !this.selectedVideoService) {\n      this.openServiceModal(true);\n    }\n  }\n\n  logDebug(...args) {\n    if (!this.config.enableDebugLogging) {\n      return;\n    }\n    console.log(...args);\n  }\n\n  /**\n   * ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸ç”¨ã®ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º\n   */\n  showDemoMessage() {\n    this.showCompactToast('ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸ã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“');\n  }\n\n  /**\n   * ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º\n   */\n  showCompactToast(message) {\n    // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¹ãƒˆãŒã‚ã‚Œã°å‰Šé™¤\n    const existingToast = document.getElementById('demo-toast');\n    if (existingToast) {\n      existingToast.remove();\n    }\n\n    // ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®ä½ç½®ã‚’å–å¾—\n    const buttonContainer = this.radioModeContainer;\n    if (!buttonContainer) return;\n\n    const toast = document.createElement('div');\n    toast.id = 'demo-toast';\n    toast.textContent = message;\n    toast.style.cssText = `\n      position: absolute;\n      top: -35px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: ${this.isDarkMode ? 'rgba(139, 92, 246, 0.9)' : 'rgba(139, 92, 246, 0.85)'};\n      color: white;\n      padding: 6px 12px;\n      border-radius: 6px;\n      font-size: 12px;\n      font-weight: 500;\n      white-space: nowrap;\n      z-index: 1000;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);\n    `;\n\n    // ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã«ç›¸å¯¾é…ç½®\n    buttonContainer.style.position = 'relative';\n    buttonContainer.appendChild(toast);\n\n    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³\n    setTimeout(() => {\n      toast.style.opacity = '1';\n    }, 10);\n\n    // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤\n    setTimeout(() => {\n      if (toast.parentNode) {\n        toast.style.opacity = '0';\n        setTimeout(() => {\n          if (toast.parentNode) {\n            toast.remove();\n          }\n        }, 300);\n      }\n    }, 3000);\n  }\n\n  /**\n   * UIè¦ç´ ã®ä½œæˆã¨é…ç½®\n   */\n  initUI() {\n    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ\n    this.container = document.createElement('div');\n    this.container.id = 'live-command-ui';\n    this.container.style.cssText = this.getContainerStyles();\n\n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šProgressive Disclosureï¼ˆãƒ›ãƒãƒ¼æ™‚ã®ã¿ãƒ–ãƒ©ãƒ³ãƒ‰è¡¨ç¤ºï¼‰\n    const brandIndicator = document.createElement('div');\n    brandIndicator.className = 'progressive-brand-indicator';\n    brandIndicator.style.cssText = `\n      position: absolute;\n      top: -8px;\n      right: 8px;\n      width: 8px;\n      height: 8px;\n      background: linear-gradient(135deg, #6366f1, #8b5cf6);\n      border-radius: 50%;\n      opacity: 0.7;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      z-index: 10;\n      cursor: pointer;\n    `;\n    \n    // Progressive Disclosure: ãƒ›ãƒãƒ¼/ã‚¯ãƒªãƒƒã‚¯ã§ãƒ–ãƒ©ãƒ³ãƒ‰åè¡¨ç¤º\n    const brandText = document.createElement('div');\n    brandText.className = 'progressive-brand-text';\n    brandText.style.cssText = `\n      position: absolute;\n      top: -35px;\n      right: -5px;\n      padding: 6px 12px;\n      background: rgba(255, 255, 255, 0.15);\n      border: 1px solid ${this.isDarkMode ? 'rgba(129, 140, 248, 0.3)' : 'rgba(99, 102, 241, 0.25)'};\n      border-radius: 12px;\n      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);\n      color: ${this.isWabiSabiMode ? '#F5F5F5' : (this.isDarkMode ? '#ffffff' : '#1f2937')};\n      font-size: 11px;\n      font-weight: 700;\n      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      letter-spacing: 0.02em;\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      opacity: 0;\n      transform: translateY(5px) scale(0.9);\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      pointer-events: none;\n      z-index: 11;\n      white-space: nowrap;\n    `;\n    brandText.innerHTML = '<span style=\"filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);\">ğŸ«</span> <span style=\"color: #6366f1;\">ChocoDrop</span>';\n    \n    // Progressive Disclosure ã‚¤ãƒ™ãƒ³ãƒˆ\n    brandIndicator.addEventListener('mouseenter', () => {\n      brandText.style.opacity = '1';\n      brandText.style.transform = 'translateY(0) scale(1)';\n      brandIndicator.style.transform = 'scale(1.2)';\n      brandIndicator.style.opacity = '1';\n    });\n    \n    brandIndicator.addEventListener('mouseleave', () => {\n      brandText.style.opacity = '0';\n      brandText.style.transform = 'translateY(5px) scale(0.9)';\n      brandIndicator.style.transform = 'scale(1)';\n      brandIndicator.style.opacity = '0.7';\n    });\n    \n    brandIndicator.appendChild(brandText);\n    this.container.appendChild(brandIndicator);\n\n    // å‡ºåŠ›ã‚¨ãƒªã‚¢ï¼ˆã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠï¼‰- éè¡¨ç¤ºã«å¤‰æ›´\n    this.output = document.createElement('div');\n    this.outputDiv = this.output; // ä¸¡æ–¹ã®å‚ç…§ã‚’ä¿æŒï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰\n    this.output.id = 'command-output';\n    this.output.className = 'command-output';\n    this.output.style.cssText = this.getOutputStyles();\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ç”¨ã‚³ãƒ³ãƒ†ãƒŠ\n    this.floatingContainer = document.createElement('div');\n    this.floatingContainer.id = 'floating-cards-container';\n    this.floatingContainer.style.cssText = `\n      position: fixed;\n      top: var(--floating-top, 20px);\n      left: 50%;\n      transform: translateX(-50%);\n      z-index: 99999;\n      pointer-events: none;\n      display: none;\n      flex-direction: column-reverse;\n      gap: 8px;\n      width: 400px;\n      max-width: 90vw;\n      align-items: center;\n      justify-content: flex-end;\n    `;\n\n    // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ç®¡ç†ç”¨\n    this.taskCards = new Map();\n\n    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆå±•é–‹ãƒœã‚¿ãƒ³ç”¨ï¼‰\n    this.inputWrapper = document.createElement('div');\n    this.inputWrapper.style.cssText = `\n      position: relative;\n      width: 100%;\n      margin-bottom: 0;\n    `;\n\n    // Ultra-Simple å˜ä¸€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆè‡ªå‹•ãƒªã‚µã‚¤ã‚ºå¯¾å¿œï¼‰\n    this.input = document.createElement('textarea');\n    this.input.rows = 1;\n    this.input.id = 'command-input';\n    this.input.placeholder = 'ã€Œå³ä¸Šã«ãƒ‰ãƒ©ã‚´ãƒ³ã‚’ã€ã€Œç¾ã—ã„æ¡œã®æ£®ã‚’ä¸­å¤®ã«ã€ãªã©... âœ¨';\n    this.input.style.cssText = this.getInputStyles();\n\n    // å±•é–‹ãƒœã‚¿ãƒ³ï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰\n    this.expandButton = document.createElement('div');\n    this.expandButton.innerHTML = 'â¤¢';\n    this.expandButton.title = 'ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‚’è¡¨ç¤º';\n    this.expandButton.style.cssText = `\n      position: absolute;\n      bottom: 8px;\n      right: 8px;\n      width: 24px;\n      height: 24px;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'};\n      border: 1px solid ${this.isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)'};\n      border-radius: 6px;\n      color: ${this.isWabiSabiMode ? '#F5F5F5' : (this.isDarkMode ? '#ffffff' : '#1f2937')};\n      font-size: 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      z-index: 1;\n    `;\n\n    // å±•é–‹ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼åŠ¹æœ\n    this.expandButton.addEventListener('mouseenter', () => {\n      this.expandButton.style.background = this.isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)';\n      this.expandButton.style.transform = 'scale(1.1)';\n    });\n\n    this.expandButton.addEventListener('mouseleave', () => {\n      this.expandButton.style.background = this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';\n      this.expandButton.style.transform = 'scale(1)';\n    });\n\n    // å±•é–‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†\n    this.expandButton.addEventListener('click', () => {\n      if (this.isExpanded) {\n        this.hideOverlayTextarea();\n      } else {\n        this.showOverlayTextarea();\n      }\n    });\n\n    // ãƒ©ãƒƒãƒ‘ãƒ¼ã«è¦ç´ ã‚’è¿½åŠ \n    this.inputWrapper.appendChild(this.input);\n    this.inputWrapper.appendChild(this.expandButton);\n\n    // æ—§ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIã«çµ±åˆï¼‰\n\n    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³é¢¨ãƒ¢ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼\n    const modeSelector = this.createRadioModeSelector();\n\n    // ãƒŸãƒ‹ãƒãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³\n    const actionContainer = this.createMinimalActions();\n\n    // Ã—ã‚¯ãƒ­ãƒ¼ã‚ºãƒœã‚¿ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒ å³ä¸Šã«è¿½åŠ \n    const closeButton = document.createElement('div');\n    closeButton.innerHTML = 'Ã—';\n    closeButton.style.cssText = `\n      position: absolute;\n      top: 12px;\n      right: 12px;\n      width: 22px;\n      height: 22px;\n      border-radius: 50%;\n      background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'};\n      color: ${this.isWabiSabiMode ? '#F5F5F5' : (this.isDarkMode ? '#ffffff' : '#1f2937')};\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: normal;\n      transition: all 0.2s ease;\n      backdrop-filter: blur(8px);\n      z-index: 10;\n    `;\n\n    closeButton.addEventListener('mouseover', () => {\n      closeButton.style.background = this.isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)';\n      closeButton.style.transform = 'scale(1.1)';\n    });\n\n    closeButton.addEventListener('mouseout', () => {\n      closeButton.style.background = this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';\n      closeButton.style.color = this.isDarkMode ? '#ffffff' : '#1f2937';\n      closeButton.style.transform = 'scale(1)';\n    });\n\n    closeButton.addEventListener('click', () => {\n      this.hide();\n    });\n\n    // çµ„ã¿ç«‹ã¦ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å‰Šé™¤ã€ãƒ–ãƒ©ãƒ³ãƒ‰ãƒãƒƒã‚¸ã¯æ—¢ã«è¿½åŠ æ¸ˆã¿ï¼‰\n    // this.container.appendChild(this.output); // å¤§ããªã‚¿ã‚¹ã‚¯è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’DOMã«è¿½åŠ ã—ãªã„\n    this.container.appendChild(closeButton);\n    this.container.appendChild(modeSelector);\n    this.container.appendChild(this.inputWrapper);\n    this.container.appendChild(actionContainer);\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã‚’bodyã«ç›´æ¥è¿½åŠ \n    document.body.appendChild(this.floatingContainer);\n\n    // DOM ã«è¿½åŠ \n    document.body.appendChild(this.container);\n\n    // åˆå›ãƒ†ãƒ¼ãƒé©ç”¨\n    this.applyTheme();\n\n    // æ—¥æœ¬èªIMEå¯¾å¿œã®composition stateç®¡ç†\n    this.isComposing = false;\n    this.hasCompositionJustEnded = false;\n\n    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›ç›£è¦–ã¨ã‚³ãƒãƒ³ãƒ‰æ¤œå‡ºï¼ˆIMEå¯¾å¿œï¼‰\n    this.input.addEventListener('input', () => {\n      // IMEå…¥åŠ›ä¸­ã¯ã‚³ãƒãƒ³ãƒ‰æ¤œå‡ºã‚’åœæ­¢\n      if (this.isComposing) {\n        return;\n      }\n      \n      // è‡ªå‹•ãƒªã‚µã‚¤ã‚ºå‡¦ç†\n      this.autoResizeTextarea();\n      \n      this.detectCommandType();\n    });\n    \n    // æ—¥æœ¬èªIME composition events\n    this.input.addEventListener('compositionstart', () => {\n      this.isComposing = true;\n    });\n    \n    this.input.addEventListener('compositionend', () => {\n      this.isComposing = false;\n      \n      // Safariã®ã¿ãƒ•ãƒ©ã‚°è¨­å®šï¼ˆä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä¸è¦ï¼‰\n      const isSafari = /Safari/.test(navigator.userAgent) && /Version/.test(navigator.userAgent);\n      if (isSafari) {\n        this.hasCompositionJustEnded = true;\n      }\n      \n      // ç¢ºå®šå¾Œã®ã‚³ãƒãƒ³ãƒ‰æ¤œå‡ºã‚’å®Ÿè¡Œ\n      setTimeout(() => {\n        this.autoResizeTextarea();\n        this.detectCommandType();\n      }, 10);\n    });\n    \n    // Safariåˆ¤å®š\n    const isSafari = /Safari/.test(navigator.userAgent) && /Version/.test(navigator.userAgent);\n    \n    // æ—¥æœ¬èªIMEå¯¾å¿œEnterã‚­ãƒ¼å‡¦ç†ï¼ˆSafariå¯¾å¿œç‰ˆï¼‰\n    this.input.addEventListener('keydown', (e) => {\n      if (e.key === 'Enter') {\n        // Safari: compositionendç›´å¾Œã®Enterã‚’ã‚¹ã‚­ãƒƒãƒ—\n        if (isSafari && this.hasCompositionJustEnded) {\n          this.hasCompositionJustEnded = false;\n          return;\n        }\n\n        // ãã®ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶: isComposingãƒã‚§ãƒƒã‚¯\n        if (!isSafari && (e.isComposing || this.isComposing)) {\n          return;\n        }\n\n        // Generate ãƒ¢ãƒ¼ãƒ‰ã®ã¿ãƒ‡ãƒ¢åˆ¶é™ã‚’é©ç”¨\n        if (this.currentMode === 'generate') {\n          e.preventDefault();\n          this.showDemoMessage();\n          return;\n        }\n\n        e.preventDefault();\n        this.executeCommand();\n      }\n    });\n    \n    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\n    if (this.config.showExamples) {\n      // èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤\n      // èµ·å‹•æ™‚ã¯é™ã‹ã«å¾…æ©Ÿ\n    }\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ä½œæˆ\n   */\n  createMinimalActions() {\n    const container = document.createElement('div');\n    container.style.cssText = `\n      display: flex;\n      margin-top: 8px;\n      margin-bottom: 0 !important;\n      gap: 8px;\n      justify-content: space-between;\n      align-items: center;\n    `;\n\n    // å·¦å´: Clear All ãƒœã‚¿ãƒ³ï¼ˆæ‰¿èªæ¸ˆã¿ã®Layout Bãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰\n    const leftSection = document.createElement('div');\n    leftSection.style.cssText = 'display: flex; gap: 8px; align-items: center;';\n\n    const clearBtn = document.createElement('button');\n    clearBtn.innerHTML = '<span style=\"filter: hue-rotate(240deg) saturate(0.7) brightness(0.9);\">ğŸ§¹</span> Clear All';\n    clearBtn.style.cssText = this.getActionButtonStyles('secondary');\n    clearBtn.addEventListener('click', () => this.clearAllWithConfirmation());\n\n    // å±¥æ­´ãƒœã‚¿ãƒ³ï¼ˆå°†æ¥å®Ÿè£…ç”¨ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ï¼‰- æµ·å¤–UIæ¨™æº–å¯¾å¿œï¼šåŒä¸€å¹…\n    const historyBtn = document.createElement('button');\n    historyBtn.innerHTML = '<span style=\"filter: hue-rotate(240deg) saturate(0.7) brightness(0.9);\">ğŸ“š</span> History';\n    historyBtn.style.cssText = this.getActionButtonStyles('secondary');\n    historyBtn.style.opacity = '0.5';\n    historyBtn.disabled = true;\n    historyBtn.title = 'å±¥æ­´æ©Ÿèƒ½ï¼ˆé–‹ç™ºä¸­ï¼‰';\n\n    leftSection.appendChild(clearBtn);\n    leftSection.appendChild(historyBtn);\n\n    // å³å´: ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ«ã¨è¨­å®šï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ç§»å‹•ï¼‰\n    const rightSection = document.createElement('div');\n    rightSection.style.cssText = 'display: flex; gap: 6px; align-items: center;';\n\n    const themeToggle = document.createElement('button');\n    const getThemeIcon = () => {\n      const themeConfig = {\n        light: 'ğŸŒ™',\n        dark: 'ğŸµ',\n        wabisabi: 'â˜€ï¸'\n      };\n      return themeConfig[this.currentTheme] || 'ğŸŒ™';\n    };\n\n    const getThemeTitle = () => {\n      const titleConfig = {\n        light: 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ',\n        dark: 'ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ',\n        wabisabi: 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ'\n      };\n      return titleConfig[this.currentTheme] || 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ';\n    };\n\n    const getThemeIconWithFilter = () => {\n      const icon = getThemeIcon();\n      // å¤ªé™½ã¯é»„è‰²ãã€ãŠèŒ¶ã¯ç·‘ç³»ã€æœˆã¯ç´«ç³»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼\n      if (icon === 'â˜€ï¸') {\n        return `<span style=\"filter: saturate(1.2) brightness(1.1);\">${icon}</span>`;\n      } else if (icon === 'ğŸµ') {\n        return `<span style=\"filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);\">${icon}</span>`;\n      } else {\n        return `<span style=\"filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);\">${icon}</span>`;\n      }\n    };\n\n    themeToggle.innerHTML = getThemeIconWithFilter();\n    themeToggle.style.cssText = this.getActionButtonStyles('icon');\n    themeToggle.title = getThemeTitle();\n    themeToggle.addEventListener('click', () => this.toggleTheme());\n\n    const settingsButton = document.createElement('button');\n    settingsButton.innerHTML = '<span style=\"filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);\">âš™ï¸</span>';\n    settingsButton.style.cssText = this.getActionButtonStyles('icon');\n    settingsButton.title = 'ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šã‚’é–‹ã';\n    settingsButton.addEventListener('click', () => this.openServiceModal());\n\n    rightSection.appendChild(themeToggle);\n    rightSection.appendChild(settingsButton);\n\n    container.appendChild(leftSection);\n    container.appendChild(rightSection);\n\n    // å‚ç…§ã‚’ä¿æŒ\n    this.clearBtn = clearBtn;\n    this.historyBtn = historyBtn;\n    this.themeToggle = themeToggle;\n    this.settingsButton = settingsButton;\n\n    return container;\n  }\n\n  createServiceSelectorSection() {\n    this.serviceSelectorContainer = document.createElement('div');\n    this.serviceSelectorContainer.id = 'service-selector';\n    this.serviceSelectorContainer.style.cssText = `\n      margin-bottom: 16px;\n      padding: 12px;\n      border-radius: 12px;\n      border: 1px solid transparent;\n      transition: background 0.3s ease, border 0.3s ease;\n    `;\n\n    this.serviceSelectorStatus = document.createElement('div');\n    this.serviceSelectorStatus.textContent = 'ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...';\n    this.serviceSelectorStatus.style.fontSize = '12px';\n    this.serviceSelectorStatus.style.opacity = '0.8';\n    this.serviceSelectorStatus.style.marginBottom = '8px';\n    this.serviceSelectorContainer.appendChild(this.serviceSelectorStatus);\n\n    this.serviceSelectorContent = document.createElement('div');\n    this.serviceSelectorContainer.appendChild(this.serviceSelectorContent);\n\n    this.updateServiceSelectorTheme();\n    return this.serviceSelectorContainer;\n  }\n\n  createServiceModal() {\n    if (this.serviceModalOverlay) {\n      this.serviceModalOverlay.remove();\n      this.serviceModalOverlay = null;\n      this.serviceModal = null;\n    }\n\n    this.serviceModalOverlay = document.createElement('div');\n    this.serviceModalOverlay.id = 'chocodrop-service-modal-overlay';\n    this.serviceModalOverlay.style.cssText = `\n      position: fixed;\n      inset: 0;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      backdrop-filter: blur(18px);\n      -webkit-backdrop-filter: blur(18px);\n      z-index: 2000;\n      padding: 16px !important;\n      opacity: 0;\n      transition: opacity 0.2s ease;\n    `;\n\n    this.serviceModalOverlay.addEventListener('click', (event) => {\n      if (event.target === this.serviceModalOverlay) {\n        this.closeServiceModal();\n      }\n    });\n\n    this.serviceModal = document.createElement('div');\n    this.serviceModal.className = 'chocodrop-service-modal';\n    this.serviceModal.style.cssText = `\n      width: min(420px, 90vw);\n      border-radius: 24px;\n      padding: 26px 28px;\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);\n      display: flex;\n      flex-direction: column;\n      gap: 18px;\n      max-height: 90vh;\n      overflow-y: auto;\n      position: relative;\n    `;\n\n    const title = document.createElement('h2');\n    title.textContent = 'ã‚µãƒ¼ãƒ“ã‚¹è¨­å®š';\n    title.style.cssText = `\n      margin: 0;\n      font-size: 18px;\n      font-weight: 700;\n      letter-spacing: 0.03em;\n    `;\n\n    const subtitle = document.createElement('p');\n    subtitle.textContent = 'åˆ©ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';\n    subtitle.style.cssText = `\n      margin: 0;\n      font-size: 12px;\n      opacity: 0.75;\n    `;\n\n    const selector = this.createServiceSelectorSection();\n\n    const actionRow = document.createElement('div');\n    actionRow.style.cssText = `\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      gap: 16px;\n    `;\n\n    this.serviceSelectorRetryButton = document.createElement('button');\n    this.serviceSelectorRetryButton.textContent = 'å†èª­ã¿è¾¼ã¿';\n    this.serviceSelectorRetryButton.style.cssText = `\n      font-size: 11px;\n      padding: 6px 14px;\n      border-radius: 10px;\n      border: 1px solid transparent;\n      cursor: pointer;\n      display: none;\n      transition: all 0.2s ease;\n    `;\n    this.serviceSelectorRetryButton.addEventListener('click', () => this.initializeServiceSelector(true));\n\n    const actionButtons = document.createElement('div');\n    actionButtons.style.cssText = 'display: flex; gap: 8px;';\n\n    this.serviceSelectorCancelButton = document.createElement('button');\n    this.serviceSelectorCancelButton.textContent = 'Cancel';\n    this.serviceSelectorCancelButton.style.cssText = `\n      font-size: 12px;\n      padding: 8px 16px;\n      border-radius: 10px;\n      border: 1px solid rgba(255, 255, 255, 0.35);\n      background: transparent;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    `;\n    this.serviceSelectorCancelButton.addEventListener('click', () => this.closeServiceModal());\n\n    this.serviceSelectorSaveButton = document.createElement('button');\n    this.serviceSelectorSaveButton.textContent = 'Save';\n    this.serviceSelectorSaveButton.style.cssText = `\n      font-size: 12px;\n      padding: 8px 18px;\n      border-radius: 10px;\n      border: none;\n      cursor: pointer;\n      background: linear-gradient(135deg, #6366f1, #8b5cf6);\n      color: white;\n      font-weight: 600;\n      transition: all 0.2s ease;\n      box-shadow: 0 12px 24px rgba(99, 102, 241, 0.35);\n    `;\n    this.serviceSelectorSaveButton.addEventListener('click', () => this.handleServiceSave());\n\n    actionButtons.appendChild(this.serviceSelectorCancelButton);\n    actionButtons.appendChild(this.serviceSelectorSaveButton);\n\n    actionRow.appendChild(this.serviceSelectorRetryButton);\n    actionRow.appendChild(actionButtons);\n\n    this.serviceModal.appendChild(title);\n    this.serviceModal.appendChild(subtitle);\n    this.serviceModal.appendChild(selector);\n    this.serviceModal.appendChild(actionRow);\n\n    this.serviceModalOverlay.appendChild(this.serviceModal);\n    document.body.appendChild(this.serviceModalOverlay);\n\n    this.updateServiceSelectorTheme();\n    this.toggleServiceRetryButton(false);\n  }\n\n  openServiceModal(forceFetch = false) {\n    if (!this.serviceModalOverlay) {\n      this.createServiceModal();\n    }\n\n    this.serviceModalOverlay.style.display = 'flex';\n    requestAnimationFrame(() => {\n      if (this.serviceModalOverlay) {\n        this.serviceModalOverlay.style.opacity = '1';\n      }\n    });\n\n    this.resetPendingSelections();\n    this.initializeServiceSelector(forceFetch);\n  }\n\n  closeServiceModal() {\n    if (!this.serviceModalOverlay) {\n      return;\n    }\n\n    this.serviceModalOverlay.style.opacity = '0';\n    setTimeout(() => {\n      if (this.serviceModalOverlay) {\n        this.serviceModalOverlay.style.display = 'none';\n      }\n      this.resetPendingSelections();\n    }, 150);\n  }\n\n  async initializeServiceSelector(force = false) {\n    if (this.servicesLoading && !force) {\n      return;\n    }\n\n    if (!this.client || typeof this.client.getAvailableServices !== 'function') {\n      this.setServiceSelectorStatus('ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–å¾…ã¡ã§ã™ï¼‰ã€‚å³ä¸‹ã®ã€Œå†èª­ã¿è¾¼ã¿ã€ã§å†å–å¾—ã§ãã¾ã™ã€‚', 'error');\n      this.toggleServiceRetryButton(true);\n      this.setServiceButtonsEnabled(false);\n      return;\n    }\n\n    this.servicesLoading = true;\n    this.setServiceSelectorStatus('ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...', 'info');\n    this.toggleServiceRetryButton(false);\n    this.setServiceButtonsEnabled(false);\n\n    try {\n      if (typeof this.client.ensureInitialized === 'function') {\n        await this.client.ensureInitialized();\n      }\n\n      const response = await this.client.getAvailableServices();\n      if (!response || response.success === false || !response.metadata) {\n        throw new Error(response?.error || 'ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');\n      }\n\n      this.availableImageServices = Array.isArray(response.metadata?.image) ? response.metadata.image : [];\n      this.availableVideoServices = Array.isArray(response.metadata?.video) ? response.metadata.video : [];\n\n      this.selectedImageService = this.resolveServiceSelection(\n        'image',\n        this.availableImageServices,\n        response.default?.image\n      );\n\n      this.selectedVideoService = this.resolveServiceSelection(\n        'video',\n        this.availableVideoServices,\n        response.default?.video\n      );\n\n      this.pendingImageService = this.selectedImageService;\n      this.pendingVideoService = this.selectedVideoService;\n\n      this.populateServiceSelector();\n      this.applyServiceSelectionToSceneManager();\n      this.setServiceButtonsEnabled(true);\n    } catch (error) {\n      console.error('âŒ Failed to initialize service selector:', error);\n      this.setServiceSelectorStatus('ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã®ã†ãˆã€å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');\n      this.toggleServiceRetryButton(true);\n      this.setServiceButtonsEnabled(false);\n    } finally {\n      this.servicesLoading = false;\n    }\n  }\n\n  setServiceSelectorStatus(message, type = 'info') {\n    if (!this.serviceSelectorStatus) {\n      return;\n    }\n    this.serviceSelectorStatus.textContent = message;\n    this.serviceSelectorStatus.dataset.statusType = type;\n    this.serviceSelectorStatus.classList.toggle('service-selector-helper', type !== 'error');\n    this.updateServiceSelectorTheme();\n  }\n\n  toggleServiceRetryButton(visible) {\n    if (!this.serviceSelectorRetryButton) {\n      return;\n    }\n    this.serviceSelectorRetryButton.style.display = visible ? 'inline-flex' : 'none';\n    this.updateServiceSelectorTheme();\n  }\n\n  resolveServiceSelection(type, services, defaultId) {\n    if (!services || services.length === 0) {\n      return null;\n    }\n\n    const storageKey = type === 'image' ? IMAGE_SERVICE_STORAGE_KEY : VIDEO_SERVICE_STORAGE_KEY;\n    let storedId = null;\n    try {\n      storedId = localStorage.getItem(storageKey);\n    } catch (error) {\n      console.warn('âš ï¸ Failed to access localStorage:', error);\n    }\n\n    const isStoredValid = storedId && services.some(service => service.id === storedId);\n    let resolvedId = isStoredValid ? storedId : null;\n\n    if (!resolvedId && defaultId && services.some(service => service.id === defaultId)) {\n      resolvedId = defaultId;\n    }\n\n    if (!resolvedId) {\n      resolvedId = services[0]?.id || null;\n    }\n\n    try {\n      if (resolvedId) {\n        localStorage.setItem(storageKey, resolvedId);\n      } else {\n        localStorage.removeItem(storageKey);\n      }\n    } catch (error) {\n      console.warn('âš ï¸ Failed to persist service selection:', error);\n    }\n\n    return resolvedId;\n  }\n\n  populateServiceSelector() {\n    if (!this.serviceSelectorContent) {\n      return;\n    }\n\n    this.serviceSelectorContent.innerHTML = '';\n\n    const hasImage = this.availableImageServices.length > 0;\n    const hasVideo = this.availableVideoServices.length > 0;\n\n    if (!hasImage && !hasVideo) {\n      this.setServiceSelectorStatus('åˆ©ç”¨å¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');\n      return;\n    }\n\n    this.setServiceSelectorStatus('åˆ©ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'info');\n\n    if (hasImage) {\n      const imageRow = this.buildServiceRow('image', 'ç”»åƒ (T2I)', this.availableImageServices, this.pendingImageService || this.selectedImageService);\n      this.serviceSelectorContent.appendChild(imageRow);\n    }\n\n    if (hasVideo) {\n      const videoRow = this.buildServiceRow('video', 'å‹•ç”» (T2V)', this.availableVideoServices, this.pendingVideoService || this.selectedVideoService);\n      this.serviceSelectorContent.appendChild(videoRow);\n    }\n\n    this.updateServiceSelectorTheme();\n  }\n\n  buildServiceRow(type, labelText, services, selectedId) {\n    const row = document.createElement('div');\n    row.className = `service-row service-row-${type}`;\n    row.style.cssText = `\n      display: flex;\n      flex-direction: column;\n      gap: 6px;\n      margin-bottom: 12px;\n    `;\n\n    const label = document.createElement('label');\n    label.textContent = labelText;\n    label.style.fontSize = '13px';\n    label.style.fontWeight = '600';\n    row.appendChild(label);\n\n    const select = document.createElement('select');\n    select.dataset.serviceType = type;\n    select.style.fontFamily = 'inherit';\n    select.style.width = '100%';\n\n    services.forEach(service => {\n      const option = document.createElement('option');\n      option.value = service.id;\n      option.textContent = service.name || service.id;\n      if (service.description) {\n        option.title = service.description;\n      }\n      select.appendChild(option);\n    });\n\n    if (selectedId && services.some(service => service.id === selectedId)) {\n      select.value = selectedId;\n    }\n\n    select.addEventListener('change', (event) => {\n      this.onServiceSelectionChange(type, event.target.value);\n    });\n\n    row.appendChild(select);\n\n    const description = document.createElement('div');\n    description.className = 'service-description';\n    description.textContent = this.findServiceInfo(type, select.value)?.description || '';\n    description.style.fontSize = '11px';\n    description.style.opacity = '0.75';\n    description.style.lineHeight = '1.4';\n    description.style.minHeight = '14px';\n    row.appendChild(description);\n\n    select.addEventListener('change', () => {\n      description.textContent = this.findServiceInfo(type, select.value)?.description || '';\n    });\n\n    if (type === 'image') {\n      this.imageServiceSelect = select;\n    } else {\n      this.videoServiceSelect = select;\n    }\n\n    return row;\n  }\n\n  onServiceSelectionChange(type, serviceId) {\n    if (type === 'image') {\n      this.pendingImageService = serviceId;\n    } else {\n      this.pendingVideoService = serviceId;\n    }\n\n    const info = this.findServiceInfo(type, serviceId);\n    const description = type === 'image'\n      ? this.imageServiceSelect?.parentElement?.querySelector('.service-description')\n      : this.videoServiceSelect?.parentElement?.querySelector('.service-description');\n\n    if (description) {\n      description.textContent = info?.description || '';\n    }\n  }\n\n  handleServiceSave() {\n    const newImageId = this.pendingImageService || this.selectedImageService;\n    const newVideoId = this.pendingVideoService || this.selectedVideoService;\n\n    if (newImageId) {\n      try {\n        localStorage.setItem(IMAGE_SERVICE_STORAGE_KEY, newImageId);\n      } catch (error) {\n        console.warn('âš ï¸ Failed to persist image service selection:', error);\n      }\n      this.selectedImageService = newImageId;\n      this.sceneManager?.setImageService(newImageId);\n    }\n\n    if (newVideoId) {\n      try {\n        localStorage.setItem(VIDEO_SERVICE_STORAGE_KEY, newVideoId);\n      } catch (error) {\n        console.warn('âš ï¸ Failed to persist video service selection:', error);\n      }\n      this.selectedVideoService = newVideoId;\n      this.sceneManager?.setVideoService(newVideoId);\n    }\n\n    const imageInfo = this.findServiceInfo('image', newImageId);\n    const videoInfo = this.findServiceInfo('video', newVideoId);\n\n    if (imageInfo) {\n      this.addOutput(`ğŸ–¼ï¸ ç”»åƒã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€Œ${imageInfo.name}ã€ã«è¨­å®šã—ã¾ã—ãŸ`, 'system');\n    }\n    if (videoInfo) {\n      this.addOutput(`ğŸ¬ å‹•ç”»ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€Œ${videoInfo.name}ã€ã«è¨­å®šã—ã¾ã—ãŸ`, 'system');\n    }\n\n    this.closeServiceModal();\n  }\n\n  setServiceButtonsEnabled(enabled) {\n    if (this.serviceSelectorSaveButton) {\n      this.serviceSelectorSaveButton.disabled = !enabled;\n      this.serviceSelectorSaveButton.style.opacity = enabled ? '1' : '0.6';\n      this.serviceSelectorSaveButton.style.cursor = enabled ? 'pointer' : 'not-allowed';\n    }\n  }\n\n  resetPendingSelections() {\n    this.pendingImageService = this.selectedImageService;\n    this.pendingVideoService = this.selectedVideoService;\n\n    if (this.imageServiceSelect && this.selectedImageService) {\n      this.imageServiceSelect.value = this.selectedImageService;\n    }\n    if (this.videoServiceSelect && this.selectedVideoService) {\n      this.videoServiceSelect.value = this.selectedVideoService;\n    }\n\n    if (this.serviceSelectorContent && this.serviceSelectorContent.childElementCount > 0) {\n      this.populateServiceSelector();\n    }\n  }\n\n  findServiceInfo(type, serviceId) {\n    const list = type === 'image' ? this.availableImageServices : this.availableVideoServices;\n    return list.find(service => service.id === serviceId) || null;\n  }\n\n  applyServiceSelectionToSceneManager() {\n    if (!this.sceneManager) {\n      return;\n    }\n    this.sceneManager.setImageService(this.selectedImageService);\n    this.sceneManager.setVideoService(this.selectedVideoService);\n  }\n\n  updateServiceSelectorTheme() {\n    if (this.serviceModalOverlay) {\n      this.serviceModalOverlay.style.background = this.isDarkMode\n        ? 'rgba(8, 11, 26, 0.55)'\n        : 'rgba(229, 231, 255, 0.45)';\n    }\n\n    if (this.serviceModal) {\n      this.serviceModal.style.background = this.isDarkMode\n        ? 'rgba(17, 24, 39, 0.15)'\n        : 'rgba(255, 255, 255, 0.15)';\n      this.serviceModal.style.border = this.isDarkMode\n        ? '1px solid rgba(129, 140, 248, 0.4)'\n        : '1px solid rgba(99, 102, 241, 0.25)';\n      this.serviceModal.style.color = this.isDarkMode ? '#e5e7ff' : '#1f2937';\n    }\n\n    if (this.serviceSelectorStatus) {\n      const type = this.serviceSelectorStatus.dataset?.statusType;\n      const statusColor = type === 'error'\n        ? (this.isDarkMode ? '#fca5a5' : '#b91c1c')\n        : (this.isDarkMode ? 'rgba(209, 213, 219, 0.8)' : 'rgba(55, 65, 81, 0.75)');\n      this.serviceSelectorStatus.style.color = statusColor;\n    }\n\n    if (this.serviceSelectorContainer) {\n      const labels = this.serviceSelectorContainer.querySelectorAll('label');\n      labels.forEach(label => {\n        label.style.color = this.isDarkMode ? 'rgba(255, 255, 255, 0.9)' : 'rgba(31, 41, 55, 0.9)';\n      });\n\n      const selects = this.serviceSelectorContainer.querySelectorAll('select');\n      selects.forEach(select => {\n        select.style.background = this.isDarkMode ? 'rgba(99, 102, 241, 0.18)' : 'rgba(99, 102, 241, 0.12)';\n        select.style.border = this.isDarkMode ? '1px solid rgba(129, 140, 248, 0.45)' : '1px solid rgba(99, 102, 241, 0.45)';\n        select.style.color = this.isDarkMode ? '#ffffff' : '#1f2937';\n        select.style.padding = '10px 12px';\n        select.style.borderRadius = '10px';\n        select.style.fontSize = '13px';\n        select.style.outline = 'none';\n        select.style.boxShadow = this.isDarkMode\n          ? '0 12px 28px rgba(15, 23, 42, 0.5)'\n          : '0 12px 24px rgba(99, 102, 241, 0.2)';\n      });\n\n      const descriptions = this.serviceSelectorContainer.querySelectorAll('.service-description');\n      descriptions.forEach(desc => {\n        desc.style.color = this.isDarkMode ? 'rgba(209, 213, 219, 0.8)' : 'rgba(55, 65, 81, 0.7)';\n      });\n    }\n\n    if (this.serviceSelectorRetryButton) {\n      this.serviceSelectorRetryButton.style.background = this.isDarkMode\n        ? 'rgba(129, 140, 248, 0.35)'\n        : 'rgba(99, 102, 241, 0.15)';\n      this.serviceSelectorRetryButton.style.border = this.isDarkMode\n        ? '1px solid rgba(129, 140, 248, 0.5)'\n        : '1px solid rgba(99, 102, 241, 0.45)';\n      this.serviceSelectorRetryButton.style.color = this.isDarkMode ? '#f9fafb' : '#1e1b4b';\n      this.serviceSelectorRetryButton.style.boxShadow = this.isDarkMode\n        ? '0 0 8px rgba(129, 140, 248, 0.45)'\n        : '0 0 8px rgba(99, 102, 241, 0.35)';\n    }\n\n    if (this.serviceSelectorCancelButton) {\n      this.serviceSelectorCancelButton.style.border = this.isDarkMode\n        ? '1px solid rgba(209, 213, 219, 0.3)'\n        : '1px solid rgba(148, 163, 184, 0.5)';\n      this.serviceSelectorCancelButton.style.color = this.isDarkMode ? 'rgba(226, 232, 240, 0.85)' : 'rgba(30, 41, 59, 0.85)';\n    }\n\n    if (this.serviceSelectorSaveButton) {\n      this.serviceSelectorSaveButton.style.background = this.isDarkMode\n        ? 'linear-gradient(135deg, #6366f1, #8b5cf6)'\n        : 'linear-gradient(135deg, #818cf8, #a855f7)';\n      this.serviceSelectorSaveButton.style.boxShadow = this.isDarkMode\n        ? '0 16px 28px rgba(99, 102, 241, 0.4)'\n        : '0 16px 28px rgba(129, 140, 248, 0.35)';\n    }\n  }\n\n  /**\n   * ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³é¢¨ãƒ¢ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ä½œæˆ\n   */\n  createRadioModeSelector() {\n    const container = document.createElement('div');\n    container.className = 'radio-mode-selector';\n    container.style.cssText = `\n      display: grid;\n      grid-template-columns: repeat(4, 1fr);\n      gap: 8px;\n      margin-bottom: 12px;\n      padding: 12px;\n      background: ${this.isWabiSabiMode\n        ? 'linear-gradient(135deg, rgba(158, 158, 158, 0.25), rgba(189, 189, 189, 0.2))'\n        : (this.isDarkMode\n          ? 'linear-gradient(135deg, rgba(30, 27, 75, 0.3), rgba(15, 23, 42, 0.4))'\n          : 'linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1))')};\n      border: 1px solid ${this.isWabiSabiMode\n        ? 'rgba(141, 110, 99, 0.4)'\n        : (this.isDarkMode ? 'rgba(99, 102, 241, 0.15)' : 'rgba(255, 255, 255, 0.25)')};\n      border-radius: 16px;\n      backdrop-filter: blur(12px);\n      transition: all 0.3s ease;\n      position: relative;\n    `;\n\n    const modes = [\n      { value: 'generate', label: 'Generate', icon: 'ğŸš«', disabled: true },\n      { value: 'import', label: 'Import', icon: 'ğŸ“¥' },\n      { value: 'modify', label: 'Modify', icon: 'ğŸ”§' },\n      { value: 'delete', label: 'Delete', icon: 'ğŸ—‘ï¸' }\n    ];\n\n    this.radioModeButtons = {};\n\n    modes.forEach(mode => {\n      const button = document.createElement('div');\n      button.className = `mode-option ${mode.value}`;\n      button.style.cssText = `\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 4px;\n        padding: 10px 8px;\n        border-radius: 12px;\n        cursor: ${mode.disabled ? 'not-allowed' : 'pointer'};\n        transition: all 0.2s ease;\n        font-size: 11px;\n        font-weight: 600;\n        text-align: center;\n        color: ${mode.disabled ? 'rgba(139, 92, 246, 0.6)' : this.isWabiSabiMode\n          ? '#F5F5F5'\n          : (this.isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(55, 65, 81, 0.8)')};\n        background: transparent;\n        border: 1px solid transparent;\n        position: relative;\n        opacity: ${mode.disabled ? '0.6' : '1'};\n      `;\n\n      const icon = document.createElement('div');\n      icon.textContent = mode.icon;\n      icon.style.cssText = `\n        font-size: 16px;\n        margin-bottom: 2px;\n        filter: ${mode.disabled ? 'hue-rotate(240deg) saturate(0.8) brightness(1.1)' : this.isDarkMode \n          ? 'hue-rotate(220deg) saturate(0.8) brightness(1.2)' \n          : 'hue-rotate(240deg) saturate(0.7) brightness(0.9)'};\n        transition: filter 0.2s ease;\n      `;\n\n      const label = document.createElement('span');\n      label.textContent = mode.label;\n\n      // AUTOãƒãƒƒã‚¸ã‚’ä½œæˆ\n      const autoBadge = document.createElement('div');\n      autoBadge.className = 'auto-badge';\n      autoBadge.textContent = 'AUTO';\n      autoBadge.style.cssText = `\n        position: absolute;\n        top: -4px;\n        right: -4px;\n        font-size: 7px;\n        font-weight: 700;\n        padding: 2px 4px;\n        background: linear-gradient(135deg, #10b981, #059669);\n        color: white;\n        border-radius: 6px;\n        opacity: 0;\n        transform: scale(0.8);\n        transition: all 0.2s ease;\n        display: none;\n      `;\n\n      button.appendChild(icon);\n      button.appendChild(label);\n      button.appendChild(autoBadge);\n\n      // ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†\n      if (mode.disabled) {\n        // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã¿ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º\n        button.addEventListener('click', (e) => {\n          e.preventDefault();\n          e.stopPropagation();\n          this.showDemoMessage();\n        });\n      } else {\n        // é€šå¸¸ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ\n        button.addEventListener('click', () => {\n          if (mode.value === 'import') {\n            this.triggerFileSelection();\n          } else {\n            this.selectMode(mode.value, true); // trueã¯æ‰‹å‹•é¸æŠã‚’ç¤ºã™\n          }\n        });\n      }\n\n      this.radioModeButtons[mode.value] = { button, autoBadge };\n      container.appendChild(button);\n    });\n\n\n    this.radioModeContainer = container;\n    // ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸ã§ã¯Importã‚’åˆæœŸé¸æŠ\n    this.selectMode('import', false);\n\n    return container;\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIæ›´æ–°ï¼‰\n   */\n  selectMode(mode, isManual = false, detectedKeyword = null) {\n    this.currentMode = mode;\n\n    // å…¨ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ\n    Object.keys(this.radioModeButtons).forEach(key => {\n      const { button, autoBadge } = this.radioModeButtons[key];\n      button.style.color = this.isWabiSabiMode\n        ? '#F5F5F5'\n        : (this.isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(55, 65, 81, 0.8)');\n      button.style.background = 'transparent';\n      button.style.border = '1px solid transparent';\n      button.style.transform = 'scale(1)';\n      button.style.boxShadow = 'none';\n      // AUTOãƒãƒƒã‚¸ã‚’éè¡¨ç¤º\n      autoBadge.style.display = 'none';\n      autoBadge.style.opacity = '0';\n    });\n\n    // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆ2025å¹´ä»•æ§˜ï¼‰\n    const { button, autoBadge } = this.radioModeButtons[mode];\n    \n    // 2025 Glassmorphismé¸æŠçŠ¶æ…‹\n    const selectedGlass = this.isWabiSabiMode\n      ? {\n          background: 'linear-gradient(135deg, rgba(109, 76, 65, 0.2), rgba(141, 110, 99, 0.15))',\n          border: '1px solid rgba(109, 76, 65, 0.4)',\n          boxShadow: '0 4px 16px rgba(109, 76, 65, 0.25), inset 0 1px 0 rgba(245, 245, 220, 0.15)',\n          color: '#F5F5F5'\n        }\n      : (this.isDarkMode\n        ? {\n            background: 'linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15))',\n            border: '1px solid rgba(99, 102, 241, 0.4)',\n            boxShadow: '0 4px 16px rgba(99, 102, 241, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1)',\n            color: '#a5b4fc'\n          }\n        : {\n            background: 'linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.08))',\n            border: '1px solid rgba(99, 102, 241, 0.3)',\n            boxShadow: '0 4px 16px rgba(99, 102, 241, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2)',\n            color: '#6366f1'\n          });\n\n    button.style.color = selectedGlass.color;\n    button.style.background = selectedGlass.background;\n    button.style.border = selectedGlass.border;\n    button.style.boxShadow = selectedGlass.boxShadow;\n    button.style.transform = 'scale(1.02)';\n\n    // AUTOãƒãƒƒã‚¸ã®è¡¨ç¤ºåˆ¶å¾¡\n    if (!isManual && detectedKeyword) {\n      // è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆã®å ´åˆã¯AUTOãƒãƒƒã‚¸ã‚’è¡¨ç¤º\n      autoBadge.style.display = 'inline-block';\n      setTimeout(() => {\n        autoBadge.style.opacity = '1';\n        autoBadge.style.transform = 'scale(1)';\n      }, 100);\n      \n      // 3ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ\n      setTimeout(() => {\n        autoBadge.style.opacity = '0';\n        autoBadge.style.transform = 'scale(0.8)';\n        setTimeout(() => {\n          autoBadge.style.display = 'none';\n        }, 200);\n      }, 3000);\n    }\n\n    // ãƒ‘ãƒ«ã‚¹åŠ¹æœã‚’è¿½åŠ \n    if (!isManual) {\n      this.addPulseEffect(button);\n      this.addContainerGlow(mode);\n    }\n\n    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ›´æ–°\n    this.input.placeholder = this.getPlaceholderForMode(mode);\n\n    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å…¥åŠ›æ¬„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸Šæ›¸ãæ©Ÿèƒ½\n    if (isManual) {\n      this.clearInputOnModeSwitch(mode);\n    }\n\n    // Importãƒ¢ãƒ¼ãƒ‰å°‚ç”¨å‡¦ç†\n    if (mode === 'import' || this.selectedFile) {\n      this.showImportInterface();\n    } else {\n      this.hideImportInterface();\n    }\n\n    // Deleteãƒ¢ãƒ¼ãƒ‰å°‚ç”¨å‡¦ç†\n    if (mode === 'delete' && isManual) {\n      this.handleDeleteModeSelection();\n    }\n\n    // Modifyãƒ¢ãƒ¼ãƒ‰å°‚ç”¨å‡¦ç†\n    if (mode === 'modify' && isManual) {\n      this.handleModifyModeSelection();\n    }\n\n    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã—ãªã„ï¼ˆUIã§åˆ†ã‹ã‚‹ãŸã‚ï¼‰\n  }\n\n  /**\n   * ãƒ‘ãƒ«ã‚¹åŠ¹æœã‚’è¿½åŠ \n   */\n  addPulseEffect(element) {\n    // æ—¢å­˜ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ\n    element.style.animation = 'none';\n    \n    // å°‘ã—é…ã‚‰ã›ã¦ã‹ã‚‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ï¼ˆãƒªãƒ•ãƒ­ãƒ¼å¼·åˆ¶ï¼‰\n    setTimeout(() => {\n      element.style.animation = 'smartModePulse 0.6s ease-out';\n    }, 10);\n    \n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    setTimeout(() => {\n      element.style.animation = '';\n    }, 610);\n    \n    // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•çš„ã«è¿½åŠ ï¼ˆã¾ã å­˜åœ¨ã—ãªã„å ´åˆï¼‰\n    this.ensurePulseAnimation();\n  }\n\n  /**\n   * ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨CSSã‚’ç¢ºä¿\n   */\n  ensurePulseAnimation() {\n    if (document.getElementById('smart-mode-pulse-animation')) return;\n    \n    const style = document.createElement('style');\n    style.id = 'smart-mode-pulse-animation';\n    style.textContent = `\n      @keyframes smartModePulse {\n        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }\n        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }\n        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  /**\n   * ã‚³ãƒ³ãƒ†ãƒŠã‚°ãƒ­ãƒ¼åŠ¹æœ\n   */\n  addContainerGlow(mode) {\n    const container = this.radioModeContainer;\n    if (!container) return;\n\n    // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ã‚°ãƒ­ãƒ¼è‰²ã‚’è¨­å®š\n    const glowColors = this.isWabiSabiMode ? {\n      generate: 'rgba(139, 195, 74, 0.4)',  // ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ï¼šãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘\n      import: 'rgba(139, 195, 74, 0.4)',    // ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ï¼šãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘\n      modify: 'rgba(139, 195, 74, 0.4)',    // ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ï¼šãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘\n      delete: 'rgba(139, 195, 74, 0.4)'     // ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ï¼šãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘\n    } : {\n      generate: 'rgba(79, 70, 229, 0.4)',   // ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼šå…ƒã®ç´«\n      import: 'rgba(34, 197, 94, 0.4)',     // ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼šå…ƒã®ç·‘\n      modify: 'rgba(236, 72, 153, 0.4)',    // ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼šå…ƒã®ãƒ”ãƒ³ã‚¯\n      delete: 'rgba(107, 114, 128, 0.3)'    // ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼šå…ƒã®ã‚°ãƒ¬ãƒ¼\n    };\n\n    // ä¸€æ™‚çš„ã«ã‚°ãƒ­ãƒ¼åŠ¹æœã‚’é©ç”¨\n    const glowColor = glowColors[mode];\n    if (glowColor) {\n      container.style.boxShadow = `0 0 20px ${glowColor}, 0 0 40px ${glowColor}`;\n      container.style.borderColor = glowColor.replace('0.4', '0.6').replace('0.3', '0.5');\n    }\n    \n    // 1ç§’å¾Œã«ã‚°ãƒ­ãƒ¼åŠ¹æœã‚’é™¤å»\n    setTimeout(() => {\n      container.style.boxShadow = '';\n      container.style.borderColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.15)';\n    }, 1000);\n  }\n\n  getActionButtonStyles(variant = 'secondary') {\n    const baseStyles = `\n      border: none;\n      border-radius: 10px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n      font-weight: 500;\n      backdrop-filter: blur(8px);\n      -webkit-backdrop-filter: blur(8px);\n    `;\n\n    if (variant === 'secondary') {\n      // Clear All, History ãƒœã‚¿ãƒ³ç”¨ - ç¾ã—ã„é…ç½®ã¨çµ±ä¸€æ„Ÿ\n      return baseStyles + `\n        width: 90px;\n        height: 36px;\n        padding: 8px 12px;\n        font-size: 12px;\n        font-weight: 600;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n        background: ${this.isWabiSabiMode\n          ? 'linear-gradient(135deg, rgba(141, 110, 99, 0.3), rgba(109, 76, 65, 0.2))'\n          : (this.isDarkMode\n            ? 'linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2))'\n            : 'linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))')};\n        border: 1px solid ${this.isWabiSabiMode\n          ? 'rgba(93, 64, 55, 0.6)'\n          : (this.isDarkMode ? 'rgba(156, 163, 175, 0.2)' : 'rgba(255, 255, 255, 0.3)')};\n        color: ${this.isWabiSabiMode\n          ? '#F5F5F5'\n          : (this.isDarkMode ? '#d1d5db' : '#374151')};\n        text-align: center;\n        white-space: nowrap;\n      `;\n    } else if (variant === 'icon') {\n      // ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ«ã€è¨­å®šãƒœã‚¿ãƒ³ç”¨\n      return baseStyles + `\n        width: 32px;\n        height: 32px;\n        padding: 0;\n        font-size: 14px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: ${this.isDarkMode \n          ? 'linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1))'\n          : 'linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))'};\n        border: 1px solid ${this.isDarkMode ? 'rgba(99, 102, 241, 0.2)' : 'rgba(255, 255, 255, 0.4)'};\n        color: ${this.isDarkMode ? '#a5b4fc' : '#6366f1'};\n      `;\n    }\n  }\n\n  /**\n   * ç ´å£Šçš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆèµ¤ç³»ã‚¬ãƒ©ã‚¹åŠ¹æœï¼‰\n   */\n  getDestructiveButtonStyles() {\n    return `\n      min-width: 50px;\n      height: 32px;\n      border: 1px solid ${this.isDarkMode ? 'rgba(220, 38, 127, 0.4)' : 'rgba(190, 24, 93, 0.35)'};\n      border-radius: 6px;\n      background: ${this.isDarkMode ? 'rgba(220, 38, 127, 0.3)' : 'rgba(190, 24, 93, 0.25)'};\n      color: ${this.isDarkMode ? '#fca5a5' : '#dc2626'};\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n      font-size: 11px;\n      font-weight: 500;\n      padding: 0 8px;\n      backdrop-filter: blur(10px);\n      -webkit-backdrop-filter: blur(10px);\n    `;\n  }\n\n  getCommandTypeIndicatorStyles() {\n    return `\n      padding: 4px 0;\n      margin-bottom: 0;\n      font-size: 11px;\n      font-weight: 400;\n      text-align: left;\n      color: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.6)' : 'rgba(0, 0, 0, 0.6)'};\n      transition: all 0.3s ease;\n      border: none;\n      background: none;\n    `;\n  }\n\n  /**\n   * ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚ºå‡¦ç†ï¼ˆæœ€å¤§2è¡Œï¼‰\n   */\n  autoResizeTextarea() {\n    // é«˜ã•ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ­£ç¢ºãª scrollHeight ã‚’å–å¾—\n    this.input.style.height = 'auto';\n    \n    // ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åŸºã¥ã„ã¦é«˜ã•ã‚’è¨ˆç®—\n    const lineHeight = 22; // CSS ã§è¨­å®šã—ãŸ line-height\n    const padding = 28; // ä¸Šä¸‹ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆè¨ˆ (14px * 2)\n    const maxLines = 2;\n    const maxHeight = (lineHeight * maxLines) + padding;\n    \n    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é«˜ã•ã«åŸºã¥ã„ã¦æ–°ã—ã„é«˜ã•ã‚’æ±ºå®š\n    const newHeight = Math.min(this.input.scrollHeight, maxHeight);\n    \n    // é«˜ã•ã‚’é©ç”¨\n    this.input.style.height = newHeight + 'px';\n    \n    // 2è¡Œã‚’è¶…ãˆã‚‹å ´åˆã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–ã¨å±•é–‹ãƒœã‚¿ãƒ³è¡¨ç¤º\n    if (this.input.scrollHeight > maxHeight) {\n      this.input.style.overflowY = 'auto';\n      // å±•é–‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º\n      if (this.expandButton) {\n        this.expandButton.style.display = 'flex';\n      }\n    } else {\n      this.input.style.overflowY = 'hidden';\n      // å±•é–‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º\n      if (this.expandButton) {\n        this.expandButton.style.display = 'none';\n      }\n    }\n  }\n\n  /**\n   * ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—æ¤œå‡º\n   */\n  detectCommandType() {\n    const input = this.input.value.trim();\n    if (!input) {\n      this.selectMode('generate', false);\n      return;\n    }\n\n    const commandType = this.analyzeCommandType(input);\n\n    // Delete/Modifyã¯æ‰‹å‹•é¸æŠã‚’å„ªå…ˆã€è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆã—ãªã„\n    if (this.currentMode === 'delete' || this.currentMode === 'modify') {\n      return; // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ç¶­æŒ\n    }\n    // Generate/Importã®ã¿è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ\n    this.selectMode(commandType.type, false, commandType.detectedKeyword);\n  }\n\n  /**\n   * ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚³ãƒãƒ³ãƒ‰åˆ†æ\n   */\n  analyzeCommandType(text) {\n    this.logDebug(`ğŸ” Analyzing command: \"${text}\"`);\n\n    // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—ã®æ¤œå‡º\n    const mediaInfo = this.detectMediaType(text);\n    \n    // å‰Šé™¤ã‚³ãƒãƒ³ãƒ‰ã®æ¤œå‡º\n    const deletePatterns = [\n      { pattern: /å‰Šé™¤/, keyword: 'å‰Šé™¤' },\n      { pattern: /æ¶ˆå»/, keyword: 'æ¶ˆå»' },\n      { pattern: /æ¶ˆã—ã¦/, keyword: 'æ¶ˆã—ã¦' },\n      { pattern: /æ¶ˆã™/, keyword: 'æ¶ˆã™' },\n      { pattern: /å–ã‚Šé™¤/, keyword: 'å–ã‚Šé™¤' },\n      { pattern: /é™¤å»/, keyword: 'é™¤å»' },\n      { pattern: /å‰Šé™¤ã—ã¦/, keyword: 'å‰Šé™¤ã—ã¦' },\n      { pattern: /delete/i, keyword: 'delete' },\n      { pattern: /remove/i, keyword: 'remove' },\n      { pattern: /clear/i, keyword: 'clear' },\n      { pattern: /erase/i, keyword: 'erase' }\n    ];\n    \n    // å¤‰æ›´ãƒ»ç§»å‹•ã‚³ãƒãƒ³ãƒ‰ã®æ¤œå‡º\n    const modifyPatterns = [\n      { pattern: /ç§»å‹•/, keyword: 'ç§»å‹•' },\n      { pattern: /å‹•ã‹ã—ã¦/, keyword: 'å‹•ã‹ã—ã¦' },\n      { pattern: /å¤‰æ›´/, keyword: 'å¤‰æ›´' },\n      { pattern: /å¤‰ãˆã¦/, keyword: 'å¤‰ãˆã¦' },\n      { pattern: /ä¿®æ­£/, keyword: 'ä¿®æ­£' },\n      { pattern: /èª¿æ•´/, keyword: 'èª¿æ•´' },\n      { pattern: /å›è»¢/, keyword: 'å›è»¢' },\n      { pattern: /åè»¢/, keyword: 'åè»¢' },\n      { pattern: /ãƒŸãƒ©ãƒ¼/, keyword: 'ãƒŸãƒ©ãƒ¼' },\n      { pattern: /å‚¾ã‘/, keyword: 'å‚¾ã‘' },\n      { pattern: /å‘ãã‚’å¤‰ãˆ/, keyword: 'å‘ãã‚’å¤‰ãˆ' },\n      { pattern: /å‘ãã‚’å¤‰æ›´/, keyword: 'å‘ãã‚’å¤‰æ›´' },\n      { pattern: /å·¦å³(é€†|åè»¢)/, keyword: 'å·¦å³åè»¢' },\n      { pattern: /ä¸Šä¸‹(é€†|åè»¢)/, keyword: 'ä¸Šä¸‹åè»¢' },\n      { pattern: /é€†ã•/, keyword: 'é€†ã•' },\n      { pattern: /ã²ã£ãã‚Šè¿”/, keyword: 'ã²ã£ãã‚Šè¿”ã™' },\n      { pattern: /.*ã‚’.*è‰²/, keyword: 'è‰²å¤‰æ›´' },\n      { pattern: /.*ã‚’.*ã‚µã‚¤ã‚º/, keyword: 'ã‚µã‚¤ã‚ºå¤‰æ›´' },\n      { pattern: /ã‚’.*ã«.*ã—ã¦/, keyword: 'å¤‰æ›´' },\n      { pattern: /move/i, keyword: 'move' },\n      { pattern: /change/i, keyword: 'change' },\n      { pattern: /modify/i, keyword: 'modify' },\n      { pattern: /edit/i, keyword: 'edit' }\n    ];\n    \n    // ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰ã®æ¤œå‡ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰\n    const generatePatterns = [\n      { pattern: /ä½œã£ã¦/, keyword: 'ä½œã£ã¦' },\n      { pattern: /ç”Ÿæˆ/, keyword: 'ç”Ÿæˆ' },\n      { pattern: /ä½œæˆ/, keyword: 'ä½œæˆ' },\n      { pattern: /æã„ã¦/, keyword: 'æã„ã¦' },\n      { pattern: /æ›¸ã„ã¦/, keyword: 'æ›¸ã„ã¦' },\n      { pattern: /create/i, keyword: 'create' },\n      { pattern: /generate/i, keyword: 'generate' },\n      { pattern: /make/i, keyword: 'make' },\n      { pattern: /draw/i, keyword: 'draw' }\n    ];\n\n    // å‰Šé™¤ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯\n    for (const { pattern, keyword } of deletePatterns) {\n      if (pattern.test(text)) {\n        this.logDebug(`âœ… Delete pattern matched: ${keyword}`);\n        return {\n          type: 'delete',\n          confidence: 0.9,\n          reason: 'å‰Šé™¤ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º',\n          mediaType: mediaInfo.type,\n          requiresConfirmation: true,\n          detectedKeyword: keyword\n        };\n      }\n    }\n    \n    // å¤‰æ›´ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯\n    for (const { pattern, keyword } of modifyPatterns) {\n      if (pattern.test(text)) {\n        this.logDebug(`âœ… Modify pattern matched: ${keyword}`);\n        return {\n          type: 'modify',\n          confidence: 0.8,\n          reason: 'å¤‰æ›´ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º',\n          mediaType: mediaInfo.type,\n          requiresConfirmation: false,\n          detectedKeyword: keyword\n        };\n      }\n    }\n    \n    // ç”Ÿæˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯\n    for (const { pattern, keyword } of generatePatterns) {\n      if (pattern.test(text)) {\n        return {\n          type: 'generate',\n          confidence: mediaInfo.confidence,\n          reason: mediaInfo.reason,\n          mediaType: mediaInfo.type,\n          requiresConfirmation: false,\n          detectedKeyword: keyword\n        };\n      }\n    }\n    \n    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ï¼‰\n    this.logDebug(`â„¹ï¸ No specific pattern matched, defaulting to generate mode`);\n    return {\n      type: 'generate',\n      confidence: mediaInfo.confidence,\n      reason: mediaInfo.reason,\n      mediaType: mediaInfo.type,\n      requiresConfirmation: false,\n      detectedKeyword: null\n    };\n  }\n\n  /**\n   * ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—æ¤œå‡ºï¼ˆç”»åƒ/å‹•ç”»ï¼‰\n   */\n  detectMediaType(text) {\n    const videoPatterns = [\n      /å‹•ç”»|ãƒ“ãƒ‡ã‚ª|æ˜ åƒ|ãƒ ãƒ¼ãƒ“ãƒ¼/,\n      /video|movie|clip/i\n    ];\n    \n    const imagePatterns = [\n      /ç”»åƒ|å†™çœŸ|çµµ|ã‚¤ãƒ©ã‚¹ãƒˆ|ã‚¤ãƒ¡ãƒ¼ã‚¸/,\n      /image|picture|photo|illustration/i\n    ];\n    \n    if (videoPatterns.some(pattern => pattern.test(text))) {\n      return {\n        type: 'video',\n        confidence: 0.8,\n        reason: 'å‹•ç”»ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰'\n      };\n    }\n    \n    if (imagePatterns.some(pattern => pattern.test(text))) {\n      return {\n        type: 'image',\n        confidence: 0.8,\n        reason: 'ç”»åƒç”Ÿæˆã‚³ãƒãƒ³ãƒ‰'\n      };\n    }\n    \n    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç”»åƒ\n    return {\n      type: 'image',\n      confidence: 0.6,\n      reason: 'ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰ï¼ˆç”»åƒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰'\n    };\n  }\n\n  /**\n   * ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º\n   */\n  showCommandTypeIndicator(commandInfo) {\n    const { type, confidence, reason } = commandInfo;\n    \n    const typeLabels = {\n      generate: 'ğŸ¨ ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰',\n      import: 'ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰',\n      modify: 'âœï¸ å¤‰æ›´ãƒ¢ãƒ¼ãƒ‰',\n      delete: 'ğŸ—‘ï¸ å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰'\n    };\n    \n    const typeColors = {\n      generate: 'linear-gradient(135deg, #4f46e5, #4338ca)',\n      import: 'linear-gradient(135deg, #22c55e, #16a34a)',\n      modify: 'linear-gradient(135deg, #ec4899, #be185d)',\n      delete: 'rgba(107, 114, 128, 0.15)'\n    };\n    \n    // Proactive UX: ä½ä¿¡é ¼åº¦æ™‚ã«ææ¡ˆè¡¨ç¤º\n    if (confidence < 0.7) {\n      this.showProactiveSuggestion(type, confidence);\n    } else {\n      this.hideProactiveSuggestion();\n    }\n    \n    // æ—§ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIã«çµ±åˆæ¸ˆã¿ï¼‰\n    // this.commandTypeIndicator.textContent = `â—¯ ${typeLabels[type].replace('ğŸ¨ ', '').replace('âœï¸ ', '').replace('ğŸ—‘ï¸ ', '')}`;\n    // this.commandTypeIndicator.style.display = 'block';\n    // this.commandTypeIndicator.style.cursor = 'default';\n    \n    // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼å¯¾å¿œ\n    this.enableGestureControl();\n  }\n\n  /**\n   * Proactive UX: ä½ä¿¡é ¼åº¦æ™‚ã®ææ¡ˆè¡¨ç¤º\n   */\n  showProactiveSuggestion(detectedType, confidence) {\n    if (!this.proactiveSuggestion) {\n      this.proactiveSuggestion = document.createElement('div');\n      this.proactiveSuggestion.id = 'proactive-suggestion';\n      this.proactiveSuggestion.style.cssText = `\n        margin-bottom: 0;\n        padding: 10px;\n        background: rgba(255, 193, 7, 0.15);\n        border: 1px solid rgba(255, 193, 7, 0.3);\n        border-radius: 8px;\n        font-size: 12px;\n        color: #ffc107;\n        text-align: center;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      `;\n      // æ—§ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIã«çµ±åˆæ¸ˆã¿ï¼‰\n      // ä»£ã‚ã‚Šã«å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‰ã«æŒ¿å…¥\n      this.container.insertBefore(this.proactiveSuggestion, this.input);\n    }\n\n    const alternativeTypes = ['generate', 'modify', 'delete'].filter(t => t !== detectedType);\n    const suggestion = alternativeTypes[0]; // æœ€åˆã®ä»£æ›¿æ¡ˆ\n\n    const suggestionLabels = {\n      generate: 'ğŸ¨ ç”Ÿæˆ',\n      modify: 'âœï¸ å¤‰æ›´', \n      delete: 'ğŸ—‘ï¸ å‰Šé™¤'\n    };\n\n    this.proactiveSuggestion.innerHTML = `\n      ğŸ’¡ ã‚‚ã—ã‹ã—ã¦ã€Œ${suggestionLabels[suggestion]}ãƒ¢ãƒ¼ãƒ‰ã€ã§ã™ã‹ï¼Ÿ\n      <div style=\"margin-top: 4px; font-size: 10px; opacity: 0.8;\">\n        ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´ | ã‚¹ãƒ¯ã‚¤ãƒ—ã§é¸æŠ\n      </div>\n    `;\n    \n    this.proactiveSuggestion.style.display = 'block';\n    \n    // ã‚¯ãƒªãƒƒã‚¯ã§ææ¡ˆãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´\n    this.proactiveSuggestion.onclick = () => {\n      this.currentMode = suggestion;\n      this.hideProactiveSuggestion();\n      this.updateIndicatorForMode(suggestion, 0.9);\n    };\n  }\n\n  /**\n   * Proactive UXææ¡ˆã‚’éè¡¨ç¤º\n   */\n  hideProactiveSuggestion() {\n    if (this.proactiveSuggestion) {\n      this.proactiveSuggestion.style.display = 'none';\n    }\n  }\n\n  /**\n   * æŒ‡å®šãƒ¢ãƒ¼ãƒ‰ã§ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°\n   */\n  updateIndicatorForMode(mode, confidence) {\n    const typeLabels = {\n      generate: 'ğŸ¨ ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰',\n      import: 'ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰',\n      modify: 'âœï¸ å¤‰æ›´ãƒ¢ãƒ¼ãƒ‰',\n      delete: 'ğŸ—‘ï¸ å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰'\n    };\n    \n    const typeColors = {\n      generate: 'linear-gradient(135deg, #4f46e5, #4338ca)',\n      import: 'linear-gradient(135deg, #22c55e, #16a34a)',\n      modify: 'linear-gradient(135deg, #ec4899, #be185d)',\n      delete: 'rgba(107, 114, 128, 0.15)'\n    };\n\n    // æ—§ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIã«çµ±åˆæ¸ˆã¿ï¼‰\n    // this.commandTypeIndicator.textContent = `â—¯ ${typeLabels[mode].replace('ğŸ¨ ', '').replace('âœï¸ ', '').replace('ğŸ—‘ï¸ ', '')}`;\n  }\n\n  /**\n   * ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æœ‰åŠ¹åŒ–\n   */\n  enableGestureControl() {\n    // æ—§ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼æ©Ÿèƒ½ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIã«çµ±åˆæ¸ˆã¿ï¼‰\n    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§ç›´æ¥ãƒ¢ãƒ¼ãƒ‰é¸æŠå¯èƒ½ã«ãªã£ãŸãŸã‚ã€ã‚¹ãƒ¯ã‚¤ãƒ—æ“ä½œã¯ä¸è¦\n    this.gestureEnabled = true;\n  }\n\n  /**\n   * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ä½œæˆ\n   */\n  createActionButtons() {\n    const container = document.createElement('div');\n    container.style.cssText = `\n      display: flex;\n      margin-top: 8px;\n      gap: 8px;\n    `;\n\n    // å±¥æ­´ãƒœã‚¿ãƒ³å‰Šé™¤ - ã‚¿ã‚¹ã‚¯é€²è¡ŒçŠ¶æ³ã«ç½®ãæ›ãˆæ¸ˆã¿\n\n    // ã‚¯ãƒªã‚¢ã‚ªãƒ¼ãƒ«ãƒœã‚¿ãƒ³\n    const clearBtn = document.createElement('button');\n    clearBtn.innerHTML = 'ğŸ§¹ å…¨å‰Šé™¤';\n    clearBtn.style.cssText = this.getModernButtonStyles('danger');\n    clearBtn.addEventListener('click', () => this.clearAll());\n\n    // historyBtnå‰Šé™¤æ¸ˆã¿\n    container.appendChild(clearBtn);\n\n    return container;\n  }\n\n  /**\n   * ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©\n   */\n  getContainerStyles() {\n    const positions = {\n      'bottom-right': 'bottom: 20px; right: 20px;',\n      'bottom-left': 'bottom: 20px; left: 20px;',\n      'top-right': 'top: 20px; right: 20px;',\n      'top-left': 'top: 20px; left: 20px;',\n      'center': 'top: 50%; left: 50%; transform: translate(-50%, -50%);'\n    };\n\n    // 2025 Glassmorphismä»•æ§˜ï¼šãƒ€ãƒ¼ã‚¯ãƒ»ãƒ©ã‚¤ãƒˆä¸¡å¯¾å¿œ\n    const glassmorphismDark = {\n      background: 'linear-gradient(135deg, rgba(15, 23, 42, 0.7), rgba(30, 27, 75, 0.65))',\n      backdropFilter: 'blur(24px) saturate(180%)',\n      border: '1px solid rgba(99, 102, 241, 0.2)',\n      boxShadow: '0 8px 32px rgba(15, 23, 42, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1)'\n    };\n\n    const glassmorphismLight = {\n      background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))',\n      backdropFilter: 'blur(24px) saturate(180%)',\n      border: '1px solid rgba(255, 255, 255, 0.4)',\n      boxShadow: '0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3)'\n    };\n\n    // ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ - æ¯å±±æ°´ã®é™å¯‚ï¼šç‹¬è‡ªã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£\n    const glassmorphismWabiSabi = {\n      background: 'linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))',\n      backdropFilter: 'blur(20px) saturate(120%)',\n      border: '1px solid rgba(93, 64, 55, 0.5)',\n      boxShadow: '0 8px 32px rgba(33, 33, 33, 0.4), 0 0 0 1px rgba(93, 64, 55, 0.4), inset 0 1px 0 rgba(189, 189, 189, 0.15)'\n    };\n\n    const theme = this.isWabiSabiMode ? glassmorphismWabiSabi : (this.isDarkMode ? glassmorphismDark : glassmorphismLight);\n\n    return `\n      position: fixed;\n      ${positions[this.config.position] || positions['bottom-right']}\n      width: 320px;\n      max-height: ${this.config.maxHeight}px;\n      background: ${theme.background};\n      border: ${theme.border};\n      border-radius: 20px;\n      color: ${this.isWabiSabiMode ? '#F5F5F5' : (this.isDarkMode ? '#ffffff' : '#1f2937')};\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;\n      font-size: 14px;\n      z-index: 1000;\n      padding: 16px !important;\n      box-shadow: ${theme.boxShadow};\n      backdrop-filter: ${theme.backdropFilter};\n      -webkit-backdrop-filter: ${theme.backdropFilter};\n      display: none;\n      flex-direction: column;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    `;\n  }\n\n  getHeaderStyles() {\n    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã¨åŒã˜ç´«ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§çµ±ä¸€\n    const gradientColors = 'linear-gradient(135deg, #4f46e5, #7c3aed)';\n\n    return `\n      margin-bottom: 20px;\n      text-align: center;\n      background: ${gradientColors};\n      -webkit-background-clip: text;\n      -webkit-text-fill-color: transparent;\n      background-clip: text;\n      font-weight: 800;\n      font-size: 18px;\n      border-bottom: 1px solid rgba(79, 70, 229, 0.2);\n      padding-bottom: 12px;\n    `;\n  }\n\n  getOutputStyles() {\n    // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®CSSã‚’æ³¨å…¥\n    this.addScrollbarStyles();\n\n    return `\n      height: 200px;\n      overflow-y: auto;\n      background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.1)'};\n      border: 1px solid ${this.isDarkMode ? 'rgba(255, 255, 255, 0.15)' : 'rgba(255, 255, 255, 0.2)'};\n      border-radius: 12px;\n      padding: 12px;\n      margin-bottom: 16px;\n      font-size: 12px;\n      line-height: 1.4;\n      backdrop-filter: blur(8px);\n\n      /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */\n      scrollbar-width: thin;\n      scrollbar-color: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.3) rgba(0, 0, 0, 0.1)'};\n    `;\n  }\n\n  /**\n   * ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒšãƒ¼ã‚¸ã«æ³¨å…¥\n   */\n  addScrollbarStyles() {\n    if (document.getElementById('custom-scrollbar-styles')) return;\n\n    const style = document.createElement('style');\n    style.id = 'custom-scrollbar-styles';\n    style.textContent = `\n      .command-output::-webkit-scrollbar {\n        width: 8px;\n      }\n\n      .command-output::-webkit-scrollbar-track {\n        background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'};\n        border-radius: 4px;\n      }\n\n      .command-output::-webkit-scrollbar-thumb {\n        background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.3)' : 'rgba(0, 0, 0, 0.3)'};\n        border-radius: 4px;\n        transition: background 0.2s ease;\n      }\n\n      .command-output::-webkit-scrollbar-thumb:hover {\n        background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.5)' : 'rgba(0, 0, 0, 0.5)'};\n      }\n\n      /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ */\n      .dark-mode .command-output::-webkit-scrollbar-track {\n        background: rgba(255, 255, 255, 0.1);\n      }\n\n      .dark-mode .command-output::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      .dark-mode .command-output::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.5);\n      }\n\n      /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ */\n      .light-mode .command-output::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.1);\n      }\n\n      .light-mode .command-output::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      .light-mode .command-output::-webkit-scrollbar-thumb:hover {\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      @keyframes shimmer {\n        0% { background-position: -200% 0; }\n        100% { background-position: 200% 0; }\n      }\n\n      /* ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ›ãƒãƒ¼åŠ¹æœ */\n      .task-status-container:hover .progress-bar {\n        box-shadow: 0 0 20px rgba(255,123,71,0.6) !important;\n        transform: scaleY(1.1);\n      }\n\n      /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®å¾®ç´°ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */\n      .progress-bar {\n        position: relative;\n      }\n\n      .progress-bar::after {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: linear-gradient(90deg, \n          transparent, \n          rgba(255,255,255,0.4), \n          transparent);\n        animation: progress-shine 2s ease-in-out infinite;\n      }\n\n      @keyframes progress-shine {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(100%); }\n      }\n\n      /* wabi-sabiãƒ¢ãƒ¼ãƒ‰ç”¨ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */\n      .wabisabi-mode textarea:focus,\n      .wabisabi-mode input:focus {\n        background: linear-gradient(135deg, rgba(97, 97, 97, 0.4), rgba(66, 66, 66, 0.3)) !important;\n        border: 1px solid rgba(141, 110, 99, 0.6) !important;\n        box-shadow: 0 4px 16px rgba(66, 66, 66, 0.3), inset 0 1px 0 rgba(189, 189, 189, 0.2), 0 0 0 2px rgba(141, 110, 99, 0.2) !important;\n        color: #F5F5F5 !important;\n        outline: none !important;\n      }\n    `;\n\n    document.head.appendChild(style);\n  }\n\n  getInputStyles() {\n    // 2025 Glassmorphismä»•æ§˜ï¼šå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰\n    const glassmorphismDark = {\n      background: 'linear-gradient(135deg, rgba(30, 27, 75, 0.4), rgba(15, 23, 42, 0.5))',\n      border: '1px solid rgba(99, 102, 241, 0.25)',\n      boxShadow: '0 4px 16px rgba(15, 23, 42, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08)'\n    };\n\n    const glassmorphismLight = {\n      background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))',\n      border: '1px solid rgba(255, 255, 255, 0.5)',\n      boxShadow: '0 4px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.4)'\n    };\n\n    const glassmorphismWabiSabi = {\n      background: 'linear-gradient(135deg, rgba(97, 97, 97, 0.4), rgba(66, 66, 66, 0.3))',\n      border: '1px solid rgba(97, 97, 97, 0.5)',\n      boxShadow: '0 4px 16px rgba(66, 66, 66, 0.3), inset 0 1px 0 rgba(189, 189, 189, 0.2)'\n    };\n\n    const theme = this.isWabiSabiMode ? glassmorphismWabiSabi : (this.isDarkMode ? glassmorphismDark : glassmorphismLight);\n\n    return `\n      width: 100%;\n      padding: 14px 16px;\n      background: ${theme.background};\n      border: ${theme.border};\n      border-radius: 14px;\n      color: ${this.isWabiSabiMode ? '#F5F5F5' : (this.isDarkMode ? '#ffffff' : '#1f2937')};\n      font-size: 14px;\n      outline: none;\n      box-sizing: border-box;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      font-family: inherit;\n      backdrop-filter: blur(16px);\n      -webkit-backdrop-filter: blur(16px);\n      box-shadow: ${theme.boxShadow};\n      placeholder-color: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.5)' : 'rgba(55, 65, 81, 0.6)'};\n      resize: none;\n      overflow-y: hidden;\n      min-height: 22px;\n      max-height: 66px;\n      line-height: 22px;\n    `;\n  }\n\n  getModernButtonStyles(type) {\n    const styles = {\n      primary: this.isWabiSabiMode ? `\n        background: linear-gradient(135deg, #8D6E63, #6D4C41);\n        box-shadow: 0 4px 12px rgba(85, 139, 47, 0.4), inset 0 1px 0 rgba(184, 158, 135, 0.15);\n        width: 100%;\n        padding: 16px;\n        font-size: 14px;\n        font-weight: 600;\n      ` : `\n        background: linear-gradient(135deg, #4f46e5, #4338ca);\n        width: 100%;\n        padding: 16px;\n        font-size: 14px;\n        font-weight: 600;\n      `,\n      secondary: this.isWabiSabiMode ? `\n        background: rgba(158, 158, 158, 0.2);\n        border: 1px solid rgba(141, 110, 99, 0.4);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #F5F5F5;\n      ` : `\n        background: rgba(255, 255, 255, 0.08);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n      `,\n      danger: this.isWabiSabiMode ? `\n        background: rgba(141, 110, 99, 0.3);\n        border: 1px solid rgba(93, 64, 55, 0.5);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #F5F5F5;\n      ` : `\n        background: rgba(255, 59, 48, 0.15);\n        border: 1px solid rgba(255, 59, 48, 0.3);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #ff453a;\n      `\n    };\n\n    return `\n      border: none;\n      border-radius: 12px;\n      color: white;\n      cursor: pointer;\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      font-family: inherit;\n      outline: none;\n      ${styles[type]}\n    `;\n  }\n\n  getModeButtonStyles(isActive, mode) {\n    // ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ©ãƒ¼è¨­å®š\n    const modeColors = {\n      generate: 'linear-gradient(135deg, #22c55e, #16a34a)', // Green - ãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘è‰²\n      import: 'linear-gradient(135deg, #22c55e, #16a34a)',   // Green - ãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘è‰²\n      modify: 'linear-gradient(135deg, #22c55e, #16a34a)',    // Green - ãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘è‰²\n      delete: 'linear-gradient(135deg, #22c55e, #16a34a)'     // Green - ãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘è‰²\n    };\n    \n    return `\n      flex: 1;\n      padding: 12px 16px;\n      border: none;\n      border-radius: 8px;\n      color: ${isActive ? 'white' : (this.isWabiSabiMode ? '#F5F5F5' : 'rgba(255, 255, 255, 0.7)')};\n      background: ${isActive ? modeColors[mode] : 'transparent'};\n      font-size: 13px;\n      font-weight: 600;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n    `;\n  }\n\n  /**\n   * ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°\n   */\n  bindEvents() {\n    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ\n    document.addEventListener('keydown', (e) => {\n      // è¨­å®šã•ã‚ŒãŸã‚­ãƒ¼ã§UIè¡¨ç¤ºåˆ‡æ›¿\n      if (e.key === this.config.activationKey) {\n        e.preventDefault();\n        this.toggle();\n        return;\n      }\n      \n      // Enterã‚­ãƒ¼å‡¦ç†ã¯initUI()å†…ã§è¡Œã†ãŸã‚ã€ã“ã“ã§ã¯å‡¦ç†ã—ãªã„\n      // ï¼ˆIMEå¯¾å¿œã®ãŸã‚ï¼‰\n      \n      // Escapeã§éè¡¨ç¤º\n      if (this.isVisible && e.key === 'Escape') {\n        this.hide();\n      }\n      \n      // Ctrl+Z/Ctrl+Y ã§Undo/Redo\n      if (this.isVisible && e.ctrlKey) {\n        if (e.key === 'z' && !e.shiftKey) {\n          e.preventDefault();\n          this.undo();\n        } else if (e.key === 'y' || (e.key === 'z' && e.shiftKey)) {\n          e.preventDefault();\n          this.redo();\n        }\n      }\n    });\n\n    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´\n    this.input.addEventListener('focus', () => {\n      this.input.style.borderColor = '#74b9ff';\n      this.input.style.boxShadow = '0 0 5px rgba(116, 185, 255, 0.5)';\n    });\n\n    this.input.addEventListener('blur', () => {\n      this.input.style.borderColor = '#4a90e2';\n      this.input.style.boxShadow = 'none';\n    });\n  }\n\n  /**\n   * UIè¡¨ç¤º/éè¡¨ç¤ºåˆ‡æ›¿\n   */\n  toggle() {\n    if (this.isVisible) {\n      this.hide();\n    } else {\n      this.show();\n    }\n  }\n\n  /**\n   * UIè¡¨ç¤º\n   */\n  show() {\n    this.container.style.display = 'flex';\n    this.container.style.flexDirection = 'column';\n    this.floatingContainer.style.display = 'flex';\n\n    // UIãƒ•ã‚©ãƒ¼ãƒ ã®ä½ç½®ã«åˆã‚ã›ã¦é…ç½®ï¼ˆå°‘ã—é…å»¶ã—ã¦æ­£ç¢ºãªä½ç½®ã‚’å–å¾—ï¼‰\n    setTimeout(() => {\n      const containerRect = this.container.getBoundingClientRect();\n      this.floatingContainer.style.left = containerRect.left + 'px';\n      this.floatingContainer.style.top = (containerRect.top - 80) + 'px';\n      this.floatingContainer.style.width = containerRect.width + 'px';\n      this.floatingContainer.style.transform = 'none';\n    }, 50);\n\n    this.isVisible = true;\n    this.input.focus();\n\n    // ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºä¸­ã¯ãƒãƒ§ã‚³ã‚¢ã‚¤ã‚³ãƒ³ã‚’éš ã™\n    if (this.floatingChocolateIcon) {\n      this.floatingChocolateIcon.style.opacity = '0';\n      this.floatingChocolateIcon.style.pointerEvents = 'none';\n    }\n\n    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–\n    this.onControlsToggle(true);\n    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«åœæ­¢æ™‚ã‚‚é™ã‹ã«\n  }\n\n  /**\n   * UIéè¡¨ç¤º\n   */\n  hide() {\n    this.container.style.display = 'none';\n    this.floatingContainer.style.display = 'none';\n    this.isVisible = false;\n\n    // ãƒ•ã‚©ãƒ¼ãƒ éè¡¨ç¤ºæ™‚ã¯ãƒãƒ§ã‚³ã‚¢ã‚¤ã‚³ãƒ³ã‚’å†è¡¨ç¤º\n    if (this.floatingChocolateIcon) {\n      this.floatingChocolateIcon.style.opacity = '0.8';\n      this.floatingChocolateIcon.style.pointerEvents = 'auto';\n    }\n\n    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å†æœ‰åŠ¹åŒ–\n    this.onControlsToggle(false);\n    this.logDebug('ğŸ® ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å†é–‹');\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ\n   */\n  switchMode(mode) {\n    if (this.currentMode === mode) return;\n    \n    this.currentMode = mode;\n    \n    // ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°\n    this.container.querySelectorAll('[data-mode]').forEach(btn => {\n      const isActive = btn.dataset.mode === mode;\n      btn.style.cssText = this.getModeButtonStyles(isActive, btn.dataset.mode);\n    });\n    \n    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ›´æ–°\n    this.input.placeholder = this.getPlaceholderForMode(mode);\n    \n    // å®Ÿè¡Œãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«ã¨è‰²æ›´æ–°\n    const executeBtn = this.container.querySelector('#execute-btn');\n    const labels = {\n      generate: 'ğŸ¨ Generate Object',\n      modify: 'âœï¸ Apply Changes', \n      delete: 'ğŸ—‘ï¸ Delete Objects'\n    };\n    \n    const buttonColors = {\n      generate: 'linear-gradient(135deg, #5b21b6, #4c1d95)',\n      modify: 'linear-gradient(135deg, #ec4899, #be185d)', \n      delete: 'rgba(107, 114, 128, 0.15)'\n    };\n    \n    executeBtn.innerHTML = `<span>${labels[mode]}</span>`;\n    executeBtn.style.background = buttonColors[mode];\n    \n    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆé€šçŸ¥ã¯ä¸è¦ï¼ˆãƒœã‚¿ãƒ³ã§åˆ†ã‹ã‚‹ãŸã‚ï¼‰\n  }\n  \n  /**\n   * ãƒ¢ãƒ¼ãƒ‰åˆ¥ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼\n   */\n  getPlaceholderForMode(mode) {\n    const placeholders = {\n      generate: 'ã€ŒçŒ«ã®ç”»åƒã‚’ä½œã£ã¦ã€ã¨è©±ã—ã‹ã‘ã¦ â âœ¨',\n      import: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ â ğŸ“',\n      modify: 'é¸æŠå¾Œã€Œãƒ”ãƒ³ã‚¯ã«å¤‰æ›´ã€ã¨ä¼ãˆã¦ â âœï¸',\n      delete: 'é¸æŠå¾Œã€ã‚³ãƒãƒ³ãƒ‰ã‚’ãã®ã¾ã¾é€ã£ã¦ â ğŸ—‘ï¸'\n    };\n    return placeholders[mode] || placeholders.generate;\n  }\n\n  /**\n   * ãƒ‡ãƒ¢ç‰ˆå°‚ç”¨: å‘ããƒ»åè»¢ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å‡¦ç†\n   */\n  handleDemoOrientationCommand(command) {\n    if (!this.sceneManager) {\n      return null;\n    }\n\n    const normalized = command.toLowerCase();\n    const wantsVerticalFlip = /ä¸Šä¸‹|é€†ã•|ã•ã‹ã•|ã²ã£ãã‚Šè¿”/.test(normalized);\n    const wantsHorizontalFlip = /å·¦å³|å‘ãã‚’å¤‰ãˆ|å‘ãã‚’å¤‰æ›´|æ¨ªå‘ã|ãƒŸãƒ©ãƒ¼|åè»¢/.test(normalized);\n    const wantsRotateRight = /å³å‘ã|å³ã‚’å‘|å³ã«å‘ã‘/.test(normalized);\n    const wantsRotateLeft = /å·¦å‘ã|å·¦ã‚’å‘|å·¦ã«å‘ã‘/.test(normalized);\n    const wantsRotateBack = /å¾Œã‚å‘ã|åå¯¾å‘ã|èƒŒä¸­|180åº¦|åŠå›è»¢/.test(normalized);\n\n    const hasOrientationKeyword = wantsVerticalFlip || wantsHorizontalFlip || wantsRotateRight || wantsRotateLeft || wantsRotateBack;\n    if (!hasOrientationKeyword) {\n      return null;\n    }\n\n    let targetObject = this.sceneManager.selectedObject;\n    if (!targetObject && typeof this.sceneManager.findObjectByKeyword === 'function') {\n      targetObject = this.sceneManager.findObjectByKeyword(normalized);\n      if (targetObject) {\n        this.sceneManager.selectObject(targetObject);\n      }\n    }\n\n    if (!targetObject) {\n      this.addOutput('âš ï¸ å¤‰æ›´ã—ãŸã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„ã€‚', 'warning');\n      return { handled: true, result: { success: false, message: 'å¯¾è±¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ' } };\n    }\n\n    const operations = [];\n\n    if (wantsHorizontalFlip) {\n      const currentX = targetObject.scale.x === 0 ? 1 : targetObject.scale.x;\n      targetObject.scale.x = -currentX;\n      operations.push('å·¦å³åè»¢');\n    }\n\n    if (wantsVerticalFlip) {\n      const currentY = targetObject.scale.y === 0 ? 1 : targetObject.scale.y;\n      targetObject.scale.y = -currentY;\n      operations.push('ä¸Šä¸‹åè»¢');\n    }\n\n    if (wantsRotateRight) {\n      targetObject.rotation.y = Math.PI / 2;\n      operations.push('å³å‘ã');\n    }\n\n    if (wantsRotateLeft) {\n      targetObject.rotation.y = -Math.PI / 2;\n      operations.push('å·¦å‘ã');\n    }\n\n    if (wantsRotateBack) {\n      targetObject.rotation.y = Math.PI;\n      operations.push('èƒŒé¢å‘ã');\n    }\n\n    if (operations.length === 0) {\n      // ã“ã“ã¾ã§æ¥ã¦æ“ä½œãŒç„¡ã‘ã‚Œã° SceneManager ã«å§”è­²\n      return { handled: false };\n    }\n\n    // å¤‰æ›´å±¥æ­´ã‚’è¿½åŠ \n    targetObject.userData = targetObject.userData || {};\n    targetObject.userData.modifications = targetObject.userData.modifications || [];\n    targetObject.userData.modifications.push({\n      timestamp: Date.now(),\n      type: 'orientation',\n      operations,\n      command\n    });\n\n    // é¸æŠè¡¨ç¤ºã‚’æ›´æ–°\n    if (typeof this.sceneManager.createModernSelectionIndicator === 'function') {\n      this.sceneManager.createModernSelectionIndicator(targetObject);\n    }\n\n    const message = `âœï¸ ${operations.join('ãƒ»')} ã‚’é©ç”¨ã—ã¾ã—ãŸ`;\n    this.addOutput(message, 'success');\n\n    return {\n      handled: true,\n      result: {\n        success: true,\n        message,\n        objectId: targetObject.name,\n        operations\n      }\n    };\n  }\n\n  /**\n   * ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ\n   */\n  async executeCommand() {\n    const command = this.input.value.trim();\n    if (!command) return;\n\n    // æœ€çµ‚çš„ãªã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—åˆ¤å®š\n    const commandType = this.analyzeCommandType(command);\n\n    if (this.selectedFile) {\n      if (this.currentMode !== 'import') {\n        this.selectMode('import', false);\n      }\n      this.currentMode = 'import';\n    } else {\n      this.currentMode = commandType.type;\n    }\n\n    // å‰Šé™¤ã®å ´åˆã¯ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°\n    if (commandType.requiresConfirmation) {\n      const confirmed = await this.showDeleteConfirmation(command);\n      if (!confirmed) {\n        this.addOutput('âŒ å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'system');\n        return;\n      }\n    }\n\n    // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢\n    this.input.value = '';\n    // æ—§ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIã«çµ±åˆæ¸ˆã¿ï¼‰\n    // this.commandTypeIndicator.style.display = 'none';\n    this.hideProactiveSuggestion();\n\n    // ã‚³ãƒãƒ³ãƒ‰è¡¨ç¤ºï¼ˆãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—ä»˜ãï¼‰\n    const mediaIcon = commandType.mediaType === 'video' ? 'ğŸ¬' : 'ğŸ–¼ï¸';\n    // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ä½œæˆ\n    const taskId = this.addTaskCard(command, { status: 'processing' });\n\n    // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå‰ã®çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜\n    this.saveCommandToHistory({\n      command: command,\n      mode: this.currentMode,\n      mediaType: commandType.mediaType,\n      timestamp: Date.now()\n    });\n\n    try {\n      // å‡¦ç†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º\n      // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã¯æ—¢ã«1183è¡Œç›®ã§ä½œæˆæ¸ˆã¿ï¼ˆtaskIdå¤‰æ•°ï¼‰\n      // é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½œæˆã—ãªã„\n\n      let result;\n      \n      // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸã‚³ãƒãƒ³ãƒ‰å‡¦ç†\n      const modePrefix = this.getModePrefix(this.currentMode);\n      const fullCommand = `${modePrefix}${command}`;\n\n      // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®å®Ÿè¡Œå‡¦ç†\n      this.logDebug('ğŸ” Current mode check:', this.currentMode);\n      if (this.currentMode === 'import') {\n        this.logDebug('ğŸ“ Import mode detected - bypassing SceneManager');\n        // Importãƒ¢ãƒ¼ãƒ‰: ç›´æ¥å‡¦ç†ï¼ˆSceneManagerã‚’è¿‚å›ï¼‰\n        if (!this.selectedFile) {\n          throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');\n        }\n        result = await this.handleImportCommand(command);\n      } else if (this.sceneManager) {\n        if (this.currentMode === 'modify') {\n          const orientationResult = this.handleDemoOrientationCommand(command);\n          if (orientationResult && orientationResult.handled) {\n            result = orientationResult.result;\n          } else {\n            result = await this.sceneManager.executeCommand(fullCommand);\n          }\n        } else {\n          result = await this.sceneManager.executeCommand(fullCommand);\n        }\n      } else if (this.client) {\n        // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’é¸æŠ\n        if (this.currentMode === 'generate') {\n          // ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰: æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ\n          if (commandType.mediaType === 'video') {\n            result = await this.client.generateVideo(command, {\n              model: this.selectedVideoService || undefined\n            });\n          } else {\n            result = await this.client.generateImage(command, {\n              service: this.selectedImageService || undefined\n            });\n          }\n        } else if (this.currentMode === 'modify') {\n          // å¤‰æ›´ãƒ¢ãƒ¼ãƒ‰: æ—¢å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤‰æ›´ï¼ˆé¸æŠãŒå¿…è¦ï¼‰\n          if (!this.selectedObject) {\n            throw new Error('å¤‰æ›´ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšå¯¾è±¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');\n          }\n          result = await this.client.modifySelectedObject(this.selectedObject, command);\n        } else if (this.currentMode === 'delete') {\n          // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠãƒã‚§ãƒƒã‚¯\n          if (!this.selectedObject && !this.sceneManager?.getSelectedObjects()?.length) {\n            this.addOutput('âš ï¸ å‰Šé™¤ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãš3Dã‚·ãƒ¼ãƒ³å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã—ã¦ã‹ã‚‰ã€å†åº¦Deleteãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'system');\n            return;\n          }\n          // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰: ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰å‰Šé™¤\n          const confirmMessage = `æœ¬å½“ã«ã€Œ${command}ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;\n          if (!confirm(confirmMessage)) {\n            this.addOutput('âŒ å‰Šé™¤ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'system');\n            return;\n          }\n          result = await this.client.deleteObjects(command);\n        } else {\n          // ãã®ä»–ã®ãƒ¢ãƒ¼ãƒ‰\n          result = await this.client.executeCommand(fullCommand);\n        }\n      } else {\n        throw new Error('SceneManager ã¾ãŸã¯ Client ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');\n      }\n\n      // taskIdå–å¾—ã¨SSEæ¥ç¶šé–‹å§‹\n      if (result && result.taskId) {\n        this.connectToProgress(result.taskId, taskId);\n        this.currentTaskId = result.taskId;\n      }\n\n      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\n      const successMessages = {\n        generate: ``, // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ - çµæœã§ååˆ†\n        modify: 'âœ… å¤‰æ›´ã‚’é©ç”¨ã—ã¾ã—ãŸ',\n        delete: 'ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ'\n      };\n      \n      // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰å®Œäº†\n      if (taskId) {\n        this.updateTaskCard(taskId, 'completed');\n      }\n      \n      // è©³ç´°æƒ…å ±è¡¨ç¤º\n      if (result.modelName) {\n        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‰Šé™¤ - ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç”¨ã«ä¿å­˜\n      }\n      \n      if (result.objectId) {\n        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆIDå‰Šé™¤\n      }\n      \n      if (result.position) {\n        // ä½ç½®æƒ…å ±å‰Šé™¤\n      }\n\n      if (commandType.mediaType) {\n        // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—å‰Šé™¤\n      }\n\n    } catch (error) {\n      const errorMessages = {\n        generate: `âŒ ${commandType.mediaType === 'video' ? 'å‹•ç”»' : 'ç”»åƒ'}ç”Ÿæˆã‚¨ãƒ©ãƒ¼`,\n        modify: 'âŒ å¤‰æ›´ã‚¨ãƒ©ãƒ¼', \n        delete: 'âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼'\n      };\n      // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼\n      if (taskId) {\n        this.updateTaskCard(taskId, 'error');\n      }\n\n      this.addOutput(`${errorMessages[this.currentMode]}: ${error.message}`, 'error');\n      console.error('Command execution error:', error);\n    }\n\n    // 2025å¹´UXãƒˆãƒ¬ãƒ³ãƒ‰: ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå¾Œã®è‡ªå‹•é¸æŠè§£é™¤\n    if (this.sceneManager && this.sceneManager.selectedObject) {\n      // Modify/Deleteã‚³ãƒãƒ³ãƒ‰å¾Œã¯é¸æŠã‚’è‡ªå‹•è§£é™¤ã—ã¦ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›\n      if (this.currentMode === 'modify' || this.currentMode === 'delete') {\n        setTimeout(() => {\n          this.sceneManager.deselectObject();\n        }, 500); // å°‘ã—é…å»¶ã•ã›ã¦æ“ä½œå®Œäº†ã‚’è¦–è¦šçš„ã«ç¢ºèª\n      }\n    }\n\n    // å‡ºåŠ›ã‚¨ãƒªã‚¢ã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«\n    if (this.config.autoScroll) {\n      this.scrollToBottom();\n    }\n  }\n\n  /**\n   * å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°\n   */\n  async showConfirmationDialog(options) {\n    const {\n      icon = 'ğŸ—‘ï¸',\n      title = 'ç¢ºèª',\n      message = 'ã“ã®æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ',\n      confirmText = 'å®Ÿè¡Œ',\n      cancelText = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',\n      confirmColor = '#ef4444'\n    } = options;\n\n    return new Promise((resolve) => {\n      const modal = document.createElement('div');\n      modal.style.cssText = `\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(15, 23, 42, 0.6);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        z-index: 2000;\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n      `;\n\n      const dialog = document.createElement('div');\n      dialog.style.cssText = `\n        background: ${this.isDarkMode \n          ? 'linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(30, 27, 75, 0.8))'\n          : 'linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3))'};\n        border: 1px solid ${this.isDarkMode ? 'rgba(99, 102, 241, 0.3)' : 'rgba(255, 255, 255, 0.5)'};\n        border-radius: 20px;\n        padding: 32px;\n        max-width: 420px;\n        text-align: center;\n        color: ${this.isWabiSabiMode ? '#F5F5F5' : (this.isDarkMode ? '#ffffff' : '#1f2937')};\n        font-family: inherit;\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n        box-shadow: ${this.isDarkMode \n          ? '0 8px 32px rgba(15, 23, 42, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1)'\n          : '0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2)'};\n        transform: scale(0.9);\n        opacity: 0;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      `;\n\n      dialog.innerHTML = `\n        <div style=\"font-size: 56px; margin-bottom: 20px;\">${icon}</div>\n        <h3 style=\"margin: 0 0 16px 0; color: ${this.isDarkMode ? '#a5b4fc' : '#6366f1'}; font-size: 20px; font-weight: 700; letter-spacing: 0.02em;\">\n          ${title}\n        </h3>\n        <p style=\"margin: 0 0 28px 0; color: ${this.isDarkMode ? '#d1d5db' : '#6b7280'}; line-height: 1.6; font-size: 16px;\">\n          ${message}\n        </p>\n        <div style=\"display: flex; gap: 8px; justify-content: center;\">\n          <button id=\"cancel-btn\" style=\"\n            padding: 14px 24px;\n            background: ${this.isDarkMode \n              ? 'linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2))'\n              : 'linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))'};\n            border: 1px solid ${this.isDarkMode ? 'rgba(156, 163, 175, 0.2)' : 'rgba(255, 255, 255, 0.3)'};\n            border-radius: 12px;\n            color: ${this.isDarkMode ? '#d1d5db' : '#374151'};\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 600;\n            transition: all 0.2s ease;\n            backdrop-filter: blur(16px);\n            -webkit-backdrop-filter: blur(16px);\n          \">${cancelText}</button>\n          <button id=\"confirm-btn\" style=\"\n            padding: 14px 24px;\n            background: ${confirmColor === '#6366f1' \n              ? 'linear-gradient(135deg, #6366f1, #8b5cf6)' \n              : confirmColor === '#ef4444'\n              ? 'linear-gradient(135deg, #ef4444, #dc2626)'\n              : 'linear-gradient(135deg, #ff7b47, #f97316)'};\n            border: none;\n            border-radius: 12px;\n            color: white;\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 700;\n            transition: all 0.2s ease;\n            box-shadow: 0 4px 16px ${confirmColor === '#6366f1' \n              ? 'rgba(99, 102, 241, 0.3)' \n              : confirmColor === '#ef4444' \n              ? 'rgba(239, 68, 68, 0.3)' \n              : 'rgba(255, 123, 71, 0.3)'};\n            backdrop-filter: blur(8px);\n            -webkit-backdrop-filter: blur(8px);\n          \">${confirmText}</button>\n        </div>\n      `;\n\n      modal.appendChild(dialog);\n      document.body.appendChild(modal);\n\n      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹\n      requestAnimationFrame(() => {\n        modal.style.opacity = '1';\n        dialog.style.transform = 'scale(1)';\n        dialog.style.opacity = '1';\n      });\n\n      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼\n      dialog.querySelector('#cancel-btn').onclick = () => {\n        this.closeModalWithAnimation(modal);\n        resolve(false);\n      };\n\n      dialog.querySelector('#confirm-btn').onclick = () => {\n        this.closeModalWithAnimation(modal);\n        resolve(true);\n      };\n\n      // ESCã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«\n      const escHandler = (e) => {\n        if (e.key === 'Escape') {\n          this.closeModalWithAnimation(modal);\n          document.removeEventListener('keydown', escHandler);\n          resolve(false);\n        }\n      };\n      document.addEventListener('keydown', escHandler);\n\n      // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«\n      modal.onclick = (e) => {\n        if (e.target === modal) {\n          this.closeModalWithAnimation(modal);\n          resolve(false);\n        }\n      };\n    });\n  }\n\n  async showDeleteConfirmation(command) {\n    return this.showConfirmationDialog({\n      icon: 'ğŸ—‘ï¸',\n      title: 'å‰Šé™¤ã®ç¢ºèª',\n      message: `ã€Œ${command}ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚`,\n      confirmText: 'å‰Šé™¤å®Ÿè¡Œ',\n      cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',\n      confirmColor: '#ff7b47'\n    });\n  }\n\n  /**\n   * å‡ºåŠ›ã‚¨ãƒªã‚¢ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ \n   */\n  /**\n   * ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰è¿½åŠ ï¼ˆå¾“æ¥ã®addOutputã‚’ç½®ãæ›ãˆï¼‰\n   */\n  addOutput(message, type = 'default', options = {}) {\n    // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰å½¢å¼ã§å‡¦ç†\n    if (type === 'task' || type === 'progress') {\n      return this.addTaskCard(message, options);\n    }\n\n    // ã‚¨ãƒ©ãƒ¼ã¨ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¡¨ç¤º\n    if (type === 'error' || type === 'system') {\n      this.addSystemMessage(message, type);\n    }\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰è¿½åŠ \n   */\n  addTaskCard(taskInfo, options = {}) {\n    if (!this.taskCards) this.taskCards = new Map();\n\n    const taskId = options.taskId || `task_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;\n    const status = options.status || 'pending';\n    const prompt = taskInfo.prompt || taskInfo.command || taskInfo;\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ä½œæˆ\n    const card = document.createElement('div');\n    card.className = 'floating-task-card';\n    card.setAttribute('data-task-id', taskId);\n\n    // iOS 26 Liquid Glass + 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«\n    card.style.cssText = this.getFloatingCardStyles(status);\n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨åˆæœŸçŠ¶æ…‹ï¼ˆéè¡¨ç¤ºï¼‰- å¼·åˆ¶è¨­å®š\n    card.style.setProperty('opacity', '0', 'important');\n    card.style.setProperty('transform', 'translateY(20px) scale(0.95)', 'important');\n    card.style.setProperty('filter', 'blur(4px)', 'important');\n\n    const iconMap = {\n      pending: 'â³',\n      processing: 'ğŸ¨',\n      progress: 'âš¡',\n      completed: 'âœ…',\n      error: 'âŒ'\n    };\n\n    const statusText = {\n      pending: 'å¾…æ©Ÿä¸­',\n      processing: 'ç”Ÿæˆä¸­',\n      progress: 'é€²è¡Œä¸­',\n      completed: 'å®Œäº†',\n      error: 'ã‚¨ãƒ©ãƒ¼'\n    };\n\n    // æ¸©ã‹ã¿ã®ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º\n    const friendlyMessage = this.getFriendlyMessage(status, prompt);\n    card.innerHTML = `\n      <span style=\"font-size: 14px;\">${iconMap[status]}</span>\n      <span style=\"font-size: 13px; margin-left: 6px;\">${friendlyMessage}</span>\n    `;\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ ï¼ˆæœ€æ–°ãŒä¸‹ã«æ¥ã‚‹ã‚ˆã†ã«ï¼‰\n    this.floatingContainer.appendChild(card);\n    \n    // ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºåˆ¶é™ã‚’é©ç”¨ï¼ˆæœ€å¤§3å€‹ã¾ã§è¡¨ç¤ºï¼‰\n    this.updateCardDisplayLimit();\n\n    this.taskCards.set(taskId, {\n      element: card,\n      status: status,\n      prompt: prompt,\n      originalPrompt: prompt, // å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\n      startTime: Date.now(),\n      endTime: null,\n      error: null,\n      contentType: 'image', // 'image', 'video', etc.\n      model: null,\n      settings: null\n    });\n\n    // ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼\n    this.addCardDetailEvents(card, taskId);\n    \n    // å…¥å ´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    this.animateCardEntrance(card);\n    return taskId;\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰æ›´æ–°\n   */\n  updateTaskCard(taskId, status, options = {}) {\n    if (!this.taskCards || !this.taskCards.has(taskId)) return;\n\n    const taskData = this.taskCards.get(taskId);\n    const card = taskData.element;\n\n    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°\n    taskData.status = status;\n\n    const iconMap = {\n      pending: 'â³',\n      processing: 'ğŸ¨',\n      progress: 'âš¡',\n      completed: 'âœ…',\n      error: 'âŒ'\n    };\n\n    // æ¸©ã‹ã¿ã®ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°\n    const friendlyMessage = this.getFriendlyMessage(status, taskData.prompt);\n    card.innerHTML = `\n      <span style=\"font-size: 14px;\">${iconMap[status]}</span>\n      <span style=\"font-size: 13px; margin-left: 6px;\">${friendlyMessage}</span>\n    `;\n\n    // å®Œäº†æ™‚ã®è‡ªå‹•æ¶ˆå»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    if (status === 'completed') {\n      this.animateCardSuccess(card, taskId);\n    } else if (status === 'error') {\n      this.animateCardError(card, taskId);\n    }\n  }\n\n  /**\n   * ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º\n   */\n  addSystemMessage(message, type) {\n    const entry = document.createElement('div');\n    entry.className = `system-message ${type}`;\n    entry.style.cssText = `\n      padding: 8px 12px;\n      margin: 4px 0;\n      border-radius: 8px;\n      font-size: 12px;\n      line-height: 1.4;\n      animation: slideIn 0.3s ease-out;\n      background: ${type === 'error' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(107, 114, 128, 0.1)'};\n      border: 1px solid ${type === 'error' ? 'rgba(239, 68, 68, 0.3)' : 'rgba(107, 114, 128, 0.3)'};\n      color: ${type === 'error' ? '#fca5a5' : (this.isDarkMode ? '#d1d5db' : '#6b7280')};\n    `;\n    entry.textContent = message;\n    this.outputDiv.appendChild(entry);\n    this.scrollToBottom();\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«å–å¾—\n   */\n  getTaskCardStyles(status) {\n    const baseStyles = `\n      background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.08)' : 'rgba(255, 255, 255, 0.15)'};\n      border: 1px solid ${this.isDarkMode ? 'rgba(255, 255, 255, 0.15)' : 'rgba(255, 255, 255, 0.25)'};\n      border-radius: 12px;\n      padding: 16px;\n      margin-bottom: 12px;\n      backdrop-filter: blur(12px);\n      transition: all 0.3s ease;\n      animation: slideInUp 0.3s ease-out;\n    `;\n\n    const statusBorders = {\n      pending: 'rgba(167, 139, 250, 0.3)',     // è–„ç´«\n      processing: 'rgba(192, 132, 252, 0.5)',  // ç´«ï¼ˆå¼·èª¿ï¼‰\n      progress: 'rgba(236, 72, 153, 0.4)',     // ãƒ”ãƒ³ã‚¯\n      completed: 'rgba(167, 139, 250, 0.4)',   // ç´«\n      error: 'rgba(239, 68, 68, 0.4)'          // èµ¤\n    };\n\n    return baseStyles + `border-left: 3px solid ${statusBorders[status] || statusBorders.pending};`;\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆiOS 26 Liquid Glass + 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰\n   */\n  getFloatingCardStyles(status) {\n    // 2025å¹´Glassmorphismä»•æ§˜ï¼šãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰\n    const glassmorphismDark = {\n      background: 'linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 27, 75, 0.7))',\n      border: '1px solid rgba(99, 102, 241, 0.25)',\n      boxShadow: '0 8px 32px rgba(15, 23, 42, 0.3), 0 0 0 1px rgba(99, 102, 241, 0.1)',\n      color: '#ffffff'\n    };\n\n    const glassmorphismLight = {\n      background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25))',\n      border: '1px solid rgba(255, 255, 255, 0.4)',\n      boxShadow: '0 8px 32px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.2)',\n      color: '#1f2937'\n    };\n\n    const theme = this.isDarkMode ? glassmorphismDark : glassmorphismLight;\n\n    return `\n      height: 36px;\n      padding: 0 18px;\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n      background: ${theme.background};\n      backdrop-filter: blur(24px) saturate(180%);\n      -webkit-backdrop-filter: blur(24px) saturate(180%);\n      border: ${theme.border};\n      border-radius: 18px;\n      color: ${theme.color};\n      pointer-events: auto;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;\n      font-weight: 600;\n      font-size: 13px;\n      letter-spacing: 0.01em;\n      box-shadow: ${theme.boxShadow};\n      transform: translateY(10px);\n      opacity: 0;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    `;\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºåˆ¶é™ã‚’é©ç”¨ï¼ˆæœ€å¤§3å€‹ã¾ã§è¡¨ç¤ºã€ãã‚Œä»¥ä¸Šã¯ã€Œ+ Nã€ã§è¡¨ç¤ºï¼‰\n   */\n  updateCardDisplayLimit() {\n    const maxVisibleCards = 3;\n    const allCards = Array.from(this.floatingContainer.children).filter(child => \n      !child.classList.contains('overflow-counter')\n    );\n    \n    // æ—¢å­˜ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å‰Šé™¤\n    const existingCounter = this.floatingContainer.querySelector('.overflow-counter');\n    if (existingCounter) {\n      existingCounter.remove();\n    }\n    \n    if (allCards.length <= maxVisibleCards) {\n      // ã‚«ãƒ¼ãƒ‰ãŒ3å€‹ä»¥ä¸‹ã®å ´åˆã€ã™ã¹ã¦è¡¨ç¤º\n      allCards.forEach(card => {\n        card.style.display = 'flex';\n      });\n    } else {\n      // ã‚«ãƒ¼ãƒ‰ãŒ4å€‹ä»¥ä¸Šã®å ´åˆã€æœ€æ–°3å€‹ã®ã¿è¡¨ç¤ºã—ã€æ®‹ã‚Šã¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¡¨ç¤º\n      const visibleCards = allCards.slice(-maxVisibleCards); // æœ€æ–°3å€‹\n      const hiddenCount = allCards.length - maxVisibleCards;\n      \n      // å¤ã„ã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤º\n      allCards.forEach((card, index) => {\n        if (index < allCards.length - maxVisibleCards) {\n          card.style.display = 'none';\n        } else {\n          card.style.display = 'flex';\n        }\n      });\n      \n      // ã€Œ+ Nã€ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ä½œæˆ\n      const counter = document.createElement('div');\n      counter.className = 'overflow-counter';\n      // ãƒ†ãƒ¼ãƒã«å¿œã˜ãŸã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«\n      const counterBaseColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.12)';\n      const counterBorderColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.15)';\n      const counterTextColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.6)';\n      \n      counter.style.cssText = `\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 8px 12px;\n        margin: 4px 0;\n        background: ${counterBaseColor};\n        backdrop-filter: blur(20px);\n        border-radius: 12px;\n        border: 1px solid ${counterBorderColor};\n        font-size: 12px;\n        color: ${counterTextColor};\n        font-weight: 500;\n        min-height: 32px;\n        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n        cursor: pointer;\n      `;\n      counter.innerHTML = `+ ${hiddenCount}`;\n      \n      // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æœ€åˆã«æŒ¿å…¥ï¼ˆæœ€ä¸Šéƒ¨ã«é…ç½®ï¼‰\n      this.floatingContainer.insertBefore(counter, this.floatingContainer.firstChild);\n      \n      // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®ãƒ›ãƒãƒ¼åŠ¹æœï¼ˆãƒ†ãƒ¼ãƒå¯¾å¿œï¼‰\n      const counterHoverColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.12)' : 'rgba(0, 0, 0, 0.18)';\n      \n      counter.addEventListener('mouseenter', () => {\n        counter.style.background = counterHoverColor;\n        counter.style.transform = 'scale(1.05)';\n      });\n      \n      counter.addEventListener('mouseleave', () => {\n        counter.style.background = counterBaseColor;\n        counter.style.transform = 'scale(1)';\n      });\n    }\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã«è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ \n   */\n  addCardDetailEvents(card, taskId) {\n    // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º\n    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;\n    \n    if (isTouchDevice) {\n      // ãƒ¢ãƒã‚¤ãƒ«/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ: ã‚¿ãƒƒãƒ—ã§è©³ç´°è¡¨ç¤º\n      card.addEventListener('click', (e) => {\n        e.preventDefault();\n        e.stopPropagation();\n        this.showTaskDetailModal(taskId);\n      });\n    } else {\n      // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: ãƒ›ãƒãƒ¼ã§è©³ç´°è¡¨ç¤º\n      let hoverTimeout;\n      \n      card.addEventListener('mouseenter', () => {\n        hoverTimeout = setTimeout(() => {\n          this.showTaskDetailModal(taskId);\n        }, 800); // 0.8ç§’ãƒ›ãƒãƒ¼ã§è¡¨ç¤º\n      });\n      \n      card.addEventListener('mouseleave', () => {\n        if (hoverTimeout) {\n          clearTimeout(hoverTimeout);\n        }\n      });\n      \n      // ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚è¡¨ç¤ºï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã‚‚ä½¿ã„ã‚„ã™ãï¼‰\n      card.addEventListener('click', (e) => {\n        e.preventDefault();\n        e.stopPropagation();\n        this.showTaskDetailModal(taskId);\n      });\n    }\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º\n   */\n  showTaskDetailModal(taskId) {\n    const taskData = this.taskCards.get(taskId);\n    if (!taskData) return;\n    \n    // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤\n    const existingModal = document.querySelector('.task-detail-modal');\n    if (existingModal) {\n      existingModal.remove();\n    }\n    \n    // ãƒ¢ãƒ¼ãƒ€ãƒ«ä½œæˆ\n    const modal = this.createTaskDetailModal(taskData);\n    document.body.appendChild(modal);\n    \n    // å…¥å ´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    requestAnimationFrame(() => {\n      modal.style.opacity = '1';\n      modal.querySelector('.modal-content').style.transform = 'translateY(0) scale(1)';\n    });\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®HTMLè¦ç´ ã‚’ä½œæˆ\n   */\n  createTaskDetailModal(taskData) {\n    const modal = document.createElement('div');\n    modal.className = 'task-detail-modal';\n    \n    // ãƒ†ãƒ¼ãƒã«å¿œã˜ãŸã‚¹ã‚¿ã‚¤ãƒ«\n    const overlayColor = this.isDarkMode ? 'rgba(0, 0, 0, 0.6)' : 'rgba(0, 0, 0, 0.4)';\n    const modalBg = this.isDarkMode ? 'rgba(20, 20, 20, 0.95)' : 'rgba(255, 255, 255, 0.95)';\n    const modalBorder = this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';\n    const textColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.9)' : 'rgba(0, 0, 0, 0.9)';\n    const labelColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.6)' : 'rgba(0, 0, 0, 0.6)';\n    \n    modal.style.cssText = `\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: ${overlayColor};\n      backdrop-filter: blur(10px);\n      z-index: 100000;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      transition: opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: pointer;\n    `;\n    \n    // å®Ÿè¡Œæ™‚é–“è¨ˆç®—\n    const duration = taskData.endTime \n      ? ((taskData.endTime - taskData.startTime) / 1000).toFixed(1)\n      : ((Date.now() - taskData.startTime) / 1000).toFixed(1);\n    \n    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º\n    const statusText = taskData.status === 'pending' ? 'å¾…æ©Ÿä¸­' \n                    : taskData.status === 'in-progress' ? 'å®Ÿè¡Œä¸­' \n                    : taskData.status === 'completed' ? 'å®Œäº†' \n                    : 'ã‚¨ãƒ©ãƒ¼';\n    \n    const modalContent = document.createElement('div');\n    modalContent.className = 'modal-content';\n    modalContent.style.cssText = `\n      background: ${modalBg};\n      backdrop-filter: blur(30px);\n      border: 1px solid ${modalBorder};\n      border-radius: 16px;\n      padding: 16px !important;\n      max-width: 400px;\n      width: 90%;\n      max-height: 80vh;\n      overflow-y: auto;\n      transform: translateY(20px) scale(0.95);\n      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: default;\n      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n    `;\n    \n    modalContent.innerHTML = `\n      <div style=\"display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;\">\n        <h3 style=\"margin: 0; color: ${textColor}; font-size: 18px; font-weight: 600;\">ã‚¿ã‚¹ã‚¯è©³ç´°</h3>\n        <button class=\"close-btn\" style=\"\n          background: none;\n          border: none;\n          font-size: 24px;\n          color: ${labelColor};\n          cursor: pointer;\n          padding: 0;\n          line-height: 1;\n          transition: color 0.2s;\n        \">Ã—</button>\n      </div>\n      \n      <div style=\"space-y: 16px;\">\n        <div>\n          <div style=\"color: ${labelColor}; font-size: 12px; font-weight: 500; margin-bottom: 0;\">ğŸ“ å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</div>\n          <div style=\"color: ${textColor}; font-size: 14px; line-height: 1.4;\">${taskData.originalPrompt}</div>\n        </div>\n        \n        <div>\n          <div style=\"color: ${labelColor}; font-size: 12px; font-weight: 500; margin-bottom: 0;\">ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>\n          <div style=\"color: ${textColor}; font-size: 14px;\">${statusText}</div>\n        </div>\n        \n        <div>\n          <div style=\"color: ${labelColor}; font-size: 12px; font-weight: 500; margin-bottom: 0;\">â±ï¸ å®Ÿè¡Œæ™‚é–“</div>\n          <div style=\"color: ${textColor}; font-size: 14px;\">${duration}ç§’</div>\n        </div>\n        \n        ${taskData.error ? `\n        <div>\n          <div style=\"color: ${labelColor}; font-size: 12px; font-weight: 500; margin-bottom: 0;\">âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°</div>\n          <div style=\"color: #ef4444; font-size: 14px; line-height: 1.4;\">${taskData.error}</div>\n        </div>\n        ` : ''}\n        \n        <div>\n          <div style=\"color: ${labelColor}; font-size: 12px; font-weight: 500; margin-bottom: 0;\">ğŸ¨ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—</div>\n          <div style=\"color: ${textColor}; font-size: 14px;\">${taskData.contentType || 'ç”»åƒ'}</div>\n        </div>\n      </div>\n    `;\n    \n    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼\n    modalContent.addEventListener('click', (e) => {\n      e.stopPropagation();\n    });\n    \n    const closeBtn = modalContent.querySelector('.close-btn');\n    closeBtn.addEventListener('click', () => {\n      this.closeTaskDetailModal(modal);\n    });\n    \n    closeBtn.addEventListener('mouseenter', () => {\n      closeBtn.style.color = textColor;\n    });\n    \n    closeBtn.addEventListener('mouseleave', () => {\n      closeBtn.style.color = labelColor;\n    });\n    \n    modal.addEventListener('click', () => {\n      this.closeTaskDetailModal(modal);\n    });\n    \n    modal.appendChild(modalContent);\n    return modal;\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹\n   */\n  closeTaskDetailModal(modal) {\n    modal.style.opacity = '0';\n    modal.querySelector('.modal-content').style.transform = 'translateY(20px) scale(0.95)';\n    \n    setTimeout(() => {\n      if (modal.parentNode) {\n        modal.parentNode.removeChild(modal);\n      }\n    }, 300);\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰å…¥å ´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ + iOS 26 Liquid Glassï¼‰\n   */\n  animateCardEntrance(card) {\n    // iOS 26 Liquid Glass å…¥å ´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ\n    card.style.transform = 'translateY(20px) scale(0.95)';\n    card.style.opacity = '0';\n    card.style.filter = 'blur(4px)';\n\n    requestAnimationFrame(() => {\n      card.style.transition = 'all 0.6s cubic-bezier(0.16, 1, 0.3, 1)';\n      card.style.transform = 'translateY(0) scale(1)';\n      card.style.opacity = '1';\n      card.style.filter = 'blur(0px)';\n\n      // 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: å¾®ç´°ãªå…‰ã‚‹åŠ¹æœ\n      card.style.boxShadow = '0 4px 20px rgba(255, 255, 255, 0.1), 0 0 40px rgba(255, 255, 255, 0.05)';\n    });\n  }\n\n  /**\n   * æˆåŠŸæ™‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ + è‡ªå‹•æ¶ˆå»ï¼ˆiOS 26 Liquid Glassï¼‰\n   */\n  animateCardSuccess(card, taskId) {\n    // iOS 26 Liquid Glass æˆåŠŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆ\n    card.style.transition = 'all 0.3s cubic-bezier(0.16, 1, 0.3, 1)';\n    card.style.borderColor = 'rgba(76, 175, 80, 0.6)';\n    card.style.transform = 'scale(1.08)';\n    card.style.boxShadow = '0 8px 32px rgba(76, 175, 80, 0.4), 0 0 60px rgba(76, 175, 80, 0.2)';\n    card.style.filter = 'brightness(1.1) saturate(1.2)';\n\n    // 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: æµä½“çš„ãªæˆ»ã‚Šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    setTimeout(() => {\n      card.style.transform = 'scale(1.02)';\n      card.style.filter = 'brightness(1.05) saturate(1.1)';\n    }, 150);\n\n    // Liquid Glassé¢¨ã®ã‚¹ãƒ ãƒ¼ã‚ºãªãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆ2ç§’å¾Œã«è‡ªå‹•å‰Šé™¤ï¼‰\n    setTimeout(() => {\n      this.animateCardExit(card, taskId);\n    }, 2000);\n  }\n\n  /**\n   * ã‚¨ãƒ©ãƒ¼æ™‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ UXï¼‰\n   */\n  animateCardError(card, taskId) {\n    // iOS 26 Liquid Glass ã‚¨ãƒ©ãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ\n    card.style.transition = 'all 0.3s cubic-bezier(0.16, 1, 0.3, 1)';\n    card.style.borderColor = 'rgba(244, 67, 54, 0.7)';\n    card.style.boxShadow = '0 8px 32px rgba(244, 67, 54, 0.3), 0 0 60px rgba(244, 67, 54, 0.15)';\n    card.style.filter = 'saturate(1.3) brightness(1.1)';\n\n    // 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: ã‚ˆã‚Šè‡ªç„¶ãªpulseã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆshakeã‚ˆã‚Šæ´—ç·´ï¼‰\n    card.style.animation = 'errorPulse 0.6s cubic-bezier(0.16, 1, 0.3, 1) 2';\n\n    // UXæ”¹å–„: ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’è¡¨ç¤ºã™ã‚‹ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—é¢¨UI\n    this.addErrorTooltip(card, taskId);\n\n    // ã‚¨ãƒ©ãƒ¼ã¯æ‰‹å‹•ã§æ¶ˆã™ã¾ã§è¡¨ç¤ºç¶™ç¶šï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ¶ˆå»ï¼‰\n    card.style.cursor = 'pointer';\n    card.onclick = () => this.animateCardExit(card, taskId);\n\n    // 5ç§’å¾Œã«è‡ªå‹•ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆUXæ”¹å–„ï¼‰\n    setTimeout(() => {\n      if (this.taskCards.has(taskId)) {\n        this.animateCardExit(card, taskId);\n      }\n    }, 5000);\n  }\n\n  /**\n   * ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºï¼ˆUXæ”¹å–„ï¼‰\n   */\n  addErrorTooltip(card, taskId) {\n    const taskData = this.taskCards.get(taskId);\n    if (!taskData || !taskData.error) return;\n\n    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¦ç´ ä½œæˆ\n    const tooltip = document.createElement('div');\n    tooltip.style.cssText = `\n      position: absolute;\n      bottom: 100%;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(244, 67, 54, 0.95);\n      color: white;\n      padding: 8px 12px;\n      border-radius: 8px;\n      font-size: 11px;\n      white-space: nowrap;\n      pointer-events: none;\n      z-index: 1001;\n      backdrop-filter: blur(10px);\n      margin-bottom: 0;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n    `;\n    tooltip.textContent = taskData.error;\n\n    card.style.position = 'relative';\n    card.appendChild(tooltip);\n\n    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³\n    requestAnimationFrame(() => {\n      tooltip.style.opacity = '1';\n    });\n\n    // 3ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ\n    setTimeout(() => {\n      if (tooltip.parentNode) {\n        tooltip.style.opacity = '0';\n        setTimeout(() => {\n          if (tooltip.parentNode) {\n            tooltip.parentNode.removeChild(tooltip);\n          }\n        }, 300);\n      }\n    }, 3000);\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰é€€å ´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ + iOS 26 Liquid Glassï¼‰\n   */\n  animateCardExit(card, taskId) {\n    // iOS 26 Liquid Glass é€€å ´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ - 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ã®ã€Œã‚¹ãƒƒã¨æ¶ˆãˆã‚‹ã€\n    card.style.transition = 'all 0.28s cubic-bezier(0.4, 0, 0.2, 1)';\n    card.style.transform = 'translateY(-12px) scale(0.92)';\n    card.style.opacity = '0';\n    card.style.filter = 'blur(6px) brightness(1.2)';\n\n    // 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: æ¶ˆå»æ™‚ã®å¾®ç´°ãªå…‰ã®æ‹¡æ•£åŠ¹æœ\n    card.style.boxShadow = '0 0 40px rgba(255, 255, 255, 0.3), 0 0 80px rgba(255, 255, 255, 0.1)';\n\n    setTimeout(() => {\n      if (card.parentNode) {\n        card.parentNode.removeChild(card);\n      }\n      this.taskCards.delete(taskId);\n      // ã‚«ãƒ¼ãƒ‰å‰Šé™¤å¾Œã«è¡¨ç¤ºåˆ¶é™ã‚’å†é©ç”¨\n      this.updateCardDisplayLimit();\n    }, 280);\n  }\n\n  /**\n   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡¨ç¾ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è‡ªç„¶ã«æ„ŸçŸ¥\n   */\n  getResponseType(prompt) {\n    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡¨ç¾ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è‡ªç„¶ã«æ„ŸçŸ¥\n    if (/ã¡ã‚‡ã“ã£ã¨|ã¡ã‚‡ã“ã‚“|å°‘ã—|è»½ã/.test(prompt) || prompt.length < 15) {\n      return 'casual';\n    }\n    if (/ç¾ã—ã„|å¹»æƒ³|ç´ æ•µ|é­”æ³•|ä¸–ç•Œ|ç¶ºéº—/.test(prompt)) {\n      return 'magical';\n    }\n    return 'balanced'; // 80%ãŒã“ã“ã«è©²å½“\n  }\n\n  /**\n   * æ¸©ã‹ã¿ã®ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆï¼ˆãƒãƒ¼ã‚±ææ¡ˆãƒ™ãƒ¼ã‚¹ï¼‰\n   */\n  getFriendlyMessage(status, prompt, errorMessage = null) {\n    const shortPrompt = prompt.length > 15 ? prompt.substring(0, 15) + '...' : prompt;\n\n    // è‡ªç„¶ãªå¿œç­”ã‚·ã‚¹ãƒ†ãƒ é©ç”¨\n    const responseType = this.getResponseType(prompt);\n\n    switch (status) {\n      case 'pending':\n        return responseType === 'casual' ? 'ã¡ã‚‡ã“ã£ã¨æº–å‚™ä¸­ã§ã™...' :\n               responseType === 'magical' ? 'é­”æ³•ã‚’ã‹ã‘ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...' :\n               'ã¡ã‚‡ã“ã£ã¨é­”æ³•ã®æº–å‚™ä¸­...';\n      case 'processing':\n      case 'in-progress':\n      case 'progress':\n        // Modify mode specific messages for processing\n        if (this.currentMode === 'modify') {\n          return responseType === 'casual' ? 'ã¡ã‚‡ã“ã£ã¨èª¿æ•´ä¸­ã§ã™...' :\n                 responseType === 'magical' ? 'ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å¤‰åŒ–ã•ã›ã¦ã„ã¾ã™...' :\n                 'ã¡ã‚‡ã“ã‚“ã¨ç·¨é›†ä¸­ã§ã™...';\n        }\n        return responseType === 'casual' ? 'ã¡ã‚‡ã“ã‚“ã¨é…ç½®ä¸­ã§ã™...' :\n               responseType === 'magical' ? 'ã‚ãªãŸã®æƒ³ã„ã‚’å½¢ã«ã—ã¦ã„ã¾ã™...' :\n               'ã¡ã‚‡ã“ã£ã¨é­”æ³•ã‚’ã‹ã‘ã¦ã„ã¾ã™...';\n      case 'completed':\n        // Delete mode specific messages\n        if (this.currentMode === 'delete') {\n          return responseType === 'casual' ? 'ã¡ã‚‡ã“ã£ã¨å‰Šé™¤ã—ã¾ã—ãŸï¼' :\n                 responseType === 'magical' ? 'ã™ã£ãã‚Šã¨ç‰‡ä»˜ãã¾ã—ãŸï¼' :\n                 'ã¡ã‚‡ã“ã‚“ã¨å‰Šé™¤å®Œäº†ï¼ã™ã£ãã‚Šã§ã™ã­ï¼';\n        }\n        // Modify mode specific messages\n        if (this.currentMode === 'modify') {\n          return responseType === 'casual' ? 'ã¡ã‚‡ã“ã£ã¨èª¿æ•´ã—ã¾ã—ãŸï¼' :\n                 responseType === 'magical' ? 'ç´ æ•µã«å¤‰èº«ã—ã¾ã—ãŸï¼' :\n                 'ã¡ã‚‡ã“ã‚“ã¨ç·¨é›†å®Œäº†ï¼ã„ã„æ„Ÿã˜ã§ã™ã­ï¼';\n        }\n        // Default completion messages for other modes\n        return responseType === 'casual' ? 'ã¡ã‚‡ã“ã£ã¨ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã—ãŸï¼' :\n               responseType === 'magical' ? 'ç´ æ•µãªä¸–ç•ŒãŒå®Œæˆã—ã¾ã—ãŸï¼' :\n               'ã¡ã‚‡ã“ã‚“ã¨é…ç½®å®Œäº†ï¼ç´ æ•µã§ã™ã­ï¼';\n      case 'error':\n        // ã‚¨ãƒ©ãƒ¼ç†ç”±ãŒã‚ã‚Œã°å«ã‚ã‚‹\n        if (errorMessage) {\n          const shortError = errorMessage.length > 30 ? errorMessage.substring(0, 30) + '...' : errorMessage;\n          return `âŒ ${shortError}`;\n        }\n        return responseType === 'casual' ? 'ãŠã£ã¨ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' :\n               responseType === 'magical' ? 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ' :\n               'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„';\n      default:\n        return shortPrompt;\n    }\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰²å–å¾—\n   */\n  getStatusColor(status) {\n    // ãƒã‚ªãƒ³ãƒ‘ãƒ¼ãƒ—ãƒ«/ãƒ”ãƒ³ã‚¯ç³»ã§çµ±ä¸€ï¼ˆ2025ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰\n    const colors = {\n      pending: this.isDarkMode ? '#a78bfa' : '#7c3aed',        // è–„ç´«\n      processing: this.isDarkMode ? '#c084fc' : '#9333ea',     // ç´«ï¼ˆç”Ÿæˆä¸­ï¼‰\n      progress: this.isDarkMode ? '#ec4899' : '#be185d',       // ãƒ”ãƒ³ã‚¯\n      completed: this.isDarkMode ? '#a78bfa' : '#7c3aed',      // ç´«ï¼ˆå®Œäº†ã‚‚çµ±ä¸€ï¼‰\n      error: this.isDarkMode ? '#f87171' : '#dc2626'           // èµ¤ï¼ˆã‚¨ãƒ©ãƒ¼ã®ã¿ï¼‰\n    };\n    return colors[status] || colors.pending;\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ä½œæˆï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤ºãªã—ï¼‰\n   */\n  createStatusIndicator(status) {\n    if (status === 'processing' || status === 'progress') {\n      return `\n        <div class=\"status-indicator\" style=\"\n          background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.08)'};\n          border-radius: 8px;\n          height: 4px;\n          overflow: hidden;\n          margin-top: 8px;\n          position: relative;\n        \">\n          <div class=\"status-pulse\" style=\"\n            background: linear-gradient(90deg, transparent, #6366f1, #8b5cf6, transparent);\n            height: 100%;\n            width: 30%;\n            border-radius: 8px;\n            animation: statusPulse 1.8s ease-in-out infinite;\n          \"></div>\n        </div>\n        <div style=\"display: flex; align-items: center; gap: 4px; margin-top: 8px;\">\n          <div class=\"status-dots\" style=\"font-size: 10px; color: ${this.isDarkMode ? '#c084fc' : '#9333ea'};\">\n            å‡¦ç†ä¸­<span style=\"animation: dots 1.5s infinite;\">...</span>\n          </div>\n        </div>\n      `;\n    }\n    return '';\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯å®Œäº†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n   */\n  animateTaskCompletion(card) {\n    // æ§ãˆã‚ãªã‚µã‚¯ã‚»ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    card.style.animation = 'taskComplete 0.8s ease-out';\n\n    // å¾®å¦™ãªãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«åŠ¹æœã‚’è¿½åŠ ï¼ˆæ§ãˆã‚ï¼‰\n    this.addSubtleParticleEffect(card);\n\n    setTimeout(() => {\n      card.style.animation = '';\n    }, 800);\n\n    this.ensureTaskAnimations();\n  }\n\n  /**\n   * æ§ãˆã‚ãªãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«åŠ¹æœ\n   */\n  addSubtleParticleEffect(card) {\n    const particles = 3; // å°‘ãªã„æ•°ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«\n    const rect = card.getBoundingClientRect();\n\n    for (let i = 0; i < particles; i++) {\n      const particle = document.createElement('div');\n      particle.style.cssText = `\n        position: fixed;\n        width: 4px;\n        height: 4px;\n        background: linear-gradient(45deg, #a78bfa, #c084fc);\n        border-radius: 50%;\n        pointer-events: none;\n        z-index: 9999;\n        left: ${rect.right - 20}px;\n        top: ${rect.top + 10}px;\n        opacity: 0.8;\n        transform: scale(0);\n        animation: subtleParticle 1.2s ease-out forwards;\n      `;\n\n      // ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ã«å°‘ã—ç§»å‹•\n      const angle = (i / particles) * Math.PI * 2;\n      const distance = 15; // æ§ãˆã‚ãªè·é›¢\n      particle.style.setProperty('--move-x', `${Math.cos(angle) * distance}px`);\n      particle.style.setProperty('--move-y', `${Math.sin(angle) * distance}px`);\n\n      document.body.appendChild(particle);\n\n      // è‡ªå‹•å‰Šé™¤\n      setTimeout(() => particle.remove(), 1200);\n    }\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨CSSç¢ºä¿\n   */\n  ensureTaskAnimations() {\n    if (document.getElementById('task-animations')) return;\n\n    const style = document.createElement('style');\n    style.id = 'task-animations';\n    style.textContent = `\n      @keyframes slideInUp {\n        from { opacity: 0; transform: translateY(20px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n\n      @keyframes taskComplete {\n        0% {\n          transform: scale(1);\n          border-left-color: rgba(192, 132, 252, 0.5);\n        }\n        30% {\n          transform: scale(1.01);\n          background: rgba(167, 139, 250, 0.08);\n          border-left-color: rgba(167, 139, 250, 0.6);\n        }\n        60% {\n          background: rgba(167, 139, 250, 0.05);\n        }\n        100% {\n          transform: scale(1);\n          background: rgba(167, 139, 250, 0.02);\n          border-left-color: rgba(167, 139, 250, 0.4);\n        }\n      }\n\n      @keyframes subtleParticle {\n        0% {\n          transform: scale(0) translate(0, 0);\n          opacity: 0.8;\n        }\n        20% {\n          transform: scale(1) translate(0, 0);\n          opacity: 1;\n        }\n        100% {\n          transform: scale(0.3) translate(var(--move-x, 0), var(--move-y, 0));\n          opacity: 0;\n        }\n      }\n\n      @keyframes shimmer {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(100%); }\n      }\n\n      @keyframes slideIn {\n        from { opacity: 0; transform: translateX(-20px); }\n        to { opacity: 1; transform: translateX(0); }\n      }\n\n      @keyframes statusPulse {\n        0% { transform: translateX(-100%); }\n        50% { transform: translateX(300%); }\n        100% { transform: translateX(-100%); }\n      }\n\n      @keyframes dots {\n        0%, 20% { opacity: 0; }\n        50% { opacity: 1; }\n        100% { opacity: 0; }\n      }\n\n      @keyframes errorPulse {\n        0% {\n          transform: scale(1);\n          filter: saturate(1.3) brightness(1.1);\n        }\n        50% {\n          transform: scale(1.03);\n          filter: saturate(1.5) brightness(1.2);\n          box-shadow: 0 12px 40px rgba(244, 67, 54, 0.4), 0 0 80px rgba(244, 67, 54, 0.2);\n        }\n        100% {\n          transform: scale(1);\n          filter: saturate(1.3) brightness(1.1);\n        }\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  /**\n   * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ä»˜ãã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰\n   */\n  addTaskStatus(message, percent = 0, taskId = null) {\n    const id = taskId || `task_${Date.now()}`;\n    return this.addTaskCard(message, {\n      percent: Math.min(Math.max(percent, 0), 100),\n      taskId: id,\n      status: percent > 0 ? 'progress' : 'pending'\n    });\n  }\n\n  /**\n   * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°\n   */\n  updateTaskProgress(taskId, percent, newMessage = null) {\n    const existingTask = this.output.querySelector(`[data-task-id=\"${taskId}\"]`);\n    if (existingTask && newMessage) {\n      // æ—¢å­˜ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°\n      this.addOutput(newMessage, 'progress', { \n        percent: Math.min(Math.max(percent, 0), 100),\n        taskId\n      });\n    }\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯å®Œäº†ï¼ˆãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼å‰Šé™¤ï¼‰\n   */\n  completeTask(taskId) {\n    const existingTask = this.output.querySelector(`[data-task-id=\"${taskId}\"]`);\n    if (existingTask) {\n      // å®Œäº†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n      existingTask.style.transition = 'opacity 0.5s ease, transform 0.5s ease';\n      existingTask.style.opacity = '0';\n      existingTask.style.transform = 'translateX(20px)';\n      \n      setTimeout(() => {\n        if (existingTask.parentNode) {\n          existingTask.remove();\n        }\n      }, 500);\n    }\n  }\n\n  /**\n   * SSEæ¥ç¶šé–‹å§‹ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—å—ä¿¡ï¼‰\n   */\n  connectToProgress(serverTaskId, uiTaskId = null) {\n    if (this.activeConnections.has(serverTaskId)) {\n      return;\n    }\n\n    const eventSource = new EventSource(`/api/progress/${serverTaskId}`);\n    this.activeConnections.set(serverTaskId, eventSource);\n\n    eventSource.onmessage = (event) => {\n      try {\n        const data = JSON.parse(event.data);\n        data.uiTaskId = uiTaskId; // UIç”¨ã‚¿ã‚¹ã‚¯IDã‚’è¿½åŠ \n        this.handleProgressUpdate(data);\n      } catch (error) {\n        console.error('SSE data parse error:', error);\n      }\n    };\n\n    eventSource.onerror = (error) => {\n      console.error('SSE connection error:', error);\n      this.disconnectProgress(serverTaskId);\n    };\n  }\n\n  /**\n   * é€²æ—æ›´æ–°å‡¦ç†\n   */\n  handleProgressUpdate(data) {\n    switch (data.type) {\n      case 'connected':\n        this.logDebug(`ğŸ”— Connected to progress stream: ${data.taskId}`);\n        break;\n\n      case 'progress':\n        if (data.percent !== undefined && data.uiTaskId) {\n          this.updateTaskCard(data.uiTaskId, 'progress', { percent: data.percent });\n        }\n        break;\n\n      case 'completed':\n        if (data.uiTaskId) {\n          this.updateTaskCard(data.uiTaskId, 'completed');\n        }\n        this.disconnectProgress(data.taskId);\n        break;\n\n      case 'error':\n        if (data.uiTaskId) {\n          this.updateTaskCard(data.uiTaskId, 'error');\n        }\n        this.addOutput(`âŒ ${data.message}`, 'error');\n        this.disconnectProgress(data.taskId);\n        break;\n    }\n  }\n\n  /**\n   * SSEæ¥ç¶šçµ‚äº†\n   */\n  disconnectProgress(taskId) {\n    const connection = this.activeConnections.get(taskId);\n    if (connection) {\n      connection.close();\n      this.activeConnections.delete(taskId);\n    }\n  }\n\n  /**\n   * å‡ºåŠ›ã‚¨ãƒªã‚¢ã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«\n   */\n  scrollToBottom() {\n    if (this.outputDiv) {\n      this.outputDiv.scrollTop = this.outputDiv.scrollHeight;\n    }\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ‰åˆ¥ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹\n   */\n  getModePrefix(mode) {\n    // ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ¢ãƒ¼ãƒ‰ã‚’åŒºåˆ¥ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹\n    const prefixes = {\n      generate: '', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰\n      modify: '[å¤‰æ›´] ',\n      delete: '[å‰Šé™¤] '\n    };\n    return prefixes[mode] || '';\n  }\n\n  /**\n   * ã‚³ãƒãƒ³ãƒ‰ä¿å­˜ (Undo/Redoã‚·ã‚¹ãƒ†ãƒ )\n   */\n  saveCommandToHistory(commandData) {\n    // ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä»¥é™ã®å±¥æ­´ã‚’å‰Šé™¤ï¼ˆæ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸãŸã‚ï¼‰\n    this.commandHistory = this.commandHistory.slice(0, this.currentHistoryIndex + 1);\n    \n    // æ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰ã‚’å±¥æ­´ã«è¿½åŠ \n    this.commandHistory.push(commandData);\n    this.currentHistoryIndex = this.commandHistory.length - 1;\n    \n    // æœ€å¤§ã‚³ãƒãƒ³ãƒ‰ä¿å­˜æ•°ã‚’è¶…ãˆãŸå ´åˆã€å¤ã„ã‚³ãƒãƒ³ãƒ‰ã‚’å‰Šé™¤\n    if (this.commandHistory.length > this.maxHistorySize) {\n      this.commandHistory.shift();\n      this.currentHistoryIndex--;\n    }\n    \n    // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°\n    this.updateUndoRedoButtons();\n  }\n\n  /**\n   * Undoå®Ÿè¡Œ\n   */\n  undo() {\n    if (!this.canUndo()) {\n      this.addOutput('â†¶ Undoã§ãã‚‹æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“', 'hint');\n      return;\n    }\n    \n    const command = this.commandHistory[this.currentHistoryIndex];\n    this.currentHistoryIndex--;\n    \n    // Undoã®é€†æ“ä½œã‚’å®Ÿè¡Œï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰\n    if (command.mode === 'generate') {\n      this.addOutput(`â†¶ Undo: \"${command.command}\" ã®ç”Ÿæˆã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ`, 'system');\n      // å®Ÿéš›ã®ã‚·ãƒ¼ãƒ³ç®¡ç†ã§ã¯æœ€å¾Œã«ä½œæˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤\n      if (this.sceneManager && this.sceneManager.undoLastGenerate) {\n        this.sceneManager.undoLastGenerate();\n      }\n    } else if (command.mode === 'modify') {\n      this.addOutput(`â†¶ Undo: \"${command.command}\" ã®å¤‰æ›´ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ`, 'system');\n      // å®Ÿéš›ã®ã‚·ãƒ¼ãƒ³ç®¡ç†ã§ã¯å‰ã®çŠ¶æ…‹ã«æˆ»ã™\n      if (this.sceneManager && this.sceneManager.undoLastModify) {\n        this.sceneManager.undoLastModify();\n      }\n    } else if (command.mode === 'delete') {\n      this.addOutput(`â†¶ Undo: \"${command.command}\" ã®å‰Šé™¤ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ`, 'system');\n      // å®Ÿéš›ã®ã‚·ãƒ¼ãƒ³ç®¡ç†ã§ã¯å‰Šé™¤ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¾©å…ƒ\n      if (this.sceneManager && this.sceneManager.undoLastDelete) {\n        this.sceneManager.undoLastDelete();\n      }\n    }\n    \n    this.updateUndoRedoButtons();\n  }\n\n  /**\n   * Redoå®Ÿè¡Œ\n   */\n  redo() {\n    if (!this.canRedo()) {\n      this.addOutput('â†· Redoã§ãã‚‹æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“', 'hint');\n      return;\n    }\n    \n    this.currentHistoryIndex++;\n    const command = this.commandHistory[this.currentHistoryIndex];\n    \n    // Redoã§ã‚³ãƒãƒ³ãƒ‰ã‚’å†å®Ÿè¡Œ\n    this.addOutput(`â†· Redo: \"${command.command}\" ã‚’å†å®Ÿè¡Œã—ã¾ã—ãŸ`, 'system');\n    \n    // å®Ÿéš›ã®ã‚·ãƒ¼ãƒ³ç®¡ç†ã§ã®Redoå‡¦ç†\n    if (this.sceneManager && this.sceneManager.redoCommand) {\n      this.sceneManager.redoCommand(command);\n    }\n    \n    this.updateUndoRedoButtons();\n  }\n\n  /**\n   * UndoãŒå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯\n   */\n  canUndo() {\n    return this.currentHistoryIndex >= 0;\n  }\n\n  /**\n   * RedoãŒå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯\n   */\n  canRedo() {\n    return this.currentHistoryIndex < this.commandHistory.length - 1;\n  }\n\n  /**\n   * Undo/Redoãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°\n   */\n  updateUndoRedoButtons() {\n    if (this.undoBtn) {\n      this.undoBtn.disabled = !this.canUndo();\n      this.undoBtn.style.opacity = this.canUndo() ? '1' : '0.4';\n      this.undoBtn.style.cursor = this.canUndo() ? 'pointer' : 'not-allowed';\n    }\n    \n    if (this.redoBtn) {\n      this.redoBtn.disabled = !this.canRedo();\n      this.redoBtn.style.opacity = this.canRedo() ? '1' : '0.4';\n      this.redoBtn.style.cursor = this.canRedo() ? 'pointer' : 'not-allowed';\n    }\n  }\n\n  /**\n   * ç¢ºèªä»˜ãå…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤\n   */\n  async clearAllWithConfirmation() {\n    const confirmed = await this.showClearAllConfirmation();\n    if (confirmed) {\n      this.clearAll();\n    }\n  }\n\n  /**\n   * Clear Allç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°\n   */\n  async showClearAllConfirmation() {\n    return this.showConfirmationDialog({\n      icon: 'ğŸ§¹',\n      title: 'Clear All ã®ç¢ºèª',\n      message: 'ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚',\n      confirmText: 'Clear All å®Ÿè¡Œ',\n      cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',\n      confirmColor: '#6366f1'\n    });\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n   */\n  closeModalWithAnimation(modal) {\n    const dialog = modal.querySelector('div:last-child');\n    dialog.style.transform = 'scale(0.9)';\n    dialog.style.opacity = '0';\n    modal.style.opacity = '0';\n    \n    setTimeout(() => {\n      if (modal.parentElement) {\n        document.body.removeChild(modal);\n      }\n    }, 200);\n  }\n\n  /**\n   * å…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤\n   */\n  clearAll() {\n    if (this.sceneManager) {\n      this.sceneManager.clearAll();\n      this.addOutput('ğŸ§¹ å…¨ã¦ã®å®Ÿé¨“ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'system');\n    } else if (this.client) {\n      // ã‚µãƒ¼ãƒãƒ¼å´ã§ã®å‰Šé™¤ã¯æœªå®Ÿè£…\n      this.addOutput('âš ï¸ ã‚µãƒ¼ãƒãƒ¼å´å‰Šé™¤ã¯æœªå®Ÿè£…', 'error');\n    }\n  }\n\n  // showHistory() ãƒ¡ã‚½ãƒƒãƒ‰å®Œå…¨å‰Šé™¤æ¸ˆã¿\n\n  /**\n   * åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ä¾‹ã‚’è¡¨ç¤º\n   */\n  showExamples() {\n    const examples = [\n      'å³ä¸Šã«ãƒ‰ãƒ©ã‚´ãƒ³ã‚’ä½œã£ã¦',\n      'ä¸­å¤®ã«å¤§ããªãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³ã‚’ç”Ÿæˆ',\n      'å·¦ä¸‹ã«å°ã•ãªæ¡œã‚’ä½œã£ã¦',\n      'ç©ºã«é³³å‡°ã‚’ä½œã£ã¦',\n      'åœ°é¢ã«ç¥ç¤¾ã‚’ä½œã£ã¦'\n    ];\n\n    this.addOutput('ğŸ’¡ ã‚³ãƒãƒ³ãƒ‰ä¾‹:', 'system');\n    examples.forEach(example => {\n      this.addOutput(`   \"${example}\"`, 'hint');\n    });\n  }\n\n  /**\n   * SceneManagerè¨­å®š\n   */\n  setSceneManager(sceneManager) {\n    this.sceneManager = sceneManager;\n    this.applyServiceSelectionToSceneManager();\n  }\n\n  /**\n   * Clientè¨­å®š\n   */\n  setClient(client) {\n    this.client = client;\n  }\n\n  /**\n   * è¨­å®šæ›´æ–°\n   */\n  updateConfig(newConfig) {\n    this.config = { ...this.config, ...newConfig };\n    // å¿…è¦ã«å¿œã˜ã¦UIã‚’æ›´æ–°\n    if (newConfig.activationKey) {\n      // æ–°ã—ã„ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã‚’åæ˜ ã™ã‚‹ãŸã‚ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š\n      this.bindEvents();\n    }\n  }\n\n  /**\n   * ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n   */\n  /**\n   * ã‚¹ã‚¿ã‚¤ãƒ«å†é©ç”¨\n   */\n  refreshStyles() {\n    // ãƒœãƒ‡ã‚£ã«ãƒ†ãƒ¼ãƒã‚¯ãƒ©ã‚¹ã‚’è¨­å®š\n    document.body.className = this.isWabiSabiMode ? 'wabisabi-mode' : (this.isDarkMode ? 'dark-mode' : 'light-mode');\n\n    // Generateãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å†é©ç”¨\n    const generateBtn = this.container?.querySelector('[data-mode=\"generate\"]');\n    if (generateBtn) {\n      generateBtn.style.cssText = this.getModeButtonStyles(true, 'generate');\n    }\n    \n    // Executeãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å†é©ç”¨\n    const executeBtn = this.container?.querySelector('#execute-btn');\n    if (executeBtn) {\n      executeBtn.style.cssText = this.getModernButtonStyles('primary');\n    }\n  }\n\n  /**\n   * ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ (light -> dark -> wabisabi -> light)\n   */\n  toggleTheme() {\n    const themeOrder = ['light', 'dark', 'wabisabi'];\n    const currentIndex = themeOrder.indexOf(this.currentTheme);\n    const nextIndex = (currentIndex + 1) % themeOrder.length;\n\n    this.currentTheme = themeOrder[nextIndex];\n    this.isDarkMode = this.currentTheme === 'dark';\n    this.isWabiSabiMode = this.currentTheme === 'wabisabi';\n\n    localStorage.setItem('live-command-theme', this.currentTheme);\n\n    // ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³æ›´æ–°\n    if (this.themeToggle) {\n      const getThemeIcon = () => {\n        const themeConfig = {\n          light: 'ğŸŒ™',\n          dark: 'ğŸµ',\n          wabisabi: 'â˜€ï¸'\n        };\n        return themeConfig[this.currentTheme] || 'ğŸŒ™';\n      };\n\n      const getThemeTitle = () => {\n        const titleConfig = {\n          light: 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ',\n          dark: 'ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ',\n          wabisabi: 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ'\n        };\n        return titleConfig[this.currentTheme] || 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ';\n      };\n\n      const getThemeIconWithFilter = () => {\n        const icon = getThemeIcon();\n        if (icon === 'â˜€ï¸') {\n          return `<span style=\"filter: saturate(1.2) brightness(1.1);\">${icon}</span>`;\n        } else if (icon === 'ğŸµ') {\n          return `<span style=\"filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);\">${icon}</span>`;\n        } else {\n          return `<span style=\"filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);\">${icon}</span>`;\n        }\n      };\n\n      this.themeToggle.innerHTML = getThemeIconWithFilter();\n      this.themeToggle.title = getThemeTitle();\n    }\n\n    // å…¨ã‚¹ã‚¿ã‚¤ãƒ«å†é©ç”¨\n    this.applyTheme();\n\n    // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆå®Œäº†ï¼ˆå±¥æ­´ã«ã¯å‡ºåŠ›ã—ãªã„ï¼‰\n  }\n\n  /**\n   * ãƒ†ãƒ¼ãƒé©ç”¨\n   */\n  applyTheme() {\n    // ãƒœãƒ‡ã‚£ã«ãƒ†ãƒ¼ãƒã‚¯ãƒ©ã‚¹ã‚’è¨­å®š\n    document.body.className = this.isDarkMode ? 'dark-mode' : 'light-mode';\n\n    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠï¼ˆdisplayçŠ¶æ…‹ã‚’ä¿æŒï¼‰\n    const currentDisplay = this.container.style.display;\n    const currentFlexDirection = this.container.style.flexDirection;\n    this.container.style.cssText = this.getContainerStyles();\n    this.container.style.display = currentDisplay || 'flex';\n    this.container.style.flexDirection = currentFlexDirection || 'column';\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒ‰ãƒãƒƒã‚¸ã®ãƒ†ãƒ¼ãƒå†é©ç”¨\n    const brandBadge = this.container.querySelector('.floating-brand-badge');\n    if (brandBadge) {\n      brandBadge.style.background = this.isDarkMode \n        ? 'linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.7))'\n        : 'linear-gradient(135deg, rgba(99, 102, 241, 0.9), rgba(139, 92, 246, 0.8))';\n      brandBadge.style.border = `1px solid ${this.isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.4)'}`;\n    }\n\n    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰\n    this.input.style.cssText = this.getInputStyles();\n\n    // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨\n    this.output.style.cssText = this.getOutputStyles();\n\n    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®2025å¹´ä»•æ§˜ãƒ†ãƒ¼ãƒå†é©ç”¨\n    if (this.radioModeContainer) {\n      this.radioModeContainer.style.background = this.isWabiSabiMode\n        ? 'linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))'\n        : (this.isDarkMode\n          ? 'linear-gradient(135deg, rgba(30, 27, 75, 0.3), rgba(15, 23, 42, 0.4))'\n          : 'linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1))');\n      this.radioModeContainer.style.borderColor = this.isWabiSabiMode\n        ? 'rgba(93, 64, 55, 0.4)'\n        : (this.isDarkMode\n          ? 'rgba(99, 102, 241, 0.15)'\n          : 'rgba(255, 255, 255, 0.25)');\n\n      // å„ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°\n      Object.keys(this.radioModeButtons).forEach(key => {\n        const { button } = this.radioModeButtons[key];\n        if (this.currentMode !== key) {\n          button.style.color = this.isWabiSabiMode\n            ? 'rgba(245, 245, 245, 0.8)'\n            : (this.isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(55, 65, 81, 0.8)');\n          button.style.background = 'transparent';\n          button.style.border = '1px solid transparent';\n          button.style.boxShadow = 'none';\n        }\n      });\n\n      // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚æ›´æ–°\n      this.selectMode(this.currentMode, false);\n    }\n\n    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ãƒ†ãƒ¼ãƒå†é©ç”¨\n    if (this.clearBtn) {\n      this.clearBtn.style.cssText = this.getActionButtonStyles('secondary');\n    }\n    if (this.historyBtn) {\n      this.historyBtn.style.cssText = this.getActionButtonStyles('secondary');\n      this.historyBtn.style.opacity = '0.5';\n    }\n    if (this.themeToggle) {\n      const getThemeIcon = () => {\n        const themeConfig = {\n          light: 'ğŸŒ™', // ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯æœˆã‚’è¡¨ç¤ºï¼ˆæ¬¡ãŒãƒ€ãƒ¼ã‚¯ï¼‰\n          dark: 'ğŸµ',  // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯èŒ¶ã‚’è¡¨ç¤ºï¼ˆæ¬¡ãŒwabi-sabiï¼‰\n          wabisabi: 'â˜€ï¸' // wabi-sabiãƒ¢ãƒ¼ãƒ‰æ™‚ã¯å¤ªé™½ã‚’è¡¨ç¤ºï¼ˆæ¬¡ãŒãƒ©ã‚¤ãƒˆï¼‰\n        };\n        return themeConfig[this.currentTheme] || 'ğŸŒ™';\n      };\n      const getThemeTitle = () => {\n        const titleConfig = {\n          light: 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ',\n          dark: 'ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ',\n          wabisabi: 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ'\n        };\n        return titleConfig[this.currentTheme] || 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ';\n      };\n      const getThemeIconWithFilter = () => {\n        const icon = getThemeIcon();\n        // å¤ªé™½ã¯é»„è‰²ãã€ãŠèŒ¶ã¯ç·‘ç³»ã€æœˆã¯ç´«ç³»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼\n        if (icon === 'â˜€ï¸') {\n          return `<span style=\"filter: saturate(1.2) brightness(1.1);\">${icon}</span>`;\n        } else if (icon === 'ğŸµ') {\n          return `<span style=\"filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);\">${icon}</span>`;\n        } else {\n          return `<span style=\"filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);\">${icon}</span>`;\n        }\n      };\n      this.themeToggle.innerHTML = getThemeIconWithFilter();\n      this.themeToggle.title = getThemeTitle();\n      this.themeToggle.style.cssText = this.getActionButtonStyles('icon');\n    }\n    if (this.settingsButton) {\n      this.settingsButton.style.cssText = this.getActionButtonStyles('icon');\n    }\n\n    this.updateServiceSelectorTheme();\n\n    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ãƒ†ãƒ¼ãƒæ›´æ–°\n    const closeButton = this.container.querySelector('.close-button');\n    if (closeButton) {\n      closeButton.style.color = this.isWabiSabiMode ? '#F5F5F5' : (this.isDarkMode ? '#ffffff' : '#1f2937');\n      closeButton.style.background = this.isWabiSabiMode\n        ? 'rgba(245, 245, 245, 0.1)'\n        : (this.isDarkMode\n          ? 'rgba(255, 255, 255, 0.1)'\n          : 'rgba(0, 0, 0, 0.1)');\n    }\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒŠã¨ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®ãƒ†ãƒ¼ãƒæ›´æ–°\n    this.updateFloatingContainerTheme();\n\n    // æ—¢å­˜ã®å‡ºåŠ›ãƒ†ã‚­ã‚¹ãƒˆã®è‰²ã‚’æ›´æ–°\n    this.updateExistingTextColors();\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒŠã¨ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®ãƒ†ãƒ¼ãƒæ›´æ–°\n   */\n  updateFloatingContainerTheme() {\n    if (!this.floatingContainer) return;\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒŠã®è¡¨ç¤ºçŠ¶æ…‹ã‚’ä¿æŒ\n    const currentDisplay = this.floatingContainer.style.display;\n\n    // æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®è‰²ã ã‘ã‚’ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã¦æ›´æ–°ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯ä¿æŒï¼‰\n    if (this.taskCards && this.taskCards.size > 0) {\n      this.taskCards.forEach((taskData, taskId) => {\n        const card = taskData.element;\n        if (card) {\n          // ãƒ†ãƒ¼ãƒé–¢é€£ã®è‰²ã®ã¿æ›´æ–°ï¼ˆä½ç½®ã‚„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã¯ä¿æŒï¼‰\n          // 2025å¹´Glassmorphismä»•æ§˜é©ç”¨\n          const glassmorphismDark = {\n            background: 'linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 27, 75, 0.7))',\n            border: '1px solid rgba(99, 102, 241, 0.25)',\n            color: '#ffffff'\n          };\n\n          const glassmorphismLight = {\n            background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25))',\n            border: '1px solid rgba(255, 255, 255, 0.4)',\n            color: '#1f2937'\n          };\n\n          const theme = this.isDarkMode ? glassmorphismDark : glassmorphismLight;\n\n\n          card.style.setProperty('background', theme.background, 'important');\n          card.style.setProperty('border', theme.border, 'important');\n          card.style.setProperty('color', theme.color, 'important');\n        }\n      });\n    }\n\n    // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆæ™‚ã¯ä½ç½®ã¯å¤‰æ›´ã›ãšã€è¡¨ç¤ºçŠ¶æ…‹ã®ã¿å¾©å…ƒ\n    this.floatingContainer.style.display = currentDisplay;\n  }\n\n  /**\n   * æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’ç¾åœ¨ã®ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã¦æ›´æ–°\n   */\n  updateExistingTextColors() {\n    const colors = this.isDarkMode ? {\n      system: '#60a5fa',\n      command: '#93c5fd',\n      success: '#f472b6',\n      error: '#f87171',\n      processing: '#fbbf24',\n      info: '#d1d5db',\n      hint: '#d1d5db'\n    } : {\n      system: '#1e40af',\n      command: '#1d4ed8',\n      success: '#be185d',\n      error: '#dc2626',\n      processing: '#d97706',\n      info: '#7c3aed',\n      hint: '#374151'\n    };\n\n    const defaultTextColor = this.isDarkMode ? '#d1d5db' : '#374151';\n\n    // outputå†…ã®å…¨ã¦ã®divã®è‰²ã‚’æ›´æ–°\n    this.output.querySelectorAll('div').forEach(line => {\n      const text = line.textContent;\n      let type = 'default';\n      \n      // ãƒ†ã‚­ã‚¹ãƒˆã®å†…å®¹ã‹ã‚‰ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š\n      if (text.includes('ğŸ“‹') || text.includes('ğŸ¨') || text.includes('ğŸ®') || text.includes('UIèµ·å‹•')) {\n        type = 'system';\n      } else if (text.startsWith('> ')) {\n        type = 'command';\n      } else if (text.includes('âœ…') || text.includes('â­') || text.includes('ç”Ÿæˆã—ã¾ã—ãŸ')) {\n        type = 'success';\n      } else if (text.includes('âŒ') || text.includes('ã‚¨ãƒ©ãƒ¼')) {\n        type = 'error';\n      } else if (text.includes('ä¸­...')) {\n        type = 'processing';\n      } else if (text.includes('ğŸ“') || text.includes('ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«:') || text.includes('ä½ç½®:')) {\n        type = 'info';\n      } else if (text.includes('   ')) {\n        type = 'hint';\n      }\n\n      line.style.color = colors[type] || defaultTextColor;\n    });\n  }\n\n  /**\n   * Importã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¡¨ç¤º\n   */\n  showImportInterface() {\n    // éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ä½œæˆï¼ˆImportãƒœã‚¿ãƒ³ã‹ã‚‰ç›´æ¥é¸æŠã§ãã‚‹ã®ã§ã€ãƒœã‚¿ãƒ³ã¯ä¸è¦ï¼‰\n    if (!this.fileInput) {\n      this.fileInput = document.createElement('input');\n      this.fileInput.type = 'file';\n      this.fileInput.accept = '.glb,.gltf,.jpg,.jpeg,.png,.mp4,.mov';\n      this.fileInput.style.display = 'none';\n      this.fileInput.onchange = (e) => this.handleFileSelection(e);\n      document.body.appendChild(this.fileInput);\n    }\n\n    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–\n    this.enableDragAndDrop();\n  }\n\n  /**\n   * Importã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹éè¡¨ç¤º\n   */\n  hideImportInterface() {\n    if (this.fileSelectButton && this.fileSelectButton.parentNode) {\n      this.fileSelectButton.parentNode.removeChild(this.fileSelectButton);\n    }\n    this.disableDragAndDrop();\n  }\n\n  /**\n   * ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã\n   */\n  openFileSelector() {\n    if (this.fileInput) {\n      this.fileInput.click();\n    }\n  }\n\n  /**\n   * Importãƒœã‚¿ãƒ³ã‹ã‚‰ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’å®Ÿè¡Œ\n   */\n  triggerFileSelection() {\n    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ\n    if (!this.fileInput) {\n      this.showImportInterface(); // æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ä½œæˆå‡¦ç†ã‚’å‘¼ã³å‡ºã—\n    }\n\n    // ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã\n    this.openFileSelector();\n\n    // Import ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆUIåæ˜ ï¼‰\n    this.selectMode('import', true);\n  }\n\n  /**\n   * ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†\n   */\n  async handleFileSelection(event) {\n    const file = event.target.files[0];\n    if (!file) return;\n\n    try {\n      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š\n      const fileType = this.detectFileType(file.name);\n\n      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«URLã¨ã—ã¦å‡¦ç†\n      const fileUrl = URL.createObjectURL(file);\n\n      // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ä¿å­˜\n      this.selectedFile = {\n        file: file,\n        url: fileUrl,\n        type: fileType,\n        name: file.name\n      };\n\n      this.selectMode('import', true);\n\n      // è‡ªå‹•çš„ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§å®Ÿè¡Œ\n      const defaultPrompt = `ä¸­å¤®ã«è¨­ç½® (${file.name})`;\n      this.input.value = defaultPrompt;\n\n      this.addOutput(`ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ: ${file.name} (${fileType})`, 'system');\n      this.addOutput(`ğŸš€ è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${defaultPrompt}`, 'system');\n\n      // è‡ªå‹•å®Ÿè¡Œï¼ˆå°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦UXå‘ä¸Šï¼‰\n      setTimeout(() => {\n        this.executeCommand();\n      }, 500);\n\n    } catch (error) {\n      console.error('File selection error:', error);\n      this.addOutput(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');\n    }\n  }\n\n  /**\n   * ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–\n   */\n  enableDragAndDrop() {\n    if (!this.input) return;\n\n    this.input.addEventListener('dragover', this.handleDragOver.bind(this));\n    this.input.addEventListener('drop', this.handleDrop.bind(this));\n    this.input.addEventListener('dragenter', this.handleDragEnter.bind(this));\n    this.input.addEventListener('dragleave', this.handleDragLeave.bind(this));\n  }\n\n  /**\n   * ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–\n   */\n  disableDragAndDrop() {\n    if (!this.input) return;\n\n    this.input.removeEventListener('dragover', this.handleDragOver.bind(this));\n    this.input.removeEventListener('drop', this.handleDrop.bind(this));\n    this.input.removeEventListener('dragenter', this.handleDragEnter.bind(this));\n    this.input.removeEventListener('dragleave', this.handleDragLeave.bind(this));\n  }\n\n  /**\n   * ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†\n   */\n  handleDragOver(e) {\n    e.preventDefault();\n    this.input.style.background = this.isDarkMode ? 'rgba(236, 72, 153, 0.1)' : 'rgba(236, 72, 153, 0.05)';\n  }\n\n  /**\n   * ãƒ‰ãƒ©ãƒƒã‚°ã‚¨ãƒ³ã‚¿ãƒ¼å‡¦ç†\n   */\n  handleDragEnter(e) {\n    e.preventDefault();\n    this.input.style.background = this.isDarkMode ? 'rgba(236, 72, 153, 0.1)' : 'rgba(236, 72, 153, 0.05)';\n  }\n\n  /**\n   * ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–å‡¦ç†\n   */\n  handleDragLeave(e) {\n    e.preventDefault();\n    this.input.style.background = '';\n  }\n\n  /**\n   * ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†\n   */\n  async handleDrop(e) {\n    e.preventDefault();\n    this.input.style.background = '';\n\n    const files = Array.from(e.dataTransfer.files);\n    if (files.length === 0) return;\n\n    const file = files[0]; // æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å‡¦ç†\n\n    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯\n    const fileType = this.detectFileType(file.name);\n    if (!fileType) {\n      this.addOutput('âŒ ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™', 'error');\n      return;\n    }\n\n    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†ã¨åŒã˜æµã‚Œ\n    this.handleFileSelection({ target: { files: [file] } });\n  }\n\n  /**\n   * ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—åˆ¤å®š\n   */\n  detectFileType(fileName) {\n    const ext = fileName.toLowerCase().split('.').pop();\n\n    if (['glb', 'gltf'].includes(ext)) return '3d';\n    if (['jpg', 'jpeg', 'png', 'webp'].includes(ext)) return 'image';\n    if (['mp4', 'mov', 'webm'].includes(ext)) return 'video';\n\n    return null;\n  }\n\n  /**\n   * Importã‚³ãƒãƒ³ãƒ‰å‡¦ç†\n   */\n  async handleImportCommand(command) {\n    if (!this.selectedFile) {\n      throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');\n    }\n\n    try {\n      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‹ã‚‰ä½ç½®æƒ…å ±ã‚’è§£æ\n      const position = this.sceneManager ? this.sceneManager.parsePosition(command) : { x: 0, y: 5, z: -10 };\n\n      let result;\n\n      switch (this.selectedFile.type) {\n        case '3d':\n          // 3Dãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿\n          if (this.sceneManager) {\n            result = await this.sceneManager.load3DModel(this.selectedFile.url, {\n              position: position,\n              // scale: è‡ªå‹•èª¿æ•´ã«ä»»ã›ã‚‹\n            });\n          } else {\n            throw new Error('SceneManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');\n          }\n          break;\n\n        case 'image':\n          // ç”»åƒã‚’ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ã—ã¦é…ç½®\n          if (this.sceneManager) {\n            result = await this.sceneManager.loadImageFile(this.selectedFile.url, {\n              position: position,\n              fileName: this.selectedFile.name\n            });\n          } else {\n            throw new Error('SceneManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');\n          }\n          break;\n\n        case 'video':\n          // å‹•ç”»ã‚’ãƒ“ãƒ‡ã‚ªãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨ã—ã¦é…ç½®\n          if (this.sceneManager) {\n            result = await this.sceneManager.loadVideoFile(this.selectedFile.url, {\n              position: position,\n              fileName: this.selectedFile.name\n            });\n          } else {\n            throw new Error('SceneManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');\n          }\n          break;\n\n        default:\n          throw new Error(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: ${this.selectedFile.type}`);\n      }\n\n      // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n      const processedFileName = this.selectedFile?.name;\n      const importedType = this.selectedFile?.type;\n      const importedUrl = this.selectedFile?.url;\n\n      if (importedType !== 'video' && importedUrl) {\n        URL.revokeObjectURL(importedUrl);\n      }\n\n      this.selectedFile = null;\n      this.selectMode('generate', false);\n\n      return {\n        success: true,\n        message: `${processedFileName || 'ãƒ•ã‚¡ã‚¤ãƒ«'} ã‚’ ${position.x}, ${position.y}, ${position.z} ã«é…ç½®ã—ã¾ã—ãŸ`,\n        objectId: result.objectId\n      };\n\n    } catch (error) {\n      // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n      if (this.selectedFile?.url) {\n        URL.revokeObjectURL(this.selectedFile.url);\n      }\n      this.selectedFile = null;\n      this.selectMode('generate', false);\n      throw error;\n    }\n  }\n\n  /**\n   * å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚ŒãŸæ™‚ã®å‡¦ç†\n   */\n  handleDeleteModeSelection() {\n    // SceneManagerã‹ã‚‰é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—\n    const selectedObject = this.sceneManager?.selectedObject;\n    \n    if (selectedObject) {\n      // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹å ´åˆï¼šå‰Šé™¤ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒãƒ£ãƒƒãƒˆæ¬„ã«å…¥åŠ›\n      const objectName = selectedObject.userData?.originalPrompt || selectedObject.name || 'é¸æŠã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ';\n      this.input.value = `${objectName}ã‚’å‰Šé™¤ â`;\n      this.input.focus();\n      \n      // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ–‡æœ«ã«ç§»å‹•ï¼ˆé¸æŠçŠ¶æ…‹ã‚’è§£é™¤ï¼‰\n      this.input.setSelectionRange(this.input.value.length, this.input.value.length);\n      \n      this.addOutput(`ğŸ¯ å‰Šé™¤å¯¾è±¡: ${objectName}`, 'system');\n    } else {\n      // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãªã„å ´åˆï¼š2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§æ³¨æ„å–šèµ·\n      this.input.value = '';\n      this.addOutput('â— å‰Šé™¤ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠå¾Œã€å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„', 'system');\n      \n      // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šContext-Aware Attention Animation\n      this.triggerAttentionAnimation('delete');\n      \n      // DELETEãƒ¢ãƒ¼ãƒ‰ã‚’ç¶­æŒï¼ˆgenerateãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã•ãªã„ï¼‰\n    }\n  }\n\n  /**\n   * ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚ŒãŸæ™‚ã®å‡¦ç†\n   */\n  handleModifyModeSelection() {\n    // SceneManagerã‹ã‚‰é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—\n    const selectedObject = this.sceneManager?.selectedObject;\n    \n    if (selectedObject) {\n      // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹å ´åˆï¼šä¿®æ­£ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒãƒ£ãƒƒãƒˆæ¬„ã«å…¥åŠ›\n      const objectName = selectedObject.userData?.originalPrompt || selectedObject.name || 'é¸æŠã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ';\n      this.input.value = `${objectName}ã‚’`;\n      this.input.focus();\n      \n      // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ–‡æœ«ã«ç§»å‹•ï¼ˆé¸æŠçŠ¶æ…‹ã‚’è§£é™¤ï¼‰\n      this.input.setSelectionRange(this.input.value.length, this.input.value.length);\n      \n      this.addOutput(`ğŸ¯ ä¿®æ­£å¯¾è±¡: ${objectName}`, 'system');\n    } else {\n      // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãªã„å ´åˆï¼š2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§æ³¨æ„å–šèµ·\n      this.input.value = '';\n      this.addOutput('â— ä¿®æ­£ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠå¾Œã€ä¿®æ­£ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„', 'system');\n      \n      // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šContext-Aware Attention Animation\n      this.triggerAttentionAnimation('modify');\n      \n      // Modifyãƒ¢ãƒ¼ãƒ‰ã‚’ç¶­æŒï¼ˆgenerateãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã•ãªã„ï¼‰\n    }\n  }\n\n  /**\n   * 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šContext-Aware Attention Animation\n   * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠæ™‚ã®æ³¨æ„å–šèµ·ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n   */\n  triggerAttentionAnimation(mode) {\n    const chatOutput = this.chatOutput;\n    const inputField = this.input;\n    \n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰1: Micro-Shake Effectï¼ˆå¾®ç´°ãªéœ‡ãˆï¼‰\n    this.addMicroShakeEffect(chatOutput);\n    \n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰2: Context-Aware Glowï¼ˆçŠ¶æ³èªè­˜ã‚°ãƒ­ãƒ¼ï¼‰\n    this.addContextGlow(inputField, mode);\n    \n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰3: Emotional Pulseï¼ˆæ„Ÿæƒ…çš„ãƒ‘ãƒ«ã‚¹ï¼‰\n    this.addEmotionalPulse(chatOutput, mode);\n    \n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰4: 3D Depth Shadowï¼ˆç«‹ä½“çš„å½±åŠ¹æœï¼‰\n    this.add3DDepthEffect(chatOutput);\n  }\n\n  /**\n   * 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šMicro-Shake Effect\n   */\n  addMicroShakeEffect(element) {\n    element.style.animation = 'microShake2025 0.5s ease-in-out';\n    \n    // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•çš„è¿½åŠ \n    this.ensureMicroShakeAnimation();\n    \n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    setTimeout(() => {\n      element.style.animation = '';\n    }, 500);\n  }\n\n  /**\n   * 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šContext-Aware Glow\n   */\n  addContextGlow(element, mode) {\n    const glowColor = mode === 'delete' ? 'rgba(239, 68, 68, 0.4)' : 'rgba(99, 102, 241, 0.4)';\n    \n    element.style.transition = 'all 0.3s ease';\n    element.style.boxShadow = `0 0 20px ${glowColor}, 0 0 40px ${glowColor}`;\n    \n    // 3ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ\n    setTimeout(() => {\n      element.style.boxShadow = '';\n    }, 3000);\n  }\n\n  /**\n   * 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šEmotional Pulse\n   */\n  addEmotionalPulse(element, mode) {\n    const pulseColor = mode === 'delete' ? '#ef4444' : '#6366f1';\n    \n    element.style.borderLeft = `4px solid ${pulseColor}`;\n    element.style.animation = 'emotionalPulse2025 2s ease-in-out infinite';\n    \n    // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•çš„è¿½åŠ \n    this.ensureEmotionalPulseAnimation();\n    \n    // 6ç§’å¾Œã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢\n    setTimeout(() => {\n      element.style.animation = '';\n      element.style.borderLeft = '';\n    }, 6000);\n  }\n\n  /**\n   * 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼š3D Depth Effect\n   */\n  add3DDepthEffect(element) {\n    element.style.transform = 'translateZ(8px) rotateX(1deg)';\n    element.style.transition = 'transform 0.3s ease';\n    \n    // 2ç§’å¾Œã«å…ƒã«æˆ»ã™\n    setTimeout(() => {\n      element.style.transform = '';\n    }, 2000);\n  }\n\n  /**\n   * Micro-Shake CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºä¿\n   */\n  ensureMicroShakeAnimation() {\n    if (document.getElementById('micro-shake-2025')) return;\n    \n    const style = document.createElement('style');\n    style.id = 'micro-shake-2025';\n    style.textContent = `\n      @keyframes microShake2025 {\n        0%, 100% { transform: translateX(0); }\n        10% { transform: translateX(-2px) rotateZ(-0.5deg); }\n        20% { transform: translateX(2px) rotateZ(0.5deg); }\n        30% { transform: translateX(-1px) rotateZ(-0.3deg); }\n        40% { transform: translateX(1px) rotateZ(0.3deg); }\n        50% { transform: translateX(-0.5px) rotateZ(-0.1deg); }\n        60% { transform: translateX(0.5px) rotateZ(0.1deg); }\n        70% { transform: translateX(0); }\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  /**\n   * Emotional Pulse CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºä¿\n   */\n  ensureEmotionalPulseAnimation() {\n    if (document.getElementById('emotional-pulse-2025')) return;\n    \n    const style = document.createElement('style');\n    style.id = 'emotional-pulse-2025';\n    style.textContent = `\n      @keyframes emotionalPulse2025 {\n        0% { \n          border-left-width: 4px;\n          filter: brightness(1);\n        }\n        50% { \n          border-left-width: 8px;\n          filter: brightness(1.2) saturate(1.1);\n        }\n        100% { \n          border-left-width: 4px;\n          filter: brightness(1);\n        }\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å…¥åŠ›æ¬„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸Šæ›¸ãæ©Ÿèƒ½\n   * ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šï¼šä»–ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ–°ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸçŠ¶æ…‹ã«ã‚¯ãƒªã‚¢\n   */\n  clearInputOnModeSwitch(newMode) {\n    // ç¾åœ¨ã®å…¥åŠ›æ¬„ã«å†…å®¹ãŒã‚ã‚‹å ´åˆã®ã¿å‡¦ç†\n    if (this.input.value.trim()) {\n      // ä»¥å‰ã®ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã©ã†ã‹ã‚’åˆ¤å®š\n      const isPreviousModeMessage = this.isPreviousModeMessage(this.input.value, newMode);\n      \n      if (isPreviousModeMessage) {\n        // ä»¥å‰ã®ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã€æ–°ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç½®ãæ›ãˆ\n        this.input.value = '';\n        this.addOutput(`ğŸ’« ${this.getModeDisplayName(newMode)}ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, 'system');\n      }\n    }\n  }\n\n  /**\n   * å…¥åŠ›å†…å®¹ãŒä»¥å‰ã®ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã©ã†ã‹ã‚’åˆ¤å®š\n   */\n  isPreviousModeMessage(inputValue, currentMode) {\n    // Delete/Modifyãƒ¢ãƒ¼ãƒ‰ã®ç‰¹å¾´çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º\n    const deletePatterns = [\n      /.*ã‚’å‰Šé™¤$/,\n      /å‰Šé™¤$/\n    ];\n    \n    const modifyPatterns = [\n      /.*ã‚’$/,\n      /.*ã‚’å¤‰æ›´/,\n      /.*ã‚’ãƒ”ãƒ³ã‚¯/,\n      /.*ã‚’å¤§ãã/,\n      /.*ã‚’å°ã•ã/,\n      /.*ã‚’ç§»å‹•/,\n      /å›è»¢/,\n      /åè»¢/,\n      /ãƒŸãƒ©ãƒ¼/,\n      /å‚¾ã‘/,\n      /å‘ãã‚’å¤‰ãˆ/,\n      /.*ã‚’.*è‰²/,\n      /.*ã‚’.*ã‚µã‚¤ã‚º/\n    ];\n    \n    const importPatterns = [\n      /ãƒ•ã‚¡ã‚¤ãƒ«/,\n      /ç”»åƒ/,\n      /ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/\n    ];\n\n    // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã¨ç•°ãªã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã™ã‚‹å ´åˆã¯ä¸Šæ›¸ãå¯¾è±¡\n    switch (currentMode) {\n      case 'delete':\n        return modifyPatterns.some(pattern => pattern.test(inputValue)) ||\n               importPatterns.some(pattern => pattern.test(inputValue));\n               \n      case 'modify':\n        return deletePatterns.some(pattern => pattern.test(inputValue)) ||\n               importPatterns.some(pattern => pattern.test(inputValue));\n               \n      case 'import':\n        return deletePatterns.some(pattern => pattern.test(inputValue)) ||\n               modifyPatterns.some(pattern => pattern.test(inputValue));\n               \n      case 'generate':\n        return deletePatterns.some(pattern => pattern.test(inputValue)) ||\n               modifyPatterns.some(pattern => pattern.test(inputValue)) ||\n               importPatterns.some(pattern => pattern.test(inputValue));\n               \n      default:\n        return false;\n    }\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºåã‚’å–å¾—\n   */\n  getModeDisplayName(mode) {\n    const modeNames = {\n      'generate': 'ç”Ÿæˆ',\n      'import': 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆ',\n      'modify': 'ä¿®æ­£',\n      'delete': 'å‰Šé™¤'\n    };\n    return modeNames[mode] || mode;\n  }\n\n  /**\n   * å¸¸æ™‚è¡¨ç¤ºãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ§ã‚³ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆ\n   */\n  createFloatingChocolateIcon() {\n    // æ—¢å­˜ã®ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤\n    if (this.floatingChocolateIcon) {\n      this.floatingChocolateIcon.remove();\n    }\n\n    this.floatingChocolateIcon = document.createElement('div');\n    this.floatingChocolateIcon.innerHTML = 'ğŸ«';\n    this.floatingChocolateIcon.title = 'ChocoDrop ã‚’é–‹ã (@ã‚­ãƒ¼ã§ã‚‚é–‹ã‘ã¾ã™)';\n    this.floatingChocolateIcon.style.cssText = `\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      width: 48px;\n      height: 48px;\n      border-radius: 50%;\n      background: rgba(99, 102, 241, 0.15);\n      backdrop-filter: blur(16px);\n      -webkit-backdrop-filter: blur(16px);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05);\n      opacity: 0.8;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 20px;\n      cursor: pointer;\n      z-index: 999;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      transform: scale(1);\n      filter: none;\n    `;\n\n    // ãƒ›ãƒãƒ¼åŠ¹æœ\n    this.floatingChocolateIcon.addEventListener('mouseover', () => {\n      this.floatingChocolateIcon.style.transform = 'scale(1.1) translateY(-2px)';\n      this.floatingChocolateIcon.style.boxShadow = '0 6px 16px rgba(99, 102, 241, 0.3), 0 3px 8px rgba(0, 0, 0, 0.1)';\n      this.floatingChocolateIcon.style.opacity = '1';\n      this.floatingChocolateIcon.style.filter = 'none';\n    });\n\n    this.floatingChocolateIcon.addEventListener('mouseout', () => {\n      this.floatingChocolateIcon.style.transform = 'scale(1) translateY(0)';\n      this.floatingChocolateIcon.style.boxShadow = '0 4px 12px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05)';\n      this.floatingChocolateIcon.style.opacity = '0.8';\n      this.floatingChocolateIcon.style.filter = 'none';\n    });\n\n    // ã‚¯ãƒªãƒƒã‚¯ã§ ChocoDrop ã‚’é–‹ã\n    this.floatingChocolateIcon.addEventListener('click', () => {\n      if (this.isVisible) {\n        this.hide();\n      } else {\n        this.show();\n      }\n    });\n\n    // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼\n    this.floatingChocolateIcon.addEventListener('contextmenu', (e) => {\n      e.preventDefault();\n      this.showFloatingIconContextMenu(e);\n    });\n\n    // DOM ã«è¿½åŠ \n    document.body.appendChild(this.floatingChocolateIcon);\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ã‚¤ã‚³ãƒ³ã®å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º\n   */\n  showFloatingIconContextMenu(event) {\n    // æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤\n    const existingMenu = document.querySelector('.floating-icon-context-menu');\n    if (existingMenu) {\n      existingMenu.remove();\n    }\n\n    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆ\n    const menu = document.createElement('div');\n    menu.className = 'floating-icon-context-menu';\n    menu.style.cssText = `\n      position: fixed;\n      top: ${event.clientY}px;\n      left: ${event.clientX}px;\n      background: ${this.isDarkMode ? 'rgba(17, 24, 39, 0.85)' : 'rgba(255, 255, 255, 0.85)'};\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid ${this.isDarkMode ? 'rgba(129, 140, 248, 0.3)' : 'rgba(99, 102, 241, 0.2)'};\n      border-radius: 12px;\n      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);\n      padding: 8px 0;\n      min-width: 160px;\n      z-index: 2000;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      color: ${this.isWabiSabiMode ? '#F5F5F5' : (this.isDarkMode ? '#ffffff' : '#1f2937')};\n    `;\n\n    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ 1: ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã\n    const openFormItem = document.createElement('div');\n    openFormItem.innerHTML = 'ğŸ“„ ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';\n    openFormItem.style.cssText = `\n      padding: 8px 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      color: #6366f1;\n      text-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);\n    `;\n\n    openFormItem.addEventListener('mouseover', () => {\n      openFormItem.style.background = this.isDarkMode ? 'rgba(99, 102, 241, 0.15)' : 'rgba(99, 102, 241, 0.1)';\n      openFormItem.style.textShadow = '0 2px 6px rgba(99, 102, 241, 0.5)';\n    });\n\n    openFormItem.addEventListener('mouseout', () => {\n      openFormItem.style.background = 'transparent';\n      openFormItem.style.textShadow = '0 2px 4px rgba(99, 102, 241, 0.3)';\n    });\n\n    openFormItem.addEventListener('click', () => {\n      menu.remove();\n      if (this.isVisible) {\n        this.hide();\n      } else {\n        this.show();\n      }\n    });\n\n    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ 2: ã‚¢ã‚¤ã‚³ãƒ³ã‚’éè¡¨ç¤º\n    const hideIconItem = document.createElement('div');\n    hideIconItem.innerHTML = 'âœ• ã‚¢ã‚¤ã‚³ãƒ³ã‚’éè¡¨ç¤º';\n    hideIconItem.style.cssText = `\n      padding: 8px 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      color: #6366f1;\n      text-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);\n    `;\n\n    hideIconItem.addEventListener('mouseover', () => {\n      hideIconItem.style.background = this.isDarkMode ? 'rgba(99, 102, 241, 0.15)' : 'rgba(99, 102, 241, 0.1)';\n      hideIconItem.style.textShadow = '0 2px 6px rgba(99, 102, 241, 0.5)';\n    });\n\n    hideIconItem.addEventListener('mouseout', () => {\n      hideIconItem.style.background = 'transparent';\n      hideIconItem.style.textShadow = '0 2px 4px rgba(99, 102, 241, 0.3)';\n    });\n\n    hideIconItem.addEventListener('click', () => {\n      menu.remove();\n      this.hideFloatingIcon();\n    });\n\n    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¿½åŠ \n    menu.appendChild(openFormItem);\n    menu.appendChild(hideIconItem);\n\n    // DOM ã«è¿½åŠ \n    document.body.appendChild(menu);\n\n    // ç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†ã«èª¿æ•´\n    const rect = menu.getBoundingClientRect();\n    if (rect.right > window.innerWidth) {\n      menu.style.left = `${event.clientX - rect.width}px`;\n    }\n    if (rect.bottom > window.innerHeight) {\n      menu.style.top = `${event.clientY - rect.height}px`;\n    }\n\n    // å¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹\n    const closeMenu = (e) => {\n      if (!menu.contains(e.target)) {\n        menu.remove();\n        document.removeEventListener('click', closeMenu);\n      }\n    };\n\n    setTimeout(() => {\n      document.addEventListener('click', closeMenu);\n    }, 10);\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ã‚¤ã‚³ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹\n   */\n  hideFloatingIcon() {\n    if (this.floatingChocolateIcon) {\n      this.floatingChocolateIcon.style.display = 'none';\n    }\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹\n   */\n  showFloatingIcon() {\n    if (this.floatingChocolateIcon) {\n      this.floatingChocolateIcon.style.display = 'flex';\n    }\n  }\n\n  dispose() {\n    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠé–¢é€£ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    if (this.fileInput && this.fileInput.parentNode) {\n      this.fileInput.parentNode.removeChild(this.fileInput);\n    }\n    if (this.selectedFile && this.selectedFile.url) {\n      URL.revokeObjectURL(this.selectedFile.url);\n    }\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ§ã‚³ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    if (this.floatingChocolateIcon && this.floatingChocolateIcon.parentNode) {\n      this.floatingChocolateIcon.parentNode.removeChild(this.floatingChocolateIcon);\n    }\n\n    if (this.container && this.container.parentElement) {\n      this.container.parentElement.removeChild(this.container);\n    }\n  }\n\n  showOverlayTextarea() {\n    if (this.overlayTextarea) return;\n\n    this.isExpanded = true;\n    \n    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ä½œæˆ\n    this.overlayTextarea = document.createElement('textarea');\n    this.overlayTextarea.value = this.input.value;\n    this.overlayTextarea.placeholder = this.input.placeholder;\n    \n    // ãƒ•ã‚©ãƒ¼ãƒ ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’å–å¾—\n    const containerRect = this.container.getBoundingClientRect();\n    \n    // ç”»é¢å¢ƒç•Œã‚’è€ƒæ…®ã—ãŸä½ç½®èª¿æ•´\n    const overlayHeight = 300;\n    const padding = 20;\n    \n    let top = containerRect.top + 60;\n    let left = containerRect.left;\n    let width = containerRect.width;\n    \n    // å³ç«¯ãŒã¯ã¿å‡ºã‚‹å ´åˆ\n    if (left + width > window.innerWidth - padding) {\n      left = window.innerWidth - width - padding;\n    }\n    \n    // å·¦ç«¯ãŒã¯ã¿å‡ºã‚‹å ´åˆ\n    if (left < padding) {\n      left = padding;\n      width = Math.min(width, window.innerWidth - 2 * padding);\n    }\n    \n    // ä¸‹ç«¯ãŒã¯ã¿å‡ºã‚‹å ´åˆ\n    if (top + overlayHeight > window.innerHeight - padding) {\n      top = Math.max(padding, window.innerHeight - overlayHeight - padding);\n    }\n\n    const overlayBackground = this.isWabiSabiMode\n      ? 'linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))'\n      : (this.isDarkMode\n        ? 'linear-gradient(135deg, rgba(30, 27, 75, 0.4), rgba(15, 23, 42, 0.5))'\n        : 'linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))');\n\n    const overlayBorder = this.isWabiSabiMode\n      ? '1px solid rgba(93, 64, 55, 0.5)'\n      : (this.isDarkMode\n        ? '1px solid rgba(99, 102, 241, 0.25)'\n        : '1px solid rgba(255, 255, 255, 0.5)');\n\n    const overlayInnerShadow = this.isWabiSabiMode\n      ? '0 4px 16px rgba(66, 66, 66, 0.3), inset 0 1px 0 rgba(189, 189, 189, 0.2)'\n      : (this.isDarkMode\n        ? '0 4px 16px rgba(15, 23, 42, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08)'\n        : '0 4px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.4)');\n\n    const overlayTextColor = this.isWabiSabiMode ? '#F5F5F5' : (this.isDarkMode ? '#ffffff' : '#1f2937');\n\n    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š\n    this.overlayTextarea.style.cssText = `\n      position: fixed;\n      top: ${top}px;\n      left: ${left}px;\n      width: ${width}px;\n      height: ${overlayHeight}px;\n      box-sizing: border-box;\n      background: ${overlayBackground};\n      backdrop-filter: blur(24px) saturate(180%);\n      border: ${overlayBorder};\n      box-shadow: ${overlayInnerShadow};\n      border-radius: 16px;\n      color: ${overlayTextColor};\n      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      line-height: 1.5;\n      padding: 20px;\n      resize: none;\n      outline: none;\n      z-index: 10000;\n      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);\n      opacity: 0;\n      transition: opacity 0.2s ease-out;\n    `;\n    \n    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¿½åŠ \n    document.body.appendChild(this.overlayTextarea);\n    \n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹\n    requestAnimationFrame(() => {\n      this.overlayTextarea.style.opacity = '1';\n    });\n    \n    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¨­å®š\n    this.overlayTextarea.focus();\n    \n    // å…¥åŠ›åŒæœŸ\n    this.overlayTextarea.addEventListener('input', (e) => {\n      this.input.value = e.target.value;\n    });\n    \n    // Escapeã‚­ãƒ¼ã§é–‰ã˜ã‚‹\n    this.overlayTextarea.addEventListener('keydown', (e) => {\n      if (e.key === 'Escape') {\n        this.hideOverlayTextarea();\n      }\n    });\n    \n    // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹\n    this.overlayTextarea.addEventListener('blur', () => {\n      setTimeout(() => this.hideOverlayTextarea(), 100);\n    });\n  }\n  \n  hideOverlayTextarea() {\n    if (!this.overlayTextarea) return;\n    \n    this.isExpanded = false;\n    \n    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    this.overlayTextarea.style.opacity = '0';\n    \n    setTimeout(() => {\n      if (this.overlayTextarea) {\n        document.body.removeChild(this.overlayTextarea);\n        this.overlayTextarea = null;\n      }\n    }, 200);\n  }\n  \n  hideOverlayTextarea() {\n    if (!this.overlayTextarea) return;\n    \n    this.isExpanded = false;\n    \n    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    this.overlayTextarea.style.opacity = '0';\n    \n    setTimeout(() => {\n      if (this.overlayTextarea) {\n        document.body.removeChild(this.overlayTextarea);\n        this.overlayTextarea = null;\n      }\n    }, 200);\n  }\n}\n","const IMAGE_SERVICE_STORAGE_KEY = 'chocodrop-service-image';\nconst VIDEO_SERVICE_STORAGE_KEY = 'chocodrop-service-video';\nconst KEYWORD_HIGHLIGHT_COLOR = '#ff6ad5';\n\n/**\n * Command UI - Web interface for ChocoDrop System\n * Real-time natural language command interface for 3D scenes\n */\nexport class CommandUI {\n  constructor(options = {}) {\n    this.sceneManager = options.sceneManager || null;\n    this.client = options.client || null;\n    this.onControlsToggle = options.onControlsToggle || (() => {});\n    \n    this.isVisible = false;\n    this.container = null;\n    this.input = null;\n    this.output = null;\n    this.currentMode = 'generate';\n\n    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—ç®¡ç†\n    this.activeConnections = new Map();\n    this.currentTaskId = null;\n    \n    // è¨­å®š\n    this.config = {\n      activationKey: options.activationKey || '@',\n      position: options.position || 'bottom-right',\n      width: options.width || 450,\n      maxHeight: options.maxHeight || 600,\n      theme: options.theme || 'dark',\n      showExamples: options.showExamples !== false,\n      autoScroll: options.autoScroll !== false,\n      enableDebugLogging: options.enableDebugLogging === true,\n      ...options.config\n    };\n\n    this.availableImageServices = [];\n    this.availableVideoServices = [];\n    this.selectedImageService = null;\n    this.selectedVideoService = null;\n    this.highlightOverlay = null;\n    this.inputDefaultStyles = null;\n    this.imageServiceSelect = null;\n    this.videoServiceSelect = null;\n    this.serviceSelectorContainer = null;\n    this.serviceSelectorStatus = null;\n    this.serviceSelectorContent = null;\n    this.serviceSelectorRetryButton = null;\n    this.serviceSelectorSaveButton = null;\n    this.serviceSelectorCancelButton = null;\n    this.serviceModalOverlay = null;\n    this.serviceModal = null;\n    this.servicesLoading = false;\n    this.isExpanded = false;\n    this.overlayTextarea = null;\n    this.pendingImageService = null;\n    this.pendingVideoService = null;\n\n    try {\n      const storedImage = localStorage.getItem(IMAGE_SERVICE_STORAGE_KEY);\n      const storedVideo = localStorage.getItem(VIDEO_SERVICE_STORAGE_KEY);\n      console.log('ğŸ” Debug localStorage read:', { storedImage, storedVideo, IMAGE_SERVICE_STORAGE_KEY, VIDEO_SERVICE_STORAGE_KEY });\n      if (storedImage) {\n        this.selectedImageService = storedImage;\n        console.log('âœ… Set selectedImageService:', this.selectedImageService);\n      }\n      if (storedVideo) {\n        this.selectedVideoService = storedVideo;\n        console.log('âœ… Set selectedVideoService:', this.selectedVideoService);\n      }\n      console.log('ğŸ” Final values:', { selectedImageService: this.selectedImageService, selectedVideoService: this.selectedVideoService });\n    } catch (error) {\n      console.warn('âš ï¸ Failed to load stored service selections:', error);\n    }\n\n    this.pendingImageService = this.selectedImageService;\n    this.pendingVideoService = this.selectedVideoService;\n\n    this.applyServiceSelectionToSceneManager();\n    console.log('ğŸ” After applyServiceSelectionToSceneManager - UI:', { selectedImageService: this.selectedImageService, selectedVideoService: this.selectedVideoService });\n    console.log('ğŸ” After applyServiceSelectionToSceneManager - SceneManager:', { selectedImageService: this.sceneManager?.selectedImageService, selectedVideoService: this.sceneManager?.selectedVideoService });\n\n    // ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ç®¡ç† (light, dark, wabisabi)\n    this.currentTheme = localStorage.getItem('live-command-theme') || 'light';\n    this.isDarkMode = this.currentTheme === 'dark';\n    this.isWabiSabiMode = this.currentTheme === 'wabisabi';\n    \n    // Undo/Redo ã‚·ã‚¹ãƒ†ãƒ \n    this.commandHistory = [];\n    this.currentHistoryIndex = -1;\n    this.maxHistorySize = 50; // æœ€å¤§ã‚³ãƒãƒ³ãƒ‰ä¿å­˜æ•°\n    \n    this.initUI();\n    this.bindEvents();\n\n    if (!this.client && this.sceneManager && this.sceneManager.client) {\n      this.client = this.sceneManager.client;\n    }\n\n    this.createServiceModal();\n    this.createFloatingChocolateIcon();\n\n    // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¢ºå®Ÿã«é©ç”¨\n    document.addEventListener('DOMContentLoaded', () => {\n      this.refreshStyles();\n    });\n\n    this.logDebug('ğŸ® CommandUI initialized');\n\n    if (!this.selectedImageService || !this.selectedVideoService) {\n      this.openServiceModal(true);\n    }\n  }\n\n  logDebug(...args) {\n    if (!this.config.enableDebugLogging) {\n      return;\n    }\n    console.log(...args);\n  }\n\n  /**\n   * UIè¦ç´ ã®ä½œæˆã¨é…ç½®\n   */\n  initUI() {\n    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ\n    this.container = document.createElement('div');\n    this.container.id = 'live-command-ui';\n    this.container.style.cssText = this.getContainerStyles();\n\n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šProgressive Disclosureï¼ˆãƒ›ãƒãƒ¼æ™‚ã®ã¿ãƒ–ãƒ©ãƒ³ãƒ‰è¡¨ç¤ºï¼‰\n    const brandIndicator = document.createElement('div');\n    brandIndicator.className = 'progressive-brand-indicator';\n    brandIndicator.style.cssText = `\n      position: absolute;\n      top: -8px;\n      right: 8px;\n      width: 8px;\n      height: 8px;\n      background: linear-gradient(135deg, ${this.isWabiSabiMode ? '#8BC34A, #689F38' : '#6366f1, #8b5cf6'});\n      border-radius: 50%;\n      opacity: 0.7;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      z-index: 10;\n      cursor: pointer;\n    `;\n    \n    // Progressive Disclosure: ãƒ›ãƒãƒ¼/ã‚¯ãƒªãƒƒã‚¯ã§ãƒ–ãƒ©ãƒ³ãƒ‰åè¡¨ç¤º\n    const brandText = document.createElement('div');\n    brandText.className = 'progressive-brand-text';\n    brandText.style.cssText = `\n      position: absolute;\n      top: -35px;\n      right: -5px;\n      padding: 6px 12px;\n      background: rgba(255, 255, 255, 0.15);\n      border: 1px solid ${this.isDarkMode ? 'rgba(129, 140, 248, 0.3)' : 'rgba(99, 102, 241, 0.25)'};\n      border-radius: 12px;\n      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);\n      color: ${this.isDarkMode ? '#ffffff' : '#1f2937'};\n      font-size: 11px;\n      font-weight: 700;\n      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      letter-spacing: 0.02em;\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      opacity: 0;\n      transform: translateY(5px) scale(0.9);\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      pointer-events: none;\n      z-index: 11;\n      white-space: nowrap;\n    `;\n    brandText.innerHTML = '<span style=\"filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);\">ğŸ«</span> <span style=\"color: #6366f1;\">ChocoDrop</span>';\n    \n    // Progressive Disclosure ã‚¤ãƒ™ãƒ³ãƒˆ\n    brandIndicator.addEventListener('mouseenter', () => {\n      brandText.style.opacity = '1';\n      brandText.style.transform = 'translateY(0) scale(1)';\n      brandIndicator.style.transform = 'scale(1.2)';\n      brandIndicator.style.opacity = '1';\n    });\n    \n    brandIndicator.addEventListener('mouseleave', () => {\n      brandText.style.opacity = '0';\n      brandText.style.transform = 'translateY(5px) scale(0.9)';\n      brandIndicator.style.transform = 'scale(1)';\n      brandIndicator.style.opacity = '0.7';\n    });\n    \n    brandIndicator.appendChild(brandText);\n    this.container.appendChild(brandIndicator);\n\n    // å‡ºåŠ›ã‚¨ãƒªã‚¢ï¼ˆã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠï¼‰- éè¡¨ç¤ºã«å¤‰æ›´\n    this.output = document.createElement('div');\n    this.outputDiv = this.output; // ä¸¡æ–¹ã®å‚ç…§ã‚’ä¿æŒï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰\n    this.output.id = 'command-output';\n    this.output.className = 'command-output';\n    this.output.style.cssText = this.getOutputStyles();\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ç”¨ã‚³ãƒ³ãƒ†ãƒŠ\n    this.floatingContainer = document.createElement('div');\n    this.floatingContainer.id = 'floating-cards-container';\n    this.floatingContainer.style.cssText = `\n      position: fixed;\n      bottom: var(--floating-bottom, 120px);\n      left: 50%;\n      transform: translateX(-50%);\n      z-index: 99999;\n      pointer-events: none;\n      display: none;\n      flex-direction: column;\n      gap: 8px;\n      width: 400px;\n      max-width: 90vw;\n      align-items: center;\n      justify-content: flex-start;\n    `;\n\n    // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ç®¡ç†ç”¨\n    this.taskCards = new Map();\n\n    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆå±•é–‹ãƒœã‚¿ãƒ³ç”¨ï¼‰\n    this.inputWrapper = document.createElement('div');\n    this.inputWrapper.style.cssText = `\n      position: relative;\n      width: 100%;\n      margin-bottom: 0;\n    `;\n\n    // Ultra-Simple å˜ä¸€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆè‡ªå‹•ãƒªã‚µã‚¤ã‚ºå¯¾å¿œï¼‰\n    this.input = document.createElement('textarea');\n    this.input.rows = 1;\n    this.input.id = 'command-input';\n    this.input.placeholder = 'ã€Œå³ä¸Šã«ãƒ‰ãƒ©ã‚´ãƒ³ã‚’ã€ã€Œç¾ã—ã„æ¡œã®æ£®ã‚’ä¸­å¤®ã«ã€ãªã©... âœ¨';\n    this.input.style.cssText = this.getInputStyles();\n\n    // å±•é–‹ãƒœã‚¿ãƒ³ï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰\n    this.expandButton = document.createElement('div');\n    this.expandButton.innerHTML = 'â¤¢';\n    this.expandButton.title = 'ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‚’è¡¨ç¤º';\n    this.expandButton.style.cssText = `\n      position: absolute;\n      bottom: 8px;\n      right: 8px;\n      width: 24px;\n      height: 24px;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'};\n      border: 1px solid ${this.isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)'};\n      border-radius: 6px;\n      color: ${this.isDarkMode ? '#ffffff' : '#1f2937'};\n      font-size: 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      z-index: 1;\n    `;\n\n    // å±•é–‹ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼åŠ¹æœ\n    this.expandButton.addEventListener('mouseenter', () => {\n      this.expandButton.style.background = this.isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)';\n      this.expandButton.style.transform = 'scale(1.1)';\n    });\n\n    this.expandButton.addEventListener('mouseleave', () => {\n      this.expandButton.style.background = this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';\n      this.expandButton.style.transform = 'scale(1)';\n    });\n\n    // å±•é–‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†\n    this.expandButton.addEventListener('click', () => {\n      if (this.isExpanded) {\n        this.hideOverlayTextarea();\n      } else {\n        this.showOverlayTextarea();\n      }\n    });\n\n    // ãƒ©ãƒƒãƒ‘ãƒ¼ã«è¦ç´ ã‚’è¿½åŠ \n    this.inputWrapper.appendChild(this.input);\n    this.inputWrapper.appendChild(this.expandButton);\n\n    // æ—§ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIã«çµ±åˆï¼‰\n\n    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³é¢¨ãƒ¢ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼\n    const modeSelector = this.createRadioModeSelector();\n\n    // ãƒŸãƒ‹ãƒãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³\n    const actionContainer = this.createMinimalActions();\n\n    // Ã—ã‚¯ãƒ­ãƒ¼ã‚ºãƒœã‚¿ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒ å³ä¸Šã«è¿½åŠ \n    const closeButton = document.createElement('div');\n    closeButton.innerHTML = 'Ã—';\n    closeButton.style.cssText = `\n      position: absolute;\n      top: 12px;\n      right: 12px;\n      width: 22px;\n      height: 22px;\n      border-radius: 50%;\n      background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'};\n      color: ${this.isDarkMode ? '#ffffff' : '#1f2937'};\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: normal;\n      transition: all 0.2s ease;\n      backdrop-filter: blur(8px);\n      z-index: 10;\n    `;\n\n    closeButton.addEventListener('mouseover', () => {\n      closeButton.style.background = this.isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)';\n      closeButton.style.transform = 'scale(1.1)';\n    });\n\n    closeButton.addEventListener('mouseout', () => {\n      closeButton.style.background = this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';\n      closeButton.style.color = this.isDarkMode ? '#ffffff' : '#1f2937';\n      closeButton.style.transform = 'scale(1)';\n    });\n\n    closeButton.addEventListener('click', () => {\n      this.hide();\n    });\n\n    // çµ„ã¿ç«‹ã¦ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å‰Šé™¤ã€ãƒ–ãƒ©ãƒ³ãƒ‰ãƒãƒƒã‚¸ã¯æ—¢ã«è¿½åŠ æ¸ˆã¿ï¼‰\n    // this.container.appendChild(this.output); // å¤§ããªã‚¿ã‚¹ã‚¯è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’DOMã«è¿½åŠ ã—ãªã„\n    this.container.appendChild(closeButton);\n    this.container.appendChild(modeSelector);\n    this.container.appendChild(this.inputWrapper);\n    this.container.appendChild(actionContainer);\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã‚’bodyã«ç›´æ¥è¿½åŠ \n    document.body.appendChild(this.floatingContainer);\n\n    // DOM ã«è¿½åŠ \n    document.body.appendChild(this.container);\n\n    // åˆå›ãƒ†ãƒ¼ãƒé©ç”¨\n    this.applyTheme();\n\n    // æ—¥æœ¬èªIMEå¯¾å¿œã®composition stateç®¡ç†\n    this.isComposing = false;\n    this.hasCompositionJustEnded = false;\n\n    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›ç›£è¦–ã¨ã‚³ãƒãƒ³ãƒ‰æ¤œå‡ºï¼ˆIMEå¯¾å¿œï¼‰\n    this.input.addEventListener('input', () => {\n      // IMEå…¥åŠ›ä¸­ã¯ã‚³ãƒãƒ³ãƒ‰æ¤œå‡ºã‚’åœæ­¢\n      if (this.isComposing) {\n        return;\n      }\n      \n      // è‡ªå‹•ãƒªã‚µã‚¤ã‚ºå‡¦ç†\n      this.autoResizeTextarea();\n      \n      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆé©ç”¨\n      this.applyKeywordHighlighting();\n      \n      this.detectCommandType();\n    });\n    \n    // æ—¥æœ¬èªIME composition events\n    this.input.addEventListener('compositionstart', () => {\n      this.isComposing = true;\n    });\n    \n    this.input.addEventListener('compositionend', () => {\n      this.isComposing = false;\n      \n      // Safariã®ã¿ãƒ•ãƒ©ã‚°è¨­å®šï¼ˆä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä¸è¦ï¼‰\n      const isSafari = /Safari/.test(navigator.userAgent) && /Version/.test(navigator.userAgent);\n      if (isSafari) {\n        this.hasCompositionJustEnded = true;\n      }\n      \n      // ç¢ºå®šå¾Œã®ã‚³ãƒãƒ³ãƒ‰æ¤œå‡ºã‚’å®Ÿè¡Œ\n      setTimeout(() => {\n        this.autoResizeTextarea();\n        this.detectCommandType();\n      }, 10);\n    });\n    \n    // Safariåˆ¤å®š\n    const isSafari = /Safari/.test(navigator.userAgent) && /Version/.test(navigator.userAgent);\n    \n    // æ—¥æœ¬èªIMEå¯¾å¿œEnterã‚­ãƒ¼å‡¦ç†ï¼ˆSafariå¯¾å¿œç‰ˆï¼‰\n    this.input.addEventListener('keydown', (e) => {\n      if (e.key === 'Enter') {\n        // Safari: compositionendç›´å¾Œã®Enterã‚’ã‚¹ã‚­ãƒƒãƒ—\n        if (isSafari && this.hasCompositionJustEnded) {\n          this.hasCompositionJustEnded = false;\n          return;\n        }\n        \n        // ãã®ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶: isComposingãƒã‚§ãƒƒã‚¯\n        if (!isSafari && (e.isComposing || this.isComposing)) {\n          return;\n        }\n        \n\n\n        e.preventDefault();\n        this.executeCommand();\n      }\n    });\n    \n    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\n    if (this.config.showExamples) {\n      // èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤\n      // èµ·å‹•æ™‚ã¯é™ã‹ã«å¾…æ©Ÿ\n    }\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ä½œæˆ\n   */\n  createMinimalActions() {\n    const container = document.createElement('div');\n    container.style.cssText = `\n      display: flex;\n      margin-top: 8px;\n      margin-bottom: 0 !important;\n      gap: 8px;\n      justify-content: space-between;\n      align-items: center;\n    `;\n\n    // å·¦å´: Clear All ãƒœã‚¿ãƒ³ï¼ˆæ‰¿èªæ¸ˆã¿ã®Layout Bãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰\n    const leftSection = document.createElement('div');\n    leftSection.style.cssText = 'display: flex; gap: 8px; align-items: center;';\n\n    const clearBtn = document.createElement('button');\n    clearBtn.innerHTML = '<span style=\"filter: hue-rotate(240deg) saturate(0.7) brightness(0.9);\">ğŸ§¹</span> Clear All';\n    clearBtn.style.cssText = this.getActionButtonStyles('secondary');\n    clearBtn.addEventListener('click', () => this.clearAllWithConfirmation());\n\n    // å±¥æ­´ãƒœã‚¿ãƒ³ï¼ˆå°†æ¥å®Ÿè£…ç”¨ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ï¼‰- æµ·å¤–UIæ¨™æº–å¯¾å¿œï¼šåŒä¸€å¹…\n    const historyBtn = document.createElement('button');\n    historyBtn.innerHTML = '<span style=\"filter: hue-rotate(240deg) saturate(0.7) brightness(0.9);\">ğŸ“š</span> History';\n    historyBtn.style.cssText = this.getActionButtonStyles('secondary');\n    historyBtn.style.opacity = '0.5';\n    historyBtn.disabled = true;\n    historyBtn.title = 'å±¥æ­´æ©Ÿèƒ½ï¼ˆé–‹ç™ºä¸­ï¼‰';\n\n    leftSection.appendChild(clearBtn);\n    leftSection.appendChild(historyBtn);\n\n    // å³å´: ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ«ã¨è¨­å®šï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ç§»å‹•ï¼‰\n    const rightSection = document.createElement('div');\n    rightSection.style.cssText = 'display: flex; gap: 6px; align-items: center;';\n\n    const themeToggle = document.createElement('button');\n    const getThemeIcon = () => {\n      const themeConfig = {\n        light: 'ğŸŒ™',\n        dark: 'ğŸµ',\n        wabisabi: 'â˜€ï¸'\n      };\n      return themeConfig[this.currentTheme] || 'ğŸŒ™';\n    };\n\n    const getThemeTitle = () => {\n      const titleConfig = {\n        light: 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ',\n        dark: 'ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ',\n        wabisabi: 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ'\n      };\n      return titleConfig[this.currentTheme] || 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ';\n    };\n\n    const getThemeIconWithFilter = () => {\n      const icon = getThemeIcon();\n      // å¤ªé™½ã¯é»„è‰²ãã€ãŠèŒ¶ã¯ç·‘ç³»ã€æœˆã¯ç´«ç³»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼\n      if (icon === 'â˜€ï¸') {\n        return `<span style=\"filter: saturate(1.2) brightness(1.1);\">${icon}</span>`;\n      } else if (icon === 'ğŸµ') {\n        return `<span style=\"filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);\">${icon}</span>`;\n      } else {\n        return `<span style=\"filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);\">${icon}</span>`;\n      }\n    };\n\n    themeToggle.innerHTML = getThemeIconWithFilter();\n    themeToggle.style.cssText = this.getActionButtonStyles('icon');\n    themeToggle.title = getThemeTitle();\n    themeToggle.addEventListener('click', () => this.toggleTheme());\n\n    const settingsButton = document.createElement('button');\n    settingsButton.innerHTML = '<span style=\"filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);\">âš™ï¸</span>';\n    settingsButton.style.cssText = this.getActionButtonStyles('icon');\n    settingsButton.title = 'ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šã‚’é–‹ã';\n    settingsButton.addEventListener('click', () => this.openServiceModal());\n\n    rightSection.appendChild(themeToggle);\n    rightSection.appendChild(settingsButton);\n\n    container.appendChild(leftSection);\n    container.appendChild(rightSection);\n\n    // å‚ç…§ã‚’ä¿æŒ\n    this.clearBtn = clearBtn;\n    this.historyBtn = historyBtn;\n    this.themeToggle = themeToggle;\n    this.settingsButton = settingsButton;\n\n    return container;\n  }\n\n  createServiceSelectorSection() {\n    this.serviceSelectorContainer = document.createElement('div');\n    this.serviceSelectorContainer.id = 'service-selector';\n    this.serviceSelectorContainer.style.cssText = `\n      margin-bottom: 16px;\n      padding: 12px;\n      border-radius: 12px;\n      border: 1px solid transparent;\n      transition: background 0.3s ease, border 0.3s ease;\n    `;\n\n    this.serviceSelectorStatus = document.createElement('div');\n    this.serviceSelectorStatus.textContent = 'ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...';\n    this.serviceSelectorStatus.style.fontSize = '12px';\n    this.serviceSelectorStatus.style.opacity = '0.8';\n    this.serviceSelectorStatus.style.marginBottom = '8px';\n    this.serviceSelectorContainer.appendChild(this.serviceSelectorStatus);\n\n    this.serviceSelectorContent = document.createElement('div');\n    this.serviceSelectorContainer.appendChild(this.serviceSelectorContent);\n\n    this.updateServiceSelectorTheme();\n    return this.serviceSelectorContainer;\n  }\n\n  createServiceModal() {\n    if (this.serviceModalOverlay) {\n      this.serviceModalOverlay.remove();\n      this.serviceModalOverlay = null;\n      this.serviceModal = null;\n    }\n\n    this.serviceModalOverlay = document.createElement('div');\n    this.serviceModalOverlay.id = 'chocodrop-service-modal-overlay';\n    this.serviceModalOverlay.style.cssText = `\n      position: fixed;\n      inset: 0;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      backdrop-filter: blur(18px);\n      -webkit-backdrop-filter: blur(18px);\n      z-index: 2000;\n      padding: 16px !important;\n      opacity: 0;\n      transition: opacity 0.2s ease;\n    `;\n\n    this.serviceModalOverlay.addEventListener('click', (event) => {\n      if (event.target === this.serviceModalOverlay) {\n        this.closeServiceModal();\n      }\n    });\n\n    this.serviceModal = document.createElement('div');\n    this.serviceModal.className = 'chocodrop-service-modal';\n    this.serviceModal.style.cssText = `\n      width: min(420px, 90vw);\n      border-radius: 24px;\n      padding: 26px 28px;\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);\n      display: flex;\n      flex-direction: column;\n      gap: 18px;\n      max-height: 90vh;\n      overflow-y: auto;\n      position: relative;\n    `;\n\n    const title = document.createElement('h2');\n    title.textContent = 'ã‚µãƒ¼ãƒ“ã‚¹è¨­å®š';\n    title.style.cssText = `\n      margin: 0;\n      font-size: 18px;\n      font-weight: 700;\n      letter-spacing: 0.03em;\n    `;\n\n    const subtitle = document.createElement('p');\n    subtitle.textContent = 'åˆ©ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';\n    subtitle.style.cssText = `\n      margin: 0;\n      font-size: 12px;\n      opacity: 0.75;\n    `;\n\n    const selector = this.createServiceSelectorSection();\n\n    const actionRow = document.createElement('div');\n    actionRow.style.cssText = `\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      gap: 16px;\n    `;\n\n    this.serviceSelectorRetryButton = document.createElement('button');\n    this.serviceSelectorRetryButton.textContent = 'å†èª­ã¿è¾¼ã¿';\n    this.serviceSelectorRetryButton.style.cssText = `\n      font-size: 11px;\n      padding: 6px 14px;\n      border-radius: 10px;\n      border: 1px solid transparent;\n      cursor: pointer;\n      display: none;\n      transition: all 0.2s ease;\n    `;\n    this.serviceSelectorRetryButton.addEventListener('click', () => this.initializeServiceSelector(true));\n\n    const actionButtons = document.createElement('div');\n    actionButtons.style.cssText = 'display: flex; gap: 8px;';\n\n    this.serviceSelectorCancelButton = document.createElement('button');\n    this.serviceSelectorCancelButton.textContent = 'Cancel';\n    this.serviceSelectorCancelButton.style.cssText = `\n      font-size: 12px;\n      padding: 8px 16px;\n      border-radius: 10px;\n      border: 1px solid rgba(255, 255, 255, 0.35);\n      background: transparent;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    `;\n    this.serviceSelectorCancelButton.addEventListener('click', () => this.closeServiceModal());\n\n    this.serviceSelectorSaveButton = document.createElement('button');\n    this.serviceSelectorSaveButton.textContent = 'Save';\n    this.serviceSelectorSaveButton.style.cssText = `\n      font-size: 12px;\n      padding: 8px 18px;\n      border-radius: 10px;\n      border: none;\n      cursor: pointer;\n      background: linear-gradient(135deg, ${this.isWabiSabiMode ? '#8BC34A, #689F38' : '#6366f1, #8b5cf6'});\n      color: white;\n      font-weight: 600;\n      transition: all 0.2s ease;\n      box-shadow: 0 12px 24px rgba(99, 102, 241, 0.35);\n    `;\n    this.serviceSelectorSaveButton.addEventListener('click', () => this.handleServiceSave());\n\n    actionButtons.appendChild(this.serviceSelectorCancelButton);\n    actionButtons.appendChild(this.serviceSelectorSaveButton);\n\n    actionRow.appendChild(this.serviceSelectorRetryButton);\n    actionRow.appendChild(actionButtons);\n\n    this.serviceModal.appendChild(title);\n    this.serviceModal.appendChild(subtitle);\n    this.serviceModal.appendChild(selector);\n    this.serviceModal.appendChild(actionRow);\n\n    this.serviceModalOverlay.appendChild(this.serviceModal);\n    document.body.appendChild(this.serviceModalOverlay);\n\n    this.updateServiceSelectorTheme();\n    this.toggleServiceRetryButton(false);\n  }\n\n  openServiceModal(forceFetch = false) {\n    if (!this.serviceModalOverlay) {\n      this.createServiceModal();\n    }\n\n    this.serviceModalOverlay.style.display = 'flex';\n    requestAnimationFrame(() => {\n      if (this.serviceModalOverlay) {\n        this.serviceModalOverlay.style.opacity = '1';\n      }\n    });\n\n    this.resetPendingSelections();\n    this.initializeServiceSelector(forceFetch);\n  }\n\n  closeServiceModal() {\n    if (!this.serviceModalOverlay) {\n      return;\n    }\n\n    this.serviceModalOverlay.style.opacity = '0';\n    setTimeout(() => {\n      if (this.serviceModalOverlay) {\n        this.serviceModalOverlay.style.display = 'none';\n      }\n      this.resetPendingSelections();\n    }, 150);\n  }\n\n  async initializeServiceSelector(force = false) {\n    if (this.servicesLoading && !force) {\n      return;\n    }\n\n    if (!this.client || typeof this.client.getAvailableServices !== 'function') {\n      this.setServiceSelectorStatus('ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–å¾…ã¡ã§ã™ï¼‰ã€‚å³ä¸‹ã®ã€Œå†èª­ã¿è¾¼ã¿ã€ã§å†å–å¾—ã§ãã¾ã™ã€‚', 'error');\n      this.toggleServiceRetryButton(true);\n      this.setServiceButtonsEnabled(false);\n      return;\n    }\n\n    this.servicesLoading = true;\n    this.setServiceSelectorStatus('ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...', 'info');\n    this.toggleServiceRetryButton(false);\n    this.setServiceButtonsEnabled(false);\n\n    try {\n      if (typeof this.client.ensureInitialized === 'function') {\n        await this.client.ensureInitialized();\n      }\n\n      const response = await this.client.getAvailableServices();\n      if (!response || response.success === false || !response.metadata) {\n        throw new Error(response?.error || 'ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');\n      }\n\n      this.availableImageServices = Array.isArray(response.metadata?.image) ? response.metadata.image : [];\n      this.availableVideoServices = Array.isArray(response.metadata?.video) ? response.metadata.video : [];\n\n      this.selectedImageService = this.resolveServiceSelection(\n        'image',\n        this.availableImageServices,\n        response.default?.image\n      );\n\n      this.selectedVideoService = this.resolveServiceSelection(\n        'video',\n        this.availableVideoServices,\n        response.default?.video\n      );\n\n      this.pendingImageService = this.selectedImageService;\n      this.pendingVideoService = this.selectedVideoService;\n\n      this.populateServiceSelector();\n      this.applyServiceSelectionToSceneManager();\n      this.setServiceButtonsEnabled(true);\n    } catch (error) {\n      console.error('âŒ Failed to initialize service selector:', error);\n      this.setServiceSelectorStatus('ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã®ã†ãˆã€å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');\n      this.toggleServiceRetryButton(true);\n      this.setServiceButtonsEnabled(false);\n    } finally {\n      this.servicesLoading = false;\n    }\n  }\n\n  setServiceSelectorStatus(message, type = 'info') {\n    if (!this.serviceSelectorStatus) {\n      return;\n    }\n    this.serviceSelectorStatus.textContent = message;\n    this.serviceSelectorStatus.dataset.statusType = type;\n    this.serviceSelectorStatus.classList.toggle('service-selector-helper', type !== 'error');\n    this.updateServiceSelectorTheme();\n  }\n\n  toggleServiceRetryButton(visible) {\n    if (!this.serviceSelectorRetryButton) {\n      return;\n    }\n    this.serviceSelectorRetryButton.style.display = visible ? 'inline-flex' : 'none';\n    this.updateServiceSelectorTheme();\n  }\n\n  resolveServiceSelection(type, services, defaultId) {\n    if (!services || services.length === 0) {\n      return null;\n    }\n\n    const storageKey = type === 'image' ? IMAGE_SERVICE_STORAGE_KEY : VIDEO_SERVICE_STORAGE_KEY;\n    let storedId = null;\n    try {\n      storedId = localStorage.getItem(storageKey);\n    } catch (error) {\n      console.warn('âš ï¸ Failed to access localStorage:', error);\n    }\n\n    const isStoredValid = storedId && services.some(service => service.id === storedId);\n    let resolvedId = isStoredValid ? storedId : null;\n\n    if (!resolvedId && defaultId && services.some(service => service.id === defaultId)) {\n      resolvedId = defaultId;\n    }\n\n    if (!resolvedId) {\n      resolvedId = services[0]?.id || null;\n    }\n\n    try {\n      if (resolvedId) {\n        localStorage.setItem(storageKey, resolvedId);\n      } else {\n        localStorage.removeItem(storageKey);\n      }\n    } catch (error) {\n      console.warn('âš ï¸ Failed to persist service selection:', error);\n    }\n\n    return resolvedId;\n  }\n\n  populateServiceSelector() {\n    if (!this.serviceSelectorContent) {\n      return;\n    }\n\n    this.serviceSelectorContent.innerHTML = '';\n\n    const hasImage = this.availableImageServices.length > 0;\n    const hasVideo = this.availableVideoServices.length > 0;\n\n    if (!hasImage && !hasVideo) {\n      this.setServiceSelectorStatus('åˆ©ç”¨å¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');\n      return;\n    }\n\n    this.setServiceSelectorStatus('åˆ©ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'info');\n\n    if (hasImage) {\n      const imageRow = this.buildServiceRow('image', 'ç”»åƒ (T2I)', this.availableImageServices, this.pendingImageService || this.selectedImageService);\n      this.serviceSelectorContent.appendChild(imageRow);\n    }\n\n    if (hasVideo) {\n      const videoRow = this.buildServiceRow('video', 'å‹•ç”» (T2V)', this.availableVideoServices, this.pendingVideoService || this.selectedVideoService);\n      this.serviceSelectorContent.appendChild(videoRow);\n    }\n\n    this.updateServiceSelectorTheme();\n  }\n\n  buildServiceRow(type, labelText, services, selectedId) {\n    const row = document.createElement('div');\n    row.className = `service-row service-row-${type}`;\n    row.style.cssText = `\n      display: flex;\n      flex-direction: column;\n      gap: 6px;\n      margin-bottom: 12px;\n    `;\n\n    const label = document.createElement('label');\n    label.textContent = labelText;\n    label.style.fontSize = '13px';\n    label.style.fontWeight = '600';\n    row.appendChild(label);\n\n    const select = document.createElement('select');\n    select.dataset.serviceType = type;\n    select.style.fontFamily = 'inherit';\n    select.style.width = '100%';\n\n    services.forEach(service => {\n      const option = document.createElement('option');\n      option.value = service.id;\n      option.textContent = service.name || service.id;\n      if (service.description) {\n        option.title = service.description;\n      }\n      select.appendChild(option);\n    });\n\n    if (selectedId && services.some(service => service.id === selectedId)) {\n      select.value = selectedId;\n    }\n\n    select.addEventListener('change', (event) => {\n      this.onServiceSelectionChange(type, event.target.value);\n    });\n\n    row.appendChild(select);\n\n    const description = document.createElement('div');\n    description.className = 'service-description';\n    description.textContent = this.findServiceInfo(type, select.value)?.description || '';\n    description.style.fontSize = '11px';\n    description.style.opacity = '0.75';\n    description.style.lineHeight = '1.4';\n    description.style.minHeight = '14px';\n    row.appendChild(description);\n\n    select.addEventListener('change', () => {\n      description.textContent = this.findServiceInfo(type, select.value)?.description || '';\n    });\n\n    if (type === 'image') {\n      this.imageServiceSelect = select;\n    } else {\n      this.videoServiceSelect = select;\n    }\n\n    return row;\n  }\n\n  onServiceSelectionChange(type, serviceId) {\n    if (type === 'image') {\n      this.pendingImageService = serviceId;\n    } else {\n      this.pendingVideoService = serviceId;\n    }\n\n    const info = this.findServiceInfo(type, serviceId);\n    const description = type === 'image'\n      ? this.imageServiceSelect?.parentElement?.querySelector('.service-description')\n      : this.videoServiceSelect?.parentElement?.querySelector('.service-description');\n\n    if (description) {\n      description.textContent = info?.description || '';\n    }\n  }\n\n  handleServiceSave() {\n    const newImageId = this.pendingImageService || this.selectedImageService;\n    const newVideoId = this.pendingVideoService || this.selectedVideoService;\n\n    if (newImageId) {\n      try {\n        localStorage.setItem(IMAGE_SERVICE_STORAGE_KEY, newImageId);\n      } catch (error) {\n        console.warn('âš ï¸ Failed to persist image service selection:', error);\n      }\n      this.selectedImageService = newImageId;\n      this.sceneManager?.setImageService(newImageId);\n    }\n\n    if (newVideoId) {\n      try {\n        localStorage.setItem(VIDEO_SERVICE_STORAGE_KEY, newVideoId);\n      } catch (error) {\n        console.warn('âš ï¸ Failed to persist video service selection:', error);\n      }\n      this.selectedVideoService = newVideoId;\n      this.sceneManager?.setVideoService(newVideoId);\n    }\n\n    const imageInfo = this.findServiceInfo('image', newImageId);\n    const videoInfo = this.findServiceInfo('video', newVideoId);\n\n    if (imageInfo) {\n      this.addOutput(`ğŸ–¼ï¸ ç”»åƒã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€Œ${imageInfo.name}ã€ã«è¨­å®šã—ã¾ã—ãŸ`, 'system');\n    }\n    if (videoInfo) {\n      this.addOutput(`ğŸ¬ å‹•ç”»ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€Œ${videoInfo.name}ã€ã«è¨­å®šã—ã¾ã—ãŸ`, 'system');\n    }\n\n    this.closeServiceModal();\n  }\n\n  setServiceButtonsEnabled(enabled) {\n    if (this.serviceSelectorSaveButton) {\n      this.serviceSelectorSaveButton.disabled = !enabled;\n      this.serviceSelectorSaveButton.style.opacity = enabled ? '1' : '0.6';\n      this.serviceSelectorSaveButton.style.cursor = enabled ? 'pointer' : 'not-allowed';\n    }\n  }\n\n  resetPendingSelections() {\n    this.pendingImageService = this.selectedImageService;\n    this.pendingVideoService = this.selectedVideoService;\n\n    if (this.imageServiceSelect && this.selectedImageService) {\n      this.imageServiceSelect.value = this.selectedImageService;\n    }\n    if (this.videoServiceSelect && this.selectedVideoService) {\n      this.videoServiceSelect.value = this.selectedVideoService;\n    }\n\n    if (this.serviceSelectorContent && this.serviceSelectorContent.childElementCount > 0) {\n      this.populateServiceSelector();\n    }\n  }\n\n  findServiceInfo(type, serviceId) {\n    const list = type === 'image' ? this.availableImageServices : this.availableVideoServices;\n    return list.find(service => service.id === serviceId) || null;\n  }\n\n  applyServiceSelectionToSceneManager() {\n    if (!this.sceneManager) {\n      return;\n    }\n    this.sceneManager.setImageService(this.selectedImageService);\n    this.sceneManager.setVideoService(this.selectedVideoService);\n  }\n\n  updateServiceSelectorTheme() {\n    if (this.serviceModalOverlay) {\n      this.serviceModalOverlay.style.background = this.isDarkMode\n        ? 'rgba(8, 11, 26, 0.55)'\n        : 'rgba(229, 231, 255, 0.45)';\n    }\n\n    if (this.serviceModal) {\n      this.serviceModal.style.background = this.isDarkMode\n        ? 'rgba(17, 24, 39, 0.15)'\n        : 'rgba(255, 255, 255, 0.15)';\n      this.serviceModal.style.border = this.isDarkMode\n        ? '1px solid rgba(129, 140, 248, 0.4)'\n        : '1px solid rgba(99, 102, 241, 0.25)';\n      this.serviceModal.style.color = this.isDarkMode ? '#e5e7ff' : '#1f2937';\n    }\n\n    if (this.serviceSelectorStatus) {\n      const type = this.serviceSelectorStatus.dataset?.statusType;\n      const statusColor = type === 'error'\n        ? (this.isDarkMode ? '#fca5a5' : '#b91c1c')\n        : (this.isDarkMode ? 'rgba(209, 213, 219, 0.8)' : 'rgba(55, 65, 81, 0.75)');\n      this.serviceSelectorStatus.style.color = statusColor;\n    }\n\n    if (this.serviceSelectorContainer) {\n      const labels = this.serviceSelectorContainer.querySelectorAll('label');\n      labels.forEach(label => {\n        label.style.color = this.isWabiSabiMode\n          ? '#5D4037'\n          : (this.isDarkMode ? 'rgba(255, 255, 255, 0.9)' : 'rgba(31, 41, 55, 0.9)');\n      });\n\n      const selects = this.serviceSelectorContainer.querySelectorAll('select');\n      selects.forEach(select => {\n        select.style.background = this.isWabiSabiMode\n          ? 'rgba(161, 136, 127, 0.15)'\n          : (this.isDarkMode ? 'rgba(99, 102, 241, 0.18)' : 'rgba(99, 102, 241, 0.12)');\n        select.style.border = this.isWabiSabiMode\n          ? '1px solid rgba(161, 136, 127, 0.4)'\n          : (this.isDarkMode ? '1px solid rgba(129, 140, 248, 0.45)' : '1px solid rgba(99, 102, 241, 0.45)');\n        select.style.color = this.isWabiSabiMode\n          ? '#5D4037'\n          : (this.isDarkMode ? '#ffffff' : '#1f2937');\n        select.style.padding = '10px 12px';\n        select.style.borderRadius = '10px';\n        select.style.fontSize = '13px';\n        select.style.outline = 'none';\n        select.style.boxShadow = this.isWabiSabiMode\n          ? '0 12px 24px rgba(93, 64, 55, 0.25)'\n          : (this.isDarkMode\n            ? '0 12px 28px rgba(15, 23, 42, 0.5)'\n            : '0 12px 24px rgba(99, 102, 241, 0.2)');\n      });\n\n      const descriptions = this.serviceSelectorContainer.querySelectorAll('.service-description');\n      descriptions.forEach(desc => {\n        desc.style.color = this.isWabiSabiMode\n          ? 'rgba(93, 64, 55, 0.7)'\n          : (this.isDarkMode ? 'rgba(209, 213, 219, 0.8)' : 'rgba(55, 65, 81, 0.7)');\n      });\n    }\n\n    if (this.serviceSelectorRetryButton) {\n      this.serviceSelectorRetryButton.style.background = this.isWabiSabiMode\n        ? 'rgba(161, 136, 127, 0.25)'\n        : (this.isDarkMode\n          ? 'rgba(129, 140, 248, 0.35)'\n          : 'rgba(99, 102, 241, 0.15)');\n      this.serviceSelectorRetryButton.style.border = this.isWabiSabiMode\n        ? '1px solid rgba(161, 136, 127, 0.5)'\n        : (this.isDarkMode\n          ? '1px solid rgba(129, 140, 248, 0.5)'\n          : '1px solid rgba(99, 102, 241, 0.45)');\n      this.serviceSelectorRetryButton.style.color = this.isWabiSabiMode\n        ? '#5D4037'\n        : (this.isDarkMode ? '#f9fafb' : '#1e1b4b');\n      this.serviceSelectorRetryButton.style.boxShadow = this.isWabiSabiMode\n        ? '0 0 8px rgba(161, 136, 127, 0.4)'\n        : (this.isDarkMode\n          ? '0 0 8px rgba(129, 140, 248, 0.45)'\n          : '0 0 8px rgba(99, 102, 241, 0.35)');\n    }\n\n    if (this.serviceSelectorCancelButton) {\n      this.serviceSelectorCancelButton.style.border = this.isWabiSabiMode\n        ? '1px solid rgba(161, 136, 127, 0.4)'\n        : (this.isDarkMode\n          ? '1px solid rgba(209, 213, 219, 0.3)'\n          : '1px solid rgba(148, 163, 184, 0.5)');\n      this.serviceSelectorCancelButton.style.color = this.isWabiSabiMode\n        ? 'rgba(93, 64, 55, 0.85)'\n        : (this.isDarkMode ? 'rgba(226, 232, 240, 0.85)' : 'rgba(30, 41, 59, 0.85)');\n    }\n\n    if (this.serviceSelectorSaveButton) {\n      this.serviceSelectorSaveButton.style.background = this.isWabiSabiMode\n        ? 'linear-gradient(135deg, #6D4C41, #5D4037)'\n        : (this.isDarkMode\n          ? 'linear-gradient(135deg, ' + (this.isWabiSabiMode ? '#8BC34A, #689F38' : '#6366f1, #8b5cf6') + ')'\n          : 'linear-gradient(135deg, #818cf8, #a855f7)');\n      this.serviceSelectorSaveButton.style.boxShadow = this.isWabiSabiMode\n        ? '0 16px 28px rgba(93, 64, 55, 0.35)'\n        : (this.isDarkMode\n          ? '0 16px 28px rgba(99, 102, 241, 0.4)'\n          : '0 16px 28px rgba(129, 140, 248, 0.35)');\n    }\n  }\n\n  /**\n   * ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³é¢¨ãƒ¢ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ä½œæˆ\n   */\n  createRadioModeSelector() {\n    const container = document.createElement('div');\n    container.className = 'radio-mode-selector';\n    container.style.cssText = `\n      display: grid;\n      grid-template-columns: repeat(4, 1fr);\n      gap: 8px;\n      margin-bottom: 12px;\n      padding: 12px;\n      background: ${this.isWabiSabiMode\n        ? 'linear-gradient(135deg, rgba(158, 158, 158, 0.25), rgba(189, 189, 189, 0.2))'\n        : (this.isDarkMode\n          ? 'linear-gradient(135deg, rgba(30, 27, 75, 0.3), rgba(15, 23, 42, 0.4))'\n          : 'linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1))')};\n      border: 1px solid ${this.isWabiSabiMode\n        ? 'rgba(141, 110, 99, 0.4)'\n        : (this.isDarkMode ? 'rgba(99, 102, 241, 0.15)' : 'rgba(255, 255, 255, 0.25)')};\n      border-radius: 16px;\n      backdrop-filter: blur(12px);\n      transition: all 0.3s ease;\n      position: relative;\n    `;\n\n    const modes = [\n      { value: 'generate', label: 'Generate', icon: 'âœ¨' },\n      { value: 'import', label: 'Import', icon: 'ğŸ“¥' },\n      { value: 'modify', label: 'Modify', icon: 'ğŸ”§' },\n      { value: 'delete', label: 'Delete', icon: 'ğŸ—‘ï¸' }\n    ];\n\n    this.radioModeButtons = {};\n\n    modes.forEach(mode => {\n      const button = document.createElement('div');\n      button.className = `mode-option ${mode.value}`;\n      button.style.cssText = `\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 4px;\n        padding: 10px 8px;\n        border-radius: 12px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        font-size: 11px;\n        font-weight: 600;\n        text-align: center;\n        color: ${this.isWabiSabiMode\n          ? '#F5F5F5'\n          : (this.isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(55, 65, 81, 0.8)')};\n        background: transparent;\n        border: 1px solid transparent;\n        position: relative;\n      `;\n\n      const icon = document.createElement('div');\n      icon.textContent = mode.icon;\n      icon.style.cssText = `\n        font-size: 16px;\n        margin-bottom: 2px;\n        filter: ${this.isDarkMode \n          ? 'hue-rotate(220deg) saturate(0.8) brightness(1.2)' \n          : 'hue-rotate(240deg) saturate(0.7) brightness(0.9)'};\n        transition: filter 0.2s ease;\n      `;\n\n      const label = document.createElement('span');\n      label.textContent = mode.label;\n\n      // AUTOãƒãƒƒã‚¸ã‚’ä½œæˆ\n      const autoBadge = document.createElement('div');\n      autoBadge.className = 'auto-badge';\n      autoBadge.textContent = 'AUTO';\n      autoBadge.style.cssText = `\n        position: absolute;\n        top: -4px;\n        right: -4px;\n        font-size: 7px;\n        font-weight: 700;\n        padding: 2px 4px;\n        background: linear-gradient(135deg, #10b981, #059669);\n        color: white;\n        border-radius: 6px;\n        opacity: 0;\n        transform: scale(0.8);\n        transition: all 0.2s ease;\n        display: none;\n      `;\n\n      button.appendChild(icon);\n      button.appendChild(label);\n      button.appendChild(autoBadge);\n\n      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ\n      button.addEventListener('click', () => {\n        if (mode.value === 'import') {\n          this.triggerFileSelection();\n        } else {\n          this.selectMode(mode.value, true); // trueã¯æ‰‹å‹•é¸æŠã‚’ç¤ºã™\n        }\n      });\n\n      this.radioModeButtons[mode.value] = { button, autoBadge };\n      container.appendChild(button);\n    });\n\n\n    this.radioModeContainer = container;\n    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Generateã‚’é¸æŠ\n    this.selectMode('generate', false);\n\n    return container;\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIæ›´æ–°ï¼‰\n   */\n  selectMode(mode, isManual = false, detectedKeyword = null) {\n    this.currentMode = mode;\n\n    // å…¨ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ\n    Object.keys(this.radioModeButtons).forEach(key => {\n      const { button, autoBadge } = this.radioModeButtons[key];\n      button.style.color = this.isWabiSabiMode\n        ? '#F5F5F5'\n        : (this.isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(55, 65, 81, 0.8)');\n      button.style.background = 'transparent';\n      button.style.border = '1px solid transparent';\n      button.style.transform = 'scale(1)';\n      button.style.boxShadow = 'none';\n      // AUTOãƒãƒƒã‚¸ã‚’éè¡¨ç¤º\n      autoBadge.style.display = 'none';\n      autoBadge.style.opacity = '0';\n    });\n\n    // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆ2025å¹´ä»•æ§˜ï¼‰\n    const { button, autoBadge } = this.radioModeButtons[mode];\n    \n    // 2025 Glassmorphismé¸æŠçŠ¶æ…‹\n    const selectedGlass = this.isWabiSabiMode\n      ? {\n          background: 'linear-gradient(135deg, rgba(109, 76, 65, 0.2), rgba(141, 110, 99, 0.15))',\n          border: '1px solid rgba(109, 76, 65, 0.4)',\n          boxShadow: '0 4px 16px rgba(109, 76, 65, 0.25), inset 0 1px 0 rgba(245, 245, 220, 0.15)',\n          color: '#F5F5F5'\n        }\n      : (this.isDarkMode\n        ? {\n            background: 'linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15))',\n            border: '1px solid rgba(99, 102, 241, 0.4)',\n            boxShadow: '0 4px 16px rgba(99, 102, 241, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1)',\n            color: '#a5b4fc'\n          }\n        : {\n            background: 'linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.08))',\n            border: '1px solid rgba(99, 102, 241, 0.3)',\n            boxShadow: '0 4px 16px rgba(99, 102, 241, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2)',\n            color: this.isWabiSabiMode ? '#8BC34A' : '#6366f1'\n          });\n\n    button.style.color = selectedGlass.color;\n    button.style.background = selectedGlass.background;\n    button.style.border = selectedGlass.border;\n    button.style.boxShadow = selectedGlass.boxShadow;\n    button.style.transform = 'scale(1.02)';\n\n    // AUTOãƒãƒƒã‚¸ã®è¡¨ç¤ºåˆ¶å¾¡\n    if (!isManual && detectedKeyword) {\n      // è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆã®å ´åˆã¯AUTOãƒãƒƒã‚¸ã‚’è¡¨ç¤º\n      autoBadge.style.display = 'inline-block';\n      setTimeout(() => {\n        autoBadge.style.opacity = '1';\n        autoBadge.style.transform = 'scale(1)';\n      }, 100);\n      \n      // 3ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ\n      setTimeout(() => {\n        autoBadge.style.opacity = '0';\n        autoBadge.style.transform = 'scale(0.8)';\n        setTimeout(() => {\n          autoBadge.style.display = 'none';\n        }, 200);\n      }, 3000);\n    }\n\n    // ãƒ‘ãƒ«ã‚¹åŠ¹æœã‚’è¿½åŠ \n    if (!isManual) {\n      this.addPulseEffect(button);\n      this.addContainerGlow(mode);\n    }\n\n    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ›´æ–°\n    this.input.placeholder = this.getPlaceholderForMode(mode);\n\n    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å…¥åŠ›æ¬„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸Šæ›¸ãæ©Ÿèƒ½\n    if (isManual) {\n      this.clearInputOnModeSwitch(mode);\n    }\n\n    // Importãƒ¢ãƒ¼ãƒ‰å°‚ç”¨å‡¦ç†\n    if (mode === 'import' || this.selectedFile) {\n      this.showImportInterface();\n    } else {\n      this.hideImportInterface();\n    }\n\n    // Deleteãƒ¢ãƒ¼ãƒ‰å°‚ç”¨å‡¦ç†\n    if (mode === 'delete' && isManual) {\n      this.handleDeleteModeSelection();\n    }\n\n    // Modifyãƒ¢ãƒ¼ãƒ‰å°‚ç”¨å‡¦ç†\n    if (mode === 'modify' && isManual) {\n      this.handleModifyModeSelection();\n    }\n\n    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã—ãªã„ï¼ˆUIã§åˆ†ã‹ã‚‹ãŸã‚ï¼‰\n  }\n\n  /**\n   * ãƒ‘ãƒ«ã‚¹åŠ¹æœã‚’è¿½åŠ \n   */\n  addPulseEffect(element) {\n    // æ—¢å­˜ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ\n    element.style.animation = 'none';\n    \n    // å°‘ã—é…ã‚‰ã›ã¦ã‹ã‚‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ï¼ˆãƒªãƒ•ãƒ­ãƒ¼å¼·åˆ¶ï¼‰\n    setTimeout(() => {\n      element.style.animation = 'smartModePulse 0.6s ease-out';\n    }, 10);\n    \n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    setTimeout(() => {\n      element.style.animation = '';\n    }, 610);\n    \n    // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•çš„ã«è¿½åŠ ï¼ˆã¾ã å­˜åœ¨ã—ãªã„å ´åˆï¼‰\n    this.ensurePulseAnimation();\n  }\n\n  /**\n   * ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨CSSã‚’ç¢ºä¿\n   */\n  ensurePulseAnimation() {\n    if (document.getElementById('smart-mode-pulse-animation')) return;\n    \n    const style = document.createElement('style');\n    style.id = 'smart-mode-pulse-animation';\n    style.textContent = `\n      @keyframes smartModePulse {\n        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }\n        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }\n        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  /**\n   * ã‚³ãƒ³ãƒ†ãƒŠã‚°ãƒ­ãƒ¼åŠ¹æœ\n   */\n  addContainerGlow(mode) {\n    const container = this.radioModeContainer;\n    if (!container) return;\n\n    // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ã‚°ãƒ­ãƒ¼è‰²ã‚’è¨­å®š\n    const glowColors = this.isWabiSabiMode ? {\n      generate: 'rgba(139, 195, 74, 0.4)',  // ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ï¼šãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘\n      modify: 'rgba(139, 195, 74, 0.4)',    // ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ï¼šãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘\n      delete: 'rgba(139, 195, 74, 0.4)'     // ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ï¼šãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘\n    } : {\n      generate: 'rgba(79, 70, 229, 0.4)',   // ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼šå…ƒã®ç´«\n      modify: 'rgba(236, 72, 153, 0.4)',    // ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼šå…ƒã®ãƒ”ãƒ³ã‚¯\n      delete: 'rgba(107, 114, 128, 0.3)'    // ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼šå…ƒã®ã‚°ãƒ¬ãƒ¼\n    };\n\n    // ä¸€æ™‚çš„ã«ã‚°ãƒ­ãƒ¼åŠ¹æœã‚’é©ç”¨\n    container.style.boxShadow = `0 0 20px ${glowColors[mode]}, 0 0 40px ${glowColors[mode]}`;\n    container.style.borderColor = glowColors[mode].replace('0.4', '0.6').replace('0.3', '0.5');\n    \n    // 1ç§’å¾Œã«ã‚°ãƒ­ãƒ¼åŠ¹æœã‚’é™¤å»\n    setTimeout(() => {\n      container.style.boxShadow = '';\n      container.style.borderColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.15)';\n    }, 1000);\n  }\n\n  getActionButtonStyles(variant = 'secondary') {\n    const baseStyles = `\n      border: none;\n      border-radius: 10px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n      font-weight: 500;\n      backdrop-filter: blur(8px);\n      -webkit-backdrop-filter: blur(8px);\n    `;\n\n    if (variant === 'secondary') {\n      // Clear All, History ãƒœã‚¿ãƒ³ç”¨ - ç¾ã—ã„é…ç½®ã¨çµ±ä¸€æ„Ÿ\n      return baseStyles + `\n        width: 90px;\n        height: 36px;\n        padding: 8px 12px;\n        font-size: 12px;\n        font-weight: 600;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n        background: ${this.isWabiSabiMode\n          ? 'linear-gradient(135deg, rgba(141, 110, 99, 0.3), rgba(109, 76, 65, 0.2))'\n          : (this.isDarkMode\n            ? 'linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2))'\n            : 'linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))')};\n        border: 1px solid ${this.isWabiSabiMode\n          ? 'rgba(93, 64, 55, 0.6)'\n          : (this.isDarkMode ? 'rgba(156, 163, 175, 0.2)' : 'rgba(255, 255, 255, 0.3)')};\n        color: ${this.isWabiSabiMode\n          ? '#F5F5F5'\n          : (this.isDarkMode ? '#d1d5db' : '#374151')};\n        text-align: center;\n        white-space: nowrap;\n      `;\n    } else if (variant === 'icon') {\n      // ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ«ã€è¨­å®šãƒœã‚¿ãƒ³ç”¨\n      return baseStyles + `\n        width: 32px;\n        height: 32px;\n        padding: 0;\n        font-size: 14px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: ${this.isDarkMode \n          ? 'linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1))'\n          : 'linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))'};\n        border: 1px solid ${this.isDarkMode ? 'rgba(99, 102, 241, 0.2)' : 'rgba(255, 255, 255, 0.4)'};\n        color: ${this.isDarkMode ? '#a5b4fc' : '#6366f1'};\n      `;\n    }\n  }\n\n  /**\n   * ç ´å£Šçš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆèµ¤ç³»ã‚¬ãƒ©ã‚¹åŠ¹æœï¼‰\n   */\n  getDestructiveButtonStyles() {\n    return `\n      min-width: 50px;\n      height: 32px;\n      border: 1px solid ${this.isDarkMode ? 'rgba(220, 38, 127, 0.4)' : 'rgba(190, 24, 93, 0.35)'};\n      border-radius: 6px;\n      background: ${this.isDarkMode ? 'rgba(220, 38, 127, 0.3)' : 'rgba(190, 24, 93, 0.25)'};\n      color: ${this.isDarkMode ? '#fca5a5' : '#dc2626'};\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n      font-size: 11px;\n      font-weight: 500;\n      padding: 0 8px;\n      backdrop-filter: blur(10px);\n      -webkit-backdrop-filter: blur(10px);\n    `;\n  }\n\n  getCommandTypeIndicatorStyles() {\n    return `\n      padding: 4px 0;\n      margin-bottom: 0;\n      font-size: 11px;\n      font-weight: 400;\n      text-align: left;\n      color: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.6)' : 'rgba(0, 0, 0, 0.6)'};\n      transition: all 0.3s ease;\n      border: none;\n      background: none;\n    `;\n  }\n\n  /**\n   * ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚ºå‡¦ç†ï¼ˆæœ€å¤§2è¡Œï¼‰\n   */\n  autoResizeTextarea() {\n    // é«˜ã•ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ­£ç¢ºãª scrollHeight ã‚’å–å¾—\n    this.input.style.height = 'auto';\n    \n    // ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åŸºã¥ã„ã¦é«˜ã•ã‚’è¨ˆç®—\n    const lineHeight = 22; // CSS ã§è¨­å®šã—ãŸ line-height\n    const padding = 28; // ä¸Šä¸‹ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆè¨ˆ (14px * 2)\n    const maxLines = 2;\n    const maxHeight = (lineHeight * maxLines) + padding;\n    \n    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é«˜ã•ã«åŸºã¥ã„ã¦æ–°ã—ã„é«˜ã•ã‚’æ±ºå®š\n    const newHeight = Math.min(this.input.scrollHeight, maxHeight);\n    \n    // é«˜ã•ã‚’é©ç”¨\n    this.input.style.height = newHeight + 'px';\n    \n    // 2è¡Œã‚’è¶…ãˆã‚‹å ´åˆã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–ã¨å±•é–‹ãƒœã‚¿ãƒ³è¡¨ç¤º\n    if (this.input.scrollHeight > maxHeight) {\n      this.input.style.overflowY = 'auto';\n      // å±•é–‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º\n      if (this.expandButton) {\n        this.expandButton.style.display = 'flex';\n      }\n    } else {\n      this.input.style.overflowY = 'hidden';\n      // å±•é–‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º\n      if (this.expandButton) {\n        this.expandButton.style.display = 'none';\n      }\n    }\n  }\n\n  /**\n   * ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—æ¤œå‡º\n   */\n  detectCommandType() {\n    const input = this.input.value.trim();\n    if (!input) {\n      this.selectMode('generate', false);\n      return;\n    }\n\n    const commandType = this.analyzeCommandType(input);\n\n    // Delete/Modifyã¯æ‰‹å‹•é¸æŠã‚’å„ªå…ˆã€è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆã—ãªã„\n    if (this.currentMode === 'delete' || this.currentMode === 'modify') {\n      return; // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ç¶­æŒ\n    }\n    // Generate/Importã®ã¿è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ\n    this.selectMode(commandType.type, false, commandType.detectedKeyword);\n  }\n\n  /**\n   * ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚³ãƒãƒ³ãƒ‰åˆ†æ\n   */\n  analyzeCommandType(text) {\n    this.logDebug(`ğŸ” Analyzing command: \"${text}\"`);\n\n    // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—ã®æ¤œå‡º\n    const mediaInfo = this.detectMediaType(text);\n    \n    // å‰Šé™¤ã‚³ãƒãƒ³ãƒ‰ã®æ¤œå‡º\n    const deletePatterns = [\n      { pattern: /å‰Šé™¤/, keyword: 'å‰Šé™¤' },\n      { pattern: /æ¶ˆå»/, keyword: 'æ¶ˆå»' },\n      { pattern: /æ¶ˆã—ã¦/, keyword: 'æ¶ˆã—ã¦' },\n      { pattern: /æ¶ˆã™/, keyword: 'æ¶ˆã™' },\n      { pattern: /å–ã‚Šé™¤/, keyword: 'å–ã‚Šé™¤' },\n      { pattern: /é™¤å»/, keyword: 'é™¤å»' },\n      { pattern: /å‰Šé™¤ã—ã¦/, keyword: 'å‰Šé™¤ã—ã¦' },\n      { pattern: /delete/i, keyword: 'delete' },\n      { pattern: /remove/i, keyword: 'remove' },\n      { pattern: /clear/i, keyword: 'clear' },\n      { pattern: /erase/i, keyword: 'erase' }\n    ];\n    \n    // å¤‰æ›´ãƒ»ç§»å‹•ã‚³ãƒãƒ³ãƒ‰ã®æ¤œå‡º\n    const modifyPatterns = [\n      { pattern: /ç§»å‹•/, keyword: 'ç§»å‹•' },\n      { pattern: /å‹•ã‹ã—ã¦/, keyword: 'å‹•ã‹ã—ã¦' },\n      { pattern: /å¤‰æ›´/, keyword: 'å¤‰æ›´' },\n      { pattern: /å¤‰ãˆã¦/, keyword: 'å¤‰ãˆã¦' },\n      { pattern: /ä¿®æ­£/, keyword: 'ä¿®æ­£' },\n      { pattern: /èª¿æ•´/, keyword: 'èª¿æ•´' },\n      { pattern: /å›è»¢/, keyword: 'å›è»¢' },\n      { pattern: /åè»¢/, keyword: 'åè»¢' },\n      { pattern: /ãƒŸãƒ©ãƒ¼/, keyword: 'ãƒŸãƒ©ãƒ¼' },\n      { pattern: /å‚¾ã‘/, keyword: 'å‚¾ã‘' },\n      { pattern: /å‘ãã‚’å¤‰ãˆ/, keyword: 'å‘ãã‚’å¤‰ãˆ' },\n      { pattern: /.*ã‚’.*è‰²/, keyword: 'è‰²å¤‰æ›´' },\n      { pattern: /.*ã‚’.*ã‚µã‚¤ã‚º/, keyword: 'ã‚µã‚¤ã‚ºå¤‰æ›´' },\n      { pattern: /ã‚’.*ã«.*ã—ã¦/, keyword: 'å¤‰æ›´' },\n      { pattern: /move/i, keyword: 'move' },\n      { pattern: /change/i, keyword: 'change' },\n      { pattern: /modify/i, keyword: 'modify' },\n      { pattern: /edit/i, keyword: 'edit' }\n    ];\n    \n    // ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰ã®æ¤œå‡ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰\n    const generatePatterns = [\n      { pattern: /ä½œã£ã¦/, keyword: 'ä½œã£ã¦' },\n      { pattern: /ç”Ÿæˆ/, keyword: 'ç”Ÿæˆ' },\n      { pattern: /ä½œæˆ/, keyword: 'ä½œæˆ' },\n      { pattern: /æã„ã¦/, keyword: 'æã„ã¦' },\n      { pattern: /æ›¸ã„ã¦/, keyword: 'æ›¸ã„ã¦' },\n      { pattern: /create/i, keyword: 'create' },\n      { pattern: /generate/i, keyword: 'generate' },\n      { pattern: /make/i, keyword: 'make' },\n      { pattern: /draw/i, keyword: 'draw' }\n    ];\n\n    // å‰Šé™¤ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯\n    for (const { pattern, keyword } of deletePatterns) {\n      if (pattern.test(text)) {\n        this.logDebug(`âœ… Delete pattern matched: ${keyword}`);\n        return {\n          type: 'delete',\n          confidence: 0.9,\n          reason: 'å‰Šé™¤ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º',\n          mediaType: mediaInfo.type,\n          requiresConfirmation: true,\n          detectedKeyword: keyword\n        };\n      }\n    }\n    \n    // å¤‰æ›´ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯\n    for (const { pattern, keyword } of modifyPatterns) {\n      if (pattern.test(text)) {\n        this.logDebug(`âœ… Modify pattern matched: ${keyword}`);\n        return {\n          type: 'modify',\n          confidence: 0.8,\n          reason: 'å¤‰æ›´ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º',\n          mediaType: mediaInfo.type,\n          requiresConfirmation: false,\n          detectedKeyword: keyword\n        };\n      }\n    }\n    \n    // ç”Ÿæˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯\n    for (const { pattern, keyword } of generatePatterns) {\n      if (pattern.test(text)) {\n        return {\n          type: 'generate',\n          confidence: mediaInfo.confidence,\n          reason: mediaInfo.reason,\n          mediaType: mediaInfo.type,\n          requiresConfirmation: false,\n          detectedKeyword: keyword\n        };\n      }\n    }\n    \n    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ï¼‰\n    this.logDebug(`â„¹ï¸ No specific pattern matched, defaulting to generate mode`);\n    return {\n      type: 'generate',\n      confidence: mediaInfo.confidence,\n      reason: mediaInfo.reason,\n      mediaType: mediaInfo.type,\n      requiresConfirmation: false,\n      detectedKeyword: null\n    };\n  }\n\n  /**\n   * Extract all command keywords from the analyzeCommandType patterns\n   * Returns an array of {pattern, keyword, type} objects\n   */\n  getAllCommandKeywords() {\n    const deletePatterns = [\n      { pattern: /å‰Šé™¤/, keyword: 'å‰Šé™¤', type: 'delete' },\n      { pattern: /æ¶ˆå»/, keyword: 'æ¶ˆå»', type: 'delete' },\n      { pattern: /æ¶ˆã—ã¦/, keyword: 'æ¶ˆã—ã¦', type: 'delete' },\n      { pattern: /æ¶ˆã™/, keyword: 'æ¶ˆã™', type: 'delete' },\n      { pattern: /å–ã‚Šé™¤/, keyword: 'å–ã‚Šé™¤', type: 'delete' },\n      { pattern: /é™¤å»/, keyword: 'é™¤å»', type: 'delete' },\n      { pattern: /å‰Šé™¤ã—ã¦/, keyword: 'å‰Šé™¤ã—ã¦', type: 'delete' },\n      { pattern: /delete/i, keyword: 'delete', type: 'delete' },\n      { pattern: /remove/i, keyword: 'remove', type: 'delete' },\n      { pattern: /clear/i, keyword: 'clear', type: 'delete' },\n      { pattern: /erase/i, keyword: 'erase', type: 'delete' }\n    ];\n    \n    const modifyPatterns = [\n      { pattern: /ç§»å‹•/, keyword: 'ç§»å‹•', type: 'modify' },\n      { pattern: /å‹•ã‹ã—ã¦/, keyword: 'å‹•ã‹ã—ã¦', type: 'modify' },\n      { pattern: /å¤‰æ›´/, keyword: 'å¤‰æ›´', type: 'modify' },\n      { pattern: /å¤‰ãˆã¦/, keyword: 'å¤‰ãˆã¦', type: 'modify' },\n      { pattern: /ä¿®æ­£/, keyword: 'ä¿®æ­£', type: 'modify' },\n      { pattern: /èª¿æ•´/, keyword: 'èª¿æ•´', type: 'modify' },\n      { pattern: /move/i, keyword: 'move', type: 'modify' },\n      { pattern: /change/i, keyword: 'change', type: 'modify' },\n      { pattern: /modify/i, keyword: 'modify', type: 'modify' },\n      { pattern: /edit/i, keyword: 'edit', type: 'modify' }\n    ];\n    \n    const generatePatterns = [\n      { pattern: /ä½œã£ã¦/, keyword: 'ä½œã£ã¦', type: 'generate' },\n      { pattern: /ç”Ÿæˆ/, keyword: 'ç”Ÿæˆ', type: 'generate' },\n      { pattern: /ä½œæˆ/, keyword: 'ä½œæˆ', type: 'generate' },\n      { pattern: /æã„ã¦/, keyword: 'æã„ã¦', type: 'generate' },\n      { pattern: /æ›¸ã„ã¦/, keyword: 'æ›¸ã„ã¦', type: 'generate' },\n      { pattern: /create/i, keyword: 'create', type: 'generate' },\n      { pattern: /generate/i, keyword: 'generate', type: 'generate' },\n      { pattern: /make/i, keyword: 'make', type: 'generate' },\n      { pattern: /draw/i, keyword: 'draw', type: 'generate' }\n    ];\n\n    return [...deletePatterns, ...modifyPatterns, ...generatePatterns];\n  }\n\n  /**\n   * Apply keyword highlighting to the input text\n   */\n  applyKeywordHighlighting() {\n    // TODO: ä¸€æ™‚çš„ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒªãƒªãƒ¼ã‚¹å¾Œã«å†æ¤œè¨ï¼‰\n    return;\n\n    if (!this.input || this.isComposing) {\n      return;\n    }\n\n    const text = this.input.value;\n    if (!text.trim()) {\n      this.clearKeywordHighlighting();\n      return;\n    }\n\n    // Get all keyword patterns\n    const allKeywords = this.getAllCommandKeywords();\n    \n    // Find matches in the text\n    const matches = [];\n    for (const { pattern, keyword, type } of allKeywords) {\n      const match = text.match(pattern);\n      if (match) {\n        const startIndex = match.index;\n        const endIndex = startIndex + match[0].length;\n        matches.push({\n          start: startIndex,\n          end: endIndex,\n          keyword: match[0], // Use actual matched text\n          type: type\n        });\n      }\n    }\n\n    // Sort matches by position to avoid overlaps\n    matches.sort((a, b) => a.start - b.start);\n\n    // Apply highlighting if we have matches\n    if (matches.length > 0) {\n      this.createHighlightOverlay(text, matches);\n    } else {\n      this.clearKeywordHighlighting();\n    }\n  }\n\n  /**\n   * Create a highlighting overlay div that sits behind the textarea\n   */\n  createHighlightOverlay(text, matches) {\n    // Remove existing overlay\n    this.clearKeywordHighlighting();\n\n    // Create highlight overlay div\n    this.highlightOverlay = document.createElement('div');\n    this.highlightOverlay.className = 'keyword-highlight-overlay';\n    \n    // Copy textarea styles to overlay\n    const computedStyle = window.getComputedStyle(this.input);\n\n    if (!this.inputDefaultStyles) {\n      this.captureInputDefaultStyles();\n    }\n    this.highlightOverlay.style.cssText = `\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      white-space: pre-wrap;\n      word-wrap: break-word;\n      overflow: hidden;\n      font-family: ${computedStyle.fontFamily};\n      font-size: ${computedStyle.fontSize};\n      font-weight: ${computedStyle.fontWeight};\n      line-height: ${computedStyle.lineHeight};\n      letter-spacing: ${computedStyle.letterSpacing};\n      padding: ${computedStyle.padding};\n      border: ${computedStyle.borderWidth} solid transparent;\n      margin: 0;\n      z-index: 1;\n      color: transparent;\n      background: transparent;\n    `;\n\n    // Build highlighted HTML\n    let highlightedHTML = '';\n    let lastIndex = 0;\n\n    for (const match of matches) {\n      // Add text before this match\n      highlightedHTML += this.escapeHtml(text.substring(lastIndex, match.start));\n      \n      // Add highlighted keyword\n      const color = this.getKeywordColor(match.type);\n      highlightedHTML += `<span style=\"color: ${color}; font-weight: 600; background: linear-gradient(135deg, ${color}22 0%, ${color}11 100%); border-radius: 3px; padding: 1px 2px;\">${this.escapeHtml(match.keyword)}</span>`;\n      \n      lastIndex = match.end;\n    }\n\n    // Add remaining text\n    highlightedHTML += this.escapeHtml(text.substring(lastIndex));\n\n    this.highlightOverlay.innerHTML = highlightedHTML;\n\n    // Make textarea background transparent so overlay shows through\n    this.input.style.background = 'transparent';\n    this.input.style.backgroundColor = 'transparent';\n    this.input.style.backgroundImage = 'none';\n    this.input.style.color = this.getInputTextColor();\n\n    // Insert overlay before textarea\n    this.inputWrapper.insertBefore(this.highlightOverlay, this.input);\n  }\n\n  /**\n   * Get the appropriate color for each keyword type\n   */\n  getKeywordColor(type) {\n    return KEYWORD_HIGHLIGHT_COLOR;\n  }\n\n  getInputTextColor() {\n    if (this.isWabiSabiMode) {\n      return '#F5F5F5';\n    }\n    return this.isDarkMode ? '#ffffff' : '#1f2937';\n  }\n\n  captureInputDefaultStyles() {\n    if (!this.input) {\n      return;\n    }\n    const computedStyle = window.getComputedStyle(this.input);\n    this.inputDefaultStyles = {\n      background: computedStyle.background,\n      backgroundImage: computedStyle.backgroundImage,\n      backgroundColor: computedStyle.backgroundColor,\n      color: computedStyle.color\n    };\n  }\n\n  /**\n   * Clear keyword highlighting\n   */\n  clearKeywordHighlighting() {\n    if (this.highlightOverlay) {\n      this.highlightOverlay.remove();\n      this.highlightOverlay = null;\n    }\n    \n    // Restore textarea background\n    if (this.input) {\n      if (this.inputDefaultStyles) {\n        this.input.style.background = this.inputDefaultStyles.background;\n        this.input.style.backgroundImage = this.inputDefaultStyles.backgroundImage;\n        this.input.style.backgroundColor = this.inputDefaultStyles.backgroundColor;\n        this.input.style.color = this.inputDefaultStyles.color;\n      } else {\n        this.input.style.background = '';\n        this.input.style.backgroundImage = '';\n        this.input.style.backgroundColor = '';\n        this.input.style.color = '';\n      }\n    }\n  }\n\n  /**\n   * Escape HTML characters\n   */\n  escapeHtml(text) {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  /**\n   * ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—æ¤œå‡ºï¼ˆç”»åƒ/å‹•ç”»ï¼‰\n   */\n  detectMediaType(text) {\n    const videoPatterns = [\n      /å‹•ç”»|ãƒ“ãƒ‡ã‚ª|æ˜ åƒ|ãƒ ãƒ¼ãƒ“ãƒ¼/,\n      /video|movie|clip/i\n    ];\n    \n    const imagePatterns = [\n      /ç”»åƒ|å†™çœŸ|çµµ|ã‚¤ãƒ©ã‚¹ãƒˆ|ã‚¤ãƒ¡ãƒ¼ã‚¸/,\n      /image|picture|photo|illustration/i\n    ];\n    \n    if (videoPatterns.some(pattern => pattern.test(text))) {\n      return {\n        type: 'video',\n        confidence: 0.8,\n        reason: 'å‹•ç”»ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰'\n      };\n    }\n    \n    if (imagePatterns.some(pattern => pattern.test(text))) {\n      return {\n        type: 'image',\n        confidence: 0.8,\n        reason: 'ç”»åƒç”Ÿæˆã‚³ãƒãƒ³ãƒ‰'\n      };\n    }\n    \n    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç”»åƒ\n    return {\n      type: 'image',\n      confidence: 0.6,\n      reason: 'ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰ï¼ˆç”»åƒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰'\n    };\n  }\n\n  /**\n   * ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º\n   */\n  showCommandTypeIndicator(commandInfo) {\n    const { type, confidence, reason } = commandInfo;\n    \n    const typeLabels = {\n      generate: 'ğŸ¨ ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰',\n      modify: 'âœï¸ å¤‰æ›´ãƒ¢ãƒ¼ãƒ‰',\n      delete: 'ğŸ—‘ï¸ å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰'\n    };\n    \n    const typeColors = {\n      generate: 'linear-gradient(135deg, #4f46e5, #4338ca)',\n      modify: 'linear-gradient(135deg, #ec4899, #be185d)',\n      delete: 'rgba(107, 114, 128, 0.15)'\n    };\n    \n    // Proactive UX: ä½ä¿¡é ¼åº¦æ™‚ã«ææ¡ˆè¡¨ç¤º\n    if (confidence < 0.7) {\n      this.showProactiveSuggestion(type, confidence);\n    } else {\n      this.hideProactiveSuggestion();\n    }\n    \n    // æ—§ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIã«çµ±åˆæ¸ˆã¿ï¼‰\n    // this.commandTypeIndicator.textContent = `â—¯ ${typeLabels[type].replace('ğŸ¨ ', '').replace('âœï¸ ', '').replace('ğŸ—‘ï¸ ', '')}`;\n    // this.commandTypeIndicator.style.display = 'block';\n    // this.commandTypeIndicator.style.cursor = 'default';\n    \n    // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼å¯¾å¿œ\n    this.enableGestureControl();\n  }\n\n  /**\n   * Proactive UX: ä½ä¿¡é ¼åº¦æ™‚ã®ææ¡ˆè¡¨ç¤º\n   */\n  showProactiveSuggestion(detectedType, confidence) {\n    if (!this.proactiveSuggestion) {\n      this.proactiveSuggestion = document.createElement('div');\n      this.proactiveSuggestion.id = 'proactive-suggestion';\n      this.proactiveSuggestion.style.cssText = `\n        margin-bottom: 0;\n        padding: 10px;\n        background: rgba(255, 193, 7, 0.15);\n        border: 1px solid rgba(255, 193, 7, 0.3);\n        border-radius: 8px;\n        font-size: 12px;\n        color: #ffc107;\n        text-align: center;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      `;\n      // æ—§ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIã«çµ±åˆæ¸ˆã¿ï¼‰\n      // ä»£ã‚ã‚Šã«å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‰ã«æŒ¿å…¥\n      this.container.insertBefore(this.proactiveSuggestion, this.input);\n    }\n\n    const alternativeTypes = ['generate', 'modify', 'delete'].filter(t => t !== detectedType);\n    const suggestion = alternativeTypes[0]; // æœ€åˆã®ä»£æ›¿æ¡ˆ\n\n    const suggestionLabels = {\n      generate: 'ğŸ¨ ç”Ÿæˆ',\n      modify: 'âœï¸ å¤‰æ›´', \n      delete: 'ğŸ—‘ï¸ å‰Šé™¤'\n    };\n\n    this.proactiveSuggestion.innerHTML = `\n      ğŸ’¡ ã‚‚ã—ã‹ã—ã¦ã€Œ${suggestionLabels[suggestion]}ãƒ¢ãƒ¼ãƒ‰ã€ã§ã™ã‹ï¼Ÿ\n      <div style=\"margin-top: 4px; font-size: 10px; opacity: 0.8;\">\n        ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´ | ã‚¹ãƒ¯ã‚¤ãƒ—ã§é¸æŠ\n      </div>\n    `;\n    \n    this.proactiveSuggestion.style.display = 'block';\n    \n    // ã‚¯ãƒªãƒƒã‚¯ã§ææ¡ˆãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´\n    this.proactiveSuggestion.onclick = () => {\n      this.currentMode = suggestion;\n      this.hideProactiveSuggestion();\n      this.updateIndicatorForMode(suggestion, 0.9);\n    };\n  }\n\n  /**\n   * Proactive UXææ¡ˆã‚’éè¡¨ç¤º\n   */\n  hideProactiveSuggestion() {\n    if (this.proactiveSuggestion) {\n      this.proactiveSuggestion.style.display = 'none';\n    }\n  }\n\n  /**\n   * æŒ‡å®šãƒ¢ãƒ¼ãƒ‰ã§ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°\n   */\n  updateIndicatorForMode(mode, confidence) {\n    const typeLabels = {\n      generate: 'ğŸ¨ ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰',\n      modify: 'âœï¸ å¤‰æ›´ãƒ¢ãƒ¼ãƒ‰',\n      delete: 'ğŸ—‘ï¸ å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰'\n    };\n    \n    const typeColors = {\n      generate: 'linear-gradient(135deg, #4f46e5, #4338ca)',\n      modify: 'linear-gradient(135deg, #ec4899, #be185d)',\n      delete: 'rgba(107, 114, 128, 0.15)'\n    };\n\n    // æ—§ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIã«çµ±åˆæ¸ˆã¿ï¼‰\n    // this.commandTypeIndicator.textContent = `â—¯ ${typeLabels[mode].replace('ğŸ¨ ', '').replace('âœï¸ ', '').replace('ğŸ—‘ï¸ ', '')}`;\n  }\n\n  /**\n   * ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æœ‰åŠ¹åŒ–\n   */\n  enableGestureControl() {\n    // æ—§ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼æ©Ÿèƒ½ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIã«çµ±åˆæ¸ˆã¿ï¼‰\n    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§ç›´æ¥ãƒ¢ãƒ¼ãƒ‰é¸æŠå¯èƒ½ã«ãªã£ãŸãŸã‚ã€ã‚¹ãƒ¯ã‚¤ãƒ—æ“ä½œã¯ä¸è¦\n    this.gestureEnabled = true;\n  }\n\n  /**\n   * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ä½œæˆ\n   */\n  createActionButtons() {\n    const container = document.createElement('div');\n    container.style.cssText = `\n      display: flex;\n      margin-top: 8px;\n      gap: 8px;\n    `;\n\n    // å±¥æ­´ãƒœã‚¿ãƒ³å‰Šé™¤ - ã‚¿ã‚¹ã‚¯é€²è¡ŒçŠ¶æ³ã«ç½®ãæ›ãˆæ¸ˆã¿\n\n    // ã‚¯ãƒªã‚¢ã‚ªãƒ¼ãƒ«ãƒœã‚¿ãƒ³\n    const clearBtn = document.createElement('button');\n    clearBtn.innerHTML = 'ğŸ§¹ å…¨å‰Šé™¤';\n    clearBtn.style.cssText = this.getModernButtonStyles('danger');\n    clearBtn.addEventListener('click', () => this.clearAll());\n\n    // historyBtnå‰Šé™¤æ¸ˆã¿\n    container.appendChild(clearBtn);\n\n    return container;\n  }\n\n  /**\n   * ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©\n   */\n  getContainerStyles() {\n    const positions = {\n      'bottom-right': 'bottom: 20px; right: 20px;',\n      'bottom-left': 'bottom: 20px; left: 20px;',\n      'top-right': 'top: 20px; right: 20px;',\n      'top-left': 'top: 20px; left: 20px;',\n      'center': 'top: 50%; left: 50%; transform: translate(-50%, -50%);'\n    };\n\n    // 2025 Glassmorphismä»•æ§˜ï¼šãƒ€ãƒ¼ã‚¯ãƒ»ãƒ©ã‚¤ãƒˆä¸¡å¯¾å¿œ\n    const glassmorphismDark = {\n      background: 'linear-gradient(135deg, rgba(15, 23, 42, 0.7), rgba(30, 27, 75, 0.65))',\n      backdropFilter: 'blur(24px) saturate(180%)',\n      border: '1px solid rgba(99, 102, 241, 0.2)',\n      boxShadow: '0 8px 32px rgba(15, 23, 42, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1)'\n    };\n\n    const glassmorphismLight = {\n      background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))',\n      backdropFilter: 'blur(24px) saturate(180%)',\n      border: '1px solid rgba(255, 255, 255, 0.4)',\n      boxShadow: '0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3)'\n    };\n\n    // ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ - æ¯å±±æ°´ã®é™å¯‚ï¼šç‹¬è‡ªã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£\n    const glassmorphismWabiSabi = {\n      background: 'linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))',\n      backdropFilter: 'blur(20px) saturate(120%)',\n      border: '1px solid rgba(93, 64, 55, 0.5)',\n      boxShadow: '0 8px 32px rgba(33, 33, 33, 0.4), 0 0 0 1px rgba(93, 64, 55, 0.4), inset 0 1px 0 rgba(189, 189, 189, 0.15)'\n    };\n\n    const theme = this.isWabiSabiMode ? glassmorphismWabiSabi : (this.isDarkMode ? glassmorphismDark : glassmorphismLight);\n\n    return `\n      position: fixed;\n      ${positions[this.config.position] || positions['bottom-right']}\n      width: 320px;\n      max-height: ${this.config.maxHeight}px;\n      background: ${theme.background};\n      border: ${theme.border};\n      border-radius: 20px;\n      color: ${this.isDarkMode ? '#ffffff' : '#1f2937'};\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;\n      font-size: 14px;\n      z-index: 1000;\n      padding: 16px !important;\n      box-shadow: ${theme.boxShadow};\n      backdrop-filter: ${theme.backdropFilter};\n      -webkit-backdrop-filter: ${theme.backdropFilter};\n      display: none;\n      flex-direction: column;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    `;\n  }\n\n  getHeaderStyles() {\n    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã¨åŒã˜ç´«ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§çµ±ä¸€\n    const gradientColors = 'linear-gradient(135deg, #4f46e5, #7c3aed)';\n\n    return `\n      margin-bottom: 20px;\n      text-align: center;\n      background: ${gradientColors};\n      -webkit-background-clip: text;\n      -webkit-text-fill-color: transparent;\n      background-clip: text;\n      font-weight: 800;\n      font-size: 18px;\n      border-bottom: 1px solid rgba(79, 70, 229, 0.2);\n      padding-bottom: 12px;\n    `;\n  }\n\n  getOutputStyles() {\n    // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®CSSã‚’æ³¨å…¥\n    this.addScrollbarStyles();\n\n    return `\n      height: 200px;\n      overflow-y: auto;\n      background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(255, 255, 255, 0.1)'};\n      border: 1px solid ${this.isDarkMode ? 'rgba(255, 255, 255, 0.15)' : 'rgba(255, 255, 255, 0.2)'};\n      border-radius: 12px;\n      padding: 12px;\n      margin-bottom: 16px;\n      font-size: 12px;\n      line-height: 1.4;\n      backdrop-filter: blur(8px);\n\n      /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */\n      scrollbar-width: thin;\n      scrollbar-color: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.3) rgba(0, 0, 0, 0.1)'};\n    `;\n  }\n\n  /**\n   * ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒšãƒ¼ã‚¸ã«æ³¨å…¥\n   */\n  addScrollbarStyles() {\n    if (document.getElementById('custom-scrollbar-styles')) return;\n\n    const style = document.createElement('style');\n    style.id = 'custom-scrollbar-styles';\n    style.textContent = `\n      .command-output::-webkit-scrollbar {\n        width: 8px;\n      }\n\n      .command-output::-webkit-scrollbar-track {\n        background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'};\n        border-radius: 4px;\n      }\n\n      .command-output::-webkit-scrollbar-thumb {\n        background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.3)' : 'rgba(0, 0, 0, 0.3)'};\n        border-radius: 4px;\n        transition: background 0.2s ease;\n      }\n\n      .command-output::-webkit-scrollbar-thumb:hover {\n        background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.5)' : 'rgba(0, 0, 0, 0.5)'};\n      }\n\n      /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ */\n      .dark-mode .command-output::-webkit-scrollbar-track {\n        background: rgba(255, 255, 255, 0.1);\n      }\n\n      .dark-mode .command-output::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      .dark-mode .command-output::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.5);\n      }\n\n      /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ */\n      .light-mode .command-output::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.1);\n      }\n\n      .light-mode .command-output::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      .light-mode .command-output::-webkit-scrollbar-thumb:hover {\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      @keyframes shimmer {\n        0% { background-position: -200% 0; }\n        100% { background-position: 200% 0; }\n      }\n\n      /* 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: å¾®ç´°ãªæµ®éŠæ„Ÿã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */\n      @keyframes gentleFloat {\n        0%, 100% { \n          transform: translateY(0px) scale(1);\n        }\n        25% { \n          transform: translateY(-2px) scale(1.005);\n        }\n        50% { \n          transform: translateY(-1px) scale(1.002);\n        }\n        75% { \n          transform: translateY(-3px) scale(1.008);\n        }\n      }\n\n      /* ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ›ãƒãƒ¼åŠ¹æœ */\n      .task-status-container:hover .progress-bar {\n        box-shadow: 0 0 20px rgba(255,123,71,0.6) !important;\n        transform: scaleY(1.1);\n      }\n\n      /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®å¾®ç´°ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */\n      .progress-bar {\n        position: relative;\n      }\n\n      .progress-bar::after {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: linear-gradient(90deg, \n          transparent, \n          rgba(255,255,255,0.4), \n          transparent);\n        animation: progress-shine 2s ease-in-out infinite;\n      }\n\n      @keyframes progress-shine {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(100%); }\n      }\n    `;\n\n    document.head.appendChild(style);\n  }\n\n  getInputStyles() {\n    // 2025 Glassmorphismä»•æ§˜ï¼šå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰\n    const glassmorphismDark = {\n      background: 'linear-gradient(135deg, rgba(30, 27, 75, 0.4), rgba(15, 23, 42, 0.5))',\n      border: '1px solid rgba(99, 102, 241, 0.25)',\n      boxShadow: '0 4px 16px rgba(15, 23, 42, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08)'\n    };\n\n    const glassmorphismLight = {\n      background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))',\n      border: '1px solid rgba(255, 255, 255, 0.5)',\n      boxShadow: '0 4px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.4)'\n    };\n\n    const glassmorphismWabiSabi = {\n      background: 'linear-gradient(135deg, rgba(97, 97, 97, 0.4), rgba(66, 66, 66, 0.3))',\n      border: '1px solid rgba(97, 97, 97, 0.5)',\n      boxShadow: '0 4px 16px rgba(66, 66, 66, 0.3), inset 0 1px 0 rgba(189, 189, 189, 0.2)'\n    };\n\n    const theme = this.isWabiSabiMode ? glassmorphismWabiSabi : (this.isDarkMode ? glassmorphismDark : glassmorphismLight);\n\n    return `\n      width: 100%;\n      padding: 14px 16px;\n      background: ${theme.background};\n      border: ${theme.border};\n      border-radius: 14px;\n      color: ${this.isWabiSabiMode ? '#F5F5F5' : (this.isDarkMode ? '#ffffff' : '#1f2937')};\n      font-size: 14px;\n      outline: none;\n      box-sizing: border-box;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      font-family: inherit;\n      backdrop-filter: blur(16px);\n      -webkit-backdrop-filter: blur(16px);\n      box-shadow: ${theme.boxShadow};\n      placeholder-color: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.5)' : 'rgba(55, 65, 81, 0.6)'};\n      resize: none;\n      overflow-y: hidden;\n      min-height: 22px;\n      max-height: 66px;\n      line-height: 22px;\n    `;\n  }\n\n  getModernButtonStyles(type) {\n    const styles = {\n      primary: this.isWabiSabiMode ? `\n        background: linear-gradient(135deg, #8D6E63, #6D4C41);\n        box-shadow: 0 4px 12px rgba(85, 139, 47, 0.4), inset 0 1px 0 rgba(184, 158, 135, 0.15);\n        width: 100%;\n        padding: 16px;\n        font-size: 14px;\n        font-weight: 600;\n      ` : `\n        background: linear-gradient(135deg, #4f46e5, #4338ca);\n        width: 100%;\n        padding: 16px;\n        font-size: 14px;\n        font-weight: 600;\n      `,\n      secondary: this.isWabiSabiMode ? `\n        background: rgba(158, 158, 158, 0.2);\n        border: 1px solid rgba(141, 110, 99, 0.4);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #F5F5F5;\n      ` : `\n        background: rgba(255, 255, 255, 0.08);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n      `,\n      danger: this.isWabiSabiMode ? `\n        background: rgba(141, 110, 99, 0.3);\n        border: 1px solid rgba(93, 64, 55, 0.5);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #F5F5F5;\n      ` : `\n        background: rgba(255, 59, 48, 0.15);\n        border: 1px solid rgba(255, 59, 48, 0.3);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #ff453a;\n      `\n    };\n\n    return `\n      border: none;\n      border-radius: 12px;\n      color: white;\n      cursor: pointer;\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      font-family: inherit;\n      outline: none;\n      ${styles[type]}\n    `;\n  }\n\n  getModeButtonStyles(isActive, mode) {\n    // ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ©ãƒ¼è¨­å®š\n    const modeColors = {\n      generate: 'linear-gradient(135deg, #22c55e, #16a34a)',  // Green - ãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘è‰²\n      modify: 'linear-gradient(135deg, #22c55e, #16a34a)',    // Green - ãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘è‰²\n      delete: 'linear-gradient(135deg, #22c55e, #16a34a)'     // Green - ãƒãƒ£ãƒƒãƒˆæ¬„ã¨åŒã˜ç·‘è‰²\n    };\n    \n    return `\n      flex: 1;\n      padding: 12px 16px;\n      border: none;\n      border-radius: 8px;\n      color: ${isActive ? 'white' : 'rgba(255, 255, 255, 0.7)'};\n      background: ${isActive ? modeColors[mode] : 'transparent'};\n      font-size: 13px;\n      font-weight: 600;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n    `;\n  }\n\n  /**\n   * ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°\n   */\n  bindEvents() {\n    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ\n    document.addEventListener('keydown', (e) => {\n      // è¨­å®šã•ã‚ŒãŸã‚­ãƒ¼ã§UIè¡¨ç¤ºåˆ‡æ›¿\n      if (e.key === this.config.activationKey) {\n        e.preventDefault();\n        this.toggle();\n        return;\n      }\n      \n      // Enterã‚­ãƒ¼å‡¦ç†ã¯initUI()å†…ã§è¡Œã†ãŸã‚ã€ã“ã“ã§ã¯å‡¦ç†ã—ãªã„\n      // ï¼ˆIMEå¯¾å¿œã®ãŸã‚ï¼‰\n      \n      // Escapeã§éè¡¨ç¤º\n      if (this.isVisible && e.key === 'Escape') {\n        this.hide();\n      }\n      \n      // Ctrl+Z/Ctrl+Y ã§Undo/Redo\n      if (this.isVisible && e.ctrlKey) {\n        if (e.key === 'z' && !e.shiftKey) {\n          e.preventDefault();\n          this.undo();\n        } else if (e.key === 'y' || (e.key === 'z' && e.shiftKey)) {\n          e.preventDefault();\n          this.redo();\n        }\n      }\n    });\n\n    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´\n    this.input.addEventListener('focus', () => {\n      if (this.isWabiSabiMode) {\n        this.input.style.borderColor = '#8BC34A';\n        this.input.style.boxShadow = '0 0 5px rgba(139, 195, 74, 0.5)';\n      } else {\n        this.input.style.borderColor = '#74b9ff';\n        this.input.style.boxShadow = '0 0 5px rgba(116, 185, 255, 0.5)';\n      }\n    });\n\n    this.input.addEventListener('blur', () => {\n      if (this.isWabiSabiMode) {\n        this.input.style.borderColor = '#8D6E63';\n        this.input.style.boxShadow = 'none';\n      } else {\n        this.input.style.borderColor = '#4a90e2';\n        this.input.style.boxShadow = 'none';\n      }\n    });\n  }\n\n  /**\n   * UIè¡¨ç¤º/éè¡¨ç¤ºåˆ‡æ›¿\n   */\n  toggle() {\n    if (this.isVisible) {\n      this.hide();\n    } else {\n      this.show();\n    }\n  }\n\n  /**\n   * UIè¡¨ç¤º\n   */\n  show() {\n    this.container.style.display = 'flex';\n    this.container.style.flexDirection = 'column';\n    this.floatingContainer.style.display = 'flex';\n\n    // UIãƒ•ã‚©ãƒ¼ãƒ ã®ä½ç½®ã«åˆã‚ã›ã¦é…ç½®ï¼ˆå°‘ã—é…å»¶ã—ã¦æ­£ç¢ºãªä½ç½®ã‚’å–å¾—ï¼‰\n    setTimeout(() => {\n      const containerRect = this.container.getBoundingClientRect();\n      this.floatingContainer.style.left = containerRect.left + 'px';\n      this.floatingContainer.style.top = (containerRect.top - 80) + 'px';\n      this.floatingContainer.style.width = containerRect.width + 'px';\n      this.floatingContainer.style.transform = 'none';\n    }, 50);\n\n    this.isVisible = true;\n    this.input.focus();\n\n    // ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºä¸­ã¯ãƒãƒ§ã‚³ã‚¢ã‚¤ã‚³ãƒ³ã‚’éš ã™\n    if (this.floatingChocolateIcon) {\n      this.floatingChocolateIcon.style.opacity = '0';\n      this.floatingChocolateIcon.style.pointerEvents = 'none';\n    }\n\n    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–\n    this.onControlsToggle(true);\n    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«åœæ­¢æ™‚ã‚‚é™ã‹ã«\n  }\n\n  /**\n   * UIéè¡¨ç¤º\n   */\n  hide() {\n    this.container.style.display = 'none';\n    this.floatingContainer.style.display = 'none';\n    this.isVisible = false;\n\n    // ãƒ•ã‚©ãƒ¼ãƒ éè¡¨ç¤ºæ™‚ã¯ãƒãƒ§ã‚³ã‚¢ã‚¤ã‚³ãƒ³ã‚’å†è¡¨ç¤º\n    if (this.floatingChocolateIcon) {\n      this.floatingChocolateIcon.style.opacity = '0.8';\n      this.floatingChocolateIcon.style.pointerEvents = 'auto';\n    }\n\n    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å†æœ‰åŠ¹åŒ–\n    this.onControlsToggle(false);\n    this.logDebug('ğŸ® ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å†é–‹');\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ\n   */\n  switchMode(mode) {\n    if (this.currentMode === mode) return;\n    \n    this.currentMode = mode;\n    \n    // ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°\n    this.container.querySelectorAll('[data-mode]').forEach(btn => {\n      const isActive = btn.dataset.mode === mode;\n      btn.style.cssText = this.getModeButtonStyles(isActive, btn.dataset.mode);\n    });\n    \n    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ›´æ–°\n    this.input.placeholder = this.getPlaceholderForMode(mode);\n    \n    // å®Ÿè¡Œãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«ã¨è‰²æ›´æ–°\n    const executeBtn = this.container.querySelector('#execute-btn');\n    const labels = {\n      generate: 'ğŸ¨ Generate Object',\n      modify: 'âœï¸ Apply Changes', \n      delete: 'ğŸ—‘ï¸ Delete Objects'\n    };\n    \n    const buttonColors = {\n      generate: 'linear-gradient(135deg, #5b21b6, #4c1d95)',\n      modify: 'linear-gradient(135deg, #ec4899, #be185d)', \n      delete: 'rgba(107, 114, 128, 0.15)'\n    };\n    \n    executeBtn.innerHTML = `<span>${labels[mode]}</span>`;\n    executeBtn.style.background = buttonColors[mode];\n    \n    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆé€šçŸ¥ã¯ä¸è¦ï¼ˆãƒœã‚¿ãƒ³ã§åˆ†ã‹ã‚‹ãŸã‚ï¼‰\n  }\n  \n  /**\n   * ãƒ¢ãƒ¼ãƒ‰åˆ¥ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼\n   */\n  getPlaceholderForMode(mode) {\n    const placeholders = {\n      generate: 'ã€ŒçŒ«ã®ç”»åƒã‚’ä½œã£ã¦ã€ã¨è©±ã—ã‹ã‘ã¦ â âœ¨',\n      import: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ â ğŸ“',\n      modify: 'é¸æŠå¾Œã€Œãƒ”ãƒ³ã‚¯ã«å¤‰æ›´ã€ã¨ä¼ãˆã¦ â âœï¸',\n      delete: 'é¸æŠå¾Œã€ã‚³ãƒãƒ³ãƒ‰ã‚’ãã®ã¾ã¾é€ã£ã¦ â ğŸ—‘ï¸'\n    };\n    return placeholders[mode] || placeholders.generate;\n  }\n\n  /**\n   * ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ\n   */\n  async executeCommand() {\n    const command = this.input.value.trim();\n    if (!command) return;\n\n    // æœ€çµ‚çš„ãªã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—åˆ¤å®š\n    const commandType = this.analyzeCommandType(command);\n\n    if (this.selectedFile) {\n      if (this.currentMode !== 'import') {\n        this.selectMode('import', false);\n      }\n      this.currentMode = 'import';\n    } else {\n      this.currentMode = commandType.type;\n    }\n\n    // å‰Šé™¤ã®å ´åˆã¯ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°\n    if (commandType.requiresConfirmation) {\n      const confirmed = await this.showDeleteConfirmation(command);\n      if (!confirmed) {\n        this.addOutput('âŒ å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'system');\n        return;\n      }\n    }\n\n    // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢\n    this.input.value = '';\n    // æ—§ã‚³ãƒãƒ³ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³UIã«çµ±åˆæ¸ˆã¿ï¼‰\n    // this.commandTypeIndicator.style.display = 'none';\n    this.hideProactiveSuggestion();\n\n    // ã‚³ãƒãƒ³ãƒ‰è¡¨ç¤ºï¼ˆãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—ä»˜ãï¼‰\n    const mediaIcon = commandType.mediaType === 'video' ? 'ğŸ¬' : 'ğŸ–¼ï¸';\n    // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ä½œæˆ\n    const taskId = this.addTaskCard(command, { status: 'processing' });\n\n    // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå‰ã®çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜\n    this.saveCommandToHistory({\n      command: command,\n      mode: this.currentMode,\n      mediaType: commandType.mediaType,\n      timestamp: Date.now()\n    });\n\n    try {\n      // å‡¦ç†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º\n      // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã¯æ—¢ã«1183è¡Œç›®ã§ä½œæˆæ¸ˆã¿ï¼ˆtaskIdå¤‰æ•°ï¼‰\n      // é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½œæˆã—ãªã„\n\n      let result;\n      \n      // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸã‚³ãƒãƒ³ãƒ‰å‡¦ç†\n      const modePrefix = this.getModePrefix(this.currentMode);\n      const fullCommand = `${modePrefix}${command}`;\n\n      // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®å®Ÿè¡Œå‡¦ç†\n      this.logDebug('ğŸ” Current mode check:', this.currentMode);\n      if (this.currentMode === 'import') {\n        this.logDebug('ğŸ“ Import mode detected - bypassing SceneManager');\n        // Importãƒ¢ãƒ¼ãƒ‰: ç›´æ¥å‡¦ç†ï¼ˆSceneManagerã‚’è¿‚å›ï¼‰\n        if (!this.selectedFile) {\n          throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');\n        }\n        result = await this.handleImportCommand(command);\n      } else if (this.sceneManager) {\n        // ä»–ã®ãƒ¢ãƒ¼ãƒ‰: SceneManagerçµŒç”±\n        result = await this.sceneManager.executeCommand(fullCommand);\n      } else if (this.client) {\n        // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’é¸æŠ\n        if (this.currentMode === 'generate') {\n          // ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰: æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ\n          if (commandType.mediaType === 'video') {\n            result = await this.client.generateVideo(command, {\n              model: this.selectedVideoService || undefined\n            });\n          } else {\n            result = await this.client.generateImage(command, {\n              service: this.selectedImageService || undefined\n            });\n          }\n        } else if (this.currentMode === 'modify') {\n          // å¤‰æ›´ãƒ¢ãƒ¼ãƒ‰: æ—¢å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤‰æ›´ï¼ˆé¸æŠãŒå¿…è¦ï¼‰\n          if (!this.selectedObject) {\n            throw new Error('å¤‰æ›´ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšå¯¾è±¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');\n          }\n          result = await this.client.modifySelectedObject(this.selectedObject, command);\n        } else if (this.currentMode === 'delete') {\n          // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠãƒã‚§ãƒƒã‚¯\n          if (!this.selectedObject && !this.sceneManager?.getSelectedObjects()?.length) {\n            this.addOutput('âš ï¸ å‰Šé™¤ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãš3Dã‚·ãƒ¼ãƒ³å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã—ã¦ã‹ã‚‰ã€å†åº¦Deleteãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'system');\n            return;\n          }\n          // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰: ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰å‰Šé™¤\n          const confirmMessage = `æœ¬å½“ã«ã€Œ${command}ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;\n          if (!confirm(confirmMessage)) {\n            this.addOutput('âŒ å‰Šé™¤ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'system');\n            return;\n          }\n          result = await this.client.deleteObjects(command);\n        } else {\n          // ãã®ä»–ã®ãƒ¢ãƒ¼ãƒ‰\n          result = await this.client.executeCommand(fullCommand);\n        }\n      } else {\n        throw new Error('SceneManager ã¾ãŸã¯ Client ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');\n      }\n\n      // taskIdå–å¾—ã¨SSEæ¥ç¶šé–‹å§‹\n      if (result && result.taskId) {\n        this.connectToProgress(result.taskId, taskId);\n        this.currentTaskId = result.taskId;\n      }\n\n      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\n      const successMessages = {\n        generate: ``, // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ - çµæœã§ååˆ†\n        modify: 'âœ… å¤‰æ›´ã‚’é©ç”¨ã—ã¾ã—ãŸ',\n        delete: 'ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ'\n      };\n      \n      // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰å®Œäº†\n      if (taskId) {\n        this.updateTaskCard(taskId, 'completed');\n      }\n      \n      // è©³ç´°æƒ…å ±è¡¨ç¤º\n      if (result.modelName) {\n        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‰Šé™¤ - ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç”¨ã«ä¿å­˜\n      }\n      \n      if (result.objectId) {\n        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆIDå‰Šé™¤\n      }\n      \n      if (result.position) {\n        // ä½ç½®æƒ…å ±å‰Šé™¤\n      }\n\n      if (commandType.mediaType) {\n        // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—å‰Šé™¤\n      }\n\n    } catch (error) {\n      const errorMessages = {\n        generate: `âŒ ${commandType.mediaType === 'video' ? 'å‹•ç”»' : 'ç”»åƒ'}ç”Ÿæˆã‚¨ãƒ©ãƒ¼`,\n        modify: 'âŒ å¤‰æ›´ã‚¨ãƒ©ãƒ¼', \n        delete: 'âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼'\n      };\n      // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼\n      if (taskId) {\n        this.updateTaskCard(taskId, 'error', { errorMessage: error.message });\n      }\n\n      this.addOutput(`${errorMessages[this.currentMode]}: ${error.message}`, 'error');\n      console.error('Command execution error:', error);\n    }\n\n    // 2025å¹´UXãƒˆãƒ¬ãƒ³ãƒ‰: ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå¾Œã®è‡ªå‹•é¸æŠè§£é™¤\n    if (this.sceneManager && this.sceneManager.selectedObject) {\n      // Modify/Deleteã‚³ãƒãƒ³ãƒ‰å¾Œã¯é¸æŠã‚’è‡ªå‹•è§£é™¤ã—ã¦ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›\n      if (this.currentMode === 'modify' || this.currentMode === 'delete') {\n        setTimeout(() => {\n          this.sceneManager.deselectObject();\n        }, 500); // å°‘ã—é…å»¶ã•ã›ã¦æ“ä½œå®Œäº†ã‚’è¦–è¦šçš„ã«ç¢ºèª\n      }\n    }\n\n    // å‡ºåŠ›ã‚¨ãƒªã‚¢ã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«\n    if (this.config.autoScroll) {\n      this.scrollToBottom();\n    }\n  }\n\n  /**\n   * å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°\n   */\n  async showConfirmationDialog(options) {\n    const {\n      icon = 'ğŸ—‘ï¸',\n      title = 'ç¢ºèª',\n      message = 'ã“ã®æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ',\n      confirmText = 'å®Ÿè¡Œ',\n      cancelText = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',\n      confirmColor = '#ef4444'\n    } = options;\n\n    return new Promise((resolve) => {\n      const modal = document.createElement('div');\n      modal.style.cssText = `\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(15, 23, 42, 0.6);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        z-index: 2000;\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n      `;\n\n      const dialog = document.createElement('div');\n      dialog.style.cssText = `\n        background: ${this.isWabiSabiMode\n          ? 'linear-gradient(135deg, rgba(239, 235, 233, 0.4), rgba(215, 204, 200, 0.3))'\n          : (this.isDarkMode\n            ? 'linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(30, 27, 75, 0.8))'\n            : 'linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3))')};\n        border: 1px solid ${this.isWabiSabiMode\n          ? 'rgba(161, 136, 127, 0.4)'\n          : (this.isDarkMode ? 'rgba(99, 102, 241, 0.3)' : 'rgba(255, 255, 255, 0.5)')};\n        border-radius: 20px;\n        padding: 32px;\n        max-width: 420px;\n        text-align: center;\n        color: ${this.isWabiSabiMode\n          ? '#5D4037'\n          : (this.isDarkMode ? '#ffffff' : '#1f2937')};\n        font-family: inherit;\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n        box-shadow: ${this.isWabiSabiMode\n          ? '0 8px 32px rgba(93, 64, 55, 0.2), 0 0 0 1px rgba(161, 136, 127, 0.2)'\n          : (this.isDarkMode\n            ? '0 8px 32px rgba(15, 23, 42, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1)'\n            : '0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2)')};\n        transform: scale(0.9);\n        opacity: 0;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      `;\n\n      dialog.innerHTML = `\n        <div style=\"font-size: 56px; margin-bottom: 20px;\">${icon}</div>\n        <h3 style=\"margin: 0 0 16px 0; color: ${this.isDarkMode ? '#a5b4fc' : '#6366f1'}; font-size: 20px; font-weight: 700; letter-spacing: 0.02em;\">\n          ${title}\n        </h3>\n        <p style=\"margin: 0 0 28px 0; color: ${this.isDarkMode ? '#d1d5db' : '#6b7280'}; line-height: 1.6; font-size: 16px;\">\n          ${message}\n        </p>\n        <div style=\"display: flex; gap: 8px; justify-content: center;\">\n          <button id=\"cancel-btn\" style=\"\n            padding: 14px 24px;\n            background: ${this.isDarkMode \n              ? 'linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2))'\n              : 'linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))'};\n            border: 1px solid ${this.isDarkMode ? 'rgba(156, 163, 175, 0.2)' : 'rgba(255, 255, 255, 0.3)'};\n            border-radius: 12px;\n            color: ${this.isDarkMode ? '#d1d5db' : '#374151'};\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 600;\n            transition: all 0.2s ease;\n            backdrop-filter: blur(16px);\n            -webkit-backdrop-filter: blur(16px);\n          \">${cancelText}</button>\n          <button id=\"confirm-btn\" style=\"\n            padding: 14px 24px;\n            background: ${confirmColor === (this.isWabiSabiMode ? '#8BC34A' : '#6366f1') \n              ? 'linear-gradient(135deg, ' + (this.isWabiSabiMode ? '#8BC34A, #689F38' : '#6366f1, #8b5cf6') + ')' \n              : confirmColor === '#ef4444'\n              ? 'linear-gradient(135deg, #ef4444, #dc2626)'\n              : 'linear-gradient(135deg, #ff7b47, #f97316)'};\n            border: none;\n            border-radius: 12px;\n            color: white;\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 700;\n            transition: all 0.2s ease;\n            box-shadow: 0 4px 16px ${confirmColor === (this.isWabiSabiMode ? '#8BC34A' : '#6366f1') \n              ? 'rgba(99, 102, 241, 0.3)' \n              : confirmColor === '#ef4444' \n              ? 'rgba(239, 68, 68, 0.3)' \n              : 'rgba(255, 123, 71, 0.3)'};\n            backdrop-filter: blur(8px);\n            -webkit-backdrop-filter: blur(8px);\n          \">${confirmText}</button>\n        </div>\n      `;\n\n      modal.appendChild(dialog);\n      document.body.appendChild(modal);\n\n      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹\n      requestAnimationFrame(() => {\n        modal.style.opacity = '1';\n        dialog.style.transform = 'scale(1)';\n        dialog.style.opacity = '1';\n      });\n\n      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼\n      dialog.querySelector('#cancel-btn').onclick = () => {\n        this.closeModalWithAnimation(modal);\n        resolve(false);\n      };\n\n      dialog.querySelector('#confirm-btn').onclick = () => {\n        this.closeModalWithAnimation(modal);\n        resolve(true);\n      };\n\n      // ESCã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«\n      const escHandler = (e) => {\n        if (e.key === 'Escape') {\n          this.closeModalWithAnimation(modal);\n          document.removeEventListener('keydown', escHandler);\n          resolve(false);\n        }\n      };\n      document.addEventListener('keydown', escHandler);\n\n      // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«\n      modal.onclick = (e) => {\n        if (e.target === modal) {\n          this.closeModalWithAnimation(modal);\n          resolve(false);\n        }\n      };\n    });\n  }\n\n  async showDeleteConfirmation(command) {\n    return this.showConfirmationDialog({\n      icon: 'ğŸ—‘ï¸',\n      title: 'å‰Šé™¤ã®ç¢ºèª',\n      message: `ã€Œ${command}ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚`,\n      confirmText: 'å‰Šé™¤å®Ÿè¡Œ',\n      cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',\n      confirmColor: '#ff7b47'\n    });\n  }\n\n  /**\n   * å‡ºåŠ›ã‚¨ãƒªã‚¢ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ \n   */\n  /**\n   * ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰è¿½åŠ ï¼ˆå¾“æ¥ã®addOutputã‚’ç½®ãæ›ãˆï¼‰\n   */\n  addOutput(message, type = 'default', options = {}) {\n    // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰å½¢å¼ã§å‡¦ç†\n    if (type === 'task' || type === 'progress') {\n      return this.addTaskCard(message, options);\n    }\n\n    // ã‚¨ãƒ©ãƒ¼ã¨ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¡¨ç¤º\n    if (type === 'error' || type === 'system') {\n      this.addSystemMessage(message, type);\n    }\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰è¿½åŠ \n   */\n  addTaskCard(taskInfo, options = {}) {\n    if (!this.taskCards) this.taskCards = new Map();\n\n    const taskId = options.taskId || `task_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;\n    const status = options.status || 'pending';\n    const prompt = taskInfo.prompt || taskInfo.command || taskInfo;\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ä½œæˆ\n    const card = document.createElement('div');\n    card.className = 'floating-task-card';\n    card.setAttribute('data-task-id', taskId);\n\n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: å¾…æ©Ÿä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ\n    if (status === 'pending' || status === 'processing' || status === 'progress') {\n      card.classList.add('chocodrop-shimmer', 'chocodrop-float');\n    }\n\n    // iOS 26 Liquid Glass + 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«\n    card.style.cssText = this.getFloatingCardStyles(status);\n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨åˆæœŸçŠ¶æ…‹ï¼ˆéè¡¨ç¤ºï¼‰- å¼·åˆ¶è¨­å®š\n    card.style.setProperty('opacity', '0', 'important');\n    card.style.setProperty('transform', 'translateY(20px) scale(0.95)', 'important');\n    card.style.setProperty('filter', 'blur(4px)', 'important');\n\n    const iconMap = {\n      pending: 'â³',\n      processing: 'ğŸ¨',\n      progress: 'âš¡',\n      completed: 'âœ…',\n      error: 'âŒ'\n    };\n\n    const statusText = {\n      pending: 'å¾…æ©Ÿä¸­',\n      processing: 'ç”Ÿæˆä¸­',\n      progress: 'é€²è¡Œä¸­',\n      completed: 'å®Œäº†',\n      error: 'ã‚¨ãƒ©ãƒ¼'\n    };\n\n    // æ¸©ã‹ã¿ã®ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º\n    const friendlyMessage = this.getFriendlyMessage(status, prompt, options.errorMessage);\n    card.innerHTML = `\n      <span style=\"font-size: 14px;\">${iconMap[status]}</span>\n      <span style=\"font-size: 13px; margin-left: 6px;\">${friendlyMessage}</span>\n    `;\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ ï¼ˆæœ€æ–°ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«ï¼‰\n    this.floatingContainer.insertBefore(card, this.floatingContainer.firstChild);\n    \n    // ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºåˆ¶é™ã‚’é©ç”¨ï¼ˆæœ€æ–°3å€‹ã¾ã§è¡¨ç¤ºï¼‰\n    this.updateCardDisplayLimit();\n\n    this.taskCards.set(taskId, {\n      element: card,\n      status: status,\n      prompt: prompt,\n      originalPrompt: prompt, // å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\n      startTime: Date.now(),\n      endTime: null,\n      error: null,\n      contentType: 'image', // 'image', 'video', etc.\n      model: null,\n      settings: null\n    });\n\n    // ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼\n    this.addCardDetailEvents(card, taskId);\n    \n    // å…¥å ´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    this.animateCardEntrance(card);\n    \n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: ã‚·ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆCSSç¢ºä¿\n    this.ensureShimmerStyles();\n    \n    return taskId;\n  }\n\n  /**\n   * 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: ã‚·ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¢ºä¿\n   */\n  ensureShimmerStyles() {\n    if (document.querySelector('#chocodrop-shimmer-styles')) return;\n    \n    const styleSheet = document.createElement('style');\n    styleSheet.id = 'chocodrop-shimmer-styles';\n    styleSheet.textContent = `\n      /* 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: ã‚·ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå¼·åŒ–ç‰ˆï¼‰ */\n      .chocodrop-shimmer {\n        position: relative;\n        overflow: hidden;\n      }\n      \n      .chocodrop-shimmer::before {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: -100%;\n        width: 100%;\n        height: 100%;\n        background: linear-gradient(\n          90deg,\n          transparent,\n          ${this.isDarkMode ? 'rgba(255, 255, 255, 0.5)' : 'rgba(255, 255, 255, 0.7)'},\n          transparent\n        );\n        animation: shimmer 1.5s infinite;\n        pointer-events: none;\n        z-index: 1;\n      }\n      \n      .chocodrop-shimmer > * {\n        position: relative;\n        z-index: 2;\n      }\n      \n      /* 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: å¾®ç´°ãªæµ®éŠæ„Ÿ */\n      .chocodrop-float {\n        animation: gentleFloat 4s ease-in-out infinite;\n      }\n      \n      /* å¾…æ©Ÿä¸­ã®ç‰¹åˆ¥ãªãƒ‘ãƒ«ã‚¹åŠ¹æœï¼ˆå¼·åŒ–ç‰ˆï¼‰ */\n      .chocodrop-shimmer.floating-task-card {\n        animation: gentleFloat 4s ease-in-out infinite, subtlePulse 3s ease-in-out infinite;\n      }\n      \n      @keyframes subtlePulse {\n        0%, 100% { \n          box-shadow: 0 8px 32px rgba(15, 23, 42, 0.3), 0 0 0 1px rgba(99, 102, 241, 0.1);\n        }\n        50% { \n          box-shadow: 0 12px 40px rgba(15, 23, 42, 0.5), 0 0 0 1px rgba(99, 102, 241, 0.3);\n        }\n      }\n    `;\n    \n    document.head.appendChild(styleSheet);\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰æ›´æ–°\n   */\n  updateTaskCard(taskId, status, options = {}) {\n    if (!this.taskCards || !this.taskCards.has(taskId)) return;\n\n    const taskData = this.taskCards.get(taskId);\n    const card = taskData.element;\n\n    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°\n    taskData.status = status;\n\n    // ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ä¿å­˜\n    if (status === 'error' && options.errorMessage) {\n      taskData.error = options.errorMessage;\n    }\n\n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†\n    if (status === 'pending' || status === 'processing' || status === 'progress') {\n      // å¾…æ©Ÿä¸­ãƒ»å‡¦ç†ä¸­: ã‚·ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ \n      card.classList.add('chocodrop-shimmer', 'chocodrop-float');\n    } else {\n      // å®Œäº†ãƒ»ã‚¨ãƒ©ãƒ¼: ã‚·ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå‰Šé™¤\n      card.classList.remove('chocodrop-shimmer', 'chocodrop-float');\n    }\n\n    const iconMap = {\n      pending: 'â³',\n      processing: 'ğŸ¨',\n      progress: 'âš¡',\n      completed: 'âœ…',\n      error: 'âŒ'\n    };\n\n    // æ¸©ã‹ã¿ã®ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã¯ç†ç”±ã‚‚å«ã‚ã‚‹ï¼‰\n    const friendlyMessage = this.getFriendlyMessage(status, taskData.prompt, taskData.error);\n    card.innerHTML = `\n      <span style=\"font-size: 14px;\">${iconMap[status]}</span>\n      <span style=\"font-size: 13px; margin-left: 6px;\">${friendlyMessage}</span>\n    `;\n\n    // ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°ï¼ˆå®Œäº†çŠ¶æ…‹ã«å¿œã˜ã¦ï¼‰\n    card.style.cssText = this.getFloatingCardStyles(status);\n\n    // å®Œäº†æ™‚ã®è‡ªå‹•æ¶ˆå»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    if (status === 'completed') {\n      this.animateCardSuccess(card, taskId);\n    } else if (status === 'error') {\n      this.animateCardError(card, taskId);\n    }\n  }\n\n  /**\n   * ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º\n   */\n  addSystemMessage(message, type) {\n    const entry = document.createElement('div');\n    entry.className = `system-message ${type}`;\n    entry.style.cssText = `\n      padding: 8px 12px;\n      margin: 4px 0;\n      border-radius: 8px;\n      font-size: 12px;\n      line-height: 1.4;\n      animation: slideIn 0.3s ease-out;\n      background: ${type === 'error' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(107, 114, 128, 0.1)'};\n      border: 1px solid ${type === 'error' ? 'rgba(239, 68, 68, 0.3)' : 'rgba(107, 114, 128, 0.3)'};\n      color: ${type === 'error' ? '#fca5a5' : (this.isDarkMode ? '#d1d5db' : '#6b7280')};\n    `;\n    entry.textContent = message;\n    this.outputDiv.appendChild(entry);\n    this.scrollToBottom();\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«å–å¾—\n   */\n  getTaskCardStyles(status) {\n    const baseStyles = `\n      background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.08)' : 'rgba(255, 255, 255, 0.15)'};\n      border: 1px solid ${this.isDarkMode ? 'rgba(255, 255, 255, 0.15)' : 'rgba(255, 255, 255, 0.25)'};\n      border-radius: 12px;\n      padding: 16px;\n      margin-bottom: 12px;\n      backdrop-filter: blur(12px);\n      transition: all 0.3s ease;\n      animation: slideInUp 0.3s ease-out;\n    `;\n\n    const statusBorders = {\n      pending: 'rgba(167, 139, 250, 0.3)',     // è–„ç´«\n      processing: 'rgba(192, 132, 252, 0.5)',  // ç´«ï¼ˆå¼·èª¿ï¼‰\n      progress: 'rgba(236, 72, 153, 0.4)',     // ãƒ”ãƒ³ã‚¯\n      completed: 'rgba(167, 139, 250, 0.4)',   // ç´«\n      error: 'rgba(239, 68, 68, 0.4)'          // èµ¤\n    };\n\n    return baseStyles + `border-left: 3px solid ${statusBorders[status] || statusBorders.pending};`;\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆiOS 26 Liquid Glass + 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰\n   */\n  getFloatingCardStyles(status) {\n    // 2025å¹´Glassmorphismä»•æ§˜ï¼šãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰\n    const glassmorphismDark = {\n      background: 'linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 27, 75, 0.7))',\n      border: '1px solid rgba(99, 102, 241, 0.25)',\n      boxShadow: '0 8px 32px rgba(15, 23, 42, 0.3), 0 0 0 1px rgba(99, 102, 241, 0.1)',\n      color: '#ffffff'\n    };\n\n    const glassmorphismLight = {\n      background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25))',\n      border: '1px solid rgba(255, 255, 255, 0.4)',\n      boxShadow: '0 8px 32px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.2)',\n      color: '#1f2937'\n    };\n\n    const theme = this.isDarkMode ? glassmorphismDark : glassmorphismLight;\n    \n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: å¾…æ©Ÿä¸­ã®ã‚·ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ\n    const shimmerEffect = (status === 'pending' || status === 'processing' || status === 'progress') ? `\n      position: relative;\n      overflow: hidden;\n      &::before {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: -100%;\n        width: 100%;\n        height: 100%;\n        background: linear-gradient(\n          90deg,\n          transparent,\n          ${this.isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.4)'},\n          transparent\n        );\n        animation: shimmer 2s infinite;\n      }\n    ` : '';\n\n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: å¾®ç´°ãªæµ®éŠæ„Ÿ\n    const floatingAnimation = (status === 'pending' || status === 'processing' || status === 'progress') ? `\n      animation: gentleFloat 4s ease-in-out infinite, shimmer 2s infinite;\n    ` : '';\n\n    return `\n      height: 36px;\n      padding: 0 18px;\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n      background: ${theme.background};\n      backdrop-filter: blur(24px) saturate(180%);\n      -webkit-backdrop-filter: blur(24px) saturate(180%);\n      border: ${theme.border};\n      border-radius: 18px;\n      color: ${theme.color};\n      pointer-events: auto;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;\n      font-weight: 600;\n      font-size: 13px;\n      letter-spacing: 0.01em;\n      box-shadow: ${theme.boxShadow};\n      transform: translateY(10px);\n      opacity: 0;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      ${shimmerEffect}\n      ${floatingAnimation}\n      position: relative;\n      overflow: hidden;\n    `;\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºåˆ¶é™ã‚’é©ç”¨ï¼ˆæœ€å¤§3å€‹ã¾ã§è¡¨ç¤ºã€ãã‚Œä»¥ä¸Šã¯ã€Œ+ Nã€ã§è¡¨ç¤ºï¼‰\n   */\n  updateCardDisplayLimit() {\n    const maxVisibleCards = 3;\n    const allCards = Array.from(this.floatingContainer.children).filter(child => \n      !child.classList.contains('overflow-counter')\n    );\n    \n    // æ—¢å­˜ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å‰Šé™¤\n    const existingCounter = this.floatingContainer.querySelector('.overflow-counter');\n    if (existingCounter) {\n      existingCounter.remove();\n    }\n    \n    if (allCards.length <= maxVisibleCards) {\n      // ã‚«ãƒ¼ãƒ‰ãŒ3å€‹ä»¥ä¸‹ã®å ´åˆã€ã™ã¹ã¦è¡¨ç¤º\n      allCards.forEach(card => {\n        card.style.display = 'flex';\n      });\n    } else {\n      // ã‚«ãƒ¼ãƒ‰ãŒ4å€‹ä»¥ä¸Šã®å ´åˆã€æœ€æ–°3å€‹ã®ã¿è¡¨ç¤ºã—ã€æ®‹ã‚Šã¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¡¨ç¤º\n      const visibleCards = allCards.slice(0, maxVisibleCards); // æœ€åˆã®3å€‹ï¼ˆæœ€æ–°ï¼‰\n      const hiddenCount = allCards.length - maxVisibleCards;\n      \n      // å¤ã„ã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤º\n      allCards.forEach((card, index) => {\n        if (index < maxVisibleCards) {\n          card.style.display = 'flex';\n        } else {\n          card.style.display = 'none';\n        }\n      });\n      \n      // ã€Œ+ Nã€ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ä½œæˆ\n      const counter = document.createElement('div');\n      counter.className = 'overflow-counter';\n      // ãƒ†ãƒ¼ãƒã«å¿œã˜ãŸã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«\n      const counterBaseColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.12)';\n      const counterBorderColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.15)';\n      const counterTextColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.6)';\n      \n      counter.style.cssText = `\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 8px 12px;\n        margin: 4px 0;\n        background: ${counterBaseColor};\n        backdrop-filter: blur(20px);\n        border-radius: 12px;\n        border: 1px solid ${counterBorderColor};\n        font-size: 12px;\n        color: ${counterTextColor};\n        font-weight: 500;\n        min-height: 32px;\n        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n        cursor: pointer;\n      `;\n      counter.innerHTML = `+ ${hiddenCount}`;\n      \n      // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æœ€å¾Œã«æŒ¿å…¥ï¼ˆæœ€ä¸‹éƒ¨ã«é…ç½®ï¼‰\n      this.floatingContainer.appendChild(counter);\n      \n      // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®ãƒ›ãƒãƒ¼åŠ¹æœï¼ˆãƒ†ãƒ¼ãƒå¯¾å¿œï¼‰\n      const counterHoverColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.12)' : 'rgba(0, 0, 0, 0.18)';\n      \n      counter.addEventListener('mouseenter', () => {\n        counter.style.background = counterHoverColor;\n        counter.style.transform = 'scale(1.05)';\n      });\n      \n      counter.addEventListener('mouseleave', () => {\n        counter.style.background = counterBaseColor;\n        counter.style.transform = 'scale(1)';\n      });\n    }\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰ã«è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ \n   */\n  addCardDetailEvents(card, taskId) {\n    // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º\n    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;\n    \n    if (isTouchDevice) {\n      // ãƒ¢ãƒã‚¤ãƒ«/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ: ã‚¿ãƒƒãƒ—ã§è©³ç´°è¡¨ç¤º\n      card.addEventListener('click', (e) => {\n        e.preventDefault();\n        e.stopPropagation();\n        this.showTaskDetailModal(taskId);\n      });\n    } else {\n      // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: ãƒ›ãƒãƒ¼ã§è©³ç´°è¡¨ç¤º\n      let hoverTimeout;\n      \n      card.addEventListener('mouseenter', () => {\n        hoverTimeout = setTimeout(() => {\n          this.showTaskDetailModal(taskId);\n        }, 800); // 0.8ç§’ãƒ›ãƒãƒ¼ã§è¡¨ç¤º\n      });\n      \n      card.addEventListener('mouseleave', () => {\n        if (hoverTimeout) {\n          clearTimeout(hoverTimeout);\n        }\n      });\n      \n      // ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚è¡¨ç¤ºï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã‚‚ä½¿ã„ã‚„ã™ãï¼‰\n      card.addEventListener('click', (e) => {\n        e.preventDefault();\n        e.stopPropagation();\n        this.showTaskDetailModal(taskId);\n      });\n    }\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º\n   */\n  showTaskDetailModal(taskId) {\n    const taskData = this.taskCards.get(taskId);\n    if (!taskData) return;\n    \n    // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤\n    const existingModal = document.querySelector('.task-detail-modal');\n    if (existingModal) {\n      existingModal.remove();\n    }\n    \n    // ãƒ¢ãƒ¼ãƒ€ãƒ«ä½œæˆ\n    const modal = this.createTaskDetailModal(taskData);\n    document.body.appendChild(modal);\n    \n    // å…¥å ´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    requestAnimationFrame(() => {\n      modal.style.opacity = '1';\n      modal.querySelector('.modal-content').style.transform = 'translateY(0) scale(1)';\n    });\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®HTMLè¦ç´ ã‚’ä½œæˆ\n   */\n  createTaskDetailModal(taskData) {\n    const modal = document.createElement('div');\n    modal.className = 'task-detail-modal';\n    \n    // ãƒ†ãƒ¼ãƒã«å¿œã˜ãŸã‚¹ã‚¿ã‚¤ãƒ«\n    const overlayColor = this.isDarkMode ? 'rgba(0, 0, 0, 0.6)' : 'rgba(0, 0, 0, 0.4)';\n    const modalBg = this.isDarkMode ? 'rgba(20, 20, 20, 0.95)' : 'rgba(255, 255, 255, 0.95)';\n    const modalBorder = this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';\n    const textColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.9)' : 'rgba(0, 0, 0, 0.9)';\n    const labelColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.6)' : 'rgba(0, 0, 0, 0.6)';\n    \n    modal.style.cssText = `\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: ${overlayColor};\n      backdrop-filter: blur(10px);\n      z-index: 100000;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      transition: opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: pointer;\n    `;\n    \n    // å®Ÿè¡Œæ™‚é–“è¨ˆç®—\n    const duration = taskData.endTime \n      ? ((taskData.endTime - taskData.startTime) / 1000).toFixed(1)\n      : ((Date.now() - taskData.startTime) / 1000).toFixed(1);\n    \n    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º\n    const statusText = taskData.status === 'pending' ? 'å¾…æ©Ÿä¸­' \n                    : taskData.status === 'in-progress' ? 'å®Ÿè¡Œä¸­' \n                    : taskData.status === 'completed' ? 'å®Œäº†' \n                    : 'ã‚¨ãƒ©ãƒ¼';\n    \n    const modalContent = document.createElement('div');\n    modalContent.className = 'modal-content';\n    modalContent.style.cssText = `\n      background: ${modalBg};\n      backdrop-filter: blur(30px);\n      border: 1px solid ${modalBorder};\n      border-radius: 16px;\n      padding: 16px !important;\n      max-width: 400px;\n      width: 90%;\n      max-height: 80vh;\n      overflow-y: auto;\n      transform: translateY(20px) scale(0.95);\n      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: default;\n      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n    `;\n    \n    modalContent.innerHTML = `\n      <div style=\"display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;\">\n        <h3 style=\"margin: 0; color: ${textColor}; font-size: 18px; font-weight: 600;\">ã‚¿ã‚¹ã‚¯è©³ç´°</h3>\n        <button class=\"close-btn\" style=\"\n          background: none;\n          border: none;\n          font-size: 24px;\n          color: ${labelColor};\n          cursor: pointer;\n          padding: 0;\n          line-height: 1;\n          transition: color 0.2s;\n        \">Ã—</button>\n      </div>\n      \n      <div style=\"space-y: 16px;\">\n        <div>\n          <div style=\"color: ${labelColor}; font-size: 12px; font-weight: 500; margin-bottom: 0;\">ğŸ“ å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</div>\n          <div style=\"color: ${textColor}; font-size: 14px; line-height: 1.4;\">${taskData.originalPrompt}</div>\n        </div>\n        \n        <div>\n          <div style=\"color: ${labelColor}; font-size: 12px; font-weight: 500; margin-bottom: 0;\">ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>\n          <div style=\"color: ${textColor}; font-size: 14px;\">${statusText}</div>\n        </div>\n        \n        <div>\n          <div style=\"color: ${labelColor}; font-size: 12px; font-weight: 500; margin-bottom: 0;\">â±ï¸ å®Ÿè¡Œæ™‚é–“</div>\n          <div style=\"color: ${textColor}; font-size: 14px;\">${duration}ç§’</div>\n        </div>\n        \n        ${taskData.error ? `\n        <div>\n          <div style=\"color: ${labelColor}; font-size: 12px; font-weight: 500; margin-bottom: 0;\">âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°</div>\n          <div style=\"color: #ef4444; font-size: 14px; line-height: 1.4;\">${taskData.error}</div>\n        </div>\n        ` : ''}\n        \n        <div>\n          <div style=\"color: ${labelColor}; font-size: 12px; font-weight: 500; margin-bottom: 0;\">ğŸ¨ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—</div>\n          <div style=\"color: ${textColor}; font-size: 14px;\">${taskData.contentType || 'ç”»åƒ'}</div>\n        </div>\n      </div>\n    `;\n    \n    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼\n    modalContent.addEventListener('click', (e) => {\n      e.stopPropagation();\n    });\n    \n    const closeBtn = modalContent.querySelector('.close-btn');\n    closeBtn.addEventListener('click', () => {\n      this.closeTaskDetailModal(modal);\n    });\n    \n    closeBtn.addEventListener('mouseenter', () => {\n      closeBtn.style.color = textColor;\n    });\n    \n    closeBtn.addEventListener('mouseleave', () => {\n      closeBtn.style.color = labelColor;\n    });\n    \n    modal.addEventListener('click', () => {\n      this.closeTaskDetailModal(modal);\n    });\n    \n    modal.appendChild(modalContent);\n    return modal;\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹\n   */\n  closeTaskDetailModal(modal) {\n    modal.style.opacity = '0';\n    modal.querySelector('.modal-content').style.transform = 'translateY(20px) scale(0.95)';\n    \n    setTimeout(() => {\n      if (modal.parentNode) {\n        modal.parentNode.removeChild(modal);\n      }\n    }, 300);\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰å…¥å ´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ + iOS 26 Liquid Glassï¼‰\n   */\n  animateCardEntrance(card) {\n    // iOS 26 Liquid Glass å…¥å ´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ\n    card.style.transform = 'translateY(20px) scale(0.95)';\n    card.style.opacity = '0';\n    card.style.filter = 'blur(4px)';\n\n    requestAnimationFrame(() => {\n      card.style.transition = 'all 0.6s cubic-bezier(0.16, 1, 0.3, 1)';\n      card.style.transform = 'translateY(0) scale(1)';\n      card.style.opacity = '1';\n      card.style.filter = 'blur(0px)';\n\n      // 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: å¾®ç´°ãªå…‰ã‚‹åŠ¹æœ\n      card.style.boxShadow = '0 4px 20px rgba(255, 255, 255, 0.1), 0 0 40px rgba(255, 255, 255, 0.05)';\n    });\n  }\n\n  /**\n   * æˆåŠŸæ™‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ + è‡ªå‹•æ¶ˆå»ï¼ˆiOS 26 Liquid Glassï¼‰\n   */\n  animateCardSuccess(card, taskId) {\n    // iOS 26 Liquid Glass æˆåŠŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆ\n    card.style.transition = 'all 0.3s cubic-bezier(0.16, 1, 0.3, 1)';\n    card.style.borderColor = 'rgba(76, 175, 80, 0.6)';\n    card.style.transform = 'scale(1.08)';\n    card.style.boxShadow = '0 8px 32px rgba(76, 175, 80, 0.4), 0 0 60px rgba(76, 175, 80, 0.2)';\n    card.style.filter = 'brightness(1.1) saturate(1.2)';\n\n    // 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: æµä½“çš„ãªæˆ»ã‚Šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    setTimeout(() => {\n      card.style.transform = 'scale(1.02)';\n      card.style.filter = 'brightness(1.05) saturate(1.1)';\n    }, 150);\n\n    // Liquid Glassé¢¨ã®ã‚¹ãƒ ãƒ¼ã‚ºãªãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆ2ç§’å¾Œã«è‡ªå‹•å‰Šé™¤ï¼‰\n    setTimeout(() => {\n      this.animateCardExit(card, taskId);\n    }, 2000);\n  }\n\n  /**\n   * ã‚¨ãƒ©ãƒ¼æ™‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ UXï¼‰\n   */\n  animateCardError(card, taskId) {\n    // iOS 26 Liquid Glass ã‚¨ãƒ©ãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ\n    card.style.transition = 'all 0.3s cubic-bezier(0.16, 1, 0.3, 1)';\n    card.style.borderColor = 'rgba(244, 67, 54, 0.7)';\n    card.style.boxShadow = '0 8px 32px rgba(244, 67, 54, 0.3), 0 0 60px rgba(244, 67, 54, 0.15)';\n    card.style.filter = 'saturate(1.3) brightness(1.1)';\n\n    // 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: ã‚ˆã‚Šè‡ªç„¶ãªpulseã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆshakeã‚ˆã‚Šæ´—ç·´ï¼‰\n    card.style.animation = 'errorPulse 0.6s cubic-bezier(0.16, 1, 0.3, 1) 2';\n\n    // UXæ”¹å–„: ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’è¡¨ç¤ºã™ã‚‹ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—é¢¨UI\n    this.addErrorTooltip(card, taskId);\n\n    // ã‚¨ãƒ©ãƒ¼ã¯æ‰‹å‹•ã§æ¶ˆã™ã¾ã§è¡¨ç¤ºç¶™ç¶šï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ¶ˆå»ï¼‰\n    card.style.cursor = 'pointer';\n    card.onclick = () => this.animateCardExit(card, taskId);\n\n    // 5ç§’å¾Œã«è‡ªå‹•ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆUXæ”¹å–„ï¼‰\n    setTimeout(() => {\n      if (this.taskCards.has(taskId)) {\n        this.animateCardExit(card, taskId);\n      }\n    }, 5000);\n  }\n\n  /**\n   * ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºï¼ˆUXæ”¹å–„ï¼‰\n   */\n  addErrorTooltip(card, taskId) {\n    const taskData = this.taskCards.get(taskId);\n    if (!taskData || !taskData.error) return;\n\n    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¦ç´ ä½œæˆ\n    const tooltip = document.createElement('div');\n    tooltip.style.cssText = `\n      position: absolute;\n      bottom: 100%;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(244, 67, 54, 0.95);\n      color: white;\n      padding: 8px 12px;\n      border-radius: 8px;\n      font-size: 11px;\n      white-space: nowrap;\n      pointer-events: none;\n      z-index: 1001;\n      backdrop-filter: blur(10px);\n      margin-bottom: 0;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n    `;\n    tooltip.textContent = taskData.error;\n\n    card.style.position = 'relative';\n    card.appendChild(tooltip);\n\n    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³\n    requestAnimationFrame(() => {\n      tooltip.style.opacity = '1';\n    });\n\n    // 3ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ\n    setTimeout(() => {\n      if (tooltip.parentNode) {\n        tooltip.style.opacity = '0';\n        setTimeout(() => {\n          if (tooltip.parentNode) {\n            tooltip.parentNode.removeChild(tooltip);\n          }\n        }, 300);\n      }\n    }, 3000);\n  }\n\n  /**\n   * ã‚«ãƒ¼ãƒ‰é€€å ´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ + iOS 26 Liquid Glassï¼‰\n   */\n  animateCardExit(card, taskId) {\n    // iOS 26 Liquid Glass é€€å ´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ - 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ã®ã€Œã‚¹ãƒƒã¨æ¶ˆãˆã‚‹ã€\n    card.style.transition = 'all 0.28s cubic-bezier(0.4, 0, 0.2, 1)';\n    card.style.transform = 'translateY(-12px) scale(0.92)';\n    card.style.opacity = '0';\n    card.style.filter = 'blur(6px) brightness(1.2)';\n\n    // 2026å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: æ¶ˆå»æ™‚ã®å¾®ç´°ãªå…‰ã®æ‹¡æ•£åŠ¹æœ\n    card.style.boxShadow = '0 0 40px rgba(255, 255, 255, 0.3), 0 0 80px rgba(255, 255, 255, 0.1)';\n\n    setTimeout(() => {\n      if (card.parentNode) {\n        card.parentNode.removeChild(card);\n      }\n      this.taskCards.delete(taskId);\n      // ã‚«ãƒ¼ãƒ‰å‰Šé™¤å¾Œã«è¡¨ç¤ºåˆ¶é™ã‚’å†é©ç”¨\n      this.updateCardDisplayLimit();\n    }, 280);\n  }\n\n  /**\n   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡¨ç¾ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è‡ªç„¶ã«æ„ŸçŸ¥\n   */\n  getResponseType(prompt) {\n    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡¨ç¾ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è‡ªç„¶ã«æ„ŸçŸ¥\n    if (/ã¡ã‚‡ã“ã£ã¨|ã¡ã‚‡ã“ã‚“|å°‘ã—|è»½ã/.test(prompt) || prompt.length < 15) {\n      return 'casual';\n    }\n    if (/ç¾ã—ã„|å¹»æƒ³|ç´ æ•µ|é­”æ³•|ä¸–ç•Œ|ç¶ºéº—/.test(prompt)) {\n      return 'magical';\n    }\n    return 'balanced'; // 80%ãŒã“ã“ã«è©²å½“\n  }\n\n  /**\n   * æ¸©ã‹ã¿ã®ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆï¼ˆãƒãƒ¼ã‚±ææ¡ˆãƒ™ãƒ¼ã‚¹ï¼‰\n   */\n  getFriendlyMessage(status, prompt, errorMessage = null) {\n    const shortPrompt = prompt.length > 15 ? prompt.substring(0, 15) + '...' : prompt;\n\n    // è‡ªç„¶ãªå¿œç­”ã‚·ã‚¹ãƒ†ãƒ é©ç”¨\n    const responseType = this.getResponseType(prompt);\n\n    switch (status) {\n      case 'pending':\n        return responseType === 'casual' ? 'ã¡ã‚‡ã“ã£ã¨æº–å‚™ä¸­ã§ã™...' :\n               responseType === 'magical' ? 'é­”æ³•ã‚’ã‹ã‘ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...' :\n               'ã¡ã‚‡ã“ã£ã¨é­”æ³•ã®æº–å‚™ä¸­...';\n      case 'processing':\n      case 'in-progress':\n      case 'progress':\n        // Modify mode specific messages for processing\n        if (this.currentMode === 'modify') {\n          return responseType === 'casual' ? 'ã¡ã‚‡ã“ã£ã¨èª¿æ•´ä¸­ã§ã™...' :\n                 responseType === 'magical' ? 'ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å¤‰åŒ–ã•ã›ã¦ã„ã¾ã™...' :\n                 'ã¡ã‚‡ã“ã‚“ã¨ç·¨é›†ä¸­ã§ã™...';\n        }\n        return responseType === 'casual' ? 'ã¡ã‚‡ã“ã‚“ã¨é…ç½®ä¸­ã§ã™...' :\n               responseType === 'magical' ? 'ã‚ãªãŸã®æƒ³ã„ã‚’å½¢ã«ã—ã¦ã„ã¾ã™...' :\n               'ã¡ã‚‡ã“ã£ã¨é­”æ³•ã‚’ã‹ã‘ã¦ã„ã¾ã™...';\n      case 'completed':\n        // Delete mode specific messages\n        if (this.currentMode === 'delete') {\n          return responseType === 'casual' ? 'ã¡ã‚‡ã“ã£ã¨å‰Šé™¤ã—ã¾ã—ãŸï¼' :\n                 responseType === 'magical' ? 'ã™ã£ãã‚Šã¨ç‰‡ä»˜ãã¾ã—ãŸï¼' :\n                 'ã¡ã‚‡ã“ã‚“ã¨å‰Šé™¤å®Œäº†ï¼ã™ã£ãã‚Šã§ã™ã­ï¼';\n        }\n        // Modify mode specific messages\n        if (this.currentMode === 'modify') {\n          return responseType === 'casual' ? 'ã¡ã‚‡ã“ã£ã¨èª¿æ•´ã—ã¾ã—ãŸï¼' :\n                 responseType === 'magical' ? 'ç´ æ•µã«å¤‰èº«ã—ã¾ã—ãŸï¼' :\n                 'ã¡ã‚‡ã“ã‚“ã¨ç·¨é›†å®Œäº†ï¼ã„ã„æ„Ÿã˜ã§ã™ã­ï¼';\n        }\n        // Default completion messages for other modes\n        return responseType === 'casual' ? 'ã¡ã‚‡ã“ã£ã¨ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã—ãŸï¼' :\n               responseType === 'magical' ? 'ç´ æ•µãªä¸–ç•ŒãŒå®Œæˆã—ã¾ã—ãŸï¼' :\n               'ã¡ã‚‡ã“ã‚“ã¨é…ç½®å®Œäº†ï¼ç´ æ•µã§ã™ã­ï¼';\n      case 'error':\n        // ã‚¨ãƒ©ãƒ¼ç†ç”±ãŒã‚ã‚Œã°å«ã‚ã‚‹\n        if (errorMessage) {\n          const shortError = errorMessage.length > 30 ? errorMessage.substring(0, 30) + '...' : errorMessage;\n          return `âŒ ${shortError}`;\n        }\n        return responseType === 'casual' ? 'ãŠã£ã¨ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' :\n               responseType === 'magical' ? 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ' :\n               'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„';\n      default:\n        return shortPrompt;\n    }\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰²å–å¾—\n   */\n  getStatusColor(status) {\n    // ãƒã‚ªãƒ³ãƒ‘ãƒ¼ãƒ—ãƒ«/ãƒ”ãƒ³ã‚¯ç³»ã§çµ±ä¸€ï¼ˆ2025ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰\n    const colors = {\n      pending: this.isDarkMode ? '#a78bfa' : '#7c3aed',        // è–„ç´«\n      processing: this.isDarkMode ? '#c084fc' : '#9333ea',     // ç´«ï¼ˆç”Ÿæˆä¸­ï¼‰\n      progress: this.isDarkMode ? '#ec4899' : '#be185d',       // ãƒ”ãƒ³ã‚¯\n      completed: this.isDarkMode ? '#a78bfa' : '#7c3aed',      // ç´«ï¼ˆå®Œäº†ã‚‚çµ±ä¸€ï¼‰\n      error: this.isDarkMode ? '#f87171' : '#dc2626'           // èµ¤ï¼ˆã‚¨ãƒ©ãƒ¼ã®ã¿ï¼‰\n    };\n    return colors[status] || colors.pending;\n  }\n\n  /**\n   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ä½œæˆï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤ºãªã—ï¼‰\n   */\n  createStatusIndicator(status) {\n    if (status === 'processing' || status === 'progress') {\n      return `\n        <div class=\"status-indicator\" style=\"\n          background: ${this.isDarkMode ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.08)'};\n          border-radius: 8px;\n          height: 4px;\n          overflow: hidden;\n          margin-top: 8px;\n          position: relative;\n        \">\n          <div class=\"status-pulse\" style=\"\n            background: linear-gradient(90deg, transparent, ${this.isWabiSabiMode ? '#8BC34A, #689F38' : '#6366f1, #8b5cf6'}, transparent);\n            height: 100%;\n            width: 30%;\n            border-radius: 8px;\n            animation: statusPulse 1.8s ease-in-out infinite;\n          \"></div>\n        </div>\n        <div style=\"display: flex; align-items: center; gap: 4px; margin-top: 8px;\">\n          <div class=\"status-dots\" style=\"font-size: 10px; color: ${this.isDarkMode ? '#c084fc' : '#9333ea'};\">\n            å‡¦ç†ä¸­<span style=\"animation: dots 1.5s infinite;\">...</span>\n          </div>\n        </div>\n      `;\n    }\n    return '';\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯å®Œäº†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n   */\n  animateTaskCompletion(card) {\n    // æ§ãˆã‚ãªã‚µã‚¯ã‚»ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    card.style.animation = 'taskComplete 0.8s ease-out';\n\n    // å¾®å¦™ãªãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«åŠ¹æœã‚’è¿½åŠ ï¼ˆæ§ãˆã‚ï¼‰\n    this.addSubtleParticleEffect(card);\n\n    setTimeout(() => {\n      card.style.animation = '';\n    }, 800);\n\n    this.ensureTaskAnimations();\n  }\n\n  /**\n   * æ§ãˆã‚ãªãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«åŠ¹æœ\n   */\n  addSubtleParticleEffect(card) {\n    const particles = 3; // å°‘ãªã„æ•°ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«\n    const rect = card.getBoundingClientRect();\n\n    for (let i = 0; i < particles; i++) {\n      const particle = document.createElement('div');\n      particle.style.cssText = `\n        position: fixed;\n        width: 4px;\n        height: 4px;\n        background: linear-gradient(45deg, #a78bfa, #c084fc);\n        border-radius: 50%;\n        pointer-events: none;\n        z-index: 9999;\n        left: ${rect.right - 20}px;\n        top: ${rect.top + 10}px;\n        opacity: 0.8;\n        transform: scale(0);\n        animation: subtleParticle 1.2s ease-out forwards;\n      `;\n\n      // ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ã«å°‘ã—ç§»å‹•\n      const angle = (i / particles) * Math.PI * 2;\n      const distance = 15; // æ§ãˆã‚ãªè·é›¢\n      particle.style.setProperty('--move-x', `${Math.cos(angle) * distance}px`);\n      particle.style.setProperty('--move-y', `${Math.sin(angle) * distance}px`);\n\n      document.body.appendChild(particle);\n\n      // è‡ªå‹•å‰Šé™¤\n      setTimeout(() => particle.remove(), 1200);\n    }\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨CSSç¢ºä¿\n   */\n  ensureTaskAnimations() {\n    if (document.getElementById('task-animations')) return;\n\n    const style = document.createElement('style');\n    style.id = 'task-animations';\n    style.textContent = `\n      @keyframes slideInUp {\n        from { opacity: 0; transform: translateY(20px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n\n      @keyframes taskComplete {\n        0% {\n          transform: scale(1);\n          border-left-color: rgba(192, 132, 252, 0.5);\n        }\n        30% {\n          transform: scale(1.01);\n          background: rgba(167, 139, 250, 0.08);\n          border-left-color: rgba(167, 139, 250, 0.6);\n        }\n        60% {\n          background: rgba(167, 139, 250, 0.05);\n        }\n        100% {\n          transform: scale(1);\n          background: rgba(167, 139, 250, 0.02);\n          border-left-color: rgba(167, 139, 250, 0.4);\n        }\n      }\n\n      @keyframes subtleParticle {\n        0% {\n          transform: scale(0) translate(0, 0);\n          opacity: 0.8;\n        }\n        20% {\n          transform: scale(1) translate(0, 0);\n          opacity: 1;\n        }\n        100% {\n          transform: scale(0.3) translate(var(--move-x, 0), var(--move-y, 0));\n          opacity: 0;\n        }\n      }\n\n      @keyframes shimmer {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(100%); }\n      }\n\n      @keyframes slideIn {\n        from { opacity: 0; transform: translateX(-20px); }\n        to { opacity: 1; transform: translateX(0); }\n      }\n\n      @keyframes statusPulse {\n        0% { transform: translateX(-100%); }\n        50% { transform: translateX(300%); }\n        100% { transform: translateX(-100%); }\n      }\n\n      @keyframes dots {\n        0%, 20% { opacity: 0; }\n        50% { opacity: 1; }\n        100% { opacity: 0; }\n      }\n\n      @keyframes errorPulse {\n        0% {\n          transform: scale(1);\n          filter: saturate(1.3) brightness(1.1);\n        }\n        50% {\n          transform: scale(1.03);\n          filter: saturate(1.5) brightness(1.2);\n          box-shadow: 0 12px 40px rgba(244, 67, 54, 0.4), 0 0 80px rgba(244, 67, 54, 0.2);\n        }\n        100% {\n          transform: scale(1);\n          filter: saturate(1.3) brightness(1.1);\n        }\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  /**\n   * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ä»˜ãã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰\n   */\n  addTaskStatus(message, percent = 0, taskId = null) {\n    const id = taskId || `task_${Date.now()}`;\n    return this.addTaskCard(message, {\n      percent: Math.min(Math.max(percent, 0), 100),\n      taskId: id,\n      status: percent > 0 ? 'progress' : 'pending'\n    });\n  }\n\n  /**\n   * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°\n   */\n  updateTaskProgress(taskId, percent, newMessage = null) {\n    const existingTask = this.output.querySelector(`[data-task-id=\"${taskId}\"]`);\n    if (existingTask && newMessage) {\n      // æ—¢å­˜ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°\n      this.addOutput(newMessage, 'progress', { \n        percent: Math.min(Math.max(percent, 0), 100),\n        taskId\n      });\n    }\n  }\n\n  /**\n   * ã‚¿ã‚¹ã‚¯å®Œäº†ï¼ˆãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼å‰Šé™¤ï¼‰\n   */\n  completeTask(taskId) {\n    const existingTask = this.output.querySelector(`[data-task-id=\"${taskId}\"]`);\n    if (existingTask) {\n      // å®Œäº†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n      existingTask.style.transition = 'opacity 0.5s ease, transform 0.5s ease';\n      existingTask.style.opacity = '0';\n      existingTask.style.transform = 'translateX(20px)';\n      \n      setTimeout(() => {\n        if (existingTask.parentNode) {\n          existingTask.remove();\n        }\n      }, 500);\n    }\n  }\n\n  /**\n   * SSEæ¥ç¶šé–‹å§‹ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—å—ä¿¡ï¼‰\n   */\n  connectToProgress(serverTaskId, uiTaskId = null) {\n    if (this.activeConnections.has(serverTaskId)) {\n      return;\n    }\n\n    const eventSource = new EventSource(`/api/progress/${serverTaskId}`);\n    this.activeConnections.set(serverTaskId, eventSource);\n\n    eventSource.onmessage = (event) => {\n      try {\n        const data = JSON.parse(event.data);\n        data.uiTaskId = uiTaskId; // UIç”¨ã‚¿ã‚¹ã‚¯IDã‚’è¿½åŠ \n        this.handleProgressUpdate(data);\n      } catch (error) {\n        console.error('SSE data parse error:', error);\n      }\n    };\n\n    eventSource.onerror = (error) => {\n      console.error('SSE connection error:', error);\n      this.disconnectProgress(serverTaskId);\n    };\n  }\n\n  /**\n   * é€²æ—æ›´æ–°å‡¦ç†\n   */\n  handleProgressUpdate(data) {\n    switch (data.type) {\n      case 'connected':\n        this.logDebug(`ğŸ”— Connected to progress stream: ${data.taskId}`);\n        break;\n\n      case 'progress':\n        if (data.percent !== undefined && data.uiTaskId) {\n          this.updateTaskCard(data.uiTaskId, 'progress', { percent: data.percent });\n        }\n        break;\n\n      case 'completed':\n        if (data.uiTaskId) {\n          this.updateTaskCard(data.uiTaskId, 'completed');\n        }\n        this.disconnectProgress(data.taskId);\n        break;\n\n      case 'error':\n        if (data.uiTaskId) {\n          this.updateTaskCard(data.uiTaskId, 'error', { errorMessage: data.message });\n        }\n        this.addOutput(`âŒ ${data.message}`, 'error');\n        this.disconnectProgress(data.taskId);\n        break;\n    }\n  }\n\n  /**\n   * SSEæ¥ç¶šçµ‚äº†\n   */\n  disconnectProgress(taskId) {\n    const connection = this.activeConnections.get(taskId);\n    if (connection) {\n      connection.close();\n      this.activeConnections.delete(taskId);\n    }\n  }\n\n  /**\n   * å‡ºåŠ›ã‚¨ãƒªã‚¢ã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«\n   */\n  scrollToBottom() {\n    if (this.outputDiv) {\n      this.outputDiv.scrollTop = this.outputDiv.scrollHeight;\n    }\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ‰åˆ¥ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹\n   */\n  getModePrefix(mode) {\n    // ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ¢ãƒ¼ãƒ‰ã‚’åŒºåˆ¥ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹\n    const prefixes = {\n      generate: '', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰\n      modify: '[å¤‰æ›´] ',\n      delete: '[å‰Šé™¤] '\n    };\n    return prefixes[mode] || '';\n  }\n\n  /**\n   * ã‚³ãƒãƒ³ãƒ‰ä¿å­˜ (Undo/Redoã‚·ã‚¹ãƒ†ãƒ )\n   */\n  saveCommandToHistory(commandData) {\n    // ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä»¥é™ã®å±¥æ­´ã‚’å‰Šé™¤ï¼ˆæ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸãŸã‚ï¼‰\n    this.commandHistory = this.commandHistory.slice(0, this.currentHistoryIndex + 1);\n    \n    // æ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰ã‚’å±¥æ­´ã«è¿½åŠ \n    this.commandHistory.push(commandData);\n    this.currentHistoryIndex = this.commandHistory.length - 1;\n    \n    // æœ€å¤§ã‚³ãƒãƒ³ãƒ‰ä¿å­˜æ•°ã‚’è¶…ãˆãŸå ´åˆã€å¤ã„ã‚³ãƒãƒ³ãƒ‰ã‚’å‰Šé™¤\n    if (this.commandHistory.length > this.maxHistorySize) {\n      this.commandHistory.shift();\n      this.currentHistoryIndex--;\n    }\n    \n    // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°\n    this.updateUndoRedoButtons();\n  }\n\n  /**\n   * Undoå®Ÿè¡Œ\n   */\n  undo() {\n    if (!this.canUndo()) {\n      this.addOutput('â†¶ Undoã§ãã‚‹æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“', 'hint');\n      return;\n    }\n    \n    const command = this.commandHistory[this.currentHistoryIndex];\n    this.currentHistoryIndex--;\n    \n    // Undoã®é€†æ“ä½œã‚’å®Ÿè¡Œï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰\n    if (command.mode === 'generate') {\n      this.addOutput(`â†¶ Undo: \"${command.command}\" ã®ç”Ÿæˆã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ`, 'system');\n      // å®Ÿéš›ã®ã‚·ãƒ¼ãƒ³ç®¡ç†ã§ã¯æœ€å¾Œã«ä½œæˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤\n      if (this.sceneManager && this.sceneManager.undoLastGenerate) {\n        this.sceneManager.undoLastGenerate();\n      }\n    } else if (command.mode === 'modify') {\n      this.addOutput(`â†¶ Undo: \"${command.command}\" ã®å¤‰æ›´ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ`, 'system');\n      // å®Ÿéš›ã®ã‚·ãƒ¼ãƒ³ç®¡ç†ã§ã¯å‰ã®çŠ¶æ…‹ã«æˆ»ã™\n      if (this.sceneManager && this.sceneManager.undoLastModify) {\n        this.sceneManager.undoLastModify();\n      }\n    } else if (command.mode === 'delete') {\n      this.addOutput(`â†¶ Undo: \"${command.command}\" ã®å‰Šé™¤ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ`, 'system');\n      // å®Ÿéš›ã®ã‚·ãƒ¼ãƒ³ç®¡ç†ã§ã¯å‰Šé™¤ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¾©å…ƒ\n      if (this.sceneManager && this.sceneManager.undoLastDelete) {\n        this.sceneManager.undoLastDelete();\n      }\n    }\n    \n    this.updateUndoRedoButtons();\n  }\n\n  /**\n   * Redoå®Ÿè¡Œ\n   */\n  redo() {\n    if (!this.canRedo()) {\n      this.addOutput('â†· Redoã§ãã‚‹æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“', 'hint');\n      return;\n    }\n    \n    this.currentHistoryIndex++;\n    const command = this.commandHistory[this.currentHistoryIndex];\n    \n    // Redoã§ã‚³ãƒãƒ³ãƒ‰ã‚’å†å®Ÿè¡Œ\n    this.addOutput(`â†· Redo: \"${command.command}\" ã‚’å†å®Ÿè¡Œã—ã¾ã—ãŸ`, 'system');\n    \n    // å®Ÿéš›ã®ã‚·ãƒ¼ãƒ³ç®¡ç†ã§ã®Redoå‡¦ç†\n    if (this.sceneManager && this.sceneManager.redoCommand) {\n      this.sceneManager.redoCommand(command);\n    }\n    \n    this.updateUndoRedoButtons();\n  }\n\n  /**\n   * UndoãŒå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯\n   */\n  canUndo() {\n    return this.currentHistoryIndex >= 0;\n  }\n\n  /**\n   * RedoãŒå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯\n   */\n  canRedo() {\n    return this.currentHistoryIndex < this.commandHistory.length - 1;\n  }\n\n  /**\n   * Undo/Redoãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°\n   */\n  updateUndoRedoButtons() {\n    if (this.undoBtn) {\n      this.undoBtn.disabled = !this.canUndo();\n      this.undoBtn.style.opacity = this.canUndo() ? '1' : '0.4';\n      this.undoBtn.style.cursor = this.canUndo() ? 'pointer' : 'not-allowed';\n    }\n    \n    if (this.redoBtn) {\n      this.redoBtn.disabled = !this.canRedo();\n      this.redoBtn.style.opacity = this.canRedo() ? '1' : '0.4';\n      this.redoBtn.style.cursor = this.canRedo() ? 'pointer' : 'not-allowed';\n    }\n  }\n\n  /**\n   * ç¢ºèªä»˜ãå…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤\n   */\n  async clearAllWithConfirmation() {\n    const confirmed = await this.showClearAllConfirmation();\n    if (confirmed) {\n      this.clearAll();\n    }\n  }\n\n  /**\n   * Clear Allç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°\n   */\n  async showClearAllConfirmation() {\n    return this.showConfirmationDialog({\n      icon: 'ğŸ§¹',\n      title: 'Clear All ã®ç¢ºèª',\n      message: 'ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚',\n      confirmText: 'Clear All å®Ÿè¡Œ',\n      cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',\n      confirmColor: this.isWabiSabiMode ? '#8BC34A' : '#6366f1'\n    });\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n   */\n  closeModalWithAnimation(modal) {\n    const dialog = modal.querySelector('div:last-child');\n    dialog.style.transform = 'scale(0.9)';\n    dialog.style.opacity = '0';\n    modal.style.opacity = '0';\n    \n    setTimeout(() => {\n      if (modal.parentElement) {\n        document.body.removeChild(modal);\n      }\n    }, 200);\n  }\n\n  /**\n   * å…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤\n   */\n  clearAll() {\n    if (this.sceneManager) {\n      this.sceneManager.clearAll();\n      this.addOutput('ğŸ§¹ å…¨ã¦ã®å®Ÿé¨“ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'system');\n    } else if (this.client) {\n      // ã‚µãƒ¼ãƒãƒ¼å´ã§ã®å‰Šé™¤ã¯æœªå®Ÿè£…\n      this.addOutput('âš ï¸ ã‚µãƒ¼ãƒãƒ¼å´å‰Šé™¤ã¯æœªå®Ÿè£…', 'error');\n    }\n  }\n\n  // showHistory() ãƒ¡ã‚½ãƒƒãƒ‰å®Œå…¨å‰Šé™¤æ¸ˆã¿\n\n  /**\n   * åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ä¾‹ã‚’è¡¨ç¤º\n   */\n  showExamples() {\n    const examples = [\n      'å³ä¸Šã«ãƒ‰ãƒ©ã‚´ãƒ³ã‚’ä½œã£ã¦',\n      'ä¸­å¤®ã«å¤§ããªãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³ã‚’ç”Ÿæˆ',\n      'å·¦ä¸‹ã«å°ã•ãªæ¡œã‚’ä½œã£ã¦',\n      'ç©ºã«é³³å‡°ã‚’ä½œã£ã¦',\n      'åœ°é¢ã«ç¥ç¤¾ã‚’ä½œã£ã¦'\n    ];\n\n    this.addOutput('ğŸ’¡ ã‚³ãƒãƒ³ãƒ‰ä¾‹:', 'system');\n    examples.forEach(example => {\n      this.addOutput(`   \"${example}\"`, 'hint');\n    });\n  }\n\n  /**\n   * SceneManagerè¨­å®š\n   */\n  setSceneManager(sceneManager) {\n    this.sceneManager = sceneManager;\n    this.applyServiceSelectionToSceneManager();\n  }\n\n  /**\n   * Clientè¨­å®š\n   */\n  setClient(client) {\n    this.client = client;\n  }\n\n  /**\n   * è¨­å®šæ›´æ–°\n   */\n  updateConfig(newConfig) {\n    this.config = { ...this.config, ...newConfig };\n    // å¿…è¦ã«å¿œã˜ã¦UIã‚’æ›´æ–°\n    if (newConfig.activationKey) {\n      // æ–°ã—ã„ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã‚’åæ˜ ã™ã‚‹ãŸã‚ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š\n      this.bindEvents();\n    }\n  }\n\n  /**\n   * ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n   */\n  /**\n   * ã‚¹ã‚¿ã‚¤ãƒ«å†é©ç”¨\n   */\n  refreshStyles() {\n    // Generateãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å†é©ç”¨\n    const generateBtn = this.container?.querySelector('[data-mode=\"generate\"]');\n    if (generateBtn) {\n      generateBtn.style.cssText = this.getModeButtonStyles(true, 'generate');\n    }\n\n    // Executeãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å†é©ç”¨\n    const executeBtn = this.container?.querySelector('#execute-btn');\n    if (executeBtn) {\n      executeBtn.style.cssText = this.getModernButtonStyles('primary');\n    }\n\n    // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°\n    if (this.serviceModal) {\n      this.updateServiceModalStyles();\n    }\n\n    // ã‚µãƒ¼ãƒ“ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒæ›´æ–°\n    this.updateServiceSelectorTheme();\n  }\n\n  updateServiceModalStyles() {\n    if (!this.serviceModal) return;\n\n    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã¨ãƒœãƒ¼ãƒ€ãƒ¼ã‚’æ›´æ–°ï¼ˆæ¯å±±æ°´ã®é™å¯‚ï¼‰\n    this.serviceModal.style.background = this.isWabiSabiMode\n      ? 'linear-gradient(135deg, rgba(158, 158, 158, 0.4), rgba(189, 189, 189, 0.35))'\n      : (this.isDarkMode\n        ? 'linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(30, 27, 75, 0.8))'\n        : 'linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3))');\n\n    this.serviceModal.style.border = this.isWabiSabiMode\n      ? '1px solid rgba(141, 110, 99, 0.4)'\n      : (this.isDarkMode\n        ? '1px solid rgba(99, 102, 241, 0.3)'\n        : '1px solid rgba(255, 255, 255, 0.5)');\n\n    this.serviceModal.style.color = this.isWabiSabiMode\n      ? '#424242'\n      : (this.isDarkMode ? '#ffffff' : '#1f2937');\n\n    this.serviceModal.style.boxShadow = this.isWabiSabiMode\n      ? '0 20px 40px rgba(93, 64, 55, 0.35)'\n      : '0 20px 40px rgba(15, 23, 42, 0.35)';\n  }\n\n  /**\n   * ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ\n   */\n  toggleTheme() {\n    // 3æ®µéšã‚µã‚¤ã‚¯ãƒ«: light â†’ dark â†’ wabisabi â†’ light\n    switch (this.currentTheme) {\n      case 'light':\n        this.currentTheme = 'dark';\n        break;\n      case 'dark':\n        this.currentTheme = 'wabisabi';\n        break;\n      case 'wabisabi':\n        this.currentTheme = 'light';\n        break;\n      default:\n        this.currentTheme = 'light';\n    }\n\n    // çŠ¶æ…‹æ›´æ–°\n    this.isDarkMode = this.currentTheme === 'dark';\n    this.isWabiSabiMode = this.currentTheme === 'wabisabi';\n    localStorage.setItem('live-command-theme', this.currentTheme);\n\n    // ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³æ›´æ–°\n    if (this.themeToggle) {\n      const themeConfig = {\n        light: { icon: 'ğŸŒ™', title: 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' },\n        dark: { icon: 'ğŸµ', title: 'ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' },\n        wabisabi: { icon: 'â˜€ï¸', title: 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' }\n      };\n\n      const config = themeConfig[this.currentTheme];\n      // å¤ªé™½ã¯é»„è‰²ãã€ãŠèŒ¶ã¯ç·‘ç³»ã€æœˆã¯ç´«ç³»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼\n      if (config.icon === 'â˜€ï¸') {\n        this.themeToggle.innerHTML = `<span style=\"filter: saturate(1.2) brightness(1.1);\">${config.icon}</span>`;\n      } else if (config.icon === 'ğŸµ') {\n        this.themeToggle.innerHTML = `<span style=\"filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);\">${config.icon}</span>`;\n      } else {\n        this.themeToggle.innerHTML = `<span style=\"filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);\">${config.icon}</span>`;\n      }\n      this.themeToggle.title = config.title;\n    }\n\n    // å…¨ã‚¹ã‚¿ã‚¤ãƒ«å†é©ç”¨\n    this.applyTheme();\n\n    // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆå®Œäº†ï¼ˆå±¥æ­´ã«ã¯å‡ºåŠ›ã—ãªã„ï¼‰\n  }\n\n  /**\n   * ãƒ†ãƒ¼ãƒé©ç”¨\n   */\n  applyTheme() {\n    // ãƒœãƒ‡ã‚£ã«ãƒ†ãƒ¼ãƒã‚¯ãƒ©ã‚¹ã‚’è¨­å®š\n    document.body.className = this.isWabiSabiMode ? 'wabisabi-mode' : (this.isDarkMode ? 'dark-mode' : 'light-mode');\n\n    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠï¼ˆdisplayçŠ¶æ…‹ã‚’ä¿æŒï¼‰\n    const currentDisplay = this.container.style.display;\n    const currentFlexDirection = this.container.style.flexDirection;\n    this.container.style.cssText = this.getContainerStyles();\n    this.container.style.display = currentDisplay || 'flex';\n    this.container.style.flexDirection = currentFlexDirection || 'column';\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ–ãƒ©ãƒ³ãƒ‰ãƒãƒƒã‚¸ã®ãƒ†ãƒ¼ãƒå†é©ç”¨\n    const brandBadge = this.container.querySelector('.floating-brand-badge');\n    if (brandBadge) {\n      brandBadge.style.background = this.isDarkMode \n        ? 'linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.7))'\n        : 'linear-gradient(135deg, rgba(99, 102, 241, 0.9), rgba(139, 92, 246, 0.8))';\n      brandBadge.style.border = `1px solid ${this.isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.4)'}`;\n    }\n\n    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰\n    const hadHighlight = !!this.highlightOverlay;\n    this.inputDefaultStyles = null;\n    this.clearKeywordHighlighting();\n    this.input.style.cssText = this.getInputStyles();\n    this.captureInputDefaultStyles();\n    if (hadHighlight || (this.input && this.input.value.trim())) {\n      this.applyKeywordHighlighting();\n    }\n\n    // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨\n    this.output.style.cssText = this.getOutputStyles();\n\n    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®2025å¹´ä»•æ§˜ãƒ†ãƒ¼ãƒå†é©ç”¨\n    if (this.radioModeContainer) {\n      this.radioModeContainer.style.background = this.isWabiSabiMode\n        ? 'linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))'\n        : (this.isDarkMode\n          ? 'linear-gradient(135deg, rgba(30, 27, 75, 0.3), rgba(15, 23, 42, 0.4))'\n          : 'linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1))');\n      this.radioModeContainer.style.borderColor = this.isWabiSabiMode\n        ? 'rgba(93, 64, 55, 0.4)'\n        : (this.isDarkMode\n          ? 'rgba(99, 102, 241, 0.15)'\n          : 'rgba(255, 255, 255, 0.25)');\n\n      // å„ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°\n      Object.keys(this.radioModeButtons).forEach(key => {\n        const { button } = this.radioModeButtons[key];\n        if (this.currentMode !== key) {\n          button.style.color = this.isWabiSabiMode\n            ? 'rgba(245, 245, 245, 0.8)'\n            : (this.isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(55, 65, 81, 0.8)');\n          button.style.background = 'transparent';\n          button.style.border = '1px solid transparent';\n          button.style.boxShadow = 'none';\n        }\n      });\n\n      // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚æ›´æ–°\n      this.selectMode(this.currentMode, false);\n    }\n\n    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ãƒ†ãƒ¼ãƒå†é©ç”¨\n    if (this.clearBtn) {\n      this.clearBtn.style.cssText = this.getActionButtonStyles('secondary');\n    }\n    if (this.historyBtn) {\n      this.historyBtn.style.cssText = this.getActionButtonStyles('secondary');\n      this.historyBtn.style.opacity = '0.5';\n    }\n    if (this.themeToggle) {\n      const themeConfig = {\n        light: { icon: 'ğŸŒ™', title: 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' },\n        dark: { icon: 'ğŸµ', title: 'ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' },\n        wabisabi: { icon: 'â˜€ï¸', title: 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' }\n      };\n      const config = themeConfig[this.currentTheme] || themeConfig.light;\n      // å¤ªé™½ã¯é»„è‰²ãã€ãŠèŒ¶ã¯ç·‘ç³»ã€æœˆã¯ç´«ç³»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼\n      if (config.icon === 'â˜€ï¸') {\n        this.themeToggle.innerHTML = `<span style=\"filter: saturate(1.2) brightness(1.1);\">${config.icon}</span>`;\n      } else if (config.icon === 'ğŸµ') {\n        this.themeToggle.innerHTML = `<span style=\"filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);\">${config.icon}</span>`;\n      } else {\n        this.themeToggle.innerHTML = `<span style=\"filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);\">${config.icon}</span>`;\n      }\n      this.themeToggle.title = config.title;\n      this.themeToggle.style.cssText = this.getActionButtonStyles('icon');\n    }\n    if (this.settingsButton) {\n      this.settingsButton.style.cssText = this.getActionButtonStyles('icon');\n    }\n\n    this.updateServiceSelectorTheme();\n\n    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ãƒ†ãƒ¼ãƒæ›´æ–°\n    const closeButton = this.container.querySelector('.close-button');\n    if (closeButton) {\n      closeButton.style.color = this.isDarkMode ? '#ffffff' : '#1f2937';\n      closeButton.style.background = this.isDarkMode \n        ? 'rgba(255, 255, 255, 0.1)' \n        : 'rgba(0, 0, 0, 0.1)';\n    }\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒŠã¨ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®ãƒ†ãƒ¼ãƒæ›´æ–°\n    this.updateFloatingContainerTheme();\n\n    // æ—¢å­˜ã®å‡ºåŠ›ãƒ†ã‚­ã‚¹ãƒˆã®è‰²ã‚’æ›´æ–°\n    this.updateExistingTextColors();\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒŠã¨ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®ãƒ†ãƒ¼ãƒæ›´æ–°\n   */\n  updateFloatingContainerTheme() {\n    if (!this.floatingContainer) return;\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒŠã®è¡¨ç¤ºçŠ¶æ…‹ã‚’ä¿æŒ\n    const currentDisplay = this.floatingContainer.style.display;\n\n    // æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®è‰²ã ã‘ã‚’ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã¦æ›´æ–°ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯ä¿æŒï¼‰\n    if (this.taskCards && this.taskCards.size > 0) {\n      this.taskCards.forEach((taskData, taskId) => {\n        const card = taskData.element;\n        if (card) {\n          // ãƒ†ãƒ¼ãƒé–¢é€£ã®è‰²ã®ã¿æ›´æ–°ï¼ˆä½ç½®ã‚„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã¯ä¿æŒï¼‰\n          // 2025å¹´Glassmorphismä»•æ§˜é©ç”¨\n          const glassmorphismDark = {\n            background: 'linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 27, 75, 0.7))',\n            border: '1px solid rgba(99, 102, 241, 0.25)',\n            color: '#ffffff'\n          };\n\n          const glassmorphismLight = {\n            background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25))',\n            border: '1px solid rgba(255, 255, 255, 0.4)',\n            color: '#1f2937'\n          };\n\n          const theme = this.isDarkMode ? glassmorphismDark : glassmorphismLight;\n\n\n          card.style.setProperty('background', theme.background, 'important');\n          card.style.setProperty('border', theme.border, 'important');\n          card.style.setProperty('color', theme.color, 'important');\n        }\n      });\n    }\n\n    // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆæ™‚ã¯ä½ç½®ã¯å¤‰æ›´ã›ãšã€è¡¨ç¤ºçŠ¶æ…‹ã®ã¿å¾©å…ƒ\n    this.floatingContainer.style.display = currentDisplay;\n  }\n\n  /**\n   * æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’ç¾åœ¨ã®ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã¦æ›´æ–°\n   */\n  updateExistingTextColors() {\n    const colors = this.isDarkMode ? {\n      system: '#60a5fa',\n      command: '#93c5fd',\n      success: '#f472b6',\n      error: '#f87171',\n      processing: '#fbbf24',\n      info: '#d1d5db',\n      hint: '#d1d5db'\n    } : {\n      system: '#1e40af',\n      command: '#1d4ed8',\n      success: '#be185d',\n      error: '#dc2626',\n      processing: '#d97706',\n      info: '#7c3aed',\n      hint: '#374151'\n    };\n\n    const defaultTextColor = this.isDarkMode ? '#d1d5db' : '#374151';\n\n    // outputå†…ã®å…¨ã¦ã®divã®è‰²ã‚’æ›´æ–°\n    this.output.querySelectorAll('div').forEach(line => {\n      const text = line.textContent;\n      let type = 'default';\n      \n      // ãƒ†ã‚­ã‚¹ãƒˆã®å†…å®¹ã‹ã‚‰ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š\n      if (text.includes('ğŸ“‹') || text.includes('ğŸ¨') || text.includes('ğŸ®') || text.includes('UIèµ·å‹•')) {\n        type = 'system';\n      } else if (text.startsWith('> ')) {\n        type = 'command';\n      } else if (text.includes('âœ…') || text.includes('â­') || text.includes('ç”Ÿæˆã—ã¾ã—ãŸ')) {\n        type = 'success';\n      } else if (text.includes('âŒ') || text.includes('ã‚¨ãƒ©ãƒ¼')) {\n        type = 'error';\n      } else if (text.includes('ä¸­...')) {\n        type = 'processing';\n      } else if (text.includes('ğŸ“') || text.includes('ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«:') || text.includes('ä½ç½®:')) {\n        type = 'info';\n      } else if (text.includes('   ')) {\n        type = 'hint';\n      }\n\n      line.style.color = colors[type] || defaultTextColor;\n    });\n  }\n\n  /**\n   * Importã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¡¨ç¤º\n   */\n  showImportInterface() {\n    // éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ä½œæˆï¼ˆImportãƒœã‚¿ãƒ³ã‹ã‚‰ç›´æ¥é¸æŠã§ãã‚‹ã®ã§ã€ãƒœã‚¿ãƒ³ã¯ä¸è¦ï¼‰\n    if (!this.fileInput) {\n      this.fileInput = document.createElement('input');\n      this.fileInput.type = 'file';\n      this.fileInput.accept = '.glb,.gltf,.jpg,.jpeg,.png,.mp4,.mov';\n      this.fileInput.style.display = 'none';\n      this.fileInput.onchange = (e) => this.handleFileSelection(e);\n      document.body.appendChild(this.fileInput);\n    }\n\n    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–\n    this.enableDragAndDrop();\n  }\n\n  /**\n   * Importã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹éè¡¨ç¤º\n   */\n  hideImportInterface() {\n    if (this.fileSelectButton && this.fileSelectButton.parentNode) {\n      this.fileSelectButton.parentNode.removeChild(this.fileSelectButton);\n    }\n    this.disableDragAndDrop();\n  }\n\n  /**\n   * ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã\n   */\n  openFileSelector() {\n    if (this.fileInput) {\n      this.fileInput.click();\n    }\n  }\n\n  /**\n   * Importãƒœã‚¿ãƒ³ã‹ã‚‰ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’å®Ÿè¡Œ\n   */\n  triggerFileSelection() {\n    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ\n    if (!this.fileInput) {\n      this.showImportInterface(); // æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ä½œæˆå‡¦ç†ã‚’å‘¼ã³å‡ºã—\n    }\n\n    // ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã\n    this.openFileSelector();\n\n    // Import ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆUIåæ˜ ï¼‰\n    this.selectMode('import', true);\n  }\n\n  /**\n   * ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†\n   */\n  async handleFileSelection(event) {\n    const file = event.target.files[0];\n    if (!file) return;\n\n    try {\n      // å‰å›ã®ObjectURLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰\n      if (this.selectedFile && this.selectedFile.url) {\n        URL.revokeObjectURL(this.selectedFile.url);\n      }\n\n      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š\n      const fileType = this.detectFileType(file.name);\n\n      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«URLã¨ã—ã¦å‡¦ç†\n      const fileUrl = URL.createObjectURL(file);\n\n      // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ä¿å­˜\n      this.selectedFile = {\n        file: file,\n        url: fileUrl,\n        type: fileType,\n        name: file.name\n      };\n\n      this.selectMode('import', true);\n\n      // è‡ªå‹•çš„ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§å®Ÿè¡Œ\n      const defaultPrompt = `ä¸­å¤®ã«è¨­ç½® (${file.name})`;\n      this.input.value = defaultPrompt;\n\n      this.addOutput(`ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ: ${file.name} (${fileType})`, 'system');\n      this.addOutput(`ğŸš€ è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${defaultPrompt}`, 'system');\n\n      // è‡ªå‹•å®Ÿè¡Œï¼ˆå°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦UXå‘ä¸Šï¼‰\n      setTimeout(() => {\n        this.executeCommand();\n      }, 500);\n\n    } catch (error) {\n      console.error('File selection error:', error);\n      this.addOutput(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');\n    } finally {\n      // IMPORTANT: ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã®å†é¸æŠã‚’å¯èƒ½ã«ã™ã‚‹\n      if (event.target) {\n        event.target.value = '';\n      }\n    }\n  }\n\n  /**\n   * ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–\n   */\n  enableDragAndDrop() {\n    if (!this.input) return;\n\n    this.input.addEventListener('dragover', this.handleDragOver.bind(this));\n    this.input.addEventListener('drop', this.handleDrop.bind(this));\n    this.input.addEventListener('dragenter', this.handleDragEnter.bind(this));\n    this.input.addEventListener('dragleave', this.handleDragLeave.bind(this));\n  }\n\n  /**\n   * ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–\n   */\n  disableDragAndDrop() {\n    if (!this.input) return;\n\n    this.input.removeEventListener('dragover', this.handleDragOver.bind(this));\n    this.input.removeEventListener('drop', this.handleDrop.bind(this));\n    this.input.removeEventListener('dragenter', this.handleDragEnter.bind(this));\n    this.input.removeEventListener('dragleave', this.handleDragLeave.bind(this));\n  }\n\n  /**\n   * ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†\n   */\n  handleDragOver(e) {\n    e.preventDefault();\n    this.input.style.background = this.isDarkMode ? 'rgba(236, 72, 153, 0.1)' : 'rgba(236, 72, 153, 0.05)';\n  }\n\n  /**\n   * ãƒ‰ãƒ©ãƒƒã‚°ã‚¨ãƒ³ã‚¿ãƒ¼å‡¦ç†\n   */\n  handleDragEnter(e) {\n    e.preventDefault();\n    this.input.style.background = this.isDarkMode ? 'rgba(236, 72, 153, 0.1)' : 'rgba(236, 72, 153, 0.05)';\n  }\n\n  /**\n   * ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–å‡¦ç†\n   */\n  handleDragLeave(e) {\n    e.preventDefault();\n    this.input.style.background = '';\n  }\n\n  /**\n   * ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†\n   */\n  async handleDrop(e) {\n    e.preventDefault();\n    this.input.style.background = '';\n\n    const files = Array.from(e.dataTransfer.files);\n    if (files.length === 0) return;\n\n    const file = files[0]; // æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å‡¦ç†\n\n    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯\n    const fileType = this.detectFileType(file.name);\n    if (!fileType) {\n      this.addOutput('âŒ ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™', 'error');\n      return;\n    }\n\n    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†ã¨åŒã˜æµã‚Œ\n    this.handleFileSelection({ target: { files: [file] } });\n  }\n\n  /**\n   * ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—åˆ¤å®š\n   */\n  detectFileType(fileName) {\n    const ext = fileName.toLowerCase().split('.').pop();\n\n    if (['glb', 'gltf'].includes(ext)) return '3d';\n    if (['jpg', 'jpeg', 'png', 'webp'].includes(ext)) return 'image';\n    if (['mp4', 'mov', 'webm'].includes(ext)) return 'video';\n\n    return null;\n  }\n\n  /**\n   * Importã‚³ãƒãƒ³ãƒ‰å‡¦ç†\n   */\n  async handleImportCommand(command) {\n    if (!this.selectedFile) {\n      throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');\n    }\n\n    try {\n      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‹ã‚‰ä½ç½®æƒ…å ±ã‚’è§£æ\n      const position = this.sceneManager ? this.sceneManager.parsePosition(command) : { x: 0, y: 5, z: -10 };\n\n      let result;\n\n      switch (this.selectedFile.type) {\n        case '3d':\n          // 3Dãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿\n          if (this.sceneManager) {\n            result = await this.sceneManager.load3DModel(this.selectedFile.url, {\n              position: position,\n              // scale: è‡ªå‹•èª¿æ•´ã«ä»»ã›ã‚‹\n            });\n          } else {\n            throw new Error('SceneManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');\n          }\n          break;\n\n        case 'image':\n          // ç”»åƒã‚’ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ã—ã¦é…ç½®\n          if (this.sceneManager) {\n            result = await this.sceneManager.loadImageFile(this.selectedFile.url, {\n              position: position,\n              fileName: this.selectedFile.name\n            });\n          } else {\n            throw new Error('SceneManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');\n          }\n          break;\n\n        case 'video':\n          // å‹•ç”»ã‚’ãƒ“ãƒ‡ã‚ªãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨ã—ã¦é…ç½®\n          if (this.sceneManager) {\n            result = await this.sceneManager.loadVideoFile(this.selectedFile.url, {\n              position: position,\n              fileName: this.selectedFile.name\n            });\n          } else {\n            throw new Error('SceneManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');\n          }\n          break;\n\n        default:\n          throw new Error(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: ${this.selectedFile.type}`);\n      }\n\n      // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n      const processedFileName = this.selectedFile?.name;\n      const importedType = this.selectedFile?.type;\n      const importedUrl = this.selectedFile?.url;\n\n      if (importedType !== 'video' && importedUrl) {\n        URL.revokeObjectURL(importedUrl);\n      }\n\n      this.selectedFile = null;\n      this.selectMode('generate', false);\n\n      return {\n        success: true,\n        message: `${processedFileName || 'ãƒ•ã‚¡ã‚¤ãƒ«'} ã‚’ ${position.x}, ${position.y}, ${position.z} ã«é…ç½®ã—ã¾ã—ãŸ`,\n        objectId: result.objectId\n      };\n\n    } catch (error) {\n      // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n      if (this.selectedFile?.url) {\n        URL.revokeObjectURL(this.selectedFile.url);\n      }\n      this.selectedFile = null;\n      this.selectMode('generate', false);\n      throw error;\n    }\n  }\n\n  /**\n   * å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚ŒãŸæ™‚ã®å‡¦ç†\n   */\n  handleDeleteModeSelection() {\n    // SceneManagerã‹ã‚‰é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—\n    const selectedObject = this.sceneManager?.selectedObject;\n    \n    if (selectedObject) {\n      // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹å ´åˆï¼šå‰Šé™¤ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒãƒ£ãƒƒãƒˆæ¬„ã«å…¥åŠ›\n      const objectName = selectedObject.userData?.originalPrompt || selectedObject.name || 'é¸æŠã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ';\n      this.input.value = `${objectName}ã‚’å‰Šé™¤ â`;\n      this.input.focus();\n      \n      // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ–‡æœ«ã«ç§»å‹•ï¼ˆé¸æŠçŠ¶æ…‹ã‚’è§£é™¤ï¼‰\n      this.input.setSelectionRange(this.input.value.length, this.input.value.length);\n      \n      this.addOutput(`ğŸ¯ å‰Šé™¤å¯¾è±¡: ${objectName}`, 'system');\n    } else {\n      // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãªã„å ´åˆï¼š2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§æ³¨æ„å–šèµ·\n      this.input.value = '';\n      this.addOutput('â— å‰Šé™¤ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠå¾Œã€å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„', 'system');\n      \n      // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šContext-Aware Attention Animation\n      this.triggerAttentionAnimation('delete');\n      \n      // DELETEãƒ¢ãƒ¼ãƒ‰ã‚’ç¶­æŒï¼ˆgenerateãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã•ãªã„ï¼‰\n    }\n  }\n\n  /**\n   * ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚ŒãŸæ™‚ã®å‡¦ç†\n   */\n  handleModifyModeSelection() {\n    // SceneManagerã‹ã‚‰é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—\n    const selectedObject = this.sceneManager?.selectedObject;\n    \n    if (selectedObject) {\n      // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹å ´åˆï¼šä¿®æ­£ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒãƒ£ãƒƒãƒˆæ¬„ã«å…¥åŠ›\n      const objectName = selectedObject.userData?.originalPrompt || selectedObject.name || 'é¸æŠã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ';\n      this.input.value = `${objectName}ã‚’`;\n      this.input.focus();\n      \n      // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ–‡æœ«ã«ç§»å‹•ï¼ˆé¸æŠçŠ¶æ…‹ã‚’è§£é™¤ï¼‰\n      this.input.setSelectionRange(this.input.value.length, this.input.value.length);\n      \n      this.addOutput(`ğŸ¯ ä¿®æ­£å¯¾è±¡: ${objectName}`, 'system');\n    } else {\n      // é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãªã„å ´åˆï¼š2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§æ³¨æ„å–šèµ·\n      this.input.value = '';\n      this.addOutput('â— ä¿®æ­£ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠå¾Œã€ä¿®æ­£ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„', 'system');\n      \n      // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šContext-Aware Attention Animation\n      this.triggerAttentionAnimation('modify');\n      \n      // Modifyãƒ¢ãƒ¼ãƒ‰ã‚’ç¶­æŒï¼ˆgenerateãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã•ãªã„ï¼‰\n    }\n  }\n\n  /**\n   * 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šContext-Aware Attention Animation\n   * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠæ™‚ã®æ³¨æ„å–šèµ·ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n   */\n  triggerAttentionAnimation(mode) {\n    const chatOutput = this.chatOutput;\n    const inputField = this.input;\n    \n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰1: Micro-Shake Effectï¼ˆå¾®ç´°ãªéœ‡ãˆï¼‰\n    this.addMicroShakeEffect(chatOutput);\n    \n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰2: Context-Aware Glowï¼ˆçŠ¶æ³èªè­˜ã‚°ãƒ­ãƒ¼ï¼‰\n    this.addContextGlow(inputField, mode);\n    \n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰3: Emotional Pulseï¼ˆæ„Ÿæƒ…çš„ãƒ‘ãƒ«ã‚¹ï¼‰\n    this.addEmotionalPulse(chatOutput, mode);\n    \n    // 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰4: 3D Depth Shadowï¼ˆç«‹ä½“çš„å½±åŠ¹æœï¼‰\n    this.add3DDepthEffect(chatOutput);\n  }\n\n  /**\n   * 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šMicro-Shake Effect\n   */\n  addMicroShakeEffect(element) {\n    element.style.animation = 'microShake2025 0.5s ease-in-out';\n    \n    // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•çš„è¿½åŠ \n    this.ensureMicroShakeAnimation();\n    \n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    setTimeout(() => {\n      element.style.animation = '';\n    }, 500);\n  }\n\n  /**\n   * 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šContext-Aware Glow\n   */\n  addContextGlow(element, mode) {\n    const glowColor = mode === 'delete' ? 'rgba(239, 68, 68, 0.4)' : 'rgba(99, 102, 241, 0.4)';\n    \n    element.style.transition = 'all 0.3s ease';\n    element.style.boxShadow = `0 0 20px ${glowColor}, 0 0 40px ${glowColor}`;\n    \n    // 3ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ\n    setTimeout(() => {\n      element.style.boxShadow = '';\n    }, 3000);\n  }\n\n  /**\n   * 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šEmotional Pulse\n   */\n  addEmotionalPulse(element, mode) {\n    const pulseColor = mode === 'delete' ? '#ef4444' : (this.isWabiSabiMode ? '#8BC34A' : '#6366f1');\n    \n    element.style.borderLeft = `4px solid ${pulseColor}`;\n    element.style.animation = 'emotionalPulse2025 2s ease-in-out infinite';\n    \n    // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•çš„è¿½åŠ \n    this.ensureEmotionalPulseAnimation();\n    \n    // 6ç§’å¾Œã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢\n    setTimeout(() => {\n      element.style.animation = '';\n      element.style.borderLeft = '';\n    }, 6000);\n  }\n\n  /**\n   * 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰ï¼š3D Depth Effect\n   */\n  add3DDepthEffect(element) {\n    element.style.transform = 'translateZ(8px) rotateX(1deg)';\n    element.style.transition = 'transform 0.3s ease';\n    \n    // 2ç§’å¾Œã«å…ƒã«æˆ»ã™\n    setTimeout(() => {\n      element.style.transform = '';\n    }, 2000);\n  }\n\n  /**\n   * Micro-Shake CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºä¿\n   */\n  ensureMicroShakeAnimation() {\n    if (document.getElementById('micro-shake-2025')) return;\n    \n    const style = document.createElement('style');\n    style.id = 'micro-shake-2025';\n    style.textContent = `\n      @keyframes microShake2025 {\n        0%, 100% { transform: translateX(0); }\n        10% { transform: translateX(-2px) rotateZ(-0.5deg); }\n        20% { transform: translateX(2px) rotateZ(0.5deg); }\n        30% { transform: translateX(-1px) rotateZ(-0.3deg); }\n        40% { transform: translateX(1px) rotateZ(0.3deg); }\n        50% { transform: translateX(-0.5px) rotateZ(-0.1deg); }\n        60% { transform: translateX(0.5px) rotateZ(0.1deg); }\n        70% { transform: translateX(0); }\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  /**\n   * Emotional Pulse CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºä¿\n   */\n  ensureEmotionalPulseAnimation() {\n    if (document.getElementById('emotional-pulse-2025')) return;\n    \n    const style = document.createElement('style');\n    style.id = 'emotional-pulse-2025';\n    style.textContent = `\n      @keyframes emotionalPulse2025 {\n        0% { \n          border-left-width: 4px;\n          filter: brightness(1);\n        }\n        50% { \n          border-left-width: 8px;\n          filter: brightness(1.2) saturate(1.1);\n        }\n        100% { \n          border-left-width: 4px;\n          filter: brightness(1);\n        }\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å…¥åŠ›æ¬„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸Šæ›¸ãæ©Ÿèƒ½\n   * ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šï¼šä»–ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ–°ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸçŠ¶æ…‹ã«ã‚¯ãƒªã‚¢\n   */\n  clearInputOnModeSwitch(newMode) {\n    // ç¾åœ¨ã®å…¥åŠ›æ¬„ã«å†…å®¹ãŒã‚ã‚‹å ´åˆã®ã¿å‡¦ç†\n    if (this.input.value.trim()) {\n      // ä»¥å‰ã®ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã©ã†ã‹ã‚’åˆ¤å®š\n      const isPreviousModeMessage = this.isPreviousModeMessage(this.input.value, newMode);\n      \n      if (isPreviousModeMessage) {\n        // ä»¥å‰ã®ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã€æ–°ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ç½®ãæ›ãˆ\n        this.input.value = '';\n        this.addOutput(`ğŸ’« ${this.getModeDisplayName(newMode)}ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, 'system');\n      }\n    }\n  }\n\n  /**\n   * å…¥åŠ›å†…å®¹ãŒä»¥å‰ã®ãƒ¢ãƒ¼ãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã©ã†ã‹ã‚’åˆ¤å®š\n   */\n  isPreviousModeMessage(inputValue, currentMode) {\n    // Delete/Modifyãƒ¢ãƒ¼ãƒ‰ã®ç‰¹å¾´çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º\n    const deletePatterns = [\n      /.*ã‚’å‰Šé™¤$/,\n      /å‰Šé™¤$/\n    ];\n    \n    const modifyPatterns = [\n      /.*ã‚’$/,\n      /.*ã‚’å¤‰æ›´/,\n      /.*ã‚’ãƒ”ãƒ³ã‚¯/,\n      /.*ã‚’å¤§ãã/,\n      /.*ã‚’å°ã•ã/,\n      /.*ã‚’ç§»å‹•/,\n      /å›è»¢/,\n      /åè»¢/,\n      /ãƒŸãƒ©ãƒ¼/,\n      /å‚¾ã‘/,\n      /å‘ãã‚’å¤‰ãˆ/,\n      /.*ã‚’.*è‰²/,\n      /.*ã‚’.*ã‚µã‚¤ã‚º/\n    ];\n    \n    const importPatterns = [\n      /ãƒ•ã‚¡ã‚¤ãƒ«/,\n      /ç”»åƒ/,\n      /ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/\n    ];\n\n    // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã¨ç•°ãªã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã™ã‚‹å ´åˆã¯ä¸Šæ›¸ãå¯¾è±¡\n    switch (currentMode) {\n      case 'delete':\n        return modifyPatterns.some(pattern => pattern.test(inputValue)) ||\n               importPatterns.some(pattern => pattern.test(inputValue));\n               \n      case 'modify':\n        return deletePatterns.some(pattern => pattern.test(inputValue)) ||\n               importPatterns.some(pattern => pattern.test(inputValue));\n               \n      case 'import':\n        return deletePatterns.some(pattern => pattern.test(inputValue)) ||\n               modifyPatterns.some(pattern => pattern.test(inputValue));\n               \n      case 'generate':\n        return deletePatterns.some(pattern => pattern.test(inputValue)) ||\n               modifyPatterns.some(pattern => pattern.test(inputValue)) ||\n               importPatterns.some(pattern => pattern.test(inputValue));\n               \n      default:\n        return false;\n    }\n  }\n\n  /**\n   * ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºåã‚’å–å¾—\n   */\n  getModeDisplayName(mode) {\n    const modeNames = {\n      'generate': 'ç”Ÿæˆ',\n      'import': 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆ',\n      'modify': 'ä¿®æ­£',\n      'delete': 'å‰Šé™¤'\n    };\n    return modeNames[mode] || mode;\n  }\n\n  /**\n   * å¸¸æ™‚è¡¨ç¤ºãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ§ã‚³ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆ\n   */\n  createFloatingChocolateIcon() {\n    // æ—¢å­˜ã®ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤\n    if (this.floatingChocolateIcon) {\n      this.floatingChocolateIcon.remove();\n    }\n\n    this.floatingChocolateIcon = document.createElement('div');\n    this.floatingChocolateIcon.innerHTML = 'ğŸ«';\n    this.floatingChocolateIcon.title = 'ChocoDrop ã‚’é–‹ã (@ã‚­ãƒ¼ã§ã‚‚é–‹ã‘ã¾ã™)';\n    this.floatingChocolateIcon.style.cssText = `\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      width: 48px;\n      height: 48px;\n      border-radius: 50%;\n      background: rgba(99, 102, 241, 0.15);\n      backdrop-filter: blur(16px);\n      -webkit-backdrop-filter: blur(16px);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05);\n      opacity: 0.8;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 20px;\n      cursor: pointer;\n      z-index: 999;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      transform: scale(1);\n      filter: none;\n    `;\n\n    // ãƒ›ãƒãƒ¼åŠ¹æœ\n    this.floatingChocolateIcon.addEventListener('mouseover', () => {\n      this.floatingChocolateIcon.style.transform = 'scale(1.1) translateY(-2px)';\n      this.floatingChocolateIcon.style.boxShadow = '0 6px 16px rgba(99, 102, 241, 0.3), 0 3px 8px rgba(0, 0, 0, 0.1)';\n      this.floatingChocolateIcon.style.opacity = '1';\n      this.floatingChocolateIcon.style.filter = 'none';\n    });\n\n    this.floatingChocolateIcon.addEventListener('mouseout', () => {\n      this.floatingChocolateIcon.style.transform = 'scale(1) translateY(0)';\n      this.floatingChocolateIcon.style.boxShadow = '0 4px 12px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05)';\n      this.floatingChocolateIcon.style.opacity = '0.8';\n      this.floatingChocolateIcon.style.filter = 'none';\n    });\n\n    // ã‚¯ãƒªãƒƒã‚¯ã§ ChocoDrop ã‚’é–‹ã\n    this.floatingChocolateIcon.addEventListener('click', () => {\n      if (this.isVisible) {\n        this.hide();\n      } else {\n        this.show();\n      }\n    });\n\n    // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼\n    this.floatingChocolateIcon.addEventListener('contextmenu', (e) => {\n      e.preventDefault();\n      this.showFloatingIconContextMenu(e);\n    });\n\n    // DOM ã«è¿½åŠ \n    document.body.appendChild(this.floatingChocolateIcon);\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ã‚¤ã‚³ãƒ³ã®å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º\n   */\n  showFloatingIconContextMenu(event) {\n    // æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤\n    const existingMenu = document.querySelector('.floating-icon-context-menu');\n    if (existingMenu) {\n      existingMenu.remove();\n    }\n\n    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆ\n    const menu = document.createElement('div');\n    menu.className = 'floating-icon-context-menu';\n    menu.style.cssText = `\n      position: fixed;\n      top: ${event.clientY}px;\n      left: ${event.clientX}px;\n      background: ${this.isWabiSabiMode\n        ? 'rgba(239, 235, 233, 0.9)'\n        : (this.isDarkMode ? 'rgba(17, 24, 39, 0.85)' : 'rgba(255, 255, 255, 0.85)')};\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid ${this.isWabiSabiMode\n        ? 'rgba(161, 136, 127, 0.4)'\n        : (this.isDarkMode ? 'rgba(129, 140, 248, 0.3)' : 'rgba(99, 102, 241, 0.2)')};\n      border-radius: 12px;\n      box-shadow: ${this.isWabiSabiMode\n        ? '0 8px 24px rgba(93, 64, 55, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1)'\n        : '0 8px 24px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1)'};\n      padding: 8px 0;\n      min-width: 160px;\n      z-index: 2000;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      color: ${this.isWabiSabiMode\n        ? '#5D4037'\n        : (this.isDarkMode ? '#ffffff' : '#1f2937')};\n    `;\n\n    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ 1: ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã\n    const openFormItem = document.createElement('div');\n    openFormItem.innerHTML = 'ğŸ“„ ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã';\n    openFormItem.style.cssText = `\n      padding: 8px 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      color: ${this.isWabiSabiMode ? '#8D6E63' : '#6366f1'};\n      text-shadow: ${this.isWabiSabiMode\n        ? '0 2px 4px rgba(141, 110, 99, 0.3)'\n        : '0 2px 4px rgba(99, 102, 241, 0.3)'};\n    `;\n\n    openFormItem.addEventListener('mouseover', () => {\n      openFormItem.style.background = this.isWabiSabiMode\n        ? 'rgba(161, 136, 127, 0.15)'\n        : (this.isDarkMode ? 'rgba(99, 102, 241, 0.15)' : 'rgba(99, 102, 241, 0.1)');\n      openFormItem.style.textShadow = this.isWabiSabiMode\n        ? '0 2px 6px rgba(141, 110, 99, 0.5)'\n        : '0 2px 6px rgba(99, 102, 241, 0.5)';\n    });\n\n    openFormItem.addEventListener('mouseout', () => {\n      openFormItem.style.background = 'transparent';\n      openFormItem.style.textShadow = this.isWabiSabiMode\n        ? '0 2px 4px rgba(141, 110, 99, 0.3)'\n        : '0 2px 4px rgba(99, 102, 241, 0.3)';\n    });\n\n    openFormItem.addEventListener('click', () => {\n      menu.remove();\n      if (this.isVisible) {\n        this.hide();\n      } else {\n        this.show();\n      }\n    });\n\n    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ 2: ã‚¢ã‚¤ã‚³ãƒ³ã‚’éè¡¨ç¤º\n    const hideIconItem = document.createElement('div');\n    hideIconItem.innerHTML = 'âœ• ã‚¢ã‚¤ã‚³ãƒ³ã‚’éè¡¨ç¤º';\n    hideIconItem.style.cssText = `\n      padding: 8px 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      color: ${this.isWabiSabiMode ? '#8D6E63' : '#6366f1'};\n      text-shadow: ${this.isWabiSabiMode\n        ? '0 2px 4px rgba(141, 110, 99, 0.3)'\n        : '0 2px 4px rgba(99, 102, 241, 0.3)'};\n    `;\n\n    hideIconItem.addEventListener('mouseover', () => {\n      hideIconItem.style.background = this.isWabiSabiMode\n        ? 'rgba(161, 136, 127, 0.15)'\n        : (this.isDarkMode ? 'rgba(99, 102, 241, 0.15)' : 'rgba(99, 102, 241, 0.1)');\n      hideIconItem.style.textShadow = this.isWabiSabiMode\n        ? '0 2px 6px rgba(141, 110, 99, 0.5)'\n        : '0 2px 6px rgba(99, 102, 241, 0.5)';\n    });\n\n    hideIconItem.addEventListener('mouseout', () => {\n      hideIconItem.style.background = 'transparent';\n      hideIconItem.style.textShadow = this.isWabiSabiMode\n        ? '0 2px 4px rgba(141, 110, 99, 0.3)'\n        : '0 2px 4px rgba(99, 102, 241, 0.3)';\n    });\n\n    hideIconItem.addEventListener('click', () => {\n      menu.remove();\n      this.hideFloatingIcon();\n    });\n\n    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¿½åŠ \n    menu.appendChild(openFormItem);\n    menu.appendChild(hideIconItem);\n\n    // DOM ã«è¿½åŠ \n    document.body.appendChild(menu);\n\n    // ç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†ã«èª¿æ•´\n    const rect = menu.getBoundingClientRect();\n    if (rect.right > window.innerWidth) {\n      menu.style.left = `${event.clientX - rect.width}px`;\n    }\n    if (rect.bottom > window.innerHeight) {\n      menu.style.top = `${event.clientY - rect.height}px`;\n    }\n\n    // å¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹\n    const closeMenu = (e) => {\n      if (!menu.contains(e.target)) {\n        menu.remove();\n        document.removeEventListener('click', closeMenu);\n      }\n    };\n\n    setTimeout(() => {\n      document.addEventListener('click', closeMenu);\n    }, 10);\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ã‚¤ã‚³ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹\n   */\n  hideFloatingIcon() {\n    if (this.floatingChocolateIcon) {\n      this.floatingChocolateIcon.style.display = 'none';\n    }\n  }\n\n  /**\n   * ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹\n   */\n  showFloatingIcon() {\n    if (this.floatingChocolateIcon) {\n      this.floatingChocolateIcon.style.display = 'flex';\n    }\n  }\n\n  dispose() {\n    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    this.clearKeywordHighlighting();\n\n    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠé–¢é€£ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    if (this.fileInput && this.fileInput.parentNode) {\n      this.fileInput.parentNode.removeChild(this.fileInput);\n    }\n    if (this.selectedFile && this.selectedFile.url) {\n      URL.revokeObjectURL(this.selectedFile.url);\n    }\n\n    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ§ã‚³ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    if (this.floatingChocolateIcon && this.floatingChocolateIcon.parentNode) {\n      this.floatingChocolateIcon.parentNode.removeChild(this.floatingChocolateIcon);\n    }\n\n    if (this.container && this.container.parentElement) {\n      this.container.parentElement.removeChild(this.container);\n    }\n  }\n\n  showOverlayTextarea() {\n    if (this.overlayTextarea) return;\n\n    this.isExpanded = true;\n    \n    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ä½œæˆ\n    this.overlayTextarea = document.createElement('textarea');\n    this.overlayTextarea.value = this.input.value;\n    this.overlayTextarea.placeholder = this.input.placeholder;\n    \n    // ãƒ•ã‚©ãƒ¼ãƒ ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’å–å¾—\n    const containerRect = this.container.getBoundingClientRect();\n    \n    // ç”»é¢å¢ƒç•Œã‚’è€ƒæ…®ã—ãŸä½ç½®èª¿æ•´\n    const overlayHeight = 300;\n    const padding = 20;\n    \n    let top = containerRect.top + 60;\n    let left = containerRect.left;\n    let width = containerRect.width;\n    \n    // å³ç«¯ãŒã¯ã¿å‡ºã‚‹å ´åˆ\n    if (left + width > window.innerWidth - padding) {\n      left = window.innerWidth - width - padding;\n    }\n    \n    // å·¦ç«¯ãŒã¯ã¿å‡ºã‚‹å ´åˆ\n    if (left < padding) {\n      left = padding;\n      width = Math.min(width, window.innerWidth - 2 * padding);\n    }\n    \n    // ä¸‹ç«¯ãŒã¯ã¿å‡ºã‚‹å ´åˆ\n    if (top + overlayHeight > window.innerHeight - padding) {\n      top = Math.max(padding, window.innerHeight - overlayHeight - padding);\n    }\n\n    const overlayBackground = this.isWabiSabiMode\n      ? 'linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))'\n      : (this.isDarkMode\n        ? 'linear-gradient(135deg, rgba(30, 27, 75, 0.4), rgba(15, 23, 42, 0.5))'\n        : 'linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))');\n\n    const overlayBorder = this.isWabiSabiMode\n      ? '1px solid rgba(93, 64, 55, 0.5)'\n      : (this.isDarkMode\n        ? '1px solid rgba(99, 102, 241, 0.25)'\n        : '1px solid rgba(255, 255, 255, 0.5)');\n\n    const overlayInnerShadow = this.isWabiSabiMode\n      ? '0 4px 16px rgba(66, 66, 66, 0.3), inset 0 1px 0 rgba(189, 189, 189, 0.2)'\n      : (this.isDarkMode\n        ? '0 4px 16px rgba(15, 23, 42, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08)'\n        : '0 4px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.4)');\n\n    const overlayTextColor = this.getInputTextColor();\n\n    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š\n    this.overlayTextarea.style.cssText = `\n      position: fixed;\n      top: ${top}px;\n      left: ${left}px;\n      width: ${width}px;\n      height: ${overlayHeight}px;\n      box-sizing: border-box;\n      background: ${overlayBackground};\n      backdrop-filter: blur(24px) saturate(180%);\n      border: ${overlayBorder};\n      box-shadow: ${overlayInnerShadow};\n      border-radius: 16px;\n      color: ${overlayTextColor};\n      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      line-height: 1.5;\n      padding: 20px;\n      resize: none;\n      outline: none;\n      z-index: 10000;\n      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);\n      opacity: 0;\n      transition: opacity 0.2s ease-out;\n    `;\n    \n    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¿½åŠ \n    document.body.appendChild(this.overlayTextarea);\n    \n    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹\n    requestAnimationFrame(() => {\n      this.overlayTextarea.style.opacity = '1';\n    });\n    \n    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¨­å®š\n    this.overlayTextarea.focus();\n    \n    // å…¥åŠ›åŒæœŸ\n    this.overlayTextarea.addEventListener('input', (e) => {\n      this.input.value = e.target.value;\n    });\n    \n    // Escapeã‚­ãƒ¼ã§é–‰ã˜ã‚‹\n    this.overlayTextarea.addEventListener('keydown', (e) => {\n      if (e.key === 'Escape') {\n        this.hideOverlayTextarea();\n      }\n    });\n    \n    // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹\n    this.overlayTextarea.addEventListener('blur', () => {\n      setTimeout(() => this.hideOverlayTextarea(), 100);\n    });\n  }\n  \n  hideOverlayTextarea() {\n    if (!this.overlayTextarea) return;\n    \n    this.isExpanded = false;\n    \n    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    this.overlayTextarea.style.opacity = '0';\n    \n    setTimeout(() => {\n      if (this.overlayTextarea) {\n        document.body.removeChild(this.overlayTextarea);\n        this.overlayTextarea = null;\n      }\n    }, 200);\n  }\n  \n  hideOverlayTextarea() {\n    if (!this.overlayTextarea) return;\n    \n    this.isExpanded = false;\n    \n    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³\n    this.overlayTextarea.style.opacity = '0';\n    \n    setTimeout(() => {\n      if (this.overlayTextarea) {\n        document.body.removeChild(this.overlayTextarea);\n        this.overlayTextarea = null;\n      }\n    }, 200);\n  }\n}\n","import { ChocoDropClient, ChocoDroClient, LiveCommandClient } from './LiveCommandClient.js';\nimport { SceneManager } from './SceneManager.js';\nimport { CommandUI } from './CommandUI.js';\n\n/**\n * ChocoDrop ãƒ¯ãƒ³ã‚¹ãƒ†ãƒƒãƒ—åˆæœŸåŒ–ãƒ˜ãƒ«ãƒ‘ãƒ¼\n * å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰è¤‡æ•°ã® Three.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ä½¿ã„å›ã™ã“ã¨ã‚’æƒ³å®š\n *\n * @param {THREE.Scene} scene - æ—¢å­˜ Three.js ã‚·ãƒ¼ãƒ³\n * @param {Object} options - åˆæœŸåŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³\n * @param {THREE.Camera} [options.camera] - ç›¸å¯¾é…ç½®è¨ˆç®—ã«ä½¿ç”¨ã™ã‚‹ã‚«ãƒ¡ãƒ©\n * @param {THREE.WebGLRenderer} [options.renderer] - ãƒã‚¦ã‚¹æ“ä½œã‚’æœ‰åŠ¹åŒ–ã™ã‚‹å ´åˆã«ä½¿ç”¨\n * @param {string} [options.serverUrl] - ChocoDrop ã‚µãƒ¼ãƒãƒ¼ã®æ˜ç¤ºçš„ URL\n * @param {ChocoDropClient} [options.client] - æ—¢å­˜ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ³¨å…¥ã™ã‚‹å ´åˆï¼ˆæ—§ LiveCommandClientï¼‰\n * @param {Function} [options.onControlsToggle] - UI é–‹é–‰æ™‚ã«å‘¼ã°ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯\n * @param {Object} [options.sceneOptions] - SceneManager ã¸æ¸¡ã™è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³\n * @param {Object} [options.uiOptions] - CommandUI ã¸æ¸¡ã™è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³\n * @returns {Object} - åˆæœŸåŒ–æ¸ˆã¿ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç¾¤ã¨ dispose ãƒ˜ãƒ«ãƒ‘ãƒ¼\n */\nexport function createChocoDrop(scene, options = {}) {\n  if (!scene) {\n    throw new Error('THREE.Scene ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå¿…è¦ã§ã™');\n  }\n\n  const {\n    camera = null,\n    renderer = null,\n    serverUrl = null,\n    client = null,\n    onControlsToggle = () => {},\n    sceneOptions = {},\n    uiOptions = {}\n  } = options;\n\n  const resolvedServerUrl = serverUrl || sceneOptions.serverUrl || null;\n  const chocoDropClient = client || new ChocoDropClient(resolvedServerUrl);\n\n  const sceneManager = new SceneManager(scene, {\n    camera,\n    renderer,\n    serverUrl: resolvedServerUrl,\n    client: chocoDropClient,\n    ...sceneOptions\n  });\n\n  const commandUI = new CommandUI({\n    sceneManager,\n    client: chocoDropClient,\n    onControlsToggle,\n    ...uiOptions\n  });\n\n  return {\n    client: chocoDropClient,\n    sceneManager,\n    ui: commandUI,\n    dispose() {\n      commandUI.dispose?.();\n      sceneManager.dispose?.();\n    }\n  };\n}\n\n// æ—§APIåã®äº’æ›ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ\nexport const createChocoDro = createChocoDrop;\nexport const createLiveCommand = createChocoDrop;\n","import { ChocoDropClient, ChocoDroClient, LiveCommandClient } from '../LiveCommandClient.js';\nimport { SceneManager } from '../SceneManager.js';\nimport { CommandUIDemo } from './CommandUIDemo.js';\nimport { createChocoDrop, createChocoDro, createLiveCommand } from '../bootstrap.js';\n\n/**\n * Demo version bootstrap function\n * Creates ChocoDrop instance with CommandUIDemo (restricted functionality)\n */\nfunction createChocoDropDemo(scene, options = {}) {\n  if (!scene) {\n    throw new Error('THREE.Scene ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå¿…è¦ã§ã™');\n  }\n\n  const {\n    camera = null,\n    renderer = null,\n    serverUrl = null,\n    client = null,\n    onControlsToggle = () => {},\n    sceneOptions = {},\n    uiOptions = {},\n    ...otherSceneOptions\n  } = options;\n\n  const resolvedServerUrl = serverUrl || sceneOptions.serverUrl || null;\n  const chocoDropClient = client || new ChocoDropClient(resolvedServerUrl);\n\n  // æ—§APIã¨ã®äº’æ›ã®ãŸã‚ã€ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«æ¸¡ã•ã‚ŒãŸè¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚‚SceneManagerã¸ä¼æ¬ã•ã›ã‚‹\n  const mergedSceneOptions = {\n    ...sceneOptions,\n    ...otherSceneOptions\n  };\n\n  const sceneManager = new SceneManager(scene, {\n    camera,\n    renderer,\n    serverUrl: resolvedServerUrl,\n    client: chocoDropClient,\n    ...mergedSceneOptions\n  });\n\n  // Use CommandUIDemo instead of CommandUI\n  const commandUI = new CommandUIDemo({\n    sceneManager,\n    client: chocoDropClient,\n    onControlsToggle,\n    ...uiOptions\n  });\n\n  sceneManager.ui = commandUI;\n  commandUI.setSceneManager(sceneManager);\n\n  return {\n    sceneManager,\n    ui: commandUI,\n    client: chocoDropClient,\n    dispose: () => {\n      if (commandUI) commandUI.dispose();\n      if (sceneManager) sceneManager.dispose();\n    }\n  };\n}\n\n// Export everything for demo UMD\nexport {\n  ChocoDropClient,\n  ChocoDroClient,\n  LiveCommandClient,\n  SceneManager,\n  CommandUIDemo,\n  createChocoDropDemo,\n  createChocoDropDemo as createChocoDrop,  // Alias for compatibility\n  createChocoDro,\n  createLiveCommand\n};\n\n// Default export for convenience\nexport default {\n  ChocoDropClient,\n  ChocoDroClient,\n  LiveCommandClient,\n  SceneManager,\n  CommandUI: CommandUIDemo, // Alias for demo\n  CommandUIDemo,\n  createChocoDrop: createChocoDropDemo, // Use demo version\n  createChocoDro,\n  createLiveCommand\n};\n"],"mappings":"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","ignoreList":[]}