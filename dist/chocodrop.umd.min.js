!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ChocoDrop={},e.THREE)}(this,function(e,t){"use strict";function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,Object.freeze(t)}var i=n(t);class o{constructor(e=null){this.serverUrl=null,this.initialized=!1,this.initPromise=null,e?(this.serverUrl=e,this.initialized=!0,console.log("ğŸ« ChocoDropClient initialized:",e)):this.initPromise=this.initializeWithConfig()}async initializeWithConfig(){try{const e=`${window.location.protocol}//${window.location.hostname}:${window.location.port}`,t=await fetch(`${e}/api/config`);if(t.ok){const e=await t.json();this.serverUrl=e.serverUrl,console.log("ğŸ« ChocoDropClient initialized from config:",this.serverUrl)}else this.serverUrl=this.detectServerUrl(),console.log("ğŸ« ChocoDropClient fallback to detected URL:",this.serverUrl)}catch(e){console.warn("âš ï¸ ChocoDrop config fetch failed, using fallback:",e),this.serverUrl=this.detectServerUrl()}this.initialized=!0}detectServerUrl(){const e=window.location.port,t=window.location.protocol,n=window.location.hostname;return e?`${t}//${n}:${e}`:`${t}//${n}:3011`}async ensureInitialized(){if(!this.initialized){if(!this.initPromise)throw new Error("ChocoDropClient not initialized");await this.initPromise}}async generateImage(e,t={}){await this.ensureInitialized(),console.log(`ğŸ¨ Requesting image generation: "${e}"`);try{const n={prompt:e,width:t.width||512,height:t.height||512};t.service&&(n.service=t.service);const i=await fetch(`${this.serverUrl}/api/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!i.ok)throw new Error(`Server error: ${i.status}`);const o=await i.json();return console.log("âœ… Image generation result:",o),o}catch(e){throw console.error("âŒ Image generation request failed:",e),e}}async generateVideo(e,t={}){await this.ensureInitialized(),console.log(`ğŸ¬ Requesting video generation: "${e}"`);try{const n={resolution:"720p",enable_safety_checker:!0,enable_prompt_expansion:!0},i={prompt:e,duration:"number"==typeof t.duration&&t.duration>0?t.duration:3,resolution:t.resolution||n.resolution,enable_safety_checker:t.enable_safety_checker??n.enable_safety_checker,enable_prompt_expansion:t.enable_prompt_expansion??n.enable_prompt_expansion};t.aspect_ratio&&(i.aspect_ratio=t.aspect_ratio),t.model&&(i.model=t.model),"number"==typeof t.width&&t.width>0&&(i.width=t.width),"number"==typeof t.height&&t.height>0&&(i.height=t.height),"number"==typeof t.seed&&(i.seed=t.seed),t.negative_prompt&&(i.negative_prompt=t.negative_prompt),"number"==typeof t.frames_per_second&&t.frames_per_second>0&&(i.frames_per_second=t.frames_per_second),"number"==typeof t.guidance_scale&&(i.guidance_scale=t.guidance_scale);const o=await fetch(`${this.serverUrl}/api/generate-video`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!o.ok)throw new Error(`Server error: ${o.status}`);const a=await o.json();return console.log("âœ… Video generation result:",a),a}catch(e){throw console.error("âŒ Video generation request failed:",e),e}}async executeCommand(e){await this.ensureInitialized(),console.log(`ğŸ¯ Executing command: "${e}"`);try{const t=await fetch(`${this.serverUrl}/api/command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:e})});if(!t.ok)throw new Error(`Server error: ${t.status}`);const n=await t.json();return console.log("âœ… Command execution result:",n),n}catch(e){throw console.error("âŒ Command execution failed:",e),e}}async getAvailableServices(){await this.ensureInitialized();try{const e=await fetch(`${this.serverUrl}/api/services`);if(!e.ok)throw new Error(`Server error: ${e.status}`);return await e.json()}catch(e){return console.error("âŒ Failed to get services:",e),[]}}}const a=o,r=o,s={"ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³":"unicorn","ãƒ‰ãƒ©ã‚´ãƒ³":"dragon","é¾":"dragon","æ€ªç£":"monster","ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼":"monster","é­”æ³•ä½¿ã„":"wizard","é­”è¡“å¸«":"sorcerer","é­”å¥³":"witch","å¦–ç²¾":"fairy","ğŸ§š":"fairy","ğŸ§™":"wizard","é­”æ³•æ–":"magic wand","æ–":"wand","ã‚¹ã‚¿ãƒƒãƒ•":"staff","é­”æ³•":"magic","å‘ªæ–‡":"spell","é­”æ³•é™£":"magic circle","æ°´æ™¶ç‰":"crystal ball","è–¬ç“¶":"potion bottle","é­”å°æ›¸":"grimoire","ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹":"phoenix","ã‚°ãƒªãƒ•ã‚£ãƒ³":"griffin","ãƒšã‚¬ã‚µã‚¹":"pegasus","ã‚±ãƒ«ãƒ™ãƒ­ã‚¹":"cerberus","ç”»åƒ":"image","å†™çœŸ":"photo","ã‚¤ãƒ¡ãƒ¼ã‚¸":"image","çµµ":"picture","ãƒ•ã‚¡ã‚¤ãƒ«":"file","ãƒ¡ãƒ‡ã‚£ã‚¢":"media","ç´ æ":"asset","å‹•ç”»":"video","ãƒ“ãƒ‡ã‚ª":"video","ãƒ ãƒ¼ãƒ“ãƒ¼":"movie","æ˜ åƒ":"video","ã‚¯ãƒªãƒƒãƒ—":"clip","çŒ«":"cat","ãƒã‚³":"cat","ã­ã“":"cat","çŠ¬":"dog","ã‚¤ãƒŒ":"dog","ã„ã¬":"dog","ç‹¼":"wolf","ç†Š":"bear","ãƒ©ã‚¤ã‚ªãƒ³":"lion","ãƒˆãƒ©":"tiger","è±¡":"elephant","ã‚­ãƒªãƒ³":"giraffe","ã‚·ãƒã‚¦ãƒ":"zebra","ãƒ‘ãƒ³ãƒ€":"panda","ã‚¦ã‚µã‚®":"rabbit","ãƒªã‚¹":"squirrel","ãƒãƒ ã‚¹ã‚¿ãƒ¼":"hamster","ãƒ•ã‚¯ãƒ­ã‚¦":"owl","ãƒ¯ã‚·":"eagle","ã‚«ãƒ©ã‚¹":"crow","ãƒãƒˆ":"dove","ãƒšãƒ³ã‚®ãƒ³":"penguin","ã‚¤ãƒ«ã‚«":"dolphin","ã‚¯ã‚¸ãƒ©":"whale","ã‚µãƒ¡":"shark","ã‚¿ã‚³":"octopus","ã‚«ãƒ‹":"crab","ã‚¨ãƒ“":"shrimp","èŠ±":"flower","ã¯ãª":"flower","ãƒãƒŠ":"flower","æ¡œ":"cherry blossom","ãƒãƒ©":"rose","ã²ã¾ã‚ã‚Š":"sunflower","ãƒãƒ¥ãƒ¼ãƒªãƒƒãƒ—":"tulip","é›²":"cloud","ç©º":"sky","æµ·":"ocean","æ¹–":"lake","å·":"river","å±±":"mountain","ã‚„ã¾":"mountain","ãƒ¤ãƒ":"mountain","æ£®":"forest","æœ¨":"tree","ã":"tree","ã‚­":"tree","è‰åŸ":"meadow","ç ‚æ¼ ":"desert","æ»":"waterfall","æ´çªŸ":"cave","å³¶":"island","æ˜Ÿåº§":"constellation","éŠ€æ²³":"galaxy","æƒ‘æ˜Ÿ":"planet","åŸ":"castle","ã—ã‚":"castle","ã‚·ãƒ­":"castle","å®®æ®¿":"palace","å®¶":"house","å¡”":"tower","æ•™ä¼š":"church","ç¥æ®¿":"temple","å›³æ›¸é¤¨":"library","å­¦æ ¡":"school","ç—…é™¢":"hospital","é§…":"station","ç©ºæ¸¯":"airport","æ¸¯":"port","æ©‹":"bridge","ç¯å°":"lighthouse","é¢¨è»Š":"windmill","åº­":"garden","å…¬åœ’":"park","éŠåœ’åœ°":"amusement park","è»Š":"car","é›»è»Š":"train","ãƒã‚¹":"bus","é£›è¡Œæ©Ÿ":"airplane","ãƒ˜ãƒªã‚³ãƒ—ã‚¿ãƒ¼":"helicopter","èˆ¹":"ship","ãƒ¨ãƒƒãƒˆ":"yacht","è‡ªè»¢è»Š":"bicycle","ãƒã‚¤ã‚¯":"motorcycle","ãƒ­ã‚±ãƒƒãƒˆ":"rocket","æœˆ":"moon","å¤ªé™½":"sun","æ˜Ÿ":"star","å½—æ˜Ÿ":"comet","æµã‚Œæ˜Ÿ":"shooting star","è™¹":"rainbow","é›·":"lightning","é›ª":"snow","é›¨":"rain","åµ":"storm","éœ§":"fog","æ°·":"ice","ç«":"fire","æ°´":"water","é¢¨":"wind","å…‰":"light","å½±":"shadow","å¤œ":"night","æœ":"morning","å¤•æ–¹":"evening","èµ¤":"red","é’":"blue","ç·‘":"green","é»„è‰²":"yellow","ç™½":"white","é»’":"black","ç´«":"purple","ãƒ”ãƒ³ã‚¯":"pink","ã‚ªãƒ¬ãƒ³ã‚¸":"orange","èŒ¶è‰²":"brown","ã‚°ãƒ¬ãƒ¼":"gray","é‡‘":"gold","éŠ€":"silver","ãƒ—ãƒ©ãƒãƒŠ":"platinum","éŠ…":"copper","é‰„":"iron","çŸ³":"stone","æœ¨æ":"wood","ã‚¬ãƒ©ã‚¹":"glass","æ°´æ™¶":"crystal","ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰":"diamond","é³¥":"bird","ã¨ã‚Š":"bird","ãƒˆãƒª":"bird"};function l(){const e={};for(const[t,n]of Object.entries(s))e[t]||(e[t]=[]),e[t].includes(n)||e[t].push(n);return e}function c(e){return s[e]||e}function d(e,t,n){const i=t.toLowerCase();if(i.includes(e.toLowerCase()))return!0;for(const[t,o]of Object.entries(n))if(e.includes(t))for(const e of o)if(i.includes(e.toLowerCase()))return!0;const o=c(e);return!(o===e||!i.includes(o.toLowerCase()))}"undefined"!=typeof module&&module.exports&&(module.exports={TRANSLATION_DICTIONARY:s,createObjectKeywords:l,translateKeyword:c,matchKeywordWithFilename:d});class p{constructor(e,t={}){if(!e)throw new Error("THREE.Scene is required");this.scene=e,this.camera=t.camera||null,this.renderer=t.renderer||null,this.labelRenderer=null,this.client=t.client||new o(t.serverUrl),this.experimentGroup=new i.Group,this.experimentGroup.name="LiveExperiments",this.scene.add(this.experimentGroup),this.commandHistory=[],this.spawnedObjects=new Map,this.objectCounter=0,this.selectedObject=null,this.selectedImageService=t.selectedImageService||null,this.selectedVideoService=t.selectedVideoService||null,this.audioControls=new Map,this.audioControlUpdateInterval=null,this.audioControlUpdateListener=null,this.clock=new i.Clock,this.raycaster=new i.Raycaster,this.mouse=new i.Vector2,this.lastHoveredObject=null,this.config={showLocationIndicator:!1!==t.showLocationIndicator,indicatorDuration:t.indicatorDuration||3e3,defaultObjectScale:t.defaultObjectScale||1,enableObjectSelection:!1!==t.enableObjectSelection,enableMouseInteraction:t.enableMouseInteraction,enableDebugLogging:!0===t.enableDebugLogging,...t.config},this.setupClickEvents(),console.log("ğŸ§ª SceneManager initialized with click selection"),"undefined"!=typeof globalThis&&(globalThis.sceneManager=this)}setupClickEvents(){!0===this.config.enableMouseInteraction&&this.renderer?(this.setupObjectDragging(),console.log("ğŸ–±ï¸ Mouse interaction enabled - Click to select, Shift+drag to move objects")):!0!==this.config.enableMouseInteraction||this.renderer?console.log("ğŸ–±ï¸ Mouse interaction disabled (safe mode). Set enableMouseInteraction: true to enable."):console.warn("âš ï¸ Mouse interaction requested but renderer not provided. Mouse interaction disabled.")}debugSceneInfo(){console.log("ğŸ” === SCENE DEBUG INFO ==="),this.camera&&console.log(`ğŸ“· Camera:\n        - Position: (${this.camera.position.x.toFixed(2)}, ${this.camera.position.y.toFixed(2)}, ${this.camera.position.z.toFixed(2)})\n        - Rotation: (${(180*this.camera.rotation.x/Math.PI).toFixed(1)}Â°, ${(180*this.camera.rotation.y/Math.PI).toFixed(1)}Â°, ${(180*this.camera.rotation.z/Math.PI).toFixed(1)}Â°)\n        - FOV: ${this.camera.fov||"N/A"}\n        - Near/Far: ${this.camera.near||"N/A"}/${this.camera.far||"N/A"}`),console.log(`ğŸŒ³ Scene hierarchy:\n      - Total objects in scene: ${this.scene.children.length}\n      - experimentGroup exists: ${this.scene.getObjectByName("LiveExperiments")?"Yes":"No"}\n      - experimentGroup children: ${this.experimentGroup.children.length}`),console.log(`ğŸ“¦ Spawned objects: ${this.spawnedObjects.size}`),this.spawnedObjects.forEach((e,t)=>{const n=new i.Vector3;if(e.getWorldPosition(n),console.log(`  - ${t} (${e.userData.type}): \n        Local: (${e.position.x.toFixed(2)}, ${e.position.y.toFixed(2)}, ${e.position.z.toFixed(2)})\n        World: (${n.x.toFixed(2)}, ${n.y.toFixed(2)}, ${n.z.toFixed(2)})\n        Visible: ${e.visible}, Scale: ${e.scale.x.toFixed(2)}`),"generated_3d_model"===e.userData.type){const t=(new i.Box3).setFromObject(e),n=t.getSize(new i.Vector3),o=t.getCenter(new i.Vector3);console.log(`    ğŸ“ Bounding box - Center: (${o.x.toFixed(2)}, ${o.y.toFixed(2)}, ${o.z.toFixed(2)}), Size: (${n.x.toFixed(2)}, ${n.y.toFixed(2)}, ${n.z.toFixed(2)})`);let a=0;e.traverse(e=>{e.isMesh&&a++}),console.log(`    ğŸ­ Meshes: ${a}`)}}),this.camera&&this.spawnedObjects.size>0&&(console.log("ğŸ“ Distances from camera:"),this.spawnedObjects.forEach((e,t)=>{const n=this.camera.position.distanceTo(e.position);console.log(`  - ${t}: ${n.toFixed(2)} units`)})),console.log("=========================")}selectObject(e){if(this.selectedObject!==e&&(this.deselectObject(),this.selectedObject=e,this.createModernSelectionIndicator(e),console.log(`âœ… Selected object: ${e.name}`),this.commandUI)){const t=e.userData||{};if(this.commandUI.addOutput(`ğŸ“ é¸æŠ: ${e.name}`,"info"),t.prompt&&this.commandUI.addOutput(`   ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${t.prompt}`,"hint"),t.modelName&&this.commandUI.addOutput(`   ãƒ¢ãƒ‡ãƒ«: ${t.modelName}`,"hint"),"delete"===this.commandUI.currentMode){const n=t.originalPrompt||e.name||"é¸æŠã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ";this.commandUI.input.value=`${n}ã‚’å‰Šé™¤`,this.commandUI.input.focus(),this.commandUI.input.setSelectionRange(this.commandUI.input.value.length,this.commandUI.input.value.length),this.commandUI.addOutput(`ğŸ¯ å‰Šé™¤å¯¾è±¡è¨­å®š: ${n}`,"system")}}}createModernSelectionIndicator(e){const t=e.getObjectByName("selectionIndicator");t&&e.remove(t);const n=new i.Group;n.name="selectionIndicator";const o=(new i.Box3).setFromObject(e),a=o.getSize(new i.Vector3),r=o.getCenter(new i.Vector3),s=new i.Vector3(a.x+.1,a.y+.1,a.z+.1);if(e.geometry&&"PlaneGeometry"===e.geometry.type){const t=e.geometry.parameters.width,o=e.geometry.parameters.height,a=new i.Shape;a.moveTo(-t/2,-o/2),a.lineTo(t/2,-o/2),a.lineTo(t/2,o/2),a.lineTo(-t/2,o/2),a.lineTo(-t/2,-o/2);const r=a.getPoints(),s=(new i.BufferGeometry).setFromPoints(r),l=this.getAdaptiveSelectionColor(),c=new i.LineBasicMaterial({color:l,linewidth:2,transparent:!0,opacity:.9}),d=new i.Line(s,c);d.position.set(0,0,.01),n.add(d)}else{const e=new i.EdgesGeometry(new i.BoxGeometry(s.x,s.y,s.z)),t=this.getAdaptiveSelectionColor(),o=new i.LineBasicMaterial({color:t,linewidth:2,transparent:!0,opacity:.9}),a=new i.LineSegments(e,o);a.position.copy(r),n.add(a)}e.add(n),n.position.set(0,0,0),this.addResizeHandles(n,s,r,e)}addResizeHandles(e,t,n,o){if(console.log("ğŸ”§ addResizeHandles called"),!o)return void console.log("âŒ No parent object provided");if(!o.geometry)return void console.log("âŒ Parent has no geometry");if("PlaneGeometry"!==o.geometry.type)return void console.log(`âŒ Geometry type is ${o.geometry.type}, not PlaneGeometry`);console.log("âœ… PlaneGeometry detected, creating handles");const a=.15,r=new i.BoxGeometry(a,a,a),s=this.getAdaptiveSelectionColor(),l=new i.MeshBasicMaterial({color:s,transparent:!0,opacity:.8,depthTest:!1,depthWrite:!1}),c=new i.MeshBasicMaterial({color:this.getAdaptiveHoverColor(),transparent:!0,opacity:1,depthTest:!1,depthWrite:!1}),d=o.geometry.parameters.width,p=o.geometry.parameters.height;[{x:d/2,y:p/2,z:.1,corner:"top-right"},{x:-d/2,y:p/2,z:.1,corner:"top-left"},{x:d/2,y:-p/2,z:.1,corner:"bottom-right"},{x:-d/2,y:-p/2,z:.1,corner:"bottom-left"}].forEach((t,n)=>{const o=new i.Mesh(r,l.clone());o.position.set(t.x,t.y,t.z),o.userData={isResizeHandle:!0,handleIndex:n,corner:t.corner,defaultMaterial:o.material,hoverMaterial:c.clone()},o.renderOrder=1001,o.onHover=()=>{o.material=o.userData.hoverMaterial,o.scale.setScalar(1.5),document.body.style.cursor="nw-resize"},o.onHoverExit=()=>{o.material=o.userData.defaultMaterial,o.scale.setScalar(1),document.body.style.cursor="default"},e.add(o),console.log(`ğŸ”´ Added resize handle at ${t.corner}`)})}updateSelectionIndicatorScale(e){}deselectObject(){if(this.selectedObject){const e=this.selectedObject.getObjectByName("selectionIndicator");e&&(this.selectedObject.remove(e),e.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())})),console.log(`âœ… Deselected: ${this.selectedObject.name}`),this.selectedObject=null}}setupObjectDragging(){if(!this.renderer)return;const e=this.renderer.domElement;let t=!1,n=null,o=new i.Vector3,a=new i.Vector2,r="move",s=new i.Vector3;e.addEventListener("mousedown",i=>{if(0!==i.button)return;const l=e.getBoundingClientRect();this.mouse.x=(i.clientX-l.left)/l.width*2-1,this.mouse.y=-(i.clientY-l.top)/l.height*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const c=this.raycaster.intersectObjects(this.experimentGroup.children,!0);if(c.length>0){const l=c[0].object;if(l.userData&&l.userData.isResizeHandle)return t=!0,n=this.selectedObject,r="resize",this.resizeHandleInfo={corner:l.userData.corner,handleIndex:l.userData.handleIndex},s.copy(n.scale),a.set(i.clientX,i.clientY),e.style.cursor="nw-resize",void console.log(`ğŸ”„ Started resizing: ${n.name} from ${l.userData.corner}`);if(l.userData&&l.userData.isRotateHandle)return void console.log(`ğŸ”„ Rotation handle clicked for: ${this.selectedObject.name}`);if(!l.userData||"generated_image"!==l.userData.type&&"generated_video"!==l.userData.type&&"generated_3d_model"!==l.userData.type&&"imported_file"!==l.userData.source)this.selectObject(l);else{if(this.commandUI&&"delete"===this.commandUI.currentMode){const e=l.name;return console.log(`ğŸ—‘ï¸ Delete mode: clicked on ${e}`),void this.commandUI.showDeleteConfirmation(`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€Œ${e}ã€ã‚’å‰Šé™¤`).then(t=>{t?(this.removeObject(e),this.commandUI.addOutput(`ğŸ—‘ï¸ å‰Šé™¤å®Œäº†: ${e}`,"success")):this.commandUI.addOutput(`âŒ å‰Šé™¤ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ${e}`,"info")}).catch(t=>{console.error("Delete confirmation error:",t),this.commandUI.addOutput(`âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e}`,"error")})}t=!0,n=l,r="move",o.copy(c[0].point).sub(l.position),a.set(i.clientX,i.clientY),l.material,e.style.cursor="move",console.log(`ğŸ”„ Started moving: ${l.name} (Shift-free interaction)`),this.selectObject(l)}}else this.deselectObject()}),e.addEventListener("mousemove",o=>{if(!t)return void this.handleHoverEffects(o,e);if(!n)return;const l=o.clientX-a.x,c=o.clientY-a.y;if("resize"===r){if(!this.resizeHandleInfo)return void console.error("âŒ Resize handle info missing");let e=1;switch(this.resizeHandleInfo.corner){case"top-right":e=l>0&&c<0?1+.001*(Math.abs(l)+Math.abs(c)):1-.001*(Math.abs(l)+Math.abs(c));break;case"top-left":e=l<0&&c<0?1+.001*(Math.abs(l)+Math.abs(c)):1-.001*(Math.abs(l)+Math.abs(c));break;case"bottom-right":e=l>0&&c>0?1+.001*(Math.abs(l)+Math.abs(c)):1-.001*(Math.abs(l)+Math.abs(c));break;case"bottom-left":e=l<0&&c>0?1+.001*(Math.abs(l)+Math.abs(c)):1-.001*(Math.abs(l)+Math.abs(c));break;default:e=1+.001*(l+c)}const t=Math.max(.1,Math.min(5,s.x*e));n.scale.setScalar(t),this.updateSelectionIndicatorScale(n)}else if("move"===r){const e=new i.Vector3,t=new i.Vector3;this.camera.getWorldDirection(new i.Vector3),e.setFromMatrixColumn(this.camera.matrixWorld,0).normalize(),t.setFromMatrixColumn(this.camera.matrixWorld,1).normalize();const r=.01,s=(new i.Vector3).add(e.clone().multiplyScalar(l*r)).add(t.clone().multiplyScalar(-c*r));n.position.add(s),a.set(o.clientX,o.clientY)}}),e.addEventListener("mouseup",()=>{t&&n&&(n.material&&(n.material.opacity=1,n.material.transparent=!1),console.log(`âœ… Finished dragging: ${n.name} to (${n.position.x.toFixed(1)}, ${n.position.y.toFixed(1)}, ${n.position.z.toFixed(1)})`),t=!1,n=null,r="move",this.resizeHandleInfo=null,e.style.cursor="default")}),e.addEventListener("wheel",t=>{t.preventDefault();const n=e.getBoundingClientRect(),o=new i.Vector2;o.x=(t.clientX-n.left)/n.width*2-1,o.y=-(t.clientY-n.top)/n.height*2+1,this.raycaster.setFromCamera(o,this.camera);const a=this.raycaster.intersectObjects(this.experimentGroup.children,!0);if(a.length>0){const e=a[0].object;if(e.userData&&("generated_image"===e.userData.type||"generated_video"===e.userData.type||"generated_3d_model"===e.userData.type)){const n=t.deltaY>0?.9:1.1,i=e.scale.x*n;i>=.2&&i<=5&&(e.scale.setScalar(i),e.material&&(e.material.emissive.setHex(3355443),setTimeout(()=>{e.material&&e.material.emissive.setHex(0)},150)),console.log(`ğŸ”„ Resized ${e.userData.type}: ${e.name} to scale ${i.toFixed(2)} (Shift-free interaction)`))}}}),document.addEventListener("keydown",e=>{const t=document.activeElement;if(t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable))return;if(!this.selectedObject)return;const n=this.selectedObject;if(!n.userData||"generated_image"!==n.userData.type&&"generated_video"!==n.userData.type)return;const o=Math.PI/36;let a=!1;switch(e.key){case"ArrowLeft":n.rotation.y-=o,a=!0;break;case"ArrowRight":n.rotation.y+=o,a=!0;break;case"ArrowUp":const t=n.rotation.x-o;t>=-Math.PI/6&&t<=Math.PI/6&&(n.rotation.x=t,a=!0);break;case"ArrowDown":const r=n.rotation.x+o;r>=-Math.PI/6&&r<=Math.PI/6&&(n.rotation.x=r,a=!0);break;case"r":case"R":n.rotation.x=0;const s=new i.Vector3;this.camera.getWorldDirection(s);const l=n.position.clone().add(s.multiplyScalar(-1));n.lookAt(l),n.rotation.x=0,a=!0,console.log(`ğŸ”„ Reset rotation for: ${n.name}`);break;case"i":case"I":this.debugSceneInfo(),e.preventDefault()}if(a){e.preventDefault();const t={x:(180*n.rotation.x/Math.PI).toFixed(1),y:(180*n.rotation.y/Math.PI).toFixed(1),z:(180*n.rotation.z/Math.PI).toFixed(1)};console.log(`ğŸ”„ Rotated ${n.userData.type}: ${n.name} to (${t.x}Â°, ${t.y}Â°, ${t.z}Â°)`)}}),console.log("ğŸ–±ï¸ Object dragging system enabled (Drag to move objects - Shift-free interaction)"),console.log("ğŸ”„ Object resizing system enabled (Scroll to resize images/videos - Shift-free interaction)"),console.log("ğŸ¯ Angle adjustment enabled (Select object + Arrow keys to rotate, R to reset)")}handleHoverEffects(e,t){const n=t.getBoundingClientRect();this.mouse.x=(e.clientX-n.left)/n.width*2-1,this.mouse.y=-(e.clientY-n.top)/n.height*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const i=this.raycaster.intersectObjects(this.experimentGroup.children,!0);if(this.lastHoveredObject&&this.lastHoveredObject.onHoverExit&&(this.lastHoveredObject.onHoverExit(),this.lastHoveredObject=null),i.length>0){const e=i[0].object;if(e.userData&&e.userData.isResizeHandle&&e.onHover)return e.onHover(),void(this.lastHoveredObject=e);if(e.userData&&("generated_image"===e.userData.type||"generated_video"===e.userData.type))return t.style.cursor="move",void(this.lastHoveredObject={onHoverExit:()=>{t.style.cursor="default"}})}t.style.cursor="default"}async executeCommand(e){const t=Date.now();console.log(`ğŸ¯ Executing: "${e}"`);try{const n=this.parseCommand(e);console.log("ğŸ“ Parsed:",n);const i=await this.dispatchCommand(n);return this.commandHistory.push({timestamp:t,command:e,parsed:n,result:i,status:"success"}),i}catch(n){throw console.error("âŒ Command execution failed:",n),this.commandHistory.push({timestamp:t,command:e,error:n.message,status:"error"}),n}}parseCommand(e){if(e.startsWith("[å¤‰æ›´] ")){const t=e.replace("[å¤‰æ›´] ","");return this.parseObjectModificationCommand(t.toLowerCase().trim())}if(e.startsWith("[å‰Šé™¤] ")){const t=e.replace("[å‰Šé™¤] ","");return this.parseDeleteCommand(t.toLowerCase().trim())}const t=e.toLowerCase().trim(),n=this.parseNaturalLanguageCommand(t);if(n)return n;const i=t.includes("ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³")&&(t.includes("ä½œã£ã¦")||t.includes("ç”Ÿæˆ")||t.includes("ã‚’")||t.includes("create")||t.includes("make")||t.includes("generate"));if(["å‹•ç”»","ãƒ“ãƒ‡ã‚ª","ãƒ ãƒ¼ãƒ“ãƒ¼","æ˜ åƒ","å‹•ã","video","movie","motion","moving","clip"].some(e=>t.includes(e))||t.includes("animate")&&!t.includes("ã‚’")||i)return{type:"video_generation",prompt:e,position:this.parsePosition(t),size:this.parseSize(t)};if(["é¸æŠ","select","ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ","æ—¢å­˜","existing"].some(e=>t.includes(e)))return{type:"object_selection",position:this.parsePosition(t)};if(["ã‚¤ãƒ³ãƒãƒ¼ãƒˆ","import","èª­ã¿è¾¼","èª­è¾¼","ãƒ•ã‚¡ã‚¤ãƒ«","file","ç”»åƒã‚’é¸æŠ","å‹•ç”»ã‚’é¸æŠ","é¸æŠã—ã¦é…ç½®"].some(e=>t.includes(e))){return{type:"file_import",fileType:t.includes("å‹•ç”»")||t.includes("video")||t.includes("mp4")?"video":"image",position:this.parsePosition(t),size:this.parseSize(t)}}return["ç”»åƒ","å†™çœŸ","ã‚¤ãƒ¡ãƒ¼ã‚¸","çµµ","ãƒ”ã‚¯ãƒãƒ£ãƒ¼","image","picture","photo","generate","create","make","draw"].some(e=>t.includes(e)),{type:"image_generation",prompt:e,position:this.parsePosition(t),size:this.parseSize(t)}}getObjectKeywords(){return l()}normalizeTargetPhrase(e){if(!e)return"";let t=`${e}`.trim();t=t.replace(/[ã€‚ã€ï¼Œ,.!?ï¼ï¼Ÿ]/g," ").trim();const n=/^(ã•ã£ã|å…ˆã»ã©|ç›´å‰|æœ€è¿‘|ã“ã®å‰|ãã®|ã‚ã®|ã“ã®|å‰å›|å‰ã®|æœ€æ–°|æœ€å¾Œ|last|latest)\s*(ã®)?/i;for(;n.test(t);)t=t.replace(n,"").trim();t=t.replace(/(ã—ã¦ãã ã•ã„|ã—ã¦ä¸‹ã•ã„|ã—ã¦ã­|ã—ã¦ã‚ˆ|ã—ã¦ãã‚Œ|ã—ã¦ãã‚Œã¾ã›ã‚“ã‹|ã—ã¦ãã ã•ã„ã­|ã—ã¦ãã ã•ã„ã‚ˆ|ãŠé¡˜ã„ã—ã¾ã™?|ãŠé¡˜ã„|é ¼ã‚€)$/i,"").trim();const i=[/(ã‚’)?(å·¦å³åè»¢|åè»¢|å‰Šé™¤|æ¶ˆã—ã¦|æ¶ˆã™|å¤‰æ›´|å¤‰ãˆã¦|å¡—ã‚Šæ›¿ãˆã¦|å¡—ã£ã¦|å›è»¢|å›ã—ã¦|ç§»å‹•|å‹•ã‹ã—ã¦|æ‹¡å¤§|ç¸®å°|å¤§ãã|å°ã•ã|ä¸¦ã¹|å¯„ã›ã¦|æ•´åˆ—|é¸æŠ|é¸ã‚“ã§|æŒ‡å®š|ç”Ÿæˆ|ä½œã£ã¦|æã„ã¦|ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰|ã‚¢ãƒƒãƒ—ã—ã¦|èª­ã¿è¾¼ã‚“ã§|èª­ã¿è¾¼ã‚“ã |é–‹ã„ã¦|é–‰ã˜ã¦|ç½®ã„ã¦|é…ç½®ã—ã¦|è²¼ã‚Šä»˜ã‘ã¦|flip|delete|remove|change|make|turn|rotate|move|scale|resize|generate|create).*$/i,/(ã‚’|ã«|ã¸|ã§|ã‹ã‚‰|ã¾ã§|ã¨|ã‚„|ã£ã¦)$/i];for(const e of i)t=t.replace(e,"").trim();if(t=t.replace(/(ã‚’|ã«|ã¸|ã§|ã‹ã‚‰|ã¾ã§|ã¨|ã‚„|ã£ã¦)$/i,"").trim(),!t){const n=/^(flip|delete|remove|change|make|turn|rotate|move|scale|resize|generate|create)\s+/i;n.test(e.trim())&&(t=e.trim().replace(n,"").trim())}return t=t.replace(/(ã‚’|ã«|ã¸|ã§|ã‹ã‚‰|ã¾ã§|ã¨|ã‚„|ã£ã¦)$/i,"").trim(),t}isReferentialCommand(e){return!!e&&/(ã•ã£ã|å…ˆã»ã©|ç›´å‰|æœ€è¿‘|å‰å›|å‰ã®|æœ€å¾Œ|æœ€æ–°|last|previous|before)/i.test(e)}getObjectSourceType(e){return e&&e.userData&&(e.userData.source||e.userData.type)||null}getRecentObjects(e){const t=Array.from(this.spawnedObjects.values());if(0===t.length)return[];const n=/(ã‚¤ãƒ³ãƒãƒ¼ãƒˆ|å–ã‚Šè¾¼|ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰|èª­ã¿è¾¼)/.test(e),i=/(ç”Ÿæˆ|ä½œã£|æã„|create|generate)/.test(e);let o=t;return n?o=o.filter(e=>"imported_file"===this.getObjectSourceType(e)):i&&(o=o.filter(e=>{const t=this.getObjectSourceType(e);return"generated_image"===t||"generated_video"===t})),0===o.length&&(o=t),o.sort((e,t)=>{const n=e.userData?.lastModified||e.userData?.createdAt||0;return(t.userData?.lastModified||t.userData?.createdAt||0)-n})}findRecentObjectByContext(e,t,n){const i=this.getRecentObjects(e);if(0===i.length)return null;if(t)for(const e of i)if(this.matchesObjectName(e,t,n))return e;return i[0]}extractTextTokens(e){return e?e.replace(/[ã€‚ã€ï¼Œ,.!?ï¼ï¼Ÿ]/g," ").split(/[\s_/\-]+/).map(e=>e.trim()).filter(e=>e.length>1):[]}buildObjectKeywordHints({prompt:e="",fileName:t="",baseType:n=null}={}){const i=new Set;if(e){i.add(e.toLowerCase());for(const t of this.extractTextTokens(e))i.add(t.toLowerCase())}if(t){const e=t.replace(/\.[^/.]+$/,"");i.add(e.toLowerCase());for(const t of this.extractTextTokens(e))i.add(t.toLowerCase())}return"image"===n?["image","photo","picture","ç”»åƒ","å†™çœŸ","ã‚¤ãƒ¡ãƒ¼ã‚¸"].forEach(e=>i.add(e)):"video"===n&&["video","movie","clip","å‹•ç”»","ãƒ“ãƒ‡ã‚ª","ãƒ ãƒ¼ãƒ“ãƒ¼","æ˜ åƒ"].forEach(e=>i.add(e)),Array.from(i).filter(Boolean)}findObjectByKeyword(e){const t=this.getObjectKeywords(),n=this.normalizeTargetPhrase(e),i=e.match(/((\d+)ç•ªç›®|æœ€åˆ|åˆå›|1ç•ªç›®)ã«(ã‚¤ãƒ³ãƒãƒ¼ãƒˆ|å–ã‚Šè¾¼)ã—ãŸ(.+)/);if(i){let e=1;i[2]?e=parseInt(i[2]):("æœ€åˆ"===i[1]||"åˆå›"===i[1]||"1ç•ªç›®"===i[1])&&(e=1);const n=this.normalizeTargetPhrase(i[4])||i[4].trim();return this.findImportedObjectByOrder(n,e,t)}const o=e.match(/(ã‚¤ãƒ³ãƒãƒ¼ãƒˆ|å–ã‚Šè¾¼|ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰|èª­ã¿è¾¼|ç”Ÿæˆ|ä½œã£ãŸ)ã—ãŸ?(.+)/);if(o){const e=o[1],n=this.normalizeTargetPhrase(o[2])||o[2].trim(),i="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"===e||"å–ã‚Šè¾¼"===e;return this.findObjectBySourceAndName(n,i,t)}if(this.isReferentialCommand(e)){const i=this.findRecentObjectByContext(e,n,t);if(i)return i}return this.findObjectByName(n||e,t)}findImportedObjectByOrder(e,t,n){const i=[];for(const e of this.spawnedObjects.values())e.userData&&"imported_file"===this.getObjectSourceType(e)&&i.push(e);i.sort((e,t)=>(e.userData.importOrder||0)-(t.userData.importOrder||0));const o=e?i.filter(t=>this.matchesObjectName(t,e,n)):i;if(o.length>=t){const n=o[t-1];return console.log(`ğŸ¯ Found ${t}ç•ªç›® imported object "${e}": ${n.name}`),n}return console.warn(`âš ï¸ ${t}ç•ªç›®ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸ"${e}"ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`),null}findObjectBySourceAndName(e,t,n){for(const i of this.spawnedObjects.values()){if(!i.userData)continue;const o=this.getObjectSourceType(i);if((!t||"imported_file"===o)&&((t||("generated_image"===o||"generated_video"===o))&&this.matchesObjectName(i,e,n))){const n=t?"ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸ":"ç”Ÿæˆã—ãŸ";return console.log(`ğŸ¯ Found ${n} object "${e}": ${i.name}`),i}}const i=t?"ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸ":"ç”Ÿæˆã—ãŸ";return console.warn(`âš ï¸ ${i}"${e}"ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`),null}findObjectByName(e,t){const n=e&&e.trim();if(!n)return null;for(const e of this.spawnedObjects.values())if(e&&this.matchesObjectName(e,n,t))return e;return null}matchesObjectName(e,t,n){if(!e||!t)return!1;const i=t.toLowerCase();if(e.userData&&Array.isArray(e.userData.keywords))for(const t of e.userData.keywords){if(!t)continue;const e=t.toLowerCase();if(i.includes(e)||e.includes(i))return!0}for(const[e,t]of Object.entries(n)){const n=e.toLowerCase();if(i.includes(n))return!0;for(const e of t){const t=e.toLowerCase();if(i.includes(t))return!0}}if(e.userData&&e.userData.prompt){const t=e.userData.prompt.toLowerCase();if(t.includes(i)||i.includes(t))return!0}return!!(e.userData&&e.userData.fileName&&d(t,e.userData.fileName,n))}parseImageGenerationCommand(e){let t=e;const n=["ã‚’","ã«","ã§","ã®"];for(const i of n)if(e.includes(i)){const n=e.split(i);if(n[0]){t=n[0].trim();break}}return t=t.replace(/(ç”»åƒ|ä½œã£ã¦|ç”Ÿæˆ|ã—ã¦|ãã ã•ã„)/g,"").trim(),{type:"image_generation",prompt:t,position:this.parsePosition(e),size:this.parseSize(e)}}parseObjectModificationCommand(e){const t=e.toLowerCase().trim();let n=null;const i={"èµ¤":16711680,"èµ¤è‰²":16711680,"é’":255,"é’è‰²":255,"ç·‘":65280,"ç·‘è‰²":65280,"é»„":16776960,"é»„è‰²":16776960,"é»„è‰²ã„":16776960,"ç´«":16711935,"ç´«è‰²":16711935,"æ©™":16746496,"æ©™è‰²":16746496,"ã‚ªãƒ¬ãƒ³ã‚¸":16746496,"ã‚ªãƒ¬ãƒ³ã‚¸è‰²":16746496,"ç™½":16777215,"ç™½è‰²":16777215,"é»’":0,"é»’è‰²":0,"ç°":8421504,"ç°è‰²":8421504,"ã‚°ãƒ¬ãƒ¼":8421504,"ã‚°ãƒ¬ãƒ¼è‰²":8421504,"ãƒ”ãƒ³ã‚¯":16761035,"ãƒ”ãƒ³ã‚¯è‰²":16761035,"èŒ¶":9127187,"èŒ¶è‰²":9127187,"éŠ€":12632256,"éŠ€è‰²":12632256,"é‡‘":16766720,"é‡‘è‰²":16766720};for(const[e,o]of Object.entries(i))if(t.includes(e)){n=o;break}const o=this.parseEffects(t);let a=null;if(t.includes("å¤§ãã")||t.includes("æ‹¡å¤§"))a=1.5;else if(t.includes("å°ã•ã")||t.includes("ç¸®å°"))a=.7;else if(t.includes("å€")){const e=t.match(/(\d+(?:\.\d+)?)\s*å€/);e&&(a=parseFloat(e[1]))}let r=null;(t.includes("ç§»å‹•")||t.includes("å‹•ã‹")||t.includes("ã¸"))&&(r=this.parsePositionFromPrompt(t));let s=null;if(t.includes("å›è»¢")||t.includes("å›ã™")||t.includes("å›ã—ã¦")||t.includes("rotate")){const e=t.match(/(\d+)\s*åº¦/);s=e?parseFloat(e[1])*Math.PI/180:Math.PI/4}let l=null;t.includes("é€æ˜")||t.includes("transparent")?l=t.includes("åŠé€æ˜")?.5:.3:(t.includes("ä¸é€æ˜")||t.includes("opaque"))&&(l=1);let c=null;return(t.includes("å·¦å³åè»¢")||t.includes("åè»¢")||t.includes("ã²ã£ãã‚Šè¿”")||t.includes("flip"))&&(c=!0),{type:"object_modification",command:e,color:n,scale:a,movement:r,rotation:s,opacity:l,flip:c,effects:o,requiresSelection:!0}}parseEffects(e){const t=[],n={"é€æ˜":{type:"opacity",value:0,name:"transparent"},"åŠé€æ˜":{type:"opacity",value:.5,name:"semi_transparent"},"ä¸é€æ˜":{type:"opacity",value:1,name:"opaque"},"æ¿ƒã":{type:"opacity",value:1,name:"solid"},"å…‰ã‚‰ã›":{type:"glow",color:16777215,intensity:.5,name:"glow_white"},"å…‰ã‚‹":{type:"glow",color:16777215,intensity:.5,name:"glow_white"},"ãƒã‚ªãƒ³":{type:"glow",color:65535,intensity:.8,name:"neon_cyan"},"ãƒ›ãƒ­ã‚°ãƒ©ãƒ ":{type:"glow",color:65535,intensity:.6,name:"hologram"},"ãƒ¡ã‚¿ãƒªãƒƒã‚¯":{type:"material",metalness:.8,roughness:.2,name:"metallic"},"é‡‘å±è³ª":{type:"material",metalness:.9,roughness:.1,name:"metallic_shiny"},"ã‚¬ãƒ©ã‚¹":{type:"material",metalness:0,roughness:0,name:"glass"},"ãƒãƒƒãƒˆ":{type:"material",metalness:0,roughness:1,name:"matte"},"ãµã‚ãµã‚":{type:"animation",animation:"float",speed:.002,amplitude:.5,name:"float_gentle"},"æµ®ã":{type:"animation",animation:"float",speed:.003,amplitude:.8,name:"float_strong"},"æ¼‚ã†":{type:"animation",animation:"float",speed:.001,amplitude:.3,name:"float_slow"},"ãƒ‰ã‚¯ãƒ‰ã‚¯":{type:"animation",animation:"pulse",speed:.003,amplitude:.15,name:"pulse_heartbeat"},"é¼“å‹•":{type:"animation",animation:"pulse",speed:.0025,amplitude:.1,name:"pulse_heart"},"è„ˆå‹•":{type:"animation",animation:"pulse",speed:.004,amplitude:.2,name:"pulse_throb"},"ãã‚‹ãã‚‹":{type:"animation",animation:"spin",speed:.02,axis:"y",name:"spin_y"},"ã‚¹ãƒ”ãƒ³":{type:"animation",animation:"spin",speed:.03,axis:"y",name:"spin_fast"},"å›ã‚‹":{type:"animation",animation:"spin",speed:.015,axis:"y",name:"spin_slow"},"ãã‚‰ã‚":{type:"animation",animation:"sparkle",intensity:.8,name:"sparkle"},"è¼":{type:"animation",animation:"sparkle",intensity:1,name:"shine"},"ã‚­ãƒ©ã‚­ãƒ©":{type:"animation",animation:"sparkle",intensity:.9,name:"twinkle"},"å®‡å®™":{type:"cosmic",colors:[4474111,16729224,4521898],intensity:.9,name:"cosmic"},"ã‚ªãƒ¼ãƒ­ãƒ©":{type:"aurora",colors:[65450,4491519,16746666],intensity:.8,name:"aurora"},"æ˜Ÿé›²":{type:"nebula",colors:[8930559,16746564,4500223],intensity:1,name:"nebula"},"ã‚¨ãƒãƒ«ã‚®ãƒ¼":{type:"energy",colors:[16755200,43775,11141375],intensity:.7,name:"energy"},"ç¥ç§˜çš„":{type:"mystic",colors:[11158783,16729258,4521983],intensity:.6,name:"mystic"},"æ°´å½©":{type:"watercolor_art",colors:[16739229,5164484,16770669,9822675],opacity:.6,name:"watercolor"},"æ°´å½©ç”»":{type:"watercolor_art",colors:[16739229,5164484,16770669,9822675],opacity:.6,name:"watercolor"},"ãƒ‘ã‚¹ãƒ†ãƒ«":{type:"pastel_art",colors:[16757690,16768954,16777146,12255177,12247551],opacity:.7,name:"pastel"},"è™¹è‰²":{type:"rainbow_glow",colors:[16711680,16746496,16776960,65280,35071,255,8913151],intensity:.5,name:"rainbow_glow"}},i={"é­”æ³•ã£ã½ã":[{type:"glow",color:13387007,intensity:.7,name:"magic_glow"},{type:"animation",animation:"pulse",speed:.003,amplitude:.1,name:"magic_pulse"},{type:"animation",animation:"sparkle",intensity:.6,name:"magic_sparkle"}],"å¹½éœŠ":[{type:"opacity",value:.6,name:"ghost_transparent"},{type:"animation",animation:"float",speed:.002,amplitude:.4,name:"ghost_float"},{type:"glow",color:16777215,intensity:.3,name:"ghost_aura"}],"ã‚µã‚¤ãƒãƒ¼":[{type:"glow",color:65450,intensity:.8,name:"cyber_glow"},{type:"material",metalness:.8,roughness:.1,name:"cyber_metal"},{type:"animation",animation:"glitch",intensity:.1,name:"cyber_glitch"}],"å¤¢ã¿ãŸã„":[{type:"opacity",value:.7,name:"dream_soft"},{type:"animation",animation:"float",speed:.0015,amplitude:.3,name:"dream_float"},{type:"animation",animation:"rainbow",speed:.001,name:"dream_rainbow"}]};for(const[n,o]of Object.entries(i))e.includes(n)&&(t.push(...o),console.log(`âœ¨ Preset effect applied: ${n}`));const o=this.requiresChromaKey(e),a=o?this.detectChromaKeyConfig(e):null,r=null!==a;for(const[i,o]of Object.entries(n))r&&"é€æ˜"===i||e.includes(i)&&(t.push(o),console.log(`ğŸ­ Effect detected: ${i} -> ${o.name}`));return o&&(r?(t.push({type:"chroma_key",color:a.color,threshold:a.threshold,smoothing:a.smoothing,name:"chroma_key"}),console.log(`ğŸª„ Chroma key requested (color: #${a.color.toString(16)}, threshold: ${a.threshold})`)):this.commandUI&&this.commandUI.showInputFeedback("èƒŒæ™¯ã‚’é€éã™ã‚‹ã«ã¯èƒŒæ™¯è‰²ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€ŒèƒŒæ™¯ã®ç™½ã‚’é€éã—ã¦ã€ï¼‰","info")),t}requiresChromaKey(e){if(!e)return!1;if(["ã‚¯ãƒ­ãƒã‚­ãƒ¼","ã‚°ãƒªãƒ¼ãƒ³ãƒãƒƒã‚¯","remove background","transparent background"].some(t=>e.includes(t)))return!0;return!(!["èƒŒæ™¯ã‚’","èƒŒæ™¯ã®","èƒŒæ™¯"].some(t=>e.includes(t))||!["é€é","é€æ˜","æ¶ˆ","æŠœ","ãªãã—ã¦"].some(t=>e.includes(t)))}detectChromaKeyConfig(e){const t=this.detectChromaKeyColor(e);if(null===t)return null;let n;switch(t){case 16777215:n=.12;break;case 0:n=.14;break;case 65280:n=.32;break;case 255:n=.3;break;default:n=.2}return{color:t,threshold:n,smoothing:.1}}detectChromaKeyColor(e){const t=e.match(/#([0-9a-fA-F]{6})/);if(t)return parseInt(t[1],16);const n=[{tokens:["ç™½","ãƒ›ãƒ¯ã‚¤ãƒˆ","ã—ã‚"],value:16777215},{tokens:["é»’","ãƒ–ãƒ©ãƒƒã‚¯","ãã‚"],value:0},{tokens:["ç·‘","ã‚°ãƒªãƒ¼ãƒ³","ã¿ã©ã‚Š"],value:65280},{tokens:["é’","ãƒ–ãƒ«ãƒ¼","ã‚ãŠ"],value:255},{tokens:["èµ¤","ãƒ¬ãƒƒãƒ‰","ã‚ã‹"],value:16711680},{tokens:["é»„","ã‚¤ã‚¨ãƒ­ãƒ¼","ãã„ã‚"],value:16776960},{tokens:["ãƒ”ãƒ³ã‚¯"],value:16761035},{tokens:["ã‚ªãƒ¬ãƒ³ã‚¸"],value:16746496}];for(const t of n)if(t.tokens.some(t=>e.includes(t)))return t.value;return e.includes("ã‚°ãƒªãƒ¼ãƒ³ãƒãƒƒã‚¯")?65280:null}applyEffects(e,t){let n=!1;for(const i of t)switch(console.log(`âœ¨ Applying effect: ${i.name} (${i.type})`),i.type){case"opacity":n=this.applyOpacityEffect(e,i)||n;break;case"glow":n=this.applyGlowEffect(e,i)||n;break;case"material":n=this.applyMaterialEffect(e,i)||n;break;case"animation":n=this.applyAnimationEffect(e,i)||n;break;case"cosmic":case"aurora":case"nebula":case"energy":case"mystic":case"rainbow_glow":n=this.applyCosmicEffect(e,i)||n;break;case"watercolor_art":case"pastel_art":n=this.applyWatercolorEffect(e,i)||n;break;case"chroma_key":n=this.applyChromaKeyEffect(e,i)||n;break;default:console.warn(`ğŸš« Unknown effect type: ${i.type}`)}return n}applyOpacityEffect(e,t){return!!e.material&&(e.material.transparent=!0,e.material.opacity=t.value,e.material.needsUpdate=!0,console.log(`ğŸ‘» Opacity set to: ${t.value} (${t.name})`),!0)}applyGlowEffect(e,t){if(!e.material)return!1;if(this.ensureEmissiveSupport(e))return e.material.emissive=new i.Color(t.color),e.material.emissiveIntensity=t.intensity,e.material.needsUpdate=!0,console.log(`ğŸ’¡ Glow applied: color=0x${t.color.toString(16)}, intensity=${t.intensity}`),!0;const n=new i.Color(t.color);return e.userData.originalColor||(e.userData.originalColor=e.material.color?e.material.color.clone():null),e.material.color?(e.material.color.lerp(n,.4),e.material.needsUpdate=!0,console.log("ğŸ’¡ Glow fallback applied via color tint"),!0):(console.warn("ğŸš« Glow effect could not be applied"),!1)}ensureEmissiveSupport(e){const t=e.material;return!!t&&("emissive"in t&&void 0!==t.emissive)}applyMaterialEffect(e,t){return!!e.material&&("MeshStandardMaterial"===e.material.type?(void 0!==t.metalness&&(e.material.metalness=t.metalness),void 0!==t.roughness&&(e.material.roughness=t.roughness),e.material.needsUpdate=!0,console.log(`ğŸ”© Material updated: metalness=${t.metalness}, roughness=${t.roughness}`),!0):(console.warn(`ğŸš« Material effect requires StandardMaterial, got: ${e.material.type}`),!1))}applyAnimationEffect(e,t){this.animations||(this.animations=new Map,this.startAnimationLoop());const n=`${e.uuid}_${t.animation}`;this.animations.has(n)&&this.animations.delete(n);const i={object:e,type:t.animation,speed:t.speed,amplitude:t.amplitude||1,axis:t.axis||"y",intensity:t.intensity||1,startTime:Date.now(),originalPosition:{...e.position},originalScale:{...e.scale},originalRotation:{...e.rotation}};return this.animations.set(n,i),console.log(`ğŸ¬ Animation started: ${t.animation} for ${e.name}`),!0}applyCosmicEffect(e,t){if(!e.material)return!1;const n=!this.ensureEmissiveSupport(e);this.animations||(this.animations=new Map,this.startAnimationLoop());const o=`${e.uuid}_${t.type}`;this.animations.has(o)&&this.animations.delete(o),n?e.material.color?(e.userData.originalColor||(e.userData.originalColor=e.material.color.clone()),e.material.color.set(t.colors[0]),e.material.needsUpdate=!0):console.warn("ğŸš« Cosmic fallback could not adjust color"):(e.material.emissive=new i.Color(t.colors[0]),e.material.emissiveIntensity=t.intensity,e.material.needsUpdate=!0);const a={object:e,type:"cosmic",cosmicType:t.type,colors:t.colors,intensity:t.intensity,speed:this.getCosmicSpeed(t.type),startTime:Date.now(),colorIndex:0,originalEmissive:!n&&e.material.emissive?e.material.emissive.clone():null,originalEmissiveIntensity:n?0:e.material.emissiveIntensity||0,useColorFallback:n};return this.animations.set(o,a),console.log(`ğŸŒŒ Cosmic effect started: ${t.type} with ${t.colors.length} colors`),!0}applyChromaKeyEffect(e,t){if(!e.material)return!1;const n=e.material,o=n.map;if(!o)return console.warn("ğŸš« Chroma key requires texture map"),!1;if(n.userData&&n.userData.isChromaKeyMaterial&&n.uniforms)return n.uniforms.keyColor.value.setHex(t.color),n.uniforms.threshold.value=t.threshold,n.uniforms.smoothing.value=t.smoothing,n.needsUpdate=!0,console.log("ğŸ¯ Updated existing chroma key material"),!0;const a=new i.ShaderMaterial({uniforms:{map:{value:o},keyColor:{value:new i.Color(t.color)},threshold:{value:t.threshold},smoothing:{value:t.smoothing}},vertexShader:"varying vec2 vUv;\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragmentShader:"uniform sampler2D map;\nuniform vec3 keyColor;\nuniform float threshold;\nuniform float smoothing;\nvarying vec2 vUv;\nvoid main() {\n  vec4 color = texture2D(map, vUv);\n  float dist = distance(color.rgb, keyColor);\n  float alpha = smoothstep(threshold, threshold + smoothing, dist) * color.a;\n  if (alpha <= 0.0) discard;\n  gl_FragColor = vec4(color.rgb, alpha);\n}",transparent:!0,side:i.DoubleSide,depthTest:n.depthTest,depthWrite:n.depthWrite,toneMapped:!0===n.toneMapped});return a.userData.isChromaKeyMaterial=!0,e.material=a,"function"==typeof n.dispose&&n.dispose(),console.log("ğŸª„ Applied chroma key shader material"),!0}getCosmicSpeed(e){switch(e){case"cosmic":return 5e-4;case"aurora":default:return 8e-4;case"nebula":return 3e-4;case"energy":return.0015;case"mystic":return 6e-4;case"rainbow_glow":return.001}}applyWatercolorEffect(e,t){if(!e.material)return!1;e.material.transparent=!0,e.material.opacity=t.opacity,this.animations||(this.animations=new Map,this.startAnimationLoop());const n=`${e.uuid}_${t.type}`;this.animations.has(n)&&this.animations.delete(n),e.material.color=new i.Color(t.colors[0]),e.material.needsUpdate=!0;const o={object:e,type:"watercolor",artType:t.type,colors:t.colors,opacity:t.opacity,speed:this.getWatercolorSpeed(t.type),startTime:Date.now(),colorIndex:0,originalColor:new i.Color(e.material.color),originalOpacity:e.material.opacity};return this.animations.set(n,o),console.log(`ğŸ¨ Watercolor effect started: ${t.type} with ${t.colors.length} colors`),!0}getWatercolorSpeed(e){switch(e){case"watercolor_art":default:return 3e-4;case"pastel_art":return 2e-4}}startAnimationLoop(){if(this.animationLoopRunning)return;this.animationLoopRunning=!0;const e=()=>{this.animations&&this.animations.size>0&&this.updateAnimations(),this.animationLoopRunning&&requestAnimationFrame(e)};e(),console.log("ğŸ­ Animation loop started")}updateAnimations(){const e=Date.now();for(const[t,n]of this.animations.entries()){const t=.001*(e-n.startTime);switch(n.type){case"float":this.updateFloatAnimation(n,t);break;case"pulse":this.updatePulseAnimation(n,t);break;case"spin":this.updateSpinAnimation(n,t);break;case"sparkle":this.updateSparkleAnimation(n,t);break;case"rainbow":this.updateRainbowAnimation(n,t);break;case"glitch":this.updateGlitchAnimation(n,t);break;case"cosmic":this.updateCosmicAnimation(n,t);break;case"watercolor":this.updateWatercolorAnimation(n,t)}}}updateFloatAnimation(e,t){const n=Math.sin(t*e.speed*2*Math.PI)*e.amplitude;e.object.position.y=e.originalPosition.y+n}updatePulseAnimation(e,t){const n=1+Math.sin(t*e.speed*2*Math.PI)*e.amplitude;e.object.scale.setScalar(e.originalScale.x*n)}updateSpinAnimation(e,t){const n=t*e.speed*2*Math.PI;"x"===e.axis?e.object.rotation.x=e.originalRotation.x+n:"y"===e.axis?e.object.rotation.y=e.originalRotation.y+n:"z"===e.axis&&(e.object.rotation.z=e.originalRotation.z+n)}updateSparkleAnimation(e,t){if(e.object.material){const n=(.5*Math.sin(3*t*2*Math.PI)+.5)*e.intensity;e.object.material.emissiveIntensity=n,e.object.material.needsUpdate=!0}}updateRainbowAnimation(e,t){if(e.object.material){const n=t*e.speed%1,o=(new i.Color).setHSL(n,1,.5);e.object.material.color=o,e.object.material.needsUpdate=!0}}updateGlitchAnimation(e,t){if(Math.random()<.1){const t=(Math.random()-.5)*e.intensity;e.object.position.x=e.originalPosition.x+t,e.object.position.z=e.originalPosition.z+t}else e.object.position.x=e.originalPosition.x,e.object.position.z=e.originalPosition.z}updateCosmicAnimation(e,t){if(!e.object.material)return;const n=t*e.speed,o=e.colors.length,a=n%o,r=Math.floor(a),s=(r+1)%o,l=a-r,c=new i.Color(e.colors[r]),d=new i.Color(e.colors[s]),p=c.lerp(d,l);let h=1;switch(e.cosmicType){case"aurora":h=.7+.3*Math.sin(2.5*t);break;case"nebula":h=.8+.2*Math.sin(1.2*t);break;case"energy":h=.6+Math.sin(4*t)*Math.cos(3*t)*.4;break;case"cosmic":h=.8+.2*Math.sin(1.8*t);break;case"mystic":h=.7+.3*Math.sin(1.5*t)*Math.cos(.8*t);break;case"rainbow_glow":h=.6+.3*Math.sin(2*t)}e.useColorFallback?e.object.material.color&&(e.object.material.color.copy(p),e.object.material.needsUpdate=!0):(e.object.material.emissive=p,e.object.material.emissiveIntensity=e.intensity*h,e.object.material.needsUpdate=!0)}updateWatercolorAnimation(e,t){if(!e.object.material)return;const n=t*e.speed,o=e.colors.length,a=n%o,r=Math.floor(a),s=(r+1)%o,l=a-r,c=new i.Color(e.colors[r]),d=new i.Color(e.colors[s]),p=c.lerp(d,l);let h=1;switch(e.artType){case"watercolor_art":h=.9+.1*Math.sin(.5*t);break;case"pastel_art":h=.95+.05*Math.sin(.3*t)}e.object.material.color=p,e.object.material.opacity=e.opacity*h,e.object.material.needsUpdate=!0}getAutoEffectsFromPrompt(e){if(!e)return null;const t=e.toLowerCase();return t.includes("ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³")||t.includes("unicorn")||t.includes("é­”æ³•")||t.includes("magic")||t.includes("é­”å¥³")||t.includes("wizard")||t.includes("fairy")||t.includes("å¦–ç²¾")?["é­”æ³•ã£ã½ã"]:t.includes("ãƒ‰ãƒ©ã‚´ãƒ³")||t.includes("dragon")||t.includes("å®‡å®™")||t.includes("space")||t.includes("æ˜Ÿ")||t.includes("star")?["å®‡å®™"]:t.includes("å¹½éœŠ")||t.includes("ghost")||t.includes("ç²¾éœŠ")||t.includes("spirit")?["å¹½éœŠ"]:t.includes("ãƒ­ãƒœãƒƒãƒˆ")||t.includes("robot")||t.includes("ã‚µã‚¤ãƒãƒ¼")||t.includes("cyber")||t.includes("æœªæ¥")||t.includes("future")?["ã‚µã‚¤ãƒãƒ¼"]:t.includes("çŒ«")||t.includes("cat")||t.includes("çŠ¬")||t.includes("dog")||t.includes("é³¥")||t.includes("bird")?["ãã‚‰ã‚"]:t.includes("èŠ±")||t.includes("flower")||t.includes("æ¡œ")||t.includes("cherry")||t.includes("è‡ªç„¶")||t.includes("nature")?["ãƒ‘ã‚¹ãƒ†ãƒ«"]:null}applyRecognitionFeedback(e){console.log(`ğŸ¯ Object recognition successful: ${e.name}`);this.applyEffects(e,[{type:"animation",animation:"sparkle",intensity:.8,name:"recognition_feedback"}]),setTimeout(()=>{this.stopRecognitionFeedback(e)},3e3)}stopRecognitionFeedback(e){if(!this.animations)return;const t=`${e.uuid}_sparkle`;this.animations.has(t)&&(this.animations.delete(t),e.material&&(e.material.emissiveIntensity=0,e.material.needsUpdate=!0),console.log(`âœ¨ Recognition feedback stopped for: ${e.name}`))}parseDeleteCommand(e){const t=e.toLowerCase().trim();return t.includes("é¸æŠ")||t.includes("ã“ã‚Œ")||t.includes("ã“ã®")?{type:"delete",target:"selected",requiresSelection:!0}:t.includes("å…¨éƒ¨")||t.includes("ã™ã¹ã¦")||t.includes("å…¨ã¦")?{type:"delete",target:"all"}:{type:"delete",target:"selected",requiresSelection:!0}}parseNaturalLanguageCommand(e){const t=["(S+?)ã‚’(.+?)ã«ç§»å‹•","(S+?)ã‚’(.+?)ã¸ç§»å‹•","(S+?)ã‚’(.+?)ã«å‹•ã‹","(S+?)ã‚’(.+?)ã¸å‹•ã‹"];for(const n of t){const t=new RegExp(n),i=e.match(t);if(i){const e=i[1],t=i[2];return console.log(`ğŸ¯ Natural language move detected: "${e}" to "${t}"`),{type:"natural_object_modification",targetObjectName:e,movement:this.parsePositionFromPrompt(t),requiresObjectSearch:!0}}}const n=["(S+?)ã‚’(S+?)è‰²ã«","(S+?)ã‚’(S+?)ã«"],i=["èµ¤","èµ¤è‰²","é’","é’è‰²","ç·‘","ç·‘è‰²","é»„","é»„è‰²","é»„è‰²ã„","ç´«","ç´«è‰²","æ©™","æ©™è‰²","ã‚ªãƒ¬ãƒ³ã‚¸","ã‚ªãƒ¬ãƒ³ã‚¸è‰²","ç™½","ç™½è‰²","é»’","é»’è‰²","ç°","ç°è‰²","ã‚°ãƒ¬ãƒ¼","ã‚°ãƒ¬ãƒ¼è‰²","ãƒ”ãƒ³ã‚¯","ãƒ”ãƒ³ã‚¯è‰²","èŒ¶","èŒ¶è‰²","éŠ€","éŠ€è‰²","é‡‘","é‡‘è‰²"];for(const t of n){const n=new RegExp(t),o=e.match(n);if(o&&i.some(e=>o[2].includes(e))){const e=o[1],t=o[2];console.log(`ğŸ¨ Natural language color change detected: "${e}" to "${t}"`);const n={"èµ¤":16711680,"èµ¤è‰²":16711680,"é’":255,"é’è‰²":255,"ç·‘":65280,"ç·‘è‰²":65280,"é»„":16776960,"é»„è‰²":16776960,"é»„è‰²ã„":16776960,"ç´«":16711935,"ç´«è‰²":16711935,"æ©™":16746496,"æ©™è‰²":16746496,"ã‚ªãƒ¬ãƒ³ã‚¸":16746496,"ã‚ªãƒ¬ãƒ³ã‚¸è‰²":16746496,"ç™½":16777215,"ç™½è‰²":16777215,"é»’":0,"é»’è‰²":0,"ç°":8421504,"ç°è‰²":8421504,"ã‚°ãƒ¬ãƒ¼":8421504,"ã‚°ãƒ¬ãƒ¼è‰²":8421504,"ãƒ”ãƒ³ã‚¯":16761035,"ãƒ”ãƒ³ã‚¯è‰²":16761035,"èŒ¶":9127187,"èŒ¶è‰²":9127187,"éŠ€":12632256,"éŠ€è‰²":12632256,"é‡‘":16766720,"é‡‘è‰²":16766720};let i=null;for(const[e,o]of Object.entries(n))if(t.includes(e)){i=o;break}return{type:"natural_object_modification",targetObjectName:e,color:i,requiresObjectSearch:!0}}}const o=["(S+?)ã‚’å›è»¢","(S+?)ã‚’å›ã™","(S+?)ã‚’å›ã—ã¦","(S+?)å›è»¢","å›è»¢.*?(S+)"];for(const t of o){const n=new RegExp(t),i=e.match(n);if(i){const t=i[1];console.log(`ğŸ”„ Natural language rotation detected: "${t}"`);const n=e.match(/(\d+)\s*åº¦/);return{type:"natural_object_modification",targetObjectName:t,rotation:n?parseFloat(n[1])*Math.PI/180:Math.PI/4,requiresObjectSearch:!0}}}const a=["(S+?)ã‚’å·¦å³åè»¢","(S+?)ã‚’åè»¢","(S+?)åè»¢","(S+?)ã‚’ã²ã£ãã‚Šè¿”","(S+?)ã‚’flip"];for(const t of a){const n=new RegExp(t),i=e.match(n);if(i){const e=i[1];return console.log(`ğŸ”„ Natural language flip detected: "${e}"`),{type:"natural_object_modification",targetObjectName:e,flip:!0,requiresObjectSearch:!0}}}const r=["(S+?)ã‚’(S+?)ã£ã½ã","(S+?)ã‚’(S+?)ã«","(S+?)ã‚’(S+?)é¢¨ã«","(S+?)ã‚’(S+?)ã¿ãŸã„"],s=["æ°´å½©","æ°´å½©ç”»","å®‡å®™","ã‚ªãƒ¼ãƒ­ãƒ©","æ˜Ÿé›²","ã‚¨ãƒãƒ«ã‚®ãƒ¼","ç¥ç§˜çš„","ãƒ‘ã‚¹ãƒ†ãƒ«","é­”æ³•","å¹½éœŠ","ã‚µã‚¤ãƒãƒ¼","å¤¢","å…‰","ãƒã‚ªãƒ³","ãƒ¡ã‚¿ãƒªãƒƒã‚¯","é‡‘å±","ã‚¬ãƒ©ã‚¹","ãƒãƒƒãƒˆ"];for(const t of r){const n=new RegExp(t),i=e.match(n);if(i&&s.some(e=>i[2].includes(e))){const e=i[1],t=i[2];return console.log(`âœ¨ Natural language effect detected: "${e}" with "${t}"`),{type:"natural_object_modification",targetObjectName:e,command:t,requiresObjectSearch:!0}}}return null}parsePositionFromPrompt(e){let t=0,n=0,i=0;e.includes("å³ã¸")||e.includes("å³ã«")||e.includes("å³å´ã¸")||e.includes("å³å´ã«")?t=5:(e.includes("å·¦ã¸")||e.includes("å·¦ã«")||e.includes("å·¦å´ã¸")||e.includes("å·¦å´ã«"))&&(t=-5),e.includes("ä¸Šã¸")||e.includes("ä¸Šã«")||e.includes("ä¸Šå´ã¸")?n=3:(e.includes("ä¸‹ã¸")||e.includes("ä¸‹ã«")||e.includes("ä¸‹å´ã¸"))&&(n=-3),e.includes("å‰ã¸")||e.includes("æ‰‹å‰ã¸")||e.includes("è¿‘ãã¸")?i=3:(e.includes("å¾Œã‚ã¸")||e.includes("å¥¥ã¸")||e.includes("é ãã¸"))&&(i=-3);const o=e.match(/(\d+(?:\.\d+)?)\s*(?:ãƒ¡ãƒ¼ãƒˆãƒ«|m)/);if(o){const e=parseFloat(o[1]);Math.abs(t)>0&&(t=t>0?e:-e),Math.abs(n)>0&&(n=n>0?e:-e),Math.abs(i)>0&&(i=i>0?e:-e)}return e.includes("å°‘ã—")||e.includes("ã¡ã‚‡ã£ã¨")?(t*=.5,n*=.5,i*=.5):(e.includes("å¤§ãã")||e.includes("ãŸãã•ã‚“"))&&(t*=2,n*=2,i*=2),console.log(`ğŸ“ Position movement parsed from "${e}": (${t}, ${n}, ${i})`),{x:t,y:n,z:i}}parsePosition(e){let t=0,n=5,i=10;return e.includes("å·¦ä¸‹")?(t=-8,n=0,i=10,console.log(`ğŸ“ Position parsed from "${e}": å·¦ä¸‹ (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("å³ä¸Š")?(t=5,n=4,i=12,console.log(`ğŸ“ Position parsed from "${e}": å³ä¸Š (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("å·¦ä¸Š")?(t=-8,n=4,i=15,console.log(`ğŸ“ Position parsed from "${e}": å·¦ä¸Š (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("å³ä¸‹")?(t=8,n=0,i=10,console.log(`ğŸ“ Position parsed from "${e}": å³ä¸‹ (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("ä¸­å¤®")||e.includes("çœŸã‚“ä¸­")||e.includes("æ­£é¢")?(t=0,n=3,i=12,console.log(`ğŸ“ Position parsed from "${e}": ä¸­å¤® (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("ç©º")||e.includes("å¤©ç©º")?(t=0,n=20,i=10,console.log(`ğŸ“ Position parsed from "${e}": ç©ºä¸­ (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("åœ°é¢")||e.includes("è¶³å…ƒ")?(t=0,n=1,i=8,console.log(`ğŸ“ Position parsed from "${e}": åœ°é¢ (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):(e.includes("å‰ã«")||e.includes("æ‰‹å‰ã«")?i=5:(e.includes("å¾Œã‚ã«")||e.includes("å¥¥ã«")||e.includes("é ãã«"))&&(i=20),e.includes("å³ã«")||e.includes("å³å´")||e.includes("ç”»é¢ã®å³")?t=8:(e.includes("å·¦ã«")||e.includes("å·¦å´")||e.includes("ç”»é¢ã®å·¦"))&&(t=-8),e.includes("ä¸Šã«")||e.includes("ä¸Šå´")||e.includes("ç”»é¢ã®ä¸Š")||e.includes("é«˜ã„ä½ç½®ã«")||e.includes("ç©ºä¸­ã«")?n=8:(e.includes("ä¸‹ã«")||e.includes("ä¸‹å´")||e.includes("ç”»é¢ã®ä¸‹")||e.includes("ä½ã„ä½ç½®ã«")||e.includes("åœ°é¢ã«"))&&(n=-2),e.includes("è¿‘ãã«")||e.includes("ã™ãå‰ã«")?i=Math.min(.5*i,3):(e.includes("é ãã«")||e.includes("å‘ã“ã†ã«"))&&(i*=1.5),console.log(`ğŸ“ Position parsed from "${e}": (${t}, ${n}, ${i})`),{x:t,y:n,z:i})}parseSize(e){return e.includes("å¤§ããª")||e.includes("å¤§ãã„")?{scale:2}:e.includes("å°ã•ãª")||e.includes("å°ã•ã„")?{scale:.5}:{scale:this.config.defaultObjectScale}}async dispatchCommand(e){switch(e.type){case"image_generation":if(!this.client||!this.client.serverUrl)throw new Error("ç”»åƒç”Ÿæˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã‚µãƒ¼ãƒãƒ¼è¨­å®šãŒå¿…è¦ã§ã™ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚");return await this.executeImageGeneration(e);case"video_generation":if(!this.client||!this.client.serverUrl)throw new Error("å‹•ç”»ç”Ÿæˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã‚µãƒ¼ãƒãƒ¼è¨­å®šãŒå¿…è¦ã§ã™ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚");return await this.executeVideoGeneration(e);case"object_modification":return await this.executeObjectModification(e);case"natural_object_modification":return await this.executeNaturalObjectModification(e);case"delete":return await this.executeDelete(e);case"file_import":return await this.executeFileImport(e);case"object_selection":return await this.executeObjectSelection(e);default:throw new Error(`Unknown command type: ${e.type}`)}}async executeImageGeneration(e){try{console.log(`ğŸ¨ Generating image: "${e.prompt}"`);const t=[{width:512,height:512},{width:768,height:432},{width:1024,height:1024},{width:640,height:480}];let n,o;for(let i=0;i<t.length;i++){const a=t[i];try{if(console.log(`ğŸ”„ Trying ${a.width}x${a.height}...`),n=await this.client.generateImage(e.prompt,{width:a.width,height:a.height,service:this.selectedImageService||void 0}),n.success){console.log(`âœ… Success with ${a.width}x${a.height}`);break}}catch(e){if(o=e,console.log(`âš ï¸ Failed with ${a.width}x${a.height}: ${e.message}`),i<t.length-1){console.log("ğŸ”„ Retrying with next size...");continue}}}n&&n.modelName&&console.log(`ğŸ“¡ Used model: ${n.modelName}`);const a=new i.TextureLoader;let r;if(n&&n.success&&(n.imageUrl||n.localPath)){let e=n.imageUrl;if(!e&&n.localPath){const t=n.localPath.split("/").pop();e=`${this.client.serverUrl}/generated/${t}`}console.log(`âœ… Image generated successfully: ${e}`),r=await a.loadAsync(e),r.colorSpace=i.SRGBColorSpace}else console.log(`âš ï¸ Using fallback image (last error: ${o?.message||"unknown"})`),r=this.createFallbackTexture(e.prompt);const s=6*(e.size?.scale??this.config.defaultObjectScale??1),l=r.image?.naturalWidth||r.image?.width||r.source?.data?.width||1,c=l/(r.image?.naturalHeight||r.image?.height||r.source?.data?.height||1)||1;let d=s,p=s;c>=1?(d=s,p=s/c):(d=s*c,p=s);const h=new i.PlaneGeometry(d,p),u=new i.MeshBasicMaterial({map:r,transparent:!0,side:i.DoubleSide,toneMapped:!1}),m=new i.Mesh(h,u);if(m.renderOrder=1e3,u.depthTest=!0,u.depthWrite=!0,u.alphaTest=.01,u.needsUpdate=!0,this.camera){const t=this.calculateCameraRelativePosition(e.position);m.position.copy(t),this.alignPlaneToCamera(m)}else m.position.set(e.position.x,e.position.y,e.position.z);m.scale.setScalar(1);const g="generated_"+ ++this.objectCounter;return m.name=g,m.userData={id:g,prompt:e.prompt,createdAt:Date.now(),type:"generated_image",source:"generated_image",modelName:n?.modelName||this.selectedImageService||null,keywords:this.buildObjectKeywordHints({prompt:e.prompt,baseType:"image"})},this.experimentGroup.add(m),this.spawnedObjects.set(g,m),console.log(`âœ… Created object: ${g} at (${e.position.x}, ${e.position.y}, ${e.position.z})`),this.config.showLocationIndicator&&this.createLocationIndicator(e.position),{objectId:g,position:e.position,prompt:e.prompt,modelName:n?.modelName,success:!0}}catch(e){throw console.error("ğŸ¨ Image generation failed:",e),e}}async executeVideoGeneration(e){try{console.log(`ğŸ¬ Generating video: "${e.prompt}"`),console.log("ğŸ” Video generation - selectedVideoService:",this.selectedVideoService);const t=await this.client.generateVideo(e.prompt,{duration:3,model:this.selectedVideoService||void 0});let n;t.modelName&&console.log(`ğŸ“¡ Used model: ${t.modelName}`);let o=null;t.success&&t.videoUrl?(console.log(`âœ… Video generated successfully: ${t.videoUrl}`),o=document.createElement("video"),o.src=t.videoUrl,o.crossOrigin="anonymous",o.loop=!0,o.muted=!0,o.playsInline=!0,n=new i.VideoTexture(o),n.colorSpace=i.SRGBColorSpace,o.addEventListener("loadeddata",()=>{o.play().catch(console.error)})):(console.log("âš ï¸ Using fallback video texture"),n=this.createFallbackVideoTexture(e.prompt));const a=6*(e.size?.scale??this.config.defaultObjectScale??1),r=t.metadata?.width||512,s=t.metadata?.height||512,l=r&&s?r/s:1;let c=a,d=a;l>=1?d=a/l:c=a*l;const p=new i.PlaneGeometry(c,d),h=new i.MeshBasicMaterial({map:n,transparent:!1,side:i.DoubleSide,toneMapped:!1}),u=new i.Mesh(p,h);if(u.renderOrder=1e3,h.depthTest=!0,h.depthWrite=!0,this.camera){const t=this.calculateCameraRelativePosition(e.position);u.position.copy(t),this.alignPlaneToCamera(u)}else u.position.set(e.position.x,e.position.y,e.position.z);u.scale.setScalar(1);const m="generated_video_"+ ++this.objectCounter;return u.name=m,u.userData={id:m,prompt:e.prompt,createdAt:Date.now(),type:"generated_video",source:"generated_video",videoUrl:t.videoUrl,modelName:t.modelName||this.selectedVideoService||null,width:r,height:s,videoElement:o,keywords:this.buildObjectKeywordHints({prompt:e.prompt,baseType:"video"})},this.createAudioControl(u),this.experimentGroup.add(u),this.spawnedObjects.set(m,u),console.log(`âœ… Created video object: ${m} at (${e.position.x}, ${e.position.y}, ${e.position.z})`),this.config.showLocationIndicator&&this.createLocationIndicator(e.position),{objectId:m,position:e.position,prompt:e.prompt,modelName:t.modelName,videoUrl:t.videoUrl,success:!0}}catch(t){console.error("ğŸ¬ Video generation failed:",t),console.log("ğŸ”„ Creating fallback video plane due to generation error");const n=this.createFallbackVideoTexture(e.prompt),o=6*(e.size?.scale??this.config.defaultObjectScale??1),a=new i.PlaneGeometry(o,o),r=new i.MeshBasicMaterial({map:n,transparent:!1,side:i.DoubleSide,toneMapped:!1}),s=new i.Mesh(a,r);if(this.camera){const t=this.calculateCameraRelativePosition(e.position);s.position.copy(t),this.alignPlaneToCamera(s)}else s.position.set(e.position.x,e.position.y,e.position.z);s.scale.setScalar(1);const l="generated_video_"+ ++this.objectCounter;return s.name=l,s.userData={id:l,prompt:e.prompt,createdAt:Date.now(),type:"generated_video",source:"generated_video",videoUrl:null,modelName:"Error Fallback",width:512,height:512,videoElement:null,error:t.message,keywords:this.buildObjectKeywordHints({prompt:e.prompt,baseType:"video"})},this.scene.add(s),console.log("ğŸ“ Fallback video plane added to scene"),{success:!1,error:t.message,object:s,prompt:e.prompt}}}async loadImageFile(e,t={}){try{const{position:n={x:0,y:5,z:-10},fileName:o=null}=t;console.log(`ğŸ“ Loading image file: ${e}`);const a=new i.TextureLoader,r=await a.loadAsync(e);r.colorSpace=i.SRGBColorSpace;const s=r.image?.naturalWidth||r.image?.width||r.source?.data?.width||1,l=s/(r.image?.naturalHeight||r.image?.height||r.source?.data?.height||1)||1,c=6;let d=c,p=c;l>=1?(d=c,p=c/l):(d=c*l,p=c);const h=new i.PlaneGeometry(d,p),u=new i.MeshBasicMaterial({map:r,transparent:!0,side:i.DoubleSide,toneMapped:!1});u.alphaTest=.01,u.needsUpdate=!0;const m=new i.Mesh(h,u);if(m.renderOrder=1e3,u.depthTest=!0,u.depthWrite=!0,this.camera){const e=this.calculateCameraRelativePosition(n);m.position.copy(e),this.alignPlaneToCamera(m)}else m.position.set(n.x,n.y,n.z);m.scale.setScalar(1);const g=o?o.replace(/\.[^/.]+$/,""):"imported_image",b="imported_image_"+ ++this.objectCounter;return m.name=b,m.userData={id:b,source:"imported_file",createdAt:Date.now(),type:"generated_image",prompt:g,fileName:o,importOrder:this.objectCounter,keywords:this.buildObjectKeywordHints({prompt:g,fileName:o,baseType:"image"})},this.experimentGroup.add(m),this.spawnedObjects.set(b,m),console.log(`âœ… Created imported image: ${b} at (${n.x}, ${n.y}, ${n.z})`),this.config.showLocationIndicator&&this.createLocationIndicator(n),{objectId:b,position:n,success:!0}}catch(e){throw console.error("ğŸ“ Image file loading failed:",e),e}}async loadVideoFile(e,t={}){try{const{position:n={x:0,y:5,z:-10},fileName:o=null}=t;console.log(`ğŸ¬ Loading video file: ${e}`);const a=document.createElement("video");a.src=e,a.loop=!0,a.muted=!0,a.playsInline=!0,a.autoplay=!0,a.preload="auto";const r=new i.VideoTexture(a);r.colorSpace=i.SRGBColorSpace,await new Promise((e,t)=>{a.addEventListener("loadedmetadata",()=>{console.log(`ğŸ¬ Video loaded: ${a.videoWidth}x${a.videoHeight}`),e()},{once:!0}),a.addEventListener("error",e=>{t(e?.error||new Error("Video failed to load"))},{once:!0}),a.load()});try{await a.play()}catch(e){console.warn("ğŸ¬ Video autoplay could not start automatically. Playback will require user interaction.",e)}const s=a.videoWidth/a.videoHeight,l=6;let c=l,d=l;s>1?d=l/s:c=l*s;const p=new i.PlaneGeometry(c,d),h=new i.MeshBasicMaterial({map:r,transparent:!0,side:i.DoubleSide,toneMapped:!1});h.alphaTest=.01,h.needsUpdate=!0;const u=new i.Mesh(p,h);if(u.renderOrder=1e3,h.depthTest=!0,h.depthWrite=!0,this.camera){const e=this.calculateCameraRelativePosition(n);u.position.copy(e),this.alignPlaneToCamera(u)}else u.position.set(n.x,n.y,n.z);u.scale.setScalar(1);const m=o?o.replace(/\.[^/.]+$/,""):"imported_video",g="imported_video_"+ ++this.objectCounter;return u.name=g,u.userData={id:g,source:"imported_file",createdAt:Date.now(),type:"generated_video",videoElement:a,objectUrl:e,prompt:m,fileName:o,importOrder:this.objectCounter,keywords:this.buildObjectKeywordHints({prompt:m,fileName:o,baseType:"video"})},this.createAudioControl(u),this.experimentGroup.add(u),this.spawnedObjects.set(g,u),console.log(`âœ… Created imported video: ${g} at (${n.x}, ${n.y}, ${n.z})`),this.config.showLocationIndicator&&this.createLocationIndicator(n),{objectId:g,position:n,success:!0}}catch(e){throw console.error("ğŸ¬ Video file loading failed:",e),e}}async executeNaturalObjectModification(e){const t=this.findObjectsByName(e.targetObjectName);if(0===t.length)return{success:!1,message:`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€Œ${e.targetObjectName}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`};console.log(`ğŸ” Found ${t.length} object(s) matching "${e.targetObjectName}"`);const n=this.selectObjectFromMultiple(t,e.targetObjectName);console.log(`ğŸ¯ Operating on object: ${n.name}`);let i=!1;if(null!==e.color&&n.material&&(n.material.map?(n.material.color.setHex(e.color),n.material.needsUpdate=!0,console.log(`ğŸ¨ Texture color tint changed to: #${e.color.toString(16)}`)):(n.material.color.setHex(e.color),n.material.needsUpdate=!0,console.log(`ğŸ¨ Material color changed to: #${e.color.toString(16)}`)),i=!0),e.effects&&e.effects.length>0){this.applyEffects(n,e.effects)&&(i=!0)}if(null!==e.movement){const t=n.position,o={x:t.x+e.movement.x,y:t.y+e.movement.y,z:t.z+e.movement.z};n.position.set(o.x,o.y,o.z),console.log(`ğŸ“ Position moved from (${t.x.toFixed(1)}, ${t.y.toFixed(1)}, ${t.z.toFixed(1)}) to (${o.x.toFixed(1)}, ${o.y.toFixed(1)}, ${o.z.toFixed(1)})`),i=!0}return i?(n.userData.lastModified=Date.now(),n.userData.modifications=n.userData.modifications||[],n.userData.modifications.push({timestamp:Date.now(),color:e.color,movement:e.movement,command:`Natural language: ${e.targetObjectName}`}),{success:!0,message:`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€Œ${n.name}ã€ã‚’å¤‰æ›´ã—ã¾ã—ãŸ`,objectId:n.name,modifications:{color:e.color,movement:e.movement}}):{success:!1,message:"å¤‰æ›´å¯èƒ½ãªå±æ€§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"}}findObjectsByName(e){const t=[],n=e.toLowerCase();for(const[e,i]of this.spawnedObjects){if(i.userData.prompt){i.userData.prompt.toLowerCase().includes(n)&&(t.push(i),console.log(`âœ… Object match found: ${e} (prompt: "${i.userData.prompt}")`))}i.name&&i.name.toLowerCase().includes(n)&&(t.push(i),console.log(`âœ… Object match found: ${e} (name: "${i.name}")`))}return t}selectObjectFromMultiple(e,t){const n=[/(\d+)ã¤ç›®ã®/,/(\d+)ç•ªç›®ã®/,/(\d+)å€‹ç›®ã®/,/æœ€åˆã®|1ã¤ç›®ã®|1ç•ªç›®ã®|1å€‹ç›®ã®/,/æœ€å¾Œã®|æœ€çµ‚ã®/,/2ã¤ç›®ã®|2ç•ªç›®ã®|2å€‹ç›®ã®/,/3ã¤ç›®ã®|3ç•ªç›®ã®|3å€‹ç›®ã®/];for(const i of n){const n=t.match(i);if(n){let t;if(n[1])t=parseInt(n[1])-1;else{const i=n[0];i.includes("æœ€åˆ")||i.includes("1ã¤ç›®")||i.includes("1ç•ªç›®")||i.includes("1å€‹ç›®")?t=0:i.includes("æœ€å¾Œ")||i.includes("æœ€çµ‚")?t=e.length-1:i.includes("2ã¤ç›®")||i.includes("2ç•ªç›®")||i.includes("2å€‹ç›®")?t=1:(i.includes("3ã¤ç›®")||i.includes("3ç•ªç›®")||i.includes("3å€‹ç›®"))&&(t=2)}if(t>=0&&t<e.length)return console.log(`ğŸ”¢ Selected object by ordinal: index ${t+1} of ${e.length}`),e[t];console.warn(`âš ï¸ Invalid ordinal index: ${t+1} (available: 1-${e.length})`)}}return console.log("ğŸ”¢ No ordinal specified, using first object"),e[0]}async executeObjectModification(e){let t=this.findObjectByKeyword(e.command);if(t)this.selectObject(t),this.applyRecognitionFeedback(t);else{if(!this.selectedObject)return{success:!1,message:"ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã™ã‚‹ã‹ã€å¯¾è±¡ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€ŒçŒ«ã‚’èµ¤ãã—ã¦ã€ï¼‰"};t=this.selectedObject}console.log(`ğŸ”§ Modifying object: ${t.name}`),console.log("ğŸ” Debug - parsed.movement:",e.movement);let n=!1;if(null!==e.color&&t.material&&(t.material.map?(t.material.color.setHex(e.color),t.material.needsUpdate=!0,console.log(`ğŸ¨ Texture color tint changed to: #${e.color.toString(16)}`)):(t.material.color.setHex(e.color),t.material.needsUpdate=!0,console.log(`ğŸ¨ Material color changed to: #${e.color.toString(16)}`)),n=!0),e.effects&&e.effects.length>0){this.applyEffects(t,e.effects)&&(n=!0)}if(null!==e.scale){const i=t.scale.x,o=i*e.scale;t.scale.setScalar(o),console.log(`ğŸ“ Scale changed from ${i} to ${o}`),n=!0}if(null!==e.movement){const i=t.position,o={x:i.x+e.movement.x,y:i.y+e.movement.y,z:i.z+e.movement.z};t.position.set(o.x,o.y,o.z),console.log(`ğŸ“ Position moved from (${i.x.toFixed(1)}, ${i.y.toFixed(1)}, ${i.z.toFixed(1)}) to (${o.x.toFixed(1)}, ${o.y.toFixed(1)}, ${o.z.toFixed(1)})`),n=!0}if(null!==e.rotation){const i=t.rotation.y+e.rotation;t.rotation.y=i;const o=(180*e.rotation/Math.PI).toFixed(1);console.log(`ğŸ”„ Rotation changed by ${o}Â° (new Y rotation: ${(180*i/Math.PI).toFixed(1)}Â°)`),n=!0}if(null!==e.opacity&&t.material){const i=t.material.opacity||1;t.material.opacity=e.opacity,t.material.transparent=e.opacity<1,console.log(`ğŸ” Opacity changed from ${i.toFixed(2)} to ${e.opacity.toFixed(2)}`),n=!0}if(e.flip){const e=t.scale.x;t.scale.x=-e,console.log(`â†”ï¸ Object flipped horizontally (scale.x: ${e} â†’ ${t.scale.x})`),n=!0}return n?(t.userData.lastModified=Date.now(),t.userData.modifications=t.userData.modifications||[],t.userData.modifications.push({timestamp:Date.now(),color:e.color,scale:e.scale,movement:e.movement,rotation:e.rotation,opacity:e.opacity,command:e.command}),this.updateAllAudioControlPositions(),{success:!0,message:`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€Œ${t.name}ã€ã‚’å¤‰æ›´ã—ã¾ã—ãŸ`,objectId:t.name,modifications:{color:e.color,scale:e.scale,movement:e.movement,rotation:e.rotation,opacity:e.opacity}}):{success:!1,message:"å¤‰æ›´å¯èƒ½ãªå±æ€§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"}}async executeDelete(e){const t=e.command||"";if("all"===e.target||t.includes("ã™ã¹ã¦")||t.includes("å…¨éƒ¨"))return this.clearAll(),{success:!0,message:"ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ"};const n=this.findObjectByKeyword(t);let i=null,o="";if(t.match(/^(å‰Šé™¤|æ¶ˆã—ã¦|æ¶ˆã™|delete|remove)$/i)&&this.selectedObject?(i=this.selectedObject,o="é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"):n?(i=n,o="ã‚³ãƒãƒ³ãƒ‰ã§æŒ‡å®šã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"):this.selectedObject&&(i=this.selectedObject,o="é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"),i){const e=i.name;console.log(`ğŸ—‘ï¸ Deleting ${o}: ${e}`),i===this.selectedObject&&this.deselectObject();return this.removeObject(e)?{success:!0,message:`${o}ã€Œ${e}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`,deletedObjectId:e}:{success:!1,message:"ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ"}}return{success:!1,message:"å‰Šé™¤å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã™ã‚‹ã‹ã€å¯¾è±¡ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"}}async executeFileImport(e){try{console.log("ğŸ« Starting file import process...");const t=document.createElement("input");return t.type="file",t.style.display="none","video"===e.fileType?t.accept="video/*":t.accept="image/*",document.body.appendChild(t),new Promise((n,i)=>{t.onchange=async o=>{try{const t=o.target.files[0];if(!t)return void i(new Error("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"));console.log(`ğŸ“ Selected file: ${t.name}`);const a=URL.createObjectURL(t);let r;r="video"===e.fileType||t.type.startsWith("video/")?await this.loadVideoFile(a,{position:e.position}):await this.loadImageFile(a,{position:e.position}),console.log("âœ… File import completed:",r),n(r)}catch(e){console.error("âŒ File import failed:",e),i(e)}finally{document.body.removeChild(t)}},t.oncancel=()=>{document.body.removeChild(t),i(new Error("ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ"))},t.click()})}catch(e){throw console.error("âŒ File import execution failed:",e),e}}async executeObjectSelection(e){try{console.log("ğŸ¯ Starting object selection...");const e=this.getSpawnedObjects();if(0===e.length)throw new Error("é¸æŠå¯èƒ½ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚");console.log(`ğŸ“‹ Available objects: ${e.length}`);const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.8);\n        z-index: 10000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      ";const n=document.createElement("div");n.style.cssText="\n        background: #1a1a2e;\n        border-radius: 12px;\n        padding: 24px;\n        max-width: 500px;\n        max-height: 70vh;\n        overflow-y: auto;\n        color: white;\n        font-family: Arial, sans-serif;\n      ";const i=document.createElement("h3");i.textContent="ğŸ¯ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„",i.style.cssText="margin: 0 0 16px 0; color: #ec4899;",n.appendChild(i);const o=document.createElement("div");o.style.cssText="margin-bottom: 16px;",e.forEach((e,n)=>{const i=document.createElement("div");i.style.cssText="\n          padding: 12px;\n          margin: 8px 0;\n          background: #2a2a3e;\n          border-radius: 8px;\n          cursor: pointer;\n          border: 2px solid transparent;\n          transition: all 0.3s ease;\n        ";const a="generated_image"===e.userData?.type?"ğŸ–¼ï¸ ç”»åƒ":"generated_video"===e.userData?.type?"ğŸ¬ å‹•ç”»":"ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«",r=new Date(e.userData?.createdAt).toLocaleTimeString();i.innerHTML=`\n          <div style="font-weight: bold;">${a} #${n+1}</div>\n          <div style="font-size: 12px; color: #94a3b8;">ä½œæˆ: ${r}</div>\n          <div style="font-size: 12px; color: #94a3b8;">ä½ç½®: (${Math.round(e.position.x)}, ${Math.round(e.position.y)}, ${Math.round(e.position.z)})</div>\n        `,i.onmouseover=()=>{i.style.borderColor="#ec4899",i.style.background="#3a3a4e"},i.onmouseout=()=>{i.style.borderColor="transparent",i.style.background="#2a2a3e"},i.onclick=()=>{resolve({selectedObjectId:e.id,selectedObject:e}),document.body.removeChild(t)},o.appendChild(i)}),n.appendChild(o);const a=document.createElement("button");return a.textContent="ã‚­ãƒ£ãƒ³ã‚»ãƒ«",a.style.cssText="\n        background: #666;\n        color: white;\n        border: none;\n        padding: 8px 16px;\n        border-radius: 6px;\n        cursor: pointer;\n        font-size: 14px;\n      ",a.onclick=()=>{document.body.removeChild(t),reject(new Error("ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ"))},n.appendChild(a),t.appendChild(n),document.body.appendChild(t),new Promise((e,t)=>{})}catch(e){throw console.error("âŒ Object selection failed:",e),e}}createFallbackTexture(e){const t=document.createElement("canvas");t.width=512,t.height=512;const n=t.getContext("2d"),o=this.hashString(e)%360,a=n.createLinearGradient(0,0,512,512);return a.addColorStop(0,`hsl(${o}, 70%, 60%)`),a.addColorStop(1,`hsl(${(o+60)%360}, 70%, 40%)`),n.fillStyle=a,n.fillRect(0,0,512,512),n.fillStyle="white",n.font="24px Arial",n.textAlign="center",n.fillText("ğŸ¨",256,230),n.font="16px Arial",n.fillText(e.slice(0,20),256,270),n.font="14px Arial",n.fillStyle="rgba(255,255,255,0.7)",n.fillText("Placeholder Image",256,300),new i.CanvasTexture(t)}createFallbackVideoTexture(e){const t=document.createElement("canvas");t.width=512,t.height=512;const n=t.getContext("2d"),o=this.hashString(e)%360;let a=0;const r=()=>{const t=n.createLinearGradient(0,0,512,512),i=2*a%360;t.addColorStop(0,`hsl(${(o+i)%360}, 70%, 60%)`),t.addColorStop(1,`hsl(${(o+i+60)%360}, 70%, 40%)`),n.fillStyle=t,n.fillRect(0,0,512,512),n.fillStyle="white",n.font="24px Arial",n.textAlign="center";const s=["ğŸ¬","ğŸ¥","ğŸ“¹","ğŸï¸"],l=Math.floor(a/10)%s.length;n.fillText(s[l],256,230),n.font="16px Arial",n.fillText(e.slice(0,20),256,270),n.font="14px Arial",n.fillStyle="rgba(255,255,255,0.7)",n.fillText("Placeholder Video",256,300),a++,setTimeout(()=>requestAnimationFrame(r),1e3/60)};return r(),new i.CanvasTexture(t)}hashString(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t)}getSpawnedObjects(){return Array.from(this.spawnedObjects.entries()).map(([e,t])=>({id:e,name:t.name,userData:t.userData,position:t.position.clone()}))}removeObject(e){const t=this.spawnedObjects.get(e);if(t){if(t.userData?.videoElement){const e=t.userData.videoElement;try{e.pause(),"function"==typeof e.removeAttribute?e.removeAttribute("src"):e.src="","function"==typeof e.load&&e.load()}catch(e){console.warn("ğŸ¬ Failed to release video element resources:",e)}}if(t.userData?.objectUrl)try{URL.revokeObjectURL(t.userData.objectUrl)}catch(e){console.warn("ğŸ¬ Failed to revoke object URL:",e)}if(t.userData?.cleanupCallbacks)try{t.userData.cleanupCallbacks.forEach(e=>{"function"==typeof e&&e()})}catch(e){console.warn("ğŸ§¹ Cleanup callbacks failed:",e)}if(this.experimentGroup.remove(t),this.spawnedObjects.delete(e),t.geometry&&t.geometry.dispose(),t.material){(Array.isArray(t.material)?t.material:[t.material]).forEach(e=>{e.map&&"function"==typeof e.map.dispose&&e.map.dispose(),e.dispose()})}return console.log(`ğŸ—‘ï¸ Removed object: ${e}`),!0}return!1}clearAll(){Array.from(this.spawnedObjects.keys()).forEach(e=>this.removeObject(e)),console.log("ğŸ§¹ Cleared all experimental objects")}getCommandHistory(){return[...this.commandHistory]}createLocationIndicator(e){const t=new i.SphereGeometry(1,16,16),n=new i.MeshBasicMaterial({color:65280,transparent:!0,opacity:.9}),o=new i.Mesh(t,n);if(this.camera){const t=this.calculateCameraRelativePosition({x:e.x,y:e.y+2,z:e.z});o.position.copy(t)}else o.position.set(e.x,e.y+2,e.z);console.log(`ğŸŸ¢ ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º: (${o.position.x.toFixed(1)}, ${o.position.y.toFixed(1)}, ${o.position.z.toFixed(1)})`),this.scene.add(o),setTimeout(()=>{this.scene.remove(o),t.dispose(),n.dispose()},this.config.indicatorDuration);let a=.8,r=-1;const s=()=>{a+=.05*r,a<=.3&&(r=1),a>=.8&&(r=-1),n.opacity=a,o.parent&&requestAnimationFrame(s)};s()}calculateCameraRelativePosition(e){if(!this.camera)return this.config.enableDebugLogging&&console.warn("ğŸ“· Camera not available, using fallback positioning"),new i.Vector3(e.x,e.y,e.z);try{const t=this.camera.position.clone(),n=new i.Vector3;this.camera.getWorldDirection(n);const o=new i.Vector3,a=new i.Vector3(0,1,0);o.crossVectors(n,a).normalize();const r=new i.Vector3;r.crossVectors(o,n).normalize();const s=t.clone();return s.add(n.clone().multiplyScalar(e.z)),s.add(o.clone().multiplyScalar(e.x)),s.add(r.clone().multiplyScalar(e.y)),this.logDebug(`ğŸ“ Camera relative position calculated: (${s.x.toFixed(1)}, ${s.y.toFixed(1)}, ${s.z.toFixed(1)})`),s}catch(t){return console.error("âŒ Camera relative position calculation failed:",t),new i.Vector3(e.x,e.y,e.z)}}alignPlaneToCamera(e){if(!this.camera)return;const t=new i.Vector3;this.camera.getWorldDirection(t),t.negate();let n=(new i.Vector3).copy(this.camera.up).applyQuaternion(this.camera.quaternion).normalize();Math.abs(t.dot(n))>.999&&(n=new i.Vector3(0,1,0),Math.abs(t.dot(n))>.999&&(n=new i.Vector3(0,0,1)));const o=(new i.Vector3).crossVectors(n,t).normalize();n=(new i.Vector3).crossVectors(t,o).normalize();const a=new i.Matrix4;a.makeBasis(o,n,t),e.quaternion.setFromRotationMatrix(a)}setCamera(e){this.camera=e}updateConfig(e){this.config={...this.config,...e}}setImageService(e){this.selectedImageService=e||null,this.logDebug("ğŸ¯ Updated image service:",this.selectedImageService)}getImageService(){return this.selectedImageService}setVideoService(e){this.selectedVideoService=e||null,this.logDebug("ğŸ¬ Updated video service:",this.selectedVideoService)}getVideoService(){return this.selectedVideoService}createAudioControl(e){const t=e.userData.videoElement;if(!t)return;const n=document.createElement("div");n.className="chocodrop-audio-control",n.innerHTML="â™ª";const i=(()=>{const e=document.createElement("div");return e.className="chocodrop-audio-tooltip",e.textContent="éŸ³å£°ã®ã‚ªãƒ³/ã‚ªãƒ•åˆ‡ã‚Šæ›¿ãˆ",e.style.cssText="\n        position: absolute !important;\n        background: rgba(0, 0, 0, 0.85) !important;\n        backdrop-filter: blur(12px) !important;\n        -webkit-backdrop-filter: blur(12px) !important;\n        border: 1px solid rgba(255, 255, 255, 0.15) !important;\n        border-radius: 8px !important;\n        padding: 8px 12px !important;\n        color: white !important;\n        font-size: 11px !important;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;\n        font-weight: 500 !important;\n        white-space: nowrap !important;\n        pointer-events: none !important;\n        z-index: 1000000 !important;\n        opacity: 0 !important;\n        transform: translateY(-100%) translateX(-50%) !important;\n        transition: opacity 0.2s ease !important;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;\n        margin-bottom: 8px !important;\n      ",e})();document.body.appendChild(i);const o=(()=>{const e=document.createElement("div");e.className="chocodrop-volume-slider",e.style.cssText="\n        position: absolute !important;\n        width: 30px !important;\n        height: 100px !important;\n        background: rgba(0, 0, 0, 0.85) !important;\n        backdrop-filter: blur(12px) !important;\n        -webkit-backdrop-filter: blur(12px) !important;\n        border: 1px solid rgba(255, 255, 255, 0.15) !important;\n        border-radius: 15px !important;\n        padding: 10px 8px !important;\n        z-index: 1000001 !important;\n        opacity: 0 !important;\n        pointer-events: none !important;\n        transition: opacity 0.2s ease !important;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;\n        display: flex !important;\n        flex-direction: column !important;\n        align-items: center !important;\n        justify-content: center !important;\n      ";const i=document.createElement("input");i.type="range",i.min="0",i.max="100",i.value="100",i.style.cssText="\n        width: 80px !important;\n        height: 12px !important;\n        background: rgba(255, 255, 255, 0.2) !important;\n        border-radius: 6px !important;\n        outline: none !important;\n        cursor: pointer !important;\n        -webkit-appearance: none !important;\n        appearance: none !important;\n        transform: rotate(-90deg) !important;\n        transform-origin: center !important;\n      ";const o=document.createElement("style");return o.textContent='\n        .chocodrop-volume-slider input[type="range"]::-webkit-slider-track {\n          width: 6px;\n          height: 80px;\n          background: rgba(255, 255, 255, 0.2);\n          border-radius: 3px;\n        }\n        .chocodrop-volume-slider input[type="range"]::-webkit-slider-thumb {\n          -webkit-appearance: none;\n          width: 14px;\n          height: 14px;\n          background: white;\n          border-radius: 50%;\n          cursor: pointer;\n          box-shadow: 0 2px 6px rgba(0,0,0,0.3);\n        }\n        .chocodrop-volume-slider input[type="range"]::-moz-range-track {\n          width: 6px;\n          height: 80px;\n          background: rgba(255, 255, 255, 0.2);\n          border-radius: 3px;\n          border: none;\n        }\n        .chocodrop-volume-slider input[type="range"]::-moz-range-thumb {\n          width: 14px;\n          height: 14px;\n          background: white;\n          border-radius: 50%;\n          cursor: pointer;\n          border: none;\n          box-shadow: 0 2px 6px rgba(0,0,0,0.3);\n        }\n      ',document.head.appendChild(o),i.addEventListener("input",e=>{const i=e.target.value;t.volume=i/100,0==i?(n.innerHTML='<span style="position: relative;">â™ª<span style="position: absolute; top: 0; left: 0; color: #8b5cf6; font-size: 14px;">âƒ </span></span>',n.style.background="rgba(99, 102, 241, 0.6) !important",n.title="ãƒŸãƒ¥ãƒ¼ãƒˆä¸­"):(n.innerHTML="â™ª",n.style.background="rgba(0, 0, 0, 0.4) !important",n.style.color="white !important",n.title="éŸ³å£°ON")}),e.appendChild(i),e})();document.body.appendChild(o),n.style.cssText="\n      position: absolute !important;\n      width: 18px !important;\n      height: 18px !important;\n      background: rgba(0, 0, 0, 0.4) !important;\n      border: 1px solid rgba(255, 255, 255, 0.3) !important;\n      border-radius: 50% !important;\n      color: white !important;\n      font-size: 9px !important;\n      cursor: pointer !important;\n      display: flex !important;\n      align-items: center !important;\n      justify-content: center !important;\n      z-index: 999999 !important;\n      transition: all 0.2s ease !important;\n      user-select: none !important;\n      box-shadow: 0 1px 4px rgba(0,0,0,0.2) !important;\n      backdrop-filter: blur(8px) !important;\n      pointer-events: auto !important;\n      opacity: 1 !important;\n    ";let a=!1;n.addEventListener("mouseenter",()=>{if(n.style.background="rgba(0, 0, 0, 0.7)",n.style.transform="scale(1.05)",n.style.borderColor="rgba(255, 255, 255, 0.5)",!a){const e=n.getBoundingClientRect();i.style.left=`${e.left+e.width/2}px`,i.style.top=e.top-8+"px",i.style.opacity="1"}}),n.addEventListener("mouseleave",()=>{n.style.background="rgba(0, 0, 0, 0.5)",n.style.transform="scale(1.0)",n.style.borderColor="rgba(255, 255, 255, 0.4)",i.style.opacity="0"}),n.addEventListener("click",e=>{if(e.stopPropagation(),a)return a=!1,o.style.opacity="0",void(o.style.pointerEvents="none");t.muted||0===t.volume?(t.muted=!1,t.volume=o.querySelector("input").value/100,n.innerHTML="â™ª",n.style.background="rgba(0, 0, 0, 0.4) !important",n.style.color="white !important",n.title="éŸ³å£°ON"):(t.muted=!0,n.innerHTML='<span style="position: relative;">â™ª<span style="position: absolute; top: 0; left: 0; color: #8b5cf6; font-size: 14px;">âƒ </span></span>',n.style.background="rgba(99, 102, 241, 0.6) !important",n.title="ãƒŸãƒ¥ãƒ¼ãƒˆä¸­")}),n.addEventListener("contextmenu",e=>{if(e.preventDefault(),e.stopPropagation(),a=!a,a){const e=n.getBoundingClientRect();o.style.left=e.left+e.width/2-15+"px",o.style.top=e.top-110+"px",o.style.opacity="1",o.style.pointerEvents="auto",i.style.opacity="0"}else o.style.opacity="0",o.style.pointerEvents="none"}),document.addEventListener("click",e=>{!a||n.contains(e.target)||o.contains(e.target)||(a=!1,o.style.opacity="0",o.style.pointerEvents="none")}),document.body.appendChild(n),e.userData.audioControlElement=n,e.userData.updateAudioControlPosition=()=>{this.updateAudioControlPosition(e,n)},this.updateAudioControlPosition(e,n),this.audioControls.set(e.userData.id||e.uuid,{object:e,audioButton:n,tooltip:i,volumeSlider:o,hideSlider:()=>{a=!1,o.style.opacity="0",o.style.pointerEvents="none"}}),this.audioControlUpdateListener||(this.audioControlUpdateListener=()=>{this.updateAllAudioControlPositions()},window.addEventListener("scroll",this.audioControlUpdateListener,{passive:!0}),window.addEventListener("resize",this.audioControlUpdateListener,{passive:!0})),this.audioControlUpdateInterval||(this.audioControlUpdateInterval=setInterval(()=>{this.updateAllAudioControlPositions()},100));const r=e=>{!a||n.contains(e.target)||o.contains(e.target)||(a=!1,o.style.opacity="0",o.style.pointerEvents="none")};document.addEventListener("click",r,!0),e.userData.cleanupCallbacks=e.userData.cleanupCallbacks||[],e.userData.cleanupCallbacks.push(()=>{document.removeEventListener("click",r,!0),n.parentNode&&n.parentNode.removeChild(n),i.parentNode&&i.parentNode.removeChild(i),o.parentNode&&o.parentNode.removeChild(o),this.audioControls.delete(e.userData.id||e.uuid),0===this.audioControls.size&&(this.audioControlUpdateInterval&&(clearInterval(this.audioControlUpdateInterval),this.audioControlUpdateInterval=null),this.audioControlUpdateListener&&(window.removeEventListener("scroll",this.audioControlUpdateListener),window.removeEventListener("resize",this.audioControlUpdateListener),this.audioControlUpdateListener=null))}),console.log("ğŸ”Š Audio control created for video:",e.userData.id)}updateAudioControlPosition(e,t){if(!this.camera||!this.renderer||!t.parentNode)return;const n=new i.Vector3;e.getWorldPosition(n),n.project(this.camera);const o=this.renderer.domElement.getBoundingClientRect(),a=(.5*n.x+.5)*o.width+o.left,r=-(.5*n.y-.5)*o.height+o.top,s=e.geometry;if(s&&s.parameters){s.parameters.width,e.scale.x;const n=150,i=-50;t.style.left=`${a+n}px`,t.style.top=`${r+i}px`}else t.style.left=`${a+50}px`,t.style.top=r-20+"px"}updateAllAudioControlPositions(){this.audioControls&&0!==this.audioControls.size&&this.audioControls.forEach(e=>{const t=e.object;t&&t.userData&&t.userData.updateAudioControlPosition&&t.userData.updateAudioControlPosition()})}toggleVideoAudio(e,t){const n=e.userData.videoElement;n&&(n.muted?(n.muted=!1,t.innerHTML="ğŸ”ˆ",console.log("ğŸ”Š Audio enabled for video:",e.userData.id)):(n.muted=!0,t.innerHTML="ğŸ”Š",console.log("ğŸ”‡ Audio muted for video:",e.userData.id)))}initializeLabelRenderer(){this.labelRenderer||this.loadAndInitializeCSS2DRenderer()}async ensureCSS2DRenderer(){this.labelRenderer||(this.css2dInitPromise||(this.css2dInitPromise=this.loadAndInitializeCSS2DRenderer()),await this.css2dInitPromise)}async loadAndInitializeCSS2DRenderer(){try{if(window.THREE&&window.THREE.CSS2DRenderer)return void this.setupCSS2DRenderer();console.log("ğŸ·ï¸ Loading CSS2DRenderer dynamically...");const e=await import("https://cdn.skypack.dev/three@0.158.0/examples/jsm/renderers/CSS2DRenderer.js");window.THREE||(window.THREE={}),window.THREE.CSS2DRenderer=e.CSS2DRenderer,window.THREE.CSS2DObject=e.CSS2DObject,console.log("âœ… CSS2DRenderer loaded successfully"),this.setupCSS2DRenderer()}catch(e){console.warn("âš ï¸ Failed to load CSS2DRenderer:",e),console.warn("ğŸ”§ Audio controls will not be visible. Please include CSS2DRenderer in your project.")}}setupCSS2DRenderer(){try{this.labelRenderer=new window.THREE.CSS2DRenderer,this.labelRenderer.setSize(window.innerWidth,window.innerHeight),this.labelRenderer.domElement.style.position="absolute",this.labelRenderer.domElement.style.top="0px",this.labelRenderer.domElement.style.pointerEvents="none",this.renderer&&this.renderer.domElement.parentNode?this.renderer.domElement.parentNode.appendChild(this.labelRenderer.domElement):document.body.appendChild(this.labelRenderer.domElement),console.log("ğŸ·ï¸ CSS2DRenderer initialized for UI overlays"),this.addLabelRendererResizeHandler()}catch(e){console.warn("âš ï¸ Failed to setup CSS2DRenderer:",e)}}addLabelRendererResizeHandler(){this.labelRendererResizeHandler||(this.labelRendererResizeHandler=()=>{this.labelRenderer&&this.labelRenderer.setSize(window.innerWidth,window.innerHeight)},window.addEventListener("resize",this.labelRendererResizeHandler))}updateRenderer(){this.labelRenderer&&this.scene&&this.camera&&this.labelRenderer.render(this.scene,this.camera)}logDebug(...e){this.config.enableDebugLogging&&console.log(...e)}getAdaptiveSelectionColor(){const e=this.scene.background;let t={r:.5,g:.5,b:.5};e&&e.isColor&&(t={r:e.r,g:e.g,b:e.b});return(e=>{const{r:t,g:n,b:i}=e;return.2126*(t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.7152*(n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4))+.0722*(i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4))})(t)<.5?65416:1710638}getAdaptiveHoverColor(){const e=this.scene.background;let t={r:.5,g:.5,b:.5};e&&e.isColor&&(t={r:e.r,g:e.g,b:e.b});return(e=>{const{r:t,g:n,b:i}=e;return.2126*(t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.7152*(n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4))+.0722*(i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4))})(t)<.5?65535:16724838}dispose(){this.clearAll(),this.experimentGroup.parent&&this.experimentGroup.parent.remove(this.experimentGroup)}}const h="chocodrop-service-image",u="chocodrop-service-video";class m{constructor(e={}){this.sceneManager=e.sceneManager||null,this.client=e.client||null,this.onControlsToggle=e.onControlsToggle||(()=>{}),this.isVisible=!1,this.container=null,this.input=null,this.output=null,this.currentMode="generate",this.activeConnections=new Map,this.currentTaskId=null,this.config={activationKey:e.activationKey||"@",position:e.position||"bottom-right",width:e.width||450,maxHeight:e.maxHeight||600,theme:e.theme||"dark",showExamples:!1!==e.showExamples,autoScroll:!1!==e.autoScroll,enableDebugLogging:!0===e.enableDebugLogging,...e.config},this.availableImageServices=[],this.availableVideoServices=[],this.selectedImageService=null,this.selectedVideoService=null,this.highlightOverlay=null,this.inputDefaultStyles=null,this.imageServiceSelect=null,this.videoServiceSelect=null,this.serviceSelectorContainer=null,this.serviceSelectorStatus=null,this.serviceSelectorContent=null,this.serviceSelectorRetryButton=null,this.serviceSelectorSaveButton=null,this.serviceSelectorCancelButton=null,this.serviceModalOverlay=null,this.serviceModal=null,this.servicesLoading=!1,this.isExpanded=!1,this.overlayTextarea=null,this.pendingImageService=null,this.pendingVideoService=null,this.feedbackAutoClearTimer=null,this.currentFeedback=null;try{const e=localStorage.getItem(h),t=localStorage.getItem(u);console.log("ğŸ” Debug localStorage read:",{storedImage:e,storedVideo:t,IMAGE_SERVICE_STORAGE_KEY:h,VIDEO_SERVICE_STORAGE_KEY:u}),e&&(this.selectedImageService=e,console.log("âœ… Set selectedImageService:",this.selectedImageService)),t&&(this.selectedVideoService=t,console.log("âœ… Set selectedVideoService:",this.selectedVideoService)),console.log("ğŸ” Final values:",{selectedImageService:this.selectedImageService,selectedVideoService:this.selectedVideoService})}catch(e){console.warn("âš ï¸ Failed to load stored service selections:",e)}this.pendingImageService=this.selectedImageService,this.pendingVideoService=this.selectedVideoService,this.applyServiceSelectionToSceneManager(),console.log("ğŸ” After applyServiceSelectionToSceneManager - UI:",{selectedImageService:this.selectedImageService,selectedVideoService:this.selectedVideoService}),console.log("ğŸ” After applyServiceSelectionToSceneManager - SceneManager:",{selectedImageService:this.sceneManager?.selectedImageService,selectedVideoService:this.sceneManager?.selectedVideoService}),this.currentTheme=localStorage.getItem("live-command-theme")||"light",this.isDarkMode="dark"===this.currentTheme,this.isWabiSabiMode="wabisabi"===this.currentTheme,this.commandHistory=[],this.currentHistoryIndex=-1,this.maxHistorySize=50,this.initUI(),this.bindEvents(),!this.client&&this.sceneManager&&this.sceneManager.client&&(this.client=this.sceneManager.client),this.createServiceModal(),this.createFloatingChocolateIcon(),document.addEventListener("DOMContentLoaded",()=>{this.refreshStyles()}),this.logDebug("ğŸ® CommandUI initialized"),this.selectedImageService&&this.selectedVideoService||this.openServiceModal(!0)}logDebug(...e){this.config.enableDebugLogging&&console.log(...e)}initUI(){this.container=document.createElement("div"),this.container.id="live-command-ui",this.container.style.cssText=this.getContainerStyles();const e=document.createElement("div");e.className="progressive-brand-indicator",e.style.cssText=`\n      position: absolute;\n      top: -8px;\n      right: 8px;\n      width: 8px;\n      height: 8px;\n      background: linear-gradient(135deg, ${this.isWabiSabiMode?"#8BC34A, #689F38":"#6366f1, #8b5cf6"});\n      border-radius: 50%;\n      opacity: 0.7;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      z-index: 10;\n      cursor: pointer;\n    `;const t=document.createElement("div");t.className="progressive-brand-text",t.style.cssText=`\n      position: absolute;\n      top: -35px;\n      right: -5px;\n      padding: 6px 12px;\n      background: rgba(255, 255, 255, 0.15);\n      border: 1px solid ${this.isDarkMode?"rgba(129, 140, 248, 0.3)":"rgba(99, 102, 241, 0.25)"};\n      border-radius: 12px;\n      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      font-size: 11px;\n      font-weight: 700;\n      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      letter-spacing: 0.02em;\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      opacity: 0;\n      transform: translateY(5px) scale(0.9);\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      pointer-events: none;\n      z-index: 11;\n      white-space: nowrap;\n    `,t.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">ğŸ«</span> <span style="color: #6366f1;">ChocoDrop</span>',e.addEventListener("mouseenter",()=>{t.style.opacity="1",t.style.transform="translateY(0) scale(1)",e.style.transform="scale(1.2)",e.style.opacity="1"}),e.addEventListener("mouseleave",()=>{t.style.opacity="0",t.style.transform="translateY(5px) scale(0.9)",e.style.transform="scale(1)",e.style.opacity="0.7"}),e.appendChild(t),this.container.appendChild(e),this.output=document.createElement("div"),this.outputDiv=this.output,this.output.id="command-output",this.output.className="command-output",this.output.style.cssText=this.getOutputStyles(),this.floatingContainer=document.createElement("div"),this.floatingContainer.id="floating-cards-container",this.floatingContainer.style.cssText="\n      position: fixed;\n      bottom: var(--floating-bottom, 120px);\n      left: 50%;\n      transform: translateX(-50%);\n      z-index: 99999;\n      pointer-events: none;\n      display: none;\n      flex-direction: column;\n      gap: 8px;\n      width: 400px;\n      max-width: 90vw;\n      align-items: center;\n      justify-content: flex-start;\n    ",this.taskCards=new Map,this.inputWrapper=document.createElement("div"),this.inputWrapper.style.cssText="\n      position: relative;\n      width: 100%;\n      margin-bottom: 0;\n    ",this.input=document.createElement("textarea"),this.input.rows=1,this.input.id="command-input",this.input.placeholder="ã€Œå³ä¸Šã«ãƒ‰ãƒ©ã‚´ãƒ³ã‚’ã€ã€Œç¾ã—ã„æ¡œã®æ£®ã‚’ä¸­å¤®ã«ã€ãªã©... âœ¨",this.input.style.cssText=this.getInputStyles(),this.expandButton=document.createElement("div"),this.expandButton.innerHTML="â¤¢",this.expandButton.title="ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‚’è¡¨ç¤º",this.expandButton.style.cssText=`\n      position: absolute;\n      bottom: 8px;\n      right: 8px;\n      width: 24px;\n      height: 24px;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"};\n      border: 1px solid ${this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)"};\n      border-radius: 6px;\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      font-size: 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      z-index: 1;\n    `,this.expandButton.addEventListener("mouseenter",()=>{this.expandButton.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)",this.expandButton.style.transform="scale(1.1)"}),this.expandButton.addEventListener("mouseleave",()=>{this.expandButton.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",this.expandButton.style.transform="scale(1)"}),this.expandButton.addEventListener("click",()=>{this.isExpanded?this.hideOverlayTextarea():this.showOverlayTextarea()}),this.inputWrapper.appendChild(this.input),this.inputWrapper.appendChild(this.expandButton);const n=this.createRadioModeSelector(),i=this.createMinimalActions(),o=document.createElement("div");o.innerHTML="Ã—",o.style.cssText=`\n      position: absolute;\n      top: 12px;\n      right: 12px;\n      width: 22px;\n      height: 22px;\n      border-radius: 50%;\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"};\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: normal;\n      transition: all 0.2s ease;\n      backdrop-filter: blur(8px);\n      z-index: 10;\n    `,o.addEventListener("mouseover",()=>{o.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)",o.style.transform="scale(1.1)"}),o.addEventListener("mouseout",()=>{o.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",o.style.color=this.isDarkMode?"#ffffff":"#1f2937",o.style.transform="scale(1)"}),o.addEventListener("click",()=>{this.hide()}),this.container.appendChild(o),this.container.appendChild(n),this.container.appendChild(this.inputWrapper),this.container.appendChild(i),document.body.appendChild(this.floatingContainer),document.body.appendChild(this.container),this.applyTheme(),this.isComposing=!1,this.hasCompositionJustEnded=!1,this.input.addEventListener("input",()=>{this.isComposing||(this.currentFeedback&&this.clearInputFeedback(),this.autoResizeTextarea(),this.applyKeywordHighlighting(),this.detectCommandType())}),this.input.addEventListener("compositionstart",()=>{this.isComposing=!0}),this.input.addEventListener("compositionend",()=>{this.isComposing=!1;/Safari/.test(navigator.userAgent)&&/Version/.test(navigator.userAgent)&&(this.hasCompositionJustEnded=!0),setTimeout(()=>{this.autoResizeTextarea(),this.detectCommandType()},10)});const a=/Safari/.test(navigator.userAgent)&&/Version/.test(navigator.userAgent);this.input.addEventListener("keydown",e=>{if("Enter"===e.key){if(a&&this.hasCompositionJustEnded)return void(this.hasCompositionJustEnded=!1);if(!a&&(e.isComposing||this.isComposing))return;e.preventDefault(),this.executeCommand()}}),this.config.showExamples}createMinimalActions(){const e=document.createElement("div");e.style.cssText="\n      display: flex;\n      margin-top: 8px;\n      margin-bottom: 0 !important;\n      gap: 8px;\n      justify-content: space-between;\n      align-items: center;\n    ";const t=document.createElement("div");t.style.cssText="display: flex; gap: 8px; align-items: center;";const n=document.createElement("button");n.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.7) brightness(0.9);">ğŸ§¹</span> Clear All',n.style.cssText=this.getActionButtonStyles("secondary"),n.addEventListener("click",()=>this.clearAllWithConfirmation());const i=document.createElement("button");i.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.7) brightness(0.9);">ğŸ“š</span> History',i.style.cssText=this.getActionButtonStyles("secondary"),i.style.opacity="0.5",i.disabled=!0,i.title="å±¥æ­´æ©Ÿèƒ½ï¼ˆé–‹ç™ºä¸­ï¼‰",t.appendChild(n),t.appendChild(i);const o=document.createElement("div");o.style.cssText="display: flex; gap: 6px; align-items: center;";const a=document.createElement("button"),r=()=>({light:"ğŸŒ™",dark:"ğŸµ",wabisabi:"â˜€ï¸"}[this.currentTheme]||"ğŸŒ™");a.innerHTML=(()=>{const e=r();return"â˜€ï¸"===e?`<span style="filter: saturate(1.2) brightness(1.1);">${e}</span>`:"ğŸµ"===e?`<span style="filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);">${e}</span>`:`<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">${e}</span>`})(),a.style.cssText=this.getActionButtonStyles("icon"),a.title=(()=>({light:"ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ",dark:"ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ",wabisabi:"ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ"}[this.currentTheme]||"ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ"))(),a.addEventListener("click",()=>this.toggleTheme());const s=document.createElement("button");return s.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">âš™ï¸</span>',s.style.cssText=this.getActionButtonStyles("icon"),s.title="ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šã‚’é–‹ã",s.addEventListener("click",()=>this.openServiceModal()),o.appendChild(a),o.appendChild(s),e.appendChild(t),e.appendChild(o),this.clearBtn=n,this.historyBtn=i,this.themeToggle=a,this.settingsButton=s,e}createServiceSelectorSection(){return this.serviceSelectorContainer=document.createElement("div"),this.serviceSelectorContainer.id="service-selector",this.serviceSelectorContainer.style.cssText="\n      margin-bottom: 16px;\n      padding: 12px;\n      border-radius: 12px;\n      border: 1px solid transparent;\n      transition: background 0.3s ease, border 0.3s ease;\n    ",this.serviceSelectorStatus=document.createElement("div"),this.serviceSelectorStatus.textContent="ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...",this.serviceSelectorStatus.style.fontSize="12px",this.serviceSelectorStatus.style.opacity="0.8",this.serviceSelectorStatus.style.marginBottom="8px",this.serviceSelectorContainer.appendChild(this.serviceSelectorStatus),this.serviceSelectorContent=document.createElement("div"),this.serviceSelectorContainer.appendChild(this.serviceSelectorContent),this.updateServiceSelectorTheme(),this.serviceSelectorContainer}createServiceModal(){this.serviceModalOverlay&&(this.serviceModalOverlay.remove(),this.serviceModalOverlay=null,this.serviceModal=null),this.serviceModalOverlay=document.createElement("div"),this.serviceModalOverlay.id="chocodrop-service-modal-overlay",this.serviceModalOverlay.style.cssText="\n      position: fixed;\n      inset: 0;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      backdrop-filter: blur(18px);\n      -webkit-backdrop-filter: blur(18px);\n      z-index: 2000;\n      padding: 16px !important;\n      opacity: 0;\n      transition: opacity 0.2s ease;\n    ",this.serviceModalOverlay.addEventListener("click",e=>{e.target===this.serviceModalOverlay&&this.closeServiceModal()}),this.serviceModal=document.createElement("div"),this.serviceModal.className="chocodrop-service-modal",this.serviceModal.style.cssText="\n      width: min(420px, 90vw);\n      border-radius: 24px;\n      padding: 26px 28px;\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);\n      display: flex;\n      flex-direction: column;\n      gap: 18px;\n      max-height: 90vh;\n      overflow-y: auto;\n      position: relative;\n    ";const e=document.createElement("h2");e.textContent="ã‚µãƒ¼ãƒ“ã‚¹è¨­å®š",e.style.cssText="\n      margin: 0;\n      font-size: 18px;\n      font-weight: 700;\n      letter-spacing: 0.03em;\n    ";const t=document.createElement("p");t.textContent="åˆ©ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚",t.style.cssText="\n      margin: 0;\n      font-size: 12px;\n      opacity: 0.75;\n    ";const n=this.createServiceSelectorSection(),i=document.createElement("div");i.style.cssText="\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      gap: 16px;\n    ",this.serviceSelectorRetryButton=document.createElement("button"),this.serviceSelectorRetryButton.textContent="å†èª­ã¿è¾¼ã¿",this.serviceSelectorRetryButton.style.cssText="\n      font-size: 11px;\n      padding: 6px 14px;\n      border-radius: 10px;\n      border: 1px solid transparent;\n      cursor: pointer;\n      display: none;\n      transition: all 0.2s ease;\n    ",this.serviceSelectorRetryButton.addEventListener("click",()=>this.initializeServiceSelector(!0));const o=document.createElement("div");o.style.cssText="display: flex; gap: 8px;",this.serviceSelectorCancelButton=document.createElement("button"),this.serviceSelectorCancelButton.textContent="Cancel",this.serviceSelectorCancelButton.style.cssText="\n      font-size: 12px;\n      padding: 8px 16px;\n      border-radius: 10px;\n      border: 1px solid rgba(255, 255, 255, 0.35);\n      background: transparent;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    ",this.serviceSelectorCancelButton.addEventListener("click",()=>this.closeServiceModal()),this.serviceSelectorSaveButton=document.createElement("button"),this.serviceSelectorSaveButton.textContent="Save",this.serviceSelectorSaveButton.style.cssText=`\n      font-size: 12px;\n      padding: 8px 18px;\n      border-radius: 10px;\n      border: none;\n      cursor: pointer;\n      background: linear-gradient(135deg, ${this.isWabiSabiMode?"#8BC34A, #689F38":"#6366f1, #8b5cf6"});\n      color: white;\n      font-weight: 600;\n      transition: all 0.2s ease;\n      box-shadow: 0 12px 24px rgba(99, 102, 241, 0.35);\n    `,this.serviceSelectorSaveButton.addEventListener("click",()=>this.handleServiceSave()),o.appendChild(this.serviceSelectorCancelButton),o.appendChild(this.serviceSelectorSaveButton),i.appendChild(this.serviceSelectorRetryButton),i.appendChild(o),this.serviceModal.appendChild(e),this.serviceModal.appendChild(t),this.serviceModal.appendChild(n),this.serviceModal.appendChild(i),this.serviceModalOverlay.appendChild(this.serviceModal),document.body.appendChild(this.serviceModalOverlay),this.updateServiceSelectorTheme(),this.toggleServiceRetryButton(!1)}openServiceModal(e=!1){this.serviceModalOverlay||this.createServiceModal(),this.serviceModalOverlay.style.display="flex",requestAnimationFrame(()=>{this.serviceModalOverlay&&(this.serviceModalOverlay.style.opacity="1")}),this.resetPendingSelections(),this.initializeServiceSelector(e)}closeServiceModal(){this.serviceModalOverlay&&(this.serviceModalOverlay.style.opacity="0",setTimeout(()=>{this.serviceModalOverlay&&(this.serviceModalOverlay.style.display="none"),this.resetPendingSelections()},150))}async initializeServiceSelector(e=!1){if(!this.servicesLoading||e){if(!this.client||"function"!=typeof this.client.getAvailableServices)return this.setServiceSelectorStatus("ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–å¾…ã¡ã§ã™ï¼‰ã€‚å³ä¸‹ã®ã€Œå†èª­ã¿è¾¼ã¿ã€ã§å†å–å¾—ã§ãã¾ã™ã€‚","error"),this.toggleServiceRetryButton(!0),void this.setServiceButtonsEnabled(!1);this.servicesLoading=!0,this.setServiceSelectorStatus("ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...","info"),this.toggleServiceRetryButton(!1),this.setServiceButtonsEnabled(!1);try{"function"==typeof this.client.ensureInitialized&&await this.client.ensureInitialized();const e=await this.client.getAvailableServices();if(!e||!1===e.success||!e.metadata)throw new Error(e?.error||"ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");this.availableImageServices=Array.isArray(e.metadata?.image)?e.metadata.image:[],this.availableVideoServices=Array.isArray(e.metadata?.video)?e.metadata.video:[],this.selectedImageService=this.resolveServiceSelection("image",this.availableImageServices,e.default?.image),this.selectedVideoService=this.resolveServiceSelection("video",this.availableVideoServices,e.default?.video),this.pendingImageService=this.selectedImageService,this.pendingVideoService=this.selectedVideoService,this.populateServiceSelector(),this.applyServiceSelectionToSceneManager(),this.setServiceButtonsEnabled(!0)}catch(e){console.error("âŒ Failed to initialize service selector:",e),this.setServiceSelectorStatus("ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã®ã†ãˆã€å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚","error"),this.toggleServiceRetryButton(!0),this.setServiceButtonsEnabled(!1)}finally{this.servicesLoading=!1}}}setServiceSelectorStatus(e,t="info"){this.serviceSelectorStatus&&(this.serviceSelectorStatus.textContent=e,this.serviceSelectorStatus.dataset.statusType=t,this.serviceSelectorStatus.classList.toggle("service-selector-helper","error"!==t),this.updateServiceSelectorTheme())}toggleServiceRetryButton(e){this.serviceSelectorRetryButton&&(this.serviceSelectorRetryButton.style.display=e?"inline-flex":"none",this.updateServiceSelectorTheme())}resolveServiceSelection(e,t,n){if(!t||0===t.length)return null;const i="image"===e?h:u;let o=null;try{o=localStorage.getItem(i)}catch(e){console.warn("âš ï¸ Failed to access localStorage:",e)}let a=o&&t.some(e=>e.id===o)?o:null;!a&&n&&t.some(e=>e.id===n)&&(a=n),a||(a=t[0]?.id||null);try{a?localStorage.setItem(i,a):localStorage.removeItem(i)}catch(e){console.warn("âš ï¸ Failed to persist service selection:",e)}return a}populateServiceSelector(){if(!this.serviceSelectorContent)return;this.serviceSelectorContent.innerHTML="";const e=this.availableImageServices.length>0,t=this.availableVideoServices.length>0;if(e||t){if(this.setServiceSelectorStatus("åˆ©ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚","info"),e){const e=this.buildServiceRow("image","ç”»åƒ (T2I)",this.availableImageServices,this.pendingImageService||this.selectedImageService);this.serviceSelectorContent.appendChild(e)}if(t){const e=this.buildServiceRow("video","å‹•ç”» (T2V)",this.availableVideoServices,this.pendingVideoService||this.selectedVideoService);this.serviceSelectorContent.appendChild(e)}this.updateServiceSelectorTheme()}else this.setServiceSelectorStatus("åˆ©ç”¨å¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚","error")}buildServiceRow(e,t,n,i){const o=document.createElement("div");o.className=`service-row service-row-${e}`,o.style.cssText="\n      display: flex;\n      flex-direction: column;\n      gap: 6px;\n      margin-bottom: 12px;\n    ";const a=document.createElement("label");a.textContent=t,a.style.fontSize="13px",a.style.fontWeight="600",o.appendChild(a);const r=document.createElement("select");r.dataset.serviceType=e,r.style.fontFamily="inherit",r.style.width="100%",n.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name||e.id,e.description&&(t.title=e.description),r.appendChild(t)}),i&&n.some(e=>e.id===i)&&(r.value=i),r.addEventListener("change",t=>{this.onServiceSelectionChange(e,t.target.value)}),o.appendChild(r);const s=document.createElement("div");return s.className="service-description",s.textContent=this.findServiceInfo(e,r.value)?.description||"",s.style.fontSize="11px",s.style.opacity="0.75",s.style.lineHeight="1.4",s.style.minHeight="14px",o.appendChild(s),r.addEventListener("change",()=>{s.textContent=this.findServiceInfo(e,r.value)?.description||""}),"image"===e?this.imageServiceSelect=r:this.videoServiceSelect=r,o}onServiceSelectionChange(e,t){"image"===e?this.pendingImageService=t:this.pendingVideoService=t;const n=this.findServiceInfo(e,t),i="image"===e?this.imageServiceSelect?.parentElement?.querySelector(".service-description"):this.videoServiceSelect?.parentElement?.querySelector(".service-description");i&&(i.textContent=n?.description||"")}handleServiceSave(){const e=this.pendingImageService||this.selectedImageService,t=this.pendingVideoService||this.selectedVideoService;if(e){try{localStorage.setItem(h,e)}catch(e){console.warn("âš ï¸ Failed to persist image service selection:",e)}this.selectedImageService=e,this.sceneManager?.setImageService(e)}if(t){try{localStorage.setItem(u,t)}catch(e){console.warn("âš ï¸ Failed to persist video service selection:",e)}this.selectedVideoService=t,this.sceneManager?.setVideoService(t)}const n=this.findServiceInfo("image",e),i=this.findServiceInfo("video",t);n&&this.addOutput(`ğŸ–¼ï¸ ç”»åƒã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€Œ${n.name}ã€ã«è¨­å®šã—ã¾ã—ãŸ`,"system"),i&&this.addOutput(`ğŸ¬ å‹•ç”»ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã€Œ${i.name}ã€ã«è¨­å®šã—ã¾ã—ãŸ`,"system"),this.closeServiceModal()}setServiceButtonsEnabled(e){this.serviceSelectorSaveButton&&(this.serviceSelectorSaveButton.disabled=!e,this.serviceSelectorSaveButton.style.opacity=e?"1":"0.6",this.serviceSelectorSaveButton.style.cursor=e?"pointer":"not-allowed")}resetPendingSelections(){this.pendingImageService=this.selectedImageService,this.pendingVideoService=this.selectedVideoService,this.imageServiceSelect&&this.selectedImageService&&(this.imageServiceSelect.value=this.selectedImageService),this.videoServiceSelect&&this.selectedVideoService&&(this.videoServiceSelect.value=this.selectedVideoService),this.serviceSelectorContent&&this.serviceSelectorContent.childElementCount>0&&this.populateServiceSelector()}findServiceInfo(e,t){return("image"===e?this.availableImageServices:this.availableVideoServices).find(e=>e.id===t)||null}applyServiceSelectionToSceneManager(){this.sceneManager&&(this.sceneManager.setImageService(this.selectedImageService),this.sceneManager.setVideoService(this.selectedVideoService))}updateServiceSelectorTheme(){if(this.serviceModalOverlay&&(this.serviceModalOverlay.style.background=this.isDarkMode?"rgba(8, 11, 26, 0.55)":"rgba(229, 231, 255, 0.45)"),this.serviceModal&&(this.serviceModal.style.background=this.isDarkMode?"rgba(17, 24, 39, 0.15)":"rgba(255, 255, 255, 0.15)",this.serviceModal.style.border=this.isDarkMode?"1px solid rgba(129, 140, 248, 0.4)":"1px solid rgba(99, 102, 241, 0.25)",this.serviceModal.style.color=this.isDarkMode?"#e5e7ff":"#1f2937"),this.serviceSelectorStatus){const e=this.serviceSelectorStatus.dataset?.statusType,t="error"===e?this.isDarkMode?"#fca5a5":"#b91c1c":this.isDarkMode?"rgba(209, 213, 219, 0.8)":"rgba(55, 65, 81, 0.75)";this.serviceSelectorStatus.style.color=t}if(this.serviceSelectorContainer){this.serviceSelectorContainer.querySelectorAll("label").forEach(e=>{e.style.color=this.isWabiSabiMode?"#5D4037":this.isDarkMode?"rgba(255, 255, 255, 0.9)":"rgba(31, 41, 55, 0.9)"});this.serviceSelectorContainer.querySelectorAll("select").forEach(e=>{e.style.background=this.isWabiSabiMode?"rgba(161, 136, 127, 0.15)":this.isDarkMode?"rgba(99, 102, 241, 0.18)":"rgba(99, 102, 241, 0.12)",e.style.border=this.isWabiSabiMode?"1px solid rgba(161, 136, 127, 0.4)":this.isDarkMode?"1px solid rgba(129, 140, 248, 0.45)":"1px solid rgba(99, 102, 241, 0.45)",e.style.color=this.isWabiSabiMode?"#5D4037":this.isDarkMode?"#ffffff":"#1f2937",e.style.padding="10px 12px",e.style.borderRadius="10px",e.style.fontSize="13px",e.style.outline="none",e.style.boxShadow=this.isWabiSabiMode?"0 12px 24px rgba(93, 64, 55, 0.25)":this.isDarkMode?"0 12px 28px rgba(15, 23, 42, 0.5)":"0 12px 24px rgba(99, 102, 241, 0.2)"});this.serviceSelectorContainer.querySelectorAll(".service-description").forEach(e=>{e.style.color=this.isWabiSabiMode?"rgba(93, 64, 55, 0.7)":this.isDarkMode?"rgba(209, 213, 219, 0.8)":"rgba(55, 65, 81, 0.7)"})}this.serviceSelectorRetryButton&&(this.serviceSelectorRetryButton.style.background=this.isWabiSabiMode?"rgba(161, 136, 127, 0.25)":this.isDarkMode?"rgba(129, 140, 248, 0.35)":"rgba(99, 102, 241, 0.15)",this.serviceSelectorRetryButton.style.border=this.isWabiSabiMode?"1px solid rgba(161, 136, 127, 0.5)":this.isDarkMode?"1px solid rgba(129, 140, 248, 0.5)":"1px solid rgba(99, 102, 241, 0.45)",this.serviceSelectorRetryButton.style.color=this.isWabiSabiMode?"#5D4037":this.isDarkMode?"#f9fafb":"#1e1b4b",this.serviceSelectorRetryButton.style.boxShadow=this.isWabiSabiMode?"0 0 8px rgba(161, 136, 127, 0.4)":this.isDarkMode?"0 0 8px rgba(129, 140, 248, 0.45)":"0 0 8px rgba(99, 102, 241, 0.35)"),this.serviceSelectorCancelButton&&(this.serviceSelectorCancelButton.style.border=this.isWabiSabiMode?"1px solid rgba(161, 136, 127, 0.4)":this.isDarkMode?"1px solid rgba(209, 213, 219, 0.3)":"1px solid rgba(148, 163, 184, 0.5)",this.serviceSelectorCancelButton.style.color=this.isWabiSabiMode?"rgba(93, 64, 55, 0.85)":this.isDarkMode?"rgba(226, 232, 240, 0.85)":"rgba(30, 41, 59, 0.85)"),this.serviceSelectorSaveButton&&(this.serviceSelectorSaveButton.style.background=this.isWabiSabiMode?"linear-gradient(135deg, #6D4C41, #5D4037)":this.isDarkMode?"linear-gradient(135deg, "+(this.isWabiSabiMode?"#8BC34A, #689F38":"#6366f1, #8b5cf6")+")":"linear-gradient(135deg, #818cf8, #a855f7)",this.serviceSelectorSaveButton.style.boxShadow=this.isWabiSabiMode?"0 16px 28px rgba(93, 64, 55, 0.35)":this.isDarkMode?"0 16px 28px rgba(99, 102, 241, 0.4)":"0 16px 28px rgba(129, 140, 248, 0.35)")}createRadioModeSelector(){const e=document.createElement("div");e.className="radio-mode-selector",e.style.cssText=`\n      display: grid;\n      grid-template-columns: repeat(4, 1fr);\n      gap: 8px;\n      margin-bottom: 12px;\n      padding: 12px;\n      background: ${this.isWabiSabiMode?"linear-gradient(135deg, rgba(158, 158, 158, 0.25), rgba(189, 189, 189, 0.2))":this.isDarkMode?"linear-gradient(135deg, rgba(30, 27, 75, 0.3), rgba(15, 23, 42, 0.4))":"linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1))"};\n      border: 1px solid ${this.isWabiSabiMode?"rgba(141, 110, 99, 0.4)":this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(255, 255, 255, 0.25)"};\n      border-radius: 16px;\n      backdrop-filter: blur(12px);\n      transition: all 0.3s ease;\n      position: relative;\n    `;return this.radioModeButtons={},[{value:"generate",label:"Generate",icon:"âœ¨"},{value:"import",label:"Import",icon:"ğŸ“¥"},{value:"modify",label:"Modify",icon:"ğŸ”§"},{value:"delete",label:"Delete",icon:"ğŸ—‘ï¸"}].forEach(t=>{const n=document.createElement("div");n.className=`mode-option ${t.value}`,n.style.cssText=`\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 4px;\n        padding: 10px 8px;\n        border-radius: 12px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        font-size: 11px;\n        font-weight: 600;\n        text-align: center;\n        color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(55, 65, 81, 0.8)"};\n        background: transparent;\n        border: 1px solid transparent;\n        position: relative;\n      `;const i=document.createElement("div");i.textContent=t.icon,i.style.cssText=`\n        font-size: 16px;\n        margin-bottom: 2px;\n        filter: ${this.isDarkMode?"hue-rotate(220deg) saturate(0.8) brightness(1.2)":"hue-rotate(240deg) saturate(0.7) brightness(0.9)"};\n        transition: filter 0.2s ease;\n      `;const o=document.createElement("span");o.textContent=t.label;const a=document.createElement("div");a.className="auto-badge",a.textContent="AUTO",a.style.cssText="\n        position: absolute;\n        top: -4px;\n        right: -4px;\n        font-size: 7px;\n        font-weight: 700;\n        padding: 2px 4px;\n        background: linear-gradient(135deg, #10b981, #059669);\n        color: white;\n        border-radius: 6px;\n        opacity: 0;\n        transform: scale(0.8);\n        transition: all 0.2s ease;\n        display: none;\n      ",n.appendChild(i),n.appendChild(o),n.appendChild(a),n.addEventListener("click",()=>{"import"===t.value?this.triggerFileSelection():this.selectMode(t.value,!0)}),this.radioModeButtons[t.value]={button:n,autoBadge:a},e.appendChild(n)}),this.radioModeContainer=e,this.selectMode("generate",!1),e}selectMode(e,t=!1,n=null){this.currentMode=e,Object.keys(this.radioModeButtons).forEach(e=>{const{button:t,autoBadge:n}=this.radioModeButtons[e];t.style.color=this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(55, 65, 81, 0.8)",t.style.background="transparent",t.style.border="1px solid transparent",t.style.transform="scale(1)",t.style.boxShadow="none",n.style.display="none",n.style.opacity="0"});const{button:i,autoBadge:o}=this.radioModeButtons[e],a=this.isWabiSabiMode?{background:"linear-gradient(135deg, rgba(109, 76, 65, 0.2), rgba(141, 110, 99, 0.15))",border:"1px solid rgba(109, 76, 65, 0.4)",boxShadow:"0 4px 16px rgba(109, 76, 65, 0.25), inset 0 1px 0 rgba(245, 245, 220, 0.15)",color:"#F5F5F5"}:this.isDarkMode?{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15))",border:"1px solid rgba(99, 102, 241, 0.4)",boxShadow:"0 4px 16px rgba(99, 102, 241, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1)",color:"#a5b4fc"}:{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.08))",border:"1px solid rgba(99, 102, 241, 0.3)",boxShadow:"0 4px 16px rgba(99, 102, 241, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2)",color:this.isWabiSabiMode?"#8BC34A":"#6366f1"};i.style.color=a.color,i.style.background=a.background,i.style.border=a.border,i.style.boxShadow=a.boxShadow,i.style.transform="scale(1.02)",!t&&n&&(o.style.display="inline-block",setTimeout(()=>{o.style.opacity="1",o.style.transform="scale(1)"},100),setTimeout(()=>{o.style.opacity="0",o.style.transform="scale(0.8)",setTimeout(()=>{o.style.display="none"},200)},3e3)),t||"import"===e?"import"===e&&this.addContainerGlow(e):(this.addPulseEffect(i),this.addContainerGlow(e)),this.input.placeholder=this.getPlaceholderForMode(e),t&&this.clearInputOnModeSwitch(e),"import"===e||this.selectedFile?this.showImportInterface():this.hideImportInterface(),"delete"===e&&t&&this.handleDeleteModeSelection(),"modify"===e&&t&&this.handleModifyModeSelection()}addPulseEffect(e){e.style.animation="none",setTimeout(()=>{e.style.animation="smartModePulse 0.6s ease-out"},10),setTimeout(()=>{e.style.animation=""},610),this.ensurePulseAnimation()}ensurePulseAnimation(){if(document.getElementById("smart-mode-pulse-animation"))return;const e=document.createElement("style");e.id="smart-mode-pulse-animation",e.textContent="\n      @keyframes smartModePulse {\n        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }\n        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }\n        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }\n      }\n    ",document.head.appendChild(e)}addContainerGlow(e){const t=this.radioModeContainer;if(!t)return;const n=this.isWabiSabiMode?{generate:"rgba(139, 195, 74, 0.4)",modify:"rgba(139, 195, 74, 0.4)",delete:"rgba(139, 195, 74, 0.4)",import:"rgba(139, 195, 74, 0.4)"}:{generate:"rgba(79, 70, 229, 0.4)",modify:"rgba(236, 72, 153, 0.4)",delete:"rgba(107, 114, 128, 0.3)",import:"rgba(59, 130, 246, 0.35)"},i=n[e]||n.generate;t.style.boxShadow=`0 0 20px ${i}, 0 0 40px ${i}`;const o=i.replace("0.4","0.6").replace("0.3","0.5");t.style.borderColor=o!==i?o:i,setTimeout(()=>{t.style.boxShadow="",t.style.borderColor=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.15)"},1e3)}getActionButtonStyles(e="secondary"){const t="\n      border: none;\n      border-radius: 10px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n      font-weight: 500;\n      backdrop-filter: blur(8px);\n      -webkit-backdrop-filter: blur(8px);\n    ";return"secondary"===e?t+`\n        width: 90px;\n        height: 36px;\n        padding: 8px 12px;\n        font-size: 12px;\n        font-weight: 600;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n        background: ${this.isWabiSabiMode?"linear-gradient(135deg, rgba(141, 110, 99, 0.3), rgba(109, 76, 65, 0.2))":this.isDarkMode?"linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2))":"linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))"};\n        border: 1px solid ${this.isWabiSabiMode?"rgba(93, 64, 55, 0.6)":this.isDarkMode?"rgba(156, 163, 175, 0.2)":"rgba(255, 255, 255, 0.3)"};\n        color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#d1d5db":"#374151"};\n        text-align: center;\n        white-space: nowrap;\n      `:"icon"===e?t+`\n        width: 32px;\n        height: 32px;\n        padding: 0;\n        font-size: 14px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: ${this.isDarkMode?"linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1))":"linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))"};\n        border: 1px solid ${this.isDarkMode?"rgba(99, 102, 241, 0.2)":"rgba(255, 255, 255, 0.4)"};\n        color: ${this.isDarkMode?"#a5b4fc":"#6366f1"};\n      `:void 0}getDestructiveButtonStyles(){return`\n      min-width: 50px;\n      height: 32px;\n      border: 1px solid ${this.isDarkMode?"rgba(220, 38, 127, 0.4)":"rgba(190, 24, 93, 0.35)"};\n      border-radius: 6px;\n      background: ${this.isDarkMode?"rgba(220, 38, 127, 0.3)":"rgba(190, 24, 93, 0.25)"};\n      color: ${this.isDarkMode?"#fca5a5":"#dc2626"};\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n      font-size: 11px;\n      font-weight: 500;\n      padding: 0 8px;\n      backdrop-filter: blur(10px);\n      -webkit-backdrop-filter: blur(10px);\n    `}getCommandTypeIndicatorStyles(){return`\n      padding: 4px 0;\n      margin-bottom: 0;\n      font-size: 11px;\n      font-weight: 400;\n      text-align: left;\n      color: ${this.isDarkMode?"rgba(255, 255, 255, 0.6)":"rgba(0, 0, 0, 0.6)"};\n      transition: all 0.3s ease;\n      border: none;\n      background: none;\n    `}autoResizeTextarea(){this.input.style.height="auto";const e=Math.min(this.input.scrollHeight,72);this.input.style.height=e+"px",this.input.scrollHeight>72?(this.input.style.overflowY="auto",this.expandButton&&(this.expandButton.style.display="flex")):(this.input.style.overflowY="hidden",this.expandButton&&(this.expandButton.style.display="none"))}detectCommandType(){const e=this.input.value.trim();if(!e)return void this.selectMode("generate",!1);const t=this.analyzeCommandType(e);"delete"!==this.currentMode&&"modify"!==this.currentMode&&this.selectMode(t.type,!1,t.detectedKeyword)}analyzeCommandType(e,t){const n=e.trim();if(this.logDebug(`ğŸ” Analyzing command: "${e}"`),this.logDebug("ğŸ“‹ Selected object: "+(t?"Yes":"No")),!n)return{type:"empty",reason:"ç©ºã®ã‚³ãƒãƒ³ãƒ‰"};const i=this.detectMediaType(e),o=[{pattern:/å‰Šé™¤/,keyword:"å‰Šé™¤"},{pattern:/æ¶ˆå»/,keyword:"æ¶ˆå»"},{pattern:/æ¶ˆã—ã¦/,keyword:"æ¶ˆã—ã¦"},{pattern:/æ¶ˆã™/,keyword:"æ¶ˆã™"},{pattern:/å–ã‚Šé™¤/,keyword:"å–ã‚Šé™¤"},{pattern:/é™¤å»/,keyword:"é™¤å»"},{pattern:/å‰Šé™¤ã—ã¦/,keyword:"å‰Šé™¤ã—ã¦"},{pattern:/delete/i,keyword:"delete"},{pattern:/remove/i,keyword:"remove"},{pattern:/clear/i,keyword:"clear"},{pattern:/erase/i,keyword:"erase"}];for(const{pattern:t,keyword:n}of o)if(t.test(e))return this.logDebug(`âœ… Delete pattern matched: ${n}`),{type:"delete",confidence:.9,reason:"å‰Šé™¤ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º",mediaType:i.type,requiresConfirmation:!0,detectedKeyword:n,needsTarget:!0};const a=[{pattern:/ä½œã£ã¦/,keyword:"ä½œã£ã¦"},{pattern:/ã¤ãã£ã¦/,keyword:"ã¤ãã£ã¦"},{pattern:/ç”Ÿæˆ/,keyword:"ç”Ÿæˆ"},{pattern:/ä½œæˆ/,keyword:"ä½œæˆ"},{pattern:/æã„ã¦/,keyword:"æã„ã¦"},{pattern:/æ›¸ã„ã¦/,keyword:"æ›¸ã„ã¦"},{pattern:/create/i,keyword:"create"},{pattern:/generate/i,keyword:"generate"},{pattern:/make/i,keyword:"make"},{pattern:/draw/i,keyword:"draw"}];for(const{pattern:t,keyword:n}of a)if(t.test(e))return this.logDebug(`âœ… Generate pattern matched: ${n}`),{type:"generate",confidence:i.confidence,reason:"ç”Ÿæˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º",mediaType:i.type,requiresConfirmation:!1,detectedKeyword:n,needsTarget:!1};const r=[/ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸ.*ã‚’/,/é¸æŠã—ãŸ.*ã‚’/,/ã“ã®.*ã‚’/,/ãã®.*ã‚’/,/ã‚ã®.*ã‚’/,/[0-9]+ç•ªç›®.*ã‚’/,/æœ€åˆ.*ã‚’/,/åˆå›.*ã‚’/,/ç”Ÿæˆã—ãŸ.*ã‚’/,/ä½œã£ãŸ.*ã‚’/,/.+ã®(ç”»åƒ|å†™çœŸ|ã‚¤ãƒ¡ãƒ¼ã‚¸|çµµ|ã‚¤ãƒ©ã‚¹ãƒˆ|ãƒ”ã‚¯ãƒãƒ£ãƒ¼)(ã‚’|ã«)/,/.+ã®(å‹•ç”»|ãƒ“ãƒ‡ã‚ª|ãƒ ãƒ¼ãƒ“ãƒ¼|æ˜ åƒ|ã‚¯ãƒªãƒƒãƒ—)(ã‚’|ã«)/,/(.+?)(ç”»åƒ|å†™çœŸ|ã‚¤ãƒ¡ãƒ¼ã‚¸|çµµ|ã‚¤ãƒ©ã‚¹ãƒˆ|ãƒ”ã‚¯ãƒãƒ£ãƒ¼)ã‚’.*(å¤‰ãˆã¦|å¤‰æ›´|ã«ã—ã¦|åŠ å·¥|ç·¨é›†|èª¿æ•´|å¡—ã‚Š|ä¸¦ã¹|ç§»å‹•|å›è»¢|åè»¢|æ•´åˆ—)/,/(.+?)(å‹•ç”»|ãƒ“ãƒ‡ã‚ª|ãƒ ãƒ¼ãƒ“ãƒ¼|æ˜ åƒ|ã‚¯ãƒªãƒƒãƒ—)ã‚’.*(å¤‰ãˆã¦|å¤‰æ›´|ã«ã—ã¦|åŠ å·¥|ç·¨é›†|èª¿æ•´|å¡—ã‚Š|ä¸¦ã¹|ç§»å‹•|å›è»¢|åè»¢|æ•´åˆ—)/].some(t=>t.test(e));if(r)return this.logDebug("âœ… Target reference pattern matched"),{type:"modify",confidence:.9,reason:"å¯¾è±¡ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š",mediaType:i.type,requiresConfirmation:!1,needsTarget:!0,hasExplicitTarget:!0};if(t&&n&&!/ã®ç”»åƒ|ã®å‹•ç”»|ç”»åƒã‚’|å‹•ç”»ã‚’|ç”»åƒ$|å‹•ç”»$/.test(e))return this.logDebug("âœ… Selected object + command = modify"),{type:"modify",confidence:.8,reason:"é¸æŠã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã™ã‚‹å¤‰æ›´",mediaType:i.type,requiresConfirmation:!1,needsTarget:!1};const s=/(ç”»åƒ|å†™çœŸ|ã‚¤ãƒ¡ãƒ¼ã‚¸|çµµ|ã‚¤ãƒ©ã‚¹ãƒˆ|ãƒ”ã‚¯ãƒãƒ£ãƒ¼|ãƒ¡ãƒ‡ã‚£ã‚¢|ç´ æ|å‹•ç”»|ãƒ“ãƒ‡ã‚ª|ãƒ ãƒ¼ãƒ“ãƒ¼|æ˜ åƒ|ã‚¯ãƒªãƒƒãƒ—|ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ|ãƒ¢ãƒ‡ãƒ«)/i;return/(ã«ã—ã¦|ã«å¤‰ãˆã¦|ã¸å¤‰ãˆã¦|ã¸å¤‰æ›´|å¤‰ãˆã¦|å¤‰æ›´|èª¿æ•´|åŠ å·¥|ç·¨é›†|å¡—(ã£ã¦|ã‚Š)|æŸ“ã‚|å½©è‰²|å½©åº¦|æ˜ã‚‹ã|æš—ã|è–„ã|æ¿ƒã|ã¼ã‹ã—|ã‚·ãƒ£ãƒ¼ãƒ—|å·¦å³åè»¢|ä¸Šä¸‹åè»¢|åè»¢|å›è»¢|ç§»å‹•|ä¸¦ã¹|æ•´åˆ—|æƒãˆ|å¯„ã›ã¦|æ‹¡å¤§|ç¸®å°|å¤§ãã|å°ã•ã|ä¼¸ã°ã—ã¦|ç¸®ã‚ã¦|é«˜ã|ä½ã|è¿‘ã¥ã‘|é ã–ã‘|é€æ˜|åŠé€æ˜|ä¸é€æ˜|é€é|èƒŒæ™¯ã‚’é€é|èƒŒæ™¯é€é|èƒŒæ™¯ã‚’æ¶ˆ|èƒŒæ™¯æ¶ˆ|èƒŒæ™¯æŠœ|è¼ã‹ã›ã¦|å…‰ã‚‰ã›ã¦|æš—ãã—ã¦|ç„¼ãè¾¼ã¿|ç„¼ãä»˜ã‘|flip|rotate|move|align|scale|resize|tint|color|brighten|darken|adjust|edit|modify)/i.test(e)?(this.logDebug("âœ… Modification indicators detected"),{type:"modify",confidence:.7,reason:"å¤‰æ›´ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º",mediaType:i.type,requiresConfirmation:!1,needsTarget:!t,hasExplicitTarget:r||s.test(e)}):(this.logDebug("â„¹ï¸ Defaulting to generate mode"),{type:"generate",confidence:i.confidence,reason:"ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆæ–°è¦ç”Ÿæˆï¼‰",mediaType:i.type,requiresConfirmation:!1,needsTarget:!1})}getAllCommandKeywords(){return[{pattern:/å‰Šé™¤/,keyword:"å‰Šé™¤",type:"delete"},{pattern:/æ¶ˆå»/,keyword:"æ¶ˆå»",type:"delete"},{pattern:/æ¶ˆã—ã¦/,keyword:"æ¶ˆã—ã¦",type:"delete"},{pattern:/æ¶ˆã™/,keyword:"æ¶ˆã™",type:"delete"},{pattern:/å–ã‚Šé™¤/,keyword:"å–ã‚Šé™¤",type:"delete"},{pattern:/é™¤å»/,keyword:"é™¤å»",type:"delete"},{pattern:/å‰Šé™¤ã—ã¦/,keyword:"å‰Šé™¤ã—ã¦",type:"delete"},{pattern:/delete/i,keyword:"delete",type:"delete"},{pattern:/remove/i,keyword:"remove",type:"delete"},{pattern:/clear/i,keyword:"clear",type:"delete"},{pattern:/erase/i,keyword:"erase",type:"delete"},{pattern:/ç§»å‹•/,keyword:"ç§»å‹•",type:"modify"},{pattern:/å‹•ã‹ã—ã¦/,keyword:"å‹•ã‹ã—ã¦",type:"modify"},{pattern:/å¤‰æ›´/,keyword:"å¤‰æ›´",type:"modify"},{pattern:/å¤‰ãˆã¦/,keyword:"å¤‰ãˆã¦",type:"modify"},{pattern:/ä¿®æ­£/,keyword:"ä¿®æ­£",type:"modify"},{pattern:/èª¿æ•´/,keyword:"èª¿æ•´",type:"modify"},{pattern:/move/i,keyword:"move",type:"modify"},{pattern:/change/i,keyword:"change",type:"modify"},{pattern:/modify/i,keyword:"modify",type:"modify"},{pattern:/edit/i,keyword:"edit",type:"modify"},{pattern:/ä½œã£ã¦/,keyword:"ä½œã£ã¦",type:"generate"},{pattern:/ç”Ÿæˆ/,keyword:"ç”Ÿæˆ",type:"generate"},{pattern:/ä½œæˆ/,keyword:"ä½œæˆ",type:"generate"},{pattern:/æã„ã¦/,keyword:"æã„ã¦",type:"generate"},{pattern:/æ›¸ã„ã¦/,keyword:"æ›¸ã„ã¦",type:"generate"},{pattern:/create/i,keyword:"create",type:"generate"},{pattern:/generate/i,keyword:"generate",type:"generate"},{pattern:/make/i,keyword:"make",type:"generate"},{pattern:/draw/i,keyword:"draw",type:"generate"}]}applyKeywordHighlighting(){}createHighlightOverlay(e,t){this.clearKeywordHighlighting(),this.highlightOverlay=document.createElement("div"),this.highlightOverlay.className="keyword-highlight-overlay";const n=window.getComputedStyle(this.input);this.inputDefaultStyles||this.captureInputDefaultStyles(),this.highlightOverlay.style.cssText=`\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      white-space: pre-wrap;\n      word-wrap: break-word;\n      overflow: hidden;\n      font-family: ${n.fontFamily};\n      font-size: ${n.fontSize};\n      font-weight: ${n.fontWeight};\n      line-height: ${n.lineHeight};\n      letter-spacing: ${n.letterSpacing};\n      padding: ${n.padding};\n      border: ${n.borderWidth} solid transparent;\n      margin: 0;\n      z-index: 1;\n      color: transparent;\n      background: transparent;\n    `;let i="",o=0;for(const n of t){i+=this.escapeHtml(e.substring(o,n.start));const t=this.getKeywordColor(n.type);i+=`<span style="color: ${t}; font-weight: 600; background: linear-gradient(135deg, ${t}22 0%, ${t}11 100%); border-radius: 3px; padding: 1px 2px;">${this.escapeHtml(n.keyword)}</span>`,o=n.end}i+=this.escapeHtml(e.substring(o)),this.highlightOverlay.innerHTML=i,this.input.style.background="transparent",this.input.style.backgroundColor="transparent",this.input.style.backgroundImage="none",this.input.style.color=this.getInputTextColor(),this.inputWrapper.insertBefore(this.highlightOverlay,this.input)}getKeywordColor(e){return"#ff6ad5"}getInputTextColor(){return this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937"}captureInputDefaultStyles(){if(!this.input)return;const e=window.getComputedStyle(this.input);this.inputDefaultStyles={background:e.background,backgroundImage:e.backgroundImage,backgroundColor:e.backgroundColor,color:e.color}}clearKeywordHighlighting(){this.highlightOverlay&&(this.highlightOverlay.remove(),this.highlightOverlay=null),this.input&&(this.inputDefaultStyles?(this.input.style.background=this.inputDefaultStyles.background,this.input.style.backgroundImage=this.inputDefaultStyles.backgroundImage,this.input.style.backgroundColor=this.inputDefaultStyles.backgroundColor,this.input.style.color=this.inputDefaultStyles.color):(this.input.style.background="",this.input.style.backgroundImage="",this.input.style.backgroundColor="",this.input.style.color=""))}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}detectMediaType(e){return[/å‹•ç”»|ãƒ“ãƒ‡ã‚ª|æ˜ åƒ|ãƒ ãƒ¼ãƒ“ãƒ¼/,/video|movie|clip/i].some(t=>t.test(e))?{type:"video",confidence:.8,reason:"å‹•ç”»ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰"}:[/ç”»åƒ|å†™çœŸ|çµµ|ã‚¤ãƒ©ã‚¹ãƒˆ|ã‚¤ãƒ¡ãƒ¼ã‚¸/,/image|picture|photo|illustration/i].some(t=>t.test(e))?{type:"image",confidence:.8,reason:"ç”»åƒç”Ÿæˆã‚³ãƒãƒ³ãƒ‰"}:{type:"image",confidence:.6,reason:"ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰ï¼ˆç”»åƒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰"}}showCommandTypeIndicator(e){const{type:t,confidence:n,reason:i}=e;n<.7?this.showProactiveSuggestion(t,n):this.hideProactiveSuggestion(),this.enableGestureControl()}showProactiveSuggestion(e,t){this.proactiveSuggestion||(this.proactiveSuggestion=document.createElement("div"),this.proactiveSuggestion.id="proactive-suggestion",this.proactiveSuggestion.style.cssText="\n        margin-bottom: 0;\n        padding: 10px;\n        background: rgba(255, 193, 7, 0.15);\n        border: 1px solid rgba(255, 193, 7, 0.3);\n        border-radius: 8px;\n        font-size: 12px;\n        color: #ffc107;\n        text-align: center;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      ",this.container.insertBefore(this.proactiveSuggestion,this.input));const n=["generate","modify","delete"].filter(t=>t!==e)[0];this.proactiveSuggestion.innerHTML=`\n      ğŸ’¡ ã‚‚ã—ã‹ã—ã¦ã€Œ${{generate:"ğŸ¨ ç”Ÿæˆ",modify:"âœï¸ å¤‰æ›´",delete:"ğŸ—‘ï¸ å‰Šé™¤"}[n]}ãƒ¢ãƒ¼ãƒ‰ã€ã§ã™ã‹ï¼Ÿ\n      <div style="margin-top: 4px; font-size: 10px; opacity: 0.8;">\n        ã‚¯ãƒªãƒƒã‚¯ã§å¤‰æ›´ | ã‚¹ãƒ¯ã‚¤ãƒ—ã§é¸æŠ\n      </div>\n    `,this.proactiveSuggestion.style.display="block",this.proactiveSuggestion.onclick=()=>{this.currentMode=n,this.hideProactiveSuggestion(),this.updateIndicatorForMode(n,.9)}}hideProactiveSuggestion(){this.proactiveSuggestion&&(this.proactiveSuggestion.style.display="none")}updateIndicatorForMode(e,t){}enableGestureControl(){this.gestureEnabled=!0}createActionButtons(){const e=document.createElement("div");e.style.cssText="\n      display: flex;\n      margin-top: 8px;\n      gap: 8px;\n    ";const t=document.createElement("button");return t.innerHTML="ğŸ§¹ å…¨å‰Šé™¤",t.style.cssText=this.getModernButtonStyles("danger"),t.addEventListener("click",()=>this.clearAll()),e.appendChild(t),e}getContainerStyles(){const e={"bottom-right":"bottom: 20px; right: 20px;","bottom-left":"bottom: 20px; left: 20px;","top-right":"top: 20px; right: 20px;","top-left":"top: 20px; left: 20px;",center:"top: 50%; left: 50%; transform: translate(-50%, -50%);"},t=this.isWabiSabiMode?{background:"linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))",backdropFilter:"blur(20px) saturate(120%)",border:"1px solid rgba(93, 64, 55, 0.5)",boxShadow:"0 8px 32px rgba(33, 33, 33, 0.4), 0 0 0 1px rgba(93, 64, 55, 0.4), inset 0 1px 0 rgba(189, 189, 189, 0.15)"}:this.isDarkMode?{background:"linear-gradient(135deg, rgba(15, 23, 42, 0.7), rgba(30, 27, 75, 0.65))",backdropFilter:"blur(24px) saturate(180%)",border:"1px solid rgba(99, 102, 241, 0.2)",boxShadow:"0 8px 32px rgba(15, 23, 42, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1)"}:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))",backdropFilter:"blur(24px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.4)",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3)"};return`\n      position: fixed;\n      ${e[this.config.position]||e["bottom-right"]}\n      width: 320px;\n      max-height: ${this.config.maxHeight}px;\n      background: ${t.background};\n      border: ${t.border};\n      border-radius: 20px;\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;\n      font-size: 14px;\n      z-index: 1000;\n      padding: 16px !important;\n      box-shadow: ${t.boxShadow};\n      backdrop-filter: ${t.backdropFilter};\n      -webkit-backdrop-filter: ${t.backdropFilter};\n      display: none;\n      flex-direction: column;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    `}getHeaderStyles(){return"\n      margin-bottom: 20px;\n      text-align: center;\n      background: linear-gradient(135deg, #4f46e5, #7c3aed);\n      -webkit-background-clip: text;\n      -webkit-text-fill-color: transparent;\n      background-clip: text;\n      font-weight: 800;\n      font-size: 18px;\n      border-bottom: 1px solid rgba(79, 70, 229, 0.2);\n      padding-bottom: 12px;\n    "}getOutputStyles(){return this.addScrollbarStyles(),`\n      height: 200px;\n      overflow-y: auto;\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.05)":"rgba(255, 255, 255, 0.1)"};\n      border: 1px solid ${this.isDarkMode?"rgba(255, 255, 255, 0.15)":"rgba(255, 255, 255, 0.2)"};\n      border-radius: 12px;\n      padding: 12px;\n      margin-bottom: 16px;\n      font-size: 12px;\n      line-height: 1.4;\n      backdrop-filter: blur(8px);\n\n      /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */\n      scrollbar-width: thin;\n      scrollbar-color: ${this.isDarkMode?"rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.3) rgba(0, 0, 0, 0.1)"};\n    `}addScrollbarStyles(){if(document.getElementById("custom-scrollbar-styles"))return;const e=document.createElement("style");e.id="custom-scrollbar-styles",e.textContent=`\n      .command-output::-webkit-scrollbar {\n        width: 8px;\n      }\n\n      .command-output::-webkit-scrollbar-track {\n        background: ${this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"};\n        border-radius: 4px;\n      }\n\n      .command-output::-webkit-scrollbar-thumb {\n        background: ${this.isDarkMode?"rgba(255, 255, 255, 0.3)":"rgba(0, 0, 0, 0.3)"};\n        border-radius: 4px;\n        transition: background 0.2s ease;\n      }\n\n      .command-output::-webkit-scrollbar-thumb:hover {\n        background: ${this.isDarkMode?"rgba(255, 255, 255, 0.5)":"rgba(0, 0, 0, 0.5)"};\n      }\n\n      /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ */\n      .dark-mode .command-output::-webkit-scrollbar-track {\n        background: rgba(255, 255, 255, 0.1);\n      }\n\n      .dark-mode .command-output::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      .dark-mode .command-output::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.5);\n      }\n\n      /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ */\n      .light-mode .command-output::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.1);\n      }\n\n      .light-mode .command-output::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      .light-mode .command-output::-webkit-scrollbar-thumb:hover {\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      @keyframes shimmer {\n        0% { background-position: -200% 0; }\n        100% { background-position: 200% 0; }\n      }\n\n      /* 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: å¾®ç´°ãªæµ®éŠæ„Ÿã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */\n      @keyframes gentleFloat {\n        0%, 100% { \n          transform: translateY(0px) scale(1);\n        }\n        25% { \n          transform: translateY(-2px) scale(1.005);\n        }\n        50% { \n          transform: translateY(-1px) scale(1.002);\n        }\n        75% { \n          transform: translateY(-3px) scale(1.008);\n        }\n      }\n\n      /* ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ›ãƒãƒ¼åŠ¹æœ */\n      .task-status-container:hover .progress-bar {\n        box-shadow: 0 0 20px rgba(255,123,71,0.6) !important;\n        transform: scaleY(1.1);\n      }\n\n      /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®å¾®ç´°ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */\n      .progress-bar {\n        position: relative;\n      }\n\n      .progress-bar::after {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: linear-gradient(90deg, \n          transparent, \n          rgba(255,255,255,0.4), \n          transparent);\n        animation: progress-shine 2s ease-in-out infinite;\n      }\n\n      @keyframes progress-shine {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(100%); }\n      }\n    `,document.head.appendChild(e)}getInputStyles(){const e=this.isWabiSabiMode?{background:"linear-gradient(135deg, rgba(97, 97, 97, 0.4), rgba(66, 66, 66, 0.3))",border:"1px solid rgba(97, 97, 97, 0.5)",boxShadow:"0 4px 16px rgba(66, 66, 66, 0.3), inset 0 1px 0 rgba(189, 189, 189, 0.2)"}:this.isDarkMode?{background:"linear-gradient(135deg, rgba(30, 27, 75, 0.4), rgba(15, 23, 42, 0.5))",border:"1px solid rgba(99, 102, 241, 0.25)",boxShadow:"0 4px 16px rgba(15, 23, 42, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08)"}:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))",border:"1px solid rgba(255, 255, 255, 0.5)",boxShadow:"0 4px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.4)"};return`\n      width: 100%;\n      padding: 14px 16px;\n      background: ${e.background};\n      border: ${e.border};\n      border-radius: 14px;\n      color: ${this.isWabiSabiMode?"#F5F5F5":this.isDarkMode?"#ffffff":"#1f2937"};\n      font-size: 14px;\n      outline: none;\n      box-sizing: border-box;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      font-family: inherit;\n      backdrop-filter: blur(16px);\n      -webkit-backdrop-filter: blur(16px);\n      box-shadow: ${e.boxShadow};\n      placeholder-color: ${this.isDarkMode?"rgba(255, 255, 255, 0.5)":"rgba(55, 65, 81, 0.6)"};\n      resize: none;\n      overflow-y: hidden;\n      min-height: 22px;\n      max-height: 66px;\n      line-height: 22px;\n    `}getModernButtonStyles(e){return`\n      border: none;\n      border-radius: 12px;\n      color: white;\n      cursor: pointer;\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      font-family: inherit;\n      outline: none;\n      ${{primary:this.isWabiSabiMode?"\n        background: linear-gradient(135deg, #8D6E63, #6D4C41);\n        box-shadow: 0 4px 12px rgba(85, 139, 47, 0.4), inset 0 1px 0 rgba(184, 158, 135, 0.15);\n        width: 100%;\n        padding: 16px;\n        font-size: 14px;\n        font-weight: 600;\n      ":"\n        background: linear-gradient(135deg, #4f46e5, #4338ca);\n        width: 100%;\n        padding: 16px;\n        font-size: 14px;\n        font-weight: 600;\n      ",secondary:this.isWabiSabiMode?"\n        background: rgba(158, 158, 158, 0.2);\n        border: 1px solid rgba(141, 110, 99, 0.4);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #F5F5F5;\n      ":"\n        background: rgba(255, 255, 255, 0.08);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n      ",danger:this.isWabiSabiMode?"\n        background: rgba(141, 110, 99, 0.3);\n        border: 1px solid rgba(93, 64, 55, 0.5);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #F5F5F5;\n      ":"\n        background: rgba(255, 59, 48, 0.15);\n        border: 1px solid rgba(255, 59, 48, 0.3);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #ff453a;\n      "}[e]}\n    `}getModeButtonStyles(e,t){return`\n      flex: 1;\n      padding: 12px 16px;\n      border: none;\n      border-radius: 8px;\n      color: ${e?"white":"rgba(255, 255, 255, 0.7)"};\n      background: ${e?{generate:"linear-gradient(135deg, #22c55e, #16a34a)",modify:"linear-gradient(135deg, #22c55e, #16a34a)",delete:"linear-gradient(135deg, #22c55e, #16a34a)"}[t]:"transparent"};\n      font-size: 13px;\n      font-weight: 600;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n    `}bindEvents(){document.addEventListener("keydown",e=>{if(e.key===this.config.activationKey)return e.preventDefault(),void this.toggle();this.isVisible&&"Escape"===e.key&&this.hide(),this.isVisible&&e.ctrlKey&&("z"!==e.key||e.shiftKey?("y"===e.key||"z"===e.key&&e.shiftKey)&&(e.preventDefault(),this.redo()):(e.preventDefault(),this.undo()))}),this.input.addEventListener("focus",()=>{this.isWabiSabiMode?(this.input.style.borderColor="#8BC34A",this.input.style.boxShadow="0 0 5px rgba(139, 195, 74, 0.5)"):(this.input.style.borderColor="#74b9ff",this.input.style.boxShadow="0 0 5px rgba(116, 185, 255, 0.5)")}),this.input.addEventListener("blur",()=>{this.isWabiSabiMode?(this.input.style.borderColor="#8D6E63",this.input.style.boxShadow="none"):(this.input.style.borderColor="#4a90e2",this.input.style.boxShadow="none")})}toggle(){this.isVisible?this.hide():this.show()}show(){this.container.style.display="flex",this.container.style.flexDirection="column",this.floatingContainer.style.display="flex",setTimeout(()=>{const e=this.container.getBoundingClientRect();this.floatingContainer.style.left=e.left+"px",this.floatingContainer.style.top=e.top-80+"px",this.floatingContainer.style.width=e.width+"px",this.floatingContainer.style.transform="none"},50),this.isVisible=!0,this.input.focus(),this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.opacity="0",this.floatingChocolateIcon.style.pointerEvents="none"),this.onControlsToggle(!0)}hide(){this.container.style.display="none",this.floatingContainer.style.display="none",this.isVisible=!1,this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.opacity="0.8",this.floatingChocolateIcon.style.pointerEvents="auto"),this.onControlsToggle(!1),this.logDebug("ğŸ® ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å†é–‹")}switchMode(e){if(this.currentMode===e)return;this.currentMode=e,this.container.querySelectorAll("[data-mode]").forEach(t=>{const n=t.dataset.mode===e;t.style.cssText=this.getModeButtonStyles(n,t.dataset.mode)}),this.input.placeholder=this.getPlaceholderForMode(e);const t=this.container.querySelector("#execute-btn");t.innerHTML=`<span>${{generate:"ğŸ¨ Generate Object",modify:"âœï¸ Apply Changes",delete:"ğŸ—‘ï¸ Delete Objects"}[e]}</span>`,t.style.background={generate:"linear-gradient(135deg, #5b21b6, #4c1d95)",modify:"linear-gradient(135deg, #ec4899, #be185d)",delete:"rgba(107, 114, 128, 0.15)"}[e]}getPlaceholderForMode(e){const t={generate:"ã€ŒçŒ«ã®ç”»åƒã‚’ä½œã£ã¦ã€ã¨è©±ã—ã‹ã‘ã¦ â âœ¨",import:"ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ â ğŸ“",modify:"é¸æŠå¾Œã€Œãƒ”ãƒ³ã‚¯ã«å¤‰æ›´ã€ã¨ä¼ãˆã¦ â âœï¸",delete:"é¸æŠå¾Œã€ã‚³ãƒãƒ³ãƒ‰ã‚’ãã®ã¾ã¾é€ã£ã¦ â ğŸ—‘ï¸"};return t[e]||t.generate}async executeCommand(){const e=this.input.value.trim();if(!e)return;const t=await this.preValidateCommand(e);t.canExecute&&await this.proceedWithExecution(e,t.commandType)}async showConfirmationDialog(e){const{icon:t="ğŸ—‘ï¸",title:n="ç¢ºèª",message:i="ã“ã®æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ",confirmText:o="å®Ÿè¡Œ",cancelText:a="ã‚­ãƒ£ãƒ³ã‚»ãƒ«",confirmColor:r="#ef4444"}=e;return new Promise(e=>{const s=document.createElement("div");s.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(15, 23, 42, 0.6);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        z-index: 2000;\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n      ";const l=document.createElement("div");l.style.cssText=`\n        background: ${this.isWabiSabiMode?"linear-gradient(135deg, rgba(239, 235, 233, 0.4), rgba(215, 204, 200, 0.3))":this.isDarkMode?"linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(30, 27, 75, 0.8))":"linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3))"};\n        border: 1px solid ${this.isWabiSabiMode?"rgba(161, 136, 127, 0.4)":this.isDarkMode?"rgba(99, 102, 241, 0.3)":"rgba(255, 255, 255, 0.5)"};\n        border-radius: 20px;\n        padding: 32px;\n        max-width: 420px;\n        text-align: center;\n        color: ${this.isWabiSabiMode?"#5D4037":this.isDarkMode?"#ffffff":"#1f2937"};\n        font-family: inherit;\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n        box-shadow: ${this.isWabiSabiMode?"0 8px 32px rgba(93, 64, 55, 0.2), 0 0 0 1px rgba(161, 136, 127, 0.2)":this.isDarkMode?"0 8px 32px rgba(15, 23, 42, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1)":"0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2)"};\n        transform: scale(0.9);\n        opacity: 0;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      `,l.innerHTML=`\n        <div style="font-size: 56px; margin-bottom: 20px;">${t}</div>\n        <h3 style="margin: 0 0 16px 0; color: ${this.isDarkMode?"#a5b4fc":"#6366f1"}; font-size: 20px; font-weight: 700; letter-spacing: 0.02em;">\n          ${n}\n        </h3>\n        <p style="margin: 0 0 28px 0; color: ${this.isDarkMode?"#d1d5db":"#6b7280"}; line-height: 1.6; font-size: 16px;">\n          ${i}\n        </p>\n        <div style="display: flex; gap: 8px; justify-content: center;">\n          <button id="cancel-btn" style="\n            padding: 14px 24px;\n            background: ${this.isDarkMode?"linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2))":"linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))"};\n            border: 1px solid ${this.isDarkMode?"rgba(156, 163, 175, 0.2)":"rgba(255, 255, 255, 0.3)"};\n            border-radius: 12px;\n            color: ${this.isDarkMode?"#d1d5db":"#374151"};\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 600;\n            transition: all 0.2s ease;\n            backdrop-filter: blur(16px);\n            -webkit-backdrop-filter: blur(16px);\n          ">${a}</button>\n          <button id="confirm-btn" style="\n            padding: 14px 24px;\n            background: ${r===(this.isWabiSabiMode?"#8BC34A":"#6366f1")?"linear-gradient(135deg, "+(this.isWabiSabiMode?"#8BC34A, #689F38":"#6366f1, #8b5cf6")+")":"#ef4444"===r?"linear-gradient(135deg, #ef4444, #dc2626)":"linear-gradient(135deg, #ff7b47, #f97316)"};\n            border: none;\n            border-radius: 12px;\n            color: white;\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 700;\n            transition: all 0.2s ease;\n            box-shadow: 0 4px 16px ${r===(this.isWabiSabiMode?"#8BC34A":"#6366f1")?"rgba(99, 102, 241, 0.3)":"#ef4444"===r?"rgba(239, 68, 68, 0.3)":"rgba(255, 123, 71, 0.3)"};\n            backdrop-filter: blur(8px);\n            -webkit-backdrop-filter: blur(8px);\n          ">${o}</button>\n        </div>\n      `,s.appendChild(l),document.body.appendChild(s),requestAnimationFrame(()=>{s.style.opacity="1",l.style.transform="scale(1)",l.style.opacity="1"}),l.querySelector("#cancel-btn").onclick=()=>{this.closeModalWithAnimation(s),e(!1)},l.querySelector("#confirm-btn").onclick=()=>{this.closeModalWithAnimation(s),e(!0)};const c=t=>{"Escape"===t.key&&(this.closeModalWithAnimation(s),document.removeEventListener("keydown",c),e(!1))};document.addEventListener("keydown",c),s.onclick=t=>{t.target===s&&(this.closeModalWithAnimation(s),e(!1))}})}async showDeleteConfirmation(e){return this.showConfirmationDialog({icon:"ğŸ—‘ï¸",title:"å‰Šé™¤ã®ç¢ºèª",message:`ã€Œ${e}ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚`,confirmText:"å‰Šé™¤å®Ÿè¡Œ",cancelText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«",confirmColor:"#ff7b47"})}addOutput(e,t="default",n={}){if("task"===t||"progress"===t)return this.addTaskCard(e,n);"error"!==t&&"system"!==t||this.addSystemMessage(e,t)}addTaskCard(e,t={}){this.taskCards||(this.taskCards=new Map);const n=t.taskId||`task_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,i=t.status||"pending",o=e.prompt||e.command||e,a=document.createElement("div");a.className="floating-task-card",a.setAttribute("data-task-id",n),"pending"!==i&&"processing"!==i&&"progress"!==i||a.classList.add("chocodrop-shimmer","chocodrop-float"),a.style.cssText=this.getFloatingCardStyles(i),a.style.setProperty("opacity","0","important"),a.style.setProperty("transform","translateY(20px) scale(0.95)","important"),a.style.setProperty("filter","blur(4px)","important");const r=this.getFriendlyMessage(i,o,t.errorMessage);return a.innerHTML=`\n      <span style="font-size: 14px;">${{pending:"â³",processing:"ğŸ¨",progress:"âš¡",completed:"âœ…",error:"âŒ"}[i]}</span>\n      <span style="font-size: 13px; margin-left: 6px;">${r}</span>\n    `,this.floatingContainer.insertBefore(a,this.floatingContainer.firstChild),this.updateCardDisplayLimit(),this.taskCards.set(n,{element:a,status:i,prompt:o,originalPrompt:o,startTime:Date.now(),endTime:null,error:null,contentType:"image",model:null,settings:null}),this.addCardDetailEvents(a,n),this.animateCardEntrance(a),this.ensureShimmerStyles(),n}ensureShimmerStyles(){if(document.querySelector("#chocodrop-shimmer-styles"))return;const e=document.createElement("style");e.id="chocodrop-shimmer-styles",e.textContent=`\n      /* 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: ã‚·ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå¼·åŒ–ç‰ˆï¼‰ */\n      .chocodrop-shimmer {\n        position: relative;\n        overflow: hidden;\n      }\n      \n      .chocodrop-shimmer::before {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: -100%;\n        width: 100%;\n        height: 100%;\n        background: linear-gradient(\n          90deg,\n          transparent,\n          ${this.isDarkMode?"rgba(255, 255, 255, 0.5)":"rgba(255, 255, 255, 0.7)"},\n          transparent\n        );\n        animation: shimmer 1.5s infinite;\n        pointer-events: none;\n        z-index: 1;\n      }\n      \n      .chocodrop-shimmer > * {\n        position: relative;\n        z-index: 2;\n      }\n      \n      /* 2025å¹´ãƒˆãƒ¬ãƒ³ãƒ‰: å¾®ç´°ãªæµ®éŠæ„Ÿ */\n      .chocodrop-float {\n        animation: gentleFloat 4s ease-in-out infinite;\n      }\n      \n      /* å¾…æ©Ÿä¸­ã®ç‰¹åˆ¥ãªãƒ‘ãƒ«ã‚¹åŠ¹æœï¼ˆå¼·åŒ–ç‰ˆï¼‰ */\n      .chocodrop-shimmer.floating-task-card {\n        animation: gentleFloat 4s ease-in-out infinite, subtlePulse 3s ease-in-out infinite;\n      }\n      \n      @keyframes subtlePulse {\n        0%, 100% { \n          box-shadow: 0 8px 32px rgba(15, 23, 42, 0.3), 0 0 0 1px rgba(99, 102, 241, 0.1);\n        }\n        50% { \n          box-shadow: 0 12px 40px rgba(15, 23, 42, 0.5), 0 0 0 1px rgba(99, 102, 241, 0.3);\n        }\n      }\n    `,document.head.appendChild(e)}updateTaskCard(e,t,n={}){if(!this.taskCards||!this.taskCards.has(e))return;const i=this.taskCards.get(e),o=i.element;i.status=t,"error"===t&&n.errorMessage&&(i.error=n.errorMessage),"pending"===t||"processing"===t||"progress"===t?o.classList.add("chocodrop-shimmer","chocodrop-float"):o.classList.remove("chocodrop-shimmer","chocodrop-float");const a=this.getFriendlyMessage(t,i.prompt,i.error);o.innerHTML=`\n      <span style="font-size: 14px;">${{pending:"â³",processing:"ğŸ¨",progress:"âš¡",completed:"âœ…",error:"âŒ"}[t]}</span>\n      <span style="font-size: 13px; margin-left: 6px;">${a}</span>\n    `,o.style.cssText=this.getFloatingCardStyles(t),"completed"===t?this.animateCardSuccess(o,e):"error"===t&&this.animateCardError(o,e)}addSystemMessage(e,t){const n=document.createElement("div");n.className=`system-message ${t}`,n.style.cssText=`\n      padding: 8px 12px;\n      margin: 4px 0;\n      border-radius: 8px;\n      font-size: 12px;\n      line-height: 1.4;\n      animation: slideIn 0.3s ease-out;\n      background: ${"error"===t?"rgba(239, 68, 68, 0.1)":"rgba(107, 114, 128, 0.1)"};\n      border: 1px solid ${"error"===t?"rgba(239, 68, 68, 0.3)":"rgba(107, 114, 128, 0.3)"};\n      color: ${"error"===t?"#fca5a5":this.isDarkMode?"#d1d5db":"#6b7280"};\n    `,n.textContent=e,this.outputDiv.appendChild(n),this.scrollToBottom()}showInputFeedback(e,t="error",n={}){if("success"===t)return;if("error"===t?this.addOutput(`âš ï¸ ${e}`,"error"):this.addOutput(`ğŸ’¡ ${e}`,"system"),!this.feedbackOverlay){const e=document.createElement("div");e.className="input-feedback-overlay",e.style.cssText="\n        position: absolute;\n        left: 16px;\n        right: 16px;\n        bottom: 12px;\n        z-index: 1200;\n        pointer-events: auto;\n        display: flex;\n        gap: 8px;\n        align-items: center;\n        padding: 12px 16px;\n        border-radius: 12px;\n        backdrop-filter: blur(10px);\n        -webkit-backdrop-filter: blur(10px);\n        transition: opacity 180ms ease, transform 180ms ease;\n        opacity: 0;\n        transform: translateY(8px);\n      ",this.container.appendChild(e),this.feedbackOverlay=e}const i=this.feedbackOverlay;i.innerHTML="";const o="error"===t,a=o?this.isDarkMode?"rgba(239, 68, 68, 0.28)":"rgba(239, 68, 68, 0.18)":this.isDarkMode?"rgba(59, 130, 246, 0.25)":"rgba(59, 130, 246, 0.18)",r=o?"1px solid rgba(239, 68, 68, 0.45)":"1px solid rgba(59, 130, 246, 0.35)",s=o?this.isDarkMode?"#fca5a5":"#b91c1c":this.isDarkMode?"#bfdbfe":"#1d4ed8";i.style.background=a,i.style.border=r,i.style.color=s;const l=document.createElement("span");if(l.textContent=e,l.style.flex="1",i.appendChild(l),n.actions&&Array.isArray(n.actions)&&n.actions.length>0){const e=document.createElement("div");e.style.cssText="\n        display: flex;\n        gap: 8px;\n      ",n.actions.forEach(t=>{const n=document.createElement("button");n.type="button",n.textContent=t.label,n.style.cssText=`\n          padding: 6px 12px;\n          border-radius: 999px;\n          border: none;\n          cursor: pointer;\n          background: ${o?"rgba(239, 68, 68, 0.28)":"rgba(59, 130, 246, 0.25)"};\n          color: inherit;\n          font-size: 11px;\n          transition: background 0.2s ease;\n        `,n.addEventListener("mouseenter",()=>{n.style.background=o?"rgba(239, 68, 68, 0.38)":"rgba(59, 130, 246, 0.35)"}),n.addEventListener("mouseleave",()=>{n.style.background=o?"rgba(239, 68, 68, 0.28)":"rgba(59, 130, 246, 0.25)"}),n.addEventListener("click",()=>{"function"==typeof t.onClick&&t.onClick()}),e.appendChild(n)}),i.appendChild(e)}this.feedbackAutoClearTimer&&(clearTimeout(this.feedbackAutoClearTimer),this.feedbackAutoClearTimer=null),i.style.pointerEvents="auto",i.style.opacity="1",i.style.transform="translateY(0)",this.currentFeedback=i,"info"===t&&(this.feedbackAutoClearTimer=setTimeout(()=>this.clearInputFeedback(),n.duration||3e3))}clearInputFeedback(){if(this.feedbackAutoClearTimer&&(clearTimeout(this.feedbackAutoClearTimer),this.feedbackAutoClearTimer=null),this.currentFeedback){const e=this.currentFeedback;e.style.pointerEvents="none",e.style.opacity="0",e.style.transform="translateY(8px)",this.currentFeedback=null,setTimeout(()=>{e.innerHTML=""},180)}}ensureFeedbackStyles(){if(document.getElementById("feedback-styles"))return;const e=document.createElement("style");e.id="feedback-styles",e.textContent="\n      @keyframes feedbackSlideIn {\n        from {\n          opacity: 0;\n          transform: translateY(-10px);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n      \n      @keyframes feedbackSlideOut {\n        from {\n          opacity: 1;\n          transform: translateY(0);\n        }\n        to {\n          opacity: 0;\n          transform: translateY(-10px);\n        }\n      }\n    ",document.head.appendChild(e)}async preValidateCommand(e){const t=this.sceneManager?.selectedObject||this.selectedFile,n=this.analyzeCommandType(e,t);if(this.selectedFile&&(n.type="import",n.mediaType="video"===this.selectedFile.type?"video":"image",n.needsTarget=!1,n.requiresConfirmation=!1,n.hasExplicitTarget=!0,n.detectedKeyword=n.detectedKeyword||"import"),n.type&&this.selectMode&&n.type!==this.currentMode&&this.selectMode(n.type,!1,n.detectedKeyword||null),"empty"===n.type)return this.showInputFeedback("ğŸ’¡ ä½•ã‚’ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„","info"),{canExecute:!1,reason:"empty_command"};if(n.needsTarget&&!t){if(!(!!this.sceneManager&&(n.hasExplicitTarget||"modify"===n.type)))return this.showInputFeedback("ğŸ¯ æ“ä½œå¯¾è±¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“","error",{actions:[{label:"é¸æŠã™ã‚‹",onClick:()=>{this.clearInputFeedback(),this.showInputFeedback("ğŸ‘† 3Dã‚·ãƒ¼ãƒ³å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã—ã¦ãã ã•ã„","info")}},{label:"ãƒ’ãƒ³ãƒˆ",onClick:()=>{this.clearInputFeedback(),this.showInputFeedback("ğŸ’¡ ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸçŒ«ã‚’ã€ã€Œé¸æŠã—ãŸç”»åƒã‚’ã€ã®ã‚ˆã†ã«å¯¾è±¡ã‚’æ˜ç¤ºã—ã¦ã¿ã¦ãã ã•ã„","info")}}]}),{canExecute:!1,reason:"no_target_selected"};this.logDebug("ğŸ” Searching for explicitly mentioned target...");try{const t=await(this.sceneManager?.findObjectByKeyword(e));return t?(this.sceneManager.selectObject(t),this.showInputFeedback(`âœ¨ ã€Œ${t.name||t.userData?.originalPrompt||"ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"}ã€ã‚’è¦‹ã¤ã‘ã¾ã—ãŸï¼`,"success"),setTimeout(()=>this.executeCommandAfterValidation(e,n),1e3),{canExecute:!1,reason:"target_found_waiting"}):(this.showInputFeedback("ğŸ” æŒ‡å®šã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“","error",{actions:[{label:"é¸æŠã™ã‚‹",onClick:()=>{this.clearInputFeedback(),this.showInputFeedback("ğŸ‘† 3Dã‚·ãƒ¼ãƒ³å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã—ã¦ãã ã•ã„","info")}},{label:"æ–°è¦ä½œæˆã«å¤‰æ›´",onClick:()=>{const t=this.convertToGenerateCommand(e);this.input.value=t,this.clearInputFeedback(),this.showInputFeedback("âœï¸ ã‚³ãƒãƒ³ãƒ‰ã‚’æ–°è¦ä½œæˆç”¨ã«å¤‰æ›´ã—ã¾ã—ãŸ","success")}}]}),{canExecute:!1,reason:"target_not_found"})}catch(e){return this.logDebug("âŒ Error searching for target:",e),this.showInputFeedback("âš ï¸ å¯¾è±¡ã®æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ","error"),{canExecute:!1,reason:"search_error"}}}return{canExecute:!0,commandType:n}}async executeCommandAfterValidation(e,t){this.clearInputFeedback(),await this.proceedWithExecution(e,t)}async proceedWithExecution(e,t){const n=this.sceneManager?.selectedObject||this.selectedFile;if(t||(t=this.analyzeCommandType(e,n)),this.selectedFile?("import"!==this.currentMode&&this.selectMode("import",!1),this.currentMode="import"):this.currentMode=t.type,t.requiresConfirmation){if(!await this.showDeleteConfirmation(e))return void this.addOutput("âŒ å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ","system")}this.input.value="",this.clearInputFeedback(),this.hideProactiveSuggestion();const i=this.addTaskCard(e,{status:"processing"});let o;this.saveCommandToHistory({command:e,mode:this.currentMode,mediaType:t.mediaType,timestamp:Date.now()});try{const n=`${this.getModePrefix(this.currentMode)}${e}`;if(this.logDebug("ğŸ” Current mode check:",this.currentMode),"import"===this.currentMode){if(this.logDebug("ğŸ“ Import mode detected - bypassing SceneManager"),!this.selectedFile)throw new Error("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");o=await this.handleImportCommand(e)}else if(this.sceneManager)o=await this.sceneManager.executeCommand(n);else{if(!this.client)throw new Error("SceneManager ã¾ãŸã¯ Client ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");if("generate"===this.currentMode)o="video"===t.mediaType?await this.client.generateVideo(e,{model:this.selectedVideoService||void 0}):await this.client.generateImage(e,{service:this.selectedImageService||void 0});else if("modify"===this.currentMode){const t=this.sceneManager?.selectedObject;if(!t)throw new Error("å¤‰æ›´ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšå¯¾è±¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");o=await this.client.modifySelectedObject(t,e)}else if("delete"===this.currentMode){const t=this.sceneManager?.selectedObject;if(!t&&!this.sceneManager?.getSelectedObjects()?.length)return void this.addOutput("âš ï¸ å‰Šé™¤ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãš3Dã‚·ãƒ¼ãƒ³å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã—ã¦ã‹ã‚‰ã€å†åº¦Deleteãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚","system");const n=`æœ¬å½“ã«ã€Œ${e}ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;if(!confirm(n))return void this.addOutput("âŒ å‰Šé™¤ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ","system");o=await this.client.deleteObjects(e)}else o=await this.client.executeCommand(n)}o&&o.taskId&&(this.connectToProgress(o.taskId,i),this.currentTaskId=o.taskId),i&&this.updateTaskCard(i,"completed"),o.modelName,o.objectId,o.position,t.mediaType}catch(e){const n={generate:`âŒ ${"video"===t.mediaType?"å‹•ç”»":"ç”»åƒ"}ç”Ÿæˆã‚¨ãƒ©ãƒ¼`,modify:"âŒ å¤‰æ›´ã‚¨ãƒ©ãƒ¼",delete:"âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼"};i&&this.updateTaskCard(i,"error",{errorMessage:e.message}),this.addOutput(`${n[this.currentMode]}: ${e.message}`,"error"),console.error("Command execution error:",e)}this.sceneManager&&this.sceneManager.selectedObject&&("modify"!==this.currentMode&&"delete"!==this.currentMode||setTimeout(()=>{this.sceneManager.deselectObject()},500)),this.config.autoScroll&&this.scrollToBottom()}convertToGenerateCommand(e){const t=[{from:/(.+)ã‚’å¤§ãã/,to:"å¤§ããª$1ã®ç”»åƒã‚’ä½œã£ã¦"},{from:/(.+)ã‚’å°ã•ã/,to:"å°ã•ãª$1ã®ç”»åƒã‚’ä½œã£ã¦"},{from:/(.+)ã‚’(.+)ã«/,to:"$2ã®$1ã®ç”»åƒã‚’ä½œã£ã¦"},{from:/(.+)ã‚’(.+)ã/,to:"$2ã„$1ã®ç”»åƒã‚’ä½œã£ã¦"}];for(const{from:n,to:i}of t)if(n.test(e))return e.replace(n,i);return`${e}ã®ç”»åƒã‚’ä½œã£ã¦`}getTaskCardStyles(e){const t={pending:"rgba(167, 139, 250, 0.3)",processing:"rgba(192, 132, 252, 0.5)",progress:"rgba(236, 72, 153, 0.4)",completed:"rgba(167, 139, 250, 0.4)",error:"rgba(239, 68, 68, 0.4)"};return`\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(255, 255, 255, 0.15)"};\n      border: 1px solid ${this.isDarkMode?"rgba(255, 255, 255, 0.15)":"rgba(255, 255, 255, 0.25)"};\n      border-radius: 12px;\n      padding: 16px;\n      margin-bottom: 12px;\n      backdrop-filter: blur(12px);\n      transition: all 0.3s ease;\n      animation: slideInUp 0.3s ease-out;\n    `+`border-left: 3px solid ${t[e]||t.pending};`}getFloatingCardStyles(e){const t=this.isDarkMode?{background:"linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 27, 75, 0.7))",border:"1px solid rgba(99, 102, 241, 0.25)",boxShadow:"0 8px 32px rgba(15, 23, 42, 0.3), 0 0 0 1px rgba(99, 102, 241, 0.1)",color:"#ffffff"}:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25))",border:"1px solid rgba(255, 255, 255, 0.4)",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.2)",color:"#1f2937"},n="pending"===e||"processing"===e||"progress"===e?`\n      position: relative;\n      overflow: hidden;\n      &::before {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: -100%;\n        width: 100%;\n        height: 100%;\n        background: linear-gradient(\n          90deg,\n          transparent,\n          ${this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(255, 255, 255, 0.4)"},\n          transparent\n        );\n        animation: shimmer 2s infinite;\n      }\n    `:"";return`\n      height: 36px;\n      padding: 0 18px;\n      display: inline-flex;\n      align-items: center;\n      gap: 8px;\n      background: ${t.background};\n      backdrop-filter: blur(24px) saturate(180%);\n      -webkit-backdrop-filter: blur(24px) saturate(180%);\n      border: ${t.border};\n      border-radius: 18px;\n      color: ${t.color};\n      pointer-events: auto;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;\n      font-weight: 600;\n      font-size: 13px;\n      letter-spacing: 0.01em;\n      box-shadow: ${t.boxShadow};\n      transform: translateY(10px);\n      opacity: 0;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      ${n}\n      ${"pending"===e||"processing"===e||"progress"===e?"\n      animation: gentleFloat 4s ease-in-out infinite, shimmer 2s infinite;\n    ":""}\n      position: relative;\n      overflow: hidden;\n    `}updateCardDisplayLimit(){const e=Array.from(this.floatingContainer.children).filter(e=>!e.classList.contains("overflow-counter")),t=this.floatingContainer.querySelector(".overflow-counter");if(t&&t.remove(),e.length<=3)e.forEach(e=>{e.style.display="flex"});else{e.slice(0,3);const t=e.length-3;e.forEach((e,t)=>{e.style.display=t<3?"flex":"none"});const n=document.createElement("div");n.className="overflow-counter";const i=this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.12)",o=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.15)",a=this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(0, 0, 0, 0.6)";n.style.cssText=`\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 8px 12px;\n        margin: 4px 0;\n        background: ${i};\n        backdrop-filter: blur(20px);\n        border-radius: 12px;\n        border: 1px solid ${o};\n        font-size: 12px;\n        color: ${a};\n        font-weight: 500;\n        min-height: 32px;\n        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n        cursor: pointer;\n      `,n.innerHTML=`+ ${t}`,this.floatingContainer.appendChild(n);const r=this.isDarkMode?"rgba(255, 255, 255, 0.12)":"rgba(0, 0, 0, 0.18)";n.addEventListener("mouseenter",()=>{n.style.background=r,n.style.transform="scale(1.05)"}),n.addEventListener("mouseleave",()=>{n.style.background=i,n.style.transform="scale(1)"})}}addCardDetailEvents(e,t){if("ontouchstart"in window||navigator.maxTouchPoints>0)e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showTaskDetailModal(t)});else{let n;e.addEventListener("mouseenter",()=>{n=setTimeout(()=>{this.showTaskDetailModal(t)},800)}),e.addEventListener("mouseleave",()=>{n&&clearTimeout(n)}),e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showTaskDetailModal(t)})}}showTaskDetailModal(e){const t=this.taskCards.get(e);if(!t)return;const n=document.querySelector(".task-detail-modal");n&&n.remove();const i=this.createTaskDetailModal(t);document.body.appendChild(i),requestAnimationFrame(()=>{i.style.opacity="1",i.querySelector(".modal-content").style.transform="translateY(0) scale(1)"})}createTaskDetailModal(e){const t=document.createElement("div");t.className="task-detail-modal";const n=this.isDarkMode?"rgba(0, 0, 0, 0.6)":"rgba(0, 0, 0, 0.4)",i=this.isDarkMode?"rgba(20, 20, 20, 0.95)":"rgba(255, 255, 255, 0.95)",o=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",a=this.isDarkMode?"rgba(255, 255, 255, 0.9)":"rgba(0, 0, 0, 0.9)",r=this.isDarkMode?"rgba(255, 255, 255, 0.6)":"rgba(0, 0, 0, 0.6)";t.style.cssText=`\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: ${n};\n      backdrop-filter: blur(10px);\n      z-index: 100000;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      transition: opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: pointer;\n    `;const s=e.endTime?((e.endTime-e.startTime)/1e3).toFixed(1):((Date.now()-e.startTime)/1e3).toFixed(1),l="pending"===e.status?"å¾…æ©Ÿä¸­":"in-progress"===e.status?"å®Ÿè¡Œä¸­":"completed"===e.status?"å®Œäº†":"ã‚¨ãƒ©ãƒ¼",c=document.createElement("div");c.className="modal-content",c.style.cssText=`\n      background: ${i};\n      backdrop-filter: blur(30px);\n      border: 1px solid ${o};\n      border-radius: 16px;\n      padding: 16px !important;\n      max-width: 400px;\n      width: 90%;\n      max-height: 80vh;\n      overflow-y: auto;\n      transform: translateY(20px) scale(0.95);\n      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: default;\n      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n    `,c.innerHTML=`\n      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">\n        <h3 style="margin: 0; color: ${a}; font-size: 18px; font-weight: 600;">ã‚¿ã‚¹ã‚¯è©³ç´°</h3>\n        <button class="close-btn" style="\n          background: none;\n          border: none;\n          font-size: 24px;\n          color: ${r};\n          cursor: pointer;\n          padding: 0;\n          line-height: 1;\n          transition: color 0.2s;\n        ">Ã—</button>\n      </div>\n      \n      <div style="space-y: 16px;">\n        <div>\n          <div style="color: ${r}; font-size: 12px; font-weight: 500; margin-bottom: 0;">ğŸ“ å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</div>\n          <div style="color: ${a}; font-size: 14px; line-height: 1.4;">${e.originalPrompt}</div>\n        </div>\n        \n        <div>\n          <div style="color: ${r}; font-size: 12px; font-weight: 500; margin-bottom: 0;">ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>\n          <div style="color: ${a}; font-size: 14px;">${l}</div>\n        </div>\n        \n        <div>\n          <div style="color: ${r}; font-size: 12px; font-weight: 500; margin-bottom: 0;">â±ï¸ å®Ÿè¡Œæ™‚é–“</div>\n          <div style="color: ${a}; font-size: 14px;">${s}ç§’</div>\n        </div>\n        \n        ${e.error?`\n        <div>\n          <div style="color: ${r}; font-size: 12px; font-weight: 500; margin-bottom: 0;">âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°</div>\n          <div style="color: #ef4444; font-size: 14px; line-height: 1.4;">${e.error}</div>\n        </div>\n        `:""}\n        \n        <div>\n          <div style="color: ${r}; font-size: 12px; font-weight: 500; margin-bottom: 0;">ğŸ¨ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—</div>\n          <div style="color: ${a}; font-size: 14px;">${e.contentType||"ç”»åƒ"}</div>\n        </div>\n      </div>\n    `,c.addEventListener("click",e=>{e.stopPropagation()});const d=c.querySelector(".close-btn");return d.addEventListener("click",()=>{this.closeTaskDetailModal(t)}),d.addEventListener("mouseenter",()=>{d.style.color=a}),d.addEventListener("mouseleave",()=>{d.style.color=r}),t.addEventListener("click",()=>{this.closeTaskDetailModal(t)}),t.appendChild(c),t}closeTaskDetailModal(e){e.style.opacity="0",e.querySelector(".modal-content").style.transform="translateY(20px) scale(0.95)",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}animateCardEntrance(e){e.style.transform="translateY(20px) scale(0.95)",e.style.opacity="0",e.style.filter="blur(4px)",requestAnimationFrame(()=>{e.style.transition="all 0.6s cubic-bezier(0.16, 1, 0.3, 1)",e.style.transform="translateY(0) scale(1)",e.style.opacity="1",e.style.filter="blur(0px)",e.style.boxShadow="0 4px 20px rgba(255, 255, 255, 0.1), 0 0 40px rgba(255, 255, 255, 0.05)"})}animateCardSuccess(e,t){e.style.transition="all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",e.style.borderColor="rgba(76, 175, 80, 0.6)",e.style.transform="scale(1.08)",e.style.boxShadow="0 8px 32px rgba(76, 175, 80, 0.4), 0 0 60px rgba(76, 175, 80, 0.2)",e.style.filter="brightness(1.1) saturate(1.2)",setTimeout(()=>{e.style.transform="scale(1.02)",e.style.filter="brightness(1.05) saturate(1.1)"},150),setTimeout(()=>{this.animateCardExit(e,t)},2e3)}animateCardError(e,t){e.style.transition="all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",e.style.borderColor="rgba(244, 67, 54, 0.7)",e.style.boxShadow="0 8px 32px rgba(244, 67, 54, 0.3), 0 0 60px rgba(244, 67, 54, 0.15)",e.style.filter="saturate(1.3) brightness(1.1)",e.style.animation="errorPulse 0.6s cubic-bezier(0.16, 1, 0.3, 1) 2",this.addErrorTooltip(e,t),e.style.cursor="pointer",e.onclick=()=>this.animateCardExit(e,t),setTimeout(()=>{this.taskCards.has(t)&&this.animateCardExit(e,t)},5e3)}addErrorTooltip(e,t){const n=this.taskCards.get(t);if(!n||!n.error)return;const i=document.createElement("div");i.style.cssText="\n      position: absolute;\n      bottom: 100%;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(244, 67, 54, 0.95);\n      color: white;\n      padding: 8px 12px;\n      border-radius: 8px;\n      font-size: 11px;\n      white-space: nowrap;\n      pointer-events: none;\n      z-index: 1001;\n      backdrop-filter: blur(10px);\n      margin-bottom: 0;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n    ",i.textContent=n.error,e.style.position="relative",e.appendChild(i),requestAnimationFrame(()=>{i.style.opacity="1"}),setTimeout(()=>{i.parentNode&&(i.style.opacity="0",setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300))},3e3)}animateCardExit(e,t){e.style.transition="all 0.28s cubic-bezier(0.4, 0, 0.2, 1)",e.style.transform="translateY(-12px) scale(0.92)",e.style.opacity="0",e.style.filter="blur(6px) brightness(1.2)",e.style.boxShadow="0 0 40px rgba(255, 255, 255, 0.3), 0 0 80px rgba(255, 255, 255, 0.1)",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e),this.taskCards.delete(t),this.updateCardDisplayLimit()},280)}getResponseType(e){return/ã¡ã‚‡ã“ã£ã¨|ã¡ã‚‡ã“ã‚“|å°‘ã—|è»½ã/.test(e)||e.length<15?"casual":/ç¾ã—ã„|å¹»æƒ³|ç´ æ•µ|é­”æ³•|ä¸–ç•Œ|ç¶ºéº—/.test(e)?"magical":"balanced"}getFriendlyMessage(e,t,n=null){const i=t.length>15?t.substring(0,15)+"...":t,o=this.getResponseType(t);switch(e){case"pending":return"casual"===o?"ã¡ã‚‡ã“ã£ã¨æº–å‚™ä¸­ã§ã™...":"magical"===o?"é­”æ³•ã‚’ã‹ã‘ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...":"ã¡ã‚‡ã“ã£ã¨é­”æ³•ã®æº–å‚™ä¸­...";case"processing":case"in-progress":case"progress":return"modify"===this.currentMode?"casual"===o?"ã¡ã‚‡ã“ã£ã¨èª¿æ•´ä¸­ã§ã™...":"magical"===o?"ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å¤‰åŒ–ã•ã›ã¦ã„ã¾ã™...":"ã¡ã‚‡ã“ã‚“ã¨ç·¨é›†ä¸­ã§ã™...":"casual"===o?"ã¡ã‚‡ã“ã‚“ã¨é…ç½®ä¸­ã§ã™...":"magical"===o?"ã‚ãªãŸã®æƒ³ã„ã‚’å½¢ã«ã—ã¦ã„ã¾ã™...":"ã¡ã‚‡ã“ã£ã¨é­”æ³•ã‚’ã‹ã‘ã¦ã„ã¾ã™...";case"completed":return"delete"===this.currentMode?"casual"===o?"ã¡ã‚‡ã“ã£ã¨å‰Šé™¤ã—ã¾ã—ãŸï¼":"magical"===o?"ã™ã£ãã‚Šã¨ç‰‡ä»˜ãã¾ã—ãŸï¼":"ã¡ã‚‡ã“ã‚“ã¨å‰Šé™¤å®Œäº†ï¼ã™ã£ãã‚Šã§ã™ã­ï¼":"modify"===this.currentMode?"casual"===o?"ã¡ã‚‡ã“ã£ã¨èª¿æ•´ã—ã¾ã—ãŸï¼":"magical"===o?"ç´ æ•µã«å¤‰èº«ã—ã¾ã—ãŸï¼":"ã¡ã‚‡ã“ã‚“ã¨ç·¨é›†å®Œäº†ï¼ã„ã„æ„Ÿã˜ã§ã™ã­ï¼":"casual"===o?"ã¡ã‚‡ã“ã£ã¨ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã—ãŸï¼":"magical"===o?"ç´ æ•µãªä¸–ç•ŒãŒå®Œæˆã—ã¾ã—ãŸï¼":"ã¡ã‚‡ã“ã‚“ã¨é…ç½®å®Œäº†ï¼ç´ æ•µã§ã™ã­ï¼";case"error":if(n){return`âŒ ${n.length>30?n.substring(0,30)+"...":n}`}return"casual"===o?"ãŠã£ã¨ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ":"magical"===o?"ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ":"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„";default:return i}}getStatusColor(e){const t={pending:this.isDarkMode?"#a78bfa":"#7c3aed",processing:this.isDarkMode?"#c084fc":"#9333ea",progress:this.isDarkMode?"#ec4899":"#be185d",completed:this.isDarkMode?"#a78bfa":"#7c3aed",error:this.isDarkMode?"#f87171":"#dc2626"};return t[e]||t.pending}createStatusIndicator(e){return"processing"===e||"progress"===e?`\n        <div class="status-indicator" style="\n          background: ${this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.08)"};\n          border-radius: 8px;\n          height: 4px;\n          overflow: hidden;\n          margin-top: 8px;\n          position: relative;\n        ">\n          <div class="status-pulse" style="\n            background: linear-gradient(90deg, transparent, ${this.isWabiSabiMode?"#8BC34A, #689F38":"#6366f1, #8b5cf6"}, transparent);\n            height: 100%;\n            width: 30%;\n            border-radius: 8px;\n            animation: statusPulse 1.8s ease-in-out infinite;\n          "></div>\n        </div>\n        <div style="display: flex; align-items: center; gap: 4px; margin-top: 8px;">\n          <div class="status-dots" style="font-size: 10px; color: ${this.isDarkMode?"#c084fc":"#9333ea"};">\n            å‡¦ç†ä¸­<span style="animation: dots 1.5s infinite;">...</span>\n          </div>\n        </div>\n      `:""}animateTaskCompletion(e){e.style.animation="taskComplete 0.8s ease-out",this.addSubtleParticleEffect(e),setTimeout(()=>{e.style.animation=""},800),this.ensureTaskAnimations()}addSubtleParticleEffect(e){const t=e.getBoundingClientRect();for(let e=0;e<3;e++){const n=document.createElement("div");n.style.cssText=`\n        position: fixed;\n        width: 4px;\n        height: 4px;\n        background: linear-gradient(45deg, #a78bfa, #c084fc);\n        border-radius: 50%;\n        pointer-events: none;\n        z-index: 9999;\n        left: ${t.right-20}px;\n        top: ${t.top+10}px;\n        opacity: 0.8;\n        transform: scale(0);\n        animation: subtleParticle 1.2s ease-out forwards;\n      `;const i=e/3*Math.PI*2,o=15;n.style.setProperty("--move-x",Math.cos(i)*o+"px"),n.style.setProperty("--move-y",Math.sin(i)*o+"px"),document.body.appendChild(n),setTimeout(()=>n.remove(),1200)}}ensureTaskAnimations(){if(document.getElementById("task-animations"))return;const e=document.createElement("style");e.id="task-animations",e.textContent="\n      @keyframes slideInUp {\n        from { opacity: 0; transform: translateY(20px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n\n      @keyframes taskComplete {\n        0% {\n          transform: scale(1);\n          border-left-color: rgba(192, 132, 252, 0.5);\n        }\n        30% {\n          transform: scale(1.01);\n          background: rgba(167, 139, 250, 0.08);\n          border-left-color: rgba(167, 139, 250, 0.6);\n        }\n        60% {\n          background: rgba(167, 139, 250, 0.05);\n        }\n        100% {\n          transform: scale(1);\n          background: rgba(167, 139, 250, 0.02);\n          border-left-color: rgba(167, 139, 250, 0.4);\n        }\n      }\n\n      @keyframes subtleParticle {\n        0% {\n          transform: scale(0) translate(0, 0);\n          opacity: 0.8;\n        }\n        20% {\n          transform: scale(1) translate(0, 0);\n          opacity: 1;\n        }\n        100% {\n          transform: scale(0.3) translate(var(--move-x, 0), var(--move-y, 0));\n          opacity: 0;\n        }\n      }\n\n      @keyframes shimmer {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(100%); }\n      }\n\n      @keyframes slideIn {\n        from { opacity: 0; transform: translateX(-20px); }\n        to { opacity: 1; transform: translateX(0); }\n      }\n\n      @keyframes statusPulse {\n        0% { transform: translateX(-100%); }\n        50% { transform: translateX(300%); }\n        100% { transform: translateX(-100%); }\n      }\n\n      @keyframes dots {\n        0%, 20% { opacity: 0; }\n        50% { opacity: 1; }\n        100% { opacity: 0; }\n      }\n\n      @keyframes errorPulse {\n        0% {\n          transform: scale(1);\n          filter: saturate(1.3) brightness(1.1);\n        }\n        50% {\n          transform: scale(1.03);\n          filter: saturate(1.5) brightness(1.2);\n          box-shadow: 0 12px 40px rgba(244, 67, 54, 0.4), 0 0 80px rgba(244, 67, 54, 0.2);\n        }\n        100% {\n          transform: scale(1);\n          filter: saturate(1.3) brightness(1.1);\n        }\n      }\n    ",document.head.appendChild(e)}addTaskStatus(e,t=0,n=null){const i=n||`task_${Date.now()}`;return this.addTaskCard(e,{percent:Math.min(Math.max(t,0),100),taskId:i,status:t>0?"progress":"pending"})}updateTaskProgress(e,t,n=null){this.output.querySelector(`[data-task-id="${e}"]`)&&n&&this.addOutput(n,"progress",{percent:Math.min(Math.max(t,0),100),taskId:e})}completeTask(e){const t=this.output.querySelector(`[data-task-id="${e}"]`);t&&(t.style.transition="opacity 0.5s ease, transform 0.5s ease",t.style.opacity="0",t.style.transform="translateX(20px)",setTimeout(()=>{t.parentNode&&t.remove()},500))}connectToProgress(e,t=null){if(this.activeConnections.has(e))return;const n=new EventSource(`/api/progress/${e}`);this.activeConnections.set(e,n),n.onmessage=e=>{try{const n=JSON.parse(e.data);n.uiTaskId=t,this.handleProgressUpdate(n)}catch(e){console.error("SSE data parse error:",e)}},n.onerror=t=>{console.error("SSE connection error:",t),this.disconnectProgress(e)}}handleProgressUpdate(e){switch(e.type){case"connected":this.logDebug(`ğŸ”— Connected to progress stream: ${e.taskId}`);break;case"progress":void 0!==e.percent&&e.uiTaskId&&this.updateTaskCard(e.uiTaskId,"progress",{percent:e.percent});break;case"completed":e.uiTaskId&&this.updateTaskCard(e.uiTaskId,"completed"),this.disconnectProgress(e.taskId);break;case"error":e.uiTaskId&&this.updateTaskCard(e.uiTaskId,"error",{errorMessage:e.message}),this.addOutput(`âŒ ${e.message}`,"error"),this.disconnectProgress(e.taskId)}}disconnectProgress(e){const t=this.activeConnections.get(e);t&&(t.close(),this.activeConnections.delete(e))}scrollToBottom(){this.outputDiv&&(this.outputDiv.scrollTop=this.outputDiv.scrollHeight)}getModePrefix(e){return{generate:"",modify:"[å¤‰æ›´] ",delete:"[å‰Šé™¤] "}[e]||""}saveCommandToHistory(e){this.commandHistory=this.commandHistory.slice(0,this.currentHistoryIndex+1),this.commandHistory.push(e),this.currentHistoryIndex=this.commandHistory.length-1,this.commandHistory.length>this.maxHistorySize&&(this.commandHistory.shift(),this.currentHistoryIndex--),this.updateUndoRedoButtons()}undo(){if(!this.canUndo())return void this.addOutput("â†¶ Undoã§ãã‚‹æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“","hint");const e=this.commandHistory[this.currentHistoryIndex];this.currentHistoryIndex--,"generate"===e.mode?(this.addOutput(`â†¶ Undo: "${e.command}" ã®ç”Ÿæˆã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ`,"system"),this.sceneManager&&this.sceneManager.undoLastGenerate&&this.sceneManager.undoLastGenerate()):"modify"===e.mode?(this.addOutput(`â†¶ Undo: "${e.command}" ã®å¤‰æ›´ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ`,"system"),this.sceneManager&&this.sceneManager.undoLastModify&&this.sceneManager.undoLastModify()):"delete"===e.mode&&(this.addOutput(`â†¶ Undo: "${e.command}" ã®å‰Šé™¤ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ`,"system"),this.sceneManager&&this.sceneManager.undoLastDelete&&this.sceneManager.undoLastDelete()),this.updateUndoRedoButtons()}redo(){if(!this.canRedo())return void this.addOutput("â†· Redoã§ãã‚‹æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“","hint");this.currentHistoryIndex++;const e=this.commandHistory[this.currentHistoryIndex];this.addOutput(`â†· Redo: "${e.command}" ã‚’å†å®Ÿè¡Œã—ã¾ã—ãŸ`,"system"),this.sceneManager&&this.sceneManager.redoCommand&&this.sceneManager.redoCommand(e),this.updateUndoRedoButtons()}canUndo(){return this.currentHistoryIndex>=0}canRedo(){return this.currentHistoryIndex<this.commandHistory.length-1}updateUndoRedoButtons(){this.undoBtn&&(this.undoBtn.disabled=!this.canUndo(),this.undoBtn.style.opacity=this.canUndo()?"1":"0.4",this.undoBtn.style.cursor=this.canUndo()?"pointer":"not-allowed"),this.redoBtn&&(this.redoBtn.disabled=!this.canRedo(),this.redoBtn.style.opacity=this.canRedo()?"1":"0.4",this.redoBtn.style.cursor=this.canRedo()?"pointer":"not-allowed")}async clearAllWithConfirmation(){await this.showClearAllConfirmation()&&this.clearAll()}async showClearAllConfirmation(){return this.showConfirmationDialog({icon:"ğŸ§¹",title:"Clear All ã®ç¢ºèª",message:"ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚",confirmText:"Clear All å®Ÿè¡Œ",cancelText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«",confirmColor:this.isWabiSabiMode?"#8BC34A":"#6366f1"})}closeModalWithAnimation(e){const t=e.querySelector("div:last-child");t.style.transform="scale(0.9)",t.style.opacity="0",e.style.opacity="0",setTimeout(()=>{e.parentElement&&document.body.removeChild(e)},200)}clearAll(){this.sceneManager?(this.sceneManager.clearAll(),this.addOutput("ğŸ§¹ å…¨ã¦ã®å®Ÿé¨“ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ","system")):this.client&&this.addOutput("âš ï¸ ã‚µãƒ¼ãƒãƒ¼å´å‰Šé™¤ã¯æœªå®Ÿè£…","error")}showExamples(){this.addOutput("ğŸ’¡ ã‚³ãƒãƒ³ãƒ‰ä¾‹:","system"),["å³ä¸Šã«ãƒ‰ãƒ©ã‚´ãƒ³ã‚’ä½œã£ã¦","ä¸­å¤®ã«å¤§ããªãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³ã‚’ç”Ÿæˆ","å·¦ä¸‹ã«å°ã•ãªæ¡œã‚’ä½œã£ã¦","ç©ºã«é³³å‡°ã‚’ä½œã£ã¦","åœ°é¢ã«ç¥ç¤¾ã‚’ä½œã£ã¦"].forEach(e=>{this.addOutput(`   "${e}"`,"hint")})}setSceneManager(e){this.sceneManager=e,this.applyServiceSelectionToSceneManager()}setClient(e){this.client=e}updateConfig(e){this.config={...this.config,...e},e.activationKey&&this.bindEvents()}refreshStyles(){const e=this.container?.querySelector('[data-mode="generate"]');e&&(e.style.cssText=this.getModeButtonStyles(!0,"generate"));const t=this.container?.querySelector("#execute-btn");t&&(t.style.cssText=this.getModernButtonStyles("primary")),this.serviceModal&&this.updateServiceModalStyles(),this.updateServiceSelectorTheme()}updateServiceModalStyles(){this.serviceModal&&(this.serviceModal.style.background=this.isWabiSabiMode?"linear-gradient(135deg, rgba(158, 158, 158, 0.4), rgba(189, 189, 189, 0.35))":this.isDarkMode?"linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(30, 27, 75, 0.8))":"linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3))",this.serviceModal.style.border=this.isWabiSabiMode?"1px solid rgba(141, 110, 99, 0.4)":this.isDarkMode?"1px solid rgba(99, 102, 241, 0.3)":"1px solid rgba(255, 255, 255, 0.5)",this.serviceModal.style.color=this.isWabiSabiMode?"#424242":this.isDarkMode?"#ffffff":"#1f2937",this.serviceModal.style.boxShadow=this.isWabiSabiMode?"0 20px 40px rgba(93, 64, 55, 0.35)":"0 20px 40px rgba(15, 23, 42, 0.35)")}toggleTheme(){switch(this.currentTheme){case"light":this.currentTheme="dark";break;case"dark":this.currentTheme="wabisabi";break;default:this.currentTheme="light"}if(this.isDarkMode="dark"===this.currentTheme,this.isWabiSabiMode="wabisabi"===this.currentTheme,localStorage.setItem("live-command-theme",this.currentTheme),this.themeToggle){const e={light:{icon:"ğŸŒ™",title:"ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ"},dark:{icon:"ğŸµ",title:"ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ"},wabisabi:{icon:"â˜€ï¸",title:"ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ"}}[this.currentTheme];"â˜€ï¸"===e.icon?this.themeToggle.innerHTML=`<span style="filter: saturate(1.2) brightness(1.1);">${e.icon}</span>`:"ğŸµ"===e.icon?this.themeToggle.innerHTML=`<span style="filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);">${e.icon}</span>`:this.themeToggle.innerHTML=`<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">${e.icon}</span>`,this.themeToggle.title=e.title}this.applyTheme()}applyTheme(){document.body.className=this.isWabiSabiMode?"wabisabi-mode":this.isDarkMode?"dark-mode":"light-mode";const e=this.container.style.display,t=this.container.style.flexDirection;this.container.style.cssText=this.getContainerStyles(),this.container.style.display=e||"flex",this.container.style.flexDirection=t||"column";const n=this.container.querySelector(".floating-brand-badge");n&&(n.style.background=this.isDarkMode?"linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.7))":"linear-gradient(135deg, rgba(99, 102, 241, 0.9), rgba(139, 92, 246, 0.8))",n.style.border="1px solid "+(this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(255, 255, 255, 0.4)"));const i=!!this.highlightOverlay;if(this.inputDefaultStyles=null,this.clearKeywordHighlighting(),this.input.style.cssText=this.getInputStyles(),this.captureInputDefaultStyles(),(i||this.input&&this.input.value.trim())&&this.applyKeywordHighlighting(),this.output.style.cssText=this.getOutputStyles(),this.radioModeContainer&&(this.radioModeContainer.style.background=this.isWabiSabiMode?"linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))":this.isDarkMode?"linear-gradient(135deg, rgba(30, 27, 75, 0.3), rgba(15, 23, 42, 0.4))":"linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1))",this.radioModeContainer.style.borderColor=this.isWabiSabiMode?"rgba(93, 64, 55, 0.4)":this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(255, 255, 255, 0.25)",Object.keys(this.radioModeButtons).forEach(e=>{const{button:t}=this.radioModeButtons[e];this.currentMode!==e&&(t.style.color=this.isWabiSabiMode?"rgba(245, 245, 245, 0.8)":this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(55, 65, 81, 0.8)",t.style.background="transparent",t.style.border="1px solid transparent",t.style.boxShadow="none")}),this.selectMode(this.currentMode,!1)),this.clearBtn&&(this.clearBtn.style.cssText=this.getActionButtonStyles("secondary")),this.historyBtn&&(this.historyBtn.style.cssText=this.getActionButtonStyles("secondary"),this.historyBtn.style.opacity="0.5"),this.themeToggle){const e={light:{icon:"ğŸŒ™",title:"ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ"},dark:{icon:"ğŸµ",title:"ä¾˜ã³å¯‚ã³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ"},wabisabi:{icon:"â˜€ï¸",title:"ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ"}},t=e[this.currentTheme]||e.light;"â˜€ï¸"===t.icon?this.themeToggle.innerHTML=`<span style="filter: saturate(1.2) brightness(1.1);">${t.icon}</span>`:"ğŸµ"===t.icon?this.themeToggle.innerHTML=`<span style="filter: hue-rotate(80deg) saturate(1.1) brightness(1.0);">${t.icon}</span>`:this.themeToggle.innerHTML=`<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">${t.icon}</span>`,this.themeToggle.title=t.title,this.themeToggle.style.cssText=this.getActionButtonStyles("icon")}this.settingsButton&&(this.settingsButton.style.cssText=this.getActionButtonStyles("icon")),this.updateServiceSelectorTheme();const o=this.container.querySelector(".close-button");o&&(o.style.color=this.isDarkMode?"#ffffff":"#1f2937",o.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"),this.updateFloatingContainerTheme(),this.updateExistingTextColors()}updateFloatingContainerTheme(){if(!this.floatingContainer)return;const e=this.floatingContainer.style.display;this.taskCards&&this.taskCards.size>0&&this.taskCards.forEach((e,t)=>{const n=e.element;if(n){const e={background:"linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 27, 75, 0.7))",border:"1px solid rgba(99, 102, 241, 0.25)",color:"#ffffff"},t={background:"linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25))",border:"1px solid rgba(255, 255, 255, 0.4)",color:"#1f2937"},i=this.isDarkMode?e:t;n.style.setProperty("background",i.background,"important"),n.style.setProperty("border",i.border,"important"),n.style.setProperty("color",i.color,"important")}}),this.floatingContainer.style.display=e}updateExistingTextColors(){const e=this.isDarkMode?{system:"#60a5fa",command:"#93c5fd",success:"#f472b6",error:"#f87171",processing:"#fbbf24",info:"#d1d5db",hint:"#d1d5db"}:{system:"#1e40af",command:"#1d4ed8",success:"#be185d",error:"#dc2626",processing:"#d97706",info:"#7c3aed",hint:"#374151"},t=this.isDarkMode?"#d1d5db":"#374151";this.output.querySelectorAll("div").forEach(n=>{const i=n.textContent;let o="default";i.includes("ğŸ“‹")||i.includes("ğŸ¨")||i.includes("ğŸ®")||i.includes("UIèµ·å‹•")?o="system":i.startsWith("> ")?o="command":i.includes("âœ…")||i.includes("â­")||i.includes("ç”Ÿæˆã—ã¾ã—ãŸ")?o="success":i.includes("âŒ")||i.includes("ã‚¨ãƒ©ãƒ¼")?o="error":i.includes("ä¸­...")?o="processing":i.includes("ğŸ“")||i.includes("ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«:")||i.includes("ä½ç½®:")?o="info":i.includes("   ")&&(o="hint"),n.style.color=e[o]||t})}showImportInterface(){this.fileInput||(this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".glb,.gltf,.jpg,.jpeg,.png,.mp4,.mov",this.fileInput.style.display="none",this.fileInput.onchange=e=>this.handleFileSelection(e),document.body.appendChild(this.fileInput)),this.enableDragAndDrop()}hideImportInterface(){this.fileSelectButton&&this.fileSelectButton.parentNode&&this.fileSelectButton.parentNode.removeChild(this.fileSelectButton),this.disableDragAndDrop()}openFileSelector(){this.fileInput&&this.fileInput.click()}triggerFileSelection(){this.fileInput||this.showImportInterface(),this.openFileSelector(),this.selectMode("import",!0)}async handleFileSelection(e){const t=e.target.files[0];if(t)try{this.selectedFile&&this.selectedFile.url&&URL.revokeObjectURL(this.selectedFile.url);const e=this.detectFileType(t.name),n=URL.createObjectURL(t);this.selectedFile={file:t,url:n,type:e,name:t.name},this.selectMode("import",!0);const i=`ä¸­å¤®ã«è¨­ç½® (${t.name})`;this.input.value=i,this.addOutput(`ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ: ${t.name} (${e})`,"system"),this.addOutput(`ğŸš€ è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${i}`,"system"),setTimeout(()=>{this.executeCommand()},500)}catch(e){console.error("File selection error:",e),this.addOutput(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒ©ãƒ¼: ${e.message}`,"error")}finally{e.target&&(e.target.value="")}}enableDragAndDrop(){this.input&&(this.input.addEventListener("dragover",this.handleDragOver.bind(this)),this.input.addEventListener("drop",this.handleDrop.bind(this)),this.input.addEventListener("dragenter",this.handleDragEnter.bind(this)),this.input.addEventListener("dragleave",this.handleDragLeave.bind(this)))}disableDragAndDrop(){this.input&&(this.input.removeEventListener("dragover",this.handleDragOver.bind(this)),this.input.removeEventListener("drop",this.handleDrop.bind(this)),this.input.removeEventListener("dragenter",this.handleDragEnter.bind(this)),this.input.removeEventListener("dragleave",this.handleDragLeave.bind(this)))}handleDragOver(e){e.preventDefault(),this.input.style.background=this.isDarkMode?"rgba(236, 72, 153, 0.1)":"rgba(236, 72, 153, 0.05)"}handleDragEnter(e){e.preventDefault(),this.input.style.background=this.isDarkMode?"rgba(236, 72, 153, 0.1)":"rgba(236, 72, 153, 0.05)"}handleDragLeave(e){e.preventDefault(),this.input.style.background=""}async handleDrop(e){e.preventDefault(),this.input.style.background="";const t=Array.from(e.dataTransfer.files);if(0===t.length)return;const n=t[0];this.detectFileType(n.name)?this.handleFileSelection({target:{files:[n]}}):this.addOutput("âŒ ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™","error")}detectFileType(e){const t=e.toLowerCase().split(".").pop();return["glb","gltf"].includes(t)?"3d":["jpg","jpeg","png","webp"].includes(t)?"image":["mp4","mov","webm"].includes(t)?"video":null}async handleImportCommand(e){if(!this.selectedFile)throw new Error("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");try{const t=this.sceneManager?this.sceneManager.parsePosition(e):{x:0,y:5,z:-10};let n;switch(this.selectedFile.type){case"3d":if(!this.sceneManager)throw new Error("SceneManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“");n=await this.sceneManager.load3DModel(this.selectedFile.url,{position:t});break;case"image":if(!this.sceneManager)throw new Error("SceneManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“");n=await this.sceneManager.loadImageFile(this.selectedFile.url,{position:t,fileName:this.selectedFile.name});break;case"video":if(!this.sceneManager)throw new Error("SceneManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“");n=await this.sceneManager.loadVideoFile(this.selectedFile.url,{position:t,fileName:this.selectedFile.name});break;default:throw new Error(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—: ${this.selectedFile.type}`)}const i=this.selectedFile?.name,o=this.selectedFile?.type,a=this.selectedFile?.url;return"video"!==o&&a&&URL.revokeObjectURL(a),this.selectedFile=null,this.selectMode("generate",!1),{success:!0,message:`${i||"ãƒ•ã‚¡ã‚¤ãƒ«"} ã‚’ ${t.x}, ${t.y}, ${t.z} ã«é…ç½®ã—ã¾ã—ãŸ`,objectId:n.objectId}}catch(e){throw this.selectedFile?.url&&URL.revokeObjectURL(this.selectedFile.url),this.selectedFile=null,this.selectMode("generate",!1),e}}handleDeleteModeSelection(){const e=this.sceneManager?.selectedObject;if(e){const t=e.userData?.originalPrompt||e.name||"é¸æŠã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ";this.input.value=`${t}ã‚’å‰Šé™¤ â`,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length),this.addOutput(`ğŸ¯ å‰Šé™¤å¯¾è±¡: ${t}`,"system")}else this.input.value="",this.addOutput("â— å‰Šé™¤ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠå¾Œã€å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„","system"),this.triggerAttentionAnimation("delete")}handleModifyModeSelection(){const e=this.sceneManager?.selectedObject;if(e){const t=e.userData?.originalPrompt||e.name||"é¸æŠã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ";this.input.value=`${t}ã‚’`,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length),this.addOutput(`ğŸ¯ ä¿®æ­£å¯¾è±¡: ${t}`,"system")}else this.input.value="",this.addOutput("â— ä¿®æ­£ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠå¾Œã€ä¿®æ­£ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„","system"),this.triggerAttentionAnimation("modify")}triggerAttentionAnimation(e){const t=this.chatOutput,n=this.input;this.addMicroShakeEffect(t),this.addContextGlow(n,e),this.addEmotionalPulse(t,e),this.add3DDepthEffect(t)}addMicroShakeEffect(e){e.style.animation="microShake2025 0.5s ease-in-out",this.ensureMicroShakeAnimation(),setTimeout(()=>{e.style.animation=""},500)}addContextGlow(e,t){const n="delete"===t?"rgba(239, 68, 68, 0.4)":"rgba(99, 102, 241, 0.4)";e.style.transition="all 0.3s ease",e.style.boxShadow=`0 0 20px ${n}, 0 0 40px ${n}`,setTimeout(()=>{e.style.boxShadow=""},3e3)}addEmotionalPulse(e,t){const n="delete"===t?"#ef4444":this.isWabiSabiMode?"#8BC34A":"#6366f1";e.style.borderLeft=`4px solid ${n}`,e.style.animation="emotionalPulse2025 2s ease-in-out infinite",this.ensureEmotionalPulseAnimation(),setTimeout(()=>{e.style.animation="",e.style.borderLeft=""},6e3)}add3DDepthEffect(e){e.style.transform="translateZ(8px) rotateX(1deg)",e.style.transition="transform 0.3s ease",setTimeout(()=>{e.style.transform=""},2e3)}ensureMicroShakeAnimation(){if(document.getElementById("micro-shake-2025"))return;const e=document.createElement("style");e.id="micro-shake-2025",e.textContent="\n      @keyframes microShake2025 {\n        0%, 100% { transform: translateX(0); }\n        10% { transform: translateX(-2px) rotateZ(-0.5deg); }\n        20% { transform: translateX(2px) rotateZ(0.5deg); }\n        30% { transform: translateX(-1px) rotateZ(-0.3deg); }\n        40% { transform: translateX(1px) rotateZ(0.3deg); }\n        50% { transform: translateX(-0.5px) rotateZ(-0.1deg); }\n        60% { transform: translateX(0.5px) rotateZ(0.1deg); }\n        70% { transform: translateX(0); }\n      }\n    ",document.head.appendChild(e)}ensureEmotionalPulseAnimation(){if(document.getElementById("emotional-pulse-2025"))return;const e=document.createElement("style");e.id="emotional-pulse-2025",e.textContent="\n      @keyframes emotionalPulse2025 {\n        0% { \n          border-left-width: 4px;\n          filter: brightness(1);\n        }\n        50% { \n          border-left-width: 8px;\n          filter: brightness(1.2) saturate(1.1);\n        }\n        100% { \n          border-left-width: 4px;\n          filter: brightness(1);\n        }\n      }\n    ",document.head.appendChild(e)}clearInputOnModeSwitch(e){if(this.input.value.trim()){this.isPreviousModeMessage(this.input.value,e)&&(this.input.value="",this.addOutput(`ğŸ’« ${this.getModeDisplayName(e)}ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`,"system"))}}isPreviousModeMessage(e,t){const n=[/.*ã‚’å‰Šé™¤$/,/å‰Šé™¤$/],i=[/.*ã‚’$/,/.*ã‚’å¤‰æ›´/,/.*ã‚’ãƒ”ãƒ³ã‚¯/,/.*ã‚’å¤§ãã/,/.*ã‚’å°ã•ã/,/.*ã‚’ç§»å‹•/,/å›è»¢/,/åè»¢/,/ãƒŸãƒ©ãƒ¼/,/å‚¾ã‘/,/å‘ãã‚’å¤‰ãˆ/,/.*ã‚’.*è‰²/,/.*ã‚’.*ã‚µã‚¤ã‚º/],o=[/ãƒ•ã‚¡ã‚¤ãƒ«/,/ç”»åƒ/,/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/];switch(t){case"delete":return i.some(t=>t.test(e))||o.some(t=>t.test(e));case"modify":return n.some(t=>t.test(e))||o.some(t=>t.test(e));case"import":return n.some(t=>t.test(e))||i.some(t=>t.test(e));case"generate":return n.some(t=>t.test(e))||i.some(t=>t.test(e))||o.some(t=>t.test(e));default:return!1}}getModeDisplayName(e){return{generate:"ç”Ÿæˆ",import:"ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",modify:"ä¿®æ­£",delete:"å‰Šé™¤"}[e]||e}createFloatingChocolateIcon(){this.floatingChocolateIcon&&this.floatingChocolateIcon.remove(),this.floatingChocolateIcon=document.createElement("div"),this.floatingChocolateIcon.innerHTML="ğŸ«",this.floatingChocolateIcon.title="ChocoDrop ã‚’é–‹ã (@ã‚­ãƒ¼ã§ã‚‚é–‹ã‘ã¾ã™)",this.floatingChocolateIcon.style.cssText="\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      width: 48px;\n      height: 48px;\n      border-radius: 50%;\n      background: rgba(99, 102, 241, 0.15);\n      backdrop-filter: blur(16px);\n      -webkit-backdrop-filter: blur(16px);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05);\n      opacity: 0.8;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 20px;\n      cursor: pointer;\n      z-index: 999;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      transform: scale(1);\n      filter: none;\n    ",this.floatingChocolateIcon.addEventListener("mouseover",()=>{this.floatingChocolateIcon.style.transform="scale(1.1) translateY(-2px)",this.floatingChocolateIcon.style.boxShadow="0 6px 16px rgba(99, 102, 241, 0.3), 0 3px 8px rgba(0, 0, 0, 0.1)",this.floatingChocolateIcon.style.opacity="1",this.floatingChocolateIcon.style.filter="none"}),this.floatingChocolateIcon.addEventListener("mouseout",()=>{this.floatingChocolateIcon.style.transform="scale(1) translateY(0)",this.floatingChocolateIcon.style.boxShadow="0 4px 12px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05)",this.floatingChocolateIcon.style.opacity="0.8",this.floatingChocolateIcon.style.filter="none"}),this.floatingChocolateIcon.addEventListener("click",()=>{this.isVisible?this.hide():this.show()}),this.floatingChocolateIcon.addEventListener("contextmenu",e=>{e.preventDefault(),this.showFloatingIconContextMenu(e)}),document.body.appendChild(this.floatingChocolateIcon)}showFloatingIconContextMenu(e){const t=document.querySelector(".floating-icon-context-menu");t&&t.remove();const n=document.createElement("div");n.className="floating-icon-context-menu",n.style.cssText=`\n      position: fixed;\n      top: ${e.clientY}px;\n      left: ${e.clientX}px;\n      background: ${this.isWabiSabiMode?"rgba(239, 235, 233, 0.9)":this.isDarkMode?"rgba(17, 24, 39, 0.85)":"rgba(255, 255, 255, 0.85)"};\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid ${this.isWabiSabiMode?"rgba(161, 136, 127, 0.4)":this.isDarkMode?"rgba(129, 140, 248, 0.3)":"rgba(99, 102, 241, 0.2)"};\n      border-radius: 12px;\n      box-shadow: ${this.isWabiSabiMode?"0 8px 24px rgba(93, 64, 55, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1)":"0 8px 24px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1)"};\n      padding: 8px 0;\n      min-width: 160px;\n      z-index: 2000;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      color: ${this.isWabiSabiMode?"#5D4037":this.isDarkMode?"#ffffff":"#1f2937"};\n    `;const i=document.createElement("div");i.innerHTML="ğŸ“„ ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã",i.style.cssText=`\n      padding: 8px 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      color: ${this.isWabiSabiMode?"#8D6E63":"#6366f1"};\n      text-shadow: ${this.isWabiSabiMode?"0 2px 4px rgba(141, 110, 99, 0.3)":"0 2px 4px rgba(99, 102, 241, 0.3)"};\n    `,i.addEventListener("mouseover",()=>{i.style.background=this.isWabiSabiMode?"rgba(161, 136, 127, 0.15)":this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(99, 102, 241, 0.1)",i.style.textShadow=this.isWabiSabiMode?"0 2px 6px rgba(141, 110, 99, 0.5)":"0 2px 6px rgba(99, 102, 241, 0.5)"}),i.addEventListener("mouseout",()=>{i.style.background="transparent",i.style.textShadow=this.isWabiSabiMode?"0 2px 4px rgba(141, 110, 99, 0.3)":"0 2px 4px rgba(99, 102, 241, 0.3)"}),i.addEventListener("click",()=>{n.remove(),this.isVisible?this.hide():this.show()});const o=document.createElement("div");o.innerHTML="âœ• ã‚¢ã‚¤ã‚³ãƒ³ã‚’éè¡¨ç¤º",o.style.cssText=`\n      padding: 8px 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      color: ${this.isWabiSabiMode?"#8D6E63":"#6366f1"};\n      text-shadow: ${this.isWabiSabiMode?"0 2px 4px rgba(141, 110, 99, 0.3)":"0 2px 4px rgba(99, 102, 241, 0.3)"};\n    `,o.addEventListener("mouseover",()=>{o.style.background=this.isWabiSabiMode?"rgba(161, 136, 127, 0.15)":this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(99, 102, 241, 0.1)",o.style.textShadow=this.isWabiSabiMode?"0 2px 6px rgba(141, 110, 99, 0.5)":"0 2px 6px rgba(99, 102, 241, 0.5)"}),o.addEventListener("mouseout",()=>{o.style.background="transparent",o.style.textShadow=this.isWabiSabiMode?"0 2px 4px rgba(141, 110, 99, 0.3)":"0 2px 4px rgba(99, 102, 241, 0.3)"}),o.addEventListener("click",()=>{n.remove(),this.hideFloatingIcon()}),n.appendChild(i),n.appendChild(o),document.body.appendChild(n);const a=n.getBoundingClientRect();a.right>window.innerWidth&&(n.style.left=e.clientX-a.width+"px"),a.bottom>window.innerHeight&&(n.style.top=e.clientY-a.height+"px");const r=e=>{n.contains(e.target)||(n.remove(),document.removeEventListener("click",r))};setTimeout(()=>{document.addEventListener("click",r)},10)}hideFloatingIcon(){this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.display="none")}showFloatingIcon(){this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.display="flex")}dispose(){this.clearKeywordHighlighting(),this.fileInput&&this.fileInput.parentNode&&this.fileInput.parentNode.removeChild(this.fileInput),this.selectedFile&&this.selectedFile.url&&URL.revokeObjectURL(this.selectedFile.url),this.floatingChocolateIcon&&this.floatingChocolateIcon.parentNode&&this.floatingChocolateIcon.parentNode.removeChild(this.floatingChocolateIcon),this.container&&this.container.parentElement&&this.container.parentElement.removeChild(this.container)}showOverlayTextarea(){if(this.overlayTextarea)return;this.isExpanded=!0,this.overlayTextarea=document.createElement("textarea"),this.overlayTextarea.value=this.input.value,this.overlayTextarea.placeholder=this.input.placeholder;const e=this.container.getBoundingClientRect(),t=20;let n=e.top+60,i=e.left,o=e.width;i+o>window.innerWidth-t&&(i=window.innerWidth-o-t),i<t&&(i=t,o=Math.min(o,window.innerWidth-40)),n+300>window.innerHeight-t&&(n=Math.max(t,window.innerHeight-300-t));const a=this.isWabiSabiMode?"linear-gradient(135deg, rgba(97, 97, 97, 0.7), rgba(66, 66, 66, 0.6))":this.isDarkMode?"linear-gradient(135deg, rgba(30, 27, 75, 0.4), rgba(15, 23, 42, 0.5))":"linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))",r=this.isWabiSabiMode?"1px solid rgba(93, 64, 55, 0.5)":this.isDarkMode?"1px solid rgba(99, 102, 241, 0.25)":"1px solid rgba(255, 255, 255, 0.5)",s=this.isWabiSabiMode?"0 4px 16px rgba(66, 66, 66, 0.3), inset 0 1px 0 rgba(189, 189, 189, 0.2)":this.isDarkMode?"0 4px 16px rgba(15, 23, 42, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08)":"0 4px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.4)",l=this.getInputTextColor();this.overlayTextarea.style.cssText=`\n      position: fixed;\n      top: ${n}px;\n      left: ${i}px;\n      width: ${o}px;\n      height: 300px;\n      box-sizing: border-box;\n      background: ${a};\n      backdrop-filter: blur(24px) saturate(180%);\n      border: ${r};\n      box-shadow: ${s};\n      border-radius: 16px;\n      color: ${l};\n      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      line-height: 1.5;\n      padding: 20px;\n      resize: none;\n      outline: none;\n      z-index: 10000;\n      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);\n      opacity: 0;\n      transition: opacity 0.2s ease-out;\n    `,document.body.appendChild(this.overlayTextarea),requestAnimationFrame(()=>{this.overlayTextarea.style.opacity="1"}),this.overlayTextarea.focus(),this.overlayTextarea.addEventListener("input",e=>{this.input.value=e.target.value}),this.overlayTextarea.addEventListener("keydown",e=>{"Escape"===e.key&&this.hideOverlayTextarea()}),this.overlayTextarea.addEventListener("blur",()=>{setTimeout(()=>this.hideOverlayTextarea(),100)})}hideOverlayTextarea(){this.overlayTextarea&&(this.isExpanded=!1,this.overlayTextarea.style.opacity="0",setTimeout(()=>{this.overlayTextarea&&(document.body.removeChild(this.overlayTextarea),this.overlayTextarea=null)},200))}hideOverlayTextarea(){this.overlayTextarea&&(this.isExpanded=!1,this.overlayTextarea.style.opacity="0",setTimeout(()=>{this.overlayTextarea&&(document.body.removeChild(this.overlayTextarea),this.overlayTextarea=null)},200))}}function g(e,t={}){if(!e)throw new Error("THREE.Scene ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå¿…è¦ã§ã™");const{camera:n=null,renderer:i=null,serverUrl:a=null,client:r=null,onControlsToggle:s=()=>{},sceneOptions:l={},uiOptions:c={}}=t,d=a||l.serverUrl||null,h=r||new o(d),u=new p(e,{camera:n,renderer:i,serverUrl:d,client:h,...l}),g=new m({sceneManager:u,client:h,onControlsToggle:s,...c});return{client:h,sceneManager:u,ui:g,dispose(){g.dispose?.(),u.dispose?.()}}}const b=g,y=g;var f={ChocoDropClient:o,ChocoDroClient:r,LiveCommandClient:a,SceneManager:p,CommandUI:m,createChocoDrop:g,createChocoDro:b,createLiveCommand:y};e.ChocoDroClient=r,e.ChocoDropClient=o,e.CommandUI=m,e.LiveCommandClient=a,e.SceneManager=p,e.createChocoDro=b,e.createChocoDrop=g,e.createLiveCommand=y,e.default=f,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=chocodrop.umd.min.js.map
