!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ChocoDrop={},e.THREE)}(this,function(e,t){"use strict";function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,Object.freeze(t)}var i=n(t);class o{constructor(e=null){this.serverUrl=null,this.initialized=!1,this.initPromise=null,e?(this.serverUrl=e,this.initialized=!0,console.log("🍫 ChocoDropClient initialized:",e)):this.initPromise=this.initializeWithConfig()}async initializeWithConfig(){try{const e=`${window.location.protocol}//${window.location.hostname}:${window.location.port}`,t=await fetch(`${e}/api/config`);if(t.ok){const e=await t.json();this.serverUrl=e.serverUrl,console.log("🍫 ChocoDropClient initialized from config:",this.serverUrl)}else this.serverUrl=this.detectServerUrl(),console.log("🍫 ChocoDropClient fallback to detected URL:",this.serverUrl)}catch(e){console.warn("⚠️ ChocoDrop config fetch failed, using fallback:",e),this.serverUrl=this.detectServerUrl()}this.initialized=!0}detectServerUrl(){const e=window.location.port,t=window.location.protocol,n=window.location.hostname;return e?`${t}//${n}:${e}`:`${t}//${n}:3011`}async ensureInitialized(){if(!this.initialized){if(!this.initPromise)throw new Error("ChocoDropClient not initialized");await this.initPromise}}async generateImage(e,t={}){await this.ensureInitialized(),console.log(`🎨 Requesting image generation: "${e}"`);try{const n={prompt:e,width:t.width||512,height:t.height||512};t.service&&(n.service=t.service);const i=await fetch(`${this.serverUrl}/api/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!i.ok)throw new Error(`Server error: ${i.status}`);const o=await i.json();return console.log("✅ Image generation result:",o),o}catch(e){throw console.error("❌ Image generation request failed:",e),e}}async generateVideo(e,t={}){await this.ensureInitialized(),console.log(`🎬 Requesting video generation: "${e}"`);try{const n={aspect_ratio:"16:9",resolution:"720p",enable_safety_checker:!0,enable_prompt_expansion:!0},i={prompt:e,duration:"number"==typeof t.duration&&t.duration>0?t.duration:3,aspect_ratio:t.aspect_ratio||n.aspect_ratio,resolution:t.resolution||n.resolution,enable_safety_checker:t.enable_safety_checker??n.enable_safety_checker,enable_prompt_expansion:t.enable_prompt_expansion??n.enable_prompt_expansion};t.model&&(i.model=t.model),"number"==typeof t.width&&t.width>0&&(i.width=t.width),"number"==typeof t.height&&t.height>0&&(i.height=t.height),"number"==typeof t.seed&&(i.seed=t.seed),t.negative_prompt&&(i.negative_prompt=t.negative_prompt),"number"==typeof t.frames_per_second&&t.frames_per_second>0&&(i.frames_per_second=t.frames_per_second),"number"==typeof t.guidance_scale&&(i.guidance_scale=t.guidance_scale);const o=await fetch(`${this.serverUrl}/api/generate-video`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!o.ok)throw new Error(`Server error: ${o.status}`);const s=await o.json();return console.log("✅ Video generation result:",s),s}catch(e){throw console.error("❌ Video generation request failed:",e),e}}async executeCommand(e){await this.ensureInitialized(),console.log(`🎯 Executing command: "${e}"`);try{const t=await fetch(`${this.serverUrl}/api/command`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:e})});if(!t.ok)throw new Error(`Server error: ${t.status}`);const n=await t.json();return console.log("✅ Command execution result:",n),n}catch(e){throw console.error("❌ Command execution failed:",e),e}}async getAvailableServices(){await this.ensureInitialized();try{const e=await fetch(`${this.serverUrl}/api/services`);if(!e.ok)throw new Error(`Server error: ${e.status}`);return await e.json()}catch(e){return console.error("❌ Failed to get services:",e),[]}}}const s=o,r=o;class a{constructor(e,t={}){if(!e)throw new Error("THREE.Scene is required");this.scene=e,this.camera=t.camera||null,this.renderer=t.renderer||null,this.labelRenderer=null,this.client=t.client||new o(t.serverUrl),this.experimentGroup=new i.Group,this.experimentGroup.name="LiveExperiments",this.scene.add(this.experimentGroup),this.commandHistory=[],this.spawnedObjects=new Map,this.objectCounter=0,this.selectedObject=null,this.selectedImageService=t.selectedImageService||null,this.selectedVideoService=t.selectedVideoService||null,this.clock=new i.Clock,this.raycaster=new i.Raycaster,this.mouse=new i.Vector2,this.lastHoveredObject=null,this.config={showLocationIndicator:!1!==t.showLocationIndicator,indicatorDuration:t.indicatorDuration||3e3,defaultObjectScale:t.defaultObjectScale||1,enableObjectSelection:!1!==t.enableObjectSelection,enableMouseInteraction:t.enableMouseInteraction,enableDebugLogging:!0===t.enableDebugLogging,...t.config},this.setupClickEvents(),console.log("🧪 SceneManager initialized with click selection"),"undefined"!=typeof globalThis&&(globalThis.sceneManager=this)}setupClickEvents(){!0===this.config.enableMouseInteraction&&this.renderer?(this.setupObjectDragging(),console.log("🖱️ Mouse interaction enabled - Click to select, Shift+drag to move objects")):!0!==this.config.enableMouseInteraction||this.renderer?console.log("🖱️ Mouse interaction disabled (safe mode). Set enableMouseInteraction: true to enable."):console.warn("⚠️ Mouse interaction requested but renderer not provided. Mouse interaction disabled.")}debugSceneInfo(){console.log("🔍 === SCENE DEBUG INFO ==="),this.camera&&console.log(`📷 Camera:\n        - Position: (${this.camera.position.x.toFixed(2)}, ${this.camera.position.y.toFixed(2)}, ${this.camera.position.z.toFixed(2)})\n        - Rotation: (${(180*this.camera.rotation.x/Math.PI).toFixed(1)}°, ${(180*this.camera.rotation.y/Math.PI).toFixed(1)}°, ${(180*this.camera.rotation.z/Math.PI).toFixed(1)}°)\n        - FOV: ${this.camera.fov||"N/A"}\n        - Near/Far: ${this.camera.near||"N/A"}/${this.camera.far||"N/A"}`),console.log(`🌳 Scene hierarchy:\n      - Total objects in scene: ${this.scene.children.length}\n      - experimentGroup exists: ${this.scene.getObjectByName("LiveExperiments")?"Yes":"No"}\n      - experimentGroup children: ${this.experimentGroup.children.length}`),console.log(`📦 Spawned objects: ${this.spawnedObjects.size}`),this.spawnedObjects.forEach((e,t)=>{const n=new i.Vector3;if(e.getWorldPosition(n),console.log(`  - ${t} (${e.userData.type}): \n        Local: (${e.position.x.toFixed(2)}, ${e.position.y.toFixed(2)}, ${e.position.z.toFixed(2)})\n        World: (${n.x.toFixed(2)}, ${n.y.toFixed(2)}, ${n.z.toFixed(2)})\n        Visible: ${e.visible}, Scale: ${e.scale.x.toFixed(2)}`),"generated_3d_model"===e.userData.type){const t=(new i.Box3).setFromObject(e),n=t.getSize(new i.Vector3),o=t.getCenter(new i.Vector3);console.log(`    📐 Bounding box - Center: (${o.x.toFixed(2)}, ${o.y.toFixed(2)}, ${o.z.toFixed(2)}), Size: (${n.x.toFixed(2)}, ${n.y.toFixed(2)}, ${n.z.toFixed(2)})`);let s=0;e.traverse(e=>{e.isMesh&&s++}),console.log(`    🎭 Meshes: ${s}`)}}),this.camera&&this.spawnedObjects.size>0&&(console.log("📏 Distances from camera:"),this.spawnedObjects.forEach((e,t)=>{const n=this.camera.position.distanceTo(e.position);console.log(`  - ${t}: ${n.toFixed(2)} units`)})),console.log("=========================")}selectObject(e){if(this.selectedObject!==e&&(this.deselectObject(),this.selectedObject=e,this.createModernSelectionIndicator(e),console.log(`✅ Selected object: ${e.name}`),this.commandUI)){const t=e.userData||{};if(this.commandUI.addOutput(`📍 選択: ${e.name}`,"info"),t.prompt&&this.commandUI.addOutput(`   プロンプト: ${t.prompt}`,"hint"),t.modelName&&this.commandUI.addOutput(`   モデル: ${t.modelName}`,"hint"),"delete"===this.commandUI.currentMode){const n=t.originalPrompt||e.name||"選択したオブジェクト";this.commandUI.input.value=`${n}を削除`,this.commandUI.input.focus(),this.commandUI.input.setSelectionRange(this.commandUI.input.value.length,this.commandUI.input.value.length),this.commandUI.addOutput(`🎯 削除対象設定: ${n}`,"system")}}}createModernSelectionIndicator(e){const t=e.getObjectByName("selectionIndicator");t&&e.remove(t);const n=new i.Group;n.name="selectionIndicator";const o=(new i.Box3).setFromObject(e),s=o.getSize(new i.Vector3),r=o.getCenter(new i.Vector3),a=new i.Vector3(s.x+.1,s.y+.1,s.z+.1);if(e.geometry&&"PlaneGeometry"===e.geometry.type){const t=e.geometry.parameters.width,o=e.geometry.parameters.height,s=new i.Shape;s.moveTo(-t/2,-o/2),s.lineTo(t/2,-o/2),s.lineTo(t/2,o/2),s.lineTo(-t/2,o/2),s.lineTo(-t/2,-o/2);const r=s.getPoints(),a=(new i.BufferGeometry).setFromPoints(r),l=this.getAdaptiveSelectionColor(),c=new i.LineBasicMaterial({color:l,linewidth:2,transparent:!0,opacity:.9}),d=new i.Line(a,c);d.position.set(0,0,.01),n.add(d)}else{const e=new i.EdgesGeometry(new i.BoxGeometry(a.x,a.y,a.z)),t=this.getAdaptiveSelectionColor(),o=new i.LineBasicMaterial({color:t,linewidth:2,transparent:!0,opacity:.9}),s=new i.LineSegments(e,o);s.position.copy(r),n.add(s)}e.add(n),n.position.set(0,0,0),this.addResizeHandles(n,a,r,e)}addResizeHandles(e,t,n,o){if(console.log("🔧 addResizeHandles called"),!o)return void console.log("❌ No parent object provided");if(!o.geometry)return void console.log("❌ Parent has no geometry");if("PlaneGeometry"!==o.geometry.type)return void console.log(`❌ Geometry type is ${o.geometry.type}, not PlaneGeometry`);console.log("✅ PlaneGeometry detected, creating handles");const s=.15,r=new i.BoxGeometry(s,s,s),a=this.getAdaptiveSelectionColor(),l=new i.MeshBasicMaterial({color:a,transparent:!0,opacity:.8,depthTest:!1,depthWrite:!1}),c=new i.MeshBasicMaterial({color:this.getAdaptiveHoverColor(),transparent:!0,opacity:1,depthTest:!1,depthWrite:!1}),d=o.geometry.parameters.width,p=o.geometry.parameters.height;[{x:d/2,y:p/2,z:.1,corner:"top-right"},{x:-d/2,y:p/2,z:.1,corner:"top-left"},{x:d/2,y:-p/2,z:.1,corner:"bottom-right"},{x:-d/2,y:-p/2,z:.1,corner:"bottom-left"}].forEach((t,n)=>{const o=new i.Mesh(r,l.clone());o.position.set(t.x,t.y,t.z),o.userData={isResizeHandle:!0,handleIndex:n,corner:t.corner,defaultMaterial:o.material,hoverMaterial:c.clone()},o.renderOrder=1001,o.onHover=()=>{o.material=o.userData.hoverMaterial,o.scale.setScalar(1.5),document.body.style.cursor="nw-resize"},o.onHoverExit=()=>{o.material=o.userData.defaultMaterial,o.scale.setScalar(1),document.body.style.cursor="default"},e.add(o),console.log(`🔴 Added resize handle at ${t.corner}`)})}updateSelectionIndicatorScale(e){}deselectObject(){if(this.selectedObject){const e=this.selectedObject.getObjectByName("selectionIndicator");e&&(this.selectedObject.remove(e),e.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())})),console.log(`✅ Deselected: ${this.selectedObject.name}`),this.selectedObject=null}}setupObjectDragging(){if(!this.renderer)return;const e=this.renderer.domElement;let t=!1,n=null,o=new i.Vector3,s=new i.Vector2,r="move",a=new i.Vector3;e.addEventListener("mousedown",i=>{if(0!==i.button)return;const l=e.getBoundingClientRect();this.mouse.x=(i.clientX-l.left)/l.width*2-1,this.mouse.y=-(i.clientY-l.top)/l.height*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const c=this.raycaster.intersectObjects(this.experimentGroup.children,!0);if(c.length>0){const l=c[0].object;if(l.userData&&l.userData.isResizeHandle)return t=!0,n=this.selectedObject,r="resize",this.resizeHandleInfo={corner:l.userData.corner,handleIndex:l.userData.handleIndex},a.copy(n.scale),s.set(i.clientX,i.clientY),e.style.cursor="nw-resize",void console.log(`🔄 Started resizing: ${n.name} from ${l.userData.corner}`);if(l.userData&&l.userData.isRotateHandle)return void console.log(`🔄 Rotation handle clicked for: ${this.selectedObject.name}`);if(!l.userData||"generated_image"!==l.userData.type&&"generated_video"!==l.userData.type&&"generated_3d_model"!==l.userData.type)this.selectObject(l);else{if(this.commandUI&&"delete"===this.commandUI.currentMode){const e=l.name;return console.log(`🗑️ Delete mode: clicked on ${e}`),void this.commandUI.showDeleteConfirmation(`オブジェクト「${e}」を削除`).then(t=>{t?(this.removeObject(e),this.commandUI.addOutput(`🗑️ 削除完了: ${e}`,"success")):this.commandUI.addOutput(`❌ 削除キャンセル: ${e}`,"info")}).catch(t=>{console.error("Delete confirmation error:",t),this.commandUI.addOutput(`❌ 削除エラー: ${e}`,"error")})}t=!0,n=l,r="move",o.copy(c[0].point).sub(l.position),s.set(i.clientX,i.clientY),l.material,e.style.cursor="move",console.log(`🔄 Started moving: ${l.name} (Shift-free interaction)`),this.selectObject(l)}}else this.deselectObject()}),e.addEventListener("mousemove",o=>{if(!t)return void this.handleHoverEffects(o,e);if(!n)return;const l=o.clientX-s.x,c=o.clientY-s.y;if("resize"===r){if(!this.resizeHandleInfo)return void console.error("❌ Resize handle info missing");const e=this.resizeHandleInfo.corner;console.log(`🔍 Resizing from corner: ${e}, deltaX: ${l}, deltaY: ${c}`);let t=1;switch(e){case"top-right":t=l>0&&c<0?1+.001*(Math.abs(l)+Math.abs(c)):1-.001*(Math.abs(l)+Math.abs(c));break;case"top-left":t=l<0&&c<0?1+.001*(Math.abs(l)+Math.abs(c)):1-.001*(Math.abs(l)+Math.abs(c));break;case"bottom-right":t=l>0&&c>0?1+.001*(Math.abs(l)+Math.abs(c)):1-.001*(Math.abs(l)+Math.abs(c));break;case"bottom-left":t=l<0&&c>0?1+.001*(Math.abs(l)+Math.abs(c)):1-.001*(Math.abs(l)+Math.abs(c));break;default:t=1+.001*(l+c)}const i=Math.max(.1,Math.min(5,a.x*t));n.scale.setScalar(i),this.updateSelectionIndicatorScale(n),console.log(`🔄 Resizing: ${n.name} scale: ${i.toFixed(2)} (${t>1?"拡大":"縮小"})`)}else if("move"===r){const e=new i.Vector3,t=new i.Vector3;this.camera.getWorldDirection(new i.Vector3),e.setFromMatrixColumn(this.camera.matrixWorld,0).normalize(),t.setFromMatrixColumn(this.camera.matrixWorld,1).normalize();const r=.01,a=(new i.Vector3).add(e.clone().multiplyScalar(l*r)).add(t.clone().multiplyScalar(-c*r));n.position.add(a),s.set(o.clientX,o.clientY)}}),e.addEventListener("mouseup",()=>{t&&n&&(n.material&&(n.material.opacity=1,n.material.transparent=!1),console.log(`✅ Finished dragging: ${n.name} to (${n.position.x.toFixed(1)}, ${n.position.y.toFixed(1)}, ${n.position.z.toFixed(1)})`),t=!1,n=null,r="move",this.resizeHandleInfo=null,e.style.cursor="default")}),e.addEventListener("wheel",t=>{t.preventDefault();const n=e.getBoundingClientRect(),o=new i.Vector2;o.x=(t.clientX-n.left)/n.width*2-1,o.y=-(t.clientY-n.top)/n.height*2+1,this.raycaster.setFromCamera(o,this.camera);const s=this.raycaster.intersectObjects(this.experimentGroup.children,!0);if(s.length>0){const e=s[0].object;if(e.userData&&("generated_image"===e.userData.type||"generated_video"===e.userData.type||"generated_3d_model"===e.userData.type)){const n=t.deltaY>0?.9:1.1,i=e.scale.x*n;i>=.2&&i<=5&&(e.scale.setScalar(i),e.material&&(e.material.emissive.setHex(3355443),setTimeout(()=>{e.material&&e.material.emissive.setHex(0)},150)),console.log(`🔄 Resized ${e.userData.type}: ${e.name} to scale ${i.toFixed(2)} (Shift-free interaction)`))}}}),document.addEventListener("keydown",e=>{if(!this.selectedObject)return;const t=this.selectedObject;if(!t.userData||"generated_image"!==t.userData.type&&"generated_video"!==t.userData.type)return;const n=Math.PI/36;let o=!1;switch(e.key){case"ArrowLeft":t.rotation.y-=n,o=!0;break;case"ArrowRight":t.rotation.y+=n,o=!0;break;case"ArrowUp":const s=t.rotation.x-n;s>=-Math.PI/6&&s<=Math.PI/6&&(t.rotation.x=s,o=!0);break;case"ArrowDown":const r=t.rotation.x+n;r>=-Math.PI/6&&r<=Math.PI/6&&(t.rotation.x=r,o=!0);break;case"r":case"R":t.rotation.x=0;const a=new i.Vector3;this.camera.getWorldDirection(a);const l=t.position.clone().add(a.multiplyScalar(-1));t.lookAt(l),t.rotation.x=0,o=!0,console.log(`🔄 Reset rotation for: ${t.name}`);break;case"i":case"I":this.debugSceneInfo(),e.preventDefault()}if(o){e.preventDefault();const n={x:(180*t.rotation.x/Math.PI).toFixed(1),y:(180*t.rotation.y/Math.PI).toFixed(1),z:(180*t.rotation.z/Math.PI).toFixed(1)};console.log(`🔄 Rotated ${t.userData.type}: ${t.name} to (${n.x}°, ${n.y}°, ${n.z}°)`)}}),console.log("🖱️ Object dragging system enabled (Drag to move objects - Shift-free interaction)"),console.log("🔄 Object resizing system enabled (Scroll to resize images/videos - Shift-free interaction)"),console.log("🎯 Angle adjustment enabled (Select object + Arrow keys to rotate, R to reset)")}handleHoverEffects(e,t){const n=t.getBoundingClientRect();this.mouse.x=(e.clientX-n.left)/n.width*2-1,this.mouse.y=-(e.clientY-n.top)/n.height*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const i=this.raycaster.intersectObjects(this.experimentGroup.children,!0);if(this.lastHoveredObject&&this.lastHoveredObject.onHoverExit&&(this.lastHoveredObject.onHoverExit(),this.lastHoveredObject=null),i.length>0){const e=i[0].object;if(e.userData&&e.userData.isResizeHandle&&e.onHover)return e.onHover(),void(this.lastHoveredObject=e);if(e.userData&&("generated_image"===e.userData.type||"generated_video"===e.userData.type))return t.style.cursor="move","generated_video"===e.userData.type&&e.userData.showAudioControl&&e.userData.showAudioControl(),void(this.lastHoveredObject={onHoverExit:()=>{t.style.cursor="default","generated_video"===e.userData.type&&e.userData.hideAudioControl&&e.userData.hideAudioControl()}})}t.style.cursor="default"}async executeCommand(e){const t=Date.now();console.log(`🎯 Executing: "${e}"`);try{const n=this.parseCommand(e);console.log("📝 Parsed:",n);const i=await this.dispatchCommand(n);return this.commandHistory.push({timestamp:t,command:e,parsed:n,result:i,status:"success"}),i}catch(n){throw console.error("❌ Command execution failed:",n),this.commandHistory.push({timestamp:t,command:e,error:n.message,status:"error"}),n}}parseCommand(e){if(e.startsWith("[変更] ")){const t=e.replace("[変更] ","");return this.parseObjectModificationCommand(t.toLowerCase().trim())}if(e.startsWith("[削除] ")){const t=e.replace("[削除] ","");return this.parseDeleteCommand(t.toLowerCase().trim())}const t=e.toLowerCase().trim(),n=this.parseNaturalLanguageCommand(t);if(n)return n;return["動画","ビデオ","ムービー","映像","アニメーション","動く"].some(e=>t.includes(e))?{type:"video_generation",prompt:e,position:this.parsePosition(t),size:this.parseSize(t)}:{type:"image_generation",prompt:e,position:this.parsePosition(t),size:this.parseSize(t)}}findObjectByKeyword(e){const t={"猫":["cat","ネコ","ねこ"],"犬":["dog","イヌ","いぬ"],"ドラゴン":["dragon","龍","りゅう"],"ユニコーン":["unicorn"],"ペガサス":["pegasus"],"鳥":["bird","とり","トリ"],"花":["flower","はな","ハナ"],"城":["castle","しろ","シロ"],"山":["mountain","やま","ヤマ"],"木":["tree","き","キ"]};for(const n of this.scene.children)if(n.name&&n.name.startsWith("generated_")){n.name.split("_");for(const[i,o]of Object.entries(t)){if(e.includes(i))return console.log(`🎯 Found object by keyword "${i}": ${n.name}`),n;for(const t of o)if(e.toLowerCase().includes(t.toLowerCase()))return console.log(`🎯 Found object by alias "${t}": ${n.name}`),n}if(n.userData&&n.userData.prompt){const e=n.userData.prompt.toLowerCase();for(const[i,o]of Object.entries(t))if(e.includes(i.toLowerCase()))return console.log(`🎯 Found object by prompt "${i}": ${n.name}`),n}}if(e.includes("最後")||e.includes("最新")||e.includes("last")){const e=this.scene.children.filter(e=>e.name&&e.name.startsWith("generated_"));if(e.length>0){const t=e[e.length-1];return console.log(`🎯 Found last created object: ${t.name}`),t}}return null}parseImageGenerationCommand(e){let t=e;const n=["を","に","で","の"];for(const i of n)if(e.includes(i)){const n=e.split(i);if(n[0]){t=n[0].trim();break}}return t=t.replace(/(画像|作って|生成|して|ください)/g,"").trim(),{type:"image_generation",prompt:t,position:this.parsePosition(e),size:this.parseSize(e)}}parseObjectModificationCommand(e){const t=e.toLowerCase().trim();let n=null;const i={"赤":16711680,"青":255,"緑":65280,"黄":16776960,"紫":16711935,"橙":16746496,"オレンジ":16746496,"白":16777215,"黒":0,"灰":8421504,"グレー":8421504,"ピンク":16761035,"茶":9127187,"銀":12632256,"金":16766720};for(const[e,o]of Object.entries(i))if(t.includes(e)){n=o;break}let o=null;if(t.includes("大きく")||t.includes("拡大"))o=1.5;else if(t.includes("小さく")||t.includes("縮小"))o=.7;else if(t.includes("倍")){const e=t.match(/(\d+(?:\.\d+)?)\s*倍/);e&&(o=parseFloat(e[1]))}let s=null;return(t.includes("移動")||t.includes("動か")||t.includes("へ"))&&(s=this.parsePositionFromPrompt(t)),{type:"object_modification",command:e,color:n,scale:o,movement:s,requiresSelection:!0}}parseDeleteCommand(e){const t=e.toLowerCase().trim();return t.includes("選択")||t.includes("これ")||t.includes("この")?{type:"delete",target:"selected",requiresSelection:!0}:t.includes("全部")||t.includes("すべて")||t.includes("全て")?{type:"delete",target:"all"}:{type:"delete",target:"selected",requiresSelection:!0}}parseNaturalLanguageCommand(e){const t=["(S+?)を(.+?)に移動","(S+?)を(.+?)へ移動","(S+?)を(.+?)に動か","(S+?)を(.+?)へ動か"];for(const n of t){const t=new RegExp(n),i=e.match(t);if(i){const e=i[1],t=i[2];return console.log(`🎯 Natural language move detected: "${e}" to "${t}"`),{type:"natural_object_modification",targetObjectName:e,movement:this.parsePositionFromPrompt(t),requiresObjectSearch:!0}}}const n=["(S+?)を(S+?)色に","(S+?)を(S+?)に"],i=["赤","青","緑","黄","紫","橙","オレンジ","白","黒","灰","グレー","ピンク","茶","銀","金"];for(const t of n){const n=new RegExp(t),o=e.match(n);if(o&&i.some(e=>o[2].includes(e))){const e=o[1],t=o[2];console.log(`🎨 Natural language color change detected: "${e}" to "${t}"`);const n={"赤":16711680,"青":255,"緑":65280,"黄":16776960,"紫":16711935,"橙":16746496,"オレンジ":16746496,"白":16777215,"黒":0,"灰":8421504,"グレー":8421504,"ピンク":16761035,"茶":9127187,"銀":12632256,"金":16766720};let i=null;for(const[e,o]of Object.entries(n))if(t.includes(e)){i=o;break}return{type:"natural_object_modification",targetObjectName:e,color:i,requiresObjectSearch:!0}}}return null}parsePositionFromPrompt(e){let t=0,n=0,i=0;e.includes("右へ")||e.includes("右に")||e.includes("右側へ")||e.includes("右側に")?t=5:(e.includes("左へ")||e.includes("左に")||e.includes("左側へ")||e.includes("左側に"))&&(t=-5),e.includes("上へ")||e.includes("上に")||e.includes("上側へ")?n=3:(e.includes("下へ")||e.includes("下に")||e.includes("下側へ"))&&(n=-3),e.includes("前へ")||e.includes("手前へ")||e.includes("近くへ")?i=3:(e.includes("後ろへ")||e.includes("奥へ")||e.includes("遠くへ"))&&(i=-3);const o=e.match(/(\d+(?:\.\d+)?)\s*(?:メートル|m)/);if(o){const e=parseFloat(o[1]);Math.abs(t)>0&&(t=t>0?e:-e),Math.abs(n)>0&&(n=n>0?e:-e),Math.abs(i)>0&&(i=i>0?e:-e)}return e.includes("少し")||e.includes("ちょっと")?(t*=.5,n*=.5,i*=.5):(e.includes("大きく")||e.includes("たくさん"))&&(t*=2,n*=2,i*=2),console.log(`📍 Position movement parsed from "${e}": (${t}, ${n}, ${i})`),{x:t,y:n,z:i}}parsePosition(e){let t=0,n=5,i=10;return e.includes("左下")?(t=-8,n=0,i=10,console.log(`📍 Position parsed from "${e}": 左下 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("右上")?(t=5,n=4,i=12,console.log(`📍 Position parsed from "${e}": 右上 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("左上")?(t=-8,n=4,i=15,console.log(`📍 Position parsed from "${e}": 左上 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("右下")?(t=8,n=0,i=10,console.log(`📍 Position parsed from "${e}": 右下 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("中央")||e.includes("真ん中")||e.includes("正面")?(t=0,n=3,i=12,console.log(`📍 Position parsed from "${e}": 中央 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("空")||e.includes("天空")?(t=0,n=20,i=10,console.log(`📍 Position parsed from "${e}": 空中 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):e.includes("地面")||e.includes("足元")?(t=0,n=1,i=8,console.log(`📍 Position parsed from "${e}": 地面 (${t}, ${n}, ${i})`),{x:t,y:n,z:i}):(e.includes("前に")||e.includes("手前に")?i=5:(e.includes("後ろに")||e.includes("奥に")||e.includes("遠くに"))&&(i=20),e.includes("右に")||e.includes("右側")||e.includes("画面の右")?t=8:(e.includes("左に")||e.includes("左側")||e.includes("画面の左"))&&(t=-8),e.includes("上に")||e.includes("上側")||e.includes("画面の上")||e.includes("高い位置に")||e.includes("空中に")?n=8:(e.includes("下に")||e.includes("下側")||e.includes("画面の下")||e.includes("低い位置に")||e.includes("地面に"))&&(n=-2),e.includes("近くに")||e.includes("すぐ前に")?i=Math.min(.5*i,3):(e.includes("遠くに")||e.includes("向こうに"))&&(i*=1.5),console.log(`📍 Position parsed from "${e}": (${t}, ${n}, ${i})`),{x:t,y:n,z:i})}parseSize(e){return e.includes("大きな")||e.includes("大きい")?{scale:2}:e.includes("小さな")||e.includes("小さい")?{scale:.5}:{scale:this.config.defaultObjectScale}}async dispatchCommand(e){switch(e.type){case"image_generation":return await this.executeImageGeneration(e);case"video_generation":return await this.executeVideoGeneration(e);case"object_modification":return await this.executeObjectModification(e);case"natural_object_modification":return await this.executeNaturalObjectModification(e);case"delete":return await this.executeDelete(e);default:throw new Error(`Unknown command type: ${e.type}`)}}async executeImageGeneration(e){try{console.log(`🎨 Generating image: "${e.prompt}"`);const t=await this.client.generateImage(e.prompt,{width:512,height:512,service:this.selectedImageService||void 0});t.modelName&&console.log(`📡 Used model: ${t.modelName}`);const n=new i.TextureLoader;let o;t.success&&t.imageUrl?(console.log(`✅ Image generated successfully: ${t.imageUrl}`),o=await n.loadAsync(t.imageUrl),o.colorSpace=i.SRGBColorSpace):(console.log("⚠️ Using fallback image"),o=this.createFallbackTexture(e.prompt));const s=6*(e.size?.scale??this.config.defaultObjectScale??1),r=o.image?.naturalWidth||o.image?.width||o.source?.data?.width||1,a=r/(o.image?.naturalHeight||o.image?.height||o.source?.data?.height||1)||1;let l=s,c=s;a>=1?(l=s,c=s/a):(l=s*a,c=s);const d=new i.PlaneGeometry(l,c),p=new i.MeshBasicMaterial({map:o,transparent:!1,side:i.DoubleSide,toneMapped:!1}),h=new i.Mesh(d,p);if(h.renderOrder=1e3,p.depthTest=!0,p.depthWrite=!0,this.camera){const t=this.calculateCameraRelativePosition(e.position);h.position.copy(t),this.alignPlaneToCamera(h)}else h.position.set(e.position.x,e.position.y,e.position.z);h.scale.setScalar(1);const u="generated_"+ ++this.objectCounter;return h.name=u,h.userData={id:u,prompt:e.prompt,createdAt:Date.now(),type:"generated_image",modelName:t.modelName||this.selectedImageService||null},this.experimentGroup.add(h),this.spawnedObjects.set(u,h),console.log(`✅ Created object: ${u} at (${e.position.x}, ${e.position.y}, ${e.position.z})`),this.config.showLocationIndicator&&this.createLocationIndicator(e.position),{objectId:u,position:e.position,prompt:e.prompt,modelName:t.modelName,success:!0}}catch(e){throw console.error("🎨 Image generation failed:",e),e}}async executeVideoGeneration(e){try{console.log(`🎬 Generating video: "${e.prompt}"`);const t=await this.client.generateVideo(e.prompt,{width:512,height:512,duration:3,model:this.selectedVideoService||void 0});let n;if(t.modelName&&console.log(`📡 Used model: ${t.modelName}`),t.success&&t.videoUrl){console.log(`✅ Video generated successfully: ${t.videoUrl}`);const e=document.createElement("video");e.src=t.videoUrl,e.crossOrigin="anonymous",e.loop=!0,e.muted=!0,e.playsInline=!0,n=new i.VideoTexture(e),n.colorSpace=i.SRGBColorSpace,e.addEventListener("loadeddata",()=>{e.play().catch(console.error)})}else console.log("⚠️ Using fallback video texture"),n=this.createFallbackVideoTexture(e.prompt);const o=6*(e.size?.scale??this.config.defaultObjectScale??1),s=t.metadata?.width||512,r=t.metadata?.height||512,a=s&&r?s/r:1;let l=o,c=o;a>=1?c=o/a:l=o*a;const d=new i.PlaneGeometry(l,c),p=new i.MeshBasicMaterial({map:n,transparent:!1,side:i.DoubleSide,toneMapped:!1}),h=new i.Mesh(d,p);if(h.renderOrder=1e3,p.depthTest=!0,p.depthWrite=!0,this.camera){const t=this.calculateCameraRelativePosition(e.position);h.position.copy(t),this.alignPlaneToCamera(h)}else h.position.set(e.position.x,e.position.y,e.position.z);h.scale.setScalar(1);const u="generated_video_"+ ++this.objectCounter;return h.name=u,h.userData={id:u,prompt:e.prompt,createdAt:Date.now(),type:"generated_video",videoUrl:t.videoUrl,modelName:t.modelName||this.selectedVideoService||null,width:s,height:r,videoElement:video},this.createAudioControl(h),this.experimentGroup.add(h),this.spawnedObjects.set(u,h),console.log(`✅ Created video object: ${u} at (${e.position.x}, ${e.position.y}, ${e.position.z})`),this.config.showLocationIndicator&&this.createLocationIndicator(e.position),{objectId:u,position:e.position,prompt:e.prompt,modelName:t.modelName,videoUrl:t.videoUrl,success:!0}}catch(e){throw console.error("🎬 Video generation failed:",e),e}}async loadImageFile(e,t={}){try{const{position:n={x:0,y:5,z:-10}}=t;console.log(`📁 Loading image file: ${e}`);const o=new i.TextureLoader,s=await o.loadAsync(e);s.colorSpace=i.SRGBColorSpace;const r=s.image?.naturalWidth||s.image?.width||s.source?.data?.width||1,a=r/(s.image?.naturalHeight||s.image?.height||s.source?.data?.height||1)||1,l=6;let c=l,d=l;a>=1?(c=l,d=l/a):(c=l*a,d=l);const p=new i.PlaneGeometry(c,d),h=new i.MeshBasicMaterial({map:s,transparent:!1,side:i.DoubleSide,toneMapped:!1}),u=new i.Mesh(p,h);if(u.renderOrder=1e3,h.depthTest=!0,h.depthWrite=!0,this.camera){const e=this.calculateCameraRelativePosition(n);u.position.copy(e),this.alignPlaneToCamera(u)}else u.position.set(n.x,n.y,n.z);u.scale.setScalar(1);const m="imported_image_"+ ++this.objectCounter;return u.name=m,u.userData={id:m,source:"imported_file",createdAt:Date.now(),type:"generated_image"},this.experimentGroup.add(u),this.spawnedObjects.set(m,u),console.log(`✅ Created imported image: ${m} at (${n.x}, ${n.y}, ${n.z})`),this.config.showLocationIndicator&&this.createLocationIndicator(n),{objectId:m,position:n,success:!0}}catch(e){throw console.error("📁 Image file loading failed:",e),e}}async loadVideoFile(e,t={}){try{const{position:n={x:0,y:5,z:-10}}=t;console.log(`🎬 Loading video file: ${e}`);const o=document.createElement("video");o.src=e,o.loop=!0,o.muted=!0,o.playsInline=!0,o.autoplay=!0,o.preload="auto";const s=new i.VideoTexture(o);s.colorSpace=i.SRGBColorSpace,await new Promise((e,t)=>{o.addEventListener("loadedmetadata",()=>{console.log(`🎬 Video loaded: ${o.videoWidth}x${o.videoHeight}`),e()},{once:!0}),o.addEventListener("error",e=>{t(e?.error||new Error("Video failed to load"))},{once:!0}),o.load()});try{await o.play()}catch(e){console.warn("🎬 Video autoplay could not start automatically. Playback will require user interaction.",e)}const r=o.videoWidth/o.videoHeight,a=6;let l=a,c=a;r>1?c=a/r:l=a*r;const d=new i.PlaneGeometry(l,c),p=new i.MeshBasicMaterial({map:s,transparent:!1,side:i.DoubleSide,toneMapped:!1}),h=new i.Mesh(d,p);if(h.renderOrder=1e3,p.depthTest=!0,p.depthWrite=!0,this.camera){const e=this.calculateCameraRelativePosition(n);h.position.copy(e),this.alignPlaneToCamera(h)}else h.position.set(n.x,n.y,n.z);h.scale.setScalar(1);const u="imported_video_"+ ++this.objectCounter;return h.name=u,h.userData={id:u,source:"imported_file",createdAt:Date.now(),type:"generated_video",videoElement:o,objectUrl:e},this.createAudioControl(h),this.experimentGroup.add(h),this.spawnedObjects.set(u,h),console.log(`✅ Created imported video: ${u} at (${n.x}, ${n.y}, ${n.z})`),this.config.showLocationIndicator&&this.createLocationIndicator(n),{objectId:u,position:n,success:!0}}catch(e){throw console.error("🎬 Video file loading failed:",e),e}}async executeNaturalObjectModification(e){const t=this.findObjectsByName(e.targetObjectName);if(0===t.length)return{success:!1,message:`オブジェクト「${e.targetObjectName}」が見つかりませんでした`};console.log(`🔍 Found ${t.length} object(s) matching "${e.targetObjectName}"`);const n=this.selectObjectFromMultiple(t,e.targetObjectName);console.log(`🎯 Operating on object: ${n.name}`);let i=!1;if(null!==e.color&&n.material&&(n.material.map,n.material.color.setHex(e.color),console.log(`🎨 Color changed to: ${e.color.toString(16)}`),i=!0),null!==e.movement){const t=n.position,o={x:t.x+e.movement.x,y:t.y+e.movement.y,z:t.z+e.movement.z};n.position.set(o.x,o.y,o.z),console.log(`📍 Position moved from (${t.x.toFixed(1)}, ${t.y.toFixed(1)}, ${t.z.toFixed(1)}) to (${o.x.toFixed(1)}, ${o.y.toFixed(1)}, ${o.z.toFixed(1)})`),i=!0}return i?(n.userData.lastModified=Date.now(),n.userData.modifications=n.userData.modifications||[],n.userData.modifications.push({timestamp:Date.now(),color:e.color,movement:e.movement,command:`Natural language: ${e.targetObjectName}`}),{success:!0,message:`オブジェクト「${n.name}」を変更しました`,objectId:n.name,modifications:{color:e.color,movement:e.movement}}):{success:!1,message:"変更可能な属性が見つかりませんでした"}}findObjectsByName(e){const t=[],n=e.toLowerCase();for(const[e,i]of this.spawnedObjects){if(i.userData.prompt){i.userData.prompt.toLowerCase().includes(n)&&(t.push(i),console.log(`✅ Object match found: ${e} (prompt: "${i.userData.prompt}")`))}i.name&&i.name.toLowerCase().includes(n)&&(t.push(i),console.log(`✅ Object match found: ${e} (name: "${i.name}")`))}return t}selectObjectFromMultiple(e,t){const n=[/(\d+)つ目の/,/(\d+)番目の/,/(\d+)個目の/,/最初の|1つ目の|1番目の|1個目の/,/最後の|最終の/,/2つ目の|2番目の|2個目の/,/3つ目の|3番目の|3個目の/];for(const i of n){const n=t.match(i);if(n){let t;if(n[1])t=parseInt(n[1])-1;else{const i=n[0];i.includes("最初")||i.includes("1つ目")||i.includes("1番目")||i.includes("1個目")?t=0:i.includes("最後")||i.includes("最終")?t=e.length-1:i.includes("2つ目")||i.includes("2番目")||i.includes("2個目")?t=1:(i.includes("3つ目")||i.includes("3番目")||i.includes("3個目"))&&(t=2)}if(t>=0&&t<e.length)return console.log(`🔢 Selected object by ordinal: index ${t+1} of ${e.length}`),e[t];console.warn(`⚠️ Invalid ordinal index: ${t+1} (available: 1-${e.length})`)}}return console.log("🔢 No ordinal specified, using first object"),e[0]}async executeObjectModification(e){let t=this.findObjectByKeyword(e.command);if(t)this.selectObject(t);else{if(!this.selectedObject)return{success:!1,message:"オブジェクトを選択するか、対象を指定してください（例：「猫を赤くして」）"};t=this.selectedObject}console.log(`🔧 Modifying object: ${t.name}`),console.log("🔍 Debug - parsed.movement:",e.movement);let n=!1;if(null!==e.color&&t.material&&(t.material.map,t.material.color.setHex(e.color),console.log(`🎨 Color changed to: ${e.color.toString(16)}`),n=!0),null!==e.scale){const i=t.scale.x,o=i*e.scale;t.scale.setScalar(o),console.log(`📏 Scale changed from ${i} to ${o}`),n=!0}if(null!==e.movement){const i=t.position,o={x:i.x+e.movement.x,y:i.y+e.movement.y,z:i.z+e.movement.z};t.position.set(o.x,o.y,o.z),console.log(`📍 Position moved from (${i.x.toFixed(1)}, ${i.y.toFixed(1)}, ${i.z.toFixed(1)}) to (${o.x.toFixed(1)}, ${o.y.toFixed(1)}, ${o.z.toFixed(1)})`),n=!0}return n?(t.userData.lastModified=Date.now(),t.userData.modifications=t.userData.modifications||[],t.userData.modifications.push({timestamp:Date.now(),color:e.color,scale:e.scale,movement:e.movement,command:e.command}),{success:!0,message:`オブジェクト「${t.name}」を変更しました`,objectId:t.name,modifications:{color:e.color,scale:e.scale,movement:e.movement}}):{success:!1,message:"変更可能な属性が見つかりませんでした"}}async executeDelete(e){const t=e.command||"";if("all"===e.target||t.includes("すべて")||t.includes("全部"))return this.clearAll(),{success:!0,message:"すべてのオブジェクトを削除しました"};const n=this.findObjectByKeyword(t);let i=null,o="";if(t.match(/^(削除|消して|消す|delete|remove)$/i)&&this.selectedObject?(i=this.selectedObject,o="選択されたオブジェクト"):n?(i=n,o="コマンドで指定されたオブジェクト"):this.selectedObject&&(i=this.selectedObject,o="選択されたオブジェクト"),i){const e=i.name;console.log(`🗑️ Deleting ${o}: ${e}`),i===this.selectedObject&&this.deselectObject();return this.removeObject(e)?{success:!0,message:`${o}「${e}」を削除しました`,deletedObjectId:e}:{success:!1,message:"オブジェクトの削除に失敗しました"}}return{success:!1,message:"削除対象が見つかりませんでした。オブジェクトを選択するか、対象を指定してください"}}createFallbackTexture(e){const t=document.createElement("canvas");t.width=512,t.height=512;const n=t.getContext("2d"),o=this.hashString(e)%360,s=n.createLinearGradient(0,0,512,512);return s.addColorStop(0,`hsl(${o}, 70%, 60%)`),s.addColorStop(1,`hsl(${(o+60)%360}, 70%, 40%)`),n.fillStyle=s,n.fillRect(0,0,512,512),n.fillStyle="white",n.font="24px Arial",n.textAlign="center",n.fillText("🎨",256,230),n.font="16px Arial",n.fillText(e.slice(0,20),256,270),n.font="14px Arial",n.fillStyle="rgba(255,255,255,0.7)",n.fillText("Placeholder Image",256,300),new i.CanvasTexture(t)}createFallbackVideoTexture(e){const t=document.createElement("canvas");t.width=512,t.height=512;const n=t.getContext("2d"),o=this.hashString(e)%360;let s=0;const r=()=>{const t=n.createLinearGradient(0,0,512,512),i=2*s%360;t.addColorStop(0,`hsl(${(o+i)%360}, 70%, 60%)`),t.addColorStop(1,`hsl(${(o+i+60)%360}, 70%, 40%)`),n.fillStyle=t,n.fillRect(0,0,512,512),n.fillStyle="white",n.font="24px Arial",n.textAlign="center";const a=["🎬","🎥","📹","🎞️"],l=Math.floor(s/10)%a.length;n.fillText(a[l],256,230),n.font="16px Arial",n.fillText(e.slice(0,20),256,270),n.font="14px Arial",n.fillStyle="rgba(255,255,255,0.7)",n.fillText("Placeholder Video",256,300),s++,setTimeout(()=>requestAnimationFrame(r),1e3/60)};return r(),new i.CanvasTexture(t)}hashString(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t)}getSpawnedObjects(){return Array.from(this.spawnedObjects.entries()).map(([e,t])=>({id:e,name:t.name,userData:t.userData,position:t.position.clone()}))}removeObject(e){const t=this.spawnedObjects.get(e);if(t){if(t.userData?.videoElement){const e=t.userData.videoElement;try{e.pause(),"function"==typeof e.removeAttribute?e.removeAttribute("src"):e.src="","function"==typeof e.load&&e.load()}catch(e){console.warn("🎬 Failed to release video element resources:",e)}}if(t.userData?.objectUrl)try{URL.revokeObjectURL(t.userData.objectUrl)}catch(e){console.warn("🎬 Failed to revoke object URL:",e)}if(this.experimentGroup.remove(t),this.spawnedObjects.delete(e),t.geometry&&t.geometry.dispose(),t.material){(Array.isArray(t.material)?t.material:[t.material]).forEach(e=>{e.map&&"function"==typeof e.map.dispose&&e.map.dispose(),e.dispose()})}return console.log(`🗑️ Removed object: ${e}`),!0}return!1}clearAll(){Array.from(this.spawnedObjects.keys()).forEach(e=>this.removeObject(e)),console.log("🧹 Cleared all experimental objects")}getCommandHistory(){return[...this.commandHistory]}createLocationIndicator(e){const t=new i.SphereGeometry(1,16,16),n=new i.MeshBasicMaterial({color:65280,transparent:!0,opacity:.9}),o=new i.Mesh(t,n);if(this.camera){const t=this.calculateCameraRelativePosition({x:e.x,y:e.y+2,z:e.z});o.position.copy(t)}else o.position.set(e.x,e.y+2,e.z);console.log(`🟢 インジケーター表示: (${o.position.x.toFixed(1)}, ${o.position.y.toFixed(1)}, ${o.position.z.toFixed(1)})`),this.scene.add(o),setTimeout(()=>{this.scene.remove(o),t.dispose(),n.dispose()},this.config.indicatorDuration);let s=.8,r=-1;const a=()=>{s+=.05*r,s<=.3&&(r=1),s>=.8&&(r=-1),n.opacity=s,o.parent&&requestAnimationFrame(a)};a()}calculateCameraRelativePosition(e){if(!this.camera)return this.config.enableDebugLogging&&console.warn("📷 Camera not available, using fallback positioning"),new i.Vector3(e.x,e.y,e.z);try{const t=this.camera.position.clone(),n=new i.Vector3;this.camera.getWorldDirection(n);const o=new i.Vector3,s=new i.Vector3(0,1,0);o.crossVectors(n,s).normalize();const r=new i.Vector3;r.crossVectors(o,n).normalize();const a=t.clone();return a.add(n.clone().multiplyScalar(e.z)),a.add(o.clone().multiplyScalar(e.x)),a.add(r.clone().multiplyScalar(e.y)),this.logDebug(`📍 Camera relative position calculated: (${a.x.toFixed(1)}, ${a.y.toFixed(1)}, ${a.z.toFixed(1)})`),a}catch(t){return console.error("❌ Camera relative position calculation failed:",t),new i.Vector3(e.x,e.y,e.z)}}alignPlaneToCamera(e){if(!this.camera)return;const t=new i.Vector3;this.camera.getWorldDirection(t),t.negate();let n=(new i.Vector3).copy(this.camera.up).applyQuaternion(this.camera.quaternion).normalize();Math.abs(t.dot(n))>.999&&(n=new i.Vector3(0,1,0),Math.abs(t.dot(n))>.999&&(n=new i.Vector3(0,0,1)));const o=(new i.Vector3).crossVectors(n,t).normalize();n=(new i.Vector3).crossVectors(t,o).normalize();const s=new i.Matrix4;s.makeBasis(o,n,t),e.quaternion.setFromRotationMatrix(s)}setCamera(e){this.camera=e}updateConfig(e){this.config={...this.config,...e}}setImageService(e){this.selectedImageService=e||null,this.logDebug("🎯 Updated image service:",this.selectedImageService)}getImageService(){return this.selectedImageService}setVideoService(e){this.selectedVideoService=e||null,this.logDebug("🎬 Updated video service:",this.selectedVideoService)}getVideoService(){return this.selectedVideoService}createAudioControl(e){const t=e.userData.videoElement;if(!t)return;const n=document.createElement("div");n.className="chocodrop-audio-control",n.innerHTML="♪";const i=(()=>{const e=document.createElement("div");return e.className="chocodrop-audio-tooltip",e.textContent="音声のオン/オフ切り替え",e.style.cssText="\n        position: absolute !important;\n        background: rgba(0, 0, 0, 0.85) !important;\n        backdrop-filter: blur(12px) !important;\n        -webkit-backdrop-filter: blur(12px) !important;\n        border: 1px solid rgba(255, 255, 255, 0.15) !important;\n        border-radius: 8px !important;\n        padding: 8px 12px !important;\n        color: white !important;\n        font-size: 11px !important;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;\n        font-weight: 500 !important;\n        white-space: nowrap !important;\n        pointer-events: none !important;\n        z-index: 1000000 !important;\n        opacity: 0 !important;\n        transform: translateY(-100%) translateX(-50%) !important;\n        transition: opacity 0.2s ease !important;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;\n        margin-bottom: 8px !important;\n      ",e})();document.body.appendChild(i);const o=(()=>{const e=document.createElement("div");e.className="chocodrop-volume-slider",e.style.cssText="\n        position: absolute !important;\n        width: 30px !important;\n        height: 100px !important;\n        background: rgba(0, 0, 0, 0.85) !important;\n        backdrop-filter: blur(12px) !important;\n        -webkit-backdrop-filter: blur(12px) !important;\n        border: 1px solid rgba(255, 255, 255, 0.15) !important;\n        border-radius: 15px !important;\n        padding: 10px 8px !important;\n        z-index: 1000001 !important;\n        opacity: 0 !important;\n        pointer-events: none !important;\n        transition: opacity 0.2s ease !important;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3) !important;\n        display: flex !important;\n        flex-direction: column !important;\n        align-items: center !important;\n        justify-content: center !important;\n      ";const i=document.createElement("input");i.type="range",i.min="0",i.max="100",i.value="100",i.style.cssText="\n        width: 12px !important;\n        height: 80px !important;\n        background: rgba(255, 255, 255, 0.2) !important;\n        border-radius: 6px !important;\n        outline: none !important;\n        cursor: pointer !important;\n        -webkit-appearance: none !important;\n        appearance: none !important;\n        writing-mode: bt-lr !important;\n      ";const o=document.createElement("style");return o.textContent='\n        .chocodrop-volume-slider input[type="range"]::-webkit-slider-track {\n          width: 6px;\n          height: 80px;\n          background: rgba(255, 255, 255, 0.2);\n          border-radius: 3px;\n        }\n        .chocodrop-volume-slider input[type="range"]::-webkit-slider-thumb {\n          -webkit-appearance: none;\n          width: 14px;\n          height: 14px;\n          background: white;\n          border-radius: 50%;\n          cursor: pointer;\n          box-shadow: 0 2px 6px rgba(0,0,0,0.3);\n        }\n        .chocodrop-volume-slider input[type="range"]::-moz-range-track {\n          width: 6px;\n          height: 80px;\n          background: rgba(255, 255, 255, 0.2);\n          border-radius: 3px;\n          border: none;\n        }\n        .chocodrop-volume-slider input[type="range"]::-moz-range-thumb {\n          width: 14px;\n          height: 14px;\n          background: white;\n          border-radius: 50%;\n          cursor: pointer;\n          border: none;\n          box-shadow: 0 2px 6px rgba(0,0,0,0.3);\n        }\n      ',document.head.appendChild(o),i.addEventListener("input",e=>{const i=e.target.value;t.volume=i/100,0==i?(n.innerHTML="♪̸",n.style.background="rgba(99, 102, 241, 0.6) !important",n.style.color="#8b5cf6 !important"):(n.innerHTML="♪",n.style.background="rgba(0, 0, 0, 0.4) !important",n.style.color="white !important")}),e.appendChild(i),e})();document.body.appendChild(o),n.style.cssText="\n      position: absolute !important;\n      width: 18px !important;\n      height: 18px !important;\n      background: rgba(0, 0, 0, 0.4) !important;\n      border: 1px solid rgba(255, 255, 255, 0.3) !important;\n      border-radius: 50% !important;\n      color: white !important;\n      font-size: 9px !important;\n      cursor: pointer !important;\n      display: flex !important;\n      align-items: center !important;\n      justify-content: center !important;\n      z-index: 999999 !important;\n      transition: all 0.2s ease !important;\n      user-select: none !important;\n      box-shadow: 0 1px 4px rgba(0,0,0,0.2) !important;\n      backdrop-filter: blur(8px) !important;\n      pointer-events: auto !important;\n      opacity: 1 !important;\n    ";let s=!1;n.addEventListener("mouseenter",()=>{if(n.style.background="rgba(0, 0, 0, 0.7)",n.style.transform="scale(1.05)",n.style.borderColor="rgba(255, 255, 255, 0.5)",!s){const e=n.getBoundingClientRect();i.style.left=`${e.left+e.width/2}px`,i.style.top=e.top-8+"px",i.style.opacity="1"}}),n.addEventListener("mouseleave",()=>{n.style.background="rgba(0, 0, 0, 0.5)",n.style.transform="scale(1.0)",n.style.borderColor="rgba(255, 255, 255, 0.4)",i.style.opacity="0"}),n.addEventListener("click",e=>{if(e.stopPropagation(),s)return s=!1,o.style.opacity="0",void(o.style.pointerEvents="none");t.muted||0===t.volume?(t.muted=!1,t.volume=o.querySelector("input").value/100,n.innerHTML="♪",n.style.background="rgba(0, 0, 0, 0.4) !important",n.style.color="white !important"):(t.muted=!0,n.innerHTML="♪̸",n.style.background="rgba(99, 102, 241, 0.6) !important",n.style.color="#8b5cf6 !important")}),n.addEventListener("contextmenu",e=>{if(e.preventDefault(),e.stopPropagation(),s=!s,s){const e=n.getBoundingClientRect();o.style.left=e.left+e.width/2-15+"px",o.style.top=e.top-110+"px",o.style.opacity="1",o.style.pointerEvents="auto",i.style.opacity="0"}else o.style.opacity="0",o.style.pointerEvents="none"}),document.addEventListener("click",e=>{!s||n.contains(e.target)||o.contains(e.target)||(s=!1,o.style.opacity="0",o.style.pointerEvents="none")}),document.body.appendChild(n),e.userData.showAudioControl=()=>{n.style.opacity="1",n.style.pointerEvents="auto"},e.userData.hideAudioControl=()=>{s||(n.style.opacity="0",n.style.pointerEvents="none")},e.userData.audioControlElement=n,e.userData.updateAudioControlPosition=()=>{this.updateAudioControlPosition(e,n)},this.updateAudioControlPosition(e,n),this.audioControlUpdateInterval||(this.audioControlUpdateInterval=setInterval(()=>{this.spawnedObjects.forEach(e=>{e.userData.updateAudioControlPosition&&e.userData.updateAudioControlPosition()})},100)),e.userData.cleanupCallbacks=e.userData.cleanupCallbacks||[],e.userData.cleanupCallbacks.push(()=>{n.parentNode&&n.parentNode.removeChild(n)}),console.log("🔊 Audio control created for video:",e.userData.id)}updateAudioControlPosition(e,t){if(!this.camera||!this.renderer||!t.parentNode)return;const n=new i.Vector3;e.getWorldPosition(n),n.project(this.camera);const o=this.renderer.domElement.getBoundingClientRect(),s=(.5*n.x+.5)*o.width+o.left,r=-(.5*n.y-.5)*o.height+o.top,a=e.geometry;if(a&&a.parameters){a.parameters.width,e.scale.x;const n=150,i=-50;t.style.left=`${s+n}px`,t.style.top=`${r+i}px`}else t.style.left=`${s+50}px`,t.style.top=r-20+"px"}toggleVideoAudio(e,t){const n=e.userData.videoElement;n&&(n.muted?(n.muted=!1,t.innerHTML="🔈",console.log("🔊 Audio enabled for video:",e.userData.id)):(n.muted=!0,t.innerHTML="🔊",console.log("🔇 Audio muted for video:",e.userData.id)))}initializeLabelRenderer(){this.labelRenderer||this.loadAndInitializeCSS2DRenderer()}async ensureCSS2DRenderer(){this.labelRenderer||(this.css2dInitPromise||(this.css2dInitPromise=this.loadAndInitializeCSS2DRenderer()),await this.css2dInitPromise)}async loadAndInitializeCSS2DRenderer(){try{if(window.THREE&&window.THREE.CSS2DRenderer)return void this.setupCSS2DRenderer();console.log("🏷️ Loading CSS2DRenderer dynamically...");const e=await import("https://cdn.skypack.dev/three@0.158.0/examples/jsm/renderers/CSS2DRenderer.js");window.THREE||(window.THREE={}),window.THREE.CSS2DRenderer=e.CSS2DRenderer,window.THREE.CSS2DObject=e.CSS2DObject,console.log("✅ CSS2DRenderer loaded successfully"),this.setupCSS2DRenderer()}catch(e){console.warn("⚠️ Failed to load CSS2DRenderer:",e),console.warn("🔧 Audio controls will not be visible. Please include CSS2DRenderer in your project.")}}setupCSS2DRenderer(){try{this.labelRenderer=new window.THREE.CSS2DRenderer,this.labelRenderer.setSize(window.innerWidth,window.innerHeight),this.labelRenderer.domElement.style.position="absolute",this.labelRenderer.domElement.style.top="0px",this.labelRenderer.domElement.style.pointerEvents="none",this.renderer&&this.renderer.domElement.parentNode?this.renderer.domElement.parentNode.appendChild(this.labelRenderer.domElement):document.body.appendChild(this.labelRenderer.domElement),console.log("🏷️ CSS2DRenderer initialized for UI overlays"),this.addLabelRendererResizeHandler()}catch(e){console.warn("⚠️ Failed to setup CSS2DRenderer:",e)}}addLabelRendererResizeHandler(){this.labelRendererResizeHandler||(this.labelRendererResizeHandler=()=>{this.labelRenderer&&this.labelRenderer.setSize(window.innerWidth,window.innerHeight)},window.addEventListener("resize",this.labelRendererResizeHandler))}updateRenderer(){this.labelRenderer&&this.scene&&this.camera&&this.labelRenderer.render(this.scene,this.camera)}logDebug(...e){this.config.enableDebugLogging&&console.log(...e)}getAdaptiveSelectionColor(){const e=this.scene.background;let t={r:.5,g:.5,b:.5};e&&e.isColor&&(t={r:e.r,g:e.g,b:e.b});return(e=>{const{r:t,g:n,b:i}=e;return.2126*(t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.7152*(n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4))+.0722*(i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4))})(t)<.5?65416:1710638}getAdaptiveHoverColor(){const e=this.scene.background;let t={r:.5,g:.5,b:.5};e&&e.isColor&&(t={r:e.r,g:e.g,b:e.b});return(e=>{const{r:t,g:n,b:i}=e;return.2126*(t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.7152*(n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4))+.0722*(i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4))})(t)<.5?65535:16724838}dispose(){this.clearAll(),this.experimentGroup.parent&&this.experimentGroup.parent.remove(this.experimentGroup)}}const l="chocodrop-service-image",c="chocodrop-service-video";class d{constructor(e={}){this.sceneManager=e.sceneManager||null,this.client=e.client||null,this.onControlsToggle=e.onControlsToggle||(()=>{}),this.isVisible=!1,this.container=null,this.input=null,this.output=null,this.currentMode="generate",this.activeConnections=new Map,this.currentTaskId=null,this.config={activationKey:e.activationKey||"@",position:e.position||"bottom-right",width:e.width||450,maxHeight:e.maxHeight||600,theme:e.theme||"dark",showExamples:!1!==e.showExamples,autoScroll:!1!==e.autoScroll,enableDebugLogging:!0===e.enableDebugLogging,...e.config},this.availableImageServices=[],this.availableVideoServices=[],this.selectedImageService=null,this.selectedVideoService=null,this.imageServiceSelect=null,this.videoServiceSelect=null,this.serviceSelectorContainer=null,this.serviceSelectorStatus=null,this.serviceSelectorContent=null,this.serviceSelectorRetryButton=null,this.serviceSelectorSaveButton=null,this.serviceSelectorCancelButton=null,this.serviceModalOverlay=null,this.serviceModal=null,this.servicesLoading=!1,this.pendingImageService=null,this.pendingVideoService=null;try{const e=localStorage.getItem(l),t=localStorage.getItem(c);e&&(this.selectedImageService=e),t&&(this.selectedVideoService=t)}catch(e){console.warn("⚠️ Failed to load stored service selections:",e)}this.pendingImageService=this.selectedImageService,this.pendingVideoService=this.selectedVideoService,this.applyServiceSelectionToSceneManager(),this.isDarkMode="dark"===localStorage.getItem("live-command-theme")||null===localStorage.getItem("live-command-theme"),this.commandHistory=[],this.currentHistoryIndex=-1,this.maxHistorySize=50,this.initUI(),this.bindEvents(),!this.client&&this.sceneManager&&this.sceneManager.client&&(this.client=this.sceneManager.client),this.createServiceModal(),this.createFloatingChocolateIcon(),document.addEventListener("DOMContentLoaded",()=>{this.refreshStyles()}),this.logDebug("🎮 CommandUI initialized"),this.selectedImageService&&this.selectedVideoService||this.openServiceModal(!0)}logDebug(...e){this.config.enableDebugLogging&&console.log(...e)}initUI(){this.container=document.createElement("div"),this.container.id="live-command-ui",this.container.style.cssText=this.getContainerStyles();const e=document.createElement("div");e.className="progressive-brand-indicator",e.style.cssText="\n      position: absolute;\n      top: -8px;\n      right: 8px;\n      width: 8px;\n      height: 8px;\n      background: linear-gradient(135deg, #6366f1, #8b5cf6);\n      border-radius: 50%;\n      opacity: 0.7;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      z-index: 10;\n      cursor: pointer;\n    ";const t=document.createElement("div");t.className="progressive-brand-text",t.style.cssText=`\n      position: absolute;\n      top: -35px;\n      right: -5px;\n      padding: 6px 12px;\n      background: rgba(255, 255, 255, 0.15);\n      border: 1px solid ${this.isDarkMode?"rgba(129, 140, 248, 0.3)":"rgba(99, 102, 241, 0.25)"};\n      border-radius: 12px;\n      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      font-size: 11px;\n      font-weight: 700;\n      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n      letter-spacing: 0.02em;\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      opacity: 0;\n      transform: translateY(5px) scale(0.9);\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      pointer-events: none;\n      z-index: 11;\n      white-space: nowrap;\n    `,t.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">🍫</span> <span style="color: #6366f1;">ChocoDrop</span>',e.addEventListener("mouseenter",()=>{t.style.opacity="1",t.style.transform="translateY(0) scale(1)",e.style.transform="scale(1.2)",e.style.opacity="1"}),e.addEventListener("mouseleave",()=>{t.style.opacity="0",t.style.transform="translateY(5px) scale(0.9)",e.style.transform="scale(1)",e.style.opacity="0.7"}),e.appendChild(t),this.container.appendChild(e),this.output=document.createElement("div"),this.outputDiv=this.output,this.output.id="command-output",this.output.className="command-output",this.output.style.cssText=this.getOutputStyles(),this.floatingContainer=document.createElement("div"),this.floatingContainer.id="floating-cards-container",this.floatingContainer.style.cssText="\n      position: fixed;\n      top: 20px;\n      left: 50%;\n      transform: translateX(-50%);\n      z-index: 99999;\n      pointer-events: none;\n      display: none;\n      flex-direction: column-reverse;\n      gap: 8px;\n      width: 400px;\n      max-width: 90vw;\n      align-items: center;\n      justify-content: flex-end;\n    ",this.taskCards=new Map,this.inputWrapper=document.createElement("div"),this.inputWrapper.style.cssText="\n      position: relative;\n      width: 100%;\n      margin-bottom: 14px;\n    ",this.input=document.createElement("textarea"),this.input.rows=1,this.input.id="command-input",this.input.placeholder="「右上にドラゴンを」「美しい桜の森を中央に」など... ✨",this.input.style.cssText=this.getInputStyles(),this.expandButton=document.createElement("div"),this.expandButton.innerHTML="⤢",this.expandButton.title="テキスト全体を表示",this.expandButton.style.cssText=`\n      position: absolute;\n      bottom: 8px;\n      right: 8px;\n      width: 24px;\n      height: 24px;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"};\n      border: 1px solid ${this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)"};\n      border-radius: 6px;\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      font-size: 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      z-index: 1;\n    `,this.expandButton.addEventListener("mouseenter",()=>{this.expandButton.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)",this.expandButton.style.transform="scale(1.1)"}),this.expandButton.addEventListener("mouseleave",()=>{this.expandButton.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",this.expandButton.style.transform="scale(1)"}),this.expandButton.addEventListener("click",()=>{"none"===this.input.style.maxHeight?(this.input.style.maxHeight="66px",this.expandButton.innerHTML="⤢",this.expandButton.title="テキスト全体を表示"):(this.input.style.maxHeight="none",this.expandButton.innerHTML="⤡",this.expandButton.title="元のサイズに戻す")}),this.inputWrapper.appendChild(this.input),this.inputWrapper.appendChild(this.expandButton);const n=this.createRadioModeSelector(),i=this.createMinimalActions(),o=document.createElement("div");o.innerHTML="×",o.style.cssText=`\n      position: absolute;\n      top: 12px;\n      right: 12px;\n      width: 22px;\n      height: 22px;\n      border-radius: 50%;\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"};\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: normal;\n      transition: all 0.2s ease;\n      backdrop-filter: blur(8px);\n      z-index: 10;\n    `,o.addEventListener("mouseover",()=>{o.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)",o.style.transform="scale(1.1)"}),o.addEventListener("mouseout",()=>{o.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",o.style.color=this.isDarkMode?"#ffffff":"#1f2937",o.style.transform="scale(1)"}),o.addEventListener("click",()=>{this.hide()}),this.container.appendChild(o),this.container.appendChild(n),this.container.appendChild(this.inputWrapper),this.container.appendChild(i),document.body.appendChild(this.floatingContainer),document.body.appendChild(this.container),this.applyTheme(),this.isComposing=!1,this.hasCompositionJustEnded=!1,this.input.addEventListener("input",()=>{this.isComposing||(this.autoResizeTextarea(),this.detectCommandType())}),this.input.addEventListener("compositionstart",()=>{this.isComposing=!0}),this.input.addEventListener("compositionend",()=>{this.isComposing=!1;/Safari/.test(navigator.userAgent)&&/Version/.test(navigator.userAgent)&&(this.hasCompositionJustEnded=!0),setTimeout(()=>{this.autoResizeTextarea(),this.detectCommandType()},10)});const s=/Safari/.test(navigator.userAgent)&&/Version/.test(navigator.userAgent);this.input.addEventListener("keydown",e=>{if("Enter"===e.key){if(s&&this.hasCompositionJustEnded)return void(this.hasCompositionJustEnded=!1);if(!s&&(e.isComposing||this.isComposing))return;e.preventDefault(),this.executeCommand()}}),this.config.showExamples}createMinimalActions(){const e=document.createElement("div");e.style.cssText="\n      display: flex;\n      margin-top: 12px;\n      gap: 10px;\n      justify-content: space-between;\n      align-items: center;\n    ";const t=document.createElement("div");t.style.cssText="display: flex; gap: 8px; align-items: center;";const n=document.createElement("button");n.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.7) brightness(0.9);">🧹</span> Clear All',n.style.cssText=this.getActionButtonStyles("secondary"),n.addEventListener("click",()=>this.clearAllWithConfirmation());const i=document.createElement("button");i.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.7) brightness(0.9);">📚</span> History',i.style.cssText=this.getActionButtonStyles("secondary"),i.style.opacity="0.5",i.disabled=!0,i.title="履歴機能（開発中）",t.appendChild(n),t.appendChild(i);const o=document.createElement("div");o.style.cssText="display: flex; gap: 6px; align-items: center;";const s=document.createElement("button");s.innerHTML=this.isDarkMode?'<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">☀️</span>':'<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">🌙</span>',s.style.cssText=this.getActionButtonStyles("icon"),s.title=this.isDarkMode?"ライトモードに切り替え":"ダークモードに切り替え",s.addEventListener("click",()=>this.toggleTheme());const r=document.createElement("button");return r.innerHTML='<span style="filter: hue-rotate(240deg) saturate(0.8) brightness(1.1);">⚙️</span>',r.style.cssText=this.getActionButtonStyles("icon"),r.title="サービス設定を開く",r.addEventListener("click",()=>this.openServiceModal()),o.appendChild(s),o.appendChild(r),e.appendChild(t),e.appendChild(o),this.clearBtn=n,this.historyBtn=i,this.themeToggle=s,this.settingsButton=r,e}createServiceSelectorSection(){return this.serviceSelectorContainer=document.createElement("div"),this.serviceSelectorContainer.id="service-selector",this.serviceSelectorContainer.style.cssText="\n      margin-bottom: 16px;\n      padding: 12px;\n      border-radius: 12px;\n      border: 1px solid transparent;\n      transition: background 0.3s ease, border 0.3s ease;\n    ",this.serviceSelectorStatus=document.createElement("div"),this.serviceSelectorStatus.textContent="サービス情報を読み込んでいます...",this.serviceSelectorStatus.style.fontSize="12px",this.serviceSelectorStatus.style.opacity="0.8",this.serviceSelectorStatus.style.marginBottom="8px",this.serviceSelectorContainer.appendChild(this.serviceSelectorStatus),this.serviceSelectorContent=document.createElement("div"),this.serviceSelectorContainer.appendChild(this.serviceSelectorContent),this.updateServiceSelectorTheme(),this.serviceSelectorContainer}createServiceModal(){this.serviceModalOverlay&&(this.serviceModalOverlay.remove(),this.serviceModalOverlay=null,this.serviceModal=null),this.serviceModalOverlay=document.createElement("div"),this.serviceModalOverlay.id="chocodrop-service-modal-overlay",this.serviceModalOverlay.style.cssText="\n      position: fixed;\n      inset: 0;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      backdrop-filter: blur(18px);\n      -webkit-backdrop-filter: blur(18px);\n      z-index: 2000;\n      padding: 24px;\n      opacity: 0;\n      transition: opacity 0.2s ease;\n    ",this.serviceModalOverlay.addEventListener("click",e=>{e.target===this.serviceModalOverlay&&this.closeServiceModal()}),this.serviceModal=document.createElement("div"),this.serviceModal.className="chocodrop-service-modal",this.serviceModal.style.cssText="\n      width: min(420px, 90vw);\n      border-radius: 24px;\n      padding: 26px 28px;\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);\n      display: flex;\n      flex-direction: column;\n      gap: 18px;\n      max-height: 90vh;\n      overflow-y: auto;\n      position: relative;\n    ";const e=document.createElement("h2");e.textContent="サービス設定",e.style.cssText="\n      margin: 0;\n      font-size: 18px;\n      font-weight: 700;\n      letter-spacing: 0.03em;\n    ";const t=document.createElement("p");t.textContent="利用するサービスを選択してください。",t.style.cssText="\n      margin: 0;\n      font-size: 12px;\n      opacity: 0.75;\n    ";const n=this.createServiceSelectorSection(),i=document.createElement("div");i.style.cssText="\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      gap: 16px;\n    ",this.serviceSelectorRetryButton=document.createElement("button"),this.serviceSelectorRetryButton.textContent="再読み込み",this.serviceSelectorRetryButton.style.cssText="\n      font-size: 11px;\n      padding: 6px 14px;\n      border-radius: 10px;\n      border: 1px solid transparent;\n      cursor: pointer;\n      display: none;\n      transition: all 0.2s ease;\n    ",this.serviceSelectorRetryButton.addEventListener("click",()=>this.initializeServiceSelector(!0));const o=document.createElement("div");o.style.cssText="display: flex; gap: 8px;",this.serviceSelectorCancelButton=document.createElement("button"),this.serviceSelectorCancelButton.textContent="Cancel",this.serviceSelectorCancelButton.style.cssText="\n      font-size: 12px;\n      padding: 8px 16px;\n      border-radius: 10px;\n      border: 1px solid rgba(255, 255, 255, 0.35);\n      background: transparent;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    ",this.serviceSelectorCancelButton.addEventListener("click",()=>this.closeServiceModal()),this.serviceSelectorSaveButton=document.createElement("button"),this.serviceSelectorSaveButton.textContent="Save",this.serviceSelectorSaveButton.style.cssText="\n      font-size: 12px;\n      padding: 8px 18px;\n      border-radius: 10px;\n      border: none;\n      cursor: pointer;\n      background: linear-gradient(135deg, #6366f1, #8b5cf6);\n      color: white;\n      font-weight: 600;\n      transition: all 0.2s ease;\n      box-shadow: 0 12px 24px rgba(99, 102, 241, 0.35);\n    ",this.serviceSelectorSaveButton.addEventListener("click",()=>this.handleServiceSave()),o.appendChild(this.serviceSelectorCancelButton),o.appendChild(this.serviceSelectorSaveButton),i.appendChild(this.serviceSelectorRetryButton),i.appendChild(o),this.serviceModal.appendChild(e),this.serviceModal.appendChild(t),this.serviceModal.appendChild(n),this.serviceModal.appendChild(i),this.serviceModalOverlay.appendChild(this.serviceModal),document.body.appendChild(this.serviceModalOverlay),this.updateServiceSelectorTheme(),this.toggleServiceRetryButton(!1)}openServiceModal(e=!1){this.serviceModalOverlay||this.createServiceModal(),this.serviceModalOverlay.style.display="flex",requestAnimationFrame(()=>{this.serviceModalOverlay&&(this.serviceModalOverlay.style.opacity="1")}),this.resetPendingSelections(),this.initializeServiceSelector(e)}closeServiceModal(){this.serviceModalOverlay&&(this.serviceModalOverlay.style.opacity="0",setTimeout(()=>{this.serviceModalOverlay&&(this.serviceModalOverlay.style.display="none"),this.resetPendingSelections()},150))}async initializeServiceSelector(e=!1){if(!this.servicesLoading||e){if(!this.client||"function"!=typeof this.client.getAvailableServices)return this.setServiceSelectorStatus("サービス情報を取得できませんでした（クライアント初期化待ちです）。右下の「再読み込み」で再取得できます。","error"),this.toggleServiceRetryButton(!0),void this.setServiceButtonsEnabled(!1);this.servicesLoading=!0,this.setServiceSelectorStatus("サービス情報を読み込んでいます...","info"),this.toggleServiceRetryButton(!1),this.setServiceButtonsEnabled(!1);try{"function"==typeof this.client.ensureInitialized&&await this.client.ensureInitialized();const e=await this.client.getAvailableServices();if(!e||!1===e.success||!e.metadata)throw new Error(e?.error||"サービス情報が取得できませんでした");this.availableImageServices=Array.isArray(e.metadata?.image)?e.metadata.image:[],this.availableVideoServices=Array.isArray(e.metadata?.video)?e.metadata.video:[],this.selectedImageService=this.resolveServiceSelection("image",this.availableImageServices,e.default?.image),this.selectedVideoService=this.resolveServiceSelection("video",this.availableVideoServices,e.default?.video),this.pendingImageService=this.selectedImageService,this.pendingVideoService=this.selectedVideoService,this.populateServiceSelector(),this.applyServiceSelectionToSceneManager(),this.setServiceButtonsEnabled(!0)}catch(e){console.error("❌ Failed to initialize service selector:",e),this.setServiceSelectorStatus("サービス情報を取得できませんでした。サーバーが起動しているか確認のうえ、再読み込みしてください。","error"),this.toggleServiceRetryButton(!0),this.setServiceButtonsEnabled(!1)}finally{this.servicesLoading=!1}}}setServiceSelectorStatus(e,t="info"){this.serviceSelectorStatus&&(this.serviceSelectorStatus.textContent=e,this.serviceSelectorStatus.dataset.statusType=t,this.serviceSelectorStatus.classList.toggle("service-selector-helper","error"!==t),this.updateServiceSelectorTheme())}toggleServiceRetryButton(e){this.serviceSelectorRetryButton&&(this.serviceSelectorRetryButton.style.display=e?"inline-flex":"none",this.updateServiceSelectorTheme())}resolveServiceSelection(e,t,n){if(!t||0===t.length)return null;const i="image"===e?l:c;let o=null;try{o=localStorage.getItem(i)}catch(e){console.warn("⚠️ Failed to access localStorage:",e)}let s=o&&t.some(e=>e.id===o)?o:null;!s&&n&&t.some(e=>e.id===n)&&(s=n),s||(s=t[0]?.id||null);try{s?localStorage.setItem(i,s):localStorage.removeItem(i)}catch(e){console.warn("⚠️ Failed to persist service selection:",e)}return s}populateServiceSelector(){if(!this.serviceSelectorContent)return;this.serviceSelectorContent.innerHTML="";const e=this.availableImageServices.length>0,t=this.availableVideoServices.length>0;if(e||t){if(this.setServiceSelectorStatus("利用するサービスを選択してください。","info"),e){const e=this.buildServiceRow("image","画像 (T2I)",this.availableImageServices,this.pendingImageService||this.selectedImageService);this.serviceSelectorContent.appendChild(e)}if(t){const e=this.buildServiceRow("video","動画 (T2V)",this.availableVideoServices,this.pendingVideoService||this.selectedVideoService);this.serviceSelectorContent.appendChild(e)}this.updateServiceSelectorTheme()}else this.setServiceSelectorStatus("利用可能なサービスが見つかりませんでした。","error")}buildServiceRow(e,t,n,i){const o=document.createElement("div");o.className=`service-row service-row-${e}`,o.style.cssText="\n      display: flex;\n      flex-direction: column;\n      gap: 6px;\n      margin-bottom: 12px;\n    ";const s=document.createElement("label");s.textContent=t,s.style.fontSize="13px",s.style.fontWeight="600",o.appendChild(s);const r=document.createElement("select");r.dataset.serviceType=e,r.style.fontFamily="inherit",r.style.width="100%",n.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name||e.id,e.description&&(t.title=e.description),r.appendChild(t)}),i&&n.some(e=>e.id===i)&&(r.value=i),r.addEventListener("change",t=>{this.onServiceSelectionChange(e,t.target.value)}),o.appendChild(r);const a=document.createElement("div");return a.className="service-description",a.textContent=this.findServiceInfo(e,r.value)?.description||"",a.style.fontSize="11px",a.style.opacity="0.75",a.style.lineHeight="1.4",a.style.minHeight="14px",o.appendChild(a),r.addEventListener("change",()=>{a.textContent=this.findServiceInfo(e,r.value)?.description||""}),"image"===e?this.imageServiceSelect=r:this.videoServiceSelect=r,o}onServiceSelectionChange(e,t){"image"===e?this.pendingImageService=t:this.pendingVideoService=t;const n=this.findServiceInfo(e,t),i="image"===e?this.imageServiceSelect?.parentElement?.querySelector(".service-description"):this.videoServiceSelect?.parentElement?.querySelector(".service-description");i&&(i.textContent=n?.description||"")}handleServiceSave(){const e=this.pendingImageService||this.selectedImageService,t=this.pendingVideoService||this.selectedVideoService;if(e){try{localStorage.setItem(l,e)}catch(e){console.warn("⚠️ Failed to persist image service selection:",e)}this.selectedImageService=e,this.sceneManager?.setImageService(e)}if(t){try{localStorage.setItem(c,t)}catch(e){console.warn("⚠️ Failed to persist video service selection:",e)}this.selectedVideoService=t,this.sceneManager?.setVideoService(t)}const n=this.findServiceInfo("image",e),i=this.findServiceInfo("video",t);n&&this.addOutput(`🖼️ 画像サービスを「${n.name}」に設定しました`,"system"),i&&this.addOutput(`🎬 動画サービスを「${i.name}」に設定しました`,"system"),this.closeServiceModal()}setServiceButtonsEnabled(e){this.serviceSelectorSaveButton&&(this.serviceSelectorSaveButton.disabled=!e,this.serviceSelectorSaveButton.style.opacity=e?"1":"0.6",this.serviceSelectorSaveButton.style.cursor=e?"pointer":"not-allowed")}resetPendingSelections(){this.pendingImageService=this.selectedImageService,this.pendingVideoService=this.selectedVideoService,this.imageServiceSelect&&this.selectedImageService&&(this.imageServiceSelect.value=this.selectedImageService),this.videoServiceSelect&&this.selectedVideoService&&(this.videoServiceSelect.value=this.selectedVideoService),this.serviceSelectorContent&&this.serviceSelectorContent.childElementCount>0&&this.populateServiceSelector()}findServiceInfo(e,t){return("image"===e?this.availableImageServices:this.availableVideoServices).find(e=>e.id===t)||null}applyServiceSelectionToSceneManager(){this.sceneManager&&(this.sceneManager.setImageService(this.selectedImageService),this.sceneManager.setVideoService(this.selectedVideoService))}updateServiceSelectorTheme(){if(this.serviceModalOverlay&&(this.serviceModalOverlay.style.background=this.isDarkMode?"rgba(8, 11, 26, 0.55)":"rgba(229, 231, 255, 0.45)"),this.serviceModal&&(this.serviceModal.style.background=this.isDarkMode?"rgba(17, 24, 39, 0.15)":"rgba(255, 255, 255, 0.15)",this.serviceModal.style.border=this.isDarkMode?"1px solid rgba(129, 140, 248, 0.4)":"1px solid rgba(99, 102, 241, 0.25)",this.serviceModal.style.color=this.isDarkMode?"#e5e7ff":"#1f2937"),this.serviceSelectorStatus){const e=this.serviceSelectorStatus.dataset?.statusType,t="error"===e?this.isDarkMode?"#fca5a5":"#b91c1c":this.isDarkMode?"rgba(209, 213, 219, 0.8)":"rgba(55, 65, 81, 0.75)";this.serviceSelectorStatus.style.color=t}if(this.serviceSelectorContainer){this.serviceSelectorContainer.querySelectorAll("label").forEach(e=>{e.style.color=this.isDarkMode?"rgba(255, 255, 255, 0.9)":"rgba(31, 41, 55, 0.9)"});this.serviceSelectorContainer.querySelectorAll("select").forEach(e=>{e.style.background=this.isDarkMode?"rgba(99, 102, 241, 0.18)":"rgba(99, 102, 241, 0.12)",e.style.border=this.isDarkMode?"1px solid rgba(129, 140, 248, 0.45)":"1px solid rgba(99, 102, 241, 0.45)",e.style.color=this.isDarkMode?"#ffffff":"#1f2937",e.style.padding="10px 12px",e.style.borderRadius="10px",e.style.fontSize="13px",e.style.outline="none",e.style.boxShadow=this.isDarkMode?"0 12px 28px rgba(15, 23, 42, 0.5)":"0 12px 24px rgba(99, 102, 241, 0.2)"});this.serviceSelectorContainer.querySelectorAll(".service-description").forEach(e=>{e.style.color=this.isDarkMode?"rgba(209, 213, 219, 0.8)":"rgba(55, 65, 81, 0.7)"})}this.serviceSelectorRetryButton&&(this.serviceSelectorRetryButton.style.background=this.isDarkMode?"rgba(129, 140, 248, 0.35)":"rgba(99, 102, 241, 0.15)",this.serviceSelectorRetryButton.style.border=this.isDarkMode?"1px solid rgba(129, 140, 248, 0.5)":"1px solid rgba(99, 102, 241, 0.45)",this.serviceSelectorRetryButton.style.color=this.isDarkMode?"#f9fafb":"#1e1b4b",this.serviceSelectorRetryButton.style.boxShadow=this.isDarkMode?"0 0 8px rgba(129, 140, 248, 0.45)":"0 0 8px rgba(99, 102, 241, 0.35)"),this.serviceSelectorCancelButton&&(this.serviceSelectorCancelButton.style.border=this.isDarkMode?"1px solid rgba(209, 213, 219, 0.3)":"1px solid rgba(148, 163, 184, 0.5)",this.serviceSelectorCancelButton.style.color=this.isDarkMode?"rgba(226, 232, 240, 0.85)":"rgba(30, 41, 59, 0.85)"),this.serviceSelectorSaveButton&&(this.serviceSelectorSaveButton.style.background=this.isDarkMode?"linear-gradient(135deg, #6366f1, #8b5cf6)":"linear-gradient(135deg, #818cf8, #a855f7)",this.serviceSelectorSaveButton.style.boxShadow=this.isDarkMode?"0 16px 28px rgba(99, 102, 241, 0.4)":"0 16px 28px rgba(129, 140, 248, 0.35)")}createRadioModeSelector(){const e=document.createElement("div");e.className="radio-mode-selector",e.style.cssText=`\n      display: grid;\n      grid-template-columns: repeat(4, 1fr);\n      gap: 8px;\n      margin-bottom: 12px;\n      padding: 12px;\n      background: ${this.isDarkMode?"linear-gradient(135deg, rgba(30, 27, 75, 0.3), rgba(15, 23, 42, 0.4))":"linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1))"};\n      border: 1px solid ${this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(255, 255, 255, 0.25)"};\n      border-radius: 16px;\n      backdrop-filter: blur(12px);\n      transition: all 0.3s ease;\n      position: relative;\n    `;return this.radioModeButtons={},[{value:"generate",label:"Generate",icon:"✨"},{value:"import",label:"Import",icon:"📥"},{value:"modify",label:"Modify",icon:"🔧"},{value:"delete",label:"Delete",icon:"🗑️"}].forEach(t=>{const n=document.createElement("div");n.className=`mode-option ${t.value}`,n.style.cssText=`\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 4px;\n        padding: 10px 8px;\n        border-radius: 12px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        font-size: 11px;\n        font-weight: 600;\n        text-align: center;\n        color: ${this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(55, 65, 81, 0.8)"};\n        background: transparent;\n        border: 1px solid transparent;\n        position: relative;\n      `;const i=document.createElement("div");i.textContent=t.icon,i.style.cssText=`\n        font-size: 16px;\n        margin-bottom: 2px;\n        filter: ${this.isDarkMode?"hue-rotate(220deg) saturate(0.8) brightness(1.2)":"hue-rotate(240deg) saturate(0.7) brightness(0.9)"};\n        transition: filter 0.2s ease;\n      `;const o=document.createElement("span");o.textContent=t.label;const s=document.createElement("div");s.className="auto-badge",s.textContent="AUTO",s.style.cssText="\n        position: absolute;\n        top: -4px;\n        right: -4px;\n        font-size: 7px;\n        font-weight: 700;\n        padding: 2px 4px;\n        background: linear-gradient(135deg, #10b981, #059669);\n        color: white;\n        border-radius: 6px;\n        opacity: 0;\n        transform: scale(0.8);\n        transition: all 0.2s ease;\n        display: none;\n      ",n.appendChild(i),n.appendChild(o),n.appendChild(s),n.addEventListener("click",()=>{"import"===t.value?this.triggerFileSelection():this.selectMode(t.value,!0)}),this.radioModeButtons[t.value]={button:n,autoBadge:s},e.appendChild(n)}),this.radioModeContainer=e,this.selectMode("generate",!1),e}selectMode(e,t=!1,n=null){this.currentMode=e,Object.keys(this.radioModeButtons).forEach(e=>{const{button:t,autoBadge:n}=this.radioModeButtons[e];t.style.color=this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(55, 65, 81, 0.8)",t.style.background="transparent",t.style.border="1px solid transparent",t.style.transform="scale(1)",t.style.boxShadow="none",n.style.display="none",n.style.opacity="0"});const{button:i,autoBadge:o}=this.radioModeButtons[e],s=this.isDarkMode?{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15))",border:"1px solid rgba(99, 102, 241, 0.4)",boxShadow:"0 4px 16px rgba(99, 102, 241, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1)",color:"#a5b4fc"}:{background:"linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.08))",border:"1px solid rgba(99, 102, 241, 0.3)",boxShadow:"0 4px 16px rgba(99, 102, 241, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2)",color:"#6366f1"};i.style.color=s.color,i.style.background=s.background,i.style.border=s.border,i.style.boxShadow=s.boxShadow,i.style.transform="scale(1.02)",!t&&n&&(o.style.display="inline-block",setTimeout(()=>{o.style.opacity="1",o.style.transform="scale(1)"},100),setTimeout(()=>{o.style.opacity="0",o.style.transform="scale(0.8)",setTimeout(()=>{o.style.display="none"},200)},3e3)),t||(this.addPulseEffect(i),this.addContainerGlow(e)),this.input.placeholder=this.getPlaceholderForMode(e),t&&this.clearInputOnModeSwitch(e),"import"===e||this.selectedFile?this.showImportInterface():this.hideImportInterface(),"delete"===e&&t&&this.handleDeleteModeSelection(),"modify"===e&&t&&this.handleModifyModeSelection()}addPulseEffect(e){e.style.animation="none",setTimeout(()=>{e.style.animation="smartModePulse 0.6s ease-out"},10),setTimeout(()=>{e.style.animation=""},610),this.ensurePulseAnimation()}ensurePulseAnimation(){if(document.getElementById("smart-mode-pulse-animation"))return;const e=document.createElement("style");e.id="smart-mode-pulse-animation",e.textContent="\n      @keyframes smartModePulse {\n        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }\n        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }\n        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }\n      }\n    ",document.head.appendChild(e)}addContainerGlow(e){const t=this.radioModeContainer;if(!t)return;const n={generate:"rgba(79, 70, 229, 0.4)",modify:"rgba(236, 72, 153, 0.4)",delete:"rgba(107, 114, 128, 0.3)"};t.style.boxShadow=`0 0 20px ${n[e]}, 0 0 40px ${n[e]}`,t.style.borderColor=n[e].replace("0.4","0.6").replace("0.3","0.5"),setTimeout(()=>{t.style.boxShadow="",t.style.borderColor=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.15)"},1e3)}getActionButtonStyles(e="secondary"){const t="\n      border: none;\n      border-radius: 10px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n      font-weight: 500;\n      backdrop-filter: blur(8px);\n      -webkit-backdrop-filter: blur(8px);\n    ";return"secondary"===e?t+`\n        width: 90px;\n        height: 36px;\n        padding: 8px 12px;\n        font-size: 12px;\n        font-weight: 600;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n        background: ${this.isDarkMode?"linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2))":"linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))"};\n        border: 1px solid ${this.isDarkMode?"rgba(156, 163, 175, 0.2)":"rgba(255, 255, 255, 0.3)"};\n        color: ${this.isDarkMode?"#d1d5db":"#374151"};\n        text-align: center;\n        white-space: nowrap;\n      `:"icon"===e?t+`\n        width: 32px;\n        height: 32px;\n        padding: 0;\n        font-size: 14px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: ${this.isDarkMode?"linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1))":"linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))"};\n        border: 1px solid ${this.isDarkMode?"rgba(99, 102, 241, 0.2)":"rgba(255, 255, 255, 0.4)"};\n        color: ${this.isDarkMode?"#a5b4fc":"#6366f1"};\n      `:void 0}getDestructiveButtonStyles(){return`\n      min-width: 50px;\n      height: 32px;\n      border: 1px solid ${this.isDarkMode?"rgba(220, 38, 127, 0.4)":"rgba(190, 24, 93, 0.35)"};\n      border-radius: 6px;\n      background: ${this.isDarkMode?"rgba(220, 38, 127, 0.3)":"rgba(190, 24, 93, 0.25)"};\n      color: ${this.isDarkMode?"#fca5a5":"#dc2626"};\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n      font-size: 11px;\n      font-weight: 500;\n      padding: 0 8px;\n      backdrop-filter: blur(10px);\n      -webkit-backdrop-filter: blur(10px);\n    `}getCommandTypeIndicatorStyles(){return`\n      padding: 4px 0;\n      margin-bottom: 8px;\n      font-size: 11px;\n      font-weight: 400;\n      text-align: left;\n      color: ${this.isDarkMode?"rgba(255, 255, 255, 0.6)":"rgba(0, 0, 0, 0.6)"};\n      transition: all 0.3s ease;\n      border: none;\n      background: none;\n    `}autoResizeTextarea(){this.input.style.height="auto";const e=Math.min(this.input.scrollHeight,72);this.input.style.height=e+"px",this.input.scrollHeight>72?(this.input.style.overflowY="auto",this.expandButton&&(this.expandButton.style.display="flex")):(this.input.style.overflowY="hidden",this.expandButton&&(this.expandButton.style.display="none"))}detectCommandType(){const e=this.input.value.trim();if(!e)return void this.selectMode("generate",!1);const t=this.analyzeCommandType(e);"delete"!==this.currentMode&&"modify"!==this.currentMode&&this.selectMode(t.type,!1,t.detectedKeyword)}analyzeCommandType(e){this.logDebug(`🔍 Analyzing command: "${e}"`);const t=this.detectMediaType(e),n=[{pattern:/削除/,keyword:"削除"},{pattern:/消去/,keyword:"消去"},{pattern:/消して/,keyword:"消して"},{pattern:/消す/,keyword:"消す"},{pattern:/取り除/,keyword:"取り除"},{pattern:/除去/,keyword:"除去"},{pattern:/削除して/,keyword:"削除して"},{pattern:/delete/i,keyword:"delete"},{pattern:/remove/i,keyword:"remove"},{pattern:/clear/i,keyword:"clear"},{pattern:/erase/i,keyword:"erase"}],i=[{pattern:/移動/,keyword:"移動"},{pattern:/動かして/,keyword:"動かして"},{pattern:/変更/,keyword:"変更"},{pattern:/変えて/,keyword:"変えて"},{pattern:/修正/,keyword:"修正"},{pattern:/調整/,keyword:"調整"},{pattern:/を.*に.*して/,keyword:"変更"},{pattern:/move/i,keyword:"move"},{pattern:/change/i,keyword:"change"},{pattern:/modify/i,keyword:"modify"},{pattern:/edit/i,keyword:"edit"}],o=[{pattern:/作って/,keyword:"作って"},{pattern:/生成/,keyword:"生成"},{pattern:/作成/,keyword:"作成"},{pattern:/描いて/,keyword:"描いて"},{pattern:/書いて/,keyword:"書いて"},{pattern:/create/i,keyword:"create"},{pattern:/generate/i,keyword:"generate"},{pattern:/make/i,keyword:"make"},{pattern:/draw/i,keyword:"draw"}];for(const{pattern:i,keyword:o}of n)if(i.test(e))return this.logDebug(`✅ Delete pattern matched: ${o}`),{type:"delete",confidence:.9,reason:"削除キーワードを検出",mediaType:t.type,requiresConfirmation:!0,detectedKeyword:o};for(const{pattern:n,keyword:o}of i)if(n.test(e))return this.logDebug(`✅ Modify pattern matched: ${o}`),{type:"modify",confidence:.8,reason:"変更キーワードを検出",mediaType:t.type,requiresConfirmation:!1,detectedKeyword:o};for(const{pattern:n,keyword:i}of o)if(n.test(e))return{type:"generate",confidence:t.confidence,reason:t.reason,mediaType:t.type,requiresConfirmation:!1,detectedKeyword:i};return this.logDebug("ℹ️ No specific pattern matched, defaulting to generate mode"),{type:"generate",confidence:t.confidence,reason:t.reason,mediaType:t.type,requiresConfirmation:!1,detectedKeyword:null}}detectMediaType(e){return[/動画|ビデオ|映像|ムービー/,/video|movie|clip/i].some(t=>t.test(e))?{type:"video",confidence:.8,reason:"動画生成コマンド"}:[/画像|写真|絵|イラスト|イメージ/,/image|picture|photo|illustration/i].some(t=>t.test(e))?{type:"image",confidence:.8,reason:"画像生成コマンド"}:{type:"image",confidence:.6,reason:"生成コマンド（画像デフォルト）"}}showCommandTypeIndicator(e){const{type:t,confidence:n,reason:i}=e;n<.7?this.showProactiveSuggestion(t,n):this.hideProactiveSuggestion(),this.enableGestureControl()}showProactiveSuggestion(e,t){this.proactiveSuggestion||(this.proactiveSuggestion=document.createElement("div"),this.proactiveSuggestion.id="proactive-suggestion",this.proactiveSuggestion.style.cssText="\n        margin-bottom: 8px;\n        padding: 10px;\n        background: rgba(255, 193, 7, 0.15);\n        border: 1px solid rgba(255, 193, 7, 0.3);\n        border-radius: 8px;\n        font-size: 12px;\n        color: #ffc107;\n        text-align: center;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      ",this.container.insertBefore(this.proactiveSuggestion,this.input));const n=["generate","modify","delete"].filter(t=>t!==e)[0];this.proactiveSuggestion.innerHTML=`\n      💡 もしかして「${{generate:"🎨 生成",modify:"✏️ 変更",delete:"🗑️ 削除"}[n]}モード」ですか？\n      <div style="margin-top: 4px; font-size: 10px; opacity: 0.8;">\n        クリックで変更 | スワイプで選択\n      </div>\n    `,this.proactiveSuggestion.style.display="block",this.proactiveSuggestion.onclick=()=>{this.currentMode=n,this.hideProactiveSuggestion(),this.updateIndicatorForMode(n,.9)}}hideProactiveSuggestion(){this.proactiveSuggestion&&(this.proactiveSuggestion.style.display="none")}updateIndicatorForMode(e,t){}enableGestureControl(){this.gestureEnabled=!0}createActionButtons(){const e=document.createElement("div");e.style.cssText="\n      display: flex;\n      margin-top: 12px;\n      gap: 8px;\n    ";const t=document.createElement("button");return t.innerHTML="🧹 全削除",t.style.cssText=this.getModernButtonStyles("danger"),t.addEventListener("click",()=>this.clearAll()),e.appendChild(t),e}getContainerStyles(){const e={"bottom-right":"bottom: 20px; right: 20px;","bottom-left":"bottom: 20px; left: 20px;","top-right":"top: 20px; right: 20px;","top-left":"top: 20px; left: 20px;",center:"top: 50%; left: 50%; transform: translate(-50%, -50%);"},t=this.isDarkMode?{background:"linear-gradient(135deg, rgba(15, 23, 42, 0.7), rgba(30, 27, 75, 0.65))",backdropFilter:"blur(24px) saturate(180%)",border:"1px solid rgba(99, 102, 241, 0.2)",boxShadow:"0 8px 32px rgba(15, 23, 42, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1)"}:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))",backdropFilter:"blur(24px) saturate(180%)",border:"1px solid rgba(255, 255, 255, 0.4)",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3)"};return`\n      position: fixed;\n      ${e[this.config.position]||e["bottom-right"]}\n      width: ${this.config.width}px;\n      max-height: ${this.config.maxHeight}px;\n      background: ${t.background};\n      border: ${t.border};\n      border-radius: 20px;\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;\n      font-size: 14px;\n      z-index: 1000;\n      padding: 20px;\n      box-shadow: ${t.boxShadow};\n      backdrop-filter: ${t.backdropFilter};\n      -webkit-backdrop-filter: ${t.backdropFilter};\n      display: none;\n      flex-direction: column;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    `}getHeaderStyles(){return"\n      margin-bottom: 20px;\n      text-align: center;\n      background: linear-gradient(135deg, #4f46e5, #7c3aed);\n      -webkit-background-clip: text;\n      -webkit-text-fill-color: transparent;\n      background-clip: text;\n      font-weight: 800;\n      font-size: 18px;\n      border-bottom: 1px solid rgba(79, 70, 229, 0.2);\n      padding-bottom: 12px;\n    "}getOutputStyles(){return this.addScrollbarStyles(),`\n      height: 200px;\n      overflow-y: auto;\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.05)":"rgba(255, 255, 255, 0.1)"};\n      border: 1px solid ${this.isDarkMode?"rgba(255, 255, 255, 0.15)":"rgba(255, 255, 255, 0.2)"};\n      border-radius: 12px;\n      padding: 12px;\n      margin-bottom: 16px;\n      font-size: 12px;\n      line-height: 1.4;\n      backdrop-filter: blur(8px);\n\n      /* カスタムスクロールバーのスタイル */\n      scrollbar-width: thin;\n      scrollbar-color: ${this.isDarkMode?"rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.3) rgba(0, 0, 0, 0.1)"};\n    `}addScrollbarStyles(){if(document.getElementById("custom-scrollbar-styles"))return;const e=document.createElement("style");e.id="custom-scrollbar-styles",e.textContent=`\n      .command-output::-webkit-scrollbar {\n        width: 8px;\n      }\n\n      .command-output::-webkit-scrollbar-track {\n        background: ${this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"};\n        border-radius: 4px;\n      }\n\n      .command-output::-webkit-scrollbar-thumb {\n        background: ${this.isDarkMode?"rgba(255, 255, 255, 0.3)":"rgba(0, 0, 0, 0.3)"};\n        border-radius: 4px;\n        transition: background 0.2s ease;\n      }\n\n      .command-output::-webkit-scrollbar-thumb:hover {\n        background: ${this.isDarkMode?"rgba(255, 255, 255, 0.5)":"rgba(0, 0, 0, 0.5)"};\n      }\n\n      /* ダークモード用 */\n      .dark-mode .command-output::-webkit-scrollbar-track {\n        background: rgba(255, 255, 255, 0.1);\n      }\n\n      .dark-mode .command-output::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      .dark-mode .command-output::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.5);\n      }\n\n      /* ライトモード用 */\n      .light-mode .command-output::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.1);\n      }\n\n      .light-mode .command-output::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      .light-mode .command-output::-webkit-scrollbar-thumb:hover {\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      @keyframes shimmer {\n        0% { background-position: -200% 0; }\n        100% { background-position: 200% 0; }\n      }\n\n      /* タスクステータスコンテナのホバー効果 */\n      .task-status-container:hover .progress-bar {\n        box-shadow: 0 0 20px rgba(255,123,71,0.6) !important;\n        transform: scaleY(1.1);\n      }\n\n      /* プログレスバーの微細なアニメーション */\n      .progress-bar {\n        position: relative;\n      }\n\n      .progress-bar::after {\n        content: '';\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: linear-gradient(90deg, \n          transparent, \n          rgba(255,255,255,0.4), \n          transparent);\n        animation: progress-shine 2s ease-in-out infinite;\n      }\n\n      @keyframes progress-shine {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(100%); }\n      }\n    `,document.head.appendChild(e)}getInputStyles(){const e=this.isDarkMode?{background:"linear-gradient(135deg, rgba(30, 27, 75, 0.4), rgba(15, 23, 42, 0.5))",border:"1px solid rgba(99, 102, 241, 0.25)",boxShadow:"0 4px 16px rgba(15, 23, 42, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08)"}:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2))",border:"1px solid rgba(255, 255, 255, 0.5)",boxShadow:"0 4px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.4)"};return`\n      width: 100%;\n      padding: 14px 16px;\n      background: ${e.background};\n      border: ${e.border};\n      border-radius: 14px;\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n      font-size: 14px;\n      outline: none;\n      box-sizing: border-box;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      font-family: inherit;\n      backdrop-filter: blur(16px);\n      -webkit-backdrop-filter: blur(16px);\n      box-shadow: ${e.boxShadow};\n      placeholder-color: ${this.isDarkMode?"rgba(255, 255, 255, 0.5)":"rgba(55, 65, 81, 0.6)"};\n      resize: none;\n      overflow-y: hidden;\n      min-height: 22px;\n      max-height: 66px;\n      line-height: 22px;\n    `}getModernButtonStyles(e){return`\n      border: none;\n      border-radius: 12px;\n      color: white;\n      cursor: pointer;\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      font-family: inherit;\n      outline: none;\n      ${{primary:"\n        background: linear-gradient(135deg, #4f46e5, #4338ca);\n        width: 100%;\n        padding: 16px;\n        font-size: 14px;\n        font-weight: 600;\n      ",secondary:"\n        background: rgba(255, 255, 255, 0.08);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n      ",danger:"\n        background: rgba(255, 59, 48, 0.15);\n        border: 1px solid rgba(255, 59, 48, 0.3);\n        flex: 1;\n        padding: 12px;\n        font-size: 13px;\n        font-weight: 500;\n        backdrop-filter: blur(8px);\n        color: #ff453a;\n      "}[e]}\n    `}getModeButtonStyles(e,t){return`\n      flex: 1;\n      padding: 12px 16px;\n      border: none;\n      border-radius: 8px;\n      color: ${e?"white":"rgba(255, 255, 255, 0.7)"};\n      background: ${e?{generate:"linear-gradient(135deg, #4f46e5, #4338ca)",modify:"linear-gradient(135deg, #ec4899, #be185d)",delete:"rgba(107, 114, 128, 0.15)"}[t]:"transparent"};\n      font-size: 13px;\n      font-weight: 600;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      font-family: inherit;\n      outline: none;\n    `}bindEvents(){document.addEventListener("keydown",e=>{if(e.key===this.config.activationKey)return e.preventDefault(),void this.toggle();this.isVisible&&"Escape"===e.key&&this.hide(),this.isVisible&&e.ctrlKey&&("z"!==e.key||e.shiftKey?("y"===e.key||"z"===e.key&&e.shiftKey)&&(e.preventDefault(),this.redo()):(e.preventDefault(),this.undo()))}),this.input.addEventListener("focus",()=>{this.input.style.borderColor="#74b9ff",this.input.style.boxShadow="0 0 5px rgba(116, 185, 255, 0.5)"}),this.input.addEventListener("blur",()=>{this.input.style.borderColor="#4a90e2",this.input.style.boxShadow="none"})}toggle(){this.isVisible?this.hide():this.show()}show(){this.container.style.display="flex",this.container.style.flexDirection="column",this.floatingContainer.style.display="flex",setTimeout(()=>{const e=this.container.getBoundingClientRect();this.floatingContainer.style.left=e.left+"px",this.floatingContainer.style.top=e.top-80+"px",this.floatingContainer.style.width=e.width+"px",this.floatingContainer.style.transform="none"},50),this.isVisible=!0,this.input.focus(),this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.opacity="0",this.floatingChocolateIcon.style.pointerEvents="none"),this.onControlsToggle(!0)}hide(){this.container.style.display="none",this.floatingContainer.style.display="none",this.isVisible=!1,this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.opacity="0.8",this.floatingChocolateIcon.style.pointerEvents="auto"),this.onControlsToggle(!1),this.logDebug("🎮 コントロールを再開")}switchMode(e){if(this.currentMode===e)return;this.currentMode=e,this.container.querySelectorAll("[data-mode]").forEach(t=>{const n=t.dataset.mode===e;t.style.cssText=this.getModeButtonStyles(n,t.dataset.mode)}),this.input.placeholder=this.getPlaceholderForMode(e);const t=this.container.querySelector("#execute-btn");t.innerHTML=`<span>${{generate:"🎨 Generate Object",modify:"✏️ Apply Changes",delete:"🗑️ Delete Objects"}[e]}</span>`,t.style.background={generate:"linear-gradient(135deg, #4f46e5, #4338ca)",modify:"linear-gradient(135deg, #ec4899, #be185d)",delete:"rgba(107, 114, 128, 0.15)"}[e]}getPlaceholderForMode(e){const t={generate:"「右上にドラゴンを」と話しかけて ⏎ ✨",import:"ファイル読み込み完了！配置場所を指定 ⏎ 📁",modify:"選択後「ピンク色に」「大きくして」と伝えて ⏎ ✏️",delete:"選択後、削除コマンドが表示されます ⏎ 🗑️"};return t[e]||t.generate}async executeCommand(){const e=this.input.value.trim();if(!e)return;const t=this.analyzeCommandType(e);if(this.selectedFile?("import"!==this.currentMode&&this.selectMode("import",!1),this.currentMode="import"):this.currentMode=t.type,t.requiresConfirmation){if(!await this.showDeleteConfirmation(e))return void this.addOutput("❌ 削除をキャンセルしました","system")}this.input.value="",this.hideProactiveSuggestion(),t.mediaType;const n=this.addTaskCard(e,{status:"processing"});this.saveCommandToHistory({command:e,mode:this.currentMode,mediaType:t.mediaType,timestamp:Date.now()});try{let i;const o=`${this.getModePrefix(this.currentMode)}${e}`;if(this.logDebug("🔍 Current mode check:",this.currentMode),"import"===this.currentMode){if(this.logDebug("📁 Import mode detected - bypassing SceneManager"),!this.selectedFile)throw new Error("ファイルが選択されていません。まずファイルを選択してください。");i=await this.handleImportCommand(e)}else if(this.sceneManager)i=await this.sceneManager.executeCommand(o);else{if(!this.client)throw new Error("SceneManager または Client が設定されていません");if("generate"===this.currentMode)i="video"===t.mediaType?await this.client.generateVideo(e,{model:this.selectedVideoService||void 0}):await this.client.generateImage(e,{service:this.selectedImageService||void 0});else if("modify"===this.currentMode){if(!this.selectedObject)throw new Error("変更するオブジェクトが選択されていません。まず対象オブジェクトを選択してください。");i=await this.client.modifySelectedObject(this.selectedObject,e)}else if("delete"===this.currentMode){if(!this.selectedObject&&!this.sceneManager?.getSelectedObjects()?.length)return void this.addOutput("⚠️ 削除するオブジェクトが選択されていません。まず3Dシーン内のオブジェクトをクリックで選択してから、再度Deleteボタンを押してください。","system");const t=`本当に「${e}」を実行しますか？\n\nこの操作は取り消せません。`;if(!confirm(t))return void this.addOutput("❌ 削除がキャンセルされました","system");i=await this.client.deleteObjects(e)}else i=await this.client.executeCommand(o)}i&&i.taskId&&(this.connectToProgress(i.taskId,n),this.currentTaskId=i.taskId);n&&this.updateTaskCard(n,"completed"),i.modelName,i.objectId,i.position,t.mediaType}catch(e){const i={generate:`❌ ${"video"===t.mediaType?"動画":"画像"}生成エラー`,modify:"❌ 変更エラー",delete:"❌ 削除エラー"};n&&this.updateTaskCard(n,"error"),this.addOutput(`${i[this.currentMode]}: ${e.message}`,"error"),console.error("Command execution error:",e)}this.sceneManager&&this.sceneManager.selectedObject&&("modify"!==this.currentMode&&"delete"!==this.currentMode||setTimeout(()=>{this.sceneManager.deselectObject()},500)),this.config.autoScroll&&this.scrollToBottom()}async showConfirmationDialog(e){const{icon:t="🗑️",title:n="確認",message:i="この操作を実行しますか？",confirmText:o="実行",cancelText:s="キャンセル",confirmColor:r="#ef4444"}=e;return new Promise(e=>{const a=document.createElement("div");a.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(15, 23, 42, 0.6);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        z-index: 2000;\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n      ";const l=document.createElement("div");l.style.cssText=`\n        background: ${this.isDarkMode?"linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(30, 27, 75, 0.8))":"linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3))"};\n        border: 1px solid ${this.isDarkMode?"rgba(99, 102, 241, 0.3)":"rgba(255, 255, 255, 0.5)"};\n        border-radius: 20px;\n        padding: 32px;\n        max-width: 420px;\n        text-align: center;\n        color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n        font-family: inherit;\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n        box-shadow: ${this.isDarkMode?"0 8px 32px rgba(15, 23, 42, 0.4), 0 0 0 1px rgba(99, 102, 241, 0.1)":"0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2)"};\n        transform: scale(0.9);\n        opacity: 0;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      `,l.innerHTML=`\n        <div style="font-size: 56px; margin-bottom: 20px;">${t}</div>\n        <h3 style="margin: 0 0 16px 0; color: ${this.isDarkMode?"#a5b4fc":"#6366f1"}; font-size: 20px; font-weight: 700; letter-spacing: 0.02em;">\n          ${n}\n        </h3>\n        <p style="margin: 0 0 28px 0; color: ${this.isDarkMode?"#d1d5db":"#6b7280"}; line-height: 1.6; font-size: 16px;">\n          ${i}\n        </p>\n        <div style="display: flex; gap: 12px; justify-content: center;">\n          <button id="cancel-btn" style="\n            padding: 14px 24px;\n            background: ${this.isDarkMode?"linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2))":"linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15))"};\n            border: 1px solid ${this.isDarkMode?"rgba(156, 163, 175, 0.2)":"rgba(255, 255, 255, 0.3)"};\n            border-radius: 12px;\n            color: ${this.isDarkMode?"#d1d5db":"#374151"};\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 600;\n            transition: all 0.2s ease;\n            backdrop-filter: blur(16px);\n            -webkit-backdrop-filter: blur(16px);\n          ">${s}</button>\n          <button id="confirm-btn" style="\n            padding: 14px 24px;\n            background: ${"#6366f1"===r?"linear-gradient(135deg, #6366f1, #8b5cf6)":"#ef4444"===r?"linear-gradient(135deg, #ef4444, #dc2626)":"linear-gradient(135deg, #ff7b47, #f97316)"};\n            border: none;\n            border-radius: 12px;\n            color: white;\n            cursor: pointer;\n            font-family: inherit;\n            font-size: 14px;\n            font-weight: 700;\n            transition: all 0.2s ease;\n            box-shadow: 0 4px 16px ${"#6366f1"===r?"rgba(99, 102, 241, 0.3)":"#ef4444"===r?"rgba(239, 68, 68, 0.3)":"rgba(255, 123, 71, 0.3)"};\n            backdrop-filter: blur(8px);\n            -webkit-backdrop-filter: blur(8px);\n          ">${o}</button>\n        </div>\n      `,a.appendChild(l),document.body.appendChild(a),requestAnimationFrame(()=>{a.style.opacity="1",l.style.transform="scale(1)",l.style.opacity="1"}),l.querySelector("#cancel-btn").onclick=()=>{this.closeModalWithAnimation(a),e(!1)},l.querySelector("#confirm-btn").onclick=()=>{this.closeModalWithAnimation(a),e(!0)};const c=t=>{"Escape"===t.key&&(this.closeModalWithAnimation(a),document.removeEventListener("keydown",c),e(!1))};document.addEventListener("keydown",c),a.onclick=t=>{t.target===a&&(this.closeModalWithAnimation(a),e(!1))}})}async showDeleteConfirmation(e){return this.showConfirmationDialog({icon:"🗑️",title:"削除の確認",message:`「${e}」を実行しますか？<br>この操作は取り消すことができません。`,confirmText:"削除実行",cancelText:"キャンセル",confirmColor:"#ff7b47"})}addOutput(e,t="default",n={}){if("task"===t||"progress"===t)return this.addTaskCard(e,n);"error"!==t&&"system"!==t||this.addSystemMessage(e,t)}addTaskCard(e,t={}){this.taskCards||(this.taskCards=new Map);const n=t.taskId||`task_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,i=t.status||"pending",o=e.prompt||e.command||e,s=document.createElement("div");s.className="floating-task-card",s.setAttribute("data-task-id",n),s.style.cssText=this.getFloatingCardStyles(i),s.style.setProperty("opacity","0","important"),s.style.setProperty("transform","translateY(20px) scale(0.95)","important"),s.style.setProperty("filter","blur(4px)","important");const r=this.getFriendlyMessage(i,o);return s.innerHTML=`\n      <span style="font-size: 14px;">${{pending:"⏳",processing:"🎨",progress:"⚡",completed:"✅",error:"❌"}[i]}</span>\n      <span style="font-size: 13px; margin-left: 6px;">${r}</span>\n    `,this.floatingContainer.appendChild(s),this.updateCardDisplayLimit(),this.taskCards.set(n,{element:s,status:i,prompt:o,originalPrompt:o,startTime:Date.now(),endTime:null,error:null,contentType:"image",model:null,settings:null}),this.addCardDetailEvents(s,n),this.animateCardEntrance(s),n}updateTaskCard(e,t,n={}){if(!this.taskCards||!this.taskCards.has(e))return;const i=this.taskCards.get(e),o=i.element;i.status=t;const s=this.getFriendlyMessage(t,i.prompt);o.innerHTML=`\n      <span style="font-size: 14px;">${{pending:"⏳",processing:"🎨",progress:"⚡",completed:"✅",error:"❌"}[t]}</span>\n      <span style="font-size: 13px; margin-left: 6px;">${s}</span>\n    `,"completed"===t?this.animateCardSuccess(o,e):"error"===t&&this.animateCardError(o,e)}addSystemMessage(e,t){const n=document.createElement("div");n.className=`system-message ${t}`,n.style.cssText=`\n      padding: 8px 12px;\n      margin: 4px 0;\n      border-radius: 8px;\n      font-size: 12px;\n      line-height: 1.4;\n      animation: slideIn 0.3s ease-out;\n      background: ${"error"===t?"rgba(239, 68, 68, 0.1)":"rgba(107, 114, 128, 0.1)"};\n      border: 1px solid ${"error"===t?"rgba(239, 68, 68, 0.3)":"rgba(107, 114, 128, 0.3)"};\n      color: ${"error"===t?"#fca5a5":this.isDarkMode?"#d1d5db":"#6b7280"};\n    `,n.textContent=e,this.outputDiv.appendChild(n),this.scrollToBottom()}getTaskCardStyles(e){const t={pending:"rgba(167, 139, 250, 0.3)",processing:"rgba(192, 132, 252, 0.5)",progress:"rgba(236, 72, 153, 0.4)",completed:"rgba(167, 139, 250, 0.4)",error:"rgba(239, 68, 68, 0.4)"};return`\n      background: ${this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(255, 255, 255, 0.15)"};\n      border: 1px solid ${this.isDarkMode?"rgba(255, 255, 255, 0.15)":"rgba(255, 255, 255, 0.25)"};\n      border-radius: 12px;\n      padding: 16px;\n      margin-bottom: 12px;\n      backdrop-filter: blur(12px);\n      transition: all 0.3s ease;\n      animation: slideInUp 0.3s ease-out;\n    `+`border-left: 3px solid ${t[e]||t.pending};`}getFloatingCardStyles(e){const t=this.isDarkMode?{background:"linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 27, 75, 0.7))",border:"1px solid rgba(99, 102, 241, 0.25)",boxShadow:"0 8px 32px rgba(15, 23, 42, 0.3), 0 0 0 1px rgba(99, 102, 241, 0.1)",color:"#ffffff"}:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25))",border:"1px solid rgba(255, 255, 255, 0.4)",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.2)",color:"#1f2937"};return`\n      height: 36px;\n      padding: 0 18px;\n      display: inline-flex;\n      align-items: center;\n      gap: 10px;\n      background: ${t.background};\n      backdrop-filter: blur(24px) saturate(180%);\n      -webkit-backdrop-filter: blur(24px) saturate(180%);\n      border: ${t.border};\n      border-radius: 18px;\n      color: ${t.color};\n      pointer-events: auto;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;\n      font-weight: 600;\n      font-size: 13px;\n      letter-spacing: 0.01em;\n      box-shadow: ${t.boxShadow};\n      transform: translateY(10px);\n      opacity: 0;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    `}updateCardDisplayLimit(){const e=Array.from(this.floatingContainer.children).filter(e=>!e.classList.contains("overflow-counter")),t=this.floatingContainer.querySelector(".overflow-counter");if(t&&t.remove(),e.length<=3)e.forEach(e=>{e.style.display="flex"});else{e.slice(-3);const t=e.length-3;e.forEach((t,n)=>{n<e.length-3?t.style.display="none":t.style.display="flex"});const n=document.createElement("div");n.className="overflow-counter";const i=this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.12)",o=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.15)",s=this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(0, 0, 0, 0.6)";n.style.cssText=`\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 8px 12px;\n        margin: 4px 0;\n        background: ${i};\n        backdrop-filter: blur(20px);\n        border-radius: 12px;\n        border: 1px solid ${o};\n        font-size: 12px;\n        color: ${s};\n        font-weight: 500;\n        min-height: 32px;\n        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n        cursor: pointer;\n      `,n.innerHTML=`+ ${t}`,this.floatingContainer.insertBefore(n,this.floatingContainer.firstChild);const r=this.isDarkMode?"rgba(255, 255, 255, 0.12)":"rgba(0, 0, 0, 0.18)";n.addEventListener("mouseenter",()=>{n.style.background=r,n.style.transform="scale(1.05)"}),n.addEventListener("mouseleave",()=>{n.style.background=i,n.style.transform="scale(1)"})}}addCardDetailEvents(e,t){if("ontouchstart"in window||navigator.maxTouchPoints>0)e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showTaskDetailModal(t)});else{let n;e.addEventListener("mouseenter",()=>{n=setTimeout(()=>{this.showTaskDetailModal(t)},800)}),e.addEventListener("mouseleave",()=>{n&&clearTimeout(n)}),e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showTaskDetailModal(t)})}}showTaskDetailModal(e){const t=this.taskCards.get(e);if(!t)return;const n=document.querySelector(".task-detail-modal");n&&n.remove();const i=this.createTaskDetailModal(t);document.body.appendChild(i),requestAnimationFrame(()=>{i.style.opacity="1",i.querySelector(".modal-content").style.transform="translateY(0) scale(1)"})}createTaskDetailModal(e){const t=document.createElement("div");t.className="task-detail-modal";const n=this.isDarkMode?"rgba(0, 0, 0, 0.6)":"rgba(0, 0, 0, 0.4)",i=this.isDarkMode?"rgba(20, 20, 20, 0.95)":"rgba(255, 255, 255, 0.95)",o=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",s=this.isDarkMode?"rgba(255, 255, 255, 0.9)":"rgba(0, 0, 0, 0.9)",r=this.isDarkMode?"rgba(255, 255, 255, 0.6)":"rgba(0, 0, 0, 0.6)";t.style.cssText=`\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: ${n};\n      backdrop-filter: blur(10px);\n      z-index: 100000;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      opacity: 0;\n      transition: opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: pointer;\n    `;const a=e.endTime?((e.endTime-e.startTime)/1e3).toFixed(1):((Date.now()-e.startTime)/1e3).toFixed(1),l="pending"===e.status?"待機中":"in-progress"===e.status?"実行中":"completed"===e.status?"完了":"エラー",c=document.createElement("div");c.className="modal-content",c.style.cssText=`\n      background: ${i};\n      backdrop-filter: blur(30px);\n      border: 1px solid ${o};\n      border-radius: 16px;\n      padding: 24px;\n      max-width: 400px;\n      width: 90%;\n      max-height: 80vh;\n      overflow-y: auto;\n      transform: translateY(20px) scale(0.95);\n      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: default;\n      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n    `,c.innerHTML=`\n      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">\n        <h3 style="margin: 0; color: ${s}; font-size: 18px; font-weight: 600;">タスク詳細</h3>\n        <button class="close-btn" style="\n          background: none;\n          border: none;\n          font-size: 24px;\n          color: ${r};\n          cursor: pointer;\n          padding: 0;\n          line-height: 1;\n          transition: color 0.2s;\n        ">×</button>\n      </div>\n      \n      <div style="space-y: 16px;">\n        <div>\n          <div style="color: ${r}; font-size: 12px; font-weight: 500; margin-bottom: 4px;">📝 元のプロンプト</div>\n          <div style="color: ${s}; font-size: 14px; line-height: 1.4;">${e.originalPrompt}</div>\n        </div>\n        \n        <div>\n          <div style="color: ${r}; font-size: 12px; font-weight: 500; margin-bottom: 4px;">📊 ステータス</div>\n          <div style="color: ${s}; font-size: 14px;">${l}</div>\n        </div>\n        \n        <div>\n          <div style="color: ${r}; font-size: 12px; font-weight: 500; margin-bottom: 4px;">⏱️ 実行時間</div>\n          <div style="color: ${s}; font-size: 14px;">${a}秒</div>\n        </div>\n        \n        ${e.error?`\n        <div>\n          <div style="color: ${r}; font-size: 12px; font-weight: 500; margin-bottom: 4px;">❌ エラー詳細</div>\n          <div style="color: #ef4444; font-size: 14px; line-height: 1.4;">${e.error}</div>\n        </div>\n        `:""}\n        \n        <div>\n          <div style="color: ${r}; font-size: 12px; font-weight: 500; margin-bottom: 4px;">🎨 コンテンツタイプ</div>\n          <div style="color: ${s}; font-size: 14px;">${e.contentType||"画像"}</div>\n        </div>\n      </div>\n    `,c.addEventListener("click",e=>{e.stopPropagation()});const d=c.querySelector(".close-btn");return d.addEventListener("click",()=>{this.closeTaskDetailModal(t)}),d.addEventListener("mouseenter",()=>{d.style.color=s}),d.addEventListener("mouseleave",()=>{d.style.color=r}),t.addEventListener("click",()=>{this.closeTaskDetailModal(t)}),t.appendChild(c),t}closeTaskDetailModal(e){e.style.opacity="0",e.querySelector(".modal-content").style.transform="translateY(20px) scale(0.95)",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}animateCardEntrance(e){e.style.transform="translateY(20px) scale(0.95)",e.style.opacity="0",e.style.filter="blur(4px)",requestAnimationFrame(()=>{e.style.transition="all 0.6s cubic-bezier(0.16, 1, 0.3, 1)",e.style.transform="translateY(0) scale(1)",e.style.opacity="1",e.style.filter="blur(0px)",e.style.boxShadow="0 4px 20px rgba(255, 255, 255, 0.1), 0 0 40px rgba(255, 255, 255, 0.05)"})}animateCardSuccess(e,t){e.style.transition="all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",e.style.borderColor="rgba(76, 175, 80, 0.6)",e.style.transform="scale(1.08)",e.style.boxShadow="0 8px 32px rgba(76, 175, 80, 0.4), 0 0 60px rgba(76, 175, 80, 0.2)",e.style.filter="brightness(1.1) saturate(1.2)",setTimeout(()=>{e.style.transform="scale(1.02)",e.style.filter="brightness(1.05) saturate(1.1)"},150),setTimeout(()=>{this.animateCardExit(e,t)},2e3)}animateCardError(e,t){e.style.transition="all 0.3s cubic-bezier(0.16, 1, 0.3, 1)",e.style.borderColor="rgba(244, 67, 54, 0.7)",e.style.boxShadow="0 8px 32px rgba(244, 67, 54, 0.3), 0 0 60px rgba(244, 67, 54, 0.15)",e.style.filter="saturate(1.3) brightness(1.1)",e.style.animation="errorPulse 0.6s cubic-bezier(0.16, 1, 0.3, 1) 2",this.addErrorTooltip(e,t),e.style.cursor="pointer",e.onclick=()=>this.animateCardExit(e,t),setTimeout(()=>{this.taskCards.has(t)&&this.animateCardExit(e,t)},5e3)}addErrorTooltip(e,t){const n=this.taskCards.get(t);if(!n||!n.error)return;const i=document.createElement("div");i.style.cssText="\n      position: absolute;\n      bottom: 100%;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(244, 67, 54, 0.95);\n      color: white;\n      padding: 8px 12px;\n      border-radius: 8px;\n      font-size: 11px;\n      white-space: nowrap;\n      pointer-events: none;\n      z-index: 1001;\n      backdrop-filter: blur(10px);\n      margin-bottom: 4px;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n    ",i.textContent=n.error,e.style.position="relative",e.appendChild(i),requestAnimationFrame(()=>{i.style.opacity="1"}),setTimeout(()=>{i.parentNode&&(i.style.opacity="0",setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300))},3e3)}animateCardExit(e,t){e.style.transition="all 0.28s cubic-bezier(0.4, 0, 0.2, 1)",e.style.transform="translateY(-12px) scale(0.92)",e.style.opacity="0",e.style.filter="blur(6px) brightness(1.2)",e.style.boxShadow="0 0 40px rgba(255, 255, 255, 0.3), 0 0 80px rgba(255, 255, 255, 0.1)",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e),this.taskCards.delete(t),this.updateCardDisplayLimit()},280)}getResponseType(e){return/ちょこっと|ちょこん|少し|軽く/.test(e)||e.length<15?"casual":/美しい|幻想|素敵|魔法|世界|綺麗/.test(e)?"magical":"balanced"}getFriendlyMessage(e,t){const n=t.length>15?t.substring(0,15)+"...":t,i=this.getResponseType(t);switch(e){case"pending":return"casual"===i?"ちょこっと準備中です...":"magical"===i?"魔法をかけようとしています...":"ちょこっと魔法の準備中...";case"processing":case"in-progress":case"progress":return"casual"===i?"ちょこんと配置中です...":"magical"===i?"あなたの想いを形にしています...":"ちょこっと魔法をかけています...";case"completed":return"casual"===i?"ちょこっとドロップしました！":"magical"===i?"素敵な世界が完成しました！":"ちょこんと配置完了！素敵ですね！";case"error":return"casual"===i?"ちょこっと失敗... もう一度どうぞ":"うまくいかなかったようです... もう一度試してみませんか？";default:return n}}getStatusColor(e){const t={pending:this.isDarkMode?"#a78bfa":"#7c3aed",processing:this.isDarkMode?"#c084fc":"#9333ea",progress:this.isDarkMode?"#ec4899":"#be185d",completed:this.isDarkMode?"#a78bfa":"#7c3aed",error:this.isDarkMode?"#f87171":"#dc2626"};return t[e]||t.pending}createStatusIndicator(e){return"processing"===e||"progress"===e?`\n        <div class="status-indicator" style="\n          background: ${this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.08)"};\n          border-radius: 8px;\n          height: 4px;\n          overflow: hidden;\n          margin-top: 8px;\n          position: relative;\n        ">\n          <div class="status-pulse" style="\n            background: linear-gradient(90deg, transparent, #6366f1, #8b5cf6, transparent);\n            height: 100%;\n            width: 30%;\n            border-radius: 8px;\n            animation: statusPulse 1.8s ease-in-out infinite;\n          "></div>\n        </div>\n        <div style="display: flex; align-items: center; gap: 4px; margin-top: 6px;">\n          <div class="status-dots" style="font-size: 10px; color: ${this.isDarkMode?"#c084fc":"#9333ea"};">\n            処理中<span style="animation: dots 1.5s infinite;">...</span>\n          </div>\n        </div>\n      `:""}animateTaskCompletion(e){e.style.animation="taskComplete 0.8s ease-out",this.addSubtleParticleEffect(e),setTimeout(()=>{e.style.animation=""},800),this.ensureTaskAnimations()}addSubtleParticleEffect(e){const t=e.getBoundingClientRect();for(let e=0;e<3;e++){const n=document.createElement("div");n.style.cssText=`\n        position: fixed;\n        width: 4px;\n        height: 4px;\n        background: linear-gradient(45deg, #a78bfa, #c084fc);\n        border-radius: 50%;\n        pointer-events: none;\n        z-index: 9999;\n        left: ${t.right-20}px;\n        top: ${t.top+10}px;\n        opacity: 0.8;\n        transform: scale(0);\n        animation: subtleParticle 1.2s ease-out forwards;\n      `;const i=e/3*Math.PI*2,o=15;n.style.setProperty("--move-x",Math.cos(i)*o+"px"),n.style.setProperty("--move-y",Math.sin(i)*o+"px"),document.body.appendChild(n),setTimeout(()=>n.remove(),1200)}}ensureTaskAnimations(){if(document.getElementById("task-animations"))return;const e=document.createElement("style");e.id="task-animations",e.textContent="\n      @keyframes slideInUp {\n        from { opacity: 0; transform: translateY(20px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n\n      @keyframes taskComplete {\n        0% {\n          transform: scale(1);\n          border-left-color: rgba(192, 132, 252, 0.5);\n        }\n        30% {\n          transform: scale(1.01);\n          background: rgba(167, 139, 250, 0.08);\n          border-left-color: rgba(167, 139, 250, 0.6);\n        }\n        60% {\n          background: rgba(167, 139, 250, 0.05);\n        }\n        100% {\n          transform: scale(1);\n          background: rgba(167, 139, 250, 0.02);\n          border-left-color: rgba(167, 139, 250, 0.4);\n        }\n      }\n\n      @keyframes subtleParticle {\n        0% {\n          transform: scale(0) translate(0, 0);\n          opacity: 0.8;\n        }\n        20% {\n          transform: scale(1) translate(0, 0);\n          opacity: 1;\n        }\n        100% {\n          transform: scale(0.3) translate(var(--move-x, 0), var(--move-y, 0));\n          opacity: 0;\n        }\n      }\n\n      @keyframes shimmer {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(100%); }\n      }\n\n      @keyframes slideIn {\n        from { opacity: 0; transform: translateX(-20px); }\n        to { opacity: 1; transform: translateX(0); }\n      }\n\n      @keyframes statusPulse {\n        0% { transform: translateX(-100%); }\n        50% { transform: translateX(300%); }\n        100% { transform: translateX(-100%); }\n      }\n\n      @keyframes dots {\n        0%, 20% { opacity: 0; }\n        50% { opacity: 1; }\n        100% { opacity: 0; }\n      }\n\n      @keyframes errorPulse {\n        0% {\n          transform: scale(1);\n          filter: saturate(1.3) brightness(1.1);\n        }\n        50% {\n          transform: scale(1.03);\n          filter: saturate(1.5) brightness(1.2);\n          box-shadow: 0 12px 40px rgba(244, 67, 54, 0.4), 0 0 80px rgba(244, 67, 54, 0.2);\n        }\n        100% {\n          transform: scale(1);\n          filter: saturate(1.3) brightness(1.1);\n        }\n      }\n    ",document.head.appendChild(e)}addTaskStatus(e,t=0,n=null){const i=n||`task_${Date.now()}`;return this.addTaskCard(e,{percent:Math.min(Math.max(t,0),100),taskId:i,status:t>0?"progress":"pending"})}updateTaskProgress(e,t,n=null){this.output.querySelector(`[data-task-id="${e}"]`)&&n&&this.addOutput(n,"progress",{percent:Math.min(Math.max(t,0),100),taskId:e})}completeTask(e){const t=this.output.querySelector(`[data-task-id="${e}"]`);t&&(t.style.transition="opacity 0.5s ease, transform 0.5s ease",t.style.opacity="0",t.style.transform="translateX(20px)",setTimeout(()=>{t.parentNode&&t.remove()},500))}connectToProgress(e,t=null){if(this.activeConnections.has(e))return;const n=new EventSource(`/api/progress/${e}`);this.activeConnections.set(e,n),n.onmessage=e=>{try{const n=JSON.parse(e.data);n.uiTaskId=t,this.handleProgressUpdate(n)}catch(e){console.error("SSE data parse error:",e)}},n.onerror=t=>{console.error("SSE connection error:",t),this.disconnectProgress(e)}}handleProgressUpdate(e){switch(e.type){case"connected":this.logDebug(`🔗 Connected to progress stream: ${e.taskId}`);break;case"progress":void 0!==e.percent&&e.uiTaskId&&this.updateTaskCard(e.uiTaskId,"progress",{percent:e.percent});break;case"completed":e.uiTaskId&&this.updateTaskCard(e.uiTaskId,"completed"),this.disconnectProgress(e.taskId);break;case"error":e.uiTaskId&&this.updateTaskCard(e.uiTaskId,"error"),this.addOutput(`❌ ${e.message}`,"error"),this.disconnectProgress(e.taskId)}}disconnectProgress(e){const t=this.activeConnections.get(e);t&&(t.close(),this.activeConnections.delete(e))}scrollToBottom(){this.outputDiv&&(this.outputDiv.scrollTop=this.outputDiv.scrollHeight)}getModePrefix(e){return{generate:"",modify:"[変更] ",delete:"[削除] "}[e]||""}saveCommandToHistory(e){this.commandHistory=this.commandHistory.slice(0,this.currentHistoryIndex+1),this.commandHistory.push(e),this.currentHistoryIndex=this.commandHistory.length-1,this.commandHistory.length>this.maxHistorySize&&(this.commandHistory.shift(),this.currentHistoryIndex--),this.updateUndoRedoButtons()}undo(){if(!this.canUndo())return void this.addOutput("↶ Undoできる操作がありません","hint");const e=this.commandHistory[this.currentHistoryIndex];this.currentHistoryIndex--,"generate"===e.mode?(this.addOutput(`↶ Undo: "${e.command}" の生成を取り消しました`,"system"),this.sceneManager&&this.sceneManager.undoLastGenerate&&this.sceneManager.undoLastGenerate()):"modify"===e.mode?(this.addOutput(`↶ Undo: "${e.command}" の変更を取り消しました`,"system"),this.sceneManager&&this.sceneManager.undoLastModify&&this.sceneManager.undoLastModify()):"delete"===e.mode&&(this.addOutput(`↶ Undo: "${e.command}" の削除を取り消しました`,"system"),this.sceneManager&&this.sceneManager.undoLastDelete&&this.sceneManager.undoLastDelete()),this.updateUndoRedoButtons()}redo(){if(!this.canRedo())return void this.addOutput("↷ Redoできる操作がありません","hint");this.currentHistoryIndex++;const e=this.commandHistory[this.currentHistoryIndex];this.addOutput(`↷ Redo: "${e.command}" を再実行しました`,"system"),this.sceneManager&&this.sceneManager.redoCommand&&this.sceneManager.redoCommand(e),this.updateUndoRedoButtons()}canUndo(){return this.currentHistoryIndex>=0}canRedo(){return this.currentHistoryIndex<this.commandHistory.length-1}updateUndoRedoButtons(){this.undoBtn&&(this.undoBtn.disabled=!this.canUndo(),this.undoBtn.style.opacity=this.canUndo()?"1":"0.4",this.undoBtn.style.cursor=this.canUndo()?"pointer":"not-allowed"),this.redoBtn&&(this.redoBtn.disabled=!this.canRedo(),this.redoBtn.style.opacity=this.canRedo()?"1":"0.4",this.redoBtn.style.cursor=this.canRedo()?"pointer":"not-allowed")}async clearAllWithConfirmation(){await this.showClearAllConfirmation()&&this.clearAll()}async showClearAllConfirmation(){return this.showConfirmationDialog({icon:"🧹",title:"Clear All の確認",message:"すべてのオブジェクトが削除されます。<br>この操作は取り消すことができません。",confirmText:"Clear All 実行",cancelText:"キャンセル",confirmColor:"#6366f1"})}closeModalWithAnimation(e){const t=e.querySelector("div:last-child");t.style.transform="scale(0.9)",t.style.opacity="0",e.style.opacity="0",setTimeout(()=>{e.parentElement&&document.body.removeChild(e)},200)}clearAll(){this.sceneManager?(this.sceneManager.clearAll(),this.addOutput("🧹 全ての実験オブジェクトを削除しました","system")):this.client&&this.addOutput("⚠️ サーバー側削除は未実装","error")}showExamples(){this.addOutput("💡 コマンド例:","system"),["右上にドラゴンを作って","中央に大きなユニコーンを生成","左下に小さな桜を作って","空に鳳凰を作って","地面に神社を作って"].forEach(e=>{this.addOutput(`   "${e}"`,"hint")})}setSceneManager(e){this.sceneManager=e,this.applyServiceSelectionToSceneManager()}setClient(e){this.client=e}updateConfig(e){this.config={...this.config,...e},e.activationKey&&this.bindEvents()}refreshStyles(){const e=this.container?.querySelector('[data-mode="generate"]');e&&(e.style.cssText=this.getModeButtonStyles(!0,"generate"));const t=this.container?.querySelector("#execute-btn");t&&(t.style.cssText=this.getModernButtonStyles("primary"))}toggleTheme(){this.isDarkMode=!this.isDarkMode,localStorage.setItem("live-command-theme",this.isDarkMode?"dark":"light"),this.themeToggle&&(this.themeToggle.innerHTML=this.isDarkMode?"☀️":"🌙",this.themeToggle.title=this.isDarkMode?"ライトモードに切り替え":"ダークモードに切り替え"),this.applyTheme()}applyTheme(){document.body.className=this.isDarkMode?"dark-mode":"light-mode";const e=this.container.style.display,t=this.container.style.flexDirection;this.container.style.cssText=this.getContainerStyles(),this.container.style.display=e||"flex",this.container.style.flexDirection=t||"column";const n=this.container.querySelector(".floating-brand-badge");n&&(n.style.background=this.isDarkMode?"linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(139, 92, 246, 0.7))":"linear-gradient(135deg, rgba(99, 102, 241, 0.9), rgba(139, 92, 246, 0.8))",n.style.border="1px solid "+(this.isDarkMode?"rgba(255, 255, 255, 0.2)":"rgba(255, 255, 255, 0.4)")),this.input.style.cssText=this.getInputStyles(),this.output.style.cssText=this.getOutputStyles(),this.radioModeContainer&&(this.radioModeContainer.style.background=this.isDarkMode?"linear-gradient(135deg, rgba(30, 27, 75, 0.3), rgba(15, 23, 42, 0.4))":"linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1))",this.radioModeContainer.style.borderColor=this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(255, 255, 255, 0.25)",Object.keys(this.radioModeButtons).forEach(e=>{const{button:t}=this.radioModeButtons[e];this.currentMode!==e&&(t.style.color=this.isDarkMode?"rgba(255, 255, 255, 0.7)":"rgba(55, 65, 81, 0.8)",t.style.background="transparent",t.style.border="1px solid transparent",t.style.boxShadow="none")}),this.selectMode(this.currentMode,!1)),this.clearBtn&&(this.clearBtn.style.cssText=this.getActionButtonStyles("secondary")),this.historyBtn&&(this.historyBtn.style.cssText=this.getActionButtonStyles("secondary"),this.historyBtn.style.opacity="0.5"),this.themeToggle&&(this.themeToggle.innerHTML=this.isDarkMode?"☀️":"🌙",this.themeToggle.title=this.isDarkMode?"ライトモードに切り替え":"ダークモードに切り替え",this.themeToggle.style.cssText=this.getActionButtonStyles("icon")),this.settingsButton&&(this.settingsButton.style.cssText=this.getActionButtonStyles("icon")),this.updateServiceSelectorTheme();const i=this.container.querySelector(".close-button");i&&(i.style.color=this.isDarkMode?"#ffffff":"#1f2937",i.style.background=this.isDarkMode?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"),this.updateFloatingContainerTheme(),this.updateExistingTextColors()}updateFloatingContainerTheme(){if(!this.floatingContainer)return;const e=this.floatingContainer.style.display;this.taskCards&&this.taskCards.size>0&&this.taskCards.forEach((e,t)=>{const n=e.element;if(n){const e={background:"linear-gradient(135deg, rgba(15, 23, 42, 0.75), rgba(30, 27, 75, 0.7))",border:"1px solid rgba(99, 102, 241, 0.25)",color:"#ffffff"},t={background:"linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25))",border:"1px solid rgba(255, 255, 255, 0.4)",color:"#1f2937"},i=this.isDarkMode?e:t;n.style.setProperty("background",i.background,"important"),n.style.setProperty("border",i.border,"important"),n.style.setProperty("color",i.color,"important")}}),this.floatingContainer.style.display=e}updateExistingTextColors(){const e=this.isDarkMode?{system:"#60a5fa",command:"#93c5fd",success:"#f472b6",error:"#f87171",processing:"#fbbf24",info:"#d1d5db",hint:"#d1d5db"}:{system:"#1e40af",command:"#1d4ed8",success:"#be185d",error:"#dc2626",processing:"#d97706",info:"#7c3aed",hint:"#374151"},t=this.isDarkMode?"#d1d5db":"#374151";this.output.querySelectorAll("div").forEach(n=>{const i=n.textContent;let o="default";i.includes("📋")||i.includes("🎨")||i.includes("🎮")||i.includes("UI起動")?o="system":i.startsWith("> ")?o="command":i.includes("✅")||i.includes("⭐")||i.includes("生成しました")?o="success":i.includes("❌")||i.includes("エラー")?o="error":i.includes("中...")?o="processing":i.includes("📍")||i.includes("使用モデル:")||i.includes("位置:")?o="info":i.includes("   ")&&(o="hint"),n.style.color=e[o]||t})}showImportInterface(){this.fileInput||(this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".glb,.gltf,.jpg,.jpeg,.png,.mp4,.mov",this.fileInput.style.display="none",this.fileInput.onchange=e=>this.handleFileSelection(e),document.body.appendChild(this.fileInput)),this.enableDragAndDrop()}hideImportInterface(){this.fileSelectButton&&this.fileSelectButton.parentNode&&this.fileSelectButton.parentNode.removeChild(this.fileSelectButton),this.disableDragAndDrop()}openFileSelector(){this.fileInput&&this.fileInput.click()}triggerFileSelection(){this.fileInput||this.showImportInterface(),this.openFileSelector(),this.selectMode("import",!0)}async handleFileSelection(e){const t=e.target.files[0];if(t)try{const e=this.detectFileType(t.name),n=URL.createObjectURL(t);this.selectedFile={file:t,url:n,type:e,name:t.name},this.selectMode("import",!0);const i=`中央に設置 (${t.name})`;this.input.value=i,this.addOutput(`📁 ファイル選択: ${t.name} (${e})`,"system"),this.addOutput(`🚀 自動アップロード開始: ${i}`,"system"),setTimeout(()=>{this.executeCommand()},500)}catch(e){console.error("File selection error:",e),this.addOutput(`❌ ファイル選択エラー: ${e.message}`,"error")}}enableDragAndDrop(){this.input&&(this.input.addEventListener("dragover",this.handleDragOver.bind(this)),this.input.addEventListener("drop",this.handleDrop.bind(this)),this.input.addEventListener("dragenter",this.handleDragEnter.bind(this)),this.input.addEventListener("dragleave",this.handleDragLeave.bind(this)))}disableDragAndDrop(){this.input&&(this.input.removeEventListener("dragover",this.handleDragOver.bind(this)),this.input.removeEventListener("drop",this.handleDrop.bind(this)),this.input.removeEventListener("dragenter",this.handleDragEnter.bind(this)),this.input.removeEventListener("dragleave",this.handleDragLeave.bind(this)))}handleDragOver(e){e.preventDefault(),this.input.style.background=this.isDarkMode?"rgba(236, 72, 153, 0.1)":"rgba(236, 72, 153, 0.05)"}handleDragEnter(e){e.preventDefault(),this.input.style.background=this.isDarkMode?"rgba(236, 72, 153, 0.1)":"rgba(236, 72, 153, 0.05)"}handleDragLeave(e){e.preventDefault(),this.input.style.background=""}async handleDrop(e){e.preventDefault(),this.input.style.background="";const t=Array.from(e.dataTransfer.files);if(0===t.length)return;const n=t[0];this.detectFileType(n.name)?this.handleFileSelection({target:{files:[n]}}):this.addOutput("❌ サポートされていないファイル形式です","error")}detectFileType(e){const t=e.toLowerCase().split(".").pop();return["glb","gltf"].includes(t)?"3d":["jpg","jpeg","png","webp"].includes(t)?"image":["mp4","mov","webm"].includes(t)?"video":null}async handleImportCommand(e){if(!this.selectedFile)throw new Error("ファイルが選択されていません");try{const t=this.sceneManager?this.sceneManager.parsePosition(e):{x:0,y:5,z:-10};let n;switch(this.selectedFile.type){case"3d":if(!this.sceneManager)throw new Error("SceneManager が利用できません");n=await this.sceneManager.load3DModel(this.selectedFile.url,{position:t});break;case"image":if(!this.sceneManager)throw new Error("SceneManager が利用できません");n=await this.sceneManager.loadImageFile(this.selectedFile.url,{position:t});break;case"video":if(!this.sceneManager)throw new Error("SceneManager が利用できません");n=await this.sceneManager.loadVideoFile(this.selectedFile.url,{position:t});break;default:throw new Error(`サポートされていないファイルタイプ: ${this.selectedFile.type}`)}const i=this.selectedFile?.name,o=this.selectedFile?.type,s=this.selectedFile?.url;return"video"!==o&&s&&URL.revokeObjectURL(s),this.selectedFile=null,this.selectMode("generate",!1),{success:!0,message:`${i||"ファイル"} を ${t.x}, ${t.y}, ${t.z} に配置しました`,objectId:n.objectId}}catch(e){throw this.selectedFile?.url&&URL.revokeObjectURL(this.selectedFile.url),this.selectedFile=null,this.selectMode("generate",!1),e}}handleDeleteModeSelection(){const e=this.sceneManager?.selectedObject;if(e){const t=e.userData?.originalPrompt||e.name||"選択したオブジェクト";this.input.value=`${t}を削除 ⏎`,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length),this.addOutput(`🎯 削除対象: ${t}`,"system")}else this.input.value="",this.addOutput("❗ 削除するオブジェクトを選択後、削除ボタンを押してください","system"),this.triggerAttentionAnimation("delete")}handleModifyModeSelection(){const e=this.sceneManager?.selectedObject;if(e){const t=e.userData?.originalPrompt||e.name||"選択したオブジェクト";this.input.value=`${t}を`,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length),this.addOutput(`🎯 修正対象: ${t}`,"system")}else this.input.value="",this.addOutput("❗ 修正するオブジェクトを選択後、修正ボタンを押してください","system"),this.triggerAttentionAnimation("modify")}triggerAttentionAnimation(e){const t=this.chatOutput,n=this.input;this.addMicroShakeEffect(t),this.addContextGlow(n,e),this.addEmotionalPulse(t,e),this.add3DDepthEffect(t)}addMicroShakeEffect(e){e.style.animation="microShake2025 0.5s ease-in-out",this.ensureMicroShakeAnimation(),setTimeout(()=>{e.style.animation=""},500)}addContextGlow(e,t){const n="delete"===t?"rgba(239, 68, 68, 0.4)":"rgba(99, 102, 241, 0.4)";e.style.transition="all 0.3s ease",e.style.boxShadow=`0 0 20px ${n}, 0 0 40px ${n}`,setTimeout(()=>{e.style.boxShadow=""},3e3)}addEmotionalPulse(e,t){const n="delete"===t?"#ef4444":"#6366f1";e.style.borderLeft=`4px solid ${n}`,e.style.animation="emotionalPulse2025 2s ease-in-out infinite",this.ensureEmotionalPulseAnimation(),setTimeout(()=>{e.style.animation="",e.style.borderLeft=""},6e3)}add3DDepthEffect(e){e.style.transform="translateZ(8px) rotateX(1deg)",e.style.transition="transform 0.3s ease",setTimeout(()=>{e.style.transform=""},2e3)}ensureMicroShakeAnimation(){if(document.getElementById("micro-shake-2025"))return;const e=document.createElement("style");e.id="micro-shake-2025",e.textContent="\n      @keyframes microShake2025 {\n        0%, 100% { transform: translateX(0); }\n        10% { transform: translateX(-2px) rotateZ(-0.5deg); }\n        20% { transform: translateX(2px) rotateZ(0.5deg); }\n        30% { transform: translateX(-1px) rotateZ(-0.3deg); }\n        40% { transform: translateX(1px) rotateZ(0.3deg); }\n        50% { transform: translateX(-0.5px) rotateZ(-0.1deg); }\n        60% { transform: translateX(0.5px) rotateZ(0.1deg); }\n        70% { transform: translateX(0); }\n      }\n    ",document.head.appendChild(e)}ensureEmotionalPulseAnimation(){if(document.getElementById("emotional-pulse-2025"))return;const e=document.createElement("style");e.id="emotional-pulse-2025",e.textContent="\n      @keyframes emotionalPulse2025 {\n        0% { \n          border-left-width: 4px;\n          filter: brightness(1);\n        }\n        50% { \n          border-left-width: 8px;\n          filter: brightness(1.2) saturate(1.1);\n        }\n        100% { \n          border-left-width: 4px;\n          filter: brightness(1);\n        }\n      }\n    ",document.head.appendChild(e)}clearInputOnModeSwitch(e){if(this.input.value.trim()){this.isPreviousModeMessage(this.input.value,e)&&(this.input.value="",this.addOutput(`💫 ${this.getModeDisplayName(e)}モードに切り替えました`,"system"))}}isPreviousModeMessage(e,t){const n=[/.*を削除$/,/削除$/],i=[/.*を$/,/.*を変更/,/.*をピンク/,/.*を大きく/,/.*を小さく/,/.*を移動/],o=[/ファイル/,/画像/,/インポート/];switch(t){case"delete":return i.some(t=>t.test(e))||o.some(t=>t.test(e));case"modify":return n.some(t=>t.test(e))||o.some(t=>t.test(e));case"import":return n.some(t=>t.test(e))||i.some(t=>t.test(e));case"generate":return n.some(t=>t.test(e))||i.some(t=>t.test(e))||o.some(t=>t.test(e));default:return!1}}getModeDisplayName(e){return{generate:"生成",import:"インポート",modify:"修正",delete:"削除"}[e]||e}createFloatingChocolateIcon(){this.floatingChocolateIcon&&this.floatingChocolateIcon.remove(),this.floatingChocolateIcon=document.createElement("div"),this.floatingChocolateIcon.innerHTML="🍫",this.floatingChocolateIcon.title="ChocoDrop を開く (@キーでも開けます)",this.floatingChocolateIcon.style.cssText="\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      width: 48px;\n      height: 48px;\n      border-radius: 50%;\n      background: rgba(99, 102, 241, 0.15);\n      backdrop-filter: blur(16px);\n      -webkit-backdrop-filter: blur(16px);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05);\n      opacity: 0.8;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 20px;\n      cursor: pointer;\n      z-index: 999;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      transform: scale(1);\n      filter: none;\n    ",this.floatingChocolateIcon.addEventListener("mouseover",()=>{this.floatingChocolateIcon.style.transform="scale(1.1) translateY(-2px)",this.floatingChocolateIcon.style.boxShadow="0 6px 16px rgba(99, 102, 241, 0.3), 0 3px 8px rgba(0, 0, 0, 0.1)",this.floatingChocolateIcon.style.opacity="1",this.floatingChocolateIcon.style.filter="none"}),this.floatingChocolateIcon.addEventListener("mouseout",()=>{this.floatingChocolateIcon.style.transform="scale(1) translateY(0)",this.floatingChocolateIcon.style.boxShadow="0 4px 12px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.05)",this.floatingChocolateIcon.style.opacity="0.8",this.floatingChocolateIcon.style.filter="none"}),this.floatingChocolateIcon.addEventListener("click",()=>{this.isVisible?this.hide():this.show()}),this.floatingChocolateIcon.addEventListener("contextmenu",e=>{e.preventDefault(),this.showFloatingIconContextMenu(e)}),document.body.appendChild(this.floatingChocolateIcon)}showFloatingIconContextMenu(e){const t=document.querySelector(".floating-icon-context-menu");t&&t.remove();const n=document.createElement("div");n.className="floating-icon-context-menu",n.style.cssText=`\n      position: fixed;\n      top: ${e.clientY}px;\n      left: ${e.clientX}px;\n      background: ${this.isDarkMode?"rgba(17, 24, 39, 0.85)":"rgba(255, 255, 255, 0.85)"};\n      backdrop-filter: blur(20px);\n      -webkit-backdrop-filter: blur(20px);\n      border: 1px solid ${this.isDarkMode?"rgba(129, 140, 248, 0.3)":"rgba(99, 102, 241, 0.2)"};\n      border-radius: 12px;\n      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);\n      padding: 8px 0;\n      min-width: 160px;\n      z-index: 2000;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      color: ${this.isDarkMode?"#ffffff":"#1f2937"};\n    `;const i=document.createElement("div");i.innerHTML="📄 フォームを開く",i.style.cssText="\n      padding: 8px 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      color: #6366f1;\n      text-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);\n    ",i.addEventListener("mouseover",()=>{i.style.background=this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(99, 102, 241, 0.1)",i.style.textShadow="0 2px 6px rgba(99, 102, 241, 0.5)"}),i.addEventListener("mouseout",()=>{i.style.background="transparent",i.style.textShadow="0 2px 4px rgba(99, 102, 241, 0.3)"}),i.addEventListener("click",()=>{n.remove(),this.isVisible?this.hide():this.show()});const o=document.createElement("div");o.innerHTML="✕ アイコンを非表示",o.style.cssText="\n      padding: 8px 16px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      color: #6366f1;\n      text-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);\n    ",o.addEventListener("mouseover",()=>{o.style.background=this.isDarkMode?"rgba(99, 102, 241, 0.15)":"rgba(99, 102, 241, 0.1)",o.style.textShadow="0 2px 6px rgba(99, 102, 241, 0.5)"}),o.addEventListener("mouseout",()=>{o.style.background="transparent",o.style.textShadow="0 2px 4px rgba(99, 102, 241, 0.3)"}),o.addEventListener("click",()=>{n.remove(),this.hideFloatingIcon()}),n.appendChild(i),n.appendChild(o),document.body.appendChild(n);const s=n.getBoundingClientRect();s.right>window.innerWidth&&(n.style.left=e.clientX-s.width+"px"),s.bottom>window.innerHeight&&(n.style.top=e.clientY-s.height+"px");const r=e=>{n.contains(e.target)||(n.remove(),document.removeEventListener("click",r))};setTimeout(()=>{document.addEventListener("click",r)},10)}hideFloatingIcon(){this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.display="none")}showFloatingIcon(){this.floatingChocolateIcon&&(this.floatingChocolateIcon.style.display="flex")}dispose(){this.fileInput&&this.fileInput.parentNode&&this.fileInput.parentNode.removeChild(this.fileInput),this.selectedFile&&this.selectedFile.url&&URL.revokeObjectURL(this.selectedFile.url),this.floatingChocolateIcon&&this.floatingChocolateIcon.parentNode&&this.floatingChocolateIcon.parentNode.removeChild(this.floatingChocolateIcon),this.container&&this.container.parentElement&&this.container.parentElement.removeChild(this.container)}}function p(e,t={}){if(!e)throw new Error("THREE.Scene インスタンスが必要です");const{camera:n=null,renderer:i=null,serverUrl:s=null,client:r=null,onControlsToggle:l=()=>{},sceneOptions:c={},uiOptions:p={}}=t,h=s||c.serverUrl||null,u=r||new o(h),m=new a(e,{camera:n,renderer:i,serverUrl:h,client:u,...c}),g=new d({sceneManager:m,client:u,onControlsToggle:l,...p});return{client:u,sceneManager:m,ui:g,dispose(){g.dispose?.(),m.dispose?.()}}}const h=p,u=p;var m={ChocoDropClient:o,ChocoDroClient:r,LiveCommandClient:s,SceneManager:a,CommandUI:d,createChocoDrop:p,createChocoDro:h,createLiveCommand:u};e.ChocoDroClient=r,e.ChocoDropClient=o,e.CommandUI=d,e.LiveCommandClient=s,e.SceneManager=a,e.createChocoDro=h,e.createChocoDrop=p,e.createLiveCommand=u,e.default=m,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=chocodrop.umd.min.js.map
